<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thronos AI Architect</title>
  <style>
    body{margin:0;font-family:system-ui;background:#050a07;color:#c8ffd8}
    .top{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #0f3}
    .pill{border:1px solid #0f3;border-radius:999px;padding:4px 10px;color:#8fffb0}
    select,textarea,input,button{background:#07140d;color:#c8ffd8;border:1px solid #0f3;border-radius:8px;padding:8px}
    button{cursor:pointer}
    .wrap{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 54px)}
    .left{border-right:1px solid #0f3;padding:10px;display:flex;flex-direction:column;gap:10px}
    .right{padding:10px}
    textarea{min-height:180px;resize:vertical}
    pre{background:#07110a;border:1px solid #0f3;border-radius:12px;padding:12px;white-space:pre-wrap}
    .muted{opacity:.8;font-size:12px}
  </style>
</head>
<body>
  <div class="top">
    <div class="pill" id="statusPill">Architect: online</div>
    <div class="muted">Wallet</div>
    <input id="wallet" placeholder="THR..." style="width:210px"/>
    <div class="muted">Model</div>
    <select id="model">
      <option value="gpt-4o">gpt-4o</option>
      <option value="gemini-1.5-pro">gemini-1.5-pro</option>
      <option value="local">offline</option>
    </select>
  </div>

  <div class="wrap">
    <div class="left">
      <div class="muted">Select Blueprint</div>
      <select id="blueprint"></select>

      <div class="muted">Custom Specifications (Optional)</div>
      <textarea id="spec" placeholder="π.χ. Θέλω login, dashboard, billing, admin panel..."></textarea>

      <button id="generate">GENERATE ARCHITECTURE</button>
      <button id="downloadZipBtn" disabled>Download Project ZIP</button>

      <div class="muted">Tip: Τα blueprints ζουν στο /app/data/ai_blueprints (Railway volume).</div>
    </div>

    <div class="right">
      <div class="muted">Architect Output Log</div>
      <pre id="out">// Generation output will appear here...</pre>
      <div class="muted" id="files"></div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
let lastArchitectFiles = [];

async function api(url, opts){
  const r = await fetch(url, opts);
  const t = await r.text();
  let j = null;
  try{ j = JSON.parse(t); }catch(e){}
  if(!r.ok){
    throw new Error((j && (j.error||j.message)) || t || ("HTTP "+r.status));
  }
  return j;
}

function setStatus(ok, text){
  const pill = $("statusPill");
  pill.textContent = text || (ok ? "Architect: online" : "Architect: offline");
  pill.style.borderColor = ok ? "#0f3" : "#f33";
  pill.style.color = ok ? "#8fffb0" : "#ffb0b0";
}

async function loadBlueprints(){
  const j = await api("/api/ai_blueprints");
  const list = j.blueprints || [];
  const sel = $("blueprint");
  sel.innerHTML = "";
  if(!list.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No blueprints found";
    sel.appendChild(opt);
    return;
  }
  list.forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b;
    opt.textContent = b;
    sel.appendChild(opt);
  });
}

function parseFiles(lines){
  return (lines||[]).map(f=>`${f.filename} (${f.size} bytes)`).join("\n");
}

$("generate").onclick = async ()=>{
  const blueprint = $("blueprint").value;
  const spec = $("spec").value.trim();
  const wallet = $("wallet").value.trim();
  const model = $("model").value.trim();

  if(!blueprint){ alert("Διάλεξε blueprint."); return; }
  if(!spec){ alert("Γράψε specifications (έστω λίγα)."); return; }

  $("out").textContent = "Generating...\n";
  $("files").textContent = "";
  lastArchitectFiles = [];
  $("downloadZipBtn").disabled = true;

  try{
    const j = await api("/api/architect_generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({wallet, blueprint, spec, model})
    });
    setStatus(true,"Architect: online");
    $("out").textContent = j.response || "";
    lastArchitectFiles = j.files || [];
    if (lastArchitectFiles.length > 0) {
      let log = j.response || "";
      log += "\n\nFiles:\n";
      lastArchitectFiles.forEach(f => {
        const name = f.filename || "file";
        const url = f.url || ("/api/ai/generated/" + encodeURIComponent(name));
        log += `- ${name} → ${url}\n`;
      });
      $("out").textContent = log;
      $("files").textContent = "";
    } else {
      $("files").textContent = j.files && j.files.length ? ("Files:\n"+parseFiles(j.files)) : "";
    }
    $("downloadZipBtn").disabled = !lastArchitectFiles.length;
  }catch(e){
    setStatus(false,"Architect: offline");
    $("out").textContent = "Σφάλμα: " + e.message;
  }
};

const downloadZipBtn = document.getElementById("downloadZipBtn");

downloadZipBtn.addEventListener("click", async () => {
  if (!lastArchitectFiles || lastArchitectFiles.length === 0) return;
  const res = await fetch("/api/architect_download", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ files: lastArchitectFiles }),
  });
  if (!res.ok) {
    alert("Failed to build ZIP");
    return;
  }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "thronos_architecture.zip";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

(async ()=>{
  try{ await loadBlueprints(); setStatus(true,"Architect: online"); }
  catch(e){ setStatus(false,"Architect: offline"); }
})();
</script>
</body>
</html>
