<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thronos AI Architect</title>
  <style>
    :root {
      --bg: #050a07;
      --panel: #071810;
      --accent: #00ff66;
      --accent-soft: rgba(0, 255, 102, 0.1);
      --text: #c8ffd8;
      --muted: #7aa398;
      --border: #1a3b2e;
      --danger: #ff4b81;
      --purple: #b366ff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #050a07 0%, #0a1810 100%);
      color: var(--text);
      min-height: 100vh;
    }

    /* Language toggle - N2 FIX: Added body.lang-el rules for Greek */
    .lang-en, .lang-ja, .lang-ru, .lang-es { display: none; }
    /* Greek (default) */
    body.lang-el .lang-en, body.lang-el .lang-ja, body.lang-el .lang-ru, body.lang-el .lang-es { display: none; }
    body.lang-el .lang-el { display: inline; }
    /* English */
    body.lang-en .lang-el { display: none; }
    body.lang-en .lang-en { display: inline; }
    /* Japanese */
    body.lang-ja .lang-el { display: none; }
    body.lang-ja .lang-ja { display: inline; }
    /* Russian */
    body.lang-ru .lang-el { display: none; }
    body.lang-ru .lang-ru { display: inline; }
    /* Spanish */
    body.lang-es .lang-el { display: none; }
    body.lang-es .lang-es { display: inline; }

    .top {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(7, 24, 16, 0.95), rgba(5, 10, 7, 0.98));
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--accent);
      box-shadow: 0 0 15px rgba(0, 255, 102, 0.3);
    }

    .logo-text {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.1em;
    }

    .pill {
      border: 1px solid var(--accent);
      border-radius: 999px;
      padding: 6px 14px;
      color: var(--accent);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .lang-control {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lang-select {
      min-width: 150px;
      background: var(--accent-soft);
      border: 1px solid var(--border);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
    }

    select, textarea, input, button {
      background: rgba(7, 20, 13, 0.9);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 14px;
      transition: all 0.3s;
    }

    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(0, 255, 102, 0.2);
    }

    button {
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
    }

    .wrap {
      display: grid;
      grid-template-columns: 350px 1fr;
      min-height: calc(100vh - 70px);
    }

    @media (max-width: 900px) {
      .wrap {
        grid-template-columns: 1fr;
      }
    }

    .left {
      border-right: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: rgba(7, 24, 16, 0.3);
    }

    .right {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    textarea {
      min-height: 200px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.5;
    }

    .generate-btn {
      background: linear-gradient(135deg, var(--accent) 0%, #00cc55 100%);
      color: #000;
      border: none;
      padding: 16px 24px;
      font-size: 15px;
      letter-spacing: 0.1em;
      box-shadow: 0 0 20px rgba(0, 255, 102, 0.3);
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 255, 102, 0.5);
    }

    .generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    pre {
      background: linear-gradient(135deg, rgba(7, 17, 10, 0.95), rgba(5, 10, 7, 0.98));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      white-space: pre-wrap;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      line-height: 1.6;
      flex: 1;
      overflow-y: auto;
      min-height: 400px;
      max-height: calc(100vh - 250px);
    }

    .files-output {
      background: rgba(179, 102, 255, 0.1);
      border: 1px solid var(--purple);
      border-radius: 10px;
      padding: 12px;
      font-size: 12px;
      color: var(--purple);
    }

    .tip-box {
      background: var(--accent-soft);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .tip-box strong {
      color: var(--accent);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-row input {
      flex: 1;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .status-indicator.online { color: var(--accent); }
    .status-indicator.offline { color: var(--danger); }
  </style>
</head>
<body>
  <div class="top">
    <div class="logo">
      <div class="logo-icon">ğŸ—ï¸</div>
      <div class="logo-text">AI ARCHITECT</div>
    </div>
    <div class="pill" id="statusPill">
      <div class="pill-dot"></div>
      <span class="lang-el">Online</span>
      <span class="lang-en">Online</span>
      <span class="lang-ja">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
      <span class="lang-ru">ĞĞ½Ğ»Ğ°Ğ¹Ğ½</span>
      <span class="lang-es">En lÃ­nea</span>
    </div>
    <div class="input-row">
      <span class="section-title" style="margin: 0;" data-i18n="label.wallet" data-i18n-default="Wallet">Wallet</span>
      <input id="wallet" placeholder="THR..." style="width: 200px"/>
    </div>
    <div class="input-row">
      <span class="section-title" style="margin: 0;" data-i18n="label.model" data-i18n-default="Model">Model</span>
      <select id="model">
        <option value="auto">ğŸ”€ Auto (Pythia chooses)</option>
        <!-- Models loaded dynamically from /api/ai_models -->
      </select>
    </div>
    <div class="lang-control">
      <span class="section-title" style="margin: 0;" data-i18n="label.language" data-i18n-default="Language">Language</span>
      <select id="languageSelect" class="lang-select" aria-label="Language">
        <option value="gr">Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="es">EspaÃ±ol</option>
        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
      </select>
    </div>
  </div>

  <div class="wrap">
    <div class="left">
      <div class="input-group">
        <div class="section-title">
          ğŸ“‹ <span class="lang-el">Î•Ï€Î¹Î»Î¿Î³Î® Blueprint</span>
          <span class="lang-en">Select Blueprint</span>
          <span class="lang-ja">ãƒ–ãƒ«ãƒ¼ãƒ—ãƒªãƒ³ãƒˆé¸æŠ</span>
          <span class="lang-ru">Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½</span>
          <span class="lang-es">Seleccionar Blueprint</span>
        </div>
        <select id="blueprint"></select>
      </div>

      <div class="input-group">
        <div class="section-title">
          âœï¸ <span class="lang-el">Î ÏÎ¿Î´Î¹Î±Î³ÏÎ±Ï†Î­Ï‚ (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</span>
          <span class="lang-en">Custom Specifications (Optional)</span>
          <span class="lang-ja">ã‚«ã‚¹ã‚¿ãƒ ä»•æ§˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</span>
          <span class="lang-ru">Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ (ĞĞµĞ¾Ğ±ÑĞ·.)</span>
          <span class="lang-es">Especificaciones (Opcional)</span>
        </div>
        <textarea id="spec" placeholder="Ï€.Ï‡. Î˜Î­Î»Ï‰ login, dashboard, billing, admin panel, API endpoints Î³Î¹Î± users..."></textarea>
      </div>

      <button class="generate-btn" id="generate">
        ğŸš€ <span class="lang-el">Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ Î‘Î¡Î§Î™Î¤Î•ÎšÎ¤ÎŸÎÎ™ÎšÎ—Î£</span>
        <span class="lang-en">GENERATE ARCHITECTURE</span>
        <span class="lang-ja">ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç”Ÿæˆ</span>
        <span class="lang-ru">Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ£</span>
        <span class="lang-es">GENERAR ARQUITECTURA</span>
      </button>

      <div class="tip-box">
        <strong>ğŸ’¡ Tip:</strong>
        <span class="lang-el">Î¤Î± blueprints Ï†Î¿ÏÏ„ÏÎ½Î¿Î½Ï„Î±Î¹ Î±Ï€ÏŒ /app/data/ai_blueprints. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î´Î¹ÎºÎ¬ ÏƒÎ±Ï‚ templates!</span>
        <span class="lang-en">Blueprints are loaded from /app/data/ai_blueprints. You can create your own templates!</span>
        <span class="lang-ja">ãƒ–ãƒ«ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã¯/app/data/ai_blueprintsã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚ç‹¬è‡ªã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™ï¼</span>
        <span class="lang-ru">Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¸Ğ· /app/data/ai_blueprints. Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¸!</span>
        <span class="lang-es">Los blueprints se cargan desde /app/data/ai_blueprints. Â¡Puedes crear los tuyos!</span>
      </div>
    </div>

    <div class="right">
      <div class="section-title">
        ğŸ“œ <span class="lang-el">Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Architect</span>
        <span class="lang-en">Architect Output Log</span>
        <span class="lang-ja">Architectã®å‡ºåŠ›ãƒ­ã‚°</span>
        <span class="lang-ru">Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Architect</span>
        <span class="lang-es">Registro de Salida</span>
      </div>
      <pre id="out">// <span class="lang-el">Î¤Î¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï...</span><span class="lang-en">Generation output will appear here...</span><span class="lang-ja">ç”ŸæˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</span><span class="lang-ru">Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ...</span><span class="lang-es">El resultado aparecerÃ¡ aquÃ­...</span></pre>
      <div class="files-output" id="files" style="display: none;"></div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <button id="downloadZipBtn" class="generate-btn" style="display: none; padding: 10px 16px;">â¬‡ï¸ Download ZIP</button>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const downloadZipBtn = document.getElementById("downloadZipBtn");

function resetDownloadBtn() {
  if (!downloadZipBtn) return;
  downloadZipBtn.disabled = true;
  downloadZipBtn.style.display = "none";
  downloadZipBtn.removeAttribute("data-url");
}

function enableDownloadBtn(url) {
  if (!downloadZipBtn || !url) return;
  downloadZipBtn.dataset.url = url;
  downloadZipBtn.disabled = false;
  downloadZipBtn.style.display = "inline-flex";
}

if (downloadZipBtn) {
  downloadZipBtn.addEventListener("click", () => {
    const url = downloadZipBtn.dataset.url;
    if (url) {
      window.location.href = url;
    }
  });
}

// Language support - data-i18n based with safe fallback
const LANG_SEQUENCE = ['gr', 'en', 'ja', 'es', 'ru'];
const LANG_ALIAS = { el: 'gr' };
const DEFAULT_LANG = 'en';
let TRANSLATIONS_CACHE = null;
let lastArchitectFiles = []; // Store generated files for download

function normalizeLang(lang) {
  if (!lang) return DEFAULT_LANG;
  const alias = LANG_ALIAS[lang];
  const normalized = alias || lang;
  return LANG_SEQUENCE.includes(normalized) ? normalized : DEFAULT_LANG;
}

function harvestTranslations() {
  const store = {};
  const langRegex = /lang-([a-z]+)/;
  document.querySelectorAll('.lang-el, .lang-en, .lang-ja, .lang-ru, .lang-es').forEach((node) => {
    const parent = node.parentElement;
    if (!parent) return;
    if (!parent.dataset.i18n) {
      parent.dataset.i18n = `auto-i18n-${Object.keys(store).length}`;
    }
    const key = parent.dataset.i18n;
    const match = node.className.match(langRegex);
    const lang = normalizeLang(match && match[1]);
    store[key] = store[key] || {};
    store[key][lang] = node.textContent.trim();
  });
  document.querySelectorAll('[data-i18n]').forEach((node) => {
    const key = node.dataset.i18n;
    store[key] = store[key] || {};
    const fallback = node.dataset.i18nDefault || node.textContent.trim();
    if (!store[key][DEFAULT_LANG]) {
      store[key][DEFAULT_LANG] = fallback;
    }
  });
  return store;
}

function applyTranslations(langOverride) {
  const lang = normalizeLang(langOverride || localStorage.getItem('lang'));
  localStorage.setItem('lang', lang);
  document.documentElement.lang = lang;

  // FIX: Apply language class to body for CSS language toggle to work
  // CSS rules use body.lang-el, body.lang-en, etc.
  const langClass = 'lang-' + (lang === 'gr' ? 'el' : lang);
  document.body.className = document.body.className.replace(/lang-\w+/g, '').trim();
  document.body.classList.add(langClass);

  if (!TRANSLATIONS_CACHE) {
    TRANSLATIONS_CACHE = harvestTranslations();
  }

  try {
    document.querySelectorAll('[data-i18n]').forEach((node) => {
      const key = node.dataset.i18n;
      const table = TRANSLATIONS_CACHE[key] || {};
      const fallback = table[DEFAULT_LANG] || node.dataset.i18nDefault || node.textContent;
      const value = table[lang] || fallback || key;
      if (node.dataset.i18nAttr === 'placeholder') {
        node.placeholder = value;
      } else {
        node.textContent = value;
      }
    });
  } catch (err) {
    console.warn('translation apply failed', err);
    document.querySelectorAll('[data-i18n]').forEach((node) => {
      const fallback = node.dataset.i18nDefault || node.textContent;
      if (node.dataset.i18nAttr === 'placeholder') {
        node.placeholder = fallback;
      } else {
        node.textContent = fallback;
      }
    });
  }

  const langSelect = document.getElementById('languageSelect');
  if (langSelect && langSelect.value !== lang) {
    langSelect.value = lang;
  }
}

async function api(url, opts) {
  const r = await fetch(url, opts);
  const t = await r.text();
  let j = null;
  try { j = JSON.parse(t); } catch(e) {}
  if (!r.ok) {
    throw new Error((j && (j.error || j.message)) || t || ("HTTP " + r.status));
  }
  return j;
}

function setStatus(ok, text) {
  const pill = $("statusPill");
  if (!pill) return;
  const dot = pill.querySelector('.pill-dot');
  if (!dot) return;
  dot.style.background = ok ? "var(--accent)" : "var(--danger)";
  dot.style.boxShadow = ok ? "0 0 8px var(--accent)" : "0 0 8px var(--danger)";
}

async function loadBlueprints() {
  const j = await api("/api/ai_blueprints");
  const list = j.blueprints || [];
  const sel = $("blueprint");
  sel.innerHTML = "";

  if (!list.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No blueprints found";
    sel.appendChild(opt);
    return;
  }

  list.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b;
    opt.textContent = "ğŸ“ " + b;
    sel.appendChild(opt);
  });
  applyTranslations();
}

function parseFiles(lines) {
  return (lines || []).map(f => `ğŸ“„ ${f.filename} (${f.size} bytes)`).join("\n");
}

$("generate").onclick = async () => {
  const blueprint = $("blueprint").value;
  const spec = $("spec").value.trim();
  const wallet = $("wallet").value.trim() || localStorage.getItem('thr_address') || '';
  const model = $("model").value.trim();

  if (!blueprint) {
    alert("Please select a blueprint.");
    return;
  }
  if (!spec) {
    alert("Please enter specifications.");
    return;
  }

  const btn = $("generate");
  btn.disabled = true;
  btn.innerHTML = "â³ Generating...";

  const outEl = $("out");
  if (outEl) {
    outEl.textContent = "ğŸ”„ Generating architecture...\n\nPlease wait while Pythia analyzes your specifications...";
  }
  const filesEl = $("files");
  if (filesEl) {
    filesEl.style.display = "none";
    filesEl.textContent = "";
  }
  lastArchitectFiles = [];
  resetDownloadBtn();

  try {
    const j = await api("/api/architect_generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet, blueprint, spec, model_id: model })
    });
    setStatus(true,"Architect: online");
    $("out").textContent = j.response || "";

    let filesInfo = "";
    const filesEl = $("files");
    if(j.files && j.files.length){
      lastArchitectFiles = j.files;
      filesInfo = `Files: ${j.files_count}\nTotal: ${j.total_kb} KB\nCost: ${j.cost_thr} THR\n\n${parseFiles(j.files)}`;
      if (filesEl) {
        filesEl.style.display = "block";
      }
      // Enable download button if zip_url is provided
      if (j.zip_url) {
        enableDownloadBtn(j.zip_url);
      }
    }

    if(j.redirect_to_chat && j.session_id){
      filesInfo += `\n\nâœ… Architecture complete!\nğŸ‘‰ Continue development in Chat: /chat?session=${j.session_id}`;

      // Auto-redirect option
      if(confirm(`Architecture generated successfully!\n\nCost: ${j.cost_thr} THR\nFiles: ${j.files_count}\n\nContinue in Chat for further development?`)){
        window.location.href = `/chat?session=${j.session_id}&from=architect`;
      }
    }

    if (filesEl) {
      filesEl.textContent = filesInfo;
    }
  }catch(e){
    setStatus(false,"Architect: offline");
    $("out").textContent = "Î£Ï†Î¬Î»Î¼Î±: " + e.message;
  } finally {
    // Re-enable the button
    const btn = $("generate");
    btn.disabled = false;
    btn.innerHTML = `ğŸš€ <span class="lang-el">Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ Î‘Î¡Î§Î™Î¤Î•ÎšÎ¤ÎŸÎÎ™ÎšÎ—Î£</span>
        <span class="lang-en">GENERATE ARCHITECTURE</span>
        <span class="lang-ja">ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç”Ÿæˆ</span>
        <span class="lang-ru">Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ£</span>
        <span class="lang-es">GENERAR ARQUITECTURA</span>`;
    applyTranslations();
  }
};

// Load wallet from localStorage
const savedWallet = localStorage.getItem('thr_address');
if (savedWallet) {
  $("wallet").value = savedWallet;
}

const langSelectEl = document.getElementById('languageSelect');
if (langSelectEl) {
  langSelectEl.addEventListener('change', (e) => applyTranslations(e.target.value));
}

// Load Models from API
async function loadModels() {
  const modelSel = $("model");
  const previousValue = modelSel.value || "auto";

  // Keep "Auto" option
  modelSel.innerHTML = '<option value="auto">ğŸ”€ Auto (Pythia chooses)</option>';

  try {
    const res = await fetch("/api/ai_models");

    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      console.error("Models API parse error", e);
      setStatus(false, "Models unavailable");
      return;
    }

    const models = Array.isArray(data.models) ? data.models : [];
    const defaultModelId = data.default_model_id || "auto";

    if (!models.length) {
      const autoOnly = document.createElement("option");
      autoOnly.value = defaultModelId;
      autoOnly.textContent = "ğŸ”€ Auto only (router available)";
      modelSel.innerHTML = "";
      modelSel.appendChild(autoOnly);
      return;
    }

    models.forEach((m) => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = `${m.label || m.id}`;
      if (m.enabled === false) {
        opt.disabled = true;
        opt.textContent += " (disabled)";
      }
      modelSel.appendChild(opt);
    });

    if (previousValue && Array.from(modelSel.options).some((o) => o.value === previousValue)) {
      modelSel.value = previousValue;
    } else if (Array.from(modelSel.options).some((o) => o.value === defaultModelId)) {
      modelSel.value = defaultModelId;
    }
  } catch (e) {
    console.warn("Failed to load models from API:", e);
    setStatus(false, "Models unavailable");
  }
  applyTranslations();
}

// Initialize
(async () => {
  applyTranslations();
  try {
    await Promise.all([loadBlueprints(), loadModels()]);
    setStatus(true);
  } catch(e) {
    setStatus(false);
    console.error("Failed to load data:", e);
  }
})();
</script>
</body>
</html>
