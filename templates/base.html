<!DOCTYPE html>
<html>
<head>
  <title>{% block title %}Thronos Network{% endblock %}</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="cgminer-kit-url" content="{{ CGMINER_KIT_URL if CGMINER_KIT_URL is defined else '' }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/thronos-token.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='img/thronos-token.png') }}">
  <script>
  (function() {
    const host = window.location.hostname;
    const isVercel = host.endsWith("vercel.app") || host === "thrchain.vercel.app";
    const origin = window.location.origin;
    window.__API_BASE__ = origin;
    window.THRONOS_API_BASE = origin;
    window.THRONOS_CONFIG = {
      apiReadBase: isVercel ? "/api/v1/read/api" : "/api",
      apiWriteBase: isVercel ? "/api/v1/write/api" : "/api",
      apiMusicBase: isVercel ? "/api/v1/read/api" : "/api",
      apiBase: "/api",
      masterUrl: origin,
      MASTER_PUBLIC_URL: origin,
      mediaBase: "/media",
      musicEnabled: true
    };
    window.normalizeMediaUrl = function normalizeMediaUrl(urlOrPath) {
      if (!urlOrPath) return "";
      const base = window.__API_BASE__ || window.location.origin;
      const raw = String(urlOrPath).trim();
      if (!raw) return "";

      if (/^https?:\/\/localhost:\d+/i.test(raw)) {
        return raw.replace(/^https?:\/\/localhost:\d+/i, base);
      }

      if (raw.startsWith("/media/")) {
        return new URL(raw, base).toString();
      }

      if (/^https?:\/\//i.test(raw)) {
        return raw;
      }

      return new URL(raw, base).toString();
    };
  })();
  </script>
  <script src="https://thrchain.vercel.app/static/wallet_session.js"></script>
  <style>
    /* Global Styles */
    body {
      background-color: #000;
      color: #0f0;
      font-family: "Courier New", monospace;
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }
    a {
      color: #0f0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
      background-color: #111;
    }
    h1, h2, h3 {
      color: #0f0;
      border-bottom: 1px solid #0f0;
      padding-bottom: 10px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Navigation Bar */
    .navbar {
      background: rgba(17, 17, 17, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 255, 0, 0.3);
      padding: 40px 0 0 0;
      margin-bottom: 30px;
      display: flex;
      justify-content: center;
      position: relative;
      flex-wrap: wrap;
      min-height: 82px;
      z-index: 3500;
    }

    .nav-list {
      list-style: none;
      margin: 0;
      padding: 12px 0 0 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      position: relative;
      z-index: 3500;
    }

    .nav-item {
      position: relative;
      z-index: 3500;
    }

    .nav-link {
      display: block;
      padding: 15px 20px;
      color: #0f0;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      z-index: 3500;
    }

    .nav-link:hover {
      background-color: rgba(34, 34, 34, 0.6);
      text-decoration: none;
    }
    .thr-logo-icon {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 8px;
      border-radius: 50%;
      box-shadow: 0 0 8px #ff6600;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 8px #ff6600; }
      50% { box-shadow: 0 0 16px #ff9900, 0 0 24px #ff6600; }
    }

    
    /* Dropdown Menu */
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #111;
      min-width: 180px;
      box-shadow: 0px 8px 16px 0px rgba(0,255,0,0.2);
      border: 1px solid #0f0;
      z-index: 3600;
      top: 100%;
      left: 0;
      pointer-events: auto;
    }

    .dropdown-content a {
      color: #0f0;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
      pointer-events: auto;
    }

    .dropdown-content a:hover {
      background-color: #222;
    }

    .nav-item:hover .dropdown-content {
      display: block;
    }
    
    /* Top Bar Controls */
    .top-controls {
        position: absolute;
        top: 8px;
        right: 12px;
        display: flex;
        gap: 10px;
        z-index: 3700;
        flex-wrap: wrap;
        max-width: 360px;
        justify-content: flex-end;
    }
    
    /* Wallet Status Indicator */
    .wallet-status {
        background: #002200;
        color: #0f0;
        border: 1px solid #004400;
        padding: 5px 10px;
        font-size: 0.8em;
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 6px;
        position: relative;
    }
    .wallet-status:hover {
        background: #004400;
    }
    .wallet-status.open .wallet-balance-popup {
        display: block;
    }
    .wallet-fire-icon {
        width: 16px;
        height: 16px;
        vertical-align: middle;
        filter: drop-shadow(0 0 4px #ff6600);
    }

    .music-modal-btn {
        background: rgba(0, 30, 15, 0.9);
        border: 1px solid rgba(0, 255, 102, 0.4);
        color: #00ff66;
        font-size: 0.85em;
        padding: 6px 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .music-modal-btn:hover {
        background: rgba(0, 60, 30, 0.9);
        border-color: rgba(255, 215, 0, 0.6);
        color: #ffd700;
    }

    .music-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        z-index: 4000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .music-modal-content {
        background: linear-gradient(135deg, #001b0f 0%, #000 80%);
        border: 2px solid rgba(0, 255, 102, 0.6);
        border-radius: 12px;
        width: min(860px, 96vw);
        max-height: 90vh;
        overflow: auto;
        padding: 20px;
        color: #e6ffe5;
        box-shadow: 0 0 30px rgba(0, 255, 102, 0.3);
    }
    .music-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        border-bottom: 1px solid rgba(0, 255, 102, 0.3);
        padding-bottom: 10px;
    }
    .music-modal-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #00ff66;
    }
    .music-modal-close {
        background: transparent;
        border: 1px solid rgba(0, 255, 102, 0.4);
        color: #00ff66;
        font-size: 0.9em;
        padding: 4px 10px;
        cursor: pointer;
    }

    /* Wallet Balance Popup Widget */
    .wallet-balance-popup {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
        border: 2px solid;
        border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
        border-radius: 12px;
        padding: 15px;
        min-width: 300px;
        max-width: 360px;
        box-shadow: 0 0 30px rgba(0, 255, 102, 0.3), 0 0 15px rgba(255, 215, 0, 0.2);
        z-index: 3800;
        color: #e6ffe5;
        backdrop-filter: blur(10px);
        pointer-events: auto;
    }
    .music-modal.open {
        display: flex;
    }

    /* Chain Tokens Widget (Footer) ‚Äî AUTO-HIDE FIXED FOOTER */
    .chain-tokens-widget{
        position: relative;
        width: 100%;
        background: linear-gradient(180deg, transparent 0%, rgba(0, 20, 10, 0.92) 20%, rgba(0, 30, 15, 0.98) 100%);
        border-top: 2px solid;
        border-image: linear-gradient(90deg, transparent, #00ff66, #ffd700, #00ff66, transparent) 1;
        backdrop-filter: blur(10px);
        padding: 10px 20px;
    }

    .chain-tokens-footer-meta{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 16px;
        margin-top: 8px;
        font-size: 12px;
        opacity: 0.9;
    }
    .chain-tokens-footer-meta .right{
        text-align:right;
        white-space: nowrap;
    }

    .page-footer-spacer { height: 15vh; min-height: 120px; }

    /* Wallet Login Modal */
    .wallet-login-btn {
        background: linear-gradient(135deg, #00ff66 0%, #ffd700 100%);
        color: #000;
        border: 1px solid #00ff66;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 10px;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0,255,102,0.35);
    }
    .wallet-login-btn:hover {
        box-shadow: 0 0 16px rgba(0,255,102,0.55);
    }
    .wallet-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        pointer-events: none;
    }
    .wallet-modal-overlay.active { display: flex; pointer-events: auto; }
    .wallet-modal {
        background: #0a130e;
        border: 1px solid #0f0;
        border-radius: 12px;
        padding: 20px;
        width: 340px;
        box-shadow: 0 0 20px rgba(0, 255, 102, 0.25);
    }
    .wallet-modal h3 { margin-top: 0; }
    .wallet-modal label { display: block; margin-top: 10px; font-size: 0.9em; color: #9f9; }
    .wallet-modal input {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 8px;
    }
    .wallet-modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        justify-content: flex-end;
    }
    .wallet-modal-actions button {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #0f0;
        background: #001800;
        color: #0f0;
        cursor: pointer;
    }
    .wallet-modal-actions .primary { background: #00ff66; color: #000; }
    .chain-tokens-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
    }
    .chain-supply-box {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chain-supply-label {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .chain-supply-amount {
        font-size: 16px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 5px rgba(0, 255, 102, 0.4));
    }
    .chain-tokens-scroll {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        flex: 1;
        padding: 5px 0;
        max-width: 70%;
    }
    .chain-token-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.1) 0%, rgba(0, 40, 20, 0.3) 100%);
        border: 1px solid rgba(0, 255, 102, 0.3);
        border-radius: 20px;
        white-space: nowrap;
        transition: all 0.3s;
        cursor: default;
    }
    .chain-token-pill:hover {
        border-color: #00ff66;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 40, 20, 0.4) 100%);
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
    }
    .chain-token-logo {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        font-weight: bold;
        border: 1px solid;
    }
    .chain-token-logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
    }
    .chain-token-symbol {
        font-size: 11px;
        font-weight: 600;
        color: #e6ffe5;
    }
    .chain-token-supply {
        font-size: 10px;
        color: #56ff9a;
        font-family: monospace;
    }
    .chain-token-holders {
        font-size: 9px;
        color: #ffd700;
        font-family: monospace;
        padding: 2px 4px;
        background: rgba(255, 215, 0, 0.1);
        border-radius: 4px;
    }
    .wallet-popup-header {
        font-size: 13px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
        border-image: linear-gradient(90deg, transparent, #00ff66, transparent) 1;
        text-align: center;
        letter-spacing: 1px;
        text-transform: uppercase;
    }
    .wallet-popup-tokens {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
    }
    .wallet-popup-token {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.2) 0%, rgba(0, 255, 102, 0.05) 100%);
        border-radius: 10px;
        border: 1px solid rgba(0, 255, 102, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    .wallet-popup-token::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
        transition: left 0.5s;
    }
    .wallet-popup-token:hover {
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.4) 0%, rgba(0, 255, 102, 0.1) 100%);
        border-color: #00ff66;
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.2), inset 0 0 10px rgba(0, 255, 102, 0.05);
        transform: translateX(-2px);
    }
    .wallet-popup-token:hover::before {
        left: 100%;
    }
    .wallet-popup-logo {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        border: 1px solid;
    }
    .wallet-popup-logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
    }
    .wallet-popup-info {
        flex: 1;
        font-size: 11px;
    }
    .wallet-popup-symbol {
        font-weight: 600;
        color: #e6ffe5;
    }
    .wallet-popup-balance {
        text-align: right;
        font-size: 12px;
        font-weight: 600;
        font-family: monospace;
    }
    .wallet-popup-total {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #1a3b2e;
        text-align: center;
        font-size: 11px;
        color: #56ff9a;
    }
    .wallet-popup-total-amount {
        font-size: 18px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-top: 4px;
        filter: drop-shadow(0 0 10px rgba(0, 255, 102, 0.5));
        animation: popup-balance-glow 2s ease-in-out infinite;
    }
    @keyframes popup-balance-glow {
        0%, 100% {
            filter: drop-shadow(0 0 10px rgba(0, 255, 102, 0.5));
        }
        50% {
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
        }
    }
    .wallet-popup-loading {
        text-align: center;
        padding: 20px;
        color: #56ff9a;
        font-size: 11px;
    }
    .wallet-popup-spinner {
        border: 2px solid rgba(0, 255, 102, 0.2);
        border-top: 2px solid #00ff66;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    .wallet-popup-actions {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid #1a3b2e;
        display: flex;
        gap: 8px;
    }

    /* PR-5: Wallet Tabs */
    .wallet-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(0, 255, 102, 0.15);
    }
    .wallet-tab-btn {
        flex: 1;
        padding: 8px 12px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: #56ff9a;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s;
        font-family: "Courier New", monospace;
    }
    .wallet-tab-btn:hover {
        background: rgba(0, 255, 102, 0.08);
        color: #00ff66;
    }
    .wallet-tab-btn.active {
        color: #00ff66;
        border-bottom-color: #00ff66;
        background: rgba(0, 255, 102, 0.1);
    }
    .wallet-tab-content {
        display: none;
    }
    .wallet-tab-content.active {
        display: block;
    }

    /* PR-5: Music Tab Styles */
    .music-section {
        margin-bottom: 16px;
    }
    .music-section-title {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid rgba(0, 255, 102, 0.1);
    }
    .music-track-item, .music-playlist-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.15) 0%, rgba(0, 255, 102, 0.03) 100%);
        border-radius: 6px;
        border: 1px solid rgba(0, 255, 102, 0.1);
        margin-bottom: 4px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .music-track-item:hover, .music-playlist-item:hover {
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.25) 0%, rgba(0, 255, 102, 0.06) 100%);
        border-color: rgba(0, 255, 102, 0.2);
        transform: translateX(-2px);
    }
    .music-track-info, .music-playlist-info {
        flex: 1;
        min-width: 0;
    }
    .music-track-title, .music-playlist-name {
        font-size: 11px;
        font-weight: 600;
        color: #e6ffe5;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .music-track-artist {
        font-size: 9px;
        color: #56ff9a;
        opacity: 0.8;
    }
    .music-playlist-count {
        font-size: 9px;
        color: #56ff9a;
        opacity: 0.8;
    }
    .music-empty {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 10px;
    }
    .music-create-btn {
        width: 100%;
        padding: 8px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.1) 0%, rgba(0, 255, 102, 0.2) 100%);
        border: 1px solid rgba(0, 255, 102, 0.3);
        color: #00ff66;
        cursor: pointer;
        font-size: 10px;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.2s;
        font-family: "Courier New", monospace;
    }
    .music-create-btn:hover {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.3) 100%);
        border-color: #00ff66;
    }

    .wallet-popup-login label {
        display: block;
        margin-top: 10px;
        font-size: 12px;
        color: #9f9;
    }

    .wallet-popup-login input {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 6px;
        box-sizing: border-box;
    }
    .wallet-popup-btn {
        flex: 1;
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.1) 0%, rgba(0, 255, 102, 0.2) 100%);
        border: 1px solid #00ff66;
        color: #00ff66;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s;
        border-radius: 6px;
        font-family: "Courier New", monospace;
    }
    .wallet-popup-btn:hover {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.3) 100%);
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.3);
        transform: translateY(-1px);
    }

    /* Enhanced Wallet Widget Styles */
    .wallet-popup-address {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.4);
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid rgba(0, 255, 102, 0.15);
    }
    .wallet-popup-address-text {
        flex: 1;
        font-family: monospace;
        font-size: 11px;
        color: #56ff9a;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .wallet-popup-copy-btn {
        background: rgba(0, 255, 102, 0.15);
        border: 1px solid rgba(0, 255, 102, 0.3);
        color: #00ff66;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.2s;
    }
    .wallet-popup-copy-btn:hover {
        background: rgba(0, 255, 102, 0.25);
        border-color: #00ff66;
    }

    /* Portfolio Summary */
    .wallet-portfolio-summary {
        background: linear-gradient(135deg, rgba(0, 40, 20, 0.6) 0%, rgba(0, 60, 30, 0.4) 100%);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
    }
    .wallet-portfolio-label {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
    }
    .wallet-portfolio-value {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
    }
    .wallet-portfolio-usd {
        font-size: 12px;
        color: #a0a0a0;
        margin-top: 2px;
    }
    .wallet-portfolio-btc {
        font-size: 11px;
        color: #f7931a;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Token List Enhanced */
    .wallet-token-list {
        max-height: 250px;
        overflow-y: auto;
        padding-right: 4px;
    }
    .wallet-token-list::-webkit-scrollbar {
        width: 4px;
    }
    .wallet-token-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 2px;
    }
    .wallet-token-list::-webkit-scrollbar-thumb {
        background: rgba(0, 255, 102, 0.3);
        border-radius: 2px;
    }
    .wallet-token-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.15) 0%, rgba(0, 255, 102, 0.03) 100%);
        border-radius: 8px;
        border: 1px solid rgba(0, 255, 102, 0.1);
        margin-bottom: 6px;
        transition: all 0.2s;
    }
    .wallet-token-item:hover {
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.3) 0%, rgba(0, 255, 102, 0.08) 100%);
        border-color: rgba(0, 255, 102, 0.25);
        transform: translateX(-2px);
    }
    .wallet-token-logo {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        border: 2px solid;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    .wallet-token-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .wallet-token-info {
        flex: 1;
        min-width: 0;
    }
    .wallet-token-name {
        font-size: 12px;
        font-weight: 600;
        color: #e6ffe5;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .wallet-token-symbol {
        font-size: 10px;
        color: #56ff9a;
        opacity: 0.8;
    }
    .wallet-token-values {
        text-align: right;
    }
    .wallet-token-balance {
        font-size: 13px;
        font-weight: 600;
        color: #e6ffe5;
        font-family: monospace;
    }
    .wallet-token-usd {
        font-size: 10px;
        color: #a0a0a0;
    }
    .wallet-token-thr-value {
        font-size: 10px;
        color: #ff9900;
        font-family: monospace;
    }

    /* Quick Actions */
    .wallet-quick-actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(0, 255, 102, 0.15);
    }
    .wallet-quick-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 10px 8px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.08) 0%, rgba(0, 255, 102, 0.15) 100%);
        border: 1px solid rgba(0, 255, 102, 0.25);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    .wallet-quick-btn:hover {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.15) 0%, rgba(0, 255, 102, 0.25) 100%);
        border-color: #00ff66;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 255, 102, 0.2);
    }
    .wallet-quick-btn-icon {
        font-size: 18px;
    }
    .wallet-quick-btn-label {
        font-size: 9px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Send Modal */
    .send-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }
    .send-modal.active {
        display: flex;
        pointer-events: auto;
    }
    .send-modal-content {
        background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
        border: 2px solid;
        border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 0 40px rgba(0, 255, 102, 0.4);
    }
    .send-modal-header {
        font-size: 16px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
        border-image: linear-gradient(90deg, transparent, #00ff66, transparent) 1;
        text-align: center;
    }
    .send-form-group {
        margin-bottom: 12px;
    }
    .send-form-label {
        display: block;
        font-size: 11px;
        color: #56ff9a;
        margin-bottom: 5px;
        font-weight: 600;
    }
    .send-form-input {
        width: 100%;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #1a3b2e;
        color: #e6ffe5;
        font-family: "Courier New", monospace;
        font-size: 12px;
        border-radius: 6px;
        transition: border-color 0.3s;
    }
    .send-form-input:focus {
        outline: none;
        border-color: #00ff66;
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
    }
    .send-speed-options {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }
    .send-speed-option {
        flex: 1;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #1a3b2e;
        cursor: pointer;
        border-radius: 6px;
        text-align: center;
        transition: all 0.3s;
    }
    .send-speed-option:hover {
        border-color: #00ff66;
    }
    .send-speed-option.selected {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.1) 100%);
        border-color: #00ff66;
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.2);
    }
    .send-speed-label {
        font-size: 11px;
        font-weight: 600;
        color: #00ff66;
        margin-bottom: 3px;
    }
    .send-speed-fee {
        font-size: 9px;
        color: #56ff9a;
    }
    .send-modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .send-modal-btn {
        flex: 1;
        padding: 10px;
        border: 1px solid;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        transition: all 0.3s;
    }
    .send-modal-btn-primary {
        background: linear-gradient(135deg, #00ff00 0%, #00ff66 100%);
        color: #000;
        border-color: #00ff66;
    }
    .send-modal-btn-primary:hover {
        box-shadow: 0 0 20px rgba(0, 255, 102, 0.4);
        transform: translateY(-1px);
    }
    .send-modal-btn-secondary {
        background: transparent;
        color: #00ff66;
        border-color: #1a3b2e;
    }
    .send-modal-btn-secondary:hover {
        border-color: #00ff66;
        background: rgba(0, 255, 102, 0.1);
    }
    .send-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 6px;
        font-size: 11px;
        display: none;
    }
    .send-result.success {
        background: rgba(0, 255, 102, 0.1);
        border: 1px solid #00ff66;
        color: #00ff66;
    }
    .send-result.error {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff0000;
        color: #ff6666;
    }

    /* Network Selection */
    .send-network-options {
        display: flex;
        gap: 10px;
    }
    .send-network-option {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #1a3b2e;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s;
        position: relative;
    }
    .send-network-option:hover {
        border-color: #00ff66;
    }
    .send-network-option.selected {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.1) 100%);
        border-color: #00ff66;
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.2);
    }
    .send-network-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .coming-soon-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #f7931a 0%, #ffb347 100%);
        color: #000;
        font-size: 8px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 10px;
        text-transform: uppercase;
    }

    /* Token Select */
    .send-token-select {
        cursor: pointer;
    }
    .token-balance-info {
        margin-top: 6px;
        font-size: 10px;
        color: #56ff9a;
    }
    #availableBalance {
        font-family: monospace;
        color: #00ff66;
        font-weight: 600;
    }

    /* Max Amount Button */
    .max-amount-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
        color: #000;
        border: none;
        padding: 4px 10px;
        font-size: 10px;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .max-amount-btn:hover {
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.4);
        transform: translateY(-50%) scale(1.05);
    }
    
    /* Disconnect Button */
    .disconnect-btn {
        background: #220000;
        color: #f00;
        border: 1px solid #440000;
        padding: 5px 10px;
        font-size: 0.8em;
        cursor: pointer;
        display: none;
    }
    .disconnect-btn:hover {
        background: #440000;
    }
    
    /* Language Toggle */
    /* PRIORITY 8: Language dropdown (5 languages) */
    .lang-toggle {
        background: #222;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 5px 10px;
        cursor: pointer;
    }

    .lang-dropdown {
        position: relative;
        display: inline-block;
    }

    .lang-dropdown-btn {
        background: linear-gradient(135deg, #003311 0%, #001a0a 100%);
        color: #00ff66;
        border: 1px solid #00ff66;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 0 8px rgba(0, 255, 102, 0.2);
        transition: all 0.2s ease;
    }

    .lang-dropdown-btn:hover {
        background: linear-gradient(135deg, #004422 0%, #002211 100%);
        box-shadow: 0 0 12px rgba(0, 255, 102, 0.4);
    }

    .lang-dropdown-content {
        display: none;
        position: absolute;
        background: #0a130e;
        min-width: 140px;
        box-shadow: 0 4px 20px rgba(0, 255, 102, 0.3);
        z-index: 3800;
        border: 1px solid #00ff66;
        border-radius: 8px;
        overflow: hidden;
        top: 100%;
        right: 0;
        margin-top: 4px;
    }

    .lang-dropdown.active .lang-dropdown-content {
        display: block;
    }

    .lang-dropdown-item {
        color: #00ff66;
        padding: 10px 16px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s ease;
        border-bottom: 1px solid rgba(0, 255, 102, 0.1);
    }

    .lang-dropdown-item:last-child {
        border-bottom: none;
    }

    .lang-dropdown-item:hover {
        background: rgba(0, 255, 102, 0.1);
    }

    .lang-dropdown-item.active {
        background: rgba(0, 255, 102, 0.15);
        font-weight: 700;
    }

    .lang-en, .lang-ja, .lang-es, .lang-ru { display: none; }

    /* Utility Classes */
    .highlight { color: #ff0; }
    .btn {
        display: inline-block;
        background: #0f0;
        color: #000;
        padding: 10px 20px;
        font-weight: bold;
        text-decoration: none;
        border: 1px solid #000;
        cursor: pointer;
    }
    .btn:hover { background: #0c0; }
    
    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(0,0,0,0.3);
        border-radius: 50%;
        border-top-color: #000;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
        vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .wallet-popup-topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px;}
    .wallet-popup-title{font-size:12px;opacity:.85;}
    .wallet-popup-actions{display:flex;gap:6px;}
    .wallet-mini-btn{background:transparent;border:1px solid rgba(0,255,102,.25);color:#00ff66;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer;}
    .wallet-mini-btn:hover{border-color:rgba(0,255,102,.55);}
    .wallet-mini-btn.active{background:rgba(0,255,102,.12);}
    .wallet-lock-hint{margin-top:8px;font-size:11px;opacity:.7;}

    /* Token Info Modal */
    .token-info-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.92);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    .token-info-modal.active {
        display: flex;
    }
    .token-info-content {
        background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
        border: 2px solid;
        border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
        border-radius: 16px;
        padding: 25px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 0 50px rgba(0, 255, 102, 0.4), 0 0 100px rgba(255, 215, 0, 0.2);
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
    }
    .token-info-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: 1px solid rgba(255, 100, 100, 0.3);
        color: #ff6666;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    .token-info-close:hover {
        background: rgba(255, 100, 100, 0.2);
        border-color: #ff6666;
    }
    .token-info-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(0, 255, 102, 0.2);
    }
    .token-info-logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        border: 3px solid;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    .token-info-logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .token-info-title {
        flex: 1;
    }
    .token-info-name {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .token-info-symbol {
        font-size: 14px;
        color: #56ff9a;
        margin-top: 2px;
    }
    .token-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    .token-info-stat {
        background: linear-gradient(135deg, rgba(0, 40, 20, 0.5) 0%, rgba(0, 60, 30, 0.3) 100%);
        border: 1px solid rgba(0, 255, 102, 0.15);
        border-radius: 10px;
        padding: 12px;
        text-align: center;
    }
    .token-info-stat-label {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
    }
    .token-info-stat-value {
        font-size: 16px;
        font-weight: 600;
        color: #e6ffe5;
        font-family: monospace;
    }
    .token-info-description {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(0, 255, 102, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #a0d8b0;
        line-height: 1.5;
    }
    .token-info-properties {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }
    .token-info-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .token-info-badge.transferable {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.1) 100%);
        border: 1px solid #00ff66;
        color: #00ff66;
    }
    .token-info-badge.not-transferable {
        background: linear-gradient(135deg, rgba(255, 100, 100, 0.2) 0%, rgba(255, 100, 100, 0.1) 100%);
        border: 1px solid #ff6666;
        color: #ff6666;
    }
    .token-info-badge.burnable {
        background: linear-gradient(135deg, rgba(255, 150, 0, 0.2) 0%, rgba(255, 150, 0, 0.1) 100%);
        border: 1px solid #ff9600;
        color: #ff9600;
    }
    .token-info-badge.mintable {
        background: linear-gradient(135deg, rgba(0, 191, 255, 0.2) 0%, rgba(0, 191, 255, 0.1) 100%);
        border: 1px solid #00bfff;
        color: #00bfff;
    }
    .token-info-actions {
        display: flex;
        gap: 10px;
    }
    .token-info-btn {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-family: "Courier New", monospace;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .token-info-btn-send {
        background: linear-gradient(135deg, #00ff00 0%, #00ff66 100%);
        color: #000;
        border: 1px solid #00ff66;
    }
    .token-info-btn-send:hover {
        box-shadow: 0 0 20px rgba(0, 255, 102, 0.4);
        transform: translateY(-2px);
    }
    .token-info-btn-send.disabled {
        background: rgba(100, 100, 100, 0.3);
        border-color: #666;
        color: #888;
        cursor: not-allowed;
    }
    .token-info-btn-secondary {
        background: transparent;
        color: #00ff66;
        border: 1px solid rgba(0, 255, 102, 0.3);
    }
    .token-info-btn-secondary:hover {
        border-color: #00ff66;
        background: rgba(0, 255, 102, 0.1);
    }
    .token-info-creator {
        font-size: 11px;
        color: #666;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .token-info-creator a {
        color: #56ff9a;
    }

    /* Page Specific Styles Block */
    {% block styles %}{% endblock %}

 </style>
</head>
<body>

<div class="top-controls">
    <button id="walletLoginBtn" class="wallet-login-btn" onclick="openHeaderWalletModal()">
        üíº <span class="lang-el">Œ£œçŒΩŒ¥ŒµœÉŒ∑</span><span class="lang-en">Login</span>
    </button>
    <div id="walletStatus" class="wallet-status">
        <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="üî•" class="wallet-fire-icon" />
        <span id="walletAddrShort"></span>

        <!-- Wallet Balance Popup Widget -->
        <div class="wallet-balance-popup" id="walletBalancePopup" onclick="event.stopPropagation();">
            <div class="wallet-popup-topbar">
                <div class="wallet-popup-title">Wallet</div>
                <div class="wallet-popup-actions">
                    <button id="walletPinBtn" class="wallet-mini-btn" title="Pin">Pin</button>
                    <button id="walletLockBtn" class="wallet-mini-btn" title="Lock">Lock</button>
                </div>
            </div>

            <div id="walletLoginSection" class="wallet-popup-login" style="display:none;">
                <label for="walletWidgetAddress">THR Address</label>
                <input type="text" id="walletWidgetAddress" placeholder="THR..." />
                <label for="walletWidgetSecret">Send Secret</label>
                <input type="password" id="walletWidgetSecret" placeholder="send_secret" />
                <label for="walletWidgetPin">PIN (optional)</label>
                <input type="password" id="walletWidgetPin" placeholder="4-8 digits" />
                <div class="wallet-modal-actions" style="margin-top:10px;">
                    <button class="primary" onclick="submitHeaderWalletLogin()">Save</button>
                </div>
                <div style="font-size:11px; color:#9f9; opacity:0.7; margin-top:6px;">
                    Stored locally (thr_address, send_secret, wallet_pin).
                </div>
            </div>

            <div id="walletContentSection">
                <div class="wallet-popup-loading">
                    <div class="wallet-popup-spinner"></div>
                    Loading balances...
                </div>
            </div>
        </div>
    </div>
    <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectWallet()">
        ‚úñ <span class="lang-el">ŒëœÄŒøœÉœçŒΩŒ¥ŒµœÉŒ∑</span><span class="lang-en">Disconnect</span>
    </button>
    <!-- PRIORITY 8: Language dropdown (5 languages: EN/EL/ES/RU/JA) -->
    <div class="lang-dropdown" id="langDropdown">
        <button class="lang-dropdown-btn" onclick="toggleLangDropdown(event)">
            <span id="currentLangFlag">üá¨üá∑</span>
            <span id="currentLangCode">GR</span>
            <span style="font-size: 10px;">‚ñº</span>
        </button>
        <div class="lang-dropdown-content">
            <div class="lang-dropdown-item" data-lang="gr" onclick="selectLanguageFromDropdown('gr')">
                <span>üá¨üá∑</span>
                <span>ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (GR)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="en" onclick="selectLanguageFromDropdown('en')">
                <span>üá¨üáß</span>
                <span>English (EN)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="es" onclick="selectLanguageFromDropdown('es')">
                <span>üá™üá∏</span>
                <span>Espa√±ol (ES)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="ru" onclick="selectLanguageFromDropdown('ru')">
                <span>üá∑üá∫</span>
                <span>–†—É—Å—Å–∫–∏–π (RU)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="ja" onclick="selectLanguageFromDropdown('ja')">
                <span>üáØüáµ</span>
                <span>Êó•Êú¨Ë™û (JA)</span>
            </div>
        </div>
    </div>
</div>

<!-- Send Modal -->
<div class="send-modal" id="sendModal" onclick="closeSendModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">üí∏ <span class="lang-el">ŒëœÄŒøœÉœÑŒøŒªŒÆ Tokens</span><span class="lang-en">Send Tokens</span></div>

        <!-- Network Selection -->
        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">ŒîŒØŒ∫œÑœÖŒø</span><span class="lang-en">Network</span></label>
            <div class="send-network-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                <div class="send-network-option selected" data-network="thronos" onclick="selectNetwork('thronos')">
                    <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="THR" style="width: 20px; height: 20px; border-radius: 50%;">
                    <span>Thronos Chain</span>
                </div>
                <div class="send-network-option" data-network="bitcoin" onclick="selectNetwork('bitcoin')">
                    <span style="font-size: 18px;">‚Çø</span>
                    <span>Bitcoin</span>
                </div>
                <div class="send-network-option" data-network="ethereum" onclick="selectNetwork('ethereum')">
                    <span style="font-size: 18px;">Œû</span>
                    <span>Ethereum</span>
                </div>
                <div class="send-network-option" data-network="bnb" onclick="selectNetwork('bnb')">
                    <span style="font-size: 18px;">üî∂</span>
                    <span>BNB Chain</span>
                </div>
                <div class="send-network-option" data-network="xrp" onclick="selectNetwork('xrp')">
                    <span style="font-size: 18px;">‚óÜ</span>
                    <span>XRP Ledger</span>
                </div>
                <div class="send-network-option" data-network="solana" onclick="selectNetwork('solana')">
                    <span style="font-size: 18px;">‚óé</span>
                    <span>Solana</span>
                    <span class="coming-soon-badge"><span class="lang-el">Œ£œçŒΩœÑŒøŒºŒ±</span><span class="lang-en">Soon</span></span>
                </div>
            </div>
        </div>

        <!-- Token Selection -->
        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Token</span><span class="lang-en">Token</span></label>
            <select id="sendToken" class="send-form-input send-token-select" onchange="updateTokenInfo()">
                <option value="THR" data-color="#ff6600">THR - Thronos</option>
                <option value="WBTC" data-color="#f7931a">WBTC - Wrapped Bitcoin</option>
                <option value="L2E" data-color="#00bfff">L2E - Learn-to-Earn</option>
            </select>
            <div id="tokenBalanceInfo" class="token-balance-info">
                <span class="lang-el">ŒîŒπŒ±Œ∏Œ≠œÉŒπŒºŒø:</span><span class="lang-en">Available:</span>
                <span id="availableBalance">0.000000</span>
            </div>
        </div>

        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Œ†Œ±œÅŒ±ŒªŒÆœÄœÑŒ∑œÇ</span><span class="lang-en">Recipient Address</span></label>
            <input type="text" id="sendTo" class="send-form-input" placeholder="THR..." />
        </div>

        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Œ†ŒøœÉœå</span><span class="lang-en">Amount</span></label>
            <div style="position: relative;">
                <input type="number" id="sendAmount" class="send-form-input" placeholder="0.000000" step="0.000001" />
                <button type="button" onclick="setMaxAmount()" class="max-amount-btn">MAX</button>
            </div>
        </div>

        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Œ§Œ±œáœçœÑŒ∑œÑŒ± Œ£œÖŒΩŒ±ŒªŒªŒ±Œ≥ŒÆœÇ</span><span class="lang-en">Transaction Speed</span></label>
            <div class="send-speed-options">
                <div class="send-speed-option" data-speed="slow" onclick="selectSpeed('slow')">
                    <div class="send-speed-label">üê¢ <span class="lang-el">ŒëœÅŒ≥ŒÆ</span><span class="lang-en">Slow</span></div>
                    <div class="send-speed-fee">0.09% fee</div>
                </div>
                <div class="send-speed-option selected" data-speed="fast" onclick="selectSpeed('fast')">
                    <div class="send-speed-label">‚ö° <span class="lang-el">ŒìœÅŒÆŒ≥ŒøœÅŒ∑</span><span class="lang-en">Fast</span></div>
                    <div class="send-speed-fee">0.5% fee</div>
                </div>
            </div>
        </div>

        <div class="send-result" id="sendResult"></div>

        <div class="send-modal-actions">
            <button class="send-modal-btn send-modal-btn-secondary" onclick="closeSendModal()">
                <span class="lang-el">ŒëŒ∫œçœÅœâœÉŒ∑</span><span class="lang-en">Cancel</span>
            </button>
            <button class="send-modal-btn send-modal-btn-primary" onclick="submitSend()">
                <span class="lang-el">ŒëœÄŒøœÉœÑŒøŒªŒÆ</span><span class="lang-en">Send</span>
            </button>
        </div>
    </div>
</div>

<!-- Receive Modal -->
<div class="send-modal" id="receiveModal" onclick="closeReceiveModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">
            üì•
            <span class="lang-el">ŒõŒÆœàŒ∑ Tokens</span>
            <span class="lang-en">Receive Tokens</span>
            <span class="lang-ja">„Éà„Éº„ÇØ„É≥Âèó„ÅëÂèñ„Çä</span>
            <span class="lang-es">Recibir Tokens</span>
            <span class="lang-ru">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</span>
        </div>

        <!-- Network Selection for Receive -->
        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">ŒîŒØŒ∫œÑœÖŒø</span><span class="lang-en">Network</span></label>
            <div class="send-network-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px;">
                <div class="send-network-option selected" data-network="thronos" onclick="selectReceiveNetwork('thronos')">
                    <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="THR" style="width: 18px; height: 18px; border-radius: 50%;">
                    <span style="font-size: 11px;">Thronos</span>
                </div>
                <div class="send-network-option" data-network="bitcoin" onclick="selectReceiveNetwork('bitcoin')">
                    <span style="font-size: 16px;">‚Çø</span>
                    <span style="font-size: 11px;">Bitcoin</span>
                </div>
                <div class="send-network-option" data-network="ethereum" onclick="selectReceiveNetwork('ethereum')">
                    <span style="font-size: 16px;">Œû</span>
                    <span style="font-size: 11px;">Ethereum</span>
                </div>
                <div class="send-network-option" data-network="bnb" onclick="selectReceiveNetwork('bnb')">
                    <span style="font-size: 16px;">üî∂</span>
                    <span style="font-size: 11px;">BNB</span>
                </div>
                <div class="send-network-option" data-network="xrp" onclick="selectReceiveNetwork('xrp')">
                    <span style="font-size: 16px;">‚óÜ</span>
                    <span style="font-size: 11px;">XRP</span>
                </div>
            </div>
        </div>

        <div id="receiveContent">
            <div class="send-form-group">
                <label class="send-form-label">
                    <span class="lang-el">ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑ ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑œÇ</span>
                    <span class="lang-en">Deposit Address</span>
                    <span class="lang-ja">ÂÖ•Èáë„Ç¢„Éâ„É¨„Çπ</span>
                    <span class="lang-es">Direcci√≥n de dep√≥sito</span>
                    <span class="lang-ru">–ê–¥—Ä–µ—Å –¥–µ–ø–æ–∑–∏—Ç–∞</span>
                </label>
                <div id="receiveNetworkLabel" style="font-size: 11px; color: #00bfff; margin-bottom: 6px;">
                    <span class="lang-el">ŒîŒØŒ∫œÑœÖŒø: Thronos Chain</span>
                    <span class="lang-en">Network: Thronos Chain</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;word-break:break-all;">
                    <code id="receiveAddress" style="font-size:13px;">‚Äî</code>
                    <button class="send-modal-btn" style="padding:6px 10px;" onclick="copyReceiveAddress()">üìã
                        <span class="lang-el">ŒëŒΩœÑŒπŒ≥œÅŒ±œÜŒÆ</span>
                        <span class="lang-en">Copy</span>
                        <span class="lang-ja">„Ç≥„Éî„Éº</span>
                        <span class="lang-es">Copiar</span>
                        <span class="lang-ru">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
            </div>

            <div class="send-form-group" style="text-align:center;">
                <img id="receiveQr" src="" alt="QR" style="max-width:200px;border:1px solid #0f0;border-radius:10px;display:none;" loading="lazy">
                <div id="receiveQrHint" style="font-size:12px;color:#9fdfb4;margin-top:8px;">
                    <span class="lang-el">Œ£Œ∫Œ¨ŒΩŒ±œÅŒµ œÑŒø QR Œ≥ŒπŒ± ŒΩŒ± ŒªŒ¨Œ≤ŒµŒπœÇ THR.</span>
                    <span class="lang-en">Scan this QR to receive THR.</span>
                    <span class="lang-ja">„Åì„ÅÆQR„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶THR„ÇíÂèó„ÅëÂèñ„Çã„ÄÇ</span>
                    <span class="lang-es">Escanea este QR para recibir THR.</span>
                    <span class="lang-ru">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å THR.</span>
                </div>
            </div>

            <div class="send-form-group" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                <audio id="receiveAudio" src=""></audio>
                <button class="send-speed-option selected" style="flex:0;" onclick="playReceiveAudio()">üîä
                    <span class="lang-el">ŒëŒΩŒ±œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆ ŒâœáŒøœÖ</span>
                    <span class="lang-en">Play Audio</span>
                    <span class="lang-ja">ÂÜçÁîü</span>
                    <span class="lang-es">Reproducir</span>
                    <span class="lang-ru">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</span>
                </button>
                <a id="receiveDownload" class="send-speed-option" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;" download="ThronosAddress.wav">
                    ‚¨áÔ∏è
                    <span class="lang-el">ŒõŒÆœàŒ∑ ŒâœáŒøœÖ</span>
                    <span class="lang-en">Download WAV</span>
                    <span class="lang-ja">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                    <span class="lang-es">Descargar</span>
                    <span class="lang-ru">–°–∫–∞—á–∞—Ç—å</span>
                </a>
            </div>

            <div id="receiveEmpty" class="send-result error" style="display:none;">
                <span class="lang-el">Œ£œÖŒΩŒ¥Œ≠œÉœÑŒµ œÄŒøœÅœÑŒøœÜœåŒªŒπ Œ≥ŒπŒ± ŒΩŒ± ŒµŒºœÜŒ±ŒΩŒπœÉœÑŒµŒØ Œ∑ Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑.</span>
                <span class="lang-en">Connect a wallet to view your address.</span>
                <span class="lang-ja">„Ç¶„Ç©„É¨„ÉÉ„Éà„ÇíÊé•Á∂ö„Åó„Å¶„Ç¢„Éâ„É¨„Çπ„ÇíË°®Á§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span>
                <span class="lang-es">Conecta una cartera para ver tu direcci√≥n.</span>
                <span class="lang-ru">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–¥—Ä–µ—Å.</span>
            </div>
        </div>

        <div style="margin-top:10px;text-align:right;">
            <button class="send-modal-btn" onclick="closeReceiveModal()">
                <span class="lang-el">ŒöŒªŒµŒØœÉŒπŒºŒø</span>
                <span class="lang-en">Close</span>
                <span class="lang-ja">Èñâ„Åò„Çã</span>
                <span class="lang-es">Cerrar</span>
                <span class="lang-ru">–ó–∞–∫—Ä—ã—Ç—å</span>
            </button>
        </div>
    </div>
</div>

<!-- Wallet History Modal -->
<div class="send-modal" id="walletHistoryModal" onclick="closeWalletHistoryModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">
            üìú
            <span class="lang-el">ŒôœÉœÑŒøœÅŒπŒ∫œå Œ£œÖŒΩŒ±ŒªŒªŒ±Œ≥œéŒΩ</span>
            <span class="lang-en">Transaction History</span>
        </div>

        <!-- History Tabs - Full categories -->
        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; padding: 0 4px;">
            <button class="history-tab-btn active" data-filter="all" onclick="filterHistory('all')" style="flex: 1; min-width: 45px; padding: 6px 8px; background: rgba(0,255,102,0.2); border: 1px solid rgba(0,255,102,0.4); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">ŒåŒªŒ±</span><span class="lang-en">All</span>
            </button>
            <button class="history-tab-btn" data-filter="thr" onclick="filterHistory('thr')" style="flex: 1; min-width: 45px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                THR
            </button>
            <button class="history-tab-btn" data-filter="mining" onclick="filterHistory('mining')" style="flex: 1; min-width: 55px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                ‚õèÔ∏è Mining
            </button>
            <button class="history-tab-btn" data-filter="tokens" onclick="filterHistory('tokens')" style="flex: 1; min-width: 50px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                Tokens
            </button>
            <button class="history-tab-btn" data-filter="l2e" onclick="filterHistory('l2e')" style="flex: 1; min-width: 40px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                L2E
            </button>
            <button class="history-tab-btn" data-filter="t2e" onclick="filterHistory('t2e')" style="flex: 1; min-width: 40px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                üöó T2E
            </button>
            <button class="history-tab-btn" data-filter="ai_credits" onclick="filterHistory('ai_credits')" style="flex: 1; min-width: 75px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                AI Credits (Chat)
            </button>
            <button class="history-tab-btn" data-filter="architect" onclick="filterHistory('architect')" style="flex: 1; min-width: 85px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                Architect / AI Jobs
            </button>
            <button class="history-tab-btn" data-filter="iot" onclick="filterHistory('iot')" style="flex: 1; min-width: 40px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                IoT
            </button>
            <button class="history-tab-btn" data-filter="bridge" onclick="filterHistory('bridge')" style="flex: 1; min-width: 50px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                Bridge
            </button>
            <button class="history-tab-btn" data-filter="swaps" onclick="filterHistory('swaps')" style="flex: 1; min-width: 50px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                Swaps
            </button>
            <button class="history-tab-btn" data-filter="liquidity" onclick="filterHistory('liquidity')" style="flex: 1; min-width: 55px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                Liquidity
            </button>
            <button class="history-tab-btn" data-filter="gateway" onclick="filterHistory('gateway')" style="flex: 1; min-width: 55px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                Gateway
            </button>
            <button class="history-tab-btn" data-filter="music" onclick="filterHistory('music')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                üéµ <span class="lang-el">ŒúŒøœÖœÉŒπŒ∫ŒÆ</span><span class="lang-en">Music</span>
            </button>
        </div>

        <div id="tokenIndexBar" style="display:none; margin: 0 4px 10px 4px;">
            <div style="display:flex; align-items:center; gap:6px; overflow-x:auto; padding-bottom:6px; scrollbar-width: thin;" id="tokenIndexScroll"></div>
            <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 4px;">
                <button class="history-tab-btn" style="flex:0 0 auto; min-width: 80px; padding: 6px 8px;" onclick="clearTokenFilter()">All Tokens</button>
                <button class="history-tab-btn" style="flex:0 0 auto; min-width: 80px; padding: 6px 8px;" onclick="shareTokenFilter()">Share / Copy</button>
            </div>
        </div>

        <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ ŒπœÉœÑŒøœÅŒπŒ∫Œøœç...</span>
                <span class="lang-en">Loading history...</span>
            </div>
        </div>

        <div style="margin-top:10px;text-align:right;">
            <button class="send-modal-btn" onclick="closeWalletHistoryModal()">
                <span class="lang-el">ŒöŒªŒµŒØœÉŒπŒºŒø</span>
                <span class="lang-en">Close</span>
            </button>
        </div>
    </div>
</div>

<!-- Bridge Modal -->
<div class="send-modal" id="bridgeModal" onclick="closeBridgeModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">
            üåâ
            <span class="lang-el">Bridge Deposit</span>
            <span class="lang-en">Bridge Deposit</span>
        </div>

        <!-- Deposit-only warning -->
        <div style="background: rgba(255,255,0,0.1); border: 1px solid rgba(255,255,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 11px; color: #ffff99;">
            <div style="font-weight: bold; margin-bottom: 4px;">‚ö†Ô∏è
                <span class="lang-el">ŒúœåŒΩŒø ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑ (BTC‚ÜíThronos)</span>
                <span class="lang-en">Deposit Only (BTC‚ÜíThronos)</span>
            </div>
            <div style="opacity: 0.9;">
                <span class="lang-el">ŒëŒΩŒ±ŒªŒÆœàŒµŒπœÇ Œ±œÄŒµŒΩŒµœÅŒ≥ŒøœÄŒøŒπŒ∑ŒºŒ≠ŒΩŒµœÇ / Œ£œçŒΩœÑŒøŒºŒ± Œ¥ŒπŒ±Œ∏Œ≠œÉŒπŒºŒµœÇ</span>
                <span class="lang-en">Withdrawals disabled / Coming soon</span>
            </div>
        </div>

        <div id="bridgeContent">
            <div class="send-form-group">
                <label class="send-form-label">
                    <span class="lang-el">ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑ ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑œÇ Bridge (œåœáŒπ Pledge)</span>
                    <span class="lang-en">Bridge Deposit Address (not Pledge)</span>
                </label>
                <div style="display:flex;align-items:center;gap:8px;word-break:break-all;">
                    <code id="bridgeDepositAddress" style="font-size:13px;">‚Äî</code>
                    <button class="send-modal-btn" style="padding:6px 10px;" onclick="copyBridgeAddress()">üìã
                        <span class="lang-el">ŒëŒΩœÑŒπŒ≥œÅŒ±œÜŒÆ</span>
                        <span class="lang-en">Copy</span>
                    </button>
                </div>
            </div>

            <div id="bridgeEmpty" class="send-result error" style="display:none;">
                <span class="lang-el">Œ£œÖŒΩŒ¥Œ≠œÉœÑŒµ œÄŒøœÅœÑŒøœÜœåŒªŒπ Œ≥ŒπŒ± bridge deposit.</span>
                <span class="lang-en">Connect wallet to get bridge deposit address.</span>
            </div>
        </div>

        <div style="margin-top:10px;text-align:right;">
            <button class="send-modal-btn" onclick="closeBridgeModal()">
                <span class="lang-el">ŒöŒªŒµŒØœÉŒπŒºŒø</span>
                <span class="lang-en">Close</span>
            </button>
        </div>
    </div>
</div>

<!-- Token Info Modal -->
<div class="token-info-modal" id="tokenInfoModal" onclick="closeTokenInfoModal(event)">
    <div class="token-info-content" onclick="event.stopPropagation()">
        <button class="token-info-close" onclick="closeTokenInfoModal()">‚úï</button>
        <div id="tokenInfoBody">
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ œÄŒªŒ∑œÅŒøœÜŒøœÅŒπœéŒΩ...</span>
                <span class="lang-en">Loading token info...</span>
            </div>
        </div>
    </div>
</div>

<div class="navbar">
  <ul class="nav-list">
    <li class="nav-item brand">
      <span class="nav-link">
        <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="üî•" class="thr-logo-icon" />
        THRONOS
      </span>
    </li>
    <!-- Home -->
    <li class="nav-item">
      <a href="/" class="nav-link">üè† <span class="lang-el">ŒëœÅœáŒπŒ∫ŒÆ</span><span class="lang-en">Home</span><span class="lang-ja">„Éõ„Éº„É†</span><span class="lang-ru">–ì–ª–∞–≤–Ω–∞—è</span><span class="lang-es">Inicio</span></a>
    </li>

    <!-- Apps Dropdown -->
    <li class="nav-item">
      <span class="nav-link">üì± <span class="lang-el">ŒïœÜŒ±œÅŒºŒøŒ≥Œ≠œÇ</span><span class="lang-en">Apps</span><span class="lang-ja">„Ç¢„Éó„É™</span><span class="lang-ru">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span><span class="lang-es">Apps</span> ‚ñº</span>
      <div class="dropdown-content">
        <a href="/send">üí∏ <span class="lang-el">ŒëœÄŒøœÉœÑŒøŒªŒÆ</span><span class="lang-en">Send</span><span class="lang-ja">ÈÄÅÈáë</span><span class="lang-ru">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span><span class="lang-es">Enviar</span></a>
        <a href="/swap">üîÑ Swap</a>
        <a href="/pools">üíß Pools</a>
        <a href="/tokens">ü™ô Tokens</a>
        <a href="/music">üéµ <span class="lang-el">ŒúŒøœÖœÉŒπŒ∫ŒÆ</span><span class="lang-en">Music</span><span class="lang-ja">Èü≥Ê•Ω</span><span class="lang-ru">–ú—É–∑—ã–∫–∞</span><span class="lang-es">M√∫sica</span></a>
        <a href="/nft">üé® <span class="lang-el">NFT ŒëŒ≥ŒøœÅŒ¨</span><span class="lang-en">NFT Market</span><span class="lang-ja">NFT„Éû„Éº„Ç±„ÉÉ„Éà</span><span class="lang-ru">NFT –ú–∞—Ä–∫–µ—Ç</span><span class="lang-es">Mercado NFT</span></a>
        <a href="/gateway">üí≥ Gateway</a>
        <a href="/evm">‚ö° Smart Contracts</a>
        <a href="/courses">üéì <span class="lang-el">ŒúŒ¨Œ∏Œµ & ŒöŒ≠œÅŒ¥ŒπœÉŒµ</span><span class="lang-en">Learn & Earn</span><span class="lang-ja">Â≠¶„Çì„ÅßÁ®º„Åê</span><span class="lang-ru">–£—á–∏—Å—å –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</span><span class="lang-es">Aprende y Gana</span></a>
        <a href="/game">üéÆ <span class="lang-el">Œ†Œ±ŒπœáŒΩŒØŒ¥Œπ</span><span class="lang-en">Game</span><span class="lang-ja">„Ç≤„Éº„É†</span><span class="lang-ru">–ò–≥—Ä–∞</span><span class="lang-es">Juego</span></a>
        <a href="/pledge">üî• <span class="lang-el">ŒîŒ≠œÉŒºŒµœÖœÉŒ∑</span><span class="lang-en">Pledge</span><span class="lang-ja">„Éó„É¨„ÉÉ„Ç∏</span><span class="lang-ru">–ó–∞–ª–æ–≥</span><span class="lang-es">Promesa</span></a>
        <a href="/explorer">üîç Token Explorer</a>
        <a href="/governance">üó≥Ô∏è <span class="lang-el">ŒîŒπŒ±Œ∫œÖŒ≤Œ≠œÅŒΩŒ∑œÉŒ∑</span><span class="lang-en">Governance</span><span class="lang-ja">„Ç¨„Éê„Éä„É≥„Çπ</span><span class="lang-ru">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span><span class="lang-es">Gobernanza</span></a>
        <a href="/viewer">üì¶ Block Viewer</a>
        <a href="/token_chart">üìà <span class="lang-el">ŒìœÅŒ¨œÜŒ∑ŒºŒ± Token</span><span class="lang-en">Token Chart</span><span class="lang-ja">„Éà„Éº„ÇØ„É≥„ÉÅ„É£„Éº„Éà</span><span class="lang-ru">–ì—Ä–∞—Ñ–∏–∫ —Ç–æ–∫–µ–Ω–∞</span><span class="lang-es">Gr√°fico Token</span></a>
      </div>
    </li>

    <!-- Services Dropdown -->
    <li class="nav-item">
      <span class="nav-link">üåê <span class="lang-el">Œ•œÄŒ∑œÅŒµœÉŒØŒµœÇ</span><span class="lang-en">Services</span><span class="lang-ja">„Çµ„Éº„Éì„Çπ</span><span class="lang-ru">–£—Å–ª—É–≥–∏</span><span class="lang-es">Servicios</span> ‚ñº</span>
      <div class="dropdown-content">
        <a href="/bridge">üåâ <span class="lang-el">ŒìŒ≠œÜœÖœÅŒ± BTC</span><span class="lang-en">BTC Bridge</span><span class="lang-ja">BTC„Éñ„É™„ÉÉ„Ç∏</span><span class="lang-ru">BTC –ú–æ—Å—Ç</span><span class="lang-es">Puente BTC</span></a>
        <a href="/iot">üöó <span class="lang-el">IoT ŒöœåŒºŒ≤ŒøŒπ</span><span class="lang-en">IoT Nodes</span><span class="lang-ja">IoT„Éé„Éº„Éâ</span><span class="lang-ru">IoT –£–∑–ª—ã</span><span class="lang-es">Nodos IoT</span></a>
        <a href="/chat">ü§ñ AI Chat</a>
        <a href="/ai_packs">üíé AI Credits</a>
        <a href="/architect">üèóÔ∏è AI Architect</a>
      </div>
    </li>

    <!-- Docs Dropdown -->
    <li class="nav-item">
      <span class="nav-link">üìö <span class="lang-el">ŒàŒ≥Œ≥œÅŒ±œÜŒ±</span><span class="lang-en">Docs</span><span class="lang-ja">„Éâ„Ç≠„É•„É°„É≥„Éà</span><span class="lang-ru">–î–æ–∫—É–º–µ–Ω—Ç—ã</span><span class="lang-es">Documentos</span> ‚ñº</span>
      <div class="dropdown-content">
        <a href="/whitepaper">üìÑ Whitepaper</a>
        <a href="/roadmap">üó∫Ô∏è Roadmap</a>
        <a href="/tokenomics">üìú Tokenomics</a>
      </div>
    </li>

    <!-- Downloads -->
    <li class="nav-item">
      <a href="/downloads" class="nav-link">üì± <span class="lang-el">ŒïœÜŒ±œÅŒºŒøŒ≥Œ≠œÇ</span><span class="lang-en">Apps</span><span class="lang-ja">„Ç¢„Éó„É™</span><span class="lang-ru">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span><span class="lang-es">Apps</span></a>
    </li>

    <!-- Recovery -->
    <li class="nav-item">
      <a href="/recovery" class="nav-link">üõ†Ô∏è <span class="lang-el">ŒëŒΩŒ¨Œ∫œÑŒ∑œÉŒ∑</span><span class="lang-en">Recovery</span><span class="lang-ja">„É™„Ç´„Éê„É™„Éº</span><span class="lang-ru">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span><span class="lang-es">Recuperaci√≥n</span></a>
    </li>
  </ul>
</div>

<div class="container">
  {% block content %}{% endblock %}
</div>

<script>
// Global Language Logic
    window.LANG_SEQUENCE = window.LANG_SEQUENCE || ['gr', 'en', 'ja', 'es', 'ru'];
const LANGUAGE_CLASS_MAP = {
    gr: 'lang-el',
    en: 'lang-en',
    ja: 'lang-ja',
    es: 'lang-es',
    ru: 'lang-ru'
};
const DEFAULT_LANG = 'gr';

function normalizeLang(lang) {
    if (!lang) return DEFAULT_LANG;
    if (lang === 'el') return 'gr';
      return window.LANG_SEQUENCE.includes(lang) ? lang : 'en';
}

// Strip localhost URLs for production safety
function repairMediaUrl(url) {
    if (!url || typeof url !== 'string') return url;
    try {
        if (url.startsWith('/')) return url;
        if (url.startsWith('http://') || url.startsWith('https://')) {
            const urlObj = new URL(url);
            const knownHosts = [window.location.host, 'localhost:5000', 'thrchain.up.railway.app', 'thrchain.vercel.app'];
            if (knownHosts.includes(urlObj.host)) {
                return urlObj.pathname + urlObj.search + urlObj.hash;
            }
        }
        return url;
    } catch (e) { return url; }
}

function getCurrentLang() {
    // PR-5a: Use thr_lang key for consistency, migrate from old 'lang' key
    let savedLang = localStorage.getItem('thr_lang');
    if (!savedLang) {
        // Migrate from old key
        savedLang = localStorage.getItem('lang');
        if (savedLang) {
            localStorage.setItem('thr_lang', savedLang);
            localStorage.removeItem('lang');
        }
    }
    return normalizeLang(savedLang || DEFAULT_LANG);
}

function isGreekLang(lang) {
    return normalizeLang(lang) === 'gr';
}

function toggleLanguage() {
    const currentLang = getCurrentLang();
      const currentIndex = window.LANG_SEQUENCE.indexOf(currentLang);
      const nextIndex = (currentIndex + 1) % window.LANG_SEQUENCE.length;
      setLanguage(window.LANG_SEQUENCE[nextIndex]);
}

function setLanguage(lang) {
    const normalizedLang = normalizeLang(lang);
    // PR-5a: Use thr_lang key for consistency
    localStorage.setItem('thr_lang', normalizedLang);

    const allClasses = Object.values(LANGUAGE_CLASS_MAP);
    allClasses.forEach(cls => {
        document.querySelectorAll(`.${cls}`).forEach(el => el.style.display = 'none');
    });

    const activeClass = LANGUAGE_CLASS_MAP[normalizedLang] || LANGUAGE_CLASS_MAP.en;
    document.querySelectorAll(`.${activeClass}`).forEach(el => el.style.display = 'inline');

    // Fallback to English where no translation exists in the same container
    if (normalizedLang !== 'en') {
        document.querySelectorAll('.lang-en').forEach(el => {
            const parent = el.parentElement;
            const hasSibling = parent ? parent.querySelector(`.${activeClass}`) : null;
            if (!hasSibling) {
                el.style.display = 'inline';
            }
        });
    }

    const toggleBtn = document.querySelector('.lang-toggle');
    if (toggleBtn) {
        toggleBtn.textContent = normalizedLang.toUpperCase();
    }

    // PRIORITY 8: Update dropdown UI
    updateLangDropdownUI(normalizedLang);

    // Trigger custom event for pages that need to re-render content
    window.dispatchEvent(new CustomEvent('langChanged', { detail: { lang: normalizedLang } }));
}

// PRIORITY 8: Language dropdown functions
const LANG_FLAGS = {
    gr: 'üá¨üá∑',
    en: 'üá¨üáß',
    es: 'üá™üá∏',
    ru: 'üá∑üá∫',
    ja: 'üáØüáµ'
};

function updateLangDropdownUI(lang) {
    const flagEl = document.getElementById('currentLangFlag');
    const codeEl = document.getElementById('currentLangCode');

    if (flagEl) flagEl.textContent = LANG_FLAGS[lang] || 'üá¨üáß';
    if (codeEl) codeEl.textContent = lang.toUpperCase();

    // Update active state in dropdown items
    document.querySelectorAll('.lang-dropdown-item').forEach(item => {
        item.classList.toggle('active', item.dataset.lang === lang);
    });
}

function toggleLangDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

function selectLanguageFromDropdown(lang) {
    setLanguage(lang);
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) {
        dropdown.classList.remove('active');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', (event) => {
    const dropdown = document.getElementById('langDropdown');
    if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

// Initialize dropdown on load
document.addEventListener('DOMContentLoaded', () => {
    const currentLang = getCurrentLang();
    updateLangDropdownUI(currentLang);
});

// Disconnect Wallet Function
function disconnectWallet() {
    // Disconnect only clears bound flag, keeps credentials for PIN unlock
    walletSession.disconnect();
    const statusEl = document.getElementById('walletStatus');
    const disconnectBtn = document.getElementById('disconnectBtn');
    if (statusEl) statusEl.classList.remove('open');
    if (disconnectBtn) disconnectBtn.style.display = 'none';
    showWalletLoginForm();
    updateWalletUI();
    walletBalancesLoaded = false;
    window.tokenBalances = {};
    stopWalletPolling();
}

function stopWalletPolling() {
    if (historyPollInterval) {
        clearInterval(historyPollInterval);
        historyPollInterval = null;
    }
    if (txPollInterval) {
        clearInterval(txPollInterval);
        txPollInterval = null;
    }
    if (tokenPriceInterval) {
        clearInterval(tokenPriceInterval);
        tokenPriceInterval = null;
    }
    if (walletBalanceInterval) {
        clearInterval(walletBalanceInterval);
        walletBalanceInterval = null;
    }
    if (chainTokensInterval) {
        clearInterval(chainTokensInterval);
        chainTokensInterval = null;
    }
}

// Forget Device Function (full wipe)
function forgetDeviceAction() {
    if (confirm('This will remove ALL wallet data from this device. Continue?')) {
        walletSession.forgetDevice();
        updateWalletUI();
        updateHeaderWalletUi();
        walletBalancesLoaded = false;
        window.tokenBalances = {};
        if (typeof updateHeroButton === 'function') {
            updateHeroButton('');
        }
        location.reload();
    }
}

// Update Wallet UI (login button visibility)
function updateWalletUI() {
    const loginBtn = document.getElementById('walletLoginBtn');
    const addr = walletSession.getAddress();
    const bound = walletSession.isBound();

    if (loginBtn) {
        // Hide login button when wallet is connected (bound)
        if (bound && addr) {
            loginBtn.style.display = 'none';
        } else {
            loginBtn.style.display = 'inline-block';
        }
    }

    if (typeof updateHeaderWalletUi === 'function') {
        updateHeaderWalletUi();
    }
}

const MASTER_PUBLIC_URL = (window.THRONOS_CONFIG && window.THRONOS_CONFIG.MASTER_PUBLIC_URL)
    ? window.THRONOS_CONFIG.MASTER_PUBLIC_URL.replace(/\/$/, '')
    : '';

function resolveMasterUrl(path) {
    if (!MASTER_PUBLIC_URL) return path;
    const normalized = path.startsWith('/') ? path : `/${path}`;
    return `${MASTER_PUBLIC_URL}${normalized}`;
}

function setDisconnectedUI() {
    if (window.walletSession && typeof walletSession.disconnect === 'function') {
        walletSession.disconnect();
    }
    walletBalancesLoaded = false;
    window.tokenBalances = {};
    if (typeof updateHeaderWalletUi === 'function') {
        updateHeaderWalletUi();
    }
    if (typeof updateWalletUI === 'function') {
        updateWalletUI();
    }
    if (typeof showWalletLoginForm === 'function') {
        showWalletLoginForm();
    }
    setWalletOpen(false);
}

// Wallet Balance Widget Functions
let walletBalancesLoaded = false;

async function loadWalletBalances(force = false) {
    // PR-5a: Guard to prevent multiple simultaneous loads
    if (window.__walletLoadInProgress && !force) return;
    if (walletBalancesLoaded && !force) return; // Only load once

    if (!walletSession.isBound()) {
        walletBalancesLoaded = false;
        showWalletLoginForm();
        return;
    }

    window.__walletLoadInProgress = true;

    const wallet = walletSession.getAddress();
    if (!wallet) {
        showWalletLoginForm();
        return;
    }

    const content = document.getElementById('walletContentSection');
    if (!content) return;

    showWalletContentSection();

    if (force) {
        content.innerHTML = `
            <div class="wallet-popup-header">üíé Wallet Balance</div>
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                Loading balances...
            </div>
        `;
    }

    try {
        // Update token prices before loading balances
        await updateTokenPrices();

        // PR-5a: Use fetchJSONOnce for request coalescing
        // Show all tokens including zero balances for multi-chain assets
        const url = resolveMasterUrl(`/api/balances?address=${encodeURIComponent(wallet)}&show_zero=true`);
        const data = await (window.FetchUtils?.fetchJSONOnce
            ? window.FetchUtils.fetchJSONOnce(url)
            : fetch(url).then(r => {
                if (!r.ok) {
                    throw new Error(`Balance fetch failed (${r.status})`);
                }
                return r.json();
            }));

        renderWalletBalances(data);
        walletBalancesLoaded = true;
    } catch (error) {
        content.innerHTML = `
            <div class="wallet-popup-header">üíé Wallet Balance</div>
            <div style="text-align: center; color: #ff4d4d; font-size: 11px; padding: 10px;">
                Failed to load balances
            </div>
        `;
        setDisconnectedUI();
    } finally {
        // PR-5a: Clear load guard
        window.__walletLoadInProgress = false;
    }
}

// Token logos and prices registry
// ARCHITECTURE:
// - BTC: ONLY pledge asset (BTC ‚Üî THR peg)
// - THR: Priced via peg+pool aggregator (floor = 0.0001 BTC, actual = max(floor, pool_median))
// - L2E + wrapped tokens: Pool-based pricing (AMM)
// - External L1 (ETH, BNB, XRP, SOL): Oracle pricing, bridge only (NO pledge)
const TOKEN_REGISTRY = {
    // === THRONOS-NATIVE TOKENS (AMM POOL-BASED PRICING) ===
    'THR': {
        name: 'Thronos',
        color: '#ff6600',
        logo: '/static/img/thronos-token.png',
        network: 'thronos',
        decimals: 6,
        price_source: 'peg+pool',  // Aggregator: max(peg_floor_from_btc, pool_median)
        priceUSD: null,  // Calculated: thr_peg_in_btc * btc_usd OR pool-based
        price_in_thr: 1.0,  // THR is the base currency
        peg_floor_btc: 0.0001  // 1 THR = 0.0001 BTC (floor from pledge)
    },
    'L2E': {
        name: 'Learn-to-Earn',
        color: '#00bfff',
        logo: '/static/img/l2e-logo.png',
        network: 'thronos',
        decimals: 6,
        category: 'education',  // L2E category for Learn-to-Earn flow
        price_source: 'pool',  // Get price from L2E/THR pool
        priceUSD: null,
        price_in_thr: null  // Will be calculated from L2E/THR pool
    },
    'WBTC': {
        name: 'Wrapped Bitcoin',
        color: '#f7931a',
        logo: '/static/img/wbtc-logo.png',
        network: 'thronos',
        decimals: 8,
        wrapped_of: 'BTC',  // Wrapped version of BTC
        price_source: 'pool',  // Get price from THR/wBTC pool
        priceUSD: null,
        price_in_thr: null  // Will be calculated from pools
    },
    'WETH': {
        name: 'Wrapped Ethereum',
        color: '#627eea',
        logo: '/static/img/weth-logo.png',
        network: 'thronos',
        decimals: 18,
        wrapped_of: 'ETH',
        price_source: 'pool',
        priceUSD: null,
        price_in_thr: null
    },
    'WBNB': {
        name: 'Wrapped BNB',
        color: '#f3ba2f',
        logo: '/static/img/wbnb-logo.png',
        network: 'thronos',
        decimals: 18,
        wrapped_of: 'BNB',
        price_source: 'pool',
        priceUSD: null,
        price_in_thr: null
    },
    'WXRP': {
        name: 'Wrapped XRP',
        color: '#00aae4',
        logo: '/static/img/wxrp-logo.png',
        network: 'thronos',
        decimals: 6,
        wrapped_of: 'XRP',
        price_source: 'pool',
        priceUSD: null,
        price_in_thr: null
    },

    // === EXTERNAL L1 ASSETS ===
    // BTC: ONLY pledge asset (gives THR addresses, establishes peg)
    'BTC': {
        name: 'Bitcoin',
        color: '#f7931a',
        logo: '/static/img/btc-logo.png',
        network: 'bitcoin',
        decimals: 8,
        price_source: 'oracle',  // Get from Gemini/external oracle
        priceUSD: 98500,  // Fallback price (will be updated from /api/token/prices)
        price_in_thr: null,  // Calculated from priceUSD / THR_price
        is_pledge_asset: true,  // ONLY BTC is pledge asset
        tradeable: false  // Not tradeable in AMM (use WBTC instead)
    },

    // Guest chains: Bridge only (NO pledge, NO THR address generation)
    'ETH': {
        name: 'Ethereum',
        color: '#627eea',
        logo: '/static/img/eth-logo.png',
        network: 'ethereum',
        decimals: 18,
        price_source: 'oracle',
        priceUSD: 3800,
        price_in_thr: null,
        is_pledge_asset: false,  // Guest chain - bridge only
        tradeable: false
    },
    'BNB': {
        name: 'BNB',
        color: '#f3ba2f',
        logo: '/static/img/bnb-logo.png',
        network: 'bnb',
        decimals: 18,
        price_source: 'oracle',
        priceUSD: 650,
        price_in_thr: null,
        is_pledge_asset: false,  // Guest chain - bridge only
        tradeable: false
    },
    'XRP': {
        name: 'XRP',
        color: '#00aae4',
        logo: '/static/img/xrp-logo.png',
        network: 'xrp',
        decimals: 6,
        price_source: 'oracle',
        priceUSD: 2.5,
        price_in_thr: null,
        is_pledge_asset: false,  // Guest chain - bridge only
        tradeable: false
    },
    'SOL': {
        name: 'Solana',
        color: '#14f195',
        logo: '/static/img/sol-logo.png',
        network: 'solana',
        decimals: 9,
        price_source: 'oracle',
        priceUSD: 190,
        price_in_thr: null,
        is_pledge_asset: false,  // Guest chain - bridge only
        tradeable: false
    }
};

// Fetch real-time prices (will be called periodically)
async function updateTokenPrices() {
    try {
        const response = await fetch('/api/token/prices');
        const data = await response.json();
        if (data.prices) {
            Object.keys(data.prices).forEach(symbol => {
                if (!TOKEN_REGISTRY[symbol]) return;
                const price = data.prices[symbol];
                if (Number.isFinite(Number(price))) {
                    TOKEN_REGISTRY[symbol].priceUSD = Number(price);
                } else if (price === null) {
                    TOKEN_REGISTRY[symbol].priceUSD = null;
                }
            });
        }
    } catch (e) {
        console.log('Using default token prices');
    }
}

function renderWalletBalances(data) {
    const content = document.getElementById('walletContentSection');
    if(!content) return;
    if(!walletSession.isBound()){
        showWalletLoginForm();
        return;
    }

    const wallet = walletSession.getAddress() || '';
    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    // PR-1b: Use tokens[] from API directly (wallet viewer parity)
    const tokens = Array.isArray(data?.tokens) ? data.tokens : [];

    // PR-1b: Calculate portfolio totals from API value fields (like wallet_viewer)
    const pricedTokens = tokens.filter(t => t.value_in_thr !== null && t.value_in_thr !== undefined);
    const totalTHR = pricedTokens.reduce((sum, t) => sum + Number(t.value_in_thr || 0), 0);
    const totalUSD = pricedTokens.reduce((sum, t) => sum + Number(t.value_usd || 0), 0);
    const totalBTC = pricedTokens.reduce((sum, t) => sum + Number(t.value_wbtc || 0), 0);

    // Labels
    const portfolioLabel = isGreek ? 'Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ ŒëŒæŒØŒ±' : 'Portfolio Value';
    const assetsLabel = isGreek ? 'Œ†ŒµœÅŒπŒøœÖœÉŒπŒ±Œ∫Œ¨ Œ£œÑŒøŒπœáŒµŒØŒ±' : 'Assets';
    const sendLabel = isGreek ? 'ŒëœÄŒøœÉœÑŒøŒªŒÆ' : 'Send';
    const receiveLabel = isGreek ? 'ŒõŒÆœàŒ∑' : 'Receive';
    const swapLabel = 'Swap';
    const bridgeLabel = 'Bridge';
    const pledgeLabel = 'Pledge';
    const historyLabel = isGreek ? 'ŒôœÉœÑŒøœÅŒπŒ∫œå' : 'History';
    const noTokensLabel = isGreek ? 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ tokens' : 'No tokens found';

    // PR-1b: Render token rows using API data directly (null ‚Üí "‚Äî" like wallet_viewer)
    const tokenRows = tokens.filter(t => Number(t.balance) > 0).map(t => {
        const balance = Number(t.balance) || 0;
        const decimals = t.decimals || 6;
        const symbol = t.symbol;
        const name = t.name || symbol;
        const color = t.color || '#00ff66';
        const logo = repairMediaUrl(t.logo_url || t.logo);

        // PR-1b: Use API value fields, display "‚Äî" for null
        const valueInThr = t.value_in_thr !== null && t.value_in_thr !== undefined
            ? Number(t.value_in_thr).toFixed(4) + ' THR'
            : '‚Äî';
        const valueUSD = t.value_usd !== null && t.value_usd !== undefined
            ? `$${Number(t.value_usd).toFixed(2)}`
            : '‚Äî';

        const logoHtml = logo
            ? `<img src="${logo}" alt="${symbol}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <span style="display:none; color:${color}; font-weight:bold;">${symbol[0]}</span>`
            : `<span style="color:${color}; font-weight:bold;">${symbol[0]}</span>`;

        return `
            <div class="wallet-token-item" onclick="openTokenInfoModal('${symbol}')" style="cursor: pointer;" title="Click for token details">
                <div class="wallet-token-logo" style="border-color: ${color}; background: linear-gradient(135deg, ${color}22 0%, ${color}11 100%);">
                    ${logoHtml}
                </div>
                <div class="wallet-token-info">
                    <div class="wallet-token-name">
                        ${escapeHtml(name)}
                        <span class="wallet-token-symbol">${escapeHtml(symbol)}</span>
                    </div>
                    ${symbol !== 'THR' ? `<div class="wallet-token-thr-value">‚âà ${valueInThr}</div>` : ''}
                </div>
                <div class="wallet-token-values">
                    <div class="wallet-token-balance">${balance.toFixed(decimals)} ${symbol}</div>
                    <div class="wallet-token-usd">‚âà ${valueUSD}</div>
                </div>
            </div>
        `;
    }).join('');

    const shortAddr = wallet ? `${wallet.slice(0, 8)}...${wallet.slice(-6)}` : '';

    // PR-5: Tab labels
    const balancesTabLabel = isGreek ? 'Œ•œÄœåŒªŒøŒπœÄŒ±' : 'Balances';
    const musicTabLabel = isGreek ? 'ŒúŒøœÖœÉŒπŒ∫ŒÆ' : 'Music';

    const html = `
        <div class="wallet-popup-header">
            <span class="lang-el">Thronos Wallet</span>
            <span class="lang-en">Thronos Wallet</span>
        </div>

        <!-- Address Section -->
        <div class="wallet-popup-address">
            <div class="wallet-popup-address-text" title="${escapeHtml(wallet)}">${escapeHtml(shortAddr)}</div>
            <button class="wallet-popup-copy-btn" onclick="copyToClipboard('${escapeHtml(wallet)}'); this.textContent='‚úì'; setTimeout(()=>this.textContent='Copy', 1500);">Copy</button>
        </div>

        <!-- PR-5: Tabs -->
        <div class="wallet-tabs">
            <button class="wallet-tab-btn active" data-tab="balances" onclick="switchWalletTab('balances')">
                üí∞ ${balancesTabLabel}
            </button>
            <button class="wallet-tab-btn" data-tab="music" onclick="switchWalletTab('music')">
                üéµ ${musicTabLabel}
            </button>
            <button class="wallet-tab-btn" data-tab="offline" onclick="switchWalletTab('offline')">
                üì• ${isGreek ? 'Offline' : 'Offline'}
            </button>
        </div>

        <!-- Balances Tab Content -->
        <div class="wallet-tab-content active" id="balancesTabContent">
            <!-- Portfolio Summary - PR-1b: Show "‚Äî" for nulls -->
            <div class="wallet-portfolio-summary">
                <div class="wallet-portfolio-label">${portfolioLabel}</div>
                <div class="wallet-portfolio-value">${pricedTokens.length > 0 ? totalTHR.toFixed(4) : '‚Äî'} THR</div>
                <div class="wallet-portfolio-usd">‚âà ${pricedTokens.length > 0 && totalUSD > 0 ? `$${totalUSD.toFixed(2)}` : '‚Äî'} USD</div>
                <div class="wallet-portfolio-btc">
                    <span style="font-size: 14px;">‚Çø</span> ${pricedTokens.length > 0 && totalBTC > 0 ? totalBTC.toFixed(8) : '‚Äî'} BTC
                </div>
            </div>

            <!-- Token List -->
            <div style="font-size: 11px; color: #56ff9a; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">${assetsLabel}</div>
            <div class="wallet-token-list">
                ${tokenRows || `<div style="text-align: center; opacity: 0.6; padding: 20px;">${noTokensLabel}</div>`}
            </div>

            <!-- Quick Actions -->
            <div class="wallet-quick-actions">
                <a href="javascript:void(0)" class="wallet-quick-btn" onclick="openSendModal()">
                    <span class="wallet-quick-btn-icon">üí∏</span>
                    <span class="wallet-quick-btn-label">${sendLabel}</span>
                </a>
                <a href="javascript:void(0)" class="wallet-quick-btn" onclick="openReceiveModal()">
                    <span class="wallet-quick-btn-icon">üì•</span>
                    <span class="wallet-quick-btn-label">${receiveLabel}</span>
                </a>
                <a href="/swap" class="wallet-quick-btn">
                    <span class="wallet-quick-btn-icon">üîÑ</span>
                    <span class="wallet-quick-btn-label">${swapLabel}</span>
                </a>
                <a href="/bridge" class="wallet-quick-btn">
                    <span class="wallet-quick-btn-icon">üåâ</span>
                    <span class="wallet-quick-btn-label">${bridgeLabel}</span>
                </a>
                <a href="/pledge" class="wallet-quick-btn">
                    <span class="wallet-quick-btn-icon">üî•</span>
                    <span class="wallet-quick-btn-label">${pledgeLabel}</span>
                </a>
                <a href="javascript:void(0)" class="wallet-quick-btn" onclick="openWalletHistoryModal()">
                    <span class="wallet-quick-btn-icon">üìú</span>
                    <span class="wallet-quick-btn-label">${historyLabel}</span>
                </a>
            </div>
        </div>

        <!-- Music Tab Content -->
        <div class="wallet-tab-content" id="musicTabContent">
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ ŒºŒøœÖœÉŒπŒ∫ŒÆœÇ...</span>
                <span class="lang-en">Loading music...</span>
            </div>
        </div>

        <!-- Offline Tab Content -->
        <div class="wallet-tab-content" id="offlineTabContent">
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ offline...</span>
                <span class="lang-en">Loading offline...</span>
            </div>
        </div>
    `;

    content.innerHTML = html;

    // Apply language after render
    const savedLang = getCurrentLang();
    setLanguage(savedLang);
}

// PR-5: Wallet Tab Switching
function switchWalletTab(tabName) {
    // Update tab buttons
    const tabBtns = document.querySelectorAll('.wallet-tab-btn');
    tabBtns.forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // Update tab content
    const tabContents = document.querySelectorAll('.wallet-tab-content');
    tabContents.forEach(content => {
        content.classList.remove('active');
    });

    const activeContent = document.getElementById(`${tabName}TabContent`);
    if (activeContent) {
        activeContent.classList.add('active');
    }

    // Load music when switching to music tab
    if (tabName === 'music') {
        loadMusicTab();
    }

    // Load offline when switching to offline tab
    if (tabName === 'offline') {
        loadOfflineTab();
    }
}

// PR-5: Load and render music tab
let musicModuleInitialized = false;
let musicModuleCheckInterval = null;
const walletMusicState = {
    library: [],
    playlists: [],
    libraryError: null,
    playlistsError: null,
    insights: { summary: {}, rows: [] }
};

function getWalletMusicApiBase() {
    return window.__API_BASE__ || window.location.origin;
}

function buildWalletMusicApiUrl(path) {
    if (!path) return path;
    if (/^https?:\/\//i.test(path)) return path;
    const normalized = path.startsWith('/') ? path : `/${path}`;
    return `${getWalletMusicApiBase()}${normalized}`;
}

function normalizeWalletTrack(track) {
    if (!track || typeof track !== 'object') return track;
    const normalized = { ...track };
    ['audio_url', 'cover_url', 'image_url', 'logo_url', 'thumbnail_url'].forEach(field => {
        if (normalized[field]) {
            const fixer = window.normalizeMediaUrl || window.FetchUtils?.normalizeMediaUrl;
            normalized[field] = fixer ? fixer(normalized[field]) : normalized[field];
        }
    });
    return normalized;
}

function normalizeWalletPlaylist(playlist) {
    if (!playlist || typeof playlist !== 'object') return playlist;
    const normalized = { ...playlist };
    if (Array.isArray(normalized.tracks)) {
        normalized.tracks = normalized.tracks.map(track => normalizeWalletTrack(track));
    }
    return normalized;
}

function initWalletMusic() {
    const musicContent = document.getElementById('musicTabContent');
    if (!musicContent) return;
    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);
    const loadingLabel = isGreek ? 'Œ¶œåœÅœÑœâœÉŒ∑ ŒºŒøœÖœÉŒπŒ∫ŒÆœÇ...' : 'Loading music...';
    musicContent.innerHTML = `
        <div class="music-section">
            <div class="music-section-title">${isGreek ? 'ŒíŒπŒ≤ŒªŒπŒøŒ∏ŒÆŒ∫Œ∑' : 'Library'}</div>
            <div class="music-empty">${loadingLabel}</div>
        </div>
        <div class="music-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div class="music-section-title" style="margin: 0;">${isGreek ? 'ŒõŒØœÉœÑŒµœÇ ŒëŒΩŒ±œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆœÇ' : 'Playlists'}</div>
                <button onclick="createPlaylistFromWallet()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;">
                    ${isGreek ? '‚ûï ŒùŒ≠Œ± Playlist' : '‚ûï New Playlist'}
                </button>
            </div>
            <div class="music-empty">${loadingLabel}</div>
        </div>
    `;
}

async function loadWalletLibrary(wallet) {
    try {
        const res = await fetch(buildWalletMusicApiUrl(`/api/music/library?address=${encodeURIComponent(wallet)}`));
        const data = res.ok ? await res.json() : {};
        if (data.ok && Array.isArray(data.library)) {
            return { items: data.library.map(track => normalizeWalletTrack(track)), error: null };
        }
        const items = Array.isArray(data.library) ? data.library : [];
        return { items: items.map(track => normalizeWalletTrack(track)), error: data.error || 'library_unavailable' };
    } catch (error) {
        return { items: [], error: error.message || 'library_unavailable' };
    }
}

async function loadWalletPlaylists(wallet) {
    try {
        const res = await fetch(buildWalletMusicApiUrl(`/api/music/playlists?address=${encodeURIComponent(wallet)}`));
        const data = res.ok ? await res.json() : {};
        const playlists = Array.isArray(data.playlists)
            ? data.playlists
            : (Array.isArray(data.items) ? data.items : []);
        return {
            items: playlists.map(playlist => normalizeWalletPlaylist(playlist)),
            error: data.ok === false ? (data.error || 'playlists_unavailable') : null
        };
    } catch (error) {
        return { items: [], error: error.message || 'playlists_unavailable' };
    }
}

async function loadMusicTab() {
    const musicContent = document.getElementById('musicTabContent');
    if (!musicContent) return;

    const wallet = walletSession.getAddress();
    if (!wallet) {
        musicContent.innerHTML = '<div class="music-empty">Please connect your wallet to view music.</div>';
        return;
    }

    // Security: Check if wallet is unlocked (has send_secret)
    const secret = localStorage.getItem('thr_secret');
    if (!secret) {
        const lang = getCurrentLang();
        const isGreek = isGreekLang(lang);
        const unlockMsg = isGreek ? 'ŒûŒµŒ∫ŒªŒµŒπŒ¥œéœÉœÑŒµ œÑŒø œÄŒøœÅœÑŒøœÜœåŒªŒπ œÉŒ±œÇ Œ≥ŒπŒ± ŒΩŒ± Œ¥ŒµŒØœÑŒµ œÑŒ∑ ŒºŒøœÖœÉŒπŒ∫ŒÆ.' : 'Unlock your wallet to view music.';
        musicContent.innerHTML = `<div class="music-empty">${unlockMsg}</div>`;
        return;
    }

    initWalletMusic();
    walletMusicState.libraryError = null;
    walletMusicState.playlistsError = null;

    const moduleAvailable = typeof MusicModule !== 'undefined';
    let moduleLoaded = false;

    if (moduleAvailable) {
        try {
            await MusicModule.init(wallet);
            musicModuleInitialized = true;
            walletMusicState.library = (MusicModule.getLibrary() || []).map(track => normalizeWalletTrack(track));
            walletMusicState.playlists = (MusicModule.getPlaylists() || []).map(playlist => normalizeWalletPlaylist(playlist));
            moduleLoaded = true;
        } catch (error) {
            console.warn('[Wallet] MusicModule init failed, falling back to API:', error);
            walletMusicState.libraryError = error.message || 'library_unavailable';
            walletMusicState.playlistsError = error.message || 'playlists_unavailable';
        }
    }

    if (!moduleLoaded) {
        const [libraryResult, playlistsResult] = await Promise.all([
            loadWalletLibrary(wallet),
            loadWalletPlaylists(wallet)
        ]);
        walletMusicState.library = libraryResult.items;
        walletMusicState.playlists = playlistsResult.items;
        walletMusicState.libraryError = libraryResult.error;
        walletMusicState.playlistsError = playlistsResult.error;
    }

    try {
        const hist = await loadWalletHistory(wallet);
        const musicRows = (hist || []).filter(tx => getTxType(tx) === 'music').slice(0, 20);
        const sent = musicRows.filter(tx => tx.from === wallet).reduce((a, tx) => a + (Number(tx.amount || 0) || 0), 0);
        const received = musicRows.filter(tx => tx.to === wallet).reduce((a, tx) => a + (Number(tx.amount || 0) || 0), 0);
        walletMusicState.insights = { summary: { sent, received, total: musicRows.length }, rows: musicRows };
    } catch (_e) {
        walletMusicState.insights = { summary: {}, rows: [] };
    }

    renderMusicTab();
}

function renderMusicTab() {
    const musicContent = document.getElementById('musicTabContent');
    if (!musicContent) return;

    const library = walletMusicState.library || [];
    const playlists = walletMusicState.playlists || [];

    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    const libraryLabel = isGreek ? 'ŒíŒπŒ≤ŒªŒπŒøŒ∏ŒÆŒ∫Œ∑' : 'Library';
    const playlistsLabel = isGreek ? 'ŒõŒØœÉœÑŒµœÇ ŒëŒΩŒ±œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆœÇ' : 'Playlists';
    const noTracksLabel = isGreek ? 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ Œ∫ŒøŒºŒºŒ¨œÑŒπŒ±' : 'No tracks found';
    const noPlaylistsLabel = isGreek ? 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ ŒªŒØœÉœÑŒµœÇ' : 'No playlists found';

    // Render library tracks
    const libraryError = walletMusicState.libraryError;
    const playlistsError = walletMusicState.playlistsError;

    const libraryHtml = library.length > 0
        ? library.map(track => {
            const trackIdSafe = (track.id || track.track_id || '').toString().replace(/'/g, "\\'");
            return `
            <div class="music-track-item" data-track-id="${track.id || track.track_id}">
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <button onclick="event.stopPropagation(); playWalletTrack('${trackIdSafe}', false);" style="background: rgba(0,255,102,0.15); border: 1px solid rgba(0,255,102,0.3); color: #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">‚ñ∂Ô∏è</button>
                    <div class="music-track-info" style="flex: 1; cursor: pointer;" onclick="playWalletTrack('${trackIdSafe}', false);">
                        <div class="music-track-title">${escapeHtml(track.title || 'Untitled')}</div>
                        <div class="music-track-artist">${escapeHtml(track.artist || track.artist_name || 'Unknown Artist')}</div>
                        <div style="font-size: 9px; color: #888; margin-top: 2px;">
                            <span>‚ñ∂Ô∏è ${track.play_count || 0}</span> ‚Ä¢
                            <span>üí∞ ${(track.tips_total || 0).toFixed(2)} THR</span>
                        </div>
                    </div>
                </div>
                <button onclick="event.stopPropagation(); window.open('/music', '_blank');" title="Open in music page" style="background: none; border: none; color: #0f0; font-size: 16px; cursor: pointer; padding: 4px;">‚ãÆ</button>
            </div>
            `;
        }).join('')
        : `<div class="music-empty">${libraryError ? (isGreek ? 'ŒîŒµŒΩ œÜŒøœÅœÑœéŒ∏Œ∑Œ∫Œµ Œ∑ Œ≤ŒπŒ≤ŒªŒπŒøŒ∏ŒÆŒ∫Œ∑' : 'Library unavailable') : noTracksLabel}</div>`;

    // Render playlists
    const playlistsHtml = playlists.length > 0
        ? playlists.map(playlist => {
            const trackCount = (playlist.track_ids || playlist.tracks || []).length;
            const countLabel = isGreek ? `${trackCount} Œ∫ŒøŒºŒºŒ¨œÑŒπŒ±` : `${trackCount} tracks`;
            const playlistIdSafe = (playlist.playlist_id || playlist.id || '').replace(/'/g, "\\'");
            return `
                <div class="music-playlist-item" data-playlist-id="${playlist.playlist_id || playlist.id}">
                    <div class="music-playlist-info" style="flex: 1; cursor: pointer;" onclick="playWalletPlaylist('${playlistIdSafe}')">
                        <div class="music-playlist-name">${escapeHtml(playlist.name || 'Untitled Playlist')}</div>
                        <div class="music-playlist-count">${countLabel}</div>
                    </div>
                    <div style="display: flex; gap: 4px;">
                        <button onclick="event.stopPropagation(); playWalletPlaylist('${playlistIdSafe}', false)" title="${isGreek ? 'Œ†Œ±ŒØŒæŒµ' : 'Play'}" style="background: rgba(0,255,102,0.15); border: 1px solid rgba(0,255,102,0.3); color: #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚ñ∂Ô∏è</button>
                        <button onclick="event.stopPropagation(); playWalletPlaylist('${playlistIdSafe}', true)" title="${isGreek ? 'Œ§œÖœáŒ±ŒØŒø' : 'Shuffle'}" style="background: rgba(0,255,102,0.15); border: 1px solid rgba(0,255,102,0.3); color: #0f0; padding: 4px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;">üîÄ</button>
                        <button onclick="event.stopPropagation(); window.open('/music#playlists', '_blank');" title="${isGreek ? 'ŒÜŒΩŒøŒπŒ≥ŒºŒ±' : 'Open'}" style="background: rgba(0,255,102,0.15); border: 1px solid rgba(0,255,102,0.3); color: #0f0; padding: 4px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;">üëÅÔ∏è</button>
                    </div>
                </div>
            `;
        }).join('')
        : `
            <div class="music-empty">
                ${playlistsError ? (isGreek ? 'ŒîŒµŒΩ œÜŒøœÅœÑœéŒ∏Œ∑Œ∫Œ±ŒΩ playlists.' : 'Playlists failed to load.') : noPlaylistsLabel}
                ${playlistsError ? `<button onclick="reloadWalletPlaylists()" style="margin-left:8px; background: transparent; border: 1px solid rgba(0,255,102,0.4); color: #0f0; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 10px;">${isGreek ? 'Retry' : 'Retry'}</button>` : ''}
            </div>
        `;

    const newPlaylistBtn = isGreek ? '‚ûï ŒùŒ≠Œ± Playlist' : '‚ûï New Playlist';
    const sessionLabel = isGreek ? 'ŒàŒªŒµŒ≥œáŒøŒπ œÉœÖŒΩŒµŒ¥œÅŒØŒ±œÇ' : 'Session controls';
    const startLabel = isGreek ? 'ŒàŒΩŒ±œÅŒæŒ∑' : 'Start';
    const endLabel = isGreek ? 'ŒõŒÆŒæŒ∑' : 'End';
    const fullPageLabel = isGreek ? 'Œ†ŒªŒÆœÅŒ∑œÇ Œ£ŒµŒªŒØŒ¥Œ±' : 'Full Page';

    // Check session status
    const isSessionActive = window.MusicModal?.isSessionActive?.() || false;
    const sessionId = window.MusicModal?.getSessionId?.() || '';
    const sessionStatusHtml = isSessionActive
        ? `<div style="margin-top: 8px; font-size: 11px; color: #b6ffcc;">${isGreek ? 'Œ£œÖŒΩŒµŒ¥œÅŒØŒ± ŒµŒΩŒµœÅŒ≥ŒÆ' : 'Session started'}: ${sessionId}</div>`
        : '';

    const insights = walletMusicState.insights || { summary: {}, rows: [] };
    const musicRows = Array.isArray(insights.rows) ? insights.rows : [];
    const summary = insights.summary || {};
    const insightsTitle = isGreek ? 'Œ£œÖŒΩŒ±ŒªŒªŒ±Œ≥Œ≠œÇ ŒúŒøœÖœÉŒπŒ∫ŒÆœÇ & Credits' : 'Music Transactions & Credits';
    const insightsHtml = musicRows.length
      ? `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:10px;">
            <div class="music-track-item"><div class="music-track-title">${isGreek ? 'Tips Sent' : 'Tips Sent'}</div><div class="music-track-artist">${(Number(summary.sent||0)).toFixed(4)} THR</div></div>
            <div class="music-track-item"><div class="music-track-title">${isGreek ? 'Tips Received' : 'Tips Received'}</div><div class="music-track-artist">${(Number(summary.received||0)).toFixed(4)} THR</div></div>
            <div class="music-track-item"><div class="music-track-title">${isGreek ? 'Music TX Count' : 'Music TX Count'}</div><div class="music-track-artist">${musicRows.length}</div></div>
         </div>
         <div style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto;">${musicRows.slice(0,12).map(tx => `<div class="music-track-item"><div class="music-track-title">${escapeHtml(tx.track_title || tx.type || tx.kind || 'music')}</div><div class="music-track-artist">${(Number(tx.amount||0)||0).toFixed(6)} ${escapeHtml(tx.symbol || tx.asset_symbol || tx.token_symbol || 'THR')} ‚Ä¢ ${escapeHtml(formatTxDate(tx.timestamp||''))}</div></div>`).join('')}</div>`
      : `<div class="music-empty">${isGreek ? 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ Œ∫ŒπŒΩŒÆœÉŒµŒπœÇ ŒºŒøœÖœÉŒπŒ∫ŒÆœÇ Œ≥ŒπŒ± Œ±œÖœÑœå œÑŒø wallet.' : 'No music transactions found for this wallet yet.'}</div>`;

    const html = `
        <!-- Session Controls -->
        <div class="music-section" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(0,255,102,0.2);">
            <div class="music-section-title" style="font-size: 12px; color: #9f9; margin-bottom: 8px;">${sessionLabel}</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="wallet-mini-btn" onclick="window.MusicModal?.startSession(); setTimeout(() => renderMusicTab(), 500);">‚ñ∂Ô∏è ${startLabel}</button>
                <button class="wallet-mini-btn" onclick="window.MusicModal?.endSession(); setTimeout(() => renderMusicTab(), 500);">‚èπÔ∏è ${endLabel}</button>
                <button class="wallet-mini-btn" onclick="window.open('/music', '_blank')">üéß ${fullPageLabel}</button>
            </div>
            ${sessionStatusHtml}
        </div>

        <div class="music-section">
            <div class="music-section-title">${libraryLabel}</div>
            ${libraryHtml}
        </div>
        <div class="music-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div class="music-section-title" style="margin: 0;">${playlistsLabel}</div>
                <button onclick="createPlaylistFromWallet()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;">
                    ${newPlaylistBtn}
                </button>
            </div>
            ${playlistsHtml}
        </div>
        <div class="music-section">
            <div class="music-section-title">${insightsTitle}</div>
            ${insightsHtml}
        </div>
    `;

    musicContent.innerHTML = html;
}

async function reloadWalletPlaylists() {
    const wallet = walletSession.getAddress();
    if (!wallet) return;
    const result = await loadWalletPlaylists(wallet);
    walletMusicState.playlists = result.items;
    walletMusicState.playlistsError = result.error;
    renderMusicTab();
}

// PR-5g: Play track from wallet widget (online or offline)
async function playWalletTrack(trackId, isOffline = false) {
    if (typeof GlobalMusicPlayer === 'undefined') {
        console.error('[Wallet] GlobalMusicPlayer not available');
        alert('Music player not available');
        return;
    }

    try {
        let track = null;

        if (isOffline) {
            // Get offline track data
            const wallet = walletSession.getAddress();
            if (!wallet) return;

            const res = await fetch(buildWalletMusicApiUrl(`/api/music/offline/${encodeURIComponent(wallet)}`));
            const data = await res.json();

            if (data.ok && data.tracks) {
                track = data.tracks.find(t => (t.id || t.track_id) === trackId);
            }
        } else {
            // Get online track from library (use walletMusicState which is loaded from API/MusicModule)
            const library = walletMusicState.library || [];
            track = library.find(t => (t.id || t.track_id) === trackId);
        }

        if (!track) {
            console.error('[Wallet] Track not found:', trackId);
            return;
        }

        // Play track using GlobalMusicPlayer
        GlobalMusicPlayer.playTrack(track);

        const lang = getCurrentLang();
        const isGreek = isGreekLang(lang);
        const msg = isGreek
            ? `Œ†Œ±ŒØŒ∂ŒµŒπ: ${track.title || 'Untitled'}`
            : `Now playing: ${track.title || 'Untitled'}`;
        showToast(msg);

    } catch (error) {
        console.error('[Wallet] Failed to play track:', error);
    }
}

// PR-5c: Create playlist from wallet popup
async function createPlaylistFromWallet() {
    const name = prompt('Enter playlist name:');
    if (!name || !name.trim()) return;

    try {
        // Use WalletAuth for PIN-based unlock
        const { address, authSecret } = await window.WalletAuth.requireUnlockedWallet();

        const musicContent = document.getElementById('musicTabContent');
        if (musicContent) {
            musicContent.innerHTML = `
                <div class="wallet-popup-loading">
                    <div class="wallet-popup-spinner"></div>
                    Creating playlist...
                </div>
            `;
        }

        // Create via API
        const res = await fetch(buildWalletMusicApiUrl('/api/music/playlists/create'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                address: address,
                name: name.trim(),
                auth_secret: authSecret
            })
        });

        const data = await res.json();
        if (data.ok) {
            // Refresh music tab - reload everything
            await loadMusicTab();
            alert('‚úÖ Playlist created!');
        } else {
            alert(`‚ùå Error: ${data.error}`);
            renderMusicTab();
        }
    } catch (e) {
        if (e.code === 'WALLET_NOT_CONNECTED') {
            alert('‚ùå Please connect your wallet first!');
        } else if (e.code === 'WALLET_LOCKED') {
            alert('‚ùå Wallet is locked. Please unlock with your PIN.');
        } else {
            alert(`‚ùå Error: ${e.message}`);
        }
        const musicContent = document.getElementById('musicTabContent');
        if (musicContent) renderMusicTab();
    }
}

// PR-5e: Play playlist from wallet widget using GlobalMusicPlayer
async function playWalletPlaylist(playlistId, shuffleMode = false) {
    try {
        // Get playlist from walletMusicState (loaded from API/MusicModule)
        const playlists = walletMusicState.playlists || [];
        const playlist = playlists.find(p => (p.playlist_id || p.id) === playlistId);

        if (!playlist) {
            console.error('[Wallet] Playlist not found:', playlistId);
            return;
        }

        // Get full track data if only IDs are available
        let tracks = playlist.tracks || [];
        if (tracks.length === 0 && playlist.track_ids && playlist.track_ids.length > 0) {
            // Fetch full playlist data
            const wallet = walletSession.getAddress();
            const res = await fetch(buildWalletMusicApiUrl(`/api/music/playlists?address=${encodeURIComponent(wallet)}`));
            const data = await res.json();
            if (data.ok && data.playlists) {
                const fullPlaylist = data.playlists.find(p => (p.playlist_id || p.id) === playlistId);
                if (fullPlaylist && fullPlaylist.tracks) {
                    tracks = fullPlaylist.tracks;
                }
            }
        }

        if (tracks.length === 0) {
            const lang = getCurrentLang();
            const isGreek = isGreekLang(lang);
            alert(isGreek ? 'Œó playlist ŒµŒØŒΩŒ±Œπ Œ¨Œ¥ŒµŒπŒ±!' : 'Playlist is empty!');
            return;
        }

        // Use GlobalMusicPlayer
        if (typeof GlobalMusicPlayer !== 'undefined') {
            // Enable shuffle if requested
            if (shuffleMode) {
                GlobalMusicPlayer.toggleShuffle();
            }

            GlobalMusicPlayer.playQueue(tracks, 0);

            const lang = getCurrentLang();
            const isGreek = isGreekLang(lang);
            const msg = isGreek
                ? `Œ†Œ±ŒØŒ∂ŒµŒπ "${playlist.name}" (${tracks.length} Œ∫ŒøŒºŒºŒ¨œÑŒπŒ±)${shuffleMode ? ' œÉŒµ œÑœÖœáŒ±ŒØŒ± œÉŒµŒπœÅŒ¨' : ''}`
                : `Playing "${playlist.name}" (${tracks.length} tracks)${shuffleMode ? ' in shuffle mode' : ''}`;

            // Show toast notification
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#0f0; color:#000; padding:12px 24px; border-radius:8px; z-index:10001; font-family:monospace; font-weight:bold;';
            toast.textContent = `‚úÖ ${msg}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);

            // Close wallet popup if open
            const popup = document.getElementById('walletBalancePopup');
            if (popup && popup.style.display === 'block') {
                popup.style.display = 'none';
            }
        } else {
            console.warn('[Wallet] GlobalMusicPlayer not available');
        }
    } catch (e) {
        console.error('[Wallet] Failed to play playlist:', e);
        alert(`‚ùå Error: ${e.message}`);
    }
}

// PR-5c: Load and render offline tab
async function loadOfflineTab() {
    const offlineContent = document.getElementById('offlineTabContent');
    if (!offlineContent) return;

    const wallet = walletSession.getAddress();
    if (!wallet) {
        offlineContent.innerHTML = '<div class="music-empty">Please connect your wallet to view offline tracks.</div>';
        return;
    }

    try {
        // Show loading
        offlineContent.innerHTML = `
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                Loading offline tracks...
            </div>
        `;

        // Fetch offline tracks with timeout (20s) and retry disabled for this specific call
        const url = buildWalletMusicApiUrl(`/api/music/offline/${encodeURIComponent(wallet)}`);
        const res = await fetch(url, { timeout: 20000, noRetry: true });

        if (!res.ok) {
            throw new Error(`Failed to fetch offline tracks: ${res.status} ${res.statusText}`);
        }

        const data = await res.json();

        if (data.ok && data.tracks && data.tracks.length > 0) {
            renderOfflineTab(data.tracks);
        } else {
            const lang = getCurrentLang();
            const isGreek = isGreekLang(lang);
            const emptyMsg = isGreek
                ? 'ŒîŒµŒΩ Œ≠œáŒµœÑŒµ Œ±œÄŒøŒ∏Œ∑Œ∫ŒµœÖŒºŒ≠ŒΩŒ± offline œÑœÅŒ±Œ≥ŒøœçŒ¥ŒπŒ±. Œ†Œ∑Œ≥Œ±ŒØŒΩŒµœÑŒµ œÉœÑŒø /music Œ≥ŒπŒ± ŒΩŒ± Œ±œÄŒøŒ∏Œ∑Œ∫ŒµœçœÉŒµœÑŒµ!'
                : 'No offline tracks saved. Go to /music to save tracks!';
            offlineContent.innerHTML = `
                <div class="music-empty">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì•</div>
                    <div style="margin-bottom: 16px;">${emptyMsg}</div>
                    <a href="/music#offline" style="color: #0f0; text-decoration: underline; cursor: pointer;">
                        ${isGreek ? 'ŒÜŒΩŒøŒπŒ≥ŒºŒ± Music' : 'Open Music'}
                    </a>
                </div>
            `;
        }
    } catch (error) {
        console.error('[Wallet] Failed to load offline tracks:', error);
        const lang = getCurrentLang();
        const isGreek = isGreekLang(lang);
        const errorMsg = error.name === 'TimeoutError'
            ? (isGreek ? 'ŒõŒÆŒæŒ∑ œáœÅœåŒΩŒøœÖ Œ∫Œ±œÑŒ¨ œÑŒ∑ œÜœåœÅœÑœâœÉŒ∑' : 'Request timeout')
            : error.message;
        offlineContent.innerHTML = `<div class="music-empty" style="color: #ff6666;">Error loading offline tracks: ${errorMsg}</div>`;
    }
}

function renderOfflineTab(tracks) {
    const offlineContent = document.getElementById('offlineTabContent');
    if (!offlineContent) return;

    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    const tracksHtml = tracks.map(track => {
        const trackIdSafe = (track.id || track.track_id || '').toString().replace(/'/g, "\\'");
        return `
        <div class="music-track-item" data-track-id="${track.id || track.track_id}">
            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                <button onclick="event.stopPropagation(); playWalletTrack('${trackIdSafe}', true);" style="background: rgba(0,255,102,0.15); border: 1px solid rgba(0,255,102,0.3); color: #0f0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px;">‚ñ∂Ô∏è</button>
                <div class="music-track-info" style="flex: 1;" onclick="playWalletTrack('${trackIdSafe}', true);" style="cursor: pointer;">
                    <div class="music-track-title">${escapeHtml(track.title || 'Untitled')}</div>
                    <div class="music-track-artist">${escapeHtml(track.artist || track.artist_name || 'Unknown Artist')}</div>
                    <div style="font-size: 9px; color: #888; margin-top: 2px;">
                        ${track.tipped ? 'üí∞ Tipped' : 'üì• Saved'}
                    </div>
                </div>
            </div>
            <div style="font-size: 9px; color: #666;">${escapeHtml(track.duration || '')}</div>
        </div>
        `;
    }).join('');

    const totalLabel = isGreek ? `${tracks.length} Œ±œÄŒøŒ∏Œ∑Œ∫ŒµœÖŒºŒ≠ŒΩŒ±` : `${tracks.length} saved`;

    offlineContent.innerHTML = `
        <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,255,102,0.2);">
            <div style="color: #0f0; font-size: 12px; font-weight: 600;">üì• ${isGreek ? 'Offline Œ§œÅŒ±Œ≥ŒøœçŒ¥ŒπŒ±' : 'Offline Tracks'}</div>
            <div style="color: #888; font-size: 10px; margin-top: 4px;">${totalLabel}</div>
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
            ${tracksHtml}
        </div>
    `;
}

function formatBalance(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
    if (num >= 1) return num.toFixed(4);
    return num.toFixed(6);
}

// Send Modal Functions
let selectedSpeed = 'fast';
let selectedNetwork = 'thronos';
let selectedToken = 'THR';
window.tokenBalances = window.tokenBalances || {};

function openSendModal() {
    document.getElementById('sendModal').classList.add('active');
    document.getElementById('sendResult').style.display = 'none';
    document.getElementById('sendTo').value = '';
    document.getElementById('sendAmount').value = '';
    loadTokenBalances();
    loadCustomTokens();
}

function closeSendModal(event) {
    if (!event || event.target.id === 'sendModal') {
        document.getElementById('sendModal').classList.remove('active');
        // Stop any active transaction polling
        if (txPollInterval) {
            clearInterval(txPollInterval);
            txPollInterval = null;
        }
    }
}

function openReceiveModal() {
    updateReceiveModal();
    document.getElementById('receiveModal').classList.add('active');
    const savedLang = getCurrentLang();
    setLanguage(savedLang);
}

function closeReceiveModal(event) {
    if (!event || event.target.id === 'receiveModal') {
        document.getElementById('receiveModal').classList.remove('active');
    }
}

let selectedReceiveNetwork = 'thronos';

async function selectReceiveNetwork(network) {
    selectedReceiveNetwork = network;

    // Update UI selection
    const modal = document.getElementById('receiveModal');
    if (modal) {
        modal.querySelectorAll('.send-network-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        const selectedOpt = modal.querySelector(`[data-network="${network}"]`);
        if (selectedOpt) selectedOpt.classList.add('selected');
    }

    // Update network label
    const networkLabel = document.getElementById('receiveNetworkLabel');
    const networkNames = {
        'thronos': 'Thronos Chain',
        'bitcoin': 'Bitcoin Network',
        'ethereum': 'Ethereum Network',
        'bnb': 'BNB Chain',
        'xrp': 'XRP Ledger'
    };
    if (networkLabel) {
        const name = networkNames[network] || network;
        networkLabel.querySelector('.lang-el').textContent = `ŒîŒØŒ∫œÑœÖŒø: ${name}`;
        networkLabel.querySelector('.lang-en').textContent = `Network: ${name}`;
    }

    // Load address for selected network
    await updateReceiveModal();
}

async function updateReceiveModal() {
    const network = selectedReceiveNetwork || 'thronos';
    const thrAddr = walletSession.getAddress() || '';
    const addrEl = document.getElementById('receiveAddress');
    const qrEl = document.getElementById('receiveQr');
    const audioEl = document.getElementById('receiveAudio');
    const dlEl = document.getElementById('receiveDownload');
    const emptyEl = document.getElementById('receiveEmpty');
    const hintEl = document.getElementById('receiveQrHint');

    if (!thrAddr) {
        if (addrEl) addrEl.textContent = '‚Äî';
        if (qrEl) qrEl.style.display = 'none';
        if (audioEl) audioEl.removeAttribute('src');
        if (dlEl) dlEl.removeAttribute('href');
        if (emptyEl) emptyEl.style.display = 'block';
        if (hintEl) hintEl.style.display = 'none';
        return;
    }

    if (network === 'thronos') {
        // Show Thronos address (existing behavior)
        const addr = thrAddr;
        const qrUrl = `/api/wallet/qr/${encodeURIComponent(addr)}`;
        const audioUrl = `/api/wallet/audio/${encodeURIComponent(addr)}`;

        if (addrEl) addrEl.textContent = addr;
        if (qrEl) {
            qrEl.src = qrUrl;
            qrEl.style.display = 'inline';
        }
        if (audioEl) {
            audioEl.src = audioUrl;
            audioEl.load();
        }
        if (dlEl) dlEl.href = audioUrl;
        if (emptyEl) emptyEl.style.display = 'none';
        if (hintEl) hintEl.style.display = 'block';
    } else {
        // Load cross-chain deposit address from bridge API
        try {
            let response, data;

            if (network === 'bitcoin') {
                // BTC bridge already has working endpoint
                response = await fetch(`/api/bridge/deposit?wallet=${encodeURIComponent(thrAddr)}`);
                data = await response.json();

                if (data.ok && data.btc_address) {
                    const depositAddr = data.btc_address;

                    if (addrEl) addrEl.textContent = depositAddr;
                    if (qrEl) {
                        qrEl.src = `/api/wallet/qr/${encodeURIComponent(depositAddr)}`;
                        qrEl.style.display = 'inline';
                        qrEl.onerror = () => { qrEl.style.display = 'none'; };
                    }
                    if (audioEl) audioEl.removeAttribute('src');
                    if (dlEl) dlEl.removeAttribute('href');
                    if (emptyEl) emptyEl.style.display = 'none';
                    if (hintEl) {
                        hintEl.style.display = 'block';
                        hintEl.querySelector('.lang-el').textContent = 'ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑ BTC œÉŒµ Œ±œÖœÑŒÆ œÑŒ∑ Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑ Œ≥ŒπŒ± ŒΩŒ± ŒªŒ¨Œ≤ŒµœÑŒµ WBTC œÉœÑŒø Thronos.';
                        hintEl.querySelector('.lang-en').textContent = 'Deposit BTC to this address to receive WBTC on Thronos.';
                    }
                    return; // Success, exit early
                }
            } else {
                // Other networks: Use new unified endpoint (when implemented)
                response = await fetch(`/api/bridge/deposit?network=${network}&thr_address=${encodeURIComponent(thrAddr)}`);
                data = await response.json();

                if (data.ok && data.deposit_address) {
                    const depositAddr = data.deposit_address;

                    if (addrEl) addrEl.textContent = depositAddr;
                    if (qrEl) {
                        qrEl.src = `/api/bridge/qr?network=${network}&address=${encodeURIComponent(depositAddr)}`;
                        qrEl.style.display = 'inline';
                        qrEl.onerror = () => { qrEl.style.display = 'none'; };
                    }
                    if (audioEl) audioEl.removeAttribute('src');
                    if (dlEl) dlEl.removeAttribute('href');
                    if (emptyEl) emptyEl.style.display = 'none';
                    if (hintEl) {
                        hintEl.style.display = 'block';
                        const wrapped = network === 'ethereum' ? 'WETH' : network === 'bnb' ? 'WBNB' : network === 'xrp' ? 'WXRP' : 'tokens';
                        hintEl.querySelector('.lang-el').textContent = `ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑ ${network.toUpperCase()} œÉŒµ Œ±œÖœÑŒÆ œÑŒ∑ Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑ Œ≥ŒπŒ± ŒΩŒ± ŒªŒ¨Œ≤ŒµœÑŒµ ${wrapped} œÉœÑŒø Thronos.`;
                        hintEl.querySelector('.lang-en').textContent = `Deposit ${network.toUpperCase()} to this address to receive ${wrapped} on Thronos.`;
                    }
                    return; // Success, exit early
                }
            }

            // If we reach here, endpoint failed - show helpful error
            throw new Error(data?.error || 'Endpoint not implemented yet');

        } catch (error) {
            console.error(`Failed to load ${network} deposit address:`, error);

            // Show friendly message for non-BTC networks
            if (network !== 'bitcoin') {
                if (addrEl) addrEl.textContent = `${network.toUpperCase()} bridge coming soon`;
                if (qrEl) qrEl.style.display = 'none';
                if (hintEl) {
                    hintEl.style.display = 'block';
                    hintEl.querySelector('.lang-el').textContent = `Œ§Œø ${network.toUpperCase()} bridge Œ∏Œ± ŒµŒØŒΩŒ±Œπ Œ¥ŒπŒ±Œ∏Œ≠œÉŒπŒºŒø œÉœçŒΩœÑŒøŒºŒ±. Backend endpoint: /api/bridge/deposit?network=${network}&thr_address=...`;
                    hintEl.querySelector('.lang-en').textContent = `${network.toUpperCase()} bridge coming soon. Backend endpoint needed: /api/bridge/deposit?network=${network}&thr_address=...`;
                }
            } else {
                // BTC should work - show actual error
                if (addrEl) addrEl.textContent = 'Error loading BTC deposit address';
                if (qrEl) qrEl.style.display = 'none';
                if (hintEl) {
                    hintEl.style.display = 'block';
                    hintEl.querySelector('.lang-el').textContent = 'Œ£œÜŒ¨ŒªŒºŒ± œÜœåœÅœÑœâœÉŒ∑œÇ Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑œÇ Œ∫Œ±œÑŒ¨Œ∏ŒµœÉŒ∑œÇ BTC.';
                    hintEl.querySelector('.lang-en').textContent = 'Error loading BTC deposit address.';
                }
            }
        }
    }
}

function copyReceiveAddress() {
    const addrEl = document.getElementById('receiveAddress');
    const addr = addrEl ? addrEl.textContent : '';
    if (!addr || addr === '‚Äî' || addr.includes('Error')) return;
    copyToClipboard(addr);
    const network = selectedReceiveNetwork || 'thronos';
    showToast(`${network.toUpperCase()} address copied!`);
}

function playReceiveAudio() {
    const audioEl = document.getElementById('receiveAudio');
    if (audioEl && audioEl.src) {
        audioEl.play();
    }
}

// Wallet History Modal Functions
let allTransactions = [];
let WALLET_HISTORY_CACHE = [];
let historyLoading = false;
let currentHistoryFilter = 'all';
let currentTokenFilter = null;
let AI_LEDGER_CACHE = [];
let NETWORK_HISTORY_CACHE = [];

function resetHistoryFilters() {
    currentHistoryFilter = 'all';
    currentTokenFilter = null;
    const tokenIndexBar = document.getElementById('tokenIndexBar');
    if (tokenIndexBar) tokenIndexBar.style.display = 'none';
}

function openWalletHistoryModal() {
    document.getElementById('walletHistoryModal').classList.add('active');
    resetHistoryFilters();
    filterHistory('all');
    const addr = walletSession.getAddress();
    hydrateHistory(addr);
}

function closeWalletHistoryModal(event) {
    if (!event || event.target.id === 'walletHistoryModal') {
        document.getElementById('walletHistoryModal').classList.remove('active');
        resetHistoryFilters();
    }
}

function filterHistory(filter, tokenSymbol = null) {
    currentHistoryFilter = filter;
    if (filter !== 'tokens') {
        currentTokenFilter = null;
    } else if (tokenSymbol) {
        currentTokenFilter = tokenSymbol;
    }

    // Update tab button styles
    document.querySelectorAll('.history-tab-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
            btn.style.background = 'rgba(0,255,102,0.2)';
            btn.style.borderColor = 'rgba(0,255,102,0.4)';
            btn.classList.add('active');
        } else {
            btn.style.background = 'rgba(0,255,102,0.05)';
            btn.style.borderColor = 'rgba(0,255,102,0.2)';
            btn.classList.remove('active');
        }
    });

    applyHistoryFilter(filter);
}

function applyHistoryFilter(filterKey) {
    currentHistoryFilter = filterKey;
    if (historyLoading) return;
    allTransactions = WALLET_HISTORY_CACHE || [];
    renderHistory();
}

function getTxType(tx) {
    // Full 13-category mapping for wallet history tabs
    const category = (tx.category || '').toLowerCase();
    const raw = (tx.kind || tx.type || '').toLowerCase();
    const symbol = (tx.symbol || tx.asset_symbol || '').toUpperCase();

    // === MINING ===
    if (raw === 'mining' || raw === 'block_reward' || raw === 'mining_reward' ||
        raw.includes('mined') || raw.includes('mining') || category === 'mining') {
        return 'mining';
    }

    // === MUSIC ===
    if (raw === 'music_tip' || raw === 'music_play' || raw === 'music_offline_tip' ||
        raw === 'royalty' || raw === 'play_reward' ||
        raw.includes('music') || raw.startsWith('music_') ||
        category === 'music' || category === 'music_tip') {
        return 'music';
    }

    // === L2E (Learn-to-Earn specific) ===
    if (raw === 'l2e' || raw === 'l2e_reward' || raw === 'learn_reward' ||
        category === 'l2e' || symbol === 'L2E') {
        return 'l2e';
    }

    // === T2E (Train-to-Earn - IoT/ASIC miners) ===
    if (raw === 't2e' || raw === 't2e_reward' || raw === 'train_reward' ||
        raw.startsWith('t2e_') || category === 't2e' || category === 't2e_reward_thr' || symbol === 'T2E') {
        return 't2e';
    }

    // === NETWORK REWARDS (Validators/Nodes) ===
    if (raw === 'network_reward' || raw === 'validator_reward' || raw === 'node_reward' ||
        category === 'network_reward') {
        return 'network';
    }

    // === AI CREDITS (Chat) ===
    if (raw.startsWith('ai_credit') || raw === 'ai_credits' ||
        raw === 'ai_credits_earned' || raw === 'ai_credits_spent' ||
        raw === 'credits_consume' || raw === 'service_payment' || raw === 'ai_knowledge' ||
        category === 'ai_credits') {
        return 'ai_credits';
    }

    // === ARCHITECT / AI JOBS ===
    if (raw.startsWith('ai_job') || raw === 'architect_job' || raw === 'architect' ||
        raw === 'architect_service' || raw === 'architect_payment' ||
        raw === 'ai_reward' || category === 'architect_ai_jobs' ||
        category === 'architect' || category === 'architect_job' || category === 'ai_reward') {
        return 'architect';
    }

    // === IoT / TELEMETRY ===
    if (raw === 'iot' || raw === 'iot_telemetry' || raw === 'autopilot' || raw === 'parking' ||
        raw === 'telemetry' || category === 'iot' || category === 'iot_telemetry') {
        return 'iot';
    }

    // === SWAPS ===
    if (raw === 'swap' || raw === 'pool_swap' || category === 'swaps') {
        return 'swaps';
    }

    // === LIQUIDITY ===
    if (raw === 'add_liquidity' || raw === 'remove_liquidity' ||
        raw === 'pool_create' || raw === 'pool_add_liquidity' || raw === 'pool_remove_liquidity' ||
        raw === 'pool_add' || raw === 'pool_remove' || raw.startsWith('liquidity_') ||
        category === 'liquidity') {
        return 'liquidity';
    }

    // === BRIDGE ===
    if (raw === 'bridge' || raw === 'bridge_in' || raw === 'bridge_out' ||
        raw === 'bridge_deposit' || raw === 'bridge_withdraw' ||
        raw === 'crosschain' || raw === 'cross_chain' || category === 'bridge') {
        return 'bridge';
    }

    // === GATEWAY (Fiat on/off ramp) ===
    if (raw === 'fiat_onramp' || raw === 'fiat_offramp' || raw === 'gateway' ||
        raw === 'onramp' || raw === 'offramp' || category === 'gateway') {
        return 'gateway';
    }

    // === TOKENS (non-THR token transfers) ===
    if (raw === 'token_transfer' || category === 'tokens' || category === 'token_transfer' ||
        (symbol && symbol !== 'THR' && (raw === 'transfer' || !raw))) {
        return 'tokens';
    }

    // === THR (native THR transfers) ===
    if (raw === 'thr_transfer' || category === 'thr' ||
        symbol === 'THR' || (!symbol && raw === 'transfer')) {
        return 'thr';
    }

    // Fallback to THR for unknown types with from/to
    if (tx.from && tx.to && (tx.amount !== undefined || tx.value !== undefined)) {
        return 'thr';
    }

    return 'thr';
}

function formatTxDate(timestamp) {
    try {
        let date;
        if (typeof timestamp === 'number') {
            // Unix timestamp (seconds or milliseconds)
            date = timestamp > 10000000000 ? new Date(timestamp) : new Date(timestamp * 1000);
        } else if (typeof timestamp === 'string') {
            const numeric = Number(timestamp);
            if (!Number.isNaN(numeric)) {
                date = numeric > 10000000000 ? new Date(numeric) : new Date(numeric * 1000);
            } else {
                date = new Date(timestamp);
            }
        } else {
            return '';
        }

        if (isNaN(date.getTime())) {
            return timestamp ? String(timestamp) : '';
        }

        return date.toLocaleString();
    } catch (e) {
        return timestamp ? String(timestamp) : '';
    }
}

function formatBytes(value) {
    const bytes = Number(value);
    if (!Number.isFinite(bytes)) return '';
    if (bytes >= 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    if (bytes >= 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
    if (bytes >= 1024) return `${(bytes / 1024).toFixed(2)} KB`;
    return `${bytes.toFixed(0)} B`;
}

function buildTokenIndexData() {
    // Experimental/invalid tokens to hide from UI
    const HIDDEN_TOKENS = ['TOKEN', 'UNKNOWN', 'TEST', 'NULL', ''];

    const counts = {};
    allTransactions.forEach(tx => {
        if (getTxType(tx) === 'tokens') {
            const sym = (tx.symbol || tx.asset_symbol || tx.token_symbol || tx.asset || '').toUpperCase();
            // Skip hidden/experimental tokens
            if (sym && !HIDDEN_TOKENS.includes(sym)) {
                counts[sym] = (counts[sym] || 0) + 1;
            }
        }
    });

    const select = document.getElementById('sendToken');
    if (select) {
        Array.from(select.options).forEach(opt => {
            const sym = (opt.value || '').toUpperCase();
            if (sym && sym !== 'THR' && !HIDDEN_TOKENS.includes(sym) && counts[sym] === undefined) {
                counts[sym] = 0;
            }
        });
    }

    return Object.keys(counts)
        .filter(sym => !HIDDEN_TOKENS.includes(sym))
        .sort((a, b) => a.localeCompare(b))
        .map(sym => ({ symbol: sym, count: counts[sym] }));
}

function renderTokenIndex() {
    const scroll = document.getElementById('tokenIndexScroll');
    const bar = document.getElementById('tokenIndexBar');
    if (!scroll || !bar) return false;

    const tokens = buildTokenIndexData();
    if (!tokens || tokens.length === 0) {
        scroll.innerHTML = '<div style="opacity:0.7; font-size:11px;">No tokens detected</div>';
        return false;
    }

    let html = '';
    tokens.forEach(token => {
        const isActive = currentTokenFilter && currentTokenFilter.toUpperCase() === token.symbol;
        const badge = `<span style="background:rgba(0,255,102,0.2); color:#00ff66; padding:1px 5px; border-radius:8px; font-size:9px;">${token.count}</span>`;
        const chipStyle = isActive
            ? 'background:rgba(0,255,102,0.25); border-color:rgba(0,255,102,0.6); color:#00ff66;'
            : 'background:rgba(0,255,102,0.08); border-color:rgba(0,255,102,0.25); color:#00ff66;';

        html += `<button class="history-tab-btn" style="flex:0 0 auto; min-width:70px; padding:6px 8px; display:flex; align-items:center; gap:6px; ${chipStyle}" onclick="filterHistory('tokens','${token.symbol}')">`;
        html += `<span style="width:20px; height:20px; border-radius:50%; background: rgba(0,255,102,0.15); display:flex; align-items:center; justify-content:center; font-weight:bold;">${escapeHtml(token.symbol[0] || '?')}</span>`;
        html += `<span style="font-size:11px;">${escapeHtml(token.symbol)}</span>${badge}`;
        html += `</button>`;
    });

    scroll.innerHTML = html;
    return true;
}

function clearTokenFilter() {
    currentTokenFilter = null;
    filterHistory('tokens');
}

function shareTokenFilter() {
    const token = currentTokenFilter;
    const text = token ? `#history=tokens&token=${encodeURIComponent(token)}` : '#history=tokens';
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
    } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Copied to clipboard');
    }
}

function renderHistory() {
    const content = document.getElementById('historyContent');
    const addr = walletSession.getAddress();
    const tokenIndexBar = document.getElementById('tokenIndexBar');

    if (currentHistoryFilter !== 'tokens') {
        currentTokenFilter = null;
    }

    if (!allTransactions || allTransactions.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No transactions found</div>';
        return;
    }

    if (currentHistoryFilter === 'tokens') {
        const hasTokens = renderTokenIndex();
        if (tokenIndexBar) tokenIndexBar.style.display = hasTokens ? 'block' : 'none';
    } else if (tokenIndexBar) {
        tokenIndexBar.style.display = 'none';
    }

    // Filter transactions
    let filtered = allTransactions;
    if (currentHistoryFilter === 'ai_credits') {
        filtered = [];
    } else if (currentHistoryFilter !== 'all') {
        filtered = allTransactions.filter(tx => getTxType(tx) === currentHistoryFilter);
    }
    if (currentHistoryFilter === 'all' || currentHistoryFilter === 'thr') {
        filtered = filtered.filter(tx => getTxType(tx) !== 'ai_credits' && !((tx.meta||{}).is_ai_credit));
    }

    if (currentHistoryFilter === 'tokens' && currentTokenFilter) {
        filtered = filtered.filter(tx => {
            const sym = (tx.symbol || tx.asset_symbol || tx.token_symbol || tx.asset || '').toUpperCase();
            return sym === currentTokenFilter.toUpperCase();
        });
    }

    // Hide experimental/invalid tokens from display
    const HIDDEN_TOKENS_LIST = ['TOKEN', 'UNKNOWN', 'TEST', 'NULL'];
    if (currentHistoryFilter === 'tokens') {
        filtered = filtered.filter(tx => {
            const sym = (tx.symbol || tx.asset_symbol || tx.token_symbol || tx.asset || '').toUpperCase();
            return sym && !HIDDEN_TOKENS_LIST.includes(sym);
        });
    }

    if (currentHistoryFilter === 'ai_credits') {
        const rows = AI_LEDGER_CACHE || [];
        if (!rows.length) {
            content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No AI credit movements</div>';
            return;
        }
        let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
        rows.slice(0, 80).forEach(entry => {
            const delta = Number(entry.delta || 0);
            const color = delta >= 0 ? '#66ff66' : '#ff6666';
            const sign = delta >= 0 ? '+' : '';
            html += `<div class="tx-item" style="padding:10px;border:1px solid rgba(0,255,102,.2);border-radius:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong style="color:${color};">${sign}${delta} credits</strong>
                    <span style="font-size:11px;opacity:.85;">${escapeHtml(String(entry.reason || 'adjust'))}</span>
                </div>
                <div style="font-size:11px;opacity:.8;margin-top:4px;">${escapeHtml(entry.ts || '')} ‚Ä¢ Balance: ${Number(entry.balance_after || 0)}</div>
            </div>`;
        });
        html += '</div>';
        content.innerHTML = html;
        return;
    }

    if (filtered.length === 0) {
        const networkRows = (NETWORK_HISTORY_CACHE || []).filter(tx => {
            const txType = getTxType(tx);
            if (currentHistoryFilter === 'all') return true;
            if (currentHistoryFilter === 'tokens' && currentTokenFilter) {
                return txType === 'tokens' && ((tx.symbol || tx.asset_symbol || tx.asset || '').toUpperCase() === currentTokenFilter.toUpperCase());
            }
            return txType === currentHistoryFilter;
        });
        if (networkRows.length > 0) {
            const preview = networkRows.slice(0, 20).map(tx => {
                const txType = getTxType(tx);
                const amount = Number(tx.amount || tx.display_amount || tx.value || 0) || 0;
                const sym = tx.symbol || tx.asset_symbol || tx.token_symbol || tx.asset || 'THR';
                const stamp = formatTxDate(tx.timestamp || tx.time || tx.created_at || '');
                const from = tx.from ? `${tx.from.slice(0,8)}...${tx.from.slice(-6)}` : '‚Äî';
                const to = tx.to ? `${tx.to.slice(0,8)}...${tx.to.slice(-6)}` : '‚Äî';
                return `<div style="padding:10px;border:1px solid rgba(0,255,102,.18);border-radius:8px;background:rgba(0,255,102,.03)">
                  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
                    <strong style="color:#7fffd4;">${txType.toUpperCase()}</strong>
                    <span style="color:#00ff66;">${amount.toFixed(6)} ${escapeHtml(String(sym))}</span>
                  </div>
                  <div style="font-size:11px;opacity:.8;margin-top:4px;">${escapeHtml(from)} ‚Üí ${escapeHtml(to)}</div>
                  <div style="font-size:10px;opacity:.6;margin-top:2px;">${escapeHtml(stamp)}</div>
                </div>`;
            }).join('');
            content.innerHTML = `<div style="margin-bottom:8px;font-size:12px;color:#9adf9a;">No wallet-matched rows in this category. Showing recent network activity:</div><div style="display:flex;flex-direction:column;gap:8px;">${preview}</div>`;
            return;
        }
        content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No transactions in this category</div>';
        return;
    }

    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

    filtered.slice(0, 50).forEach(tx => {
        const isSent = tx.from === addr;
        const direction = isSent ? (isGreek ? 'ŒëœÄŒøœÉœÑŒøŒªŒÆ' : 'Sent') : (isGreek ? 'ŒõŒÆœàŒ∑' : 'Received');
        const directionIcon = isSent ? 'üì§' : 'üì•';
        const directionColor = isSent ? '#ff6666' : '#66ff66';

        const otherAddr = isSent ? tx.to : tx.from;
        const shortAddr = otherAddr ? `${otherAddr.slice(0, 8)}...${otherAddr.slice(-6)}` : 'N/A';

        const statusValue = (tx.status || '').toLowerCase();
        const isMined = statusValue === 'confirmed' || statusValue === 'mined';
        const isRejected = statusValue === 'rejected' || statusValue === 'failed';
        const statusBadge = isMined
            ? `<span style="background: #00ff0033; color: #00ff00; padding: 2px 6px; border-radius: 4px; font-size: 10px;">‚úì ${isGreek ? 'ŒïœÄŒπŒ≤ŒµŒ≤Œ±ŒπœéŒ∏Œ∑Œ∫Œµ' : 'Confirmed'}</span>`
            : isRejected
            ? `<span style="background: #ff333333; color: #ff6666; padding: 2px 6px; border-radius: 4px; font-size: 10px;">‚úï ${isGreek ? 'ŒëœÄŒøœÅœÅŒØœÜŒ∏Œ∑Œ∫Œµ' : 'Rejected'}</span>`
            : `<span style="background: #ffff0033; color: #ffff00; padding: 2px 6px; border-radius: 4px; font-size: 10px;">‚è≥ ${isGreek ? 'ŒïŒ∫Œ∫œÅŒµŒºŒµŒØ' : 'Pending'}</span>`;

        const txType = getTxType(tx);
        const typeLabel = txType === 'mining' ? '‚õèÔ∏è Mining' :
                         txType === 'l2e' ? 'üìö L2E' :
                         txType === 't2e' ? 'üöó T2E' :
                         txType === 'ai_credits' ? 'AI Credits' :
                         txType === 'architect_ai_jobs' ? 'Architect / AI Jobs' :
                         txType === 'architect' ? 'Architect / AI Jobs' :
                         txType === 'iot' ? 'üì° IoT' :
                         txType === 'bridge' ? 'üåâ Bridge' :
                         txType === 'swaps' ? 'üîÑ Swaps' :
                         txType === 'liquidity' ? 'üíß Liquidity' :
                         txType === 'gateway' ? 'üè¶ Gateway' :
                         txType === 'music' ? 'üéµ Music' : '';
        const isSwap = txType === 'swaps';
        const isLiquidity = txType === 'liquidity';
        const meta = tx.meta || {};
        const poolEvent = tx.meta && tx.meta.pool_event ? tx.meta.pool_event : null;
        // For AI credits / T2E, prefer display_amount or credits_delta over raw amount
        const isCreditsType = (txType === 'ai_credits' || txType === 't2e');
        const amountInRaw = poolEvent?.in_amount ?? tx.amount_in ?? tx.amountIn ?? tx.input_amount
            ?? tx.display_amount ?? tx.amount ?? (isCreditsType ? (meta.credits_delta ?? tx.credits ?? tx.reward ?? 0) : 0);
        const amountIn = Number.isFinite(Number(amountInRaw)) ? Number(amountInRaw) : 0;
        const amountOut = poolEvent?.out_amount ?? tx.amount_out ?? tx.amountOut ?? tx.output_amount ?? tx.received_amount;
        const amountOutNum = (amountOut !== undefined && Number.isFinite(Number(amountOut))) ? Number(amountOut) : null;

        // Determine correct asset symbol for display (avoid experimental 'TOKEN')
        const rawAsset = txType === 'tokens'
            ? (tx.asset_symbol || tx.asset || tx.symbol || tx.token_symbol || '')
            : txType === 't2e' ? 'T2E'
            : txType === 'ai_credits' ? (tx.unit || tx.asset || tx.symbol || (amountIn > 0 && !tx.amount ? 'Credits' : 'THR'))
            : (tx.symbol || tx.asset_symbol || tx.token_symbol || tx.asset || 'THR');
        const HIDDEN_TOKENS = ['TOKEN', 'UNKNOWN', 'TEST', 'NULL'];
        const displayAsset = HIDDEN_TOKENS.includes(rawAsset.toUpperCase()) ? 'THR' : (rawAsset || 'THR');

        const liquiditySubtype = (tx.subtype || tx.meta?.subtype || '').toLowerCase();
        const isLiquidityRemove = liquiditySubtype === 'remove_liq' || (tx.kind || tx.type || '').toLowerCase().includes('remove');
        const liquiditySign = isLiquidityRemove ? '+' : '-';
        const liquidityAmounts = isLiquidity
            ? (tx.amounts || tx.meta?.amounts || [
                { symbol: tx.symbol_in || tx.token_a || 'THR', amount: amountIn },
                { symbol: tx.symbol_out || tx.token_b || '', amount: amountOutNum }
            ]).filter(entry => entry && entry.symbol && Number.isFinite(Number(entry.amount)))
            : [];
        const liquidityLines = isLiquidity
            ? liquidityAmounts.map(entry => `${liquiditySign}${Number(entry.amount).toFixed(6)} ${entry.symbol}`)
            : [];
        const amountDisplay = isSwap
            ? `${amountIn.toFixed(6)} ${poolEvent?.in_token || tx.symbol_in || tx.from_symbol || tx.symbol || 'THR'}${amountOutNum !== null ? ` ‚Üí ${amountOutNum.toFixed(6)} ${poolEvent?.out_token || tx.symbol_out || tx.to_symbol || tx.target_symbol || tx.swap_out || ''}` : ''}`
            : isLiquidity
            ? (liquidityLines.length
                ? `<div style="text-align:right;">${liquidityLines.map(line => `<div>${line}</div>`).join('')}</div>`
                : `${amountIn.toFixed(6)} ${tx.symbol_in || tx.token_a || 'THR'}`)
            : `${Number(amountInRaw || 0).toFixed(6)} ${displayAsset}`;
        const swapPair = isSwap ? (tx.pair || tx.route || `${(poolEvent?.in_token || tx.swap_in || tx.from_symbol || tx.symbol || '?')}${poolEvent?.out_token || tx.swap_out || tx.to_symbol || tx.target_symbol ? `/${poolEvent?.out_token || tx.swap_out || tx.to_symbol || tx.target_symbol}` : ''}`) : '';
        const swapDirection = isSwap ? (tx.direction || tx.side || '') : '';

        // Fee information
        const fee = tx.fee_burned || tx.fee || 0;
        const feeDisplay = fee > 0 ? `<br><span style="font-size: 10px; opacity: 0.6;">${isGreek ? 'ŒöœåœÉœÑŒøœÇ:' : 'Fee:'} ${fee} THR</span>` : '';
        const swapMeta = isSwap && poolEvent
            ? `<br><span style="font-size: 10px; opacity: 0.6;">${isGreek ? 'Fee' : 'Fee'}: ${poolEvent.fee ?? fee} ‚Ä¢ ${isGreek ? 'Impact' : 'Impact'}: ${poolEvent.price_impact ?? tx.price_impact ?? '‚Äî'}%</span>`
            : '';

        // Pool/liquidity info
        let poolInfo = '';
        if (isLiquidity) {
            const action = isLiquidityRemove ? (isGreek ? 'ŒëœÜŒ±ŒØœÅŒµœÉŒ∑ Œ°ŒµœÖœÉœÑœåœÑŒ∑œÑŒ±œÇ' : 'Remove Liquidity') : (isGreek ? 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ Œ°ŒµœÖœÉœÑœåœÑŒ∑œÑŒ±œÇ' : 'Add Liquidity');
            const poolId = meta.pool_id || tx.pool_id;
            poolInfo = `<div style="font-size: 11px; color: #00bfff; opacity: 0.85; margin-top: 4px;">${action}${poolId ? ` ‚Ä¢ Pool ${escapeHtml(poolId)}` : ''}</div>`;
        } else if (isSwap && tx.meta) {
            const fromAsset = meta.from_asset || tx.symbol || 'THR';
            const toAsset = meta.to_asset || 'THR';
            poolInfo = `<div style="font-size: 11px; color: #00bfff; opacity: 0.85; margin-top: 4px;">Swap: ${escapeHtml(fromAsset)} ‚Üí ${escapeHtml(toAsset)}</div>`;
        }

        const detailLines = [];
        // PR-5c/5g: Music transaction details (tips + pool earnings)
        if (txType === 'music') {
            const royaltyType = meta.royalty_type || '';
            const isPoolEarning = royaltyType === 'play_reward' || tx.from === 'AI_WALLET';

            if (tx.track_title) detailLines.push(`Track: "${escapeHtml(tx.track_title)}"`);
            else if (tx.track_id) detailLines.push(`Track ID: ${escapeHtml(tx.track_id)}`);

            if (isPoolEarning) {
                // Music pool earnings from plays
                const playNum = meta.play_number || '';
                const earnLabel = isGreek ? 'üéµ ŒöŒ≠œÅŒ¥Œ∑ Œ±œÄœå Plays' : 'üéµ Pool Earnings';
                detailLines.push(earnLabel);
                if (playNum) detailLines.push(`Play #${playNum}`);
            } else {
                // Direct tip from fan
                const tipLabel = isSent
                    ? (isGreek ? 'üíù Tip Œ≥ŒπŒ± Œ∫Œ±ŒªŒªŒπœÑŒ≠œáŒΩŒ∑' : 'üíù Tip to artist')
                    : (isGreek ? 'üíù Tip Œ±œÄœå fan' : 'üíù Tip from fan');
                detailLines.push(tipLabel);
            }
        }
        if (txType === 'architect_ai_jobs') {
            if (meta.job_id) detailLines.push(`Job: ${escapeHtml(meta.job_id)}`);
            if (meta.files_count != null) detailLines.push(`Files: ${meta.files_count}`);
            if (meta.bytes_total != null) detailLines.push(`Size: ${formatBytes(meta.bytes_total)}`);
            if (meta.reward_thr != null) detailLines.push(`Reward: ${Number(meta.reward_thr).toFixed(6)} THR`);
            if (meta.pct != null) detailLines.push(`Progress: ${Number(meta.pct).toFixed(1)}%`);
            if (meta.bytes_done != null && meta.bytes_total) {
                detailLines.push(`Progress: ${formatBytes(meta.bytes_done)} / ${formatBytes(meta.bytes_total)}`);
            }
            if ((tx.kind || '').toLowerCase().startsWith('ai_job_')) {
                detailLines.push(`Status: ${(tx.kind || '').replace(/_/g, ' ')}`);
            }
        }
        if (txType === 'ai_credits') {
            if (meta.credits_delta != null) detailLines.push(`Credits: ${Number(meta.credits_delta).toFixed(2)}`);
            if (meta.session_id) detailLines.push(`Session: ${escapeHtml(meta.session_id)}`);
            if (meta.reason) detailLines.push(`Reason: ${escapeHtml(meta.reason)}`);
            if (meta.tokens_used != null) detailLines.push(`Tokens: ${meta.tokens_used}`);
        }
        // PR-5g: IoT purchase details
        if (txType === 'iot') {
            if (tx.pack_name) detailLines.push(`${escapeHtml(tx.pack_name)}`);
            else if (tx.pack_id) detailLines.push(`Pack: ${escapeHtml(tx.pack_id)}`);
            if (tx.fiat_amount && tx.currency) {
                const currSymbol = tx.currency === 'EUR' ? '‚Ç¨' : tx.currency === 'USD' ? '$' : tx.currency;
                detailLines.push(`${currSymbol}${Number(tx.fiat_amount).toFixed(2)}`);
            }
            if (meta.payment_status) detailLines.push(`Payment: ${escapeHtml(meta.payment_status)}`);
        }
        const detailInfo = detailLines.length
            ? `<div style="font-size: 11px; color: #9adf9a; opacity: 0.9; margin-top: 4px;">${detailLines.join(' ‚Ä¢ ')}</div>`
            : '';

        // Token price info
        const priceInfo = (tx.meta && tx.meta.token_price_thr)
            ? `<br><span style="font-size: 10px; opacity: 0.6;">${isGreek ? 'Œ§ŒπŒºŒÆ:' : 'Price:'} ${tx.meta.token_price_thr} THR per ${tx.asset_symbol || tx.symbol}</span>`
            : '';

        html += `
            <div style="background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${directionIcon}</span>
                        <span style="color: ${directionColor}; font-weight: bold;">${direction}</span>
                        ${typeLabel ? `<span style="background: rgba(0,191,255,0.2); color: #00bfff; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${typeLabel}</span>` : ''}
                        ${statusBadge}
                    </div>
                    <div style="font-weight: bold; color: #00ff66;">${amountDisplay}</div>
                </div>
                <div style="font-size: 11px; opacity: 0.7;">
                    ${isSent ? (isGreek ? 'Œ†œÅŒøœÇ:' : 'To:') : (isGreek ? 'ŒëœÄœå:' : 'From:')} ${shortAddr}${feeDisplay}${swapMeta}${priceInfo}
                </div>
                ${poolInfo}
                ${detailInfo}
                ${isSwap && swapPair ? `<div style="font-size: 11px; opacity: 0.75; margin-top: 4px;">${isGreek ? 'ŒñŒµœçŒ≥ŒøœÇ:' : 'Pair:'} ${escapeHtml(swapPair || 'Unknown pair')}${swapDirection ? ` ‚Ä¢ ${escapeHtml(swapDirection)}` : ''}</div>` : ''}
                ${tx.timestamp ? `<div style="font-size: 10px; opacity: 0.5; margin-top: 4px;">${formatTxDate(tx.timestamp)}</div>` : ''}
            </div>
        `;
    });

    html += '</div>';
    content.innerHTML = html;
}

async function loadWalletHistory(thrAddress) {
    if (!thrAddress || typeof thrAddress !== 'string') {
        console.warn('loadWalletHistory: invalid address', thrAddress);
        return [];
    }

    // Ensure proper URL format with query string
    const cleanAddress = thrAddress.trim();
    if (!cleanAddress) {
        console.warn('loadWalletHistory: empty address after trim');
        return [];
    }

    const url = buildWalletMusicApiUrl(`/api/wallet/history?address=${encodeURIComponent(cleanAddress)}&limit=200`);
    console.log('[WalletHistory] Fetching:', url);

    try {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 15000);
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timer);
        if (!res.ok) {
            console.error('[WalletHistory] HTTP error:', res.status, res.statusText);
            return [];
        }
        const data = await res.json();
        console.log('[WalletHistory] Response ok:', data?.ok, 'txCount:', data?.transactions?.length || 0);

        // Extract transactions array from response (supports multiple backend shapes)
        const txs = Array.isArray(data)
            ? data
            : (Array.isArray(data?.transactions) ? data.transactions
                : (Array.isArray(data?.history) ? data.history
                    : (Array.isArray(data?.txs) ? data.txs
                        : (Array.isArray(data?.items) ? data.items : []))));
        const normalized = Array.isArray(txs) ? txs : [];
        console.log('[WalletHistory] Parsed tx rows:', normalized.length, 'address:', cleanAddress);
        return normalized;
    } catch (err) {
        console.error('[WalletHistory] Fetch error:', err);
        return [];
    }
}

async function loadNetworkHistory(limit = 200) {
    try {
        const url = buildWalletMusicApiUrl(`/api/transfers?limit=${Math.max(20, Math.min(limit, 500))}`);
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        const rows = Array.isArray(data?.transfers) ? data.transfers : (Array.isArray(data?.transactions) ? data.transactions : []);
        return rows;
    } catch (err) {
        console.warn('[WalletHistory] network history fetch failed:', err);
        return [];
    }
}

async function loadAICreditsLedger(thrAddress) {
    if (!thrAddress || typeof thrAddress !== 'string') return [];
    const url = buildWalletMusicApiUrl(`/api/ai_credits/ledger?wallet=${encodeURIComponent(thrAddress.trim())}&limit=200`);
    try {
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        return Array.isArray(data?.items) ? data.items : (Array.isArray(data?.entries) ? data.entries : []);
    } catch (err) {
        console.warn('[WalletHistory] AI ledger fetch failed:', err);
        return [];
    }
}

async function hydrateHistory(thrAddress) {
    const content = document.getElementById('historyContent');
    try {
        historyLoading = true;
        content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">Loading...</div>';
        WALLET_HISTORY_CACHE = await loadWalletHistory(thrAddress);
        AI_LEDGER_CACHE = await loadAICreditsLedger(thrAddress);
        NETWORK_HISTORY_CACHE = await loadNetworkHistory(220);
        allTransactions = WALLET_HISTORY_CACHE || [];
        historyLoading = false;
        if (!allTransactions.length) {
            content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No transactions found</div>';
            return;
        }
        renderHistory();
        startHistoryPendingPolling();
    } catch (error) {
        console.error('Failed to load history:', error);
        WALLET_HISTORY_CACHE = [];
        allTransactions = [];
        historyLoading = false;
        content.innerHTML = `
            <div class="send-result error" style="margin: 20px;">Unable to load transaction history</div>
            <div style="text-align:center; margin-top:10px;">
                <button class="wallet-btn" onclick="hydrateHistory(walletSession.getAddress())">Retry</button>
            </div>
        `;
    }
}

// Bridge Modal Functions
function openBridgeModal() {
    document.getElementById('bridgeModal').classList.add('active');
    loadBridgeDeposit();
}

function closeBridgeModal(event) {
    if (!event || event.target.id === 'bridgeModal') {
        document.getElementById('bridgeModal').classList.remove('active');
    }
}

async function loadBridgeDeposit() {
    const addr = walletSession.getAddress();
    const depositEl = document.getElementById('bridgeDepositAddress');
    const emptyEl = document.getElementById('bridgeEmpty');

    if (!addr) {
        if (depositEl) depositEl.textContent = '‚Äî';
        if (emptyEl) emptyEl.style.display = 'block';
        return;
    }

    try {
        const response = await fetch(`/api/bridge/deposit?wallet=${encodeURIComponent(addr)}`);
        const data = await response.json();

        if (data.deposit_address) {
            if (depositEl) depositEl.textContent = data.deposit_address;
            if (emptyEl) emptyEl.style.display = 'none';
        } else {
            if (depositEl) depositEl.textContent = '‚Äî';
            if (emptyEl) emptyEl.style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load bridge deposit:', error);
        if (depositEl) depositEl.textContent = 'Error loading address';
        if (emptyEl) emptyEl.style.display = 'block';
    }
}

function copyBridgeAddress() {
    const addr = document.getElementById('bridgeDepositAddress').textContent;
    if (addr && addr !== '‚Äî') {
        copyToClipboard(addr);
    }
}

function selectSpeed(speed) {
    selectedSpeed = speed;
    document.querySelectorAll('.send-speed-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`[data-speed="${speed}"]`).classList.add('selected');
}

function selectNetwork(network) {
    // Prevent selection of disabled networks
    if (network === 'solana') {
        showToast('Solana support coming soon!');
        return;
    }

    selectedNetwork = network;
    document.querySelectorAll('.send-network-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    const selectedOpt = document.querySelector(`[data-network="${network}"]`);
    if (selectedOpt) selectedOpt.classList.add('selected');

    // Update recipient placeholder based on network
    const toInput = document.getElementById('sendTo');
    const placeholders = {
        'thronos': 'THR...',
        'bitcoin': 'bc1... or 1... or 3...',
        'ethereum': '0x...',
        'bnb': '0x...',
        'xrp': 'r...',
        'solana': ''
    };
    toInput.placeholder = placeholders[network] || 'Address...';

    // Update token list based on network
    updateTokenListForNetwork(network);
}

function updateTokenListForNetwork(network) {
    const select = document.getElementById('sendToken');
    if (!select) return;

    // Clear current options
    select.innerHTML = '';

    if (network === 'thronos') {
        // Show all Thronos tokens (existing behavior)
        const thrOption = document.createElement('option');
        thrOption.value = 'THR';
        thrOption.textContent = 'THR - Thronos';
        thrOption.setAttribute('data-color', '#ff6600');
        select.appendChild(thrOption);

        const wbtcOption = document.createElement('option');
        wbtcOption.value = 'WBTC';
        wbtcOption.textContent = 'WBTC - Wrapped Bitcoin';
        wbtcOption.setAttribute('data-color', '#f7931a');
        select.appendChild(wbtcOption);

        const l2eOption = document.createElement('option');
        l2eOption.value = 'L2E';
        l2eOption.textContent = 'L2E - Learn-to-Earn';
        l2eOption.setAttribute('data-color', '#00bfff');
        select.appendChild(l2eOption);
    } else {
        // For external networks, show native tokens only
        const networkTokens = {
            'bitcoin': { symbol: 'BTC', name: 'Bitcoin', color: '#f7931a' },
            'ethereum': { symbol: 'ETH', name: 'Ethereum', color: '#627eea' },
            'bnb': { symbol: 'BNB', name: 'BNB', color: '#f3ba2f' },
            'xrp': { symbol: 'XRP', name: 'XRP', color: '#00aae4' }
        };

        const token = networkTokens[network];
        if (token) {
            const option = document.createElement('option');
            option.value = token.symbol;
            option.textContent = `${token.symbol} - ${token.name}`;
            option.setAttribute('data-color', token.color);
            select.appendChild(option);
        }
    }

    updateTokenInfo();
}

function anyModalOpen() {
    const modals = ['sendModal', 'receiveModal', 'walletHistoryModal', 'bridgeModal', 'musicModal'];
    return modals.some(id => {
        const modal = document.getElementById(id);
        if (!modal) return false;
        if (id === 'musicModal') {
            return modal.classList.contains('open');
        }
        return modal.classList.contains('active');
    });
}

async function submitCrossChainSend(network, to, amount, token, from, secret, resultDiv) {
    resultDiv.style.display = 'block';
    resultDiv.className = 'send-result';
    resultDiv.textContent = `Processing ${network.toUpperCase()} withdrawal...`;

    try {
        // Prepare cross-chain withdraw request (burns wrapped token, sends to external chain)
        const payload = {
            wallet: from,               // THR address
            network: network,           // bitcoin, ethereum, bnb, xrp
            destination: to,            // External address
            amount: amount              // Amount to withdraw
        };

        const response = await fetch(resolveMasterUrl('/api/bridge/withdraw'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.ok || data.status === 'success') {
            resultDiv.className = 'send-result success';
            const requestId = data.request_id || '‚Äî';
            const wrappedToken = data.wrapped_token || token;
            resultDiv.innerHTML = `
                ‚úÖ Bridge withdrawal initiated!<br>
                <small>Burned: ${amount} ${wrappedToken}</small><br>
                <small>Network: ${network.toUpperCase()}</small><br>
                <small>To: ${to.substring(0, 12)}...</small><br>
                <small>Request ID: ${requestId.substring(0, 20)}...</small><br>
                <small style="color: #ffa500;">‚è≥ Operator will process within 24h</small>
            `;

            // Refresh balances after delay
            setTimeout(() => {
                loadWalletBalances(true);
                loadTokenBalances();
            }, 2000);

            // Auto-close after 8 seconds (longer to read operator message)
            setTimeout(() => {
                closeSendModal();
                resultDiv.style.display = 'none';
                resultDiv.textContent = '';
            }, 8000);
        } else {
            resultDiv.className = 'send-result error';
            const errorMsg = data.error || data.message || 'Withdrawal failed';
            resultDiv.textContent = `‚ùå Error: ${errorMsg}`;
        }
    } catch (error) {
        console.error('Bridge withdraw error:', error);
        resultDiv.className = 'send-result error';
        resultDiv.textContent = `‚ùå Network error: ${error.message || 'Failed to withdraw'}`;
    }
}

async function loadTokenBalances() {
    const wallet = walletSession.getAddress();
    if (!wallet) return;

    try {
        const response = await fetch(resolveMasterUrl(`/api/balances?address=${encodeURIComponent(wallet)}&show_zero=true`));
        if (!response.ok) {
            throw new Error(`Balance fetch failed (${response.status})`);
        }
        const data = await response.json();
        if (data.tokens) {
            // Update balances map
            data.tokens.forEach(t => {
                window.tokenBalances[t.symbol] = t.balance;
            });

            // Ensure token selector has *all* tokens that appear in balances (not only registry tokens)
            const select = document.getElementById('sendToken');
            const existing = new Set(Array.from(select.options).map(o => o.value));

            // Prefer THR first, then rest alphabetically
            const sorted = [...data.tokens].sort((a, b) => {
                if (a.symbol === 'THR') return -1;
                if (b.symbol === 'THR') return 1;
                return String(a.symbol).localeCompare(String(b.symbol));
            });

            sorted.forEach(t => {
                if (!existing.has(t.symbol)) {
                    const option = document.createElement('option');
                    option.value = t.symbol;
                    option.textContent = t.symbol;
                    select.appendChild(option);
                    existing.add(t.symbol);
                }
            });

            updateTokenInfo();
        }
    } catch (e) {
        console.error('Failed to load token balances:', e);
        setDisconnectedUI();
    }
}
async function loadCustomTokens() {
    try {
        const response = await fetch('/api/tokens/list');
        const data = await response.json();
        if (data.ok && data.tokens) {
            const select = document.getElementById('sendToken');
            // Add custom tokens to select
            data.tokens.forEach(token => {
                if (!select.querySelector(`option[value="${token.symbol}"]`)) {
                    const option = document.createElement('option');
                    option.value = token.symbol;
                    option.dataset.color = token.color || '#00ff66';
                    option.textContent = `${token.symbol} - ${token.name}`;
                    select.appendChild(option);
                }
            });
        }
    } catch (e) {
        console.log('No custom tokens available');
    }
}

function updateTokenInfo() {
    const select = document.getElementById('sendToken');
    selectedToken = select.value;
    const balance = window.tokenBalances[selectedToken] || 0;
    document.getElementById('availableBalance').textContent = balance.toFixed(6) + ' ' + selectedToken;
}

function setMaxAmount() {
    const balance = window.tokenBalances[selectedToken] || 0;
    // Reserve a small amount for fees
    const feeReserve = selectedSpeed === 'slow' ? balance * 0.001 : balance * 0.006;
    const maxAmount = Math.max(0, balance - feeReserve);
    document.getElementById('sendAmount').value = maxAmount.toFixed(6);
}

function generateClientTxId() {
    if (crypto && typeof crypto.randomUUID === 'function') {
        return `thr-${crypto.randomUUID()}`;
    }
    return `thr-${Date.now()}-${Math.random().toString(16).slice(2, 10)}`;
}

// Transaction status polling
let txPollInterval = null;
let historyPollInterval = null;
let tokenPriceInterval = null;
let walletBalanceInterval = null;
let chainTokensInterval = null;

// History refresh with exponential backoff on consecutive failures
let historyFailCount = 0;
let historyPollDelay = 10000; // Start with 10s
const MIN_HISTORY_POLL_DELAY = 10000; // 10s minimum
const MAX_HISTORY_POLL_DELAY = 60000; // 60s maximum

async function refreshHistoryFromApi() {
    const addr = walletSession.getAddress();
    if (!addr) return;
    try {
        const _ctrl = new AbortController();
        const _t = setTimeout(() => _ctrl.abort(), 15000);
        const response = await fetch(buildWalletMusicApiUrl(`/api/wallet/history?address=${encodeURIComponent(addr)}&limit=200`), { signal: _ctrl.signal });
        clearTimeout(_t);

        if (!response.ok) {
            throw new Error(`History API returned ${response.status}`);
        }

        const data = await response.json();
        const txs = Array.isArray(data?.transactions)
            ? data.transactions
            : (Array.isArray(data?.history) ? data.history : []);
        if (Array.isArray(txs)) {
            WALLET_HISTORY_CACHE = txs;
            allTransactions = txs;
            renderHistory();

            // Reset failure count and delay on success
            historyFailCount = 0;
            if (historyPollDelay !== MIN_HISTORY_POLL_DELAY) {
                historyPollDelay = MIN_HISTORY_POLL_DELAY;
                // Restart polling with normal interval
                if (historyPollInterval) {
                    clearInterval(historyPollInterval);
                    historyPollInterval = setInterval(refreshHistoryFromApi, historyPollDelay);
                }
            }
        }
    } catch (error) {
        console.error('Failed to refresh history:', error);

        // Increment failure count and apply exponential backoff
        historyFailCount++;
        const newDelay = Math.min(
            MIN_HISTORY_POLL_DELAY * Math.pow(2, Math.min(historyFailCount - 1, 3)),
            MAX_HISTORY_POLL_DELAY
        );

        if (newDelay !== historyPollDelay) {
            historyPollDelay = newDelay;
            console.warn(`[Wallet] History refresh failed ${historyFailCount} times, backing off to ${historyPollDelay}ms`);

            // Restart polling with new backoff interval
            if (historyPollInterval) {
                clearInterval(historyPollInterval);
                historyPollInterval = setInterval(refreshHistoryFromApi, historyPollDelay);
            }
        }
    }
}

function startHistoryPendingPolling() {
    if (historyPollInterval) {
        clearInterval(historyPollInterval);
    }
    // Reset failure count and delay when explicitly starting polling
    historyFailCount = 0;
    historyPollDelay = MIN_HISTORY_POLL_DELAY;
    refreshHistoryFromApi();
    historyPollInterval = setInterval(refreshHistoryFromApi, historyPollDelay);
}

async function pollTransactionStatus(txid, resultDiv) {
    let pollCount = 0;
    const maxPolls = 60; // 10 minutes max (60 * 10s)

    // Clear any existing poll
    if (txPollInterval) {
        clearInterval(txPollInterval);
    }

    const checkStatus = async () => {
        try {
            const response = await fetch(`/api/tx_status/${encodeURIComponent(txid)}`);
            const data = await response.json();

            const statusIndicator = document.getElementById('txStatusIndicator');
            if (!statusIndicator) {
                // Modal closed, stop polling
                clearInterval(txPollInterval);
                return;
            }

            const status = (data.status || '').toLowerCase();
            if (status === 'mined' || status === 'confirmed' || data.confirmed) {
                statusIndicator.textContent = '‚úì Confirmed!';
                statusIndicator.style.color = '#00ff00';
                clearInterval(txPollInterval);

                // Close modal after 2 seconds
                setTimeout(() => {
                    closeSendModal();
                }, 2000);
            } else if (status === 'rejected' || status === 'failed') {
                const reason = data.reason ? ` (${data.reason})` : '';
                statusIndicator.textContent = `‚úï Transaction failed${reason}`;
                statusIndicator.style.color = '#ff6666';
                clearInterval(txPollInterval);
            } else {
                // Still pending
                pollCount++;
                if (pollCount >= maxPolls) {
                    statusIndicator.textContent = '‚è± Confirmation pending (check history later)';
                    statusIndicator.style.color = '#ffaa00';
                    clearInterval(txPollInterval);

                    setTimeout(() => {
                        closeSendModal();
                    }, 3000);
                }
            }
        } catch (error) {
            console.error('Status poll error:', error);
            // Don't stop polling on network errors, just continue
        }
    };

    // Initial check immediately
    await checkStatus();

    // Then poll every 10 seconds
    txPollInterval = setInterval(checkStatus, 10000);
}

async function submitSend() {
    const to = document.getElementById('sendTo').value.trim();
    const amount = parseFloat(document.getElementById('sendAmount').value);
    const token = document.getElementById('sendToken').value;
    const from = walletSession.getAddress();
    const secret = walletSession.getSendSeed();
    const resultDiv = document.getElementById('sendResult');
    const clientTxId = generateClientTxId();

    if (!walletSession.isBound()) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = 'Wallet not connected';
        resultDiv.style.display = 'block';
        return;
    }

    if (!to || !amount || amount <= 0) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = 'Please enter valid recipient and amount';
        resultDiv.style.display = 'block';
        return;
    }

    if (!from || !secret) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = 'Wallet not connected';
        resultDiv.style.display = 'block';
        return;
    }

    // Validate balance
    const balance = window.tokenBalances[token] || 0;
    if (amount > balance) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = `Insufficient ${token} balance`;
        resultDiv.style.display = 'block';
        return;
    }

    if(!walletSession.requirePin('send tokens')) return;

    try {
        // Check if this is a cross-chain send
        const network = selectedNetwork || 'thronos';

        if (network !== 'thronos') {
            // Cross-chain send via bridge
            return await submitCrossChainSend(network, to, amount, token, from, secret, resultDiv);
        }

        // Calculate fee based on selected speed
        const feeRate = selectedSpeed === 'slow' ? 0.0009 : 0.005;
        let fee = Math.max(0.001, amount * feeRate);
        fee = parseFloat(fee.toFixed(6));

        let response;

        if (token === 'THR') {
            // Native THR send
            const payload = {
                from_thr: from,
                to_thr: to,
                amount: amount,
                auth_secret: secret,
                speed: selectedSpeed,
                tx_id: clientTxId,
                expected_fee: fee
            };
            response = await fetch(resolveMasterUrl('/send_thr'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            // Custom token transfer - backend expects: from, to, symbol, amount
            const payload = {
                symbol: token,
                from: from,
                to: to,
                amount: amount,
                auth_secret: secret,
                speed: selectedSpeed // optional fee tier hint
            };
            response = await fetch(resolveMasterUrl('/api/tokens/transfer'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        const data = await response.json();

        if (data.accepted === false || data.status === 'rejected' || data.error || data.ok === false) {
            resultDiv.className = 'send-result error';
            // Check for specific error about THR balance for fees
            let errorMsg = data.reject_reason || data.error || data.message || 'Transaction failed';
            if (data.thr_balance !== undefined && data.fee_required !== undefined) {
                errorMsg = `${errorMsg}. THR balance: ${data.thr_balance}, Fee required: ${data.fee_required} THR`;
            }
            resultDiv.textContent = `Error: ${errorMsg}`;
            resultDiv.style.display = 'block';
        } else {
            // Show pending status with txid
            const actualFee = data.fee_burned || data.fee || fee;
            const txid = data.tx_id || (data.tx && data.tx.tx_id) || data.txid || clientTxId || 'pending';
            const shortTxid = txid.length > 16 ? `${txid.slice(0, 8)}...${txid.slice(-8)}` : txid;

            resultDiv.className = 'send-result success';
            resultDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div>‚è≥ ${amount} ${token} sent! Fee: ${actualFee.toFixed(6)} THR</div>
                    <div style="font-size: 11px; opacity: 0.8;">TX: ${shortTxid}</div>
                    <div id="txStatusIndicator" style="font-size: 11px; color: #ffff00;">‚è≥ Pending confirmation...</div>
                </div>
            `;
            resultDiv.style.display = 'block';

            // Reset wallet balances to reload
            walletBalancesLoaded = false;
            window.tokenBalances = {};

            // Reload balances
            setTimeout(() => {
                loadTokenBalances();
                loadWalletBalances(true);
            }, 1000);

            // Start polling for transaction status if we have a txid
            if (txid && txid !== 'pending') {
                pollTransactionStatus(txid, resultDiv);
            } else {
                // If no txid, close after 3 seconds
                setTimeout(() => {
                    closeSendModal();
                }, 3000);
            }
        }
    } catch (error) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = `Error: ${error.message}`;
        resultDiv.style.display = 'block';
    }
}



// --- Wallet UI lock/pin (prevents "vanishing" on hover and adds optional PIN unlock) ---
const WALLET_UI_PINNED_KEY = 'thr_wallet_ui_pinned';
const WALLET_PIN_HASH_KEY  = 'thr_wallet_pin_hash';
const WALLET_LAST_ACTIVE_KEY = 'thr_wallet_last_active';
const WALLET_IDLE_LOCK_MS = 20 * 60 * 1000; // 20 minutes

function _nowMs(){ return Date.now(); }

async function sha256Hex(str){
    try {
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    } catch(e) {
        // Fallback (no crypto.subtle) - not ideal, but better than breaking UX
        return 'plain:' + String(str);
    }
}

function getWalletUiPinned(){
    return localStorage.getItem(WALLET_UI_PINNED_KEY) === '1';
}
function setWalletUiPinned(v){
    localStorage.setItem(WALLET_UI_PINNED_KEY, v ? '1' : '0');
}

function markWalletActive(){
    localStorage.setItem(WALLET_LAST_ACTIVE_KEY, String(_nowMs()));
}
function isWalletStale(){
    const last = parseInt(localStorage.getItem(WALLET_LAST_ACTIVE_KEY) || '0', 10);
    return !last || (_nowMs() - last) > WALLET_IDLE_LOCK_MS;
}

async function ensureWalletPinSet(){
    const existing = localStorage.getItem(WALLET_PIN_HASH_KEY);
    if(existing) return true;
    const pin1 = prompt('Set a wallet PIN (4-8 digits). Keep it safe.');
    if(!pin1) return false;
    if(!/^\d{4,8}$/.test(pin1)) { alert('PIN must be 4-8 digits.'); return false; }
    const pin2 = prompt('Confirm PIN');
    if(pin1 !== pin2){ alert('PINs do not match.'); return false; }
    const h = await sha256Hex(pin1);
    localStorage.setItem(WALLET_PIN_HASH_KEY, h);
    markWalletActive();
    return true;
}

async function ensureWalletUnlocked(){
    // If idle too long, require PIN (if set)
    const hash = localStorage.getItem(WALLET_PIN_HASH_KEY);
    if(!hash) return true; // no pin set
    if(!isWalletStale()) return true;
    const pin = prompt('Wallet locked (idle). Enter PIN to continue.');
    if(!pin) return false;
    const h = await sha256Hex(pin);
    if(h !== hash){ alert('Wrong PIN.'); return false; }
    markWalletActive();
    return true;
}

function setWalletOpen(open){
    const statusEl = document.getElementById('walletStatus');
    if(!statusEl) return;
    if(open) statusEl.classList.add('open');
    else statusEl.classList.remove('open');
}

function isWalletOpen(){
    const statusEl = document.getElementById('walletStatus');
    return !!statusEl && statusEl.classList.contains('open');
}

function initWalletUiControls(){
    const statusEl = document.getElementById('walletStatus');
    const pinBtn = document.getElementById('walletPinBtn');
    const lockBtn = document.getElementById('walletLockBtn');
    if(!statusEl) return;

    // Reflect pinned state
    if(pinBtn){
        if(getWalletUiPinned()) pinBtn.classList.add('active');
        pinBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const next = !getWalletUiPinned();
            setWalletUiPinned(next);
            pinBtn.classList.toggle('active', next);
        });
    }

    if(lockBtn){
        lockBtn.addEventListener('click', async (ev)=>{
            ev.stopPropagation();
            const ok = await ensureWalletPinSet();
            if(ok) alert('PIN set. Wallet will auto-lock after inactivity.');
        });
    }

    // Click-to-toggle wallet popup (stays open until closed)
    statusEl.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const ok = await ensureWalletUnlocked();
        if(!ok) return;
        const nextOpen = !isWalletOpen();
        setWalletOpen(nextOpen);
        if(nextOpen) await loadWalletBalances();
        markWalletActive();
    });

    // Close on outside click, unless pinned (with delay to prevent immediate close)
    setTimeout(() => {
        document.addEventListener('click', (e)=>{
            if(getWalletUiPinned()) return;
            const popup = document.getElementById('walletBalancePopup');
            if(!popup || !statusEl) return;
            // Don't close if clicking inside the popup or status element
            if(statusEl.contains(e.target) || popup.contains(e.target)) return;
            setWalletOpen(false);
        });
    }, 100);
}

function showWalletLoginForm(){
    const loginSection = document.getElementById('walletLoginSection');
    const contentSection = document.getElementById('walletContentSection');
    if(loginSection){
        loginSection.style.display = 'block';
        const addrInput = document.getElementById('walletWidgetAddress');
        const secretInput = document.getElementById('walletWidgetSecret');
        const pinInput = document.getElementById('walletWidgetPin');
        if(addrInput) addrInput.value = walletSession.getAddress();
        if(secretInput) secretInput.value = walletSession.getSendSeed();
        if(pinInput) pinInput.value = walletSession.getPin();
        setTimeout(()=>{ if(addrInput) addrInput.focus(); }, 50);
    }
    if(contentSection) contentSection.style.display = 'none';
}

function showWalletContentSection(){
    const loginSection = document.getElementById('walletLoginSection');
    const contentSection = document.getElementById('walletContentSection');
    if(loginSection) loginSection.style.display = 'none';
    if(contentSection) contentSection.style.display = 'block';
}

function openHeaderWalletModal(){
    const addr = walletSession.getAddress();
    const pin = walletSession.getPin();

    // If device has credentials (address + PIN), do PIN-only unlock
    if (addr && pin && !walletSession.isBound()) {
        const entered = prompt('Enter PIN to unlock wallet');
        if (entered === null) return; // User cancelled
        if (entered === pin) {
            walletSession.setBound(true);
            setWalletOpen(true);
            showWalletContentSection();
            loadWalletBalances(true);
            updateWalletUI();
        } else {
            alert('Wrong PIN');
        }
        return;
    }

    // Otherwise show modal
    setWalletOpen(true);
    if(!walletSession.isBound()){
        showWalletLoginForm();
    } else {
        showWalletContentSection();
        loadWalletBalances(true);
    }
}

function closeHeaderWalletModal(){
    setWalletOpen(false);
}

async function submitHeaderWalletLogin(){
    const existingAddress = walletSession.getAddress();
    const existingSeed = walletSession.getSendSeed();

    const address = (document.getElementById('walletWidgetAddress')?.value || '').trim() || existingAddress;
    const seed = (document.getElementById('walletWidgetSecret')?.value || '').trim() || existingSeed;
    const pin = (document.getElementById('walletWidgetPin')?.value || '').trim();
    if (!address) {
        alert('Please enter a THR address.');
        return;
    }

    // Store session (reuse saved address/seed when logging in with PIN-only)
    walletSession.saveSession({ address, sendSeed: seed, pin, bound: true });

    // Sync the PIN with the wallet lock so PIN-only unlock works with the header widget
    if (pin) {
        const h = await sha256Hex(pin);
        localStorage.setItem(WALLET_PIN_HASH_KEY, h);
        markWalletActive();
    } else {
        localStorage.removeItem(WALLET_PIN_HASH_KEY);
    }

    showWalletContentSection();
    updateHeaderWalletUi();
    updateWalletUI();
    loadTokenBalances();
    loadWalletBalances(true);
    updateReceiveModal();
    if (typeof updateHeroButton === 'function') {
        updateHeroButton(address);
    }
}

function updateHeaderWalletUi(){
    const wallet = walletSession.getAddress();
    const bound = walletSession.isBound();
    const statusEl = document.getElementById('walletStatus');
    const disconnectEl = document.getElementById('disconnectBtn');
    const loginBtn = document.getElementById('walletLoginBtn');

    const hasWallet = bound && wallet;
    const short = hasWallet ? wallet.substring(0, 6) + '...' + wallet.substring(wallet.length - 4) : 'Connect';

    if(statusEl){
        document.getElementById('walletAddrShort').textContent = short;
        statusEl.style.display = 'flex';
        if(!statusEl.dataset.init){
            initWalletUiControls();
            statusEl.dataset.init = '1';
        }
    }

    if(disconnectEl) disconnectEl.style.display = hasWallet ? 'block' : 'none';
    // Hide login button when wallet is connected
    if(loginBtn) loginBtn.style.display = hasWallet ? 'none' : 'inline-block';

    if(hasWallet){
        const isPinned = getWalletUiPinned();
        const hasOpenedBefore = sessionStorage.getItem('wallet_opened_once');
        if (isPinned || !hasOpenedBefore) {
            setTimeout(() => {
                setWalletOpen(true);
                loadWalletBalances();
                sessionStorage.setItem('wallet_opened_once', '1');
            }, 500);
        }
    } else {
        setWalletOpen(false);
        showWalletLoginForm();
        walletBalancesLoaded = false;
    }
}

// Initialize language and wallet status on load
document.addEventListener('DOMContentLoaded', () => {
    const savedLang = getCurrentLang();
    setLanguage(savedLang);
    updateHeaderWalletUi();

    // Update token prices every 30 seconds
    updateTokenPrices();  // Initial update
    if (tokenPriceInterval) {
        clearInterval(tokenPriceInterval);
    }
    tokenPriceInterval = setInterval(updateTokenPrices, 30000);

    // PR-5a: Refresh wallet balances every 60 seconds if wallet is open, page is visible, and no modals are open
    if (walletBalanceInterval) {
        clearInterval(walletBalanceInterval);
    }
    walletBalanceInterval = setInterval(() => {
        if (!document.hidden && walletSession.isBound() && isWalletOpen() && !anyModalOpen()) {
            loadWalletBalances(true);
        }
    }, 60000);
});

// PR-5g: Listen for language changes and refresh wallet content
window.addEventListener('langChanged', (e) => {
    console.log('[Wallet] Language changed to:', e.detail.lang);

    // Refresh wallet popup if open
    if (isWalletOpen() && walletSession.isBound()) {
        const activeTab = document.querySelector('.wallet-popup-tab.active');
        if (!activeTab) return;

        const tabName = activeTab.getAttribute('onclick')?.match(/showWalletTab\('([^']+)'/)?.[1];
        if (!tabName) return;

        // Re-render the active tab to update language
        switch (tabName) {
            case 'overview':
                loadWalletBalances(true);
                break;
            case 'send':
                showWalletTab('send');
                break;
            case 'receive':
                showWalletTab('receive');
                break;
            case 'history':
                loadHistoryTab();
                break;
            case 'music':
                loadMusicTab();
                break;
            case 'offline':
                loadOfflineTab();
                break;
        }
    }

    // Refresh header wallet UI
    updateHeaderWalletUi();
});

// ‚îÄ‚îÄ‚îÄ TOKEN INFO MODAL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tokenInfoCache = {};

async function openTokenInfoModal(symbol) {
    const modal = document.getElementById('tokenInfoModal');
    const body = document.getElementById('tokenInfoBody');
    modal.classList.add('active');

    // Show loading state
    body.innerHTML = `
        <div class="wallet-popup-loading">
            <div class="wallet-popup-spinner"></div>
            <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ œÄŒªŒ∑œÅŒøœÜŒøœÅŒπœéŒΩ...</span>
            <span class="lang-en">Loading token info...</span>
        </div>
    `;
    const lang = getCurrentLang();
    setLanguage(lang);

    try {
        // Fetch token info from API
        let tokenData = null;

        // Check if it's a core token
        if (symbol === 'THR') {
            const statsResp = await fetch('/api/network_stats');
            const stats = await statsResp.json();
            const holdersResp = await fetch('/api/tokens/THR/holders');
            const holdersData = await holdersResp.json();

            tokenData = {
                symbol: 'THR',
                name: 'Thronos',
                description: 'The native token of the Thronos blockchain network. Used for transactions, fees, pledging, and governance.',
                color: '#ff6600',
                logo: '/static/img/thronos-token.png',
                total_supply: stats.total_supply || 0,
                max_supply: 21000000,
                holders_count: holdersData.holders_count || 0,
                decimals: 6,
                transferable: true,
                burnable: true,
                mintable: false,
                chain: 'Thronos',
                type: 'native'
            };
        } else if (symbol === 'WBTC') {
            const holdersResp = await fetch('/api/tokens/WBTC/holders');
            const holdersData = await holdersResp.json();

            tokenData = {
                symbol: 'WBTC',
                name: 'Wrapped Bitcoin',
                description: 'Bitcoin bridged to the Thronos network. 1 WBTC = 0.0001 BTC equivalent.',
                color: '#f7931a',
                logo: '/static/img/wbtc-logo.png',
                total_supply: holdersData.total_supply || 0,
                max_supply: 21000000,
                holders_count: holdersData.holders_count || 0,
                decimals: 8,
                transferable: true,
                burnable: false,
                mintable: true,
                chain: 'Thronos',
                type: 'wrapped'
            };
        } else if (symbol === 'L2E') {
            const holdersResp = await fetch('/api/tokens/L2E/holders');
            const holdersData = await holdersResp.json();

            tokenData = {
                symbol: 'L2E',
                name: 'Learn-to-Earn',
                description: 'Reward token for educational achievements and learning milestones on the Thronos platform.',
                color: '#00bfff',
                logo: '/static/img/l2e-logo.png',
                total_supply: holdersData.total_supply || 0,
                max_supply: 100000000,
                holders_count: holdersData.holders_count || 0,
                decimals: 6,
                transferable: true,
                burnable: true,
                mintable: true,
                chain: 'Thronos',
                type: 'utility'
            };
        } else {
            // Custom token - fetch from API
            const response = await fetch(`/api/tokens/list`);
            const data = await response.json();
            if (data.ok && data.tokens) {
                tokenData = data.tokens.find(t => t.symbol === symbol);
            }

            // Get holders count
            if (tokenData) {
                try {
                    const holdersResp = await fetch(`/api/tokens/${symbol}/holders`);
                    const holdersData = await holdersResp.json();
                    if (holdersData.ok) {
                        tokenData.holders_count = holdersData.holders_count;
                    }
                } catch(e) {}
            }
        }

        if (!tokenData) {
            body.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #ff6666;">
                    <div style="font-size: 40px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <span class="lang-el">Token Œ¥ŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ</span>
                    <span class="lang-en">Token not found</span>
                </div>
            `;
            setLanguage(lang);
            return;
        }

        renderTokenInfo(tokenData);

    } catch (error) {
        console.error('Token info error:', error);
        body.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #ff6666;">
                <div style="font-size: 40px; margin-bottom: 15px;">‚ùå</div>
                <span class="lang-el">Œ£œÜŒ¨ŒªŒºŒ± œÜœåœÅœÑœâœÉŒ∑œÇ</span>
                <span class="lang-en">Failed to load token info</span>
            </div>
        `;
        setLanguage(lang);
    }
}

function renderTokenInfo(token) {
    const body = document.getElementById('tokenInfoBody');
    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    const logoUrl = repairMediaUrl(token.logo);
    const logoHtml = logoUrl
        ? `<img src="${logoUrl}" alt="${token.symbol}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <span style="display:none; color:${token.color}; font-weight:bold; font-size:24px;">${token.symbol[0]}</span>`
        : `<span style="color:${token.color}; font-weight:bold; font-size:24px;">${token.symbol[0]}</span>`;

    // Labels
    const labels = {
        totalSupply: isGreek ? 'Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ Œ†œÅŒøœÉœÜŒøœÅŒ¨' : 'Total Supply',
        maxSupply: isGreek ? 'ŒúŒ≠Œ≥ŒπœÉœÑŒ∑ Œ†œÅŒøœÉœÜŒøœÅŒ¨' : 'Max Supply',
        holders: isGreek ? 'ŒöŒ¨œÑŒøœáŒøŒπ' : 'Holders',
        decimals: isGreek ? 'ŒîŒµŒ∫Œ±Œ¥ŒπŒ∫Œ¨' : 'Decimals',
        chain: isGreek ? 'ŒîŒØŒ∫œÑœÖŒø' : 'Chain',
        type: isGreek ? 'Œ§œçœÄŒøœÇ' : 'Type',
        send: isGreek ? 'ŒëœÄŒøœÉœÑŒøŒªŒÆ' : 'Send',
        viewHolders: isGreek ? 'ŒöŒ¨œÑŒøœáŒøŒπ' : 'Holders',
        explorer: isGreek ? 'ŒïŒæŒµœÅŒµœçŒΩŒ∑œÉŒ∑' : 'Explorer',
        createdBy: isGreek ? 'ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒÆŒ∏Œ∑Œ∫Œµ Œ±œÄœå' : 'Created by',
        transferable: isGreek ? 'ŒúŒµœÑŒ±Œ≤ŒπŒ≤Œ¨œÉŒπŒºŒø' : 'Transferable',
        notTransferable: isGreek ? 'ŒúŒ∑ ŒúŒµœÑŒ±Œ≤ŒπŒ≤Œ¨œÉŒπŒºŒø' : 'Not Transferable',
        burnable: isGreek ? 'ŒöŒ±œçœÉŒπŒºŒø' : 'Burnable',
        mintable: isGreek ? 'ŒïŒ∫Œ¥œåœÉŒπŒºŒø' : 'Mintable'
    };

    // Badges
    let badgesHtml = '';
    if (token.transferable !== false) {
        badgesHtml += `<span class="token-info-badge transferable">‚úì ${labels.transferable}</span>`;
    } else {
        badgesHtml += `<span class="token-info-badge not-transferable">‚úï ${labels.notTransferable}</span>`;
    }
    if (token.burnable) {
        badgesHtml += `<span class="token-info-badge burnable">üî• ${labels.burnable}</span>`;
    }
    if (token.mintable) {
        badgesHtml += `<span class="token-info-badge mintable">‚ú® ${labels.mintable}</span>`;
    }

    // Format supplies
    const formatSupply = (num) => {
        if (!num) return '‚àû';
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
        return Number(num).toLocaleString();
    };

    // Send button - disabled if not transferable
    const canSend = token.transferable !== false;
    const sendBtnClass = canSend ? 'token-info-btn token-info-btn-send' : 'token-info-btn token-info-btn-send disabled';
    const sendOnClick = canSend ? `closeTokenInfoModal(); setTimeout(() => { openSendModal(); document.getElementById('sendToken').value = '${token.symbol}'; updateTokenInfo(); }, 300);` : '';

    body.innerHTML = `
        <div class="token-info-header">
            <div class="token-info-logo" style="border-color: ${token.color}; background: linear-gradient(135deg, ${token.color}22 0%, ${token.color}11 100%);">
                ${logoHtml}
            </div>
            <div class="token-info-title">
                <div class="token-info-name">${escapeHtml(token.name)}</div>
                <div class="token-info-symbol">${escapeHtml(token.symbol)} ‚Ä¢ ${token.chain || 'Thronos'}</div>
            </div>
        </div>

        <div class="token-info-properties">
            ${badgesHtml}
        </div>

        ${token.description ? `<div class="token-info-description">${escapeHtml(token.description)}</div>` : ''}

        <div class="token-info-grid">
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.totalSupply}</div>
                <div class="token-info-stat-value">${formatSupply(token.total_supply || token.current_supply)}</div>
            </div>
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.maxSupply}</div>
                <div class="token-info-stat-value">${token.max_supply ? formatSupply(token.max_supply) : '‚àû'}</div>
            </div>
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.holders}</div>
                <div class="token-info-stat-value">${token.holders_count !== undefined ? token.holders_count.toLocaleString() : '-'} üë•</div>
            </div>
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.decimals}</div>
                <div class="token-info-stat-value">${token.decimals !== undefined ? token.decimals : 6}</div>
            </div>
        </div>

        <div class="token-info-actions">
            <button class="${sendBtnClass}" onclick="${sendOnClick}" ${canSend ? '' : 'disabled'}>
                üí∏ ${labels.send}
            </button>
            <a href="/viewer?token=${token.symbol}" class="token-info-btn token-info-btn-secondary">
                üìä ${labels.explorer}
            </a>
        </div>

        ${token.creator ? `
        <div class="token-info-creator">
            ${labels.createdBy}: <a href="/viewer?address=${token.creator}">${token.creator.slice(0, 10)}...${token.creator.slice(-6)}</a>
        </div>
        ` : ''}
    `;

    setLanguage(lang);
}

function closeTokenInfoModal(event) {
    if (!event || event.target.id === 'tokenInfoModal') {
        document.getElementById('tokenInfoModal').classList.remove('active');
    }
}
</script>

<div class="page-footer-spacer"></div>
<!-- Chain Tokens Widget (Footer) -->
<div class="chain-tokens-widget" id="chainTokensWidget">
    <div class="chain-tokens-inner">
        <div class="chain-supply-box">
            <div>
                <div class="chain-supply-label">
                    <span class="lang-el">Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ Œ†œÅŒøŒºŒÆŒ∏ŒµŒπŒ± THR</span>
                    <span class="lang-en">Total THR Supply</span>
                </div>
                <div class="chain-supply-amount" id="chainTotalSupply">Loading...</div>
            </div>
        </div>
        <div class="chain-tokens-scroll" id="chainTokensScroll">
            <div class="chain-token-pill">
                <span style="color: #56ff9a; font-size: 11px;">
                    <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ tokens...</span>
                    <span class="lang-en">Loading tokens...</span>
                </span>
            </div>
        </div>
    </div>
    <div class="chain-tokens-footer-meta">
        <div class="left">Thronos Network ¬Æ CopyRights 2023‚Äì2026</div>
        <div class="right" id="build-info">build: ‚Äî</div>
    </div>
</div>

<script>

function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, (m) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
}

// Toast notification function
function showToast(message, duration = 2000) {
    // Remove existing toasts
    const existingToast = document.querySelector('.thr-toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'thr-toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
        color: #000;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        z-index: 5000;
        box-shadow: 0 4px 15px rgba(0, 255, 102, 0.4);
        animation: toastFadeIn 0.3s ease-out;
    `;

    // Add animation keyframes if not exists
    if (!document.querySelector('#toast-style')) {
        const style = document.createElement('style');
        style.id = 'toast-style';
        style.textContent = '@keyframes toastFadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } } @keyframes toastFadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(-50%) translateY(-10px); } }';
        document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        const lang = getCurrentLang();
        const isGreek = isGreekLang(lang);
        showToast(isGreek ? 'ŒëŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ' : 'Copied');
    } catch (e) {
        console.warn('Clipboard failed', e);
    }
}

function downloadCGMinerKit() {
    const meta = document.querySelector('meta[name="cgminer-kit-url"]');
    const url = (meta && meta.content ? meta.content.trim() : '') || '/static/cgminer_kit.zip';
    window.open(url, '_blank', 'noopener');
}


// Chain Tokens Widget - Load all tokens on chain with holders count
(function() {
    async function loadChainTokensWidget() {
        try {
            // Fetch total supply
            const statsResp = await fetch('/api/network_stats');
            const stats = await statsResp.json();
            const supplyEl = document.getElementById('chainTotalSupply');
            if (supplyEl && stats.total_supply !== undefined) {
                supplyEl.textContent = Number(stats.total_supply).toLocaleString('en-US', {maximumFractionDigits: 2}) + ' THR';
            }

            // Fetch all tokens with stats (including holders count)
            let tokensWithStats = [];
            try {
                const tokensStatsResp = await fetch('/api/tokens/stats');
                const tokensStatsData = await tokensStatsResp.json();
                if (tokensStatsData.ok && tokensStatsData.tokens) {
                    tokensWithStats = tokensStatsData.tokens;
                }
            } catch(e) {
                console.log('Tokens stats API not available, using fallback');
                // Fallback to basic token list
                tokensWithStats = [
                    { symbol: 'THR', name: 'Thronos', color: '#ff6600', holders_count: 0 },
                    { symbol: 'WBTC', name: 'Wrapped Bitcoin', color: '#f7931a', holders_count: 0 },
                    { symbol: 'L2E', name: 'Learn-to-Earn', color: '#00bfff', holders_count: 0 }
                ];
            }

            // Render tokens
            const scrollEl = document.getElementById('chainTokensScroll');
            if (!scrollEl) return;

            let html = '';
            tokensWithStats.forEach(token => {
                const logoSrc = repairMediaUrl(token.logo) || (token.symbol === 'THR' ? '/static/img/thronos-token.png' : null);
                const logoHtml = logoSrc
                    ? `<img src="${logoSrc}" alt="${token.symbol}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'color:${token.color}\\'>${token.symbol[0]}</span>';">`
                    : `<span style="color: ${token.color};">${token.symbol[0]}</span>`;

                const holdersText = token.holders_count !== undefined
                    ? `${token.holders_count} üë•`
                    : '';

                const supplyText = token.total_supply
                    ? Number(token.total_supply).toLocaleString('en-US', {maximumFractionDigits: 0})
                    : '';

                // Show name if different from symbol, otherwise just symbol
                const displayName = token.name && token.name !== token.symbol
                    ? token.name
                    : token.symbol;

                html += `
                    <div class="chain-token-pill" title="${token.name || token.symbol} (${token.symbol}) - ${holdersText || '0'} holders" onclick="openTokenInfoModal('${token.symbol}')" style="cursor: pointer;">
                        <div class="chain-token-logo" style="border-color: ${token.color};">${logoHtml}</div>
                        <span class="chain-token-symbol">${token.symbol}</span>
                        ${holdersText ? `<span class="chain-token-holders">${holdersText}</span>` : ''}
                        ${supplyText ? `<span class="chain-token-supply">${supplyText}</span>` : ''}
                    </div>
                `;
            });
            scrollEl.innerHTML = html;

        } catch(err) {
            console.error('Chain tokens widget error:', err);
        }
    }

    // Load on DOM ready
    document.addEventListener('DOMContentLoaded', loadChainTokensWidget);

    // Refresh every 60 seconds
    if (chainTokensInterval) {
        clearInterval(chainTokensInterval);
    }
    chainTokensInterval = setInterval(loadChainTokensWidget, 60000);
})();

</script>

<script>
(function(){
  async function hydrateBuild(){
    try{
      const out = document.getElementById("build-info");
      if(!out) return;
      const r = await fetch("/api/health", {cache:"no-store"});
      const j = await r.json();
      let build = j.build_id || j.git_commit || null;
      if (!build && j.build) {
        if (typeof j.build === "string") {
          build = j.build;
        } else if (typeof j.build === "object") {
          build = j.build.build_id || j.build.git_commit || null;
        }
      }
      out.textContent = "build: " + (build || "‚Äî");
    }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    hydrateBuild();
  });
})();
</script>

<script src="{{ url_for('static', filename='fetch_utils.js') }}?v={{ build_id }}"></script>
<script src="https://thrchain.vercel.app/static/wallet_sdk.js?v={{ build_id }}"></script>
<script src="https://thrchain.vercel.app/static/wallet_auth.js"></script>
<script src="{{ asset_cdn_base|default('https://thrchain.vercel.app') }}/static/music_module.js?v={{ build_id }}"></script>

<script>
// PR-5a: Init guard to prevent double initialization
window.__walletWidgetInit = window.__walletWidgetInit || false;

// PR-5a: Verify MusicModule loaded
if (typeof MusicModule === 'undefined') {
    console.warn('[Wallet Widget] MusicModule not loaded - check script path/caching');
}
</script>

{% block scripts %}{% endblock %}

<!-- PR-5e: Background Music Player -->
<div id="globalMusicPlayer" class="global-music-player" style="display: none;">
    <audio id="globalAudioElement"></audio>
    <div class="global-player-bar">
        <div class="global-player-track-info">
            <div class="global-player-cover" id="globalPlayerCover">üéµ</div>
            <div class="global-player-text">
                <div class="global-player-title" id="globalPlayerTitle">-</div>
                <div class="global-player-artist" id="globalPlayerArtist">-</div>
            </div>
        </div>
        <div class="global-player-controls">
            <button class="global-player-btn" onclick="GlobalMusicPlayer.previous()" title="Previous">‚èÆÔ∏è</button>
            <button class="global-player-btn global-player-btn-play" onclick="GlobalMusicPlayer.togglePlay()" id="globalPlayPauseBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
            <button class="global-player-btn" onclick="GlobalMusicPlayer.next()" title="Next">‚è≠Ô∏è</button>
        </div>
        <div class="global-player-extra">
            <button class="global-player-btn" onclick="GlobalMusicPlayer.toggleShuffle()" id="globalShuffleBtn" title="Shuffle">üîÄ</button>
            <button class="global-player-btn" onclick="GlobalMusicPlayer.toggleRepeat()" id="globalRepeatBtn" title="Repeat">üîÅ</button>
            <button class="global-player-btn" onclick="GlobalMusicPlayer.toggleQueue()" title="Queue">üìã</button>
            <button class="global-player-btn" onclick="openGlobalTipModal()" title="Tip Artist">üí∏</button>
            <button class="global-player-btn" onclick="GlobalMusicPlayer.close()" title="Close">‚úñ</button>
        </div>
    </div>
    <div class="global-player-progress-bar" onclick="GlobalMusicPlayer.seekTo(event)">
        <div class="global-player-progress-fill" id="globalProgressFill"></div>
    </div>
    <div class="global-player-queue" id="globalPlayerQueue" style="display: none;">
        <div class="global-player-queue-header">
            <span class="lang-el">ŒüœÖœÅŒ¨ ŒëŒΩŒ±œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆœÇ</span><span class="lang-en">Play Queue</span>
            <span id="globalQueueCount">(0)</span>
        </div>
        <div class="global-player-queue-list" id="globalQueueList"></div>
    </div>
</div>

<div id="globalTipModal" class="global-tip-modal" style="display:none;">
  <div class="global-tip-panel">
    <h4>üí∏ Tip current artist</h4>
    <div id="globalTipTrackMeta" class="global-tip-track">-</div>
    <label>Asset</label>
    <select id="globalTipAsset"></select>
    <label>Amount</label>
    <input id="globalTipAmount" type="number" min="0" step="0.000001" placeholder="1.0" />
    <div id="globalTipHint" class="global-tip-hint"></div>
    <div class="global-tip-actions">
      <button class="global-player-btn" type="button" onclick="submitGlobalTip()">Send Tip</button>
      <button class="global-player-btn" type="button" onclick="closeGlobalTipModal()">Cancel</button>
    </div>
  </div>
</div>

<style>
.global-music-player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.98) 0%, rgba(40, 20, 10, 0.98) 100%);
    border-top: 2px solid #ff6600;
    box-shadow: 0 -4px 20px rgba(255, 102, 0, 0.3);
    z-index: 10000;
    font-family: "Courier New", monospace;
}

.global-tip-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.72);
    z-index: 10002;
    display: flex;
    align-items: center;
    justify-content: center;
}

.global-tip-panel {
    width: min(460px, 92vw);
    border: 1px solid #ff6600;
    border-radius: 12px;
    background: #120b07;
    padding: 14px;
    color: #ffcc99;
}

.global-tip-panel h4 { margin: 0 0 8px 0; color: #ffd277; }
.global-tip-panel label { display:block; margin-top:8px; margin-bottom:4px; font-size:12px; color:#56ff9a; }
.global-tip-panel input, .global-tip-panel select { width:100%; background:#1a120d; color:#ffd8b0; border:1px solid #704020; border-radius:8px; padding:8px; }
.global-tip-track { font-size:12px; color:#ff9966; margin-bottom:6px; }
.global-tip-hint { margin-top:8px; font-size:12px; color:#8de8b2; min-height:16px; }
.global-tip-actions { margin-top:10px; display:flex; gap:8px; justify-content:flex-end; }

.global-player-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    flex-wrap: wrap;
}

.global-player-track-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 200px;
}

.global-player-cover {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    background: linear-gradient(135deg, #ff6600 0%, #00ff66 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    overflow: hidden;
}

.global-player-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.global-player-text {
    flex: 1;
    min-width: 0;
}

.global-player-title {
    color: #ff6600;
    font-weight: bold;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.global-player-artist {
    color: #56ff9a;
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.global-player-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.global-player-extra {
    display: flex;
    align-items: center;
    gap: 8px;
}

.global-player-btn {
    background: rgba(255, 102, 0, 0.1);
    border: 1px solid #ff6600;
    color: #ff6600;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
    font-family: "Courier New", monospace;
}

.global-player-btn:hover {
    background: rgba(255, 102, 0, 0.3);
    transform: scale(1.05);
}

.global-player-btn-play {
    font-size: 20px;
    padding: 10px 16px;
}

.global-player-btn.active {
    background: rgba(255, 102, 0, 0.4);
    border-color: #00ff66;
    color: #00ff66;
}

.global-player-progress-bar {
    height: 4px;
    background: rgba(255, 102, 0, 0.2);
    cursor: pointer;
    position: relative;
}

.global-player-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff6600 0%, #00ff66 100%);
    width: 0%;
    transition: width 0.1s;
}

.global-player-queue {
    border-top: 1px solid #3a2a1e;
    max-height: 300px;
    overflow-y: auto;
}

.global-player-queue-header {
    padding: 12px 20px;
    background: rgba(255, 102, 0, 0.1);
    color: #ff6600;
    font-weight: bold;
    font-size: 14px;
    border-bottom: 1px solid #3a2a1e;
}

.global-player-queue-list {
    padding: 8px;
}

.global-queue-item {
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #3a2a1e;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.global-queue-item:hover {
    border-color: #ff6600;
    background: rgba(255, 102, 0, 0.1);
}

.global-queue-item.active {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.1);
}

.global-queue-item-title {
    color: #56ff9a;
    font-size: 13px;
    flex: 1;
}

.global-queue-item-artist {
    color: #888;
    font-size: 11px;
}

.global-queue-item-remove {
    background: none;
    border: none;
    color: #f00;
    cursor: pointer;
    font-size: 14px;
    padding: 4px 8px;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .global-player-bar {
        padding: 8px 12px;
        gap: 8px;
    }

    .global-player-extra {
        flex-wrap: wrap;
    }

    .global-player-btn {
        padding: 6px 10px;
        font-size: 14px;
    }
}
</style>

<script>
// PR-5e: Global Background Music Player
window.GlobalMusicPlayer = (function() {
    'use strict';

    let audio = null;
    let queue = [];
    let currentIndex = -1;
    let shuffle = false;
    let repeat = 'none'; // 'none', 'one', 'all'
    let isPlaying = false;

    function init() {
        audio = document.getElementById('globalAudioElement');
        if (!audio) {
            console.error('[GlobalMusicPlayer] Audio element not found');
            return;
        }

        // Event listeners
        audio.addEventListener('timeupdate', updateProgress);
        audio.addEventListener('ended', handleTrackEnd);
        audio.addEventListener('loadedmetadata', () => {
            console.log('[GlobalMusicPlayer] Track loaded:', queue[currentIndex]?.title);
        });
        audio.addEventListener('error', (e) => {
            console.error('[GlobalMusicPlayer] Audio error:', e);
        });

        // Try to restore queue from sessionStorage
        restoreState();

        console.log('[GlobalMusicPlayer] Initialized');
    }

    function saveState() {
        try {
            sessionStorage.setItem('gmp_queue', JSON.stringify(queue));
            sessionStorage.setItem('gmp_index', currentIndex);
            sessionStorage.setItem('gmp_shuffle', shuffle);
            sessionStorage.setItem('gmp_repeat', repeat);
            sessionStorage.setItem('gmp_position', audio ? audio.currentTime : 0);
            sessionStorage.setItem('gmp_playing', isPlaying);
        } catch (e) {
            console.error('[GlobalMusicPlayer] Failed to save state:', e);
        }
    }

    function restoreState() {
        try {
            const savedQueue = sessionStorage.getItem('gmp_queue');
            const savedIndex = sessionStorage.getItem('gmp_index');
            const savedShuffle = sessionStorage.getItem('gmp_shuffle');
            const savedRepeat = sessionStorage.getItem('gmp_repeat');
            const savedPosition = sessionStorage.getItem('gmp_position');
            const savedPlaying = sessionStorage.getItem('gmp_playing');

            if (savedQueue) queue = JSON.parse(savedQueue);
            if (savedIndex) currentIndex = parseInt(savedIndex);
            if (savedShuffle) shuffle = savedShuffle === 'true';
            if (savedRepeat) repeat = savedRepeat;

            // Restore playback position if there's a valid queue
            if (queue.length > 0 && currentIndex >= 0 && currentIndex < queue.length) {
                const track = queue[currentIndex];
                audio.src = track.audio_url;

                // CRITICAL FIX: Wait for metadata before setting position
                audio.addEventListener('loadedmetadata', function onMetadataLoaded() {
                    // Restore position
                    if (savedPosition) {
                        const position = parseFloat(savedPosition);
                        audio.currentTime = position;
                        console.log(`[GlobalMusicPlayer] Restored position: ${position}s`);
                    }

                    // Auto-resume if was playing
                    if (savedPlaying === 'true') {
                        audio.play().then(() => {
                            isPlaying = true;
                            updateUI();
                            show();
                            updateMediaSession(track);
                            startPositionSaving();
                            console.log('[GlobalMusicPlayer] Auto-resumed playback');
                        }).catch(e => {
                            console.log('[GlobalMusicPlayer] Auto-resume blocked (user interaction required)');
                            isPlaying = false;
                            updateUI();
                            show(); // Still show player, just paused
                        });
                    } else {
                        updateUI();
                        show(); // Show player in paused state
                    }

                    // Remove listener after first load
                    audio.removeEventListener('loadedmetadata', onMetadataLoaded);
                }, { once: true });

                // Start loading the track
                audio.load();

            } else {
                updateUI();
            }
        } catch (e) {
            console.error('[GlobalMusicPlayer] Failed to restore state:', e);
        }
    }

    // Save position periodically (only when actually playing)
    let positionSaveInterval = null;

    function startPositionSaving() {
        if (positionSaveInterval) return; // Already running
        positionSaveInterval = setInterval(() => {
            if (audio && !audio.paused && isPlaying) {
                sessionStorage.setItem('gmp_position', audio.currentTime);
            }
        }, 10000); // Every 10 seconds (reduced frequency)
    }

    function stopPositionSaving() {
        if (positionSaveInterval) {
            clearInterval(positionSaveInterval);
            positionSaveInterval = null;
        }
    }

    function playTrack(track) {
        if (!track || !track.audio_url) {
            console.error('[GlobalMusicPlayer] Invalid track:', track);
            return;
        }

        queue = [track];
        currentIndex = 0;
        loadAndPlay();
    }

    function playQueue(tracks, startIndex = 0) {
        if (!tracks || tracks.length === 0) {
            console.error('[GlobalMusicPlayer] No tracks to play');
            return;
        }

        queue = tracks;
        currentIndex = startIndex;
        loadAndPlay();
    }

    function addToQueue(track) {
        if (!track || !track.audio_url) {
            console.error('[GlobalMusicPlayer] Invalid track');
            return;
        }

        queue.push(track);
        saveState();
        updateQueueUI();

        // If nothing playing, start
        if (currentIndex === -1) {
            currentIndex = queue.length - 1;
            loadAndPlay();
        }
    }

    function loadAndPlay() {
        if (currentIndex < 0 || currentIndex >= queue.length) {
            console.error('[GlobalMusicPlayer] Invalid index:', currentIndex);
            return;
        }

        const track = queue[currentIndex];
        audio.src = track.audio_url;
        audio.play().then(() => {
            isPlaying = true;
            updateUI();
            show();

            // PR-5f: Update MediaSession API for CarPlay/Android Auto support
            updateMediaSession(track);

            // PR-5g: Start periodic position saving
            startPositionSaving();

            // Record play
            const wallet = localStorage.getItem('thr_address');
            if (track.id) {
                fetch(`/api/music/play/${track.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ listener_address: wallet || '' })
                }).catch(e => console.error('[GlobalMusicPlayer] Failed to record play:', e));
            }
        }).catch(e => {
            console.error('[GlobalMusicPlayer] Play failed:', e);
            isPlaying = false;
            updateUI();
        });

        saveState();
    }

    // PR-5f: MediaSession API for CarPlay/Android Auto/Background playback
    function updateMediaSession(track) {
        if (!('mediaSession' in navigator)) {
            return; // MediaSession API not supported
        }

        try {
            const coverUrl = track.cover_path
                ? `${window.location.origin}/media/${track.cover_path}`
                : track.cover_url;

            navigator.mediaSession.metadata = new MediaMetadata({
                title: track.title || 'Unknown Track',
                artist: track.artist_name || track.artist || 'Unknown Artist',
                album: track.album || 'Thronos Music',
                artwork: coverUrl ? [
                    { src: coverUrl, sizes: '96x96', type: 'image/png' },
                    { src: coverUrl, sizes: '128x128', type: 'image/png' },
                    { src: coverUrl, sizes: '192x192', type: 'image/png' },
                    { src: coverUrl, sizes: '256x256', type: 'image/png' },
                    { src: coverUrl, sizes: '384x384', type: 'image/png' },
                    { src: coverUrl, sizes: '512x512', type: 'image/png' }
                ] : []
            });

            // Set up action handlers for CarPlay/Android Auto
            navigator.mediaSession.setActionHandler('play', () => {
                audio.play();
                isPlaying = true;
                updateUI();
            });

            navigator.mediaSession.setActionHandler('pause', () => {
                audio.pause();
                isPlaying = false;
                updateUI();
            });

            navigator.mediaSession.setActionHandler('previoustrack', () => {
                previous();
            });

            navigator.mediaSession.setActionHandler('nexttrack', () => {
                next();
            });

            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                audio.currentTime = Math.max(0, audio.currentTime - (details.seekOffset || 10));
            });

            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                audio.currentTime = Math.min(audio.duration, audio.currentTime + (details.seekOffset || 10));
            });

            navigator.mediaSession.setActionHandler('seekto', (details) => {
                if (details.seekTime !== null) {
                    audio.currentTime = details.seekTime;
                }
            });

            // Update playback state
            navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';

            console.log('[GlobalMusicPlayer] MediaSession updated for CarPlay/Android Auto');
        } catch (e) {
            console.error('[GlobalMusicPlayer] MediaSession error:', e);
        }
    }

    function togglePlay() {
        if (!audio || currentIndex === -1) return;

        if (audio.paused) {
            audio.play().then(() => {
                isPlaying = true;
                updateUI();
                startPositionSaving(); // Resume position saving
                // PR-5f: Update MediaSession state
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'playing';
                }
            });
        } else {
            audio.pause();
            isPlaying = false;
            stopPositionSaving(); // Stop position saving when paused
            updateUI();
            saveState(); // Save final state on pause
            // PR-5f: Update MediaSession state
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'paused';
            }
        }
    }

    function next() {
        if (queue.length === 0) return;

        if (shuffle) {
            currentIndex = Math.floor(Math.random() * queue.length);
        } else {
            currentIndex++;
            if (currentIndex >= queue.length) {
                if (repeat === 'all') {
                    currentIndex = 0;
                } else {
                    currentIndex = queue.length - 1;
                    audio.pause();
                    isPlaying = false;
                    updateUI();
                    return;
                }
            }
        }

        loadAndPlay();
    }

    function previous() {
        if (queue.length === 0) return;

        // If track has played > 3 seconds, restart it
        if (audio.currentTime > 3) {
            audio.currentTime = 0;
            return;
        }

        currentIndex--;
        if (currentIndex < 0) {
            currentIndex = repeat === 'all' ? queue.length - 1 : 0;
        }

        loadAndPlay();
    }

    function handleTrackEnd() {
        if (repeat === 'one') {
            audio.currentTime = 0;
            audio.play();
        } else {
            next();
        }
    }

    function toggleShuffle() {
        shuffle = !shuffle;
        updateUI();
        saveState();
    }

    function toggleRepeat() {
        const modes = ['none', 'one', 'all'];
        const currentIdx = modes.indexOf(repeat);
        repeat = modes[(currentIdx + 1) % modes.length];
        updateUI();
        saveState();
    }

    function toggleQueue() {
        const queueEl = document.getElementById('globalPlayerQueue');
        if (queueEl) {
            queueEl.style.display = queueEl.style.display === 'none' ? 'block' : 'none';
            if (queueEl.style.display === 'block') {
                updateQueueUI();
            }
        }
    }

    function updateProgress() {
        if (!audio || !audio.duration) return;
        const progress = (audio.currentTime / audio.duration) * 100;
        const fillEl = document.getElementById('globalProgressFill');
        if (fillEl) fillEl.style.width = progress + '%';
    }

    function seekTo(e) {
        if (!audio || !audio.duration) return;
        const bar = e.currentTarget;
        const rect = bar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        audio.currentTime = percent * audio.duration;
    }

    function updateUI() {
        const playerEl = document.getElementById('globalMusicPlayer');
        const playBtn = document.getElementById('globalPlayPauseBtn');
        const shuffleBtn = document.getElementById('globalShuffleBtn');
        const repeatBtn = document.getElementById('globalRepeatBtn');
        const titleEl = document.getElementById('globalPlayerTitle');
        const artistEl = document.getElementById('globalPlayerArtist');
        const coverEl = document.getElementById('globalPlayerCover');

        if (currentIndex >= 0 && currentIndex < queue.length) {
            const track = queue[currentIndex];

            if (titleEl) titleEl.textContent = track.title || 'Unknown';
            if (artistEl) artistEl.textContent = track.artist_name || track.artist || 'Unknown Artist';

            if (coverEl) {
                const coverSrc = track.cover_path ? `/media/${track.cover_path}` : track.cover_url;
                coverEl.innerHTML = coverSrc
                    ? `<img src="${coverSrc}" onerror="this.parentElement.innerHTML='üéµ'">`
                    : 'üéµ';
            }
        }

        if (playBtn) {
            playBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        }

        if (shuffleBtn) {
            shuffleBtn.classList.toggle('active', shuffle);
        }

        if (repeatBtn) {
            repeatBtn.classList.toggle('active', repeat !== 'none');
            repeatBtn.textContent = repeat === 'one' ? 'üîÇ' : 'üîÅ';
        }

        updateQueueUI();
    }

    function updateQueueUI() {
        const queueListEl = document.getElementById('globalQueueList');
        const queueCountEl = document.getElementById('globalQueueCount');

        if (queueCountEl) {
            queueCountEl.textContent = `(${queue.length})`;
        }

        if (!queueListEl) return;

        queueListEl.innerHTML = queue.map((track, idx) => `
            <div class="global-queue-item ${idx === currentIndex ? 'active' : ''}" onclick="GlobalMusicPlayer.playQueueIndex(${idx})">
                <div>
                    <div class="global-queue-item-title">${track.title || 'Unknown'}</div>
                    <div class="global-queue-item-artist">${track.artist_name || track.artist || 'Unknown Artist'}</div>
                </div>
                <button class="global-queue-item-remove" onclick="event.stopPropagation(); GlobalMusicPlayer.removeFromQueue(${idx})">‚úñ</button>
            </div>
        `).join('');
    }

    function playQueueIndex(idx) {
        if (idx >= 0 && idx < queue.length) {
            currentIndex = idx;
            loadAndPlay();
        }
    }

    function removeFromQueue(idx) {
        if (idx < 0 || idx >= queue.length) return;

        queue.splice(idx, 1);

        if (idx === currentIndex) {
            if (queue.length === 0) {
                close();
            } else {
                currentIndex = Math.min(currentIndex, queue.length - 1);
                loadAndPlay();
            }
        } else if (idx < currentIndex) {
            currentIndex--;
        }

        saveState();
        updateQueueUI();
    }

    function show() {
        const playerEl = document.getElementById('globalMusicPlayer');
        if (playerEl) {
            playerEl.style.display = 'block';
        }
    }

    function close() {
        const playerEl = document.getElementById('globalMusicPlayer');
        _globalTipAuth = null;
        if (playerEl) {
            playerEl.style.display = 'none';
        }

        if (audio) {
            audio.pause();
            audio.src = '';
        }

        queue = [];
        currentIndex = -1;
        isPlaying = false;

        saveState();
    }

    // Initialize on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    return {
        playTrack,
        playQueue,
        addToQueue,
        togglePlay,
        next,
        previous,
        toggleShuffle,
        toggleRepeat,
        toggleQueue,
        seekTo,
        playQueueIndex,
        removeFromQueue,
        show,
        close,
        stopPositionSaving,
        getCurrentTrack: () => queue[currentIndex],
        getQueue: () => queue,
        isPlaying: () => isPlaying
    };
})();
</script>


<script>
let _globalTipAssets = [];
let _globalTipAuth = null;
let _globalTipTrack = null;  // Stores the track being tipped (from GlobalPlayer OR music page)

/**
 * Open the global tip modal.
 * @param {Object} [trackOverride] - Optional track object passed from music.html or other pages.
 *   If not provided, falls back to GlobalMusicPlayer.getCurrentTrack().
 */
async function openGlobalTipModal(trackOverride) {
    const track = trackOverride || window.GlobalMusicPlayer?.getCurrentTrack?.();
    if (!track) { alert('No active track'); return; }
    _globalTipTrack = track;  // Store for submitGlobalTip()
    try {
        const auth = _globalTipAuth || await window.WalletAuth.requireUnlockedWallet();
        _globalTipAuth = auth;
        const address = auth.address;
        const apiBase = typeof buildWalletMusicApiUrl === 'function'
            ? buildWalletMusicApiUrl('/api/balances')
            : '/api/balances';
        const r = await fetch(`${apiBase}${apiBase.includes('?') ? '&' : '?'}address=${encodeURIComponent(address)}&show_zero=false`);
        const j = await r.json();
        const balances = (j && j.balances) || {};
        const items = Object.entries(balances)
            .map(([symbol, balance]) => ({ symbol, balance: Number(balance || 0) }))
            .filter(x => x.balance > 0);
        _globalTipAssets = items;
        const sel = document.getElementById('globalTipAsset');
        sel.innerHTML = '';
        // Always show THR first, then WBTC, then rest (crosschain-friendly order)
        const sortOrder = ['THR', 'WBTC', 'L2E'];
        items.sort((a, b) => {
            const ai = sortOrder.indexOf(a.symbol);
            const bi = sortOrder.indexOf(b.symbol);
            if (ai !== -1 && bi !== -1) return ai - bi;
            if (ai !== -1) return -1;
            if (bi !== -1) return 1;
            return a.symbol.localeCompare(b.symbol);
        });
        items.forEach((it) => {
            const opt = document.createElement('option');
            opt.value = it.symbol;
            opt.textContent = `${it.symbol} (${it.balance})`;
            sel.appendChild(opt);
        });
        if (!items.length) {
            const opt = document.createElement('option');
            opt.value = 'THR';
            opt.textContent = 'THR (0)';
            sel.appendChild(opt);
        }
        document.getElementById('globalTipTrackMeta').textContent = `${track.title || '-'} ‚Ä¢ ${track.artist_name || track.artist || '-'}`;
        document.getElementById('globalTipAmount').value = '';
        document.getElementById('globalTipHint').textContent = 'Choose asset + amount to tip the artist.';
        document.getElementById('globalTipModal').style.display = 'flex';
    } catch (e) {
        if (e.code === 'WALLET_NOT_CONNECTED') {
            alert('Please connect your wallet first!');
        } else if (e.code === 'WALLET_LOCKED') {
            alert('Wallet is locked. Please unlock with your PIN.');
        } else {
            alert(`Tip unavailable: ${e.message || e}`);
        }
    }
}

function closeGlobalTipModal() {
    const el = document.getElementById('globalTipModal');
    if (el) el.style.display = 'none';
    _globalTipTrack = null;
}

async function submitGlobalTip() {
    const track = _globalTipTrack || window.GlobalMusicPlayer?.getCurrentTrack?.();
    if (!track) { alert('No track selected'); return; }
    const asset = (document.getElementById('globalTipAsset')?.value || 'THR').trim().toUpperCase();
    const amount = parseFloat(document.getElementById('globalTipAmount')?.value || '0');
    if (!amount || amount <= 0) { alert('Invalid amount'); return; }

    const hint = document.getElementById('globalTipHint');
    if (hint) hint.textContent = `Sending ${amount} ${asset}...`;

    try {
        const auth = _globalTipAuth || await window.WalletAuth.requireUnlockedWallet();
        _globalTipAuth = auth;
        const { address, authSecret } = auth;
        const tipUrl = typeof buildWalletMusicApiUrl === 'function'
            ? buildWalletMusicApiUrl('/api/v1/music/tip')
            : '/api/v1/music/tip';
        const res = await fetch(tipUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                track_id: track.id || track.track_id,
                from_address: address,
                amount,
                token_symbol: asset,
                auth_secret: authSecret,
                passphrase: ''
            })
        });
        const data = await res.json();
        if (data.status !== 'success') {
            throw new Error(data.message || data.error || data.primary || 'tip_failed');
        }
        if (hint) hint.textContent = `‚úÖ Sent ${amount} ${asset} tip!`;
        setTimeout(() => closeGlobalTipModal(), 1500);
        if (typeof loadTracks === 'function') loadTracks();
    } catch (e) {
        const msg = (e.message || e || '').toString().toLowerCase();
        // On auth failures, clear cached auth so user can re-authenticate
        if (msg.includes('invalid auth') || msg.includes('missing auth') || msg.includes('not enabled')) {
            _globalTipAuth = null;
            sessionStorage.removeItem('thr_auth_secret');
        }
        if (hint) hint.textContent = `‚ùå ${e.message || e}`;
    }
}
</script>

<script>
window.addEventListener('beforeunload', () => {
    if (musicModuleCheckInterval) {
        clearInterval(musicModuleCheckInterval);
        musicModuleCheckInterval = null;
    }
    if (historyPollInterval) {
        clearInterval(historyPollInterval);
        historyPollInterval = null;
    }
    if (txPollInterval) {
        clearInterval(txPollInterval);
        txPollInterval = null;
    }
    if (tokenPriceInterval) {
        clearInterval(tokenPriceInterval);
        tokenPriceInterval = null;
    }
    if (walletBalanceInterval) {
        clearInterval(walletBalanceInterval);
        walletBalanceInterval = null;
    }
    if (chainTokensInterval) {
        clearInterval(chainTokensInterval);
        chainTokensInterval = null;
    }
    if (typeof GlobalMusicPlayer !== 'undefined' && GlobalMusicPlayer.stopPositionSaving) {
        GlobalMusicPlayer.stopPositionSaving();
    }
});
</script>

<div id="footer-sentinel" style="height:1px;"></div>

</body>
</html>
