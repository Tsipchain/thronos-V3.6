<!DOCTYPE html>
<html>
<head>
  <title>{% block title %}Thronos Network{% endblock %}</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="cgminer-kit-url" content="{{ CGMINER_KIT_URL if CGMINER_KIT_URL is defined else '' }}">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='img/thronos-token.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='img/thronos-token.png') }}">
  <script src="{{ url_for('static', filename='wallet_session.js') }}"></script>
  <style>
    /* Global Styles */
    body {
      background-color: #000;
      color: #0f0;
      font-family: "Courier New", monospace;
      padding: 20px;
      line-height: 1.6;
      margin: 0;
    }
    a {
      color: #0f0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
      background-color: #111;
    }
    h1, h2, h3 {
      color: #0f0;
      border-bottom: 1px solid #0f0;
      padding-bottom: 10px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* Navigation Bar */
    .navbar {
      background: #111;
      border-bottom: 1px solid #0f0;
      padding: 40px 0 0 0;
      margin-bottom: 30px;
      display: flex;
      justify-content: center;
      position: relative;
      flex-wrap: wrap;
      min-height: 82px;
    }
    
    .nav-list {
      list-style: none;
      margin: 0;
      padding: 12px 0 0 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }
    
    .nav-item {
      position: relative;
    }
    
    .nav-link {
      display: block;
      padding: 15px 20px;
      color: #0f0;
      font-weight: bold;
      cursor: pointer;
    }
    
    .nav-link:hover {
      background-color: #222;
      text-decoration: none;
    }
    .thr-logo-icon {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 8px;
      border-radius: 50%;
      box-shadow: 0 0 8px #ff6600;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 8px #ff6600; }
      50% { box-shadow: 0 0 16px #ff9900, 0 0 24px #ff6600; }
    }

    
    /* Dropdown Menu */
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #111;
      min-width: 180px;
      box-shadow: 0px 8px 16px 0px rgba(0,255,0,0.2);
      border: 1px solid #0f0;
      z-index: 3000;
      top: 100%;
      left: 0;
    }
    
    .dropdown-content a {
      color: #0f0;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
    }
    
    .dropdown-content a:hover {
      background-color: #222;
    }
    
    .nav-item:hover .dropdown-content {
      display: block;
    }
    
    /* Top Bar Controls */
    .top-controls {
        position: absolute;
        top: 8px;
        right: 12px;
        display: flex;
        gap: 10px;
        z-index: 1100;
        flex-wrap: wrap;
        max-width: 360px;
        justify-content: flex-end;
    }
    
    /* Wallet Status Indicator */
    .wallet-status {
        background: #002200;
        color: #0f0;
        border: 1px solid #004400;
        padding: 5px 10px;
        font-size: 0.8em;
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 6px;
        position: relative;
    }
    .wallet-status:hover {
        background: #004400;
    }
    .wallet-status.open .wallet-balance-popup {
        display: block;
    }
    .wallet-fire-icon {
        width: 16px;
        height: 16px;
        vertical-align: middle;
        filter: drop-shadow(0 0 4px #ff6600);
    }

    /* Wallet Balance Popup Widget */
    .wallet-balance-popup {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
        border: 2px solid;
        border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
        border-radius: 12px;
        padding: 15px;
        min-width: 300px;
        max-width: 360px;
        box-shadow: 0 0 30px rgba(0, 255, 102, 0.3), 0 0 15px rgba(255, 215, 0, 0.2);
        z-index: 2500;
        color: #e6ffe5;
        backdrop-filter: blur(10px);
    }

    /* Chain Tokens Widget (Footer) ‚Äî AUTO-HIDE FIXED FOOTER */
    .chain-tokens-widget{
        position: relative;
        width: 100%;
        background: linear-gradient(180deg, transparent 0%, rgba(0, 20, 10, 0.92) 20%, rgba(0, 30, 15, 0.98) 100%);
        border-top: 2px solid;
        border-image: linear-gradient(90deg, transparent, #00ff66, #ffd700, #00ff66, transparent) 1;
        backdrop-filter: blur(10px);
        padding: 10px 20px;
    }

    .chain-tokens-footer-meta{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 16px;
        margin-top: 8px;
        font-size: 12px;
        opacity: 0.9;
    }
    .chain-tokens-footer-meta .right{
        text-align:right;
        white-space: nowrap;
    }

    .page-footer-spacer { height: 15vh; min-height: 120px; }

    /* Wallet Login Modal */
    .wallet-login-btn {
        background: linear-gradient(135deg, #00ff66 0%, #ffd700 100%);
        color: #000;
        border: 1px solid #00ff66;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 10px;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0,255,102,0.35);
    }
    .wallet-login-btn:hover {
        box-shadow: 0 0 16px rgba(0,255,102,0.55);
    }
    .wallet-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        pointer-events: none;
    }
    .wallet-modal-overlay.active { display: flex; pointer-events: auto; }
    .wallet-modal {
        background: #0a130e;
        border: 1px solid #0f0;
        border-radius: 12px;
        padding: 20px;
        width: 340px;
        box-shadow: 0 0 20px rgba(0, 255, 102, 0.25);
    }
    .wallet-modal h3 { margin-top: 0; }
    .wallet-modal label { display: block; margin-top: 10px; font-size: 0.9em; color: #9f9; }
    .wallet-modal input {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 8px;
    }
    .wallet-modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        justify-content: flex-end;
    }
    .wallet-modal-actions button {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #0f0;
        background: #001800;
        color: #0f0;
        cursor: pointer;
    }
    .wallet-modal-actions .primary { background: #00ff66; color: #000; }
    .chain-tokens-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
    }
    .chain-supply-box {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chain-supply-label {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .chain-supply-amount {
        font-size: 16px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 5px rgba(0, 255, 102, 0.4));
    }
    .chain-tokens-scroll {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        flex: 1;
        padding: 5px 0;
        max-width: 70%;
    }
    .chain-token-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.1) 0%, rgba(0, 40, 20, 0.3) 100%);
        border: 1px solid rgba(0, 255, 102, 0.3);
        border-radius: 20px;
        white-space: nowrap;
        transition: all 0.3s;
        cursor: default;
    }
    .chain-token-pill:hover {
        border-color: #00ff66;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 40, 20, 0.4) 100%);
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
    }
    .chain-token-logo {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        font-weight: bold;
        border: 1px solid;
    }
    .chain-token-logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
    }
    .chain-token-symbol {
        font-size: 11px;
        font-weight: 600;
        color: #e6ffe5;
    }
    .chain-token-supply {
        font-size: 10px;
        color: #56ff9a;
        font-family: monospace;
    }
    .chain-token-holders {
        font-size: 9px;
        color: #ffd700;
        font-family: monospace;
        padding: 2px 4px;
        background: rgba(255, 215, 0, 0.1);
        border-radius: 4px;
    }
    .wallet-popup-header {
        font-size: 13px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
        border-image: linear-gradient(90deg, transparent, #00ff66, transparent) 1;
        text-align: center;
        letter-spacing: 1px;
        text-transform: uppercase;
    }
    .wallet-popup-tokens {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
    }
    .wallet-popup-token {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.2) 0%, rgba(0, 255, 102, 0.05) 100%);
        border-radius: 10px;
        border: 1px solid rgba(0, 255, 102, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    .wallet-popup-token::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
        transition: left 0.5s;
    }
    .wallet-popup-token:hover {
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.4) 0%, rgba(0, 255, 102, 0.1) 100%);
        border-color: #00ff66;
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.2), inset 0 0 10px rgba(0, 255, 102, 0.05);
        transform: translateX(-2px);
    }
    .wallet-popup-token:hover::before {
        left: 100%;
    }
    .wallet-popup-logo {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        border: 1px solid;
    }
    .wallet-popup-logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
    }
    .wallet-popup-info {
        flex: 1;
        font-size: 11px;
    }
    .wallet-popup-symbol {
        font-weight: 600;
        color: #e6ffe5;
    }
    .wallet-popup-balance {
        text-align: right;
        font-size: 12px;
        font-weight: 600;
        font-family: monospace;
    }
    .wallet-popup-total {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #1a3b2e;
        text-align: center;
        font-size: 11px;
        color: #56ff9a;
    }
    .wallet-popup-total-amount {
        font-size: 18px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-top: 4px;
        filter: drop-shadow(0 0 10px rgba(0, 255, 102, 0.5));
        animation: popup-balance-glow 2s ease-in-out infinite;
    }
    @keyframes popup-balance-glow {
        0%, 100% {
            filter: drop-shadow(0 0 10px rgba(0, 255, 102, 0.5));
        }
        50% {
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
        }
    }
    .wallet-popup-loading {
        text-align: center;
        padding: 20px;
        color: #56ff9a;
        font-size: 11px;
    }
    .wallet-popup-spinner {
        border: 2px solid rgba(0, 255, 102, 0.2);
        border-top: 2px solid #00ff66;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    .wallet-popup-actions {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid #1a3b2e;
        display: flex;
        gap: 8px;
    }

    .wallet-popup-login label {
        display: block;
        margin-top: 10px;
        font-size: 12px;
        color: #9f9;
    }

    .wallet-popup-login input {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        border-radius: 6px;
        box-sizing: border-box;
    }
    .wallet-popup-btn {
        flex: 1;
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.1) 0%, rgba(0, 255, 102, 0.2) 100%);
        border: 1px solid #00ff66;
        color: #00ff66;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s;
        border-radius: 6px;
        font-family: "Courier New", monospace;
    }
    .wallet-popup-btn:hover {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.3) 100%);
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.3);
        transform: translateY(-1px);
    }

    /* Enhanced Wallet Widget Styles */
    .wallet-popup-address {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.4);
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid rgba(0, 255, 102, 0.15);
    }
    .wallet-popup-address-text {
        flex: 1;
        font-family: monospace;
        font-size: 11px;
        color: #56ff9a;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .wallet-popup-copy-btn {
        background: rgba(0, 255, 102, 0.15);
        border: 1px solid rgba(0, 255, 102, 0.3);
        color: #00ff66;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.2s;
    }
    .wallet-popup-copy-btn:hover {
        background: rgba(0, 255, 102, 0.25);
        border-color: #00ff66;
    }

    /* Portfolio Summary */
    .wallet-portfolio-summary {
        background: linear-gradient(135deg, rgba(0, 40, 20, 0.6) 0%, rgba(0, 60, 30, 0.4) 100%);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
    }
    .wallet-portfolio-label {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
    }
    .wallet-portfolio-value {
        font-size: 22px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
    }
    .wallet-portfolio-usd {
        font-size: 12px;
        color: #a0a0a0;
        margin-top: 2px;
    }
    .wallet-portfolio-btc {
        font-size: 11px;
        color: #f7931a;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Token List Enhanced */
    .wallet-token-list {
        max-height: 250px;
        overflow-y: auto;
        padding-right: 4px;
    }
    .wallet-token-list::-webkit-scrollbar {
        width: 4px;
    }
    .wallet-token-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 2px;
    }
    .wallet-token-list::-webkit-scrollbar-thumb {
        background: rgba(0, 255, 102, 0.3);
        border-radius: 2px;
    }
    .wallet-token-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.15) 0%, rgba(0, 255, 102, 0.03) 100%);
        border-radius: 8px;
        border: 1px solid rgba(0, 255, 102, 0.1);
        margin-bottom: 6px;
        transition: all 0.2s;
    }
    .wallet-token-item:hover {
        background: linear-gradient(135deg, rgba(26, 59, 46, 0.3) 0%, rgba(0, 255, 102, 0.08) 100%);
        border-color: rgba(0, 255, 102, 0.25);
        transform: translateX(-2px);
    }
    .wallet-token-logo {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        border: 2px solid;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    .wallet-token-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .wallet-token-info {
        flex: 1;
        min-width: 0;
    }
    .wallet-token-name {
        font-size: 12px;
        font-weight: 600;
        color: #e6ffe5;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .wallet-token-symbol {
        font-size: 10px;
        color: #56ff9a;
        opacity: 0.8;
    }
    .wallet-token-values {
        text-align: right;
    }
    .wallet-token-balance {
        font-size: 13px;
        font-weight: 600;
        color: #e6ffe5;
        font-family: monospace;
    }
    .wallet-token-usd {
        font-size: 10px;
        color: #a0a0a0;
    }
    .wallet-token-thr-value {
        font-size: 10px;
        color: #ff9900;
        font-family: monospace;
    }

    /* Quick Actions */
    .wallet-quick-actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(0, 255, 102, 0.15);
    }
    .wallet-quick-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 10px 8px;
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.08) 0%, rgba(0, 255, 102, 0.15) 100%);
        border: 1px solid rgba(0, 255, 102, 0.25);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    .wallet-quick-btn:hover {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.15) 0%, rgba(0, 255, 102, 0.25) 100%);
        border-color: #00ff66;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 255, 102, 0.2);
    }
    .wallet-quick-btn-icon {
        font-size: 18px;
    }
    .wallet-quick-btn-label {
        font-size: 9px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Send Modal */
    .send-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }
    .send-modal.active {
        display: flex;
        pointer-events: auto;
    }
    .send-modal-content {
        background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
        border: 2px solid;
        border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 0 40px rgba(0, 255, 102, 0.4);
    }
    .send-modal-header {
        font-size: 16px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
        border-image: linear-gradient(90deg, transparent, #00ff66, transparent) 1;
        text-align: center;
    }
    .send-form-group {
        margin-bottom: 12px;
    }
    .send-form-label {
        display: block;
        font-size: 11px;
        color: #56ff9a;
        margin-bottom: 5px;
        font-weight: 600;
    }
    .send-form-input {
        width: 100%;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #1a3b2e;
        color: #e6ffe5;
        font-family: "Courier New", monospace;
        font-size: 12px;
        border-radius: 6px;
        transition: border-color 0.3s;
    }
    .send-form-input:focus {
        outline: none;
        border-color: #00ff66;
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.2);
    }
    .send-speed-options {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }
    .send-speed-option {
        flex: 1;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #1a3b2e;
        cursor: pointer;
        border-radius: 6px;
        text-align: center;
        transition: all 0.3s;
    }
    .send-speed-option:hover {
        border-color: #00ff66;
    }
    .send-speed-option.selected {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.1) 100%);
        border-color: #00ff66;
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.2);
    }
    .send-speed-label {
        font-size: 11px;
        font-weight: 600;
        color: #00ff66;
        margin-bottom: 3px;
    }
    .send-speed-fee {
        font-size: 9px;
        color: #56ff9a;
    }
    .send-modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .send-modal-btn {
        flex: 1;
        padding: 10px;
        border: 1px solid;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        transition: all 0.3s;
    }
    .send-modal-btn-primary {
        background: linear-gradient(135deg, #00ff00 0%, #00ff66 100%);
        color: #000;
        border-color: #00ff66;
    }
    .send-modal-btn-primary:hover {
        box-shadow: 0 0 20px rgba(0, 255, 102, 0.4);
        transform: translateY(-1px);
    }
    .send-modal-btn-secondary {
        background: transparent;
        color: #00ff66;
        border-color: #1a3b2e;
    }
    .send-modal-btn-secondary:hover {
        border-color: #00ff66;
        background: rgba(0, 255, 102, 0.1);
    }
    .send-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 6px;
        font-size: 11px;
        display: none;
    }
    .send-result.success {
        background: rgba(0, 255, 102, 0.1);
        border: 1px solid #00ff66;
        color: #00ff66;
    }
    .send-result.error {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff0000;
        color: #ff6666;
    }

    /* Network Selection */
    .send-network-options {
        display: flex;
        gap: 10px;
    }
    .send-network-option {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #1a3b2e;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s;
        position: relative;
    }
    .send-network-option:hover {
        border-color: #00ff66;
    }
    .send-network-option.selected {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.1) 100%);
        border-color: #00ff66;
        box-shadow: 0 0 15px rgba(0, 255, 102, 0.2);
    }
    .send-network-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .coming-soon-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #f7931a 0%, #ffb347 100%);
        color: #000;
        font-size: 8px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 10px;
        text-transform: uppercase;
    }

    /* Token Select */
    .send-token-select {
        cursor: pointer;
    }
    .token-balance-info {
        margin-top: 6px;
        font-size: 10px;
        color: #56ff9a;
    }
    #availableBalance {
        font-family: monospace;
        color: #00ff66;
        font-weight: 600;
    }

    /* Max Amount Button */
    .max-amount-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
        color: #000;
        border: none;
        padding: 4px 10px;
        font-size: 10px;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .max-amount-btn:hover {
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.4);
        transform: translateY(-50%) scale(1.05);
    }
    
    /* Disconnect Button */
    .disconnect-btn {
        background: #220000;
        color: #f00;
        border: 1px solid #440000;
        padding: 5px 10px;
        font-size: 0.8em;
        cursor: pointer;
        display: none;
    }
    .disconnect-btn:hover {
        background: #440000;
    }
    
    /* Language Toggle */
    /* PRIORITY 8: Language dropdown (5 languages) */
    .lang-toggle {
        background: #222;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 5px 10px;
        cursor: pointer;
    }

    .lang-dropdown {
        position: relative;
        display: inline-block;
    }

    .lang-dropdown-btn {
        background: linear-gradient(135deg, #003311 0%, #001a0a 100%);
        color: #00ff66;
        border: 1px solid #00ff66;
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 0 8px rgba(0, 255, 102, 0.2);
        transition: all 0.2s ease;
    }

    .lang-dropdown-btn:hover {
        background: linear-gradient(135deg, #004422 0%, #002211 100%);
        box-shadow: 0 0 12px rgba(0, 255, 102, 0.4);
    }

    .lang-dropdown-content {
        display: none;
        position: absolute;
        background: #0a130e;
        min-width: 140px;
        box-shadow: 0 4px 20px rgba(0, 255, 102, 0.3);
        z-index: 3100;
        border: 1px solid #00ff66;
        border-radius: 8px;
        overflow: hidden;
        top: 100%;
        right: 0;
        margin-top: 4px;
    }

    .lang-dropdown.active .lang-dropdown-content {
        display: block;
    }

    .lang-dropdown-item {
        color: #00ff66;
        padding: 10px 16px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s ease;
        border-bottom: 1px solid rgba(0, 255, 102, 0.1);
    }

    .lang-dropdown-item:last-child {
        border-bottom: none;
    }

    .lang-dropdown-item:hover {
        background: rgba(0, 255, 102, 0.1);
    }

    .lang-dropdown-item.active {
        background: rgba(0, 255, 102, 0.15);
        font-weight: 700;
    }

    .lang-en, .lang-ja, .lang-es, .lang-ru { display: none; }

    /* Utility Classes */
    .highlight { color: #ff0; }
    .btn {
        display: inline-block;
        background: #0f0;
        color: #000;
        padding: 10px 20px;
        font-weight: bold;
        text-decoration: none;
        border: 1px solid #000;
        cursor: pointer;
    }
    .btn:hover { background: #0c0; }
    
    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(0,0,0,0.3);
        border-radius: 50%;
        border-top-color: #000;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
        vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .wallet-popup-topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px;}
    .wallet-popup-title{font-size:12px;opacity:.85;}
    .wallet-popup-actions{display:flex;gap:6px;}
    .wallet-mini-btn{background:transparent;border:1px solid rgba(0,255,102,.25);color:#00ff66;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer;}
    .wallet-mini-btn:hover{border-color:rgba(0,255,102,.55);}
    .wallet-mini-btn.active{background:rgba(0,255,102,.12);}
    .wallet-lock-hint{margin-top:8px;font-size:11px;opacity:.7;}

    /* Token Info Modal */
    .token-info-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.92);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    .token-info-modal.active {
        display: flex;
    }
    .token-info-content {
        background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
        border: 2px solid;
        border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
        border-radius: 16px;
        padding: 25px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 0 50px rgba(0, 255, 102, 0.4), 0 0 100px rgba(255, 215, 0, 0.2);
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
    }
    .token-info-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: 1px solid rgba(255, 100, 100, 0.3);
        color: #ff6666;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    .token-info-close:hover {
        background: rgba(255, 100, 100, 0.2);
        border-color: #ff6666;
    }
    .token-info-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(0, 255, 102, 0.2);
    }
    .token-info-logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        border: 3px solid;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    .token-info-logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .token-info-title {
        flex: 1;
    }
    .token-info-name {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #ffd700 0%, #00ff66 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .token-info-symbol {
        font-size: 14px;
        color: #56ff9a;
        margin-top: 2px;
    }
    .token-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    .token-info-stat {
        background: linear-gradient(135deg, rgba(0, 40, 20, 0.5) 0%, rgba(0, 60, 30, 0.3) 100%);
        border: 1px solid rgba(0, 255, 102, 0.15);
        border-radius: 10px;
        padding: 12px;
        text-align: center;
    }
    .token-info-stat-label {
        font-size: 10px;
        color: #56ff9a;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
    }
    .token-info-stat-value {
        font-size: 16px;
        font-weight: 600;
        color: #e6ffe5;
        font-family: monospace;
    }
    .token-info-description {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(0, 255, 102, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #a0d8b0;
        line-height: 1.5;
    }
    .token-info-properties {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }
    .token-info-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .token-info-badge.transferable {
        background: linear-gradient(135deg, rgba(0, 255, 102, 0.2) 0%, rgba(0, 255, 102, 0.1) 100%);
        border: 1px solid #00ff66;
        color: #00ff66;
    }
    .token-info-badge.not-transferable {
        background: linear-gradient(135deg, rgba(255, 100, 100, 0.2) 0%, rgba(255, 100, 100, 0.1) 100%);
        border: 1px solid #ff6666;
        color: #ff6666;
    }
    .token-info-badge.burnable {
        background: linear-gradient(135deg, rgba(255, 150, 0, 0.2) 0%, rgba(255, 150, 0, 0.1) 100%);
        border: 1px solid #ff9600;
        color: #ff9600;
    }
    .token-info-badge.mintable {
        background: linear-gradient(135deg, rgba(0, 191, 255, 0.2) 0%, rgba(0, 191, 255, 0.1) 100%);
        border: 1px solid #00bfff;
        color: #00bfff;
    }
    .token-info-actions {
        display: flex;
        gap: 10px;
    }
    .token-info-btn {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-family: "Courier New", monospace;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .token-info-btn-send {
        background: linear-gradient(135deg, #00ff00 0%, #00ff66 100%);
        color: #000;
        border: 1px solid #00ff66;
    }
    .token-info-btn-send:hover {
        box-shadow: 0 0 20px rgba(0, 255, 102, 0.4);
        transform: translateY(-2px);
    }
    .token-info-btn-send.disabled {
        background: rgba(100, 100, 100, 0.3);
        border-color: #666;
        color: #888;
        cursor: not-allowed;
    }
    .token-info-btn-secondary {
        background: transparent;
        color: #00ff66;
        border: 1px solid rgba(0, 255, 102, 0.3);
    }
    .token-info-btn-secondary:hover {
        border-color: #00ff66;
        background: rgba(0, 255, 102, 0.1);
    }
    .token-info-creator {
        font-size: 11px;
        color: #666;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .token-info-creator a {
        color: #56ff9a;
    }

    /* Page Specific Styles Block */
    {% block styles %}{% endblock %}

 </style>
</head>
<body>

<div class="top-controls">
    <button id="walletLoginBtn" class="wallet-login-btn" onclick="openHeaderWalletModal()">
        üíº <span class="lang-el">Œ£œçŒΩŒ¥ŒµœÉŒ∑</span><span class="lang-en">Login</span>
    </button>
    <div id="walletStatus" class="wallet-status">
        <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="üî•" class="wallet-fire-icon" />
        <span id="walletAddrShort"></span>

        <!-- Wallet Balance Popup Widget -->
        <div class="wallet-balance-popup" id="walletBalancePopup" onclick="event.stopPropagation();">
            <div class="wallet-popup-topbar">
                <div class="wallet-popup-title">Wallet</div>
                <div class="wallet-popup-actions">
                    <button id="walletPinBtn" class="wallet-mini-btn" title="Pin">Pin</button>
                    <button id="walletLockBtn" class="wallet-mini-btn" title="Lock">Lock</button>
                </div>
            </div>

            <div id="walletLoginSection" class="wallet-popup-login" style="display:none;">
                <label for="walletWidgetAddress">THR Address</label>
                <input type="text" id="walletWidgetAddress" placeholder="THR..." />
                <label for="walletWidgetSecret">Send Secret</label>
                <input type="password" id="walletWidgetSecret" placeholder="send_secret" />
                <label for="walletWidgetPin">PIN (optional)</label>
                <input type="password" id="walletWidgetPin" placeholder="4-8 digits" />
                <div class="wallet-modal-actions" style="margin-top:10px;">
                    <button class="primary" onclick="submitHeaderWalletLogin()">Save</button>
                </div>
                <div style="font-size:11px; color:#9f9; opacity:0.7; margin-top:6px;">
                    Stored locally (thr_address, send_secret, wallet_pin).
                </div>
            </div>

            <div id="walletContentSection">
                <div class="wallet-popup-loading">
                    <div class="wallet-popup-spinner"></div>
                    Loading balances...
                </div>
            </div>
        </div>
    </div>
    <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectWallet()">
        ‚úñ <span class="lang-el">ŒëœÄŒøœÉœçŒΩŒ¥ŒµœÉŒ∑</span><span class="lang-en">Disconnect</span>
    </button>
    <!-- PRIORITY 8: Language dropdown (5 languages: EN/EL/ES/RU/JA) -->
    <div class="lang-dropdown" id="langDropdown">
        <button class="lang-dropdown-btn" onclick="toggleLangDropdown(event)">
            <span id="currentLangFlag">üá¨üá∑</span>
            <span id="currentLangCode">GR</span>
            <span style="font-size: 10px;">‚ñº</span>
        </button>
        <div class="lang-dropdown-content">
            <div class="lang-dropdown-item" data-lang="gr" onclick="selectLanguageFromDropdown('gr')">
                <span>üá¨üá∑</span>
                <span>ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (GR)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="en" onclick="selectLanguageFromDropdown('en')">
                <span>üá¨üáß</span>
                <span>English (EN)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="es" onclick="selectLanguageFromDropdown('es')">
                <span>üá™üá∏</span>
                <span>Espa√±ol (ES)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="ru" onclick="selectLanguageFromDropdown('ru')">
                <span>üá∑üá∫</span>
                <span>–†—É—Å—Å–∫–∏–π (RU)</span>
            </div>
            <div class="lang-dropdown-item" data-lang="ja" onclick="selectLanguageFromDropdown('ja')">
                <span>üáØüáµ</span>
                <span>Êó•Êú¨Ë™û (JA)</span>
            </div>
        </div>
    </div>
</div>

<!-- Send Modal -->
<div class="send-modal" id="sendModal" onclick="closeSendModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">üí∏ <span class="lang-el">ŒëœÄŒøœÉœÑŒøŒªŒÆ Tokens</span><span class="lang-en">Send Tokens</span></div>

        <!-- Network Selection -->
        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">ŒîŒØŒ∫œÑœÖŒø</span><span class="lang-en">Network</span></label>
            <div class="send-network-options">
                <div class="send-network-option selected" data-network="thronos" onclick="selectNetwork('thronos')">
                    <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="THR" style="width: 20px; height: 20px; border-radius: 50%;">
                    <span>Thronos Chain</span>
                </div>
                <div class="send-network-option" data-network="bitcoin" onclick="selectNetwork('bitcoin')">
                    <span style="font-size: 18px;">‚Çø</span>
                    <span>Bitcoin (Bridge)</span>
                    <span class="coming-soon-badge"><span class="lang-el">Œ£œçŒΩœÑŒøŒºŒ±</span><span class="lang-en">Soon</span></span>
                </div>
            </div>
        </div>

        <!-- Token Selection -->
        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Token</span><span class="lang-en">Token</span></label>
            <select id="sendToken" class="send-form-input send-token-select" onchange="updateTokenInfo()">
                <option value="THR" data-color="#ff6600">THR - Thronos</option>
                <option value="WBTC" data-color="#f7931a">WBTC - Wrapped Bitcoin</option>
                <option value="L2E" data-color="#00bfff">L2E - Learn-to-Earn</option>
            </select>
            <div id="tokenBalanceInfo" class="token-balance-info">
                <span class="lang-el">ŒîŒπŒ±Œ∏Œ≠œÉŒπŒºŒø:</span><span class="lang-en">Available:</span>
                <span id="availableBalance">0.000000</span>
            </div>
        </div>

        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Œ†Œ±œÅŒ±ŒªŒÆœÄœÑŒ∑œÇ</span><span class="lang-en">Recipient Address</span></label>
            <input type="text" id="sendTo" class="send-form-input" placeholder="THR..." />
        </div>

        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Œ†ŒøœÉœå</span><span class="lang-en">Amount</span></label>
            <div style="position: relative;">
                <input type="number" id="sendAmount" class="send-form-input" placeholder="0.000000" step="0.000001" />
                <button type="button" onclick="setMaxAmount()" class="max-amount-btn">MAX</button>
            </div>
        </div>

        <div class="send-form-group">
            <label class="send-form-label"><span class="lang-el">Œ§Œ±œáœçœÑŒ∑œÑŒ± Œ£œÖŒΩŒ±ŒªŒªŒ±Œ≥ŒÆœÇ</span><span class="lang-en">Transaction Speed</span></label>
            <div class="send-speed-options">
                <div class="send-speed-option" data-speed="slow" onclick="selectSpeed('slow')">
                    <div class="send-speed-label">üê¢ <span class="lang-el">ŒëœÅŒ≥ŒÆ</span><span class="lang-en">Slow</span></div>
                    <div class="send-speed-fee">0.09% fee</div>
                </div>
                <div class="send-speed-option selected" data-speed="fast" onclick="selectSpeed('fast')">
                    <div class="send-speed-label">‚ö° <span class="lang-el">ŒìœÅŒÆŒ≥ŒøœÅŒ∑</span><span class="lang-en">Fast</span></div>
                    <div class="send-speed-fee">0.5% fee</div>
                </div>
            </div>
        </div>

        <div class="send-result" id="sendResult"></div>

        <div class="send-modal-actions">
            <button class="send-modal-btn send-modal-btn-secondary" onclick="closeSendModal()">
                <span class="lang-el">ŒëŒ∫œçœÅœâœÉŒ∑</span><span class="lang-en">Cancel</span>
            </button>
            <button class="send-modal-btn send-modal-btn-primary" onclick="submitSend()">
                <span class="lang-el">ŒëœÄŒøœÉœÑŒøŒªŒÆ</span><span class="lang-en">Send</span>
            </button>
        </div>
    </div>
</div>

<!-- Receive Modal -->
<div class="send-modal" id="receiveModal" onclick="closeReceiveModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">
            üì•
            <span class="lang-el">ŒõŒÆœàŒ∑ Tokens</span>
            <span class="lang-en">Receive Tokens</span>
            <span class="lang-ja">„Éà„Éº„ÇØ„É≥Âèó„ÅëÂèñ„Çä</span>
            <span class="lang-es">Recibir Tokens</span>
            <span class="lang-ru">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</span>
        </div>

        <div id="receiveContent">
            <div class="send-form-group">
                <label class="send-form-label">
                    <span class="lang-el">ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑ Œ†ŒøœÅœÑŒøœÜŒøŒªŒπŒøœç</span>
                    <span class="lang-en">Wallet Address</span>
                    <span class="lang-ja">„Ç¶„Ç©„É¨„ÉÉ„Éà„Ç¢„Éâ„É¨„Çπ</span>
                    <span class="lang-es">Direcci√≥n de cartera</span>
                    <span class="lang-ru">–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</span>
                </label>
                <div style="display:flex;align-items:center;gap:8px;word-break:break-all;">
                    <code id="receiveAddress" style="font-size:13px;">‚Äî</code>
                    <button class="send-modal-btn" style="padding:6px 10px;" onclick="copyReceiveAddress()">üìã
                        <span class="lang-el">ŒëŒΩœÑŒπŒ≥œÅŒ±œÜŒÆ</span>
                        <span class="lang-en">Copy</span>
                        <span class="lang-ja">„Ç≥„Éî„Éº</span>
                        <span class="lang-es">Copiar</span>
                        <span class="lang-ru">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
            </div>

            <div class="send-form-group" style="text-align:center;">
                <img id="receiveQr" src="" alt="QR" style="max-width:200px;border:1px solid #0f0;border-radius:10px;display:none;" loading="lazy">
                <div id="receiveQrHint" style="font-size:12px;color:#9fdfb4;margin-top:8px;">
                    <span class="lang-el">Œ£Œ∫Œ¨ŒΩŒ±œÅŒµ œÑŒø QR Œ≥ŒπŒ± ŒΩŒ± ŒªŒ¨Œ≤ŒµŒπœÇ THR.</span>
                    <span class="lang-en">Scan this QR to receive THR.</span>
                    <span class="lang-ja">„Åì„ÅÆQR„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶THR„ÇíÂèó„ÅëÂèñ„Çã„ÄÇ</span>
                    <span class="lang-es">Escanea este QR para recibir THR.</span>
                    <span class="lang-ru">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å THR.</span>
                </div>
            </div>

            <div class="send-form-group" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                <audio id="receiveAudio" src=""></audio>
                <button class="send-speed-option selected" style="flex:0;" onclick="playReceiveAudio()">üîä
                    <span class="lang-el">ŒëŒΩŒ±œÄŒ±œÅŒ±Œ≥œâŒ≥ŒÆ ŒâœáŒøœÖ</span>
                    <span class="lang-en">Play Audio</span>
                    <span class="lang-ja">ÂÜçÁîü</span>
                    <span class="lang-es">Reproducir</span>
                    <span class="lang-ru">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</span>
                </button>
                <a id="receiveDownload" class="send-speed-option" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;" download="ThronosAddress.wav">
                    ‚¨áÔ∏è
                    <span class="lang-el">ŒõŒÆœàŒ∑ ŒâœáŒøœÖ</span>
                    <span class="lang-en">Download WAV</span>
                    <span class="lang-ja">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                    <span class="lang-es">Descargar</span>
                    <span class="lang-ru">–°–∫–∞—á–∞—Ç—å</span>
                </a>
            </div>

            <div id="receiveEmpty" class="send-result error" style="display:none;">
                <span class="lang-el">Œ£œÖŒΩŒ¥Œ≠œÉœÑŒµ œÄŒøœÅœÑŒøœÜœåŒªŒπ Œ≥ŒπŒ± ŒΩŒ± ŒµŒºœÜŒ±ŒΩŒπœÉœÑŒµŒØ Œ∑ Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑.</span>
                <span class="lang-en">Connect a wallet to view your address.</span>
                <span class="lang-ja">„Ç¶„Ç©„É¨„ÉÉ„Éà„ÇíÊé•Á∂ö„Åó„Å¶„Ç¢„Éâ„É¨„Çπ„ÇíË°®Á§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</span>
                <span class="lang-es">Conecta una cartera para ver tu direcci√≥n.</span>
                <span class="lang-ru">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–¥—Ä–µ—Å.</span>
            </div>
        </div>

        <div style="margin-top:10px;text-align:right;">
            <button class="send-modal-btn" onclick="closeReceiveModal()">
                <span class="lang-el">ŒöŒªŒµŒØœÉŒπŒºŒø</span>
                <span class="lang-en">Close</span>
                <span class="lang-ja">Èñâ„Åò„Çã</span>
                <span class="lang-es">Cerrar</span>
                <span class="lang-ru">–ó–∞–∫—Ä—ã—Ç—å</span>
            </button>
        </div>
    </div>
</div>

<!-- Wallet History Modal -->
<div class="send-modal" id="walletHistoryModal" onclick="closeWalletHistoryModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">
            üìú
            <span class="lang-el">ŒôœÉœÑŒøœÅŒπŒ∫œå Œ£œÖŒΩŒ±ŒªŒªŒ±Œ≥œéŒΩ</span>
            <span class="lang-en">Transaction History</span>
        </div>

        <!-- History Tabs -->
        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; padding: 0 4px;">
            <button class="history-tab-btn active" data-filter="all" onclick="filterHistory('all')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.2); border: 1px solid rgba(0,255,102,0.4); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">ŒåŒªŒ±</span><span class="lang-en">All</span>
            </button>
            <button class="history-tab-btn" data-filter="thr" onclick="filterHistory('thr')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">THR</button>
            <button class="history-tab-btn" data-filter="token" onclick="filterHistory('token')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">Tokens</span><span class="lang-en">Tokens</span>
            </button>
            <button class="history-tab-btn" data-filter="l2e" onclick="filterHistory('l2e')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">L2E</button>
            <button class="history-tab-btn" data-filter="ai_credits" onclick="filterHistory('ai_credits')" style="flex: 1; min-width: 70px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">AI Credits (Chat)</button>
            <button class="history-tab-btn" data-filter="architect" onclick="filterHistory('architect')" style="flex: 1; min-width: 70px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">Architect / AI Jobs</button>
            <button class="history-tab-btn" data-filter="iot" onclick="filterHistory('iot')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">IoT</button>
            <button class="history-tab-btn" data-filter="bridge" onclick="filterHistory('bridge')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">Bridge</span><span class="lang-en">Bridge</span>
            </button>
            <button class="history-tab-btn" data-filter="swap" onclick="filterHistory('swap')" style="flex: 1; min-width: 60px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">Swaps</span><span class="lang-en">Swaps</span>
            </button>
            <button class="history-tab-btn" data-filter="liquidity" onclick="filterHistory('liquidity')" style="flex: 1; min-width: 70px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">Liquidity</span><span class="lang-en">Liquidity</span>
            </button>
            <button class="history-tab-btn" data-filter="gateway" onclick="filterHistory('gateway')" style="flex: 1; min-width: 70px; padding: 6px 8px; background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 6px; color: #00ff66; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                <span class="lang-el">Gateway</span><span class="lang-en">Gateway</span>
            </button>
        </div>

        <div id="tokenIndexBar" style="display:none; margin: 0 4px 10px 4px;">
            <div style="display:flex; align-items:center; gap:6px; overflow-x:auto; padding-bottom:6px; scrollbar-width: thin;" id="tokenIndexScroll"></div>
            <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 4px;">
                <button class="history-tab-btn" style="flex:0 0 auto; min-width: 80px; padding: 6px 8px;" onclick="clearTokenFilter()">All Tokens</button>
                <button class="history-tab-btn" style="flex:0 0 auto; min-width: 80px; padding: 6px 8px;" onclick="shareTokenFilter()">Share / Copy</button>
            </div>
        </div>

        <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ ŒπœÉœÑŒøœÅŒπŒ∫Œøœç...</span>
                <span class="lang-en">Loading history...</span>
            </div>
        </div>

        <div style="margin-top:10px;text-align:right;">
            <button class="send-modal-btn" onclick="closeWalletHistoryModal()">
                <span class="lang-el">ŒöŒªŒµŒØœÉŒπŒºŒø</span>
                <span class="lang-en">Close</span>
            </button>
        </div>
    </div>
</div>

<!-- Bridge Modal -->
<div class="send-modal" id="bridgeModal" onclick="closeBridgeModal(event)">
    <div class="send-modal-content" onclick="event.stopPropagation()">
        <div class="send-modal-header">
            üåâ
            <span class="lang-el">Bridge Deposit</span>
            <span class="lang-en">Bridge Deposit</span>
        </div>

        <!-- Deposit-only warning -->
        <div style="background: rgba(255,255,0,0.1); border: 1px solid rgba(255,255,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 11px; color: #ffff99;">
            <div style="font-weight: bold; margin-bottom: 4px;">‚ö†Ô∏è
                <span class="lang-el">ŒúœåŒΩŒø ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑ (BTC‚ÜíThronos)</span>
                <span class="lang-en">Deposit Only (BTC‚ÜíThronos)</span>
            </div>
            <div style="opacity: 0.9;">
                <span class="lang-el">ŒëŒΩŒ±ŒªŒÆœàŒµŒπœÇ Œ±œÄŒµŒΩŒµœÅŒ≥ŒøœÄŒøŒπŒ∑ŒºŒ≠ŒΩŒµœÇ / Œ£œçŒΩœÑŒøŒºŒ± Œ¥ŒπŒ±Œ∏Œ≠œÉŒπŒºŒµœÇ</span>
                <span class="lang-en">Withdrawals disabled / Coming soon</span>
            </div>
        </div>

        <div id="bridgeContent">
            <div class="send-form-group">
                <label class="send-form-label">
                    <span class="lang-el">ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑ ŒöŒ±œÑŒ¨Œ∏ŒµœÉŒ∑œÇ Bridge (œåœáŒπ Pledge)</span>
                    <span class="lang-en">Bridge Deposit Address (not Pledge)</span>
                </label>
                <div style="display:flex;align-items:center;gap:8px;word-break:break-all;">
                    <code id="bridgeDepositAddress" style="font-size:13px;">‚Äî</code>
                    <button class="send-modal-btn" style="padding:6px 10px;" onclick="copyBridgeAddress()">üìã
                        <span class="lang-el">ŒëŒΩœÑŒπŒ≥œÅŒ±œÜŒÆ</span>
                        <span class="lang-en">Copy</span>
                    </button>
                </div>
            </div>

            <div id="bridgeEmpty" class="send-result error" style="display:none;">
                <span class="lang-el">Œ£œÖŒΩŒ¥Œ≠œÉœÑŒµ œÄŒøœÅœÑŒøœÜœåŒªŒπ Œ≥ŒπŒ± bridge deposit.</span>
                <span class="lang-en">Connect wallet to get bridge deposit address.</span>
            </div>
        </div>

        <div style="margin-top:10px;text-align:right;">
            <button class="send-modal-btn" onclick="closeBridgeModal()">
                <span class="lang-el">ŒöŒªŒµŒØœÉŒπŒºŒø</span>
                <span class="lang-en">Close</span>
            </button>
        </div>
    </div>
</div>

<!-- Token Info Modal -->
<div class="token-info-modal" id="tokenInfoModal" onclick="closeTokenInfoModal(event)">
    <div class="token-info-content" onclick="event.stopPropagation()">
        <button class="token-info-close" onclick="closeTokenInfoModal()">‚úï</button>
        <div id="tokenInfoBody">
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ œÄŒªŒ∑œÅŒøœÜŒøœÅŒπœéŒΩ...</span>
                <span class="lang-en">Loading token info...</span>
            </div>
        </div>
    </div>
</div>

<div class="navbar">
  <ul class="nav-list">
    <li class="nav-item brand">
      <span class="nav-link">
        <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="üî•" class="thr-logo-icon" />
        THRONOS
      </span>
    </li>
    <!-- Home -->
    <li class="nav-item">
      <a href="/" class="nav-link">üè† <span class="lang-el">ŒëœÅœáŒπŒ∫ŒÆ</span><span class="lang-en">Home</span><span class="lang-ja">„Éõ„Éº„É†</span><span class="lang-ru">–ì–ª–∞–≤–Ω–∞—è</span><span class="lang-es">Inicio</span></a>
    </li>

    <!-- Apps Dropdown -->
    <li class="nav-item">
      <span class="nav-link">üì± <span class="lang-el">ŒïœÜŒ±œÅŒºŒøŒ≥Œ≠œÇ</span><span class="lang-en">Apps</span><span class="lang-ja">„Ç¢„Éó„É™</span><span class="lang-ru">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</span><span class="lang-es">Apps</span> ‚ñº</span>
      <div class="dropdown-content">
        <a href="/wallet">üëõ <span class="lang-el">Œ†ŒøœÅœÑŒøœÜœåŒªŒπ</span><span class="lang-en">Wallet</span><span class="lang-ja">„Ç¶„Ç©„É¨„ÉÉ„Éà</span><span class="lang-ru">–ö–æ—à–µ–ª—ë–∫</span><span class="lang-es">Billetera</span></a>
        <a href="/send">üí∏ <span class="lang-el">ŒëœÄŒøœÉœÑŒøŒªŒÆ</span><span class="lang-en">Send</span><span class="lang-ja">ÈÄÅÈáë</span><span class="lang-ru">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span><span class="lang-es">Enviar</span></a>
        <a href="/swap">üîÑ Swap</a>
        <a href="/pools">üíß Pools</a>
        <a href="/tokens">ü™ô Tokens</a>
        <a href="/music">üéµ <span class="lang-el">ŒúŒøœÖœÉŒπŒ∫ŒÆ</span><span class="lang-en">Music</span><span class="lang-ja">Èü≥Ê•Ω</span><span class="lang-ru">–ú—É–∑—ã–∫–∞</span><span class="lang-es">M√∫sica</span></a>
        <a href="/nft">üé® <span class="lang-el">NFT ŒëŒ≥ŒøœÅŒ¨</span><span class="lang-en">NFT Market</span><span class="lang-ja">NFT„Éû„Éº„Ç±„ÉÉ„Éà</span><span class="lang-ru">NFT –ú–∞—Ä–∫–µ—Ç</span><span class="lang-es">Mercado NFT</span></a>
        <a href="/gateway">üí≥ Gateway</a>
        <a href="/evm">‚ö° Smart Contracts</a>
        <a href="/courses">üéì <span class="lang-el">ŒúŒ¨Œ∏Œµ & ŒöŒ≠œÅŒ¥ŒπœÉŒµ</span><span class="lang-en">Learn & Earn</span><span class="lang-ja">Â≠¶„Çì„ÅßÁ®º„Åê</span><span class="lang-ru">–£—á–∏—Å—å –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</span><span class="lang-es">Aprende y Gana</span></a>
        <a href="/game">üéÆ <span class="lang-el">Œ†Œ±ŒπœáŒΩŒØŒ¥Œπ</span><span class="lang-en">Game</span><span class="lang-ja">„Ç≤„Éº„É†</span><span class="lang-ru">–ò–≥—Ä–∞</span><span class="lang-es">Juego</span></a>
        <a href="/pledge">üî• <span class="lang-el">ŒîŒ≠œÉŒºŒµœÖœÉŒ∑</span><span class="lang-en">Pledge</span><span class="lang-ja">„Éó„É¨„ÉÉ„Ç∏</span><span class="lang-ru">–ó–∞–ª–æ–≥</span><span class="lang-es">Promesa</span></a>
        <a href="/explorer">üîç Token Explorer</a>
        <a href="/governance">üó≥Ô∏è <span class="lang-el">ŒîŒπŒ±Œ∫œÖŒ≤Œ≠œÅŒΩŒ∑œÉŒ∑</span><span class="lang-en">Governance</span><span class="lang-ja">„Ç¨„Éê„Éä„É≥„Çπ</span><span class="lang-ru">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span><span class="lang-es">Gobernanza</span></a>
        <a href="/viewer">üì¶ Block Viewer</a>
        <a href="/token_chart">üìà <span class="lang-el">ŒìœÅŒ¨œÜŒ∑ŒºŒ± Token</span><span class="lang-en">Token Chart</span><span class="lang-ja">„Éà„Éº„ÇØ„É≥„ÉÅ„É£„Éº„Éà</span><span class="lang-ru">–ì—Ä–∞—Ñ–∏–∫ —Ç–æ–∫–µ–Ω–∞</span><span class="lang-es">Gr√°fico Token</span></a>
      </div>
    </li>

    <!-- Services Dropdown -->
    <li class="nav-item">
      <span class="nav-link">üåê <span class="lang-el">Œ•œÄŒ∑œÅŒµœÉŒØŒµœÇ</span><span class="lang-en">Services</span><span class="lang-ja">„Çµ„Éº„Éì„Çπ</span><span class="lang-ru">–£—Å–ª—É–≥–∏</span><span class="lang-es">Servicios</span> ‚ñº</span>
      <div class="dropdown-content">
        <a href="/bridge">üåâ <span class="lang-el">ŒìŒ≠œÜœÖœÅŒ± BTC</span><span class="lang-en">BTC Bridge</span><span class="lang-ja">BTC„Éñ„É™„ÉÉ„Ç∏</span><span class="lang-ru">BTC –ú–æ—Å—Ç</span><span class="lang-es">Puente BTC</span></a>
        <a href="/iot">üöó <span class="lang-el">IoT ŒöœåŒºŒ≤ŒøŒπ</span><span class="lang-en">IoT Nodes</span><span class="lang-ja">IoT„Éé„Éº„Éâ</span><span class="lang-ru">IoT –£–∑–ª—ã</span><span class="lang-es">Nodos IoT</span></a>
        <a href="/chat">ü§ñ AI Chat</a>
        <a href="/ai_packs">üíé AI Credits</a>
        <a href="/architect">üèóÔ∏è AI Architect</a>
      </div>
    </li>

    <!-- Docs Dropdown -->
    <li class="nav-item">
      <span class="nav-link">üìö <span class="lang-el">ŒàŒ≥Œ≥œÅŒ±œÜŒ±</span><span class="lang-en">Docs</span><span class="lang-ja">„Éâ„Ç≠„É•„É°„É≥„Éà</span><span class="lang-ru">–î–æ–∫—É–º–µ–Ω—Ç—ã</span><span class="lang-es">Documentos</span> ‚ñº</span>
      <div class="dropdown-content">
        <a href="/whitepaper">üìÑ Whitepaper</a>
        <a href="/roadmap">üó∫Ô∏è Roadmap</a>
        <a href="/tokenomics">üìú Tokenomics</a>
      </div>
    </li>

    <!-- Recovery -->
    <li class="nav-item">
      <a href="/recovery" class="nav-link">üõ†Ô∏è <span class="lang-el">ŒëŒΩŒ¨Œ∫œÑŒ∑œÉŒ∑</span><span class="lang-en">Recovery</span><span class="lang-ja">„É™„Ç´„Éê„É™„Éº</span><span class="lang-ru">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span><span class="lang-es">Recuperaci√≥n</span></a>
    </li>
  </ul>
</div>

<div class="container">
  {% block content %}{% endblock %}
</div>

<script>
// Global Language Logic
    window.LANG_SEQUENCE = window.LANG_SEQUENCE || ['gr', 'en', 'ja', 'es', 'ru'];
const LANGUAGE_CLASS_MAP = {
    gr: 'lang-el',
    en: 'lang-en',
    ja: 'lang-ja',
    es: 'lang-es',
    ru: 'lang-ru'
};
const DEFAULT_LANG = 'gr';

function normalizeLang(lang) {
    if (!lang) return DEFAULT_LANG;
    if (lang === 'el') return 'gr';
      return window.LANG_SEQUENCE.includes(lang) ? lang : 'en';
}

function getCurrentLang() {
    return normalizeLang(localStorage.getItem('lang') || DEFAULT_LANG);
}

function isGreekLang(lang) {
    return normalizeLang(lang) === 'gr';
}

function toggleLanguage() {
    const currentLang = getCurrentLang();
      const currentIndex = window.LANG_SEQUENCE.indexOf(currentLang);
      const nextIndex = (currentIndex + 1) % window.LANG_SEQUENCE.length;
      setLanguage(window.LANG_SEQUENCE[nextIndex]);
}

function setLanguage(lang) {
    const normalizedLang = normalizeLang(lang);
    localStorage.setItem('lang', normalizedLang);

    const allClasses = Object.values(LANGUAGE_CLASS_MAP);
    allClasses.forEach(cls => {
        document.querySelectorAll(`.${cls}`).forEach(el => el.style.display = 'none');
    });

    const activeClass = LANGUAGE_CLASS_MAP[normalizedLang] || LANGUAGE_CLASS_MAP.en;
    document.querySelectorAll(`.${activeClass}`).forEach(el => el.style.display = 'inline');

    // Fallback to English where no translation exists in the same container
    if (normalizedLang !== 'en') {
        document.querySelectorAll('.lang-en').forEach(el => {
            const parent = el.parentElement;
            const hasSibling = parent ? parent.querySelector(`.${activeClass}`) : null;
            if (!hasSibling) {
                el.style.display = 'inline';
            }
        });
    }

    const toggleBtn = document.querySelector('.lang-toggle');
    if (toggleBtn) {
        toggleBtn.textContent = normalizedLang.toUpperCase();
    }

    // PRIORITY 8: Update dropdown UI
    updateLangDropdownUI(normalizedLang);

    // Trigger custom event for pages that need to re-render content
    window.dispatchEvent(new CustomEvent('langChanged', { detail: { lang: normalizedLang } }));
}

// PRIORITY 8: Language dropdown functions
const LANG_FLAGS = {
    gr: 'üá¨üá∑',
    en: 'üá¨üáß',
    es: 'üá™üá∏',
    ru: 'üá∑üá∫',
    ja: 'üáØüáµ'
};

function updateLangDropdownUI(lang) {
    const flagEl = document.getElementById('currentLangFlag');
    const codeEl = document.getElementById('currentLangCode');

    if (flagEl) flagEl.textContent = LANG_FLAGS[lang] || 'üá¨üáß';
    if (codeEl) codeEl.textContent = lang.toUpperCase();

    // Update active state in dropdown items
    document.querySelectorAll('.lang-dropdown-item').forEach(item => {
        item.classList.toggle('active', item.dataset.lang === lang);
    });
}

function toggleLangDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

function selectLanguageFromDropdown(lang) {
    setLanguage(lang);
    const dropdown = document.getElementById('langDropdown');
    if (dropdown) {
        dropdown.classList.remove('active');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', (event) => {
    const dropdown = document.getElementById('langDropdown');
    if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

// Initialize dropdown on load
document.addEventListener('DOMContentLoaded', () => {
    const currentLang = getCurrentLang();
    updateLangDropdownUI(currentLang);
});

// Disconnect Wallet Function
function disconnectWallet() {
    // Disconnect only clears bound flag, keeps credentials for PIN unlock
    walletSession.disconnect();
    const statusEl = document.getElementById('walletStatus');
    const disconnectBtn = document.getElementById('disconnectBtn');
    if (statusEl) statusEl.classList.remove('open');
    if (disconnectBtn) disconnectBtn.style.display = 'none';
    showWalletLoginForm();
    updateWalletUI();
    walletBalancesLoaded = false;
    tokenBalances = {};
}

// Forget Device Function (full wipe)
function forgetDeviceAction() {
    if (confirm('This will remove ALL wallet data from this device. Continue?')) {
        walletSession.forgetDevice();
        updateWalletUI();
        updateHeaderWalletUi();
        walletBalancesLoaded = false;
        tokenBalances = {};
        if (typeof updateHeroButton === 'function') {
            updateHeroButton('');
        }
        location.reload();
    }
}

// Update Wallet UI (login button visibility)
function updateWalletUI() {
    const loginBtn = document.getElementById('walletLoginBtn');
    const addr = walletSession.getAddress();
    const bound = walletSession.isBound();

    if (loginBtn) {
        // Hide login button when wallet is connected (bound)
        if (bound && addr) {
            loginBtn.style.display = 'none';
        } else {
            loginBtn.style.display = 'inline-block';
        }
    }

    if (typeof updateHeaderWalletUi === 'function') {
        updateHeaderWalletUi();
    }
}

// Wallet Balance Widget Functions
let walletBalancesLoaded = false;

async function loadWalletBalances(force = false) {
    if (walletBalancesLoaded && !force) return; // Only load once

    if (!walletSession.isBound()) {
        walletBalancesLoaded = false;
        showWalletLoginForm();
        return;
    }

    const wallet = walletSession.getAddress();
    if (!wallet) {
        showWalletLoginForm();
        return;
    }

    const content = document.getElementById('walletContentSection');
    if (!content) return;

    showWalletContentSection();

    if (force) {
        content.innerHTML = `
            <div class="wallet-popup-header">üíé Wallet Balance</div>
            <div class="wallet-popup-loading">
                <div class="wallet-popup-spinner"></div>
                Loading balances...
            </div>
        `;
    }

    try {
        // Update token prices before loading balances
        await updateTokenPrices();

        const response = await fetch(`/api/wallet/tokens/${wallet}?show_zero=false`);
        if (!response.ok) throw new Error('Failed to load wallet data');

        const data = await response.json();
        renderWalletBalances(data);
        walletBalancesLoaded = true;
    } catch (error) {
        content.innerHTML = `
            <div class="wallet-popup-header">üíé Wallet Balance</div>
            <div style="text-align: center; color: #ff4d4d; font-size: 11px; padding: 10px;">
                Failed to load balances
            </div>
        `;
    }
}

// Token logos and prices registry
const TOKEN_REGISTRY = {
    'THR': {
        name: 'Thronos',
        color: '#ff6600',
        logo: '/static/img/thronos-token.png',
        priceUSD: 0.0042  // Default price, updated from API
    },
    'WBTC': {
        name: 'Wrapped Bitcoin',
        color: '#f7931a',
        logo: '/static/img/wbtc-logo.png',
        priceUSD: 98500  // Approximate BTC price
    },
    'L2E': {
        name: 'Learn-to-Earn',
        color: '#00bfff',
        logo: '/static/img/l2e-logo.png',
        priceUSD: 0.001
    }
};

// Fetch real-time prices (will be called periodically)
async function updateTokenPrices() {
    try {
        const response = await fetch('/api/token/prices');
        const data = await response.json();
        if (data.prices) {
            Object.keys(data.prices).forEach(symbol => {
                if (TOKEN_REGISTRY[symbol]) {
                    TOKEN_REGISTRY[symbol].priceUSD = data.prices[symbol];
                }
            });
        }
    } catch (e) {
        console.log('Using default token prices');
    }
}

function renderWalletBalances(data) {
    const content = document.getElementById('walletContentSection');
    if(!content) return;
    if(!walletSession.isBound()){
        showWalletLoginForm();
        return;
    }

    const wallet = walletSession.getAddress() || '';
    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    const tokensArr = Array.isArray(data?.tokens)
        ? data.tokens
        : (data?.balances ? Object.entries(data.balances).map(([symbol, balance]) => ({ symbol, balance })) : []);

    // Sort: THR first, then non-zero by value, then alphabetically
    const tokens = [...tokensArr].sort((a, b) => {
        const az = String(a.symbol || '');
        const bz = String(b.symbol || '');
        if (az === 'THR') return -1;
        if (bz === 'THR') return 1;
        const an = (Number(a.balance) || 0) > 0 ? 0 : 1;
        const bn = (Number(b.balance) || 0) > 0 ? 0 : 1;
        if (an !== bn) return an - bn;
        return az.localeCompare(bz);
    });

    // Calculate portfolio totals
    const thrPrice = TOKEN_REGISTRY['THR']?.priceUSD || 0.0042;
    const btcPrice = TOKEN_REGISTRY['WBTC']?.priceUSD || 98500;
    let totalUSD = 0;
    let totalTHR = 0;

    tokens.forEach(t => {
        const balance = Number(t.balance) || 0;
        const tokenInfo = TOKEN_REGISTRY[t.symbol] || { priceUSD: 0 };
        const valueUSD = balance * tokenInfo.priceUSD;
        totalUSD += valueUSD;

        // Convert to THR value
        if (t.symbol === 'THR') {
            totalTHR += balance;
        } else if (thrPrice > 0) {
            totalTHR += valueUSD / thrPrice;
        }
    });

    const totalBTC = btcPrice > 0 ? totalUSD / btcPrice : 0;

    // Labels
    const portfolioLabel = isGreek ? 'Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ ŒëŒæŒØŒ±' : 'Portfolio Value';
    const assetsLabel = isGreek ? 'Œ†ŒµœÅŒπŒøœÖœÉŒπŒ±Œ∫Œ¨ Œ£œÑŒøŒπœáŒµŒØŒ±' : 'Assets';
    const sendLabel = isGreek ? 'ŒëœÄŒøœÉœÑŒøŒªŒÆ' : 'Send';
    const receiveLabel = isGreek ? 'ŒõŒÆœàŒ∑' : 'Receive';
    const swapLabel = 'Swap';
    const bridgeLabel = 'Bridge';
    const pledgeLabel = 'Pledge';
    const historyLabel = isGreek ? 'ŒôœÉœÑŒøœÅŒπŒ∫œå' : 'History';
    const noTokensLabel = isGreek ? 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ tokens' : 'No tokens found';

    // Render token rows with logos and values
    const tokenRows = tokens.filter(t => Number(t.balance) > 0).map(t => {
        const balance = Number(t.balance) || 0;
        const symbol = t.symbol;
        const tokenInfo = TOKEN_REGISTRY[symbol] || {
            name: symbol,
            color: '#00ff66',
            logo: null,
            priceUSD: 0
        };
        const valueUSD = balance * tokenInfo.priceUSD;
        const valueTHR = symbol === 'THR' ? balance : (thrPrice > 0 ? valueUSD / thrPrice : 0);

        const logoHtml = tokenInfo.logo
            ? `<img src="${tokenInfo.logo}" alt="${symbol}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <span style="display:none; color:${tokenInfo.color}; font-weight:bold;">${symbol[0]}</span>`
            : `<span style="color:${tokenInfo.color}; font-weight:bold;">${symbol[0]}</span>`;

        return `
            <div class="wallet-token-item" onclick="openTokenInfoModal('${symbol}')" style="cursor: pointer;" title="Click for token details">
                <div class="wallet-token-logo" style="border-color: ${tokenInfo.color}; background: linear-gradient(135deg, ${tokenInfo.color}22 0%, ${tokenInfo.color}11 100%);">
                    ${logoHtml}
                </div>
                <div class="wallet-token-info">
                    <div class="wallet-token-name">
                        ${escapeHtml(tokenInfo.name || symbol)}
                        <span class="wallet-token-symbol">${escapeHtml(symbol)}</span>
                    </div>
                    ${symbol !== 'THR' ? `<div class="wallet-token-thr-value">‚âà ${valueTHR.toFixed(2)} THR</div>` : ''}
                </div>
                <div class="wallet-token-values">
                    <div class="wallet-token-balance">${formatBalance(balance)} ${symbol}</div>
                    <div class="wallet-token-usd">‚âà $${valueUSD.toFixed(2)}</div>
                </div>
            </div>
        `;
    }).join('');

    const shortAddr = wallet ? `${wallet.slice(0, 8)}...${wallet.slice(-6)}` : '';

    const html = `
        <div class="wallet-popup-header">
            <span class="lang-el">Thronos Wallet</span>
            <span class="lang-en">Thronos Wallet</span>
        </div>

        <!-- Address Section -->
        <div class="wallet-popup-address">
            <div class="wallet-popup-address-text" title="${escapeHtml(wallet)}">${escapeHtml(shortAddr)}</div>
            <button class="wallet-popup-copy-btn" onclick="copyToClipboard('${escapeHtml(wallet)}'); this.textContent='‚úì'; setTimeout(()=>this.textContent='Copy', 1500);">Copy</button>
        </div>

        <!-- Portfolio Summary -->
        <div class="wallet-portfolio-summary">
            <div class="wallet-portfolio-label">${portfolioLabel}</div>
            <div class="wallet-portfolio-value">${formatBalance(totalTHR)} THR</div>
            <div class="wallet-portfolio-usd">‚âà $${totalUSD.toFixed(2)} USD</div>
            <div class="wallet-portfolio-btc">
                <span style="font-size: 14px;">‚Çø</span> ${totalBTC.toFixed(8)} BTC
            </div>
        </div>

        <!-- Token List -->
        <div style="font-size: 11px; color: #56ff9a; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">${assetsLabel}</div>
        <div class="wallet-token-list">
            ${tokenRows || `<div style="text-align: center; opacity: 0.6; padding: 20px;">${noTokensLabel}</div>`}
        </div>

        <!-- Quick Actions -->
        <div class="wallet-quick-actions">
            <a href="javascript:void(0)" class="wallet-quick-btn" onclick="openSendModal()">
                <span class="wallet-quick-btn-icon">üí∏</span>
                <span class="wallet-quick-btn-label">${sendLabel}</span>
            </a>
            <a href="javascript:void(0)" class="wallet-quick-btn" onclick="openReceiveModal()">
                <span class="wallet-quick-btn-icon">üì•</span>
                <span class="wallet-quick-btn-label">${receiveLabel}</span>
            </a>
            <a href="/swap" class="wallet-quick-btn">
                <span class="wallet-quick-btn-icon">üîÑ</span>
                <span class="wallet-quick-btn-label">${swapLabel}</span>
            </a>
            <a href="/bridge" class="wallet-quick-btn">
                <span class="wallet-quick-btn-icon">üåâ</span>
                <span class="wallet-quick-btn-label">${bridgeLabel}</span>
            </a>
            <a href="/pledge" class="wallet-quick-btn">
                <span class="wallet-quick-btn-icon">üî•</span>
                <span class="wallet-quick-btn-label">${pledgeLabel}</span>
            </a>
            <a href="javascript:void(0)" class="wallet-quick-btn" onclick="openWalletHistoryModal()">
                <span class="wallet-quick-btn-icon">üìú</span>
                <span class="wallet-quick-btn-label">${historyLabel}</span>
            </a>
        </div>
    `;

    content.innerHTML = html;

    // Apply language after render
    const savedLang = getCurrentLang();
    setLanguage(savedLang);
}

function formatBalance(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
    if (num >= 1) return num.toFixed(4);
    return num.toFixed(6);
}

// Send Modal Functions
let selectedSpeed = 'fast';
let selectedNetwork = 'thronos';
let selectedToken = 'THR';
let tokenBalances = {};

function openSendModal() {
    document.getElementById('sendModal').classList.add('active');
    document.getElementById('sendResult').style.display = 'none';
    document.getElementById('sendTo').value = '';
    document.getElementById('sendAmount').value = '';
    loadTokenBalances();
    loadCustomTokens();
}

function closeSendModal(event) {
    if (!event || event.target.id === 'sendModal') {
        document.getElementById('sendModal').classList.remove('active');
        // Stop any active transaction polling
        if (txPollInterval) {
            clearInterval(txPollInterval);
            txPollInterval = null;
        }
    }
}

function openReceiveModal() {
    updateReceiveModal();
    document.getElementById('receiveModal').classList.add('active');
    const savedLang = getCurrentLang();
    setLanguage(savedLang);
}

function closeReceiveModal(event) {
    if (!event || event.target.id === 'receiveModal') {
        document.getElementById('receiveModal').classList.remove('active');
    }
}

function updateReceiveModal() {
    const addr = walletSession.getAddress() || '';
    const addrEl = document.getElementById('receiveAddress');
    const qrEl = document.getElementById('receiveQr');
    const audioEl = document.getElementById('receiveAudio');
    const dlEl = document.getElementById('receiveDownload');
    const emptyEl = document.getElementById('receiveEmpty');
    const hintEl = document.getElementById('receiveQrHint');

    if (!addr) {
        if (addrEl) addrEl.textContent = '‚Äî';
        if (qrEl) qrEl.style.display = 'none';
        if (audioEl) audioEl.removeAttribute('src');
        if (dlEl) dlEl.removeAttribute('href');
        if (emptyEl) emptyEl.style.display = 'block';
        if (hintEl) hintEl.style.display = 'none';
        return;
    }

    const qrUrl = `/api/wallet/qr/${encodeURIComponent(addr)}`;
    const audioUrl = `/api/wallet/audio/${encodeURIComponent(addr)}`;

    if (addrEl) addrEl.textContent = addr;
    if (qrEl) {
        qrEl.src = qrUrl;
        qrEl.style.display = 'inline';
    }
    if (audioEl) {
        audioEl.src = audioUrl;
        audioEl.load();
    }
    if (dlEl) dlEl.href = audioUrl;
    if (emptyEl) emptyEl.style.display = 'none';
    if (hintEl) hintEl.style.display = 'block';
}

function copyReceiveAddress() {
    const addr = walletSession.getAddress();
    if (!addr) return;
    copyToClipboard(addr);
}

function playReceiveAudio() {
    const audioEl = document.getElementById('receiveAudio');
    if (audioEl && audioEl.src) {
        audioEl.play();
    }
}

// Wallet History Modal Functions
let allTransactions = [];
let currentHistoryFilter = 'all';
let currentTokenFilter = null;

function resetHistoryFilters() {
    currentHistoryFilter = 'all';
    currentTokenFilter = null;
    const tokenIndexBar = document.getElementById('tokenIndexBar');
    if (tokenIndexBar) tokenIndexBar.style.display = 'none';
}

function openWalletHistoryModal() {
    document.getElementById('walletHistoryModal').classList.add('active');
    resetHistoryFilters();
    filterHistory('all');
    loadWalletHistory();
}

function closeWalletHistoryModal(event) {
    if (!event || event.target.id === 'walletHistoryModal') {
        document.getElementById('walletHistoryModal').classList.remove('active');
        resetHistoryFilters();
    }
}

function filterHistory(filter, tokenSymbol = null) {
    currentHistoryFilter = filter;
    if (filter !== 'token') {
        currentTokenFilter = null;
    } else if (tokenSymbol) {
        currentTokenFilter = tokenSymbol;
    }

    // Update tab button styles
    document.querySelectorAll('.history-tab-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
            btn.style.background = 'rgba(0,255,102,0.2)';
            btn.style.borderColor = 'rgba(0,255,102,0.4)';
            btn.classList.add('active');
        } else {
            btn.style.background = 'rgba(0,255,102,0.05)';
            btn.style.borderColor = 'rgba(0,255,102,0.2)';
            btn.classList.remove('active');
        }
    });

    renderHistory();
}

function getTxType(tx) {
    const raw = (tx.kind || tx.type || '').toLowerCase();
    const asset = (tx.asset_symbol || tx.asset || tx.symbol || 'THR').toUpperCase();

    // THR transfers: must be transfer/thr_transfer AND asset must be THR
    if ((raw === 'thr_transfer' || raw === 'transfer') && asset === 'THR') {
        return 'thr';
    }

    // Token transfers: must be token_transfer AND asset must NOT be THR
    if (raw === 'token_transfer' && asset !== 'THR') {
        return 'token';
    }

    // Liquidity events
    if (raw.startsWith('liquidity_') ||
        raw === 'add_liquidity' ||
        raw === 'remove_liquidity' ||
        raw === 'pool_add_liquidity' ||
        raw === 'pool_remove_liquidity') {
        return 'liquidity';
    }

    const kindMap = {
        'swap': 'swap',
        'pool_swap': 'swap',
        'bridge': 'bridge',
        'l2e': 'l2e',
        'ai_credit': 'ai_credits',
        'ai_credits': 'ai_credits',
        'iot': 'iot',
        'autopilot': 'iot',
        'parking': 'iot',
        'architect_job': 'architect',
        'architect': 'architect',
        'music': 'music',
        'fiat_onramp': 'gateway',
        'fiat_offramp': 'gateway',
        'gateway': 'gateway',
        'onramp': 'gateway',
        'offramp': 'gateway',
    };
    if (kindMap[raw]) return kindMap[raw];

    // Fallback: use already-declared asset variable from line 2305
    if (asset && asset !== 'THR') return 'token';
    return 'thr';
}

function formatTxDate(timestamp) {
    try {
        let date;
        if (typeof timestamp === 'number') {
            // Unix timestamp (seconds or milliseconds)
            date = timestamp > 10000000000 ? new Date(timestamp) : new Date(timestamp * 1000);
        } else if (typeof timestamp === 'string') {
            const numeric = Number(timestamp);
            if (!Number.isNaN(numeric)) {
                date = numeric > 10000000000 ? new Date(numeric) : new Date(numeric * 1000);
            } else {
                date = new Date(timestamp);
            }
        } else {
            return '';
        }

        if (isNaN(date.getTime())) {
            return timestamp ? String(timestamp) : '';
        }

        return date.toLocaleString();
    } catch (e) {
        return timestamp ? String(timestamp) : '';
    }
}

function buildTokenIndexData() {
    const counts = {};
    allTransactions.forEach(tx => {
        if (getTxType(tx) === 'token') {
            const sym = (tx.symbol || '').toUpperCase() || 'TOKEN';
            counts[sym] = (counts[sym] || 0) + 1;
        }
    });

    const select = document.getElementById('sendToken');
    if (select) {
        Array.from(select.options).forEach(opt => {
            const sym = (opt.value || '').toUpperCase();
            if (sym && sym !== 'THR' && counts[sym] === undefined) {
                counts[sym] = 0;
            }
        });
    }

    return Object.keys(counts)
        .sort((a, b) => a.localeCompare(b))
        .map(sym => ({ symbol: sym, count: counts[sym] }));
}

function renderTokenIndex() {
    const scroll = document.getElementById('tokenIndexScroll');
    const bar = document.getElementById('tokenIndexBar');
    if (!scroll || !bar) return false;

    const tokens = buildTokenIndexData();
    if (!tokens || tokens.length === 0) {
        scroll.innerHTML = '<div style="opacity:0.7; font-size:11px;">No tokens detected</div>';
        return false;
    }

    let html = '';
    tokens.forEach(token => {
        const isActive = currentTokenFilter && currentTokenFilter.toUpperCase() === token.symbol;
        const badge = `<span style="background:rgba(0,255,102,0.2); color:#00ff66; padding:1px 5px; border-radius:8px; font-size:9px;">${token.count}</span>`;
        const chipStyle = isActive
            ? 'background:rgba(0,255,102,0.25); border-color:rgba(0,255,102,0.6); color:#00ff66;'
            : 'background:rgba(0,255,102,0.08); border-color:rgba(0,255,102,0.25); color:#00ff66;';

        html += `<button class="history-tab-btn" style="flex:0 0 auto; min-width:70px; padding:6px 8px; display:flex; align-items:center; gap:6px; ${chipStyle}" onclick="filterHistory('token','${token.symbol}')">`;
        html += `<span style="width:20px; height:20px; border-radius:50%; background: rgba(0,255,102,0.15); display:flex; align-items:center; justify-content:center; font-weight:bold;">${escapeHtml(token.symbol[0] || '?')}</span>`;
        html += `<span style="font-size:11px;">${escapeHtml(token.symbol)}</span>${badge}`;
        html += `</button>`;
    });

    scroll.innerHTML = html;
    return true;
}

function clearTokenFilter() {
    currentTokenFilter = null;
    filterHistory('token');
}

function shareTokenFilter() {
    const token = currentTokenFilter;
    const text = token ? `#history=tokens&token=${encodeURIComponent(token)}` : '#history=tokens';
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
    } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Copied to clipboard');
    }
}

function renderHistory() {
    const content = document.getElementById('historyContent');
    const addr = walletSession.getAddress();
    const tokenIndexBar = document.getElementById('tokenIndexBar');

    if (currentHistoryFilter !== 'token') {
        currentTokenFilter = null;
    }

    if (!allTransactions || allTransactions.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No transactions found</div>';
        return;
    }

    if (currentHistoryFilter === 'token') {
        const hasTokens = renderTokenIndex();
        if (tokenIndexBar) tokenIndexBar.style.display = hasTokens ? 'block' : 'none';
    } else if (tokenIndexBar) {
        tokenIndexBar.style.display = 'none';
    }

    // Filter transactions
    let filtered = allTransactions;
    if (currentHistoryFilter !== 'all') {
        filtered = allTransactions.filter(tx => getTxType(tx) === currentHistoryFilter);
    }

    if (currentHistoryFilter === 'token' && currentTokenFilter) {
        filtered = filtered.filter(tx => (tx.symbol || '').toUpperCase() === currentTokenFilter.toUpperCase());
    }

    if (filtered.length === 0) {
        content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No transactions in this category</div>';
        return;
    }

    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

    filtered.slice(0, 50).forEach(tx => {
        const isSent = tx.from === addr;
        const direction = isSent ? (isGreek ? 'ŒëœÄŒøœÉœÑŒøŒªŒÆ' : 'Sent') : (isGreek ? 'ŒõŒÆœàŒ∑' : 'Received');
        const directionIcon = isSent ? 'üì§' : 'üì•';
        const directionColor = isSent ? '#ff6666' : '#66ff66';

        const otherAddr = isSent ? tx.to : tx.from;
        const shortAddr = otherAddr ? `${otherAddr.slice(0, 8)}...${otherAddr.slice(-6)}` : 'N/A';

        const statusValue = (tx.status || '').toLowerCase();
        const isMined = statusValue === 'confirmed' || statusValue === 'mined';
        const isRejected = statusValue === 'rejected' || statusValue === 'failed';
        const statusBadge = isMined
            ? `<span style="background: #00ff0033; color: #00ff00; padding: 2px 6px; border-radius: 4px; font-size: 10px;">‚úì ${isGreek ? 'ŒïœÄŒπŒ≤ŒµŒ≤Œ±ŒπœéŒ∏Œ∑Œ∫Œµ' : 'Confirmed'}</span>`
            : isRejected
            ? `<span style="background: #ff333333; color: #ff6666; padding: 2px 6px; border-radius: 4px; font-size: 10px;">‚úï ${isGreek ? 'ŒëœÄŒøœÅœÅŒØœÜŒ∏Œ∑Œ∫Œµ' : 'Rejected'}</span>`
            : `<span style="background: #ffff0033; color: #ffff00; padding: 2px 6px; border-radius: 4px; font-size: 10px;">‚è≥ ${isGreek ? 'ŒïŒ∫Œ∫œÅŒµŒºŒµŒØ' : 'Pending'}</span>`;

        const txType = getTxType(tx);
        const typeLabel = txType === 'l2e' ? 'L2E' :
                         txType === 'ai_credits' ? 'AI Credits' :
                         txType === 'architect' ? 'Architect' :
                         txType === 'iot' ? 'IoT' :
                         txType === 'bridge' ? 'Bridge' :
                         txType === 'swap' ? 'Swap' :
                         txType === 'liquidity' ? 'Liquidity' :
                         txType === 'gateway' ? 'Gateway' : '';
        const isSwap = txType === 'swap';
        const isLiquidity = txType === 'liquidity';
        const amountInRaw = tx.amount_in ?? tx.amountIn ?? tx.input_amount ?? tx.amount ?? 0;
        const amountIn = Number.isFinite(Number(amountInRaw)) ? Number(amountInRaw) : 0;
        const amountOut = tx.amount_out ?? tx.amountOut ?? tx.output_amount ?? tx.received_amount;
        const amountOutNum = (amountOut !== undefined && Number.isFinite(Number(amountOut))) ? Number(amountOut) : null;

        // Determine correct asset symbol for display
        const displayAsset = txType === 'token'
            ? (tx.asset_symbol || tx.asset || tx.symbol || 'TOKEN')
            : (tx.symbol || tx.asset_symbol || tx.asset || 'THR');

        const amountDisplay = isSwap
            ? `${amountIn.toFixed(6)} ${tx.symbol_in || tx.from_symbol || tx.symbol || 'THR'}${amountOutNum !== null ? ` ‚Üí ${amountOutNum.toFixed(6)} ${tx.symbol_out || tx.to_symbol || tx.target_symbol || tx.swap_out || ''}` : ''}`
            : isLiquidity
            ? `${amountIn.toFixed(6)} ${tx.symbol_in || tx.token_a || 'THR'}${amountOutNum !== null ? ` + ${amountOutNum.toFixed(6)} ${tx.symbol_out || tx.token_b || ''}` : ''}`
            : `${Number(amountInRaw || 0).toFixed(6)} ${displayAsset}`;
        const swapPair = isSwap ? (tx.pair || tx.route || `${(tx.swap_in || tx.from_symbol || tx.symbol || '?')}${tx.swap_out || tx.to_symbol || tx.target_symbol ? `/${tx.swap_out || tx.to_symbol || tx.target_symbol}` : ''}`) : '';
        const swapDirection = isSwap ? (tx.direction || tx.side || '') : '';

        // Fee information
        const fee = tx.fee_burned || tx.fee || 0;
        const feeDisplay = fee > 0 ? `<br><span style="font-size: 10px; opacity: 0.6;">${isGreek ? 'ŒöœåœÉœÑŒøœÇ:' : 'Fee:'} ${fee} THR</span>` : '';

        // Pool/liquidity info
        let poolInfo = '';
        if (isLiquidity) {
            const raw = (tx.kind || tx.type || '').toLowerCase();
            const action = raw.includes('add') ? (isGreek ? 'Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ Œ°ŒµœÖœÉœÑœåœÑŒ∑œÑŒ±œÇ' : 'Add Liquidity') : (isGreek ? 'ŒëœÜŒ±ŒØœÅŒµœÉŒ∑ Œ°ŒµœÖœÉœÑœåœÑŒ∑œÑŒ±œÇ' : 'Remove Liquidity');
            poolInfo = `<div style="font-size: 11px; color: #00bfff; opacity: 0.85; margin-top: 4px;">${action}</div>`;
        } else if (isSwap && tx.meta) {
            const fromAsset = tx.meta.from_asset || tx.symbol || 'THR';
            const toAsset = tx.meta.to_asset || 'THR';
            poolInfo = `<div style="font-size: 11px; color: #00bfff; opacity: 0.85; margin-top: 4px;">Swap: ${escapeHtml(fromAsset)} ‚Üí ${escapeHtml(toAsset)}</div>`;
        }

        // Token price info
        const priceInfo = (tx.meta && tx.meta.token_price_thr)
            ? `<br><span style="font-size: 10px; opacity: 0.6;">${isGreek ? 'Œ§ŒπŒºŒÆ:' : 'Price:'} ${tx.meta.token_price_thr} THR per ${tx.asset_symbol || tx.symbol}</span>`
            : '';

        html += `
            <div style="background: rgba(0,255,102,0.05); border: 1px solid rgba(0,255,102,0.2); border-radius: 8px; padding: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${directionIcon}</span>
                        <span style="color: ${directionColor}; font-weight: bold;">${direction}</span>
                        ${typeLabel ? `<span style="background: rgba(0,191,255,0.2); color: #00bfff; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${typeLabel}</span>` : ''}
                        ${statusBadge}
                    </div>
                    <div style="font-weight: bold; color: #00ff66;">${amountDisplay}</div>
                </div>
                <div style="font-size: 11px; opacity: 0.7;">
                    ${isSent ? (isGreek ? 'Œ†œÅŒøœÇ:' : 'To:') : (isGreek ? 'ŒëœÄœå:' : 'From:')} ${shortAddr}${feeDisplay}${priceInfo}
                </div>
                ${poolInfo}
                ${isSwap && swapPair ? `<div style="font-size: 11px; opacity: 0.75; margin-top: 4px;">${isGreek ? 'ŒñŒµœçŒ≥ŒøœÇ:' : 'Pair:'} ${escapeHtml(swapPair || 'Unknown pair')}${swapDirection ? ` ‚Ä¢ ${escapeHtml(swapDirection)}` : ''}</div>` : ''}
                ${tx.timestamp ? `<div style="font-size: 10px; opacity: 0.5; margin-top: 4px;">${formatTxDate(tx.timestamp)}</div>` : ''}
            </div>
        `;
    });

    html += '</div>';
    content.innerHTML = html;
}

async function loadWalletHistory() {
    const content = document.getElementById('historyContent');
    const addr = walletSession.getAddress();

    if (!addr) {
        content.innerHTML = '<div class="send-result error" style="margin: 20px;">Connect wallet to view history</div>';
        return;
    }

    try {
        const historyRes = await fetch(`/api/history?wallet=${encodeURIComponent(addr)}`);
        const data = historyRes.ok ? await historyRes.json() : {};
        const transactions = data.history || [];
        if (!transactions || transactions.length === 0) {
            content.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.7;">No transactions found</div>';
            allTransactions = [];
            return;
        }

        allTransactions = transactions;
        renderHistory();
        startHistoryPendingPolling();

    } catch (error) {
        console.error('Failed to load history:', error);
        content.innerHTML = '<div class="send-result error" style="margin: 20px;">Failed to load transaction history</div>';
    }
}

// Bridge Modal Functions
function openBridgeModal() {
    document.getElementById('bridgeModal').classList.add('active');
    loadBridgeDeposit();
}

function closeBridgeModal(event) {
    if (!event || event.target.id === 'bridgeModal') {
        document.getElementById('bridgeModal').classList.remove('active');
    }
}

async function loadBridgeDeposit() {
    const addr = walletSession.getAddress();
    const depositEl = document.getElementById('bridgeDepositAddress');
    const emptyEl = document.getElementById('bridgeEmpty');

    if (!addr) {
        if (depositEl) depositEl.textContent = '‚Äî';
        if (emptyEl) emptyEl.style.display = 'block';
        return;
    }

    try {
        const response = await fetch(`/api/bridge/deposit?wallet=${encodeURIComponent(addr)}`);
        const data = await response.json();

        if (data.deposit_address) {
            if (depositEl) depositEl.textContent = data.deposit_address;
            if (emptyEl) emptyEl.style.display = 'none';
        } else {
            if (depositEl) depositEl.textContent = '‚Äî';
            if (emptyEl) emptyEl.style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load bridge deposit:', error);
        if (depositEl) depositEl.textContent = 'Error loading address';
        if (emptyEl) emptyEl.style.display = 'block';
    }
}

function copyBridgeAddress() {
    const addr = document.getElementById('bridgeDepositAddress').textContent;
    if (addr && addr !== '‚Äî') {
        copyToClipboard(addr);
    }
}

function selectSpeed(speed) {
    selectedSpeed = speed;
    document.querySelectorAll('.send-speed-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`[data-speed="${speed}"]`).classList.add('selected');
}

function selectNetwork(network) {
    if (network === 'bitcoin') {
        openBridgeModal();
        return;
    }
    selectedNetwork = network;
    document.querySelectorAll('.send-network-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`[data-network="${network}"]`).classList.add('selected');

    // Update recipient placeholder based on network
    const toInput = document.getElementById('sendTo');
    if (network === 'thronos') {
        toInput.placeholder = 'THR...';
    } else {
        toInput.placeholder = 'bc1... or 1... or 3...';
    }
}

async function loadTokenBalances() {
    const wallet = walletSession.getAddress();
    if (!wallet) return;

    try {
        const response = await fetch(`/api/wallet/tokens/${wallet}?show_zero=true`);
        const data = await response.json();
        if (data.tokens) {
            // Update balances map
            data.tokens.forEach(t => {
                tokenBalances[t.symbol] = t.balance;
            });

            // Ensure token selector has *all* tokens that appear in balances (not only registry tokens)
            const select = document.getElementById('sendToken');
            const existing = new Set(Array.from(select.options).map(o => o.value));

            // Prefer THR first, then rest alphabetically
            const sorted = [...data.tokens].sort((a, b) => {
                if (a.symbol === 'THR') return -1;
                if (b.symbol === 'THR') return 1;
                return String(a.symbol).localeCompare(String(b.symbol));
            });

            sorted.forEach(t => {
                if (!existing.has(t.symbol)) {
                    const option = document.createElement('option');
                    option.value = t.symbol;
                    option.textContent = t.symbol;
                    select.appendChild(option);
                    existing.add(t.symbol);
                }
            });

            updateTokenInfo();
        }
    } catch (e) {
        console.error('Failed to load token balances:', e);
    }
}
async function loadCustomTokens() {
    try {
        const response = await fetch('/api/tokens/list');
        const data = await response.json();
        if (data.ok && data.tokens) {
            const select = document.getElementById('sendToken');
            // Add custom tokens to select
            data.tokens.forEach(token => {
                if (!select.querySelector(`option[value="${token.symbol}"]`)) {
                    const option = document.createElement('option');
                    option.value = token.symbol;
                    option.dataset.color = token.color || '#00ff66';
                    option.textContent = `${token.symbol} - ${token.name}`;
                    select.appendChild(option);
                }
            });
        }
    } catch (e) {
        console.log('No custom tokens available');
    }
}

function updateTokenInfo() {
    const select = document.getElementById('sendToken');
    selectedToken = select.value;
    const balance = tokenBalances[selectedToken] || 0;
    document.getElementById('availableBalance').textContent = balance.toFixed(6) + ' ' + selectedToken;
}

function setMaxAmount() {
    const balance = tokenBalances[selectedToken] || 0;
    // Reserve a small amount for fees
    const feeReserve = selectedSpeed === 'slow' ? balance * 0.001 : balance * 0.006;
    const maxAmount = Math.max(0, balance - feeReserve);
    document.getElementById('sendAmount').value = maxAmount.toFixed(6);
}

function generateClientTxId() {
    if (crypto && typeof crypto.randomUUID === 'function') {
        return `thr-${crypto.randomUUID()}`;
    }
    return `thr-${Date.now()}-${Math.random().toString(16).slice(2, 10)}`;
}

// Transaction status polling
let txPollInterval = null;
let historyPollInterval = null;

async function refreshHistoryFromApi() {
    const addr = walletSession.getAddress();
    if (!addr) return;
    try {
        const response = await fetch(`/api/history?wallet=${encodeURIComponent(addr)}`);
        const data = response.ok ? await response.json() : {};
        if (Array.isArray(data.history)) {
            allTransactions = data.history;
            renderHistory();
        }
    } catch (error) {
        console.error('Failed to refresh history:', error);
    }
}

function startHistoryPendingPolling() {
    if (historyPollInterval) {
        clearInterval(historyPollInterval);
    }
    refreshHistoryFromApi();
    historyPollInterval = setInterval(refreshHistoryFromApi, 10000);
}

async function pollTransactionStatus(txid, resultDiv) {
    let pollCount = 0;
    const maxPolls = 60; // 10 minutes max (60 * 10s)

    // Clear any existing poll
    if (txPollInterval) {
        clearInterval(txPollInterval);
    }

    const checkStatus = async () => {
        try {
            const response = await fetch(`/api/tx_status/${encodeURIComponent(txid)}`);
            const data = await response.json();

            const statusIndicator = document.getElementById('txStatusIndicator');
            if (!statusIndicator) {
                // Modal closed, stop polling
                clearInterval(txPollInterval);
                return;
            }

            const status = (data.status || '').toLowerCase();
            if (status === 'mined' || status === 'confirmed' || data.confirmed) {
                statusIndicator.textContent = '‚úì Confirmed!';
                statusIndicator.style.color = '#00ff00';
                clearInterval(txPollInterval);

                // Close modal after 2 seconds
                setTimeout(() => {
                    closeSendModal();
                }, 2000);
            } else if (status === 'rejected' || status === 'failed') {
                const reason = data.reason ? ` (${data.reason})` : '';
                statusIndicator.textContent = `‚úï Transaction failed${reason}`;
                statusIndicator.style.color = '#ff6666';
                clearInterval(txPollInterval);
            } else {
                // Still pending
                pollCount++;
                if (pollCount >= maxPolls) {
                    statusIndicator.textContent = '‚è± Confirmation pending (check history later)';
                    statusIndicator.style.color = '#ffaa00';
                    clearInterval(txPollInterval);

                    setTimeout(() => {
                        closeSendModal();
                    }, 3000);
                }
            }
        } catch (error) {
            console.error('Status poll error:', error);
            // Don't stop polling on network errors, just continue
        }
    };

    // Initial check immediately
    await checkStatus();

    // Then poll every 10 seconds
    txPollInterval = setInterval(checkStatus, 10000);
}

async function submitSend() {
    const to = document.getElementById('sendTo').value.trim();
    const amount = parseFloat(document.getElementById('sendAmount').value);
    const token = document.getElementById('sendToken').value;
    const from = walletSession.getAddress();
    const secret = walletSession.getSendSeed();
    const resultDiv = document.getElementById('sendResult');
    const clientTxId = generateClientTxId();

    if (!walletSession.isBound()) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = 'Wallet not connected';
        resultDiv.style.display = 'block';
        return;
    }

    if (!to || !amount || amount <= 0) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = 'Please enter valid recipient and amount';
        resultDiv.style.display = 'block';
        return;
    }

    if (!from || !secret) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = 'Wallet not connected';
        resultDiv.style.display = 'block';
        return;
    }

    // Validate balance
    const balance = tokenBalances[token] || 0;
    if (amount > balance) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = `Insufficient ${token} balance`;
        resultDiv.style.display = 'block';
        return;
    }

    if(!walletSession.requirePin('send tokens')) return;

    try {
        // Calculate fee based on selected speed
        const feeRate = selectedSpeed === 'slow' ? 0.0009 : 0.005;
        let fee = Math.max(0.001, amount * feeRate);
        fee = parseFloat(fee.toFixed(6));

        let response;

        if (token === 'THR') {
            // Native THR send
            const payload = {
                from_thr: from,
                to_thr: to,
                amount: amount,
                auth_secret: secret,
                speed: selectedSpeed,
                tx_id: clientTxId,
                expected_fee: fee
            };
            response = await fetch('/send_thr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            // Custom token transfer - backend expects: from, to, symbol, amount
            const payload = {
                symbol: token,
                from: from,
                to: to,
                amount: amount,
                auth_secret: secret,
                speed: selectedSpeed // optional fee tier hint
            };
            response = await fetch('/api/tokens/transfer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        const data = await response.json();

        if (data.accepted === false || data.status === 'rejected' || data.error || data.ok === false) {
            resultDiv.className = 'send-result error';
            // Check for specific error about THR balance for fees
            let errorMsg = data.reject_reason || data.error || data.message || 'Transaction failed';
            if (data.thr_balance !== undefined && data.fee_required !== undefined) {
                errorMsg = `${errorMsg}. THR balance: ${data.thr_balance}, Fee required: ${data.fee_required} THR`;
            }
            resultDiv.textContent = `Error: ${errorMsg}`;
            resultDiv.style.display = 'block';
        } else {
            // Show pending status with txid
            const actualFee = data.fee_burned || data.fee || fee;
            const txid = data.tx_id || (data.tx && data.tx.tx_id) || data.txid || clientTxId || 'pending';
            const shortTxid = txid.length > 16 ? `${txid.slice(0, 8)}...${txid.slice(-8)}` : txid;

            resultDiv.className = 'send-result success';
            resultDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div>‚è≥ ${amount} ${token} sent! Fee: ${actualFee.toFixed(6)} THR</div>
                    <div style="font-size: 11px; opacity: 0.8;">TX: ${shortTxid}</div>
                    <div id="txStatusIndicator" style="font-size: 11px; color: #ffff00;">‚è≥ Pending confirmation...</div>
                </div>
            `;
            resultDiv.style.display = 'block';

            // Reset wallet balances to reload
            walletBalancesLoaded = false;
            tokenBalances = {};

            // Reload balances
            setTimeout(() => {
                loadTokenBalances();
                loadWalletBalances(true);
            }, 1000);

            // Start polling for transaction status if we have a txid
            if (txid && txid !== 'pending') {
                pollTransactionStatus(txid, resultDiv);
            } else {
                // If no txid, close after 3 seconds
                setTimeout(() => {
                    closeSendModal();
                }, 3000);
            }
        }
    } catch (error) {
        resultDiv.className = 'send-result error';
        resultDiv.textContent = `Error: ${error.message}`;
        resultDiv.style.display = 'block';
    }
}



// --- Wallet UI lock/pin (prevents "vanishing" on hover and adds optional PIN unlock) ---
const WALLET_UI_PINNED_KEY = 'thr_wallet_ui_pinned';
const WALLET_PIN_HASH_KEY  = 'thr_wallet_pin_hash';
const WALLET_LAST_ACTIVE_KEY = 'thr_wallet_last_active';
const WALLET_IDLE_LOCK_MS = 20 * 60 * 1000; // 20 minutes

function _nowMs(){ return Date.now(); }

async function sha256Hex(str){
    try {
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    } catch(e) {
        // Fallback (no crypto.subtle) - not ideal, but better than breaking UX
        return 'plain:' + String(str);
    }
}

function getWalletUiPinned(){
    return localStorage.getItem(WALLET_UI_PINNED_KEY) === '1';
}
function setWalletUiPinned(v){
    localStorage.setItem(WALLET_UI_PINNED_KEY, v ? '1' : '0');
}

function markWalletActive(){
    localStorage.setItem(WALLET_LAST_ACTIVE_KEY, String(_nowMs()));
}
function isWalletStale(){
    const last = parseInt(localStorage.getItem(WALLET_LAST_ACTIVE_KEY) || '0', 10);
    return !last || (_nowMs() - last) > WALLET_IDLE_LOCK_MS;
}

async function ensureWalletPinSet(){
    const existing = localStorage.getItem(WALLET_PIN_HASH_KEY);
    if(existing) return true;
    const pin1 = prompt('Set a wallet PIN (4-8 digits). Keep it safe.');
    if(!pin1) return false;
    if(!/^\d{4,8}$/.test(pin1)) { alert('PIN must be 4-8 digits.'); return false; }
    const pin2 = prompt('Confirm PIN');
    if(pin1 !== pin2){ alert('PINs do not match.'); return false; }
    const h = await sha256Hex(pin1);
    localStorage.setItem(WALLET_PIN_HASH_KEY, h);
    markWalletActive();
    return true;
}

async function ensureWalletUnlocked(){
    // If idle too long, require PIN (if set)
    const hash = localStorage.getItem(WALLET_PIN_HASH_KEY);
    if(!hash) return true; // no pin set
    if(!isWalletStale()) return true;
    const pin = prompt('Wallet locked (idle). Enter PIN to continue.');
    if(!pin) return false;
    const h = await sha256Hex(pin);
    if(h !== hash){ alert('Wrong PIN.'); return false; }
    markWalletActive();
    return true;
}

function setWalletOpen(open){
    const statusEl = document.getElementById('walletStatus');
    if(!statusEl) return;
    if(open) statusEl.classList.add('open');
    else statusEl.classList.remove('open');
}

function isWalletOpen(){
    const statusEl = document.getElementById('walletStatus');
    return !!statusEl && statusEl.classList.contains('open');
}

function initWalletUiControls(){
    const statusEl = document.getElementById('walletStatus');
    const pinBtn = document.getElementById('walletPinBtn');
    const lockBtn = document.getElementById('walletLockBtn');
    if(!statusEl) return;

    // Reflect pinned state
    if(pinBtn){
        if(getWalletUiPinned()) pinBtn.classList.add('active');
        pinBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const next = !getWalletUiPinned();
            setWalletUiPinned(next);
            pinBtn.classList.toggle('active', next);
        });
    }

    if(lockBtn){
        lockBtn.addEventListener('click', async (ev)=>{
            ev.stopPropagation();
            const ok = await ensureWalletPinSet();
            if(ok) alert('PIN set. Wallet will auto-lock after inactivity.');
        });
    }

    // Click-to-toggle wallet popup (stays open until closed)
    statusEl.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const ok = await ensureWalletUnlocked();
        if(!ok) return;
        const nextOpen = !isWalletOpen();
        setWalletOpen(nextOpen);
        if(nextOpen) await loadWalletBalances();
        markWalletActive();
    });

    // Close on outside click, unless pinned (with delay to prevent immediate close)
    setTimeout(() => {
        document.addEventListener('click', (e)=>{
            if(getWalletUiPinned()) return;
            const popup = document.getElementById('walletBalancePopup');
            if(!popup || !statusEl) return;
            // Don't close if clicking inside the popup or status element
            if(statusEl.contains(e.target) || popup.contains(e.target)) return;
            setWalletOpen(false);
        });
    }, 100);
}

function showWalletLoginForm(){
    const loginSection = document.getElementById('walletLoginSection');
    const contentSection = document.getElementById('walletContentSection');
    if(loginSection){
        loginSection.style.display = 'block';
        const addrInput = document.getElementById('walletWidgetAddress');
        const secretInput = document.getElementById('walletWidgetSecret');
        const pinInput = document.getElementById('walletWidgetPin');
        if(addrInput) addrInput.value = walletSession.getAddress();
        if(secretInput) secretInput.value = walletSession.getSendSeed();
        if(pinInput) pinInput.value = walletSession.getPin();
        setTimeout(()=>{ if(addrInput) addrInput.focus(); }, 50);
    }
    if(contentSection) contentSection.style.display = 'none';
}

function showWalletContentSection(){
    const loginSection = document.getElementById('walletLoginSection');
    const contentSection = document.getElementById('walletContentSection');
    if(loginSection) loginSection.style.display = 'none';
    if(contentSection) contentSection.style.display = 'block';
}

function openHeaderWalletModal(){
    const addr = walletSession.getAddress();
    const pin = walletSession.getPin();

    // If device has credentials (address + PIN), do PIN-only unlock
    if (addr && pin && !walletSession.isBound()) {
        const entered = prompt('Enter PIN to unlock wallet');
        if (entered === null) return; // User cancelled
        if (entered === pin) {
            walletSession.setBound(true);
            setWalletOpen(true);
            showWalletContentSection();
            loadWalletBalances(true);
            updateWalletUI();
        } else {
            alert('Wrong PIN');
        }
        return;
    }

    // Otherwise show modal
    setWalletOpen(true);
    if(!walletSession.isBound()){
        showWalletLoginForm();
    } else {
        showWalletContentSection();
        loadWalletBalances(true);
    }
}

function closeHeaderWalletModal(){
    setWalletOpen(false);
}

async function submitHeaderWalletLogin(){
    const existingAddress = walletSession.getAddress();
    const existingSeed = walletSession.getSendSeed();

    const address = (document.getElementById('walletWidgetAddress')?.value || '').trim() || existingAddress;
    const seed = (document.getElementById('walletWidgetSecret')?.value || '').trim() || existingSeed;
    const pin = (document.getElementById('walletWidgetPin')?.value || '').trim();
    if (!address) {
        alert('Please enter a THR address.');
        return;
    }

    // Store session (reuse saved address/seed when logging in with PIN-only)
    walletSession.saveSession({ address, sendSeed: seed, pin, bound: true });

    // Sync the PIN with the wallet lock so PIN-only unlock works with the header widget
    if (pin) {
        const h = await sha256Hex(pin);
        localStorage.setItem(WALLET_PIN_HASH_KEY, h);
        markWalletActive();
    } else {
        localStorage.removeItem(WALLET_PIN_HASH_KEY);
    }

    showWalletContentSection();
    updateHeaderWalletUi();
    updateWalletUI();
    loadTokenBalances();
    loadWalletBalances(true);
    updateReceiveModal();
    if (typeof updateHeroButton === 'function') {
        updateHeroButton(address);
    }
}

function updateHeaderWalletUi(){
    const wallet = walletSession.getAddress();
    const bound = walletSession.isBound();
    const statusEl = document.getElementById('walletStatus');
    const disconnectEl = document.getElementById('disconnectBtn');
    const loginBtn = document.getElementById('walletLoginBtn');

    const hasWallet = bound && wallet;
    const short = hasWallet ? wallet.substring(0, 6) + '...' + wallet.substring(wallet.length - 4) : 'Connect';

    if(statusEl){
        document.getElementById('walletAddrShort').textContent = short;
        statusEl.style.display = 'flex';
        if(!statusEl.dataset.init){
            initWalletUiControls();
            statusEl.dataset.init = '1';
        }
    }

    if(disconnectEl) disconnectEl.style.display = hasWallet ? 'block' : 'none';
    // Hide login button when wallet is connected
    if(loginBtn) loginBtn.style.display = hasWallet ? 'none' : 'inline-block';

    if(hasWallet){
        const isPinned = getWalletUiPinned();
        const hasOpenedBefore = sessionStorage.getItem('wallet_opened_once');
        if (isPinned || !hasOpenedBefore) {
            setTimeout(() => {
                setWalletOpen(true);
                loadWalletBalances();
                sessionStorage.setItem('wallet_opened_once', '1');
            }, 500);
        }
    } else {
        setWalletOpen(false);
        showWalletLoginForm();
        walletBalancesLoaded = false;
    }
}

// Initialize language and wallet status on load
document.addEventListener('DOMContentLoaded', () => {
    const savedLang = getCurrentLang();
    setLanguage(savedLang);
    updateHeaderWalletUi();

    // Update token prices every 30 seconds
    updateTokenPrices();  // Initial update
    setInterval(updateTokenPrices, 30000);

    // Refresh wallet balances every 60 seconds if wallet is open
    setInterval(() => {
        if (walletSession.isBound() && isWalletOpen()) {
            loadWalletBalances(true);
        }
    }, 60000);
});

// ‚îÄ‚îÄ‚îÄ TOKEN INFO MODAL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tokenInfoCache = {};

async function openTokenInfoModal(symbol) {
    const modal = document.getElementById('tokenInfoModal');
    const body = document.getElementById('tokenInfoBody');
    modal.classList.add('active');

    // Show loading state
    body.innerHTML = `
        <div class="wallet-popup-loading">
            <div class="wallet-popup-spinner"></div>
            <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ œÄŒªŒ∑œÅŒøœÜŒøœÅŒπœéŒΩ...</span>
            <span class="lang-en">Loading token info...</span>
        </div>
    `;
    const lang = getCurrentLang();
    setLanguage(lang);

    try {
        // Fetch token info from API
        let tokenData = null;

        // Check if it's a core token
        if (symbol === 'THR') {
            const statsResp = await fetch('/api/network_stats');
            const stats = await statsResp.json();
            const holdersResp = await fetch('/api/tokens/THR/holders');
            const holdersData = await holdersResp.json();

            tokenData = {
                symbol: 'THR',
                name: 'Thronos',
                description: 'The native token of the Thronos blockchain network. Used for transactions, fees, pledging, and governance.',
                color: '#ff6600',
                logo: '/static/img/thronos-token.png',
                total_supply: stats.total_supply || 0,
                max_supply: 21000000,
                holders_count: holdersData.holders_count || 0,
                decimals: 6,
                transferable: true,
                burnable: true,
                mintable: false,
                chain: 'Thronos',
                type: 'native'
            };
        } else if (symbol === 'WBTC') {
            const holdersResp = await fetch('/api/tokens/WBTC/holders');
            const holdersData = await holdersResp.json();

            tokenData = {
                symbol: 'WBTC',
                name: 'Wrapped Bitcoin',
                description: 'Bitcoin bridged to the Thronos network. 1 WBTC = 0.0001 BTC equivalent.',
                color: '#f7931a',
                logo: '/static/img/wbtc-logo.png',
                total_supply: holdersData.total_supply || 0,
                max_supply: 21000000,
                holders_count: holdersData.holders_count || 0,
                decimals: 8,
                transferable: true,
                burnable: false,
                mintable: true,
                chain: 'Thronos',
                type: 'wrapped'
            };
        } else if (symbol === 'L2E') {
            const holdersResp = await fetch('/api/tokens/L2E/holders');
            const holdersData = await holdersResp.json();

            tokenData = {
                symbol: 'L2E',
                name: 'Learn-to-Earn',
                description: 'Reward token for educational achievements and learning milestones on the Thronos platform.',
                color: '#00bfff',
                logo: '/static/img/l2e-logo.png',
                total_supply: holdersData.total_supply || 0,
                max_supply: 100000000,
                holders_count: holdersData.holders_count || 0,
                decimals: 6,
                transferable: true,
                burnable: true,
                mintable: true,
                chain: 'Thronos',
                type: 'utility'
            };
        } else {
            // Custom token - fetch from API
            const response = await fetch(`/api/tokens/list`);
            const data = await response.json();
            if (data.ok && data.tokens) {
                tokenData = data.tokens.find(t => t.symbol === symbol);
            }

            // Get holders count
            if (tokenData) {
                try {
                    const holdersResp = await fetch(`/api/tokens/${symbol}/holders`);
                    const holdersData = await holdersResp.json();
                    if (holdersData.ok) {
                        tokenData.holders_count = holdersData.holders_count;
                    }
                } catch(e) {}
            }
        }

        if (!tokenData) {
            body.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #ff6666;">
                    <div style="font-size: 40px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <span class="lang-el">Token Œ¥ŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ</span>
                    <span class="lang-en">Token not found</span>
                </div>
            `;
            setLanguage(lang);
            return;
        }

        renderTokenInfo(tokenData);

    } catch (error) {
        console.error('Token info error:', error);
        body.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #ff6666;">
                <div style="font-size: 40px; margin-bottom: 15px;">‚ùå</div>
                <span class="lang-el">Œ£œÜŒ¨ŒªŒºŒ± œÜœåœÅœÑœâœÉŒ∑œÇ</span>
                <span class="lang-en">Failed to load token info</span>
            </div>
        `;
        setLanguage(lang);
    }
}

function renderTokenInfo(token) {
    const body = document.getElementById('tokenInfoBody');
    const lang = getCurrentLang();
    const isGreek = isGreekLang(lang);

    const logoHtml = token.logo
        ? `<img src="${token.logo}" alt="${token.symbol}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <span style="display:none; color:${token.color}; font-weight:bold; font-size:24px;">${token.symbol[0]}</span>`
        : `<span style="color:${token.color}; font-weight:bold; font-size:24px;">${token.symbol[0]}</span>`;

    // Labels
    const labels = {
        totalSupply: isGreek ? 'Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ Œ†œÅŒøœÉœÜŒøœÅŒ¨' : 'Total Supply',
        maxSupply: isGreek ? 'ŒúŒ≠Œ≥ŒπœÉœÑŒ∑ Œ†œÅŒøœÉœÜŒøœÅŒ¨' : 'Max Supply',
        holders: isGreek ? 'ŒöŒ¨œÑŒøœáŒøŒπ' : 'Holders',
        decimals: isGreek ? 'ŒîŒµŒ∫Œ±Œ¥ŒπŒ∫Œ¨' : 'Decimals',
        chain: isGreek ? 'ŒîŒØŒ∫œÑœÖŒø' : 'Chain',
        type: isGreek ? 'Œ§œçœÄŒøœÇ' : 'Type',
        send: isGreek ? 'ŒëœÄŒøœÉœÑŒøŒªŒÆ' : 'Send',
        viewHolders: isGreek ? 'ŒöŒ¨œÑŒøœáŒøŒπ' : 'Holders',
        explorer: isGreek ? 'ŒïŒæŒµœÅŒµœçŒΩŒ∑œÉŒ∑' : 'Explorer',
        createdBy: isGreek ? 'ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒÆŒ∏Œ∑Œ∫Œµ Œ±œÄœå' : 'Created by',
        transferable: isGreek ? 'ŒúŒµœÑŒ±Œ≤ŒπŒ≤Œ¨œÉŒπŒºŒø' : 'Transferable',
        notTransferable: isGreek ? 'ŒúŒ∑ ŒúŒµœÑŒ±Œ≤ŒπŒ≤Œ¨œÉŒπŒºŒø' : 'Not Transferable',
        burnable: isGreek ? 'ŒöŒ±œçœÉŒπŒºŒø' : 'Burnable',
        mintable: isGreek ? 'ŒïŒ∫Œ¥œåœÉŒπŒºŒø' : 'Mintable'
    };

    // Badges
    let badgesHtml = '';
    if (token.transferable !== false) {
        badgesHtml += `<span class="token-info-badge transferable">‚úì ${labels.transferable}</span>`;
    } else {
        badgesHtml += `<span class="token-info-badge not-transferable">‚úï ${labels.notTransferable}</span>`;
    }
    if (token.burnable) {
        badgesHtml += `<span class="token-info-badge burnable">üî• ${labels.burnable}</span>`;
    }
    if (token.mintable) {
        badgesHtml += `<span class="token-info-badge mintable">‚ú® ${labels.mintable}</span>`;
    }

    // Format supplies
    const formatSupply = (num) => {
        if (!num) return '‚àû';
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
        return Number(num).toLocaleString();
    };

    // Send button - disabled if not transferable
    const canSend = token.transferable !== false;
    const sendBtnClass = canSend ? 'token-info-btn token-info-btn-send' : 'token-info-btn token-info-btn-send disabled';
    const sendOnClick = canSend ? `closeTokenInfoModal(); setTimeout(() => { openSendModal(); document.getElementById('sendToken').value = '${token.symbol}'; updateTokenInfo(); }, 300);` : '';

    body.innerHTML = `
        <div class="token-info-header">
            <div class="token-info-logo" style="border-color: ${token.color}; background: linear-gradient(135deg, ${token.color}22 0%, ${token.color}11 100%);">
                ${logoHtml}
            </div>
            <div class="token-info-title">
                <div class="token-info-name">${escapeHtml(token.name)}</div>
                <div class="token-info-symbol">${escapeHtml(token.symbol)} ‚Ä¢ ${token.chain || 'Thronos'}</div>
            </div>
        </div>

        <div class="token-info-properties">
            ${badgesHtml}
        </div>

        ${token.description ? `<div class="token-info-description">${escapeHtml(token.description)}</div>` : ''}

        <div class="token-info-grid">
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.totalSupply}</div>
                <div class="token-info-stat-value">${formatSupply(token.total_supply || token.current_supply)}</div>
            </div>
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.maxSupply}</div>
                <div class="token-info-stat-value">${token.max_supply ? formatSupply(token.max_supply) : '‚àû'}</div>
            </div>
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.holders}</div>
                <div class="token-info-stat-value">${token.holders_count !== undefined ? token.holders_count.toLocaleString() : '-'} üë•</div>
            </div>
            <div class="token-info-stat">
                <div class="token-info-stat-label">${labels.decimals}</div>
                <div class="token-info-stat-value">${token.decimals !== undefined ? token.decimals : 6}</div>
            </div>
        </div>

        <div class="token-info-actions">
            <button class="${sendBtnClass}" onclick="${sendOnClick}" ${canSend ? '' : 'disabled'}>
                üí∏ ${labels.send}
            </button>
            <a href="/viewer?token=${token.symbol}" class="token-info-btn token-info-btn-secondary">
                üìä ${labels.explorer}
            </a>
        </div>

        ${token.creator ? `
        <div class="token-info-creator">
            ${labels.createdBy}: <a href="/viewer?address=${token.creator}">${token.creator.slice(0, 10)}...${token.creator.slice(-6)}</a>
        </div>
        ` : ''}
    `;

    setLanguage(lang);
}

function closeTokenInfoModal(event) {
    if (!event || event.target.id === 'tokenInfoModal') {
        document.getElementById('tokenInfoModal').classList.remove('active');
    }
}
</script>

<div class="page-footer-spacer"></div>
<!-- Chain Tokens Widget (Footer) -->
<div class="chain-tokens-widget" id="chainTokensWidget">
    <div class="chain-tokens-inner">
        <div class="chain-supply-box">
            <div>
                <div class="chain-supply-label">
                    <span class="lang-el">Œ£œÖŒΩŒøŒªŒπŒ∫ŒÆ Œ†œÅŒøŒºŒÆŒ∏ŒµŒπŒ± THR</span>
                    <span class="lang-en">Total THR Supply</span>
                </div>
                <div class="chain-supply-amount" id="chainTotalSupply">Loading...</div>
            </div>
        </div>
        <div class="chain-tokens-scroll" id="chainTokensScroll">
            <div class="chain-token-pill">
                <span style="color: #56ff9a; font-size: 11px;">
                    <span class="lang-el">Œ¶œåœÅœÑœâœÉŒ∑ tokens...</span>
                    <span class="lang-en">Loading tokens...</span>
                </span>
            </div>
        </div>
    </div>
    <div class="chain-tokens-footer-meta">
        <div class="left">Thronos Network ¬Æ CopyRights 2023‚Äì2026</div>
        <div class="right" id="build-info">build: ‚Äî</div>
    </div>
</div>

<script>

function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, (m) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
}

// Toast notification function
function showToast(message, duration = 2000) {
    // Remove existing toasts
    const existingToast = document.querySelector('.thr-toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'thr-toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #00ff66 0%, #00cc52 100%);
        color: #000;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        z-index: 5000;
        box-shadow: 0 4px 15px rgba(0, 255, 102, 0.4);
        animation: toastFadeIn 0.3s ease-out;
    `;

    // Add animation keyframes if not exists
    if (!document.querySelector('#toast-style')) {
        const style = document.createElement('style');
        style.id = 'toast-style';
        style.textContent = '@keyframes toastFadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } } @keyframes toastFadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(-50%) translateY(-10px); } }';
        document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        const lang = getCurrentLang();
        const isGreek = isGreekLang(lang);
        showToast(isGreek ? 'ŒëŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ' : 'Copied');
    } catch (e) {
        console.warn('Clipboard failed', e);
    }
}

function downloadCGMinerKit() {
    const meta = document.querySelector('meta[name="cgminer-kit-url"]');
    const url = (meta && meta.content ? meta.content.trim() : '') || '/static/cgminer_kit.zip';
    window.open(url, '_blank', 'noopener');
}


// Chain Tokens Widget - Load all tokens on chain with holders count
(function() {
    async function loadChainTokensWidget() {
        try {
            // Fetch total supply
            const statsResp = await fetch('/api/network_stats');
            const stats = await statsResp.json();
            const supplyEl = document.getElementById('chainTotalSupply');
            if (supplyEl && stats.total_supply !== undefined) {
                supplyEl.textContent = Number(stats.total_supply).toLocaleString('en-US', {maximumFractionDigits: 2}) + ' THR';
            }

            // Fetch all tokens with stats (including holders count)
            let tokensWithStats = [];
            try {
                const tokensStatsResp = await fetch('/api/tokens/stats');
                const tokensStatsData = await tokensStatsResp.json();
                if (tokensStatsData.ok && tokensStatsData.tokens) {
                    tokensWithStats = tokensStatsData.tokens;
                }
            } catch(e) {
                console.log('Tokens stats API not available, using fallback');
                // Fallback to basic token list
                tokensWithStats = [
                    { symbol: 'THR', name: 'Thronos', color: '#ff6600', holders_count: 0 },
                    { symbol: 'WBTC', name: 'Wrapped Bitcoin', color: '#f7931a', holders_count: 0 },
                    { symbol: 'L2E', name: 'Learn-to-Earn', color: '#00bfff', holders_count: 0 }
                ];
            }

            // Render tokens
            const scrollEl = document.getElementById('chainTokensScroll');
            if (!scrollEl) return;

            let html = '';
            tokensWithStats.forEach(token => {
                const logoSrc = token.logo || (token.symbol === 'THR' ? '/static/img/thronos-token.png' : null);
                const logoHtml = logoSrc
                    ? `<img src="${logoSrc}" alt="${token.symbol}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'color:${token.color}\\'>${token.symbol[0]}</span>';">`
                    : `<span style="color: ${token.color};">${token.symbol[0]}</span>`;

                const holdersText = token.holders_count !== undefined
                    ? `${token.holders_count} üë•`
                    : '';

                const supplyText = token.total_supply
                    ? Number(token.total_supply).toLocaleString('en-US', {maximumFractionDigits: 0})
                    : '';

                html += `
                    <div class="chain-token-pill" title="${token.name} - ${holdersText || '0'} holders" onclick="openTokenInfoModal('${token.symbol}')" style="cursor: pointer;">
                        <div class="chain-token-logo" style="border-color: ${token.color};">${logoHtml}</div>
                        <span class="chain-token-symbol">${token.symbol}</span>
                        ${holdersText ? `<span class="chain-token-holders">${holdersText}</span>` : ''}
                        ${supplyText ? `<span class="chain-token-supply">${supplyText}</span>` : ''}
                    </div>
                `;
            });
            scrollEl.innerHTML = html;

        } catch(err) {
            console.error('Chain tokens widget error:', err);
        }
    }

    // Load on DOM ready
    document.addEventListener('DOMContentLoaded', loadChainTokensWidget);

    // Refresh every 60 seconds
    setInterval(loadChainTokensWidget, 60000);
})();

</script>

<script>
(function(){
  async function hydrateBuild(){
    try{
      const out = document.getElementById("build-info");
      if(!out) return;
      const r = await fetch("/api/health", {cache:"no-store"});
      const j = await r.json();
      let build = j.build_id || j.git_commit || null;
      if (!build && j.build) {
        if (typeof j.build === "string") {
          build = j.build;
        } else if (typeof j.build === "object") {
          build = j.build.build_id || j.build.git_commit || null;
        }
      }
      out.textContent = "build: " + (build || "‚Äî");
    }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    hydrateBuild();
  });
})();
</script>

<script src="{{ url_for('static', filename='wallet_sdk.js') }}"></script>

{% block scripts %}{% endblock %}

<div id="footer-sentinel" style="height:1px;"></div>

</body>
</html>
