<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thronos Quantum Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #02060a;
      --bg-alt: #050910;
      --panel: #060c16;
      --accent: #00ff88;
      --accent-soft: rgba(0, 255, 136, 0.1);
      --accent-soft-2: rgba(0, 255, 136, 0.2);
      --danger: #ff4b81;
      --text: #e5f6ff;
      --text-muted: #6a96b0;
      --border: #0f1c2b;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #071824 0, #02060a 45%);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      height: 52px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #050c16, #02060a);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 0 16px rgba(0, 0, 0, 0.7);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .top-logo {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--accent);
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .top-title {
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-size: 13px;
    }

    .top-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(5, 14, 25, 0.9);
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(0, 255, 136, 0.8);
    }

    .pill-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
      color: var(--text-muted);
    }

    .pill-value {
      font-size: 11px;
    }

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr) 260px;
      gap: 12px;
      padding: 12px 14px 14px;
      overflow: hidden;
    }

    .panel {
      background: linear-gradient(145deg, var(--panel), #02060a);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: 0 0 24px rgba(0, 0, 0, 0.65);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 10px 14px 8px;
      border-bottom: 1px solid rgba(9, 30, 60, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-muted);
    }

    .panel-header-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    button,
    select,
    input,
    textarea {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      padding: 5px 11px;
      border: 1px solid var(--border);
      background: rgba(5, 16, 28, 0.9);
      color: var(--text);
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.14s ease, border-color 0.14s ease,
        box-shadow 0.14s ease, transform 0.06s ease;
    }

    .btn:hover {
      border-color: var(--accent-soft-2);
      background: rgba(8, 28, 40, 0.95);
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.15);
      transform: translateY(-0.5px);
    }

    .btn-primary {
      border-color: var(--accent-soft-2);
      background: radial-gradient(circle at top, var(--accent-soft-2), #041016);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.4);
    }

    .btn-danger {
      border-color: rgba(255, 75, 129, 0.4);
      color: var(--danger);
    }

    .sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 6px 10px;
      font-size: 12px;
    }

    .session-item {
      padding: 7px 10px;
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(3, 10, 14, 0.9);
      transition: background 0.12s ease, border-color 0.12s ease;
    }

    .session-item:hover {
      border-color: rgba(0, 255, 136, 0.3);
      background: rgba(5, 18, 24, 0.95);
    }

    .session-item.active {
      border-color: var(--accent-soft-2);
      background: radial-gradient(circle at left, var(--accent-soft-2), #050b12);
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.28);
    }

    .session-title {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .tag {
      border-radius: 999px;
      border: 1px solid rgba(10, 44, 60, 0.8);
      padding: 2px 7px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      background: rgba(4, 12, 20, 0.9);
    }

    .wallet-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 10px;
      font-size: 11px;
      background: rgba(3, 9, 16, 0.9);
      color: var(--accent);
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0, 255, 136, 0.1);
    }

    .wallet-input::placeholder {
      color: var(--text-muted);
    }

    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .messages {
      flex: 1;
      padding: 14px 14px 10px;
      overflow-y: auto;
      font-size: 13px;
    }

    .msg {
      max-width: 82%;
      margin-bottom: 10px;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid rgba(9, 30, 60, 0.9);
      background: rgba(5, 12, 20, 0.95);
      box-shadow: 0 0 14px rgba(0, 0, 0, 0.45);
    }

    .msg.me {
      margin-left: auto;
      border-color: rgba(0, 255, 136, 0.4);
      background: radial-gradient(circle at top right, var(--accent-soft-2), #031015);
    }

    .msg.agent {
      border-color: rgba(62, 136, 255, 0.4);
      background: radial-gradient(circle at top left, rgba(62, 136, 255, 0.13), #050b12);
    }

    .msg-role {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .msg-text {
      white-space: pre-wrap;
      line-height: 1.45;
    }

    .msg-meta {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .msg-files {
      margin-top: 4px;
      font-size: 11px;
    }

    .msg-files a {
      color: var(--accent);
      text-decoration: none;
    }

    .msg-files a:hover {
      text-decoration: underline;
    }

    .composer {
      border-top: 1px solid rgba(9, 30, 60, 0.9);
      padding: 10px 12px 10px;
      background: radial-gradient(circle at top, #05101a, #03070c);
    }

    .composer-top {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      align-items: center;
    }

    .composer-text {
      flex: 1;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(4, 10, 18, 0.96);
      color: var(--text);
      font-size: 13px;
      padding: 7px 10px;
      resize: none;
      min-height: 56px;
      max-height: 120px;
      outline: none;
    }

    .composer-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 3px;
    }

    .composer-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .composer-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.3);
      background: rgba(5, 14, 22, 0.9);
      padding: 3px 7px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-remove {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      padding: 0;
    }

    .file-input-label {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px dashed rgba(0, 255, 136, 0.35);
      color: var(--accent);
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(6, 20, 14, 0.85);
    }

    .file-input-label:hover {
      background: rgba(8, 28, 20, 0.95);
    }

    .file-input-label input {
      display: none;
    }

    .select {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(4, 12, 20, 0.96);
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 7px;
      outline: none;
    }

    .status-line {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .telemetry {
      padding: 8px 12px 10px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--text-muted);
    }

    .telemetry-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .telemetry-value {
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }

    .telemetry-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
    }

    .telemetry-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.4), transparent);
      margin: 4px 0;
    }

    .small {
      font-size: 10px;
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 230px minmax(0, 1fr);
        grid-template-rows: minmax(0, 1fr) 220px;
        grid-template-areas:
          "sessions main"
          "sessions side";
      }

      .panel.sessions {
        grid-area: sessions;
      }

      .panel.main {
        grid-area: main;
      }

      .panel.side {
        grid-area: side;
      }
    }

    @media (max-width: 780px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto auto auto;
        grid-template-areas:
          "main"
          "sessions"
          "side";
      }

      .panel {
        min-height: 0;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <div class="top-logo">TH</div>
      <div>
        <div class="top-title">Thronos Quantum</div>
        <div class="top-sub">Peer-to-peer encrypted AI console ‚Ä¢ Bound to Thronos chain</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="pill">
        <span class="pill-dot"></span>
        <span class="pill-label">Encryption</span>
        <span class="pill-value">Active</span>
      </div>
      <div class="pill">
        <span class="pill-label">Model</span>
        <span class="pill-value" id="modelStatus">auto</span>
      </div>
      <div class="pill">
        <span class="pill-label">Core</span>
        <span class="pill-value" id="coreStatus">loading‚Ä¶</span>
      </div>
    </div>
  </header>

  <main class="layout">
    <!-- Sessions panel -->
    <section class="panel sessions">
      <div class="panel-header">
        <div>
          <div class="panel-title">Sessions</div>
          <div class="small" id="walletLabel"></div>
        </div>
        <div class="panel-header-actions">
          <button class="btn" id="renameSessionBtn">Rename</button>
          <button class="btn btn-danger" id="deleteSessionBtn">Delete</button>
          <button class="btn btn-primary" id="newSessionBtn">New</button>
        </div>
      </div>
      <div style="padding: 8px 12px 4px;">
        <input
          id="walletInput"
          class="wallet-input"
          placeholder="THR wallet (for rewards & session binding)‚Ä¶"
        />
      </div>
      <div class="sessions-list" id="sessionsList"></div>
    </section>

    <!-- Main chat -->
    <section class="panel main">
      <div class="panel-header">
        <div>
          <div class="panel-title">Dialog</div>
          <div class="small" id="sessionTitle">No active session</div>
        </div>
        <div class="panel-header-actions">
          <select id="modelSelect" class="select">
            <option value="auto">Auto (Thronos chooses)</option>
            <option value="gpt">GPT</option>
            <option value="gemini">Gemini</option>
            <option value="local">Local</option>
          </select>
          <span class="tag" id="sessionStatusTag">Idle</span>
        </div>
      </div>
      <div class="main-chat">
        <div class="messages" id="messages"></div>
        <div class="composer">
          <div class="composer-top">
            <textarea
              id="messageInput"
              class="composer-text"
              placeholder="Type a command to Thronos‚Ä¶"
            ></textarea>
          </div>
          <div class="composer-row">
            <div class="composer-left">
              <label class="file-input-label">
                <span>üìé Attach file</span>
                <input id="fileInput" type="file" />
              </label>
              <div class="chip-row" id="pendingFilesRow"></div>
            </div>
            <div class="composer-right">
              <select id="modeSelect" class="select">
                <option value="auto">Auto (Thronos chooses)</option>
                <option value="analysis">Analysis</option>
                <option value="architect">Architect</option>
                <option value="chain">Chain Ops</option>
              </select>
              <button class="btn btn-primary" id="sendBtn">Send</button>
            </div>
          </div>
          <div class="status-line">
            <span id="uploadStatus">No files attached.</span>
            <span id="usageStatus"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Telemetry / info -->
    <section class="panel side">
      <div class="panel-header">
        <div>
          <div class="panel-title">Node Telemetry</div>
          <div class="small">Approximate stats from Thronos HTTP node</div>
        </div>
      </div>
      <div class="telemetry">
        <div class="telemetry-row">
          <span class="telemetry-label">Hashrate (local)</span>
          <span class="telemetry-value" id="hashrateLocal">0 H/s</span>
        </div>
        <div class="telemetry-row">
          <span class="telemetry-label">Pending TXs</span>
          <span class="telemetry-value" id="pendingTxs">0</span>
        </div>
        <div class="telemetry-divider"></div>
        <div class="telemetry-row">
          <span class="telemetry-label">Difficulty</span>
          <span class="telemetry-value" id="difficulty">‚Äì</span>
        </div>
        <div class="telemetry-row">
          <span class="telemetry-label">AI Credits</span>
          <span class="telemetry-value" id="aiCredits">‚Äì</span>
        </div>
        <div class="telemetry-divider"></div>
        <div class="small">
          Offline corpus: best blocks from conversations will be promoted to
          the AI training dataset automatically.
        </div>
      </div>
    </section>
  </main>

  <script>
    // --- Global state ---
    let wallet = "";
    let sessions = [];
    let currentSession = null;
    let pendingFiles = [];   // [{id, name, size}]
    let receivedFiles = [];  // files returned by AI (for debugging / future use)

    // --- DOM refs ---
    let sessionsListEl,
      messagesEl,
      walletInputEl,
      walletLabelEl,
      messageInputEl,
      fileInputEl,
      pendingFilesRowEl,
      uploadStatusEl,
      sendBtnEl,
      modelSelectEl,
      modelStatusEl,
      coreStatusEl,
      sessionTitleEl,
      sessionStatusTagEl;

    document.addEventListener("DOMContentLoaded", () => {
      cacheDom();
      bindEvents();
      initWalletFromStorage();
      loadSessions();
      refreshTelemetry(); // best-effort, ignore errors
      coreStatusEl.textContent = "warming up‚Ä¶";
      modelStatusEl.textContent = "auto";
    });

    function cacheDom() {
      sessionsListEl = document.getElementById("sessionsList");
      messagesEl = document.getElementById("messages");
      walletInputEl = document.getElementById("walletInput");
      walletLabelEl = document.getElementById("walletLabel");
      messageInputEl = document.getElementById("messageInput");
      fileInputEl = document.getElementById("fileInput");
      pendingFilesRowEl = document.getElementById("pendingFilesRow");
      uploadStatusEl = document.getElementById("uploadStatus");
      sendBtnEl = document.getElementById("sendBtn");
      modelSelectEl = document.getElementById("modelSelect");
      modelStatusEl = document.getElementById("modelStatus");
      coreStatusEl = document.getElementById("coreStatus");
      sessionTitleEl = document.getElementById("sessionTitle");
      sessionStatusTagEl = document.getElementById("sessionStatusTag");
    }

    function bindEvents() {
      walletInputEl.addEventListener("change", () => {
        wallet = walletInputEl.value.trim();
        localStorage.setItem("thr_wallet", wallet);
        walletLabelEl.textContent = wallet
          ? "Bound to wallet: " + wallet
          : "No wallet bound";
        loadSessions();
      });

      document
        .getElementById("newSessionBtn")
        .addEventListener("click", () => startSession());

      document
        .getElementById("renameSessionBtn")
        .addEventListener("click", () => {
          if (!currentSession) {
            alert("Select a session first.");
            return;
          }
          renameSession(currentSession.id);
        });

      document
        .getElementById("deleteSessionBtn")
        .addEventListener("click", () => {
          if (!currentSession) {
            alert("Select a session first.");
            return;
          }
          if (
            confirm(
              "Delete session \"" +
                (currentSession.title || currentSession.id) +
                "\" ?"
            )
          ) {
            deleteSession(currentSession.id);
          }
        });

      sendBtnEl.addEventListener("click", sendMessage);

      messageInputEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          sendMessage();
        }
      });

      fileInputEl.addEventListener("change", async () => {
        if (!fileInputEl.files || !fileInputEl.files.length) return;
        const file = fileInputEl.files[0];
        fileInputEl.value = "";
        try {
          await uploadFile(file);
        } catch (err) {
          console.error("upload error", err);
          uploadStatusEl.textContent = "Upload error: " + err.message;
        }
      });

      modelSelectEl.addEventListener("change", () => {
        modelStatusEl.textContent = modelSelectEl.value || "auto";
      });
    }

    function initWalletFromStorage() {
      wallet = localStorage.getItem("thr_wallet") || "";
      if (wallet) {
        walletInputEl.value = wallet;
        walletLabelEl.textContent = "Bound to wallet: " + wallet;
      } else {
        walletLabelEl.textContent = "No wallet bound";
      }
    }

    function setSessionStatus(text) {
      sessionStatusTagEl.textContent = text;
    }

    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function renderSessions() {
      sessionsListEl.innerHTML = "";
      if (!sessions || !sessions.length) {
        sessionsListEl.innerHTML =
          '<div class="small" style="opacity:.7;">No sessions yet. Start one from the button above.</div>';
        return;
      }
      for (const sess of sessions) {
        const el = document.createElement("div");
        el.className = "session-item" + (currentSession && currentSession.id === sess.id ? " active" : "");
        el.dataset.id = sess.id;
        el.innerHTML =
          '<div>' +
          '<div class="session-title">' +
          escapeHtml(sess.title || "Untitled") +
          "</div>" +
          '<div class="session-meta">' +
          escapeHtml(sess.model || "auto") +
          " ‚Ä¢ " +
          (sess.updated_at || sess.created_at || "") +
          "</div>" +
          "</div>" +
          '<div class="tag">ID ' +
          escapeHtml(String(sess.id).slice(0, 6)) +
          "‚Ä¶</div>";
        el.addEventListener("click", () => {
          if (!currentSession || currentSession.id !== sess.id) {
            currentSession = sess;
            localStorage.setItem("thr_session", sess.id);
            sessionTitleEl.textContent = sess.title || "Session " + sess.id;
            renderSessions();
            loadHistory(sess.id);
          }
        });
        sessionsListEl.appendChild(el);
      }
    }

    async function loadSessions() {
      coreStatusEl.textContent = "loading‚Ä¶";
      try {
        const url =
          "/api/ai/sessions" +
          (wallet ? "?wallet=" + encodeURIComponent(wallet) : "");
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const j = await res.json();
        sessions = j.sessions || j.data || j || [];
        const savedId = localStorage.getItem("thr_session");
        currentSession =
          sessions.find((s) => String(s.id) === String(savedId)) ||
          sessions[0] ||
          null;
        if (currentSession) {
          sessionTitleEl.textContent =
            currentSession.title || "Session " + currentSession.id;
          loadHistory(currentSession.id);
        } else {
          sessionTitleEl.textContent = "No active session";
          messagesEl.innerHTML = "";
        }
        renderSessions();
        coreStatusEl.textContent = "ready";
        modelStatusEl.textContent =
          document.getElementById("modelSelect").value || "auto";
      } catch (err) {
        console.warn("loadSessions error", err);
        coreStatusEl.textContent = "error: " + err.message;
      }
    }

    async function startSession() {
      if (!wallet) {
        alert("Set a THR wallet first.");
        return;
      }
      const model = modelSelectEl.value || "auto";
      try {
        const res = await fetch("/api/ai/sessions/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet, model, title: "New Chat" }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        if (!j.ok && !j.session) {
          throw new Error(j.error || "Start session failed");
        }
        currentSession = j.session || j;
        sessions.unshift(currentSession);
        localStorage.setItem("thr_session", currentSession.id);
        sessionTitleEl.textContent =
          currentSession.title || "Session " + currentSession.id;
        renderSessions();
        messagesEl.innerHTML = "";
      } catch (e) {
        alert("Start session error: " + e.message);
      }
    }

    async function renameSession(id) {
      const newTitle = prompt("Enter new session name:");
      if (!newTitle || !newTitle.trim()) return;
      try {
        const res = await fetch("/api/ai/sessions/rename", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet, session_id: id, title: newTitle }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || "Rename failed");
        const sess = sessions.find((s) => s.id === id);
        if (sess) sess.title = newTitle.trim();
        if (currentSession && currentSession.id === id) {
          currentSession.title = newTitle.trim();
          sessionTitleEl.textContent = currentSession.title;
        }
        renderSessions();
      } catch (e) {
        alert("Rename error: " + e.message);
      }
    }

    async function deleteSession(id) {
      try {
        const res = await fetch("/api/ai/sessions/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet, session_id: id }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || "Delete failed");
        sessions = sessions.filter((s) => s.id !== id);
        if (currentSession && currentSession.id === id) {
          currentSession = null;
          localStorage.removeItem("thr_session");
          messagesEl.innerHTML = "";
          sessionTitleEl.textContent = "No active session";
        }
        renderSessions();
      } catch (e) {
        alert("Delete error: " + e.message);
      }
    }

    async function loadHistory(sessionId) {
      if (!sessionId) return;
      try {
        const url =
          "/api/ai_session_history?wallet=" +
          encodeURIComponent(wallet || "") +
          "&session_id=" +
          encodeURIComponent(sessionId);
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        const items = j.messages || j.history || j || [];
        messagesEl.innerHTML = "";
        for (const m of items) {
          appendMessage(m.role || "assistant", m.content || "", {
            files: m.files || [],
            silent: true,
          });
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (e) {
        console.warn("loadHistory error", e);
      }
    }

    function renderPending() {
      pendingFilesRowEl.innerHTML = "";
      if (!pendingFiles.length) {
        uploadStatusEl.textContent = "No files attached.";
        return;
      }
      for (const f of pendingFiles) {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML =
          '<span>' +
          escapeHtml(f.name) +
          "</span><button class='chip-remove' title='Remove'>&times;</button>";
        chip.querySelector("button").addEventListener("click", () => {
          pendingFiles = pendingFiles.filter((pf) => pf.id !== f.id);
          renderPending();
        });
        pendingFilesRowEl.appendChild(chip);
      }
      uploadStatusEl.textContent =
        pendingFiles.length +
        " file(s) attached (will be sent with the next message).";
    }

    async function uploadFile(file) {
      if (!wallet) {
        throw new Error("Set a THR wallet first.");
      }
      const fd = new FormData();
      fd.append("file", file);
      fd.append("role", "user");
      if (wallet) fd.append("wallet", wallet);
      if (currentSession) fd.append("session_id", currentSession.id);

      uploadStatusEl.textContent = "Uploading " + file.name + "‚Ä¶";

      const res = await fetch("/api/ai/files/upload", {
        method: "POST",
        body: fd,
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const j = await res.json();
      const uploaded = (j.files || []).map((f) => ({
        id: f.id,
        name: f.filename || f.name || file.name,
        size: f.size || file.size,
      }));
      pendingFiles = pendingFiles.concat(uploaded);
      renderPending();
      uploadStatusEl.textContent =
        "Uploaded " + uploaded.length + " file(s).";
    }

    function appendMessage(role, text, opts) {
      opts = opts || {};
      const files = opts.files || [];
      const silent = opts.silent || false;

      const d = document.createElement("div");
      d.className = "msg " + (role === "user" ? "me" : "agent");

      const head =
        '<div class="msg-role">' +
        (role === "user" ? "User" : "Quantum Agent") +
        "</div>";
      const body =
        '<div class="msg-text">' + escapeHtml(text || "") + "</div>";

      let filesHtml = "";
      if (files && files.length) {
        const links = files
          .map(
            (f) =>
              `<a href="/api/ai/files/${encodeURIComponent(
                f.id
              )}" target="_blank">${escapeHtml(
                f.filename || f.name || "file"
              )}</a>`
          )
          .join(" ‚Ä¢ ");
        filesHtml = '<div class="msg-files">Files: ' + links + "</div>";
      }

      d.innerHTML = head + body + filesHtml;
      messagesEl.appendChild(d);
      if (!silent) {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    async function sendMessage() {
      if (!wallet) {
        alert("Set a THR wallet first.");
        return;
      }
      let text = messageInputEl.value.trim();
      if (!text && !pendingFiles.length) return;

      // Ensure we have a session
      if (!currentSession) {
        await startSession();
        if (!currentSession) return;
      }

      const filesToSend = pendingFiles.map((f) => f.id);
      const filesSnapshot = [...pendingFiles];
      pendingFiles = [];
      renderPending();

      appendMessage("user", text || "(no text, files only)", {
        files: filesSnapshot,
      });
      messageInputEl.value = "";
      setSessionStatus("Sending‚Ä¶");
      usageStatus.textContent = "";

      try {
        const body = {
          wallet,
          session_id: currentSession.id,
          message: text,
          mode: document.getElementById("modeSelect").value || "auto",
          files: filesToSend,
        };
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();

        const reply = j.reply || j.message || "(no reply)";
        const aiFiles = j.ai_files || j.files || [];
        receivedFiles.push(...aiFiles);

        appendMessage("assistant", reply, { files: aiFiles });

        const usage = j.usage || j.token_usage;
        if (usage && typeof usage.total_tokens !== "undefined") {
          usageStatus.textContent =
            "Tokens: " +
            usage.total_tokens +
            " (prompt " +
            usage.prompt_tokens +
            ", completion " +
            usage.completion_tokens +
            ")";
        }

        setSessionStatus("Ready");
      } catch (e) {
        console.error("sendMessage error", e);
        setSessionStatus("Error");
        appendMessage(
          "assistant",
          "[Error] " + e.message + " (check server logs).",
          {}
        );
      }
    }

    async function refreshTelemetry() {
      // Best-effort: Œ±ŒΩ Œ¥ŒµŒΩ œÖœÄŒ¨œÅœáŒµŒπ endpoint, Œ±œÄŒªŒ¨ Œ±Œ≥ŒΩŒøŒµŒØ œÑŒø error.
      try {
        const res = await fetch("/api/quantum_stats");
        if (!res.ok) return;
        const j = await res.json();
        document.getElementById("hashrateLocal").textContent =
          (j.hashrate_local || 0) + " H/s";
        document.getElementById("pendingTxs").textContent =
          j.pending_txs || 0;
        document.getElementById("difficulty").textContent =
          j.difficulty || "‚Äì";
        document.getElementById("aiCredits").textContent =
          j.ai_credits || "‚Äì";
      } catch (e) {
        // œÉŒπœâœÄŒ∑ŒªŒÆ Œ±œÄŒøœÑœÖœáŒØŒ± ‚Äì Œ¥ŒµŒΩ Œ∏Œ≠ŒªŒøœÖŒºŒµ console spam
      }
    }
  </script>
</body>
</html>
