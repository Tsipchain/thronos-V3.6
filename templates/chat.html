<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thronos Quantum Chat</title>
  <style>
    body{margin:0;font-family:system-ui;background:#050a07;color:#c8ffd8}
    .top{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid #0f3}
    .pill{border:1px solid #0f3;border-radius:999px;padding:4px 10px;color:#8fffb0}
    select,input,button{background:#07140d;color:#c8ffd8;border:1px solid #0f3;border-radius:8px;padding:8px}
    button{cursor:pointer}
    .wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 54px)}
    .left{border-right:1px solid #0f3;padding:10px}
    .right{display:flex;flex-direction:column}
    .sessions{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .session{padding:8px;border:1px solid #0f3;border-radius:10px;cursor:pointer}
    .session.active{background:#0a2416}
    .chat{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:860px;padding:10px 12px;border:1px solid #0f3;border-radius:12px;white-space:pre-wrap}
    .me{align-self:flex-end;background:#071a11}
    .ai{align-self:flex-start;background:#07110a}
    .bar{display:flex;gap:10px;padding:12px;border-top:1px solid #0f3}
    .bar input{flex:1}
    .muted{opacity:.8;font-size:12px}
  </style>
</head>
<body>
  <div class="top">
    <div class="pill" id="statusPill">Core: online</div>
    <div class="muted">Wallet</div>
    <input id="wallet" placeholder="THR..." style="width:210px"/>
    <div class="muted">Model</div>
    <select id="model">
      <option value="">Auto (Smart)</option>
      <option value="gpt-4o">OpenAI: gpt-4o</option>
      <option value="gemini-1.5-pro">Gemini: 1.5 Pro</option>
      <option value="local">Offline (Corpus)</option>
    </select>
    <div class="pill" id="creditsPill">credits: ?</div>
    <button id="newSessionBtn">New Chat</button>
  </div>

  <div class="wrap">
    <div class="left">
      <div class="muted">Sessions</div>
      <div class="sessions" id="sessions"></div>
    </div>
    <div class="right">
      <div class="chat" id="chat"></div>
      <div class="bar">
        <input id="msg" placeholder="Type a command to Thronos..." />
        <button id="send">Send</button>
      </div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
let currentSession = null;

async function api(url, opts){
  const r = await fetch(url, opts);
  const t = await r.text();
  let j = null;
  try{ j = JSON.parse(t); }catch(e){}
  if(!r.ok){
    throw new Error((j && (j.error||j.message)) || t || ("HTTP "+r.status));
  }
  return j;
}

function setStatus(ok, text){
  const pill = $("statusPill");
  pill.textContent = text || (ok ? "Core: online" : "Core: offline");
  pill.style.borderColor = ok ? "#0f3" : "#f33";
  pill.style.color = ok ? "#8fffb0" : "#ffb0b0";
}

function pushMsg(role, content){
  const box = document.createElement("div");
  box.className = "msg " + (role==="user" ? "me" : "ai");
  box.textContent = content;
  $("chat").appendChild(box);
  $("chat").scrollTop = $("chat").scrollHeight;
}

async function refreshCredits(){
  const w = $("wallet").value.trim();
  const j = await api("/api/ai_credits?wallet="+encodeURIComponent(w));
  $("creditsPill").textContent = "credits: " + (j.credits ?? "?");
}

async function loadSessions(){
  const w = $("wallet").value.trim();
  const j = await api("/api/ai_sessions?wallet="+encodeURIComponent(w));
  const list = j.sessions || [];
  const wrap = $("sessions");
  wrap.innerHTML = "";
  list.forEach(s=>{
    const d = document.createElement("div");
    d.className = "session" + (s.id===currentSession ? " active" : "");
    d.textContent = s.title || s.id;
    d.onclick = ()=>selectSession(s.id);
    wrap.appendChild(d);
  });
}

async function selectSession(id){
  currentSession = id;
  await loadSessions();
  $("chat").innerHTML = "";
  const w = $("wallet").value.trim();
  const j = await api("/api/ai_session_history?wallet="+encodeURIComponent(w)+"&session_id="+encodeURIComponent(id));
  (j.history||[]).forEach(m=>pushMsg(m.role==="user"?"user":"assistant", m.content));
}

async function newSession(){
  const w = $("wallet").value.trim();
  if(!w){ alert("Βάλε THR wallet για sessions."); return; }
  const j = await api("/api/ai_sessions/start", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({wallet:w, title:"Νέα συνομιλία"})
  });
  currentSession = j.session.id;
  await loadSessions();
  $("chat").innerHTML = "";
}

async function send(){
  const msg = $("msg").value.trim();
  if(!msg) return;
  $("msg").value = "";
  pushMsg("user", msg);

  try{
    const payload = {
      message: msg,
      wallet: $("wallet").value.trim(),
      session_id: currentSession,
      model_key: $("model").value.trim() || null
    };
    const j = await api("/api/chat", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    setStatus(true, "Core: online");
    pushMsg("assistant", j.response || "");
    if(j.credits !== undefined) $("creditsPill").textContent = "credits: "+j.credits;
  }catch(e){
    setStatus(false, "Core: offline");
    pushMsg("assistant", "Σφάλμα: " + e.message);
  }
}

$("send").onclick = send;
$("msg").addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });
$("newSessionBtn").onclick = newSession;
$("wallet").addEventListener("change", async ()=>{ 
  try{ await refreshCredits(); await loadSessions(); }catch(e){ setStatus(false,"Core: offline"); }
});

(async ()=>{
  try{
    setStatus(true,"Core: online");
    await refreshCredits();
    await loadSessions();
  }catch(e){
    setStatus(false,"Core: offline");
  }
})();
</script>
</body>
</html>
