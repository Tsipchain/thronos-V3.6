<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thronos Quantum Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020712;
      --bg-alt: #050b18;
      --panel: #050f1f;
      --panel-alt: #071628;
      --accent: #23ff6b;
      --accent-soft: rgba(35, 255, 107, 0.15);
      --accent-soft-2: rgba(35, 255, 107, 0.05);
      --danger: #ff4b81;
      --text: #e6fff4;
      --muted: #7aa398;
      --border: #102338;
      --border-soft: rgba(16, 35, 56, 0.7);
      --shadow-soft: 0 0 40px rgba(0, 0, 0, 0.7);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition-fast: 150ms ease-out;
      --transition-med: 220ms ease-out;
      --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #07162a 0, #020712 55%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 18px;
    }

    .quantum-shell {
      width: 100%;
      max-width: 1600px;  /* Increased from 1360px for better full screen use */
      height: 100vh;
      max-height: calc(100vh - 36px);  /* Use full viewport height minus padding */
      background: radial-gradient(circle at top left, #08162a 0, #020712 55%);
      border-radius: 26px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .quantum-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      background: radial-gradient(
          circle at 10% 0,
          rgba(35, 255, 107, 0.1),
          transparent 55%
        ),
        radial-gradient(
          circle at 90% 0,
          rgba(0, 255, 255, 0.08),
          transparent 60%
        );
      mix-blend-mode: screen;
      opacity: 0.6;
    }

    .q-header {
      position: relative;
      z-index: 1;
      padding: 14px 20px 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-soft);
      background: linear-gradient(
        135deg,
        rgba(3, 13, 30, 0.98),
        rgba(3, 11, 25, 0.95)
      );
      backdrop-filter: blur(12px);
    }

    .q-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .th-chip {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.1em;
      text-shadow: 0 0 8px rgba(35, 255, 107, 0.9);
      box-shadow: 0 0 18px rgba(35, 255, 107, 0.4);
    }

    .q-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .q-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .q-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .q-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(4, 18, 32, 0.85);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .pill-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .pill-value {
      color: var(--text);
      font-weight: 500;
    }

    .pill-quiet .pill-dot {
      background: #7aa398;
      box-shadow: none;
    }

    .pill-danger .pill-dot {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger);
    }

    .pill-success .pill-dot {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .q-main {
      position: relative;
      z-index: 1;
      flex: 1;
      display: grid;
      grid-template-columns: 260px minmax(0, 1.5fr) 260px;
      grid-template-rows: minmax(0, 1fr);  /* ADDED - constrains row height to prevent overflow */
      gap: 12px;
      padding: 12px 16px 14px 16px;
      min-height: 0;  /* ADDED - allows grid to shrink properly */
    }

    .error-banner {
      display: none;
      background: rgba(255, 75, 129, 0.1);
      border: 1px solid rgba(255, 75, 129, 0.4);
      color: #ffc2d6;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .error-banner strong {
      color: #ff4b81;
    }

    .error-banner button {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    /* Left column (sessions) */

    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, #061426 0, #050b18 55%);
      border: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .panel-title {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-actions {
      display: flex;
      gap: 6px;
    }

    .btn-ghost {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(3, 13, 30, 0.7);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast);
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      background: rgba(9, 32, 50, 0.9);
      color: var(--accent);
      transform: translateY(-0.5px);
    }

    .btn-ghost-danger:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .sessions-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      flex: 1;
      font-size: 12px;
    }

    .session-item {
      border-radius: var(--radius-md);
      padding: 7px 9px;
      border: 1px solid rgba(16, 35, 56, 0.9);
      background: linear-gradient(
        135deg,
        rgba(5, 17, 32, 0.95),
        rgba(4, 13, 26, 0.96)
      );
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .session-item:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.15);
      transform: translateY(-0.5px);
    }

    .session-item.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.2);
      background: radial-gradient(circle at top left, #071f35 0, #040d1b 55%);
    }

    .session-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .session-name {
      font-size: 12px;
      font-weight: 500;
      flex: 1;
    }

    .session-delete-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      padding: 0 4px;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
    }

    .session-item:hover .session-delete-btn {
      opacity: 1;
    }

    .session-delete-btn:hover {
      color: #ff4444;
    }

    .session-meta {
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .session-status-pill {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(64, 96, 112, 0.9);
      font-size: 9px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .session-status-pill span {
      color: var(--accent);
    }

    /* Center column (chat) */

    .chat-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: radial-gradient(circle at top, #07182e 0, #040b17 55%);
      padding: 8px 10px;
      position: relative;
      overflow: hidden;  /* CHANGED from visible - prevents content overflow */
      min-height: 0;
    }

    .chat-panel::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
          to bottom,
          rgba(35, 255, 107, 0.04),
          transparent 30%
        ),
        linear-gradient(to right, rgba(0, 255, 255, 0.04), transparent 35%);
      opacity: 0.9;
    }

    .chat-panel-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      gap: 8px;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 2px 4px 4px;
    }

    .chat-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #sessionTitle {
      font-size: 12px;
      font-weight: 500;
    }

    #sessionStatusTag {
      font-size: 10px;
      color: var(--muted);
    }

    .chat-badges-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(6, 18, 32, 0.9);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .badge strong {
      color: var(--accent);
      font-weight: 500;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
      padding: 6px 4px 8px 4px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(12, 30, 51, 0.9);
      background: radial-gradient(circle at top, #050f1f 0, #040a16 55%);
      font-size: 13px;
      scroll-behavior: smooth;
    }

    .msg-row {
      display: flex;
      margin-bottom: 10px;
      gap: 6px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
      flex-shrink: 0;
      background: rgba(3, 12, 26, 0.96);
    }

    .msg-bubble {
      max-width: 100%;
      padding: 7px 9px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(20, 50, 80, 0.9);
      background: rgba(5, 16, 32, 0.98);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }

    .msg-row.user .msg-bubble {
      border-color: rgba(35, 255, 107, 0.7);
      background: rgba(7, 26, 40, 0.98);
    }

    .msg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--muted);
    }

    .msg-author {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-weight: 500;
    }

    .msg-model-tag {
      font-size: 10px;
      color: #a6e2ff;
    }

    .msg-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
      line-height: 1.4;
    }

    .msg-files {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .msg-file-link {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(74, 119, 128, 0.9);
      background: rgba(5, 20, 30, 0.96);
      color: var(--accent);
      text-decoration: none;
    }

    .msg-actions {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .thumb-btn {
      border-radius: 999px;
      border: 1px solid rgba(50, 80, 100, 0.9);
      background: rgba(4, 15, 26, 0.96);
      color: var(--muted);
      font-size: 11px;
      padding: 2px 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast);
    }

    .thumb-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-0.5px);
    }

    .thumb-btn.down:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .thumb-btn.active {
      border-color: var(--accent);
      background: rgba(35, 255, 107, 0.09);
      color: var(--accent);
    }

    .thumb-btn.down.active {
      border-color: var(--danger);
      background: rgba(255, 75, 129, 0.08);
      color: var(--danger);
    }

    .chat-input-block {
      border-radius: var(--radius-md);
      border: 1px solid rgba(16, 35, 56, 0.9);
      background: radial-gradient(circle at top, #050f22 0, #030917 55%);
      padding: 8px 9px 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .wallet-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    #walletInput {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 11px;
      padding: 5px 7px;
      border-radius: 999px;
      border: 1px solid rgba(40, 72, 96, 0.9);
      background: rgba(2, 9, 18, 0.96);
      color: var(--text);
    }

    #walletInput:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.2);
    }

    .wallet-label {
      font-size: 10px;
      color: var(--muted);
    }

    .input-row-main {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    #messageInput {
      flex: 1;
      min-height: 40px;
      max-height: 80px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(40, 72, 96, 0.9);
      background: rgba(3, 10, 20, 0.96);
      color: var(--text);
      padding: 6px 8px;
      font-size: 13px;
      font-family: var(--font-sans);
    }

    #messageInput:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.2);
    }

    .input-side {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: flex-end;
    }

    .attach-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    #fileInput {
      display: none;
    }

    .attach-btn {
      border-radius: 999px;
      border: 1px dashed rgba(60, 92, 116, 0.9);
      background: rgba(5, 14, 26, 0.96);
      color: var(--muted);
      padding: 3px 7px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: border-color var(--transition-fast),
        color var(--transition-fast), background var(--transition-fast);
    }

    .attach-btn:hover {
      border-style: solid;
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(7, 22, 36, 0.96);
    }

    .model-select {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(60, 92, 116, 0.9);
      background: rgba(5, 14, 26, 0.96);
      color: var(--text);
      padding: 3px 6px;
    }

    .send-btn {
      margin-top: 2px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: radial-gradient(circle at 30% 0, #22ff6a 0, #059448 55%, #02361b 100%);
      color: #021108;
      font-weight: 600;
      font-size: 12px;
      padding: 5px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 0 20px rgba(35, 255, 107, 0.18);
      transition: transform var(--transition-med), box-shadow var(--transition-med),
        filter var(--transition-med), opacity var(--transition-med);
    }

    .send-btn[disabled] {
      opacity: 0.45;
      cursor: default;
      filter: grayscale(0.2);
      box-shadow: none;
    }

    .send-btn:not([disabled]):hover {
      transform: translateY(-1px);
      box-shadow: 0 0 28px rgba(35, 255, 107, 0.3);
      filter: brightness(1.06);
    }

    #pendingFilesRow {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .pending-files-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .pending-file-chip {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(70, 110, 126, 0.9);
      background: rgba(4, 14, 24, 0.96);
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pending-file-chip span {
      color: var(--accent);
    }

    .pending-file-chip .remove-file-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 11px;
      padding: 0 4px;
    }

    .pending-file-chip .remove-file-btn:hover {
      color: var(--danger);
    }

    .remove-link {
      cursor: pointer;
      text-decoration: underline;
      color: var(--muted);
    }

    .remove-link:hover {
      color: var(--danger);
    }

    #uploadStatus,
    #usageStatus {
      font-size: 10px;
      color: var(--muted);
    }

    #uploadStatus.ok {
      color: var(--accent);
    }

    #uploadStatus.error {
      color: var(--danger);
    }

    /* Right column (telemetry) */

    .telemetry-kv {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .telemetry-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 6px;
      border-radius: var(--radius-md);
      background: rgba(4, 13, 24, 0.95);
      border: 1px solid rgba(20, 44, 68, 0.9);
    }

    .telemetry-row strong {
      color: var(--accent);
      font-weight: 500;
    }

    .telemetry-note {
      margin-top: 4px;
      font-size: 10px;
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      body {
        padding: 10px;
      }
      .quantum-shell {
        max-height: none;
        height: auto;
        min-height: 100vh;  /* Ensure full height on smaller screens */
      }
      .q-main {
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 2.2fr);
        grid-template-rows: minmax(400px, 1fr) minmax(200px, auto);  /* Give chat more space */
        grid-template-areas:
          "sessions chat"
          "telemetry chat";
      }
      .panel.sessions {
        grid-area: sessions;
      }
      .chat-panel {
        grid-area: chat;
      }
      .panel.telemetry {
        grid-area: telemetry;
      }
    }

    @media (max-width: 900px) {
      .q-main {
        grid-template-columns: 1fr;
        grid-template-areas:
          "chat"
          "sessions"
          "telemetry";
      }
      .panel.sessions,
      .panel.telemetry {
        height: auto;
        max-height: 260px;
      }
    }
  </style>
</head>

<body>
  <div class="quantum-shell">
    <header class="q-header">
      <div class="q-header-left">
        <div class="th-chip">TH</div>
        <div class="q-title-block">
          <div class="q-title" id="titleText">Thronos Quantum</div>
          <div class="q-subtitle" id="subtitleText">
            Peer-to-peer encrypted AI console ‚Ä¢ Bound to Thronos chain
          </div>
        </div>
      </div>
      <div class="q-header-right">
        <div class="pill">
          <div class="pill-dot"></div>
          <div class="pill-label">Encryption</div>
          <div class="pill-value">Active</div>
        </div>
        <div class="pill pill-quiet">
          <div class="pill-dot"></div>
          <div class="pill-label">Mode</div>
          <div class="pill-value" id="modeLabel">auto</div>
        </div>
        <div class="pill pill-quiet">
          <div class="pill-dot"></div>
          <div class="pill-label">Core</div>
          <div class="pill-value" id="coreStatus">ready</div>
        </div>
        <div class="pill pill-danger">
          <div class="pill-dot"></div>
          <div class="pill-label">THR wallet</div>
          <div class="pill-value" id="walletLabel">unknown</div>
        </div>
      </div>
    </header>

    <main class="q-main">
      <!-- Sessions -->
      <section class="panel sessions">
        <div class="panel-header">
          <div class="panel-title" id="sessionsTitleLabel">Sessions</div>
          <div class="panel-actions">
            <button class="btn-ghost" id="newSessionBtn">
              ‚ó¶ New
            </button>
            <button class="btn-ghost btn-ghost-danger" id="renameSessionBtn">
              ‚úé Rename
            </button>
          </div>
        </div>
        <ul id="sessionsList" class="sessions-list"></ul>
      </section>

      <!-- Chat -->
      <section class="chat-panel">
        <div class="chat-panel-inner">
          <div id="sessionErrorBanner" class="error-banner">
            <span id="sessionErrorText"><strong>Session error</strong>: Unable to load chat session.</span>
            <button id="retrySessionBtn">Retry</button>
          </div>
          <div class="chat-header-row">
            <div class="chat-title-block">
              <div id="sessionTitle">Mesh session</div>
              <div id="sessionStatusTag">Session: loading‚Ä¶</div>
            </div>
            <div class="chat-badges-row">
              <div class="badge">
                <span id="modelLabelText">Model:</span>
                <strong id="modelStatus">auto</strong>
              </div>
              <div class="badge">
                <span id="creditsLabelText">AI Credits:</span>
                <strong id="usageStatus">‚Äì</strong>
              </div>
            </div>
          </div>

          <div id="messages"></div>

          <div class="chat-input-block">
            <div class="wallet-row">
              <span class="wallet-label" id="walletLabelText">Bound wallet:</span>
              <input
                id="walletInput"
                placeholder="THR address"
                autocomplete="off"
              />
            </div>

            <div class="input-row-main">
              <textarea
                id="messageInput"
                placeholder="Type a command to Thronos‚Ä¶"
              ></textarea>

              <div class="input-side">
                <div class="attach-row">
                  <label for="fileInput" class="attach-btn">
                    üìé Attach file
                  </label>
                  <input id="fileInput" type="file" multiple />
                  <select id="modelSelect" class="model-select" style="background: var(--bg-alt); color: var(--fg); border-radius: 4px; padding: 4px; font-size: 11px; margin-top: 8px;">
                    <option value="auto">Auto Select (Prioritize Our Stack)</option>

                    <!-- Custom Thronos / Thrai agent -->
                    <option value="diko_mas">üßø Thrai (Custom Agent)</option>

                    <!-- Public providers -->
                    <option value="gemini-2.5-flash">üöÄ Gemini 2.5 Flash</option>
                    <option value="gpt-4o">ü§ñ GPT-4o (OpenAI)</option>
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                  <select id="modelSelect" class="model-select">
                    <option value="auto">üîÄ Auto (Thronos chooses)</option>
                    <option value="gemini-2.5-pro">üíé Gemini 2.5 Pro</option>
                    <option value="gpt-4.1-mini">ü§ñ GPT-4.1 Mini (OpenAI)</option>
                    <option value="claude-3-sonnet">üß† Claude 3 Sonnet</option>
                    <option value="custom-default">üõ∞Ô∏è Custom Quantum Agent</option>
                  </select>
                </div>
                <button id="sendBtn" class="send-btn">
                  SEND
                </button>
              </div>
            </div>

            <div id="pendingFilesRow" style="display: none">
              <div class="pending-files-list" id="pendingFilesList"></div>
              <div class="remove-link" id="clearPendingBtn">remove</div>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
              "
            >
              <div id="uploadStatus"></div>
              <!-- usageStatus text now handled in header badge -->
            </div>
          </div>
        </div>
      </section>

      <!-- Telemetry -->
      <section class="panel telemetry">
        <div class="panel-header">
          <div class="panel-title" id="telemetryTitleLabel">Node Telemetry</div>
        </div>
        <div class="telemetry-kv">
          <div class="telemetry-row">
            <span id="telemetryHashrateLabel">Hashrate (local)</span>
            <strong id="hashrateLabel">0 H/s</strong>
          </div>
          <div class="telemetry-row">
            <span id="telemetryPendingLabel">Pending TXs</span>
            <strong id="pendingTxsLabel">0</strong>
          </div>
          <div class="telemetry-row">
            <span id="telemetryDifficultyLabel">Difficulty</span>
            <strong id="difficultyLabel">‚Äì</strong>
          </div>
          <div class="telemetry-row">
            <span id="telemetryCreditsLabel">AI Credits</span>
            <strong id="creditsLabel">‚Äì</strong>
          </div>
        </div>
        <div class="telemetry-note" id="telemetryNote">
          Offline corpus: best blocks from conversations will be promoted to the
          AI training dataset automatically.
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Endpoint constants ---
    const API_WALLET = "/api/ai/wallet";
    const API_CHAT = "/api/chat";
    const API_SESSION_NEW = "/api/chat/session/new";
    const API_SESSION = (id) => `/api/chat/session/${id}`;
    const API_SESSIONS = "/api/chat/sessions";
    const API_SESSION_MESSAGES = (id) => `/api/chat/session/${id}/messages`;
    const API_FILES = "/api/ai/files/upload";
    const API_TELEMETRY = "/api/ai/telemetry";
    const API_FEEDBACK = "/api/ai/feedback";

    const I18N = {
      en: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "Peer-to-peer encrypted AI console ‚Ä¢ Bound to Thronos chain",
        sessions_title: "Sessions",
        new_session: "New",
        rename_session: "Rename",
        session_loading: "Session: loading‚Ä¶",
        status_loading: "Loading‚Ä¶",
        status_ready: "Ready",
        status_error: "Error",
        status_sending: "Sending‚Ä¶",
        status_no_sessions: "No sessions yet. Create a new one.",
        status_failed_sessions: "Failed to load sessions",
        status_failed_messages: "Failed to load messages",
        session_error_banner: "Unable to load chat session.",
        retry: "Retry",
        model_label: "Model:",
        credits_label: "AI Credits:",
        wallet_label: "Bound wallet:",
        wallet_placeholder: "THR address",
        message_placeholder: "Type a command to Thronos‚Ä¶",
        attach_file: "üìé Attach file",
        send: "Send",
        telemetry_title: "Node Telemetry",
        telemetry_hashrate: "Hashrate (local)",
        telemetry_pending: "Pending TXs",
        telemetry_difficulty: "Difficulty",
        telemetry_credits: "AI Credits",
        telemetry_note:
          "Offline corpus: best blocks from conversations will be promoted to the AI training dataset automatically.",
        session_not_ready: "Session not ready",
        no_active_session: "No active session. Create one first.",
        upload_failed: "Upload failed",
        upload_success: "Files uploaded",
      },
      el: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "ŒöŒøŒΩœÉœåŒªŒ± AI ŒºŒµ Œ∫œÅœÖœÄœÑŒøŒ≥œÅŒ¨œÜŒ∑œÉŒ∑ P2P ‚Ä¢ ŒîŒµŒºŒ≠ŒΩŒ∑ ŒºŒµ œÑŒø Thronos chain",
        sessions_title: "Œ£œÖŒΩŒµŒ¥œÅŒØŒµœÇ",
        new_session: "ŒùŒ≠Œ±",
        rename_session: "ŒúŒµœÑŒøŒΩŒøŒºŒ±œÉŒØŒ±",
        session_loading: "Œ£œÖŒΩŒµŒ¥œÅŒØŒ±: œÜœåœÅœÑœâœÉŒ∑‚Ä¶",
        status_loading: "Œ¶œåœÅœÑœâœÉŒ∑‚Ä¶",
        status_ready: "ŒàœÑŒøŒπŒºŒø",
        status_error: "Œ£œÜŒ¨ŒªŒºŒ±",
        status_sending: "ŒëœÄŒøœÉœÑŒøŒªŒÆ‚Ä¶",
        status_no_sessions: "ŒîŒµŒΩ œÖœÄŒ¨œÅœáŒøœÖŒΩ œÉœÖŒΩŒµŒ¥œÅŒØŒµœÇ. ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒÆœÉœÑŒµ ŒºŒØŒ± ŒΩŒ≠Œ±.",
        status_failed_sessions: "ŒëœÄŒøœÑœÖœáŒØŒ± œÜœåœÅœÑœâœÉŒ∑œÇ œÉœÖŒΩŒµŒ¥œÅŒπœéŒΩ",
        status_failed_messages: "ŒëœÄŒøœÑœÖœáŒØŒ± œÜœåœÅœÑœâœÉŒ∑œÇ ŒºŒ∑ŒΩœÖŒºŒ¨œÑœâŒΩ",
        session_error_banner: "ŒëŒ¥œÖŒΩŒ±ŒºŒØŒ± œÜœåœÅœÑœâœÉŒ∑œÇ œÉœÖŒΩŒµŒ¥œÅŒØŒ±œÇ.",
        retry: "ŒûŒ±ŒΩŒ±Œ¥ŒøŒ∫ŒπŒºŒÆ",
        model_label: "ŒúŒøŒΩœÑŒ≠ŒªŒø:",
        credits_label: "AI Credits:",
        wallet_label: "Œ£œÖŒΩŒ¥ŒµŒ¥ŒµŒºŒ≠ŒΩŒø œÄŒøœÅœÑŒøœÜœåŒªŒπ:",
        wallet_placeholder: "ŒîŒπŒµœçŒ∏œÖŒΩœÉŒ∑ THR",
        message_placeholder: "Œ†ŒªŒ∑Œ∫œÑœÅŒøŒªœåŒ≥Œ∑œÉŒµ ŒµŒΩœÑŒøŒªŒÆ œÄœÅŒøœÇ œÑŒø Thronos‚Ä¶",
        attach_file: "üìé ŒïœÄŒπœÉœçŒΩŒ±œàŒ∑ Œ±œÅœáŒµŒØŒøœÖ",
        send: "ŒëœÄŒøœÉœÑŒøŒªŒÆ",
        telemetry_title: "Œ§Œ∑ŒªŒµŒºŒµœÑœÅŒØŒ± ŒöœåŒºŒ≤ŒøœÖ",
        telemetry_hashrate: "Hashrate (œÑŒøœÄŒπŒ∫œå)",
        telemetry_pending: "ŒïŒ∫Œ∫œÅŒµŒºŒµŒØœÇ œÉœÖŒΩŒ±ŒªŒªŒ±Œ≥Œ≠œÇ",
        telemetry_difficulty: "ŒîœÖœÉŒ∫ŒøŒªŒØŒ±",
        telemetry_credits: "AI Credits",
        telemetry_note:
          "Offline corpus: œÑŒ± Œ∫Œ±ŒªœçœÑŒµœÅŒ± blocks Œ±œÄœå œÉœÖŒ∂Œ∑œÑŒÆœÉŒµŒπœÇ œÄœÅŒøœâŒ∏ŒøœçŒΩœÑŒ±Œπ Œ±œÖœÑœåŒºŒ±œÑŒ± œÉœÑŒø dataset ŒµŒ∫œÄŒ±ŒØŒ¥ŒµœÖœÉŒ∑œÇ.",
        session_not_ready: "Œó œÉœÖŒΩŒµŒ¥œÅŒØŒ± Œ¥ŒµŒΩ ŒµŒØŒΩŒ±Œπ Œ≠œÑŒøŒπŒºŒ∑",
        no_active_session: "ŒîŒµŒΩ œÖœÄŒ¨œÅœáŒµŒπ ŒµŒΩŒµœÅŒ≥ŒÆ œÉœÖŒΩŒµŒ¥œÅŒØŒ±. ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒÆœÉœÑŒµ œÄœÅœéœÑŒ±.",
        upload_failed: "ŒëœÄŒøœÑœÖœáŒØŒ± ŒºŒµœÑŒ±œÜœåœÅœÑœâœÉŒ∑œÇ",
        upload_success: "Œ§Œ± Œ±œÅœáŒµŒØŒ± Œ±ŒΩŒ≠Œ≤Œ∑Œ∫Œ±ŒΩ",
      },
      es: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "Consola de IA cifrada P2P ‚Ä¢ Vinculada a Thronos",
        sessions_title: "Sesiones",
        new_session: "Nueva",
        rename_session: "Renombrar",
        session_loading: "Sesi√≥n: cargando‚Ä¶",
        status_loading: "Cargando‚Ä¶",
        status_ready: "Listo",
        status_error: "Error",
        status_sending: "Enviando‚Ä¶",
        status_no_sessions: "Sin sesiones. Crea una nueva.",
        status_failed_sessions: "Error al cargar sesiones",
        status_failed_messages: "Error al cargar mensajes",
        session_error_banner: "No se pudo cargar la sesi√≥n.",
        retry: "Reintentar",
        model_label: "Modelo:",
        credits_label: "Cr√©ditos de IA:",
        wallet_label: "Billetera vinculada:",
        wallet_placeholder: "Direcci√≥n THR",
        message_placeholder: "Escribe un comando para Thronos‚Ä¶",
        attach_file: "üìé Adjuntar archivo",
        send: "Enviar",
        telemetry_title: "Telemetr√≠a del nodo",
        telemetry_hashrate: "Hashrate (local)",
        telemetry_pending: "TX pendientes",
        telemetry_difficulty: "Dificultad",
        telemetry_credits: "Cr√©ditos de IA",
        telemetry_note:
          "Corpus sin conexi√≥n: los mejores bloques de conversaciones se promover√°n autom√°ticamente al dataset de entrenamiento.",
        session_not_ready: "Sesi√≥n no lista",
        no_active_session: "No hay sesi√≥n activa. Crea una primero.",
        upload_failed: "Subida fallida",
        upload_success: "Archivos subidos",
      },
      ja: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "P2PÊöóÂè∑ÂåñAI„Ç≥„É≥„ÇΩ„Éº„É´ ‚Ä¢ Thronos„ÉÅ„Çß„Éº„É≥„Å´ÈÄ£Êê∫",
        sessions_title: "„Çª„ÉÉ„Ç∑„Éß„É≥",
        new_session: "Êñ∞Ë¶è",
        rename_session: "ÂêçÂâçÂ§âÊõ¥",
        session_loading: "„Çª„ÉÉ„Ç∑„Éß„É≥: Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶",
        status_loading: "Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶",
        status_ready: "Ê∫ñÂÇôÂÆå‰∫Ü",
        status_error: "„Ç®„É©„Éº",
        status_sending: "ÈÄÅ‰ø°‰∏≠‚Ä¶",
        status_no_sessions: "„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞Ë¶è‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        status_failed_sessions: "„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
        status_failed_messages: "„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
        session_error_banner: "„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        retry: "ÂÜçË©¶Ë°å",
        model_label: "„É¢„Éá„É´:",
        credits_label: "AI„ÇØ„É¨„Ç∏„ÉÉ„Éà:",
        wallet_label: "Á¥ê‰ªò„Åë„Ç¶„Ç©„É¨„ÉÉ„Éà:",
        wallet_placeholder: "THR„Ç¢„Éâ„É¨„Çπ",
        message_placeholder: "Thronos„Å∏„ÅÆ„Ç≥„Éû„É≥„Éâ„ÇíÂÖ•Âäõ‚Ä¶",
        attach_file: "üìé „Éï„Ç°„Ç§„É´„ÇíÊ∑ª‰ªò",
        send: "ÈÄÅ‰ø°",
        telemetry_title: "„Éé„Éº„Éâ„ÉÜ„É¨„É°„Éà„É™",
        telemetry_hashrate: "„Éè„ÉÉ„Ç∑„É•„É¨„Éº„Éà („É≠„Éº„Ç´„É´)",
        telemetry_pending: "‰øùÁïôTX",
        telemetry_difficulty: "Èõ£ÊòìÂ∫¶",
        telemetry_credits: "AI„ÇØ„É¨„Ç∏„ÉÉ„Éà",
        telemetry_note:
          "„Ç™„Éï„É©„Ç§„É≥„Ç≥„Éº„Éë„Çπ: ‰ºöË©±„ÅÆ„Éô„Çπ„Éà„Éñ„É≠„ÉÉ„ÇØ„ÅåËá™Âãï„ÅßÂ≠¶Áøí„Éá„Éº„Çø„Çª„ÉÉ„Éà„Å´ÊòáÊ†º„Åó„Åæ„Åô„ÄÇ",
        session_not_ready: "„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÊ∫ñÂÇô„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì",
        no_active_session: "„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        upload_failed: "„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó",
        upload_success: "„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü",
      },
    };

    // --- DOM refs ---
    let sessionsListEl,
      messagesEl,
      walletInputEl,
      walletLabelEl,
      messageInputEl,
      fileInputEl,
      pendingFilesRowEl,
      pendingFilesListEl,
      clearPendingBtnEl,
      uploadStatusEl,
      usageStatusEl,
      sendBtnEl,
      modelSelectEl,
      modelStatusEl,
      coreStatusEl,
      sessionTitleEl,
      sessionStatusTagEl,
      sessionErrorBannerEl,
      sessionErrorTextEl,
      retrySessionBtnEl,
      hashrateLabelEl,
      pendingTxsLabelEl,
      difficultyLabelEl,
      creditsLabelEl;

    function cacheDom() {
      sessionsListEl = document.getElementById("sessionsList");
      messagesEl = document.getElementById("messages");
      walletInputEl = document.getElementById("walletInput");
      walletLabelEl = document.getElementById("walletLabel");
      messageInputEl = document.getElementById("messageInput");
      fileInputEl = document.getElementById("fileInput");
      pendingFilesRowEl = document.getElementById("pendingFilesRow");
      pendingFilesListEl = document.getElementById("pendingFilesList");
      clearPendingBtnEl = document.getElementById("clearPendingBtn");
      uploadStatusEl = document.getElementById("uploadStatus");
      usageStatusEl = document.getElementById("usageStatus");
      sendBtnEl = document.getElementById("sendBtn");
      modelSelectEl = document.getElementById("modelSelect");
      modelStatusEl = document.getElementById("modelStatus");
      coreStatusEl = document.getElementById("coreStatus");
      sessionTitleEl = document.getElementById("sessionTitle");
      sessionStatusTagEl = document.getElementById("sessionStatusTag");
      sessionErrorBannerEl = document.getElementById("sessionErrorBanner");
      sessionErrorTextEl = document.getElementById("sessionErrorText");
      retrySessionBtnEl = document.getElementById("retrySessionBtn");
      hashrateLabelEl = document.getElementById("hashrateLabel");
      pendingTxsLabelEl = document.getElementById("pendingTxsLabel");
      difficultyLabelEl = document.getElementById("difficultyLabel");
      creditsLabelEl = document.getElementById("creditsLabel");
    }

    // --- State ---
    const SESSION_STORAGE_KEY = "thronos_session_id";
    const MODEL_STORAGE_KEY = "thronos_model_key";
    const LANG_STORAGE_KEY = "thronos_lang";
    let currentSessionId = null;
    let sessions = [];
    let pendingFiles = []; // { id, name, size }
    let receivedFiles = []; // for any AI-generated [[FILE:...]] blocks
    let sessionState = "idle"; // idle | loading | ready | error
    let sessionError = "";
    let currentLang = "en";

    // --- Utilities ---
    function setUploadStatus(text, mode = "") {
      uploadStatusEl.textContent = text || "";
      uploadStatusEl.classList.remove("ok", "error");
      if (mode) uploadStatusEl.classList.add(mode);
    }

    function setSessionStatus(text) {
      sessionStatusTagEl.textContent = text;
    }

    function setSessionState(state, message = "") {
      sessionState = state;
      sessionError = state === "error" ? message : "";
      const bannerVisible = state === "error";
      sessionErrorBannerEl.style.display = bannerVisible ? "flex" : "none";
      if (bannerVisible) {
        const text = message || "Session unavailable. Please retry.";
        sessionErrorTextEl.textContent = text;
      }

      if (state === "loading") {
        setSessionStatus(t("status_loading"));
        setSending(false);
      } else if (state === "ready") {
        setSessionStatus(t("status_ready"));
        setSending(true);
      } else if (state === "error") {
        setSessionStatus(t("status_error"));
        setSending(false);
      } else {
        setSending(true);
      }
    }

    function setSending(enabled) {
      sendBtnEl.disabled = !enabled;
    }

    function initModelSelector() {
      const saved = localStorage.getItem(MODEL_STORAGE_KEY) || "auto";
      modelSelectEl.value = saved;
      modelStatusEl.textContent = saved;
    }

    function handleModelChange() {
      const value = modelSelectEl.value || "auto";
      localStorage.setItem(MODEL_STORAGE_KEY, value);
      modelStatusEl.textContent = value;
    }

    function t(key) {
      const dict = I18N[currentLang] || I18N.en;
      return dict[key] || I18N.en[key] || key;
    }

    function applyTranslations() {
      document.title = t("page_title");
      const map = [
        ["titleText", "brand_title"],
        ["subtitleText", "brand_subtitle"],
        ["sessionsTitleLabel", "sessions_title"],
        ["newSessionBtn", "new_session"],
        ["renameSessionBtn", "rename_session"],
        ["sessionStatusTag", "session_loading"],
        ["modelLabelText", "model_label"],
        ["creditsLabelText", "credits_label"],
        ["walletLabelText", "wallet_label"],
        ["attachLabel", "attach_file"],
        ["sendBtn", "send"],
        ["telemetryTitleLabel", "telemetry_title"],
        ["telemetryHashrateLabel", "telemetry_hashrate"],
        ["telemetryPendingLabel", "telemetry_pending"],
        ["telemetryDifficultyLabel", "telemetry_difficulty"],
        ["telemetryCreditsLabel", "telemetry_credits"],
        ["telemetryNote", "telemetry_note"],
        ["retrySessionBtn", "retry"],
        ["sessionErrorText", "session_error_banner"],
      ];

      map.forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = t(key);
      });

      if (walletInputEl) walletInputEl.placeholder = t("wallet_placeholder");
      if (messageInputEl) messageInputEl.placeholder = t("message_placeholder");
      if (sessionStatusTagEl) sessionStatusTagEl.textContent = t("status_loading");
    }

    function initI18n() {
      const browserLang = (navigator.language || "").toLowerCase();
      const defaultLang = browserLang.startsWith("el") ? "el" : "en";
      currentLang = localStorage.getItem(LANG_STORAGE_KEY) || defaultLang;
      if (!I18N[currentLang]) currentLang = "en";
      applyTranslations();
    }

    function formatSize(bytes) {
      if (bytes == null) return "";
      if (bytes < 1024) return bytes + " B";
      const kb = bytes / 1024;
      if (kb < 1024) return kb.toFixed(1) + " KB";
      const mb = kb / 1024;
      return mb.toFixed(1) + " MB";
    }

    function scrollMessagesToBottom() {
      // Double requestAnimationFrame for smooth scrolling
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
      });

      // Fallback timeout to ensure scroll happens even if rAF doesn't work
      setTimeout(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, 50);
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // Extract [[FILE:name.ext]]...[[/FILE]] blocks from AI text, return:
    // { cleanedText, files: [{name, content}] }
    function extractAiFilesFromText(raw) {
      const files = [];
      let text = raw;
      const regex = /\[\[FILE:([^\]]+)\]\]([\s\S]*?)\[\[\/FILE\]\]/g;
      let match;
      while ((match = regex.exec(raw)) !== null) {
        const name = match[1].trim();
        const content = match[2];
        files.push({ name, content });
      }
      text = raw.replace(regex, "").trim();
      return { cleanedText: text, files };
    }

    // --- Rendering ---

    function renderSessions() {
      sessionsListEl.innerHTML = "";
      sessions.forEach((s) => {
        const li = document.createElement("li");
        li.className =
          "session-item" + (s.id === currentSessionId ? " active" : "");
        li.dataset.id = s.id;

        const nameRow = document.createElement("div");
        nameRow.className = "session-name-row";

        const nameSpan = document.createElement("div");
        nameSpan.className = "session-name";
        nameSpan.textContent = s.title || "Untitled session";

        // Add delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "session-delete-btn";
        deleteBtn.innerHTML = "√ó";
        deleteBtn.title = "Delete session";
        deleteBtn.addEventListener("click", async (e) => {
          e.stopPropagation(); // Don't trigger session switch
          if (!confirm(`Delete "${s.title || 'Untitled session'}"?`)) return;

          try {
            const res = await fetch(API_SESSION(s.id), {
              method: "DELETE",
            });
            if (res.ok) {
              // Remove from local array
              sessions = sessions.filter(sess => sess.id !== s.id);
              // If deleted current session, switch to first available
              if (s.id === currentSessionId && sessions.length > 0) {
                currentSessionId = sessions[0].id;
                loadSessionMessages(currentSessionId);
                sessionTitleEl.textContent = sessions[0].title || "Mesh session";
              } else if (sessions.length === 0) {
                // No sessions left, create new one
                await createNewSession();
              }
              renderSessions();
            }
          } catch (e) {
            console.error("Delete session error:", e);
            alert("Failed to delete session");
          }
        });

        const statusPill = document.createElement("div");
        statusPill.className = "session-status-pill";
        statusPill.innerHTML = `<span>${(s.model || "auto").toUpperCase()}</span> ¬∑ ${
          s.created_at || ""
        }`;

        nameRow.appendChild(nameSpan);
        nameRow.appendChild(deleteBtn);

        const metaRow = document.createElement("div");
        metaRow.className = "session-meta";
        metaRow.innerHTML = `<span>${
          s.message_count || 0
        } messages</span><span>${s.last_updated || ""}</span>`;

        li.appendChild(nameRow);
        li.appendChild(statusPill);
        li.appendChild(metaRow);

        li.addEventListener("click", () => {
          if (s.id !== currentSessionId) {
            currentSessionId = s.id;
            loadSessionMessages(s.id);
            renderSessions();
            sessionTitleEl.textContent = s.title || "Mesh session";
          }
        });

        sessionsListEl.appendChild(li);
      });
    }

    function renderPendingFiles() {
      if (!pendingFiles.length) {
        pendingFilesRowEl.style.display = "none";
        pendingFilesListEl.innerHTML = "";
        return;
      }
      pendingFilesRowEl.style.display = "flex";
      pendingFilesListEl.innerHTML = "";
      pendingFiles.forEach((f) => {
        const chip = document.createElement("div");
        chip.className = "pending-file-chip";

        const label = document.createElement("span");
        label.textContent = `${f.name} (${formatSize(f.size)})`;

        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-file-btn";
        removeBtn.textContent = "√ó";
        removeBtn.addEventListener("click", () => {
          pendingFiles = pendingFiles.filter((x) => x.id !== f.id);
          renderPendingFiles();
        });

        chip.appendChild(label);
        chip.appendChild(removeBtn);
        pendingFilesListEl.appendChild(chip);
      });
    }

    function createThumbButtons(messageText) {
      const wrapper = document.createElement("div");
      wrapper.className = "msg-actions";

      const upBtn = document.createElement("button");
      upBtn.className = "thumb-btn up";
      upBtn.innerHTML = "üëç <span>good</span>";

      const downBtn = document.createElement("button");
      downBtn.className = "thumb-btn down";
      downBtn.innerHTML = "üëé <span>bad</span>";

      function setActive(which) {
        upBtn.classList.toggle("active", which === "up");
        downBtn.classList.toggle("active", which === "down");
      }

      async function sendFeedback(isUp) {
        try {
          await fetch(API_FEEDBACK, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              session_id: currentSessionId,
              message_text: messageText,
              thumbs_up: !!isUp,
            }),
          });
        } catch (e) {
          console.warn("Feedback error:", e);
        }
      }

      upBtn.addEventListener("click", () => {
        setActive("up");
        sendFeedback(true);
      });

      downBtn.addEventListener("click", () => {
        setActive("down");
        sendFeedback(false);
      });

      wrapper.appendChild(upBtn);
      wrapper.appendChild(downBtn);
      return wrapper;
    }

    function appendMessage(msg) {
      // msg: { role: "user" | "ai" | ..., content, model?, files? }
      const row = document.createElement("div");
      const isUser = msg.role === "user";
      row.className = "msg-row " + (isUser ? "user" : "ai");

      const avatar = document.createElement("div");
      avatar.className = "msg-avatar";
      avatar.textContent = isUser ? "YOU" : "AI";

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";

      const header = document.createElement("div");
      header.className = "msg-header";
      const authorSpan = document.createElement("div");
      authorSpan.className = "msg-author";
      authorSpan.textContent = isUser ? "USER" : "QUANTUM AGENT";
      const metaSpan = document.createElement("div");
      metaSpan.className = "msg-model-tag";
      if (msg.model) metaSpan.textContent = msg.model;
      header.appendChild(authorSpan);
      header.appendChild(metaSpan);

      let text = msg.content || "";
      let extraFiles = [];
      if (!isUser && text) {
        const extracted = extractAiFilesFromText(text);
        text = extracted.cleanedText;
        extraFiles = extracted.files;
      }

      const content = document.createElement("div");
      content.className = "msg-content";
      content.textContent = text;

      bubble.appendChild(header);
      bubble.appendChild(content);

      const allFiles = []
        .concat(msg.files || [])
        .concat(
          extraFiles.map((f) => ({
            // placeholder; server should create real file_id if you want
            name: f.name,
            file_id: null,
            inline_content: f.content,
          }))
        );

      if (allFiles.length) {
        const filesDiv = document.createElement("div");
        filesDiv.className = "msg-files";
        allFiles.forEach((f) => {
          if (f.url) {
            const a = document.createElement("a");
            a.className = "msg-file-link";
            a.href = f.url;
            a.target = "_blank";
            a.textContent = f.name || "file";
            filesDiv.appendChild(a);
          } else if (f.file_id) {
            const a = document.createElement("a");
            a.className = "msg-file-link";
            a.href = `/api/ai/files/${encodeURIComponent(f.file_id)}`;
            a.target = "_blank";
            a.textContent = f.name || "file";
            filesDiv.appendChild(a);
          } else if (f.inline_content != null) {
            const a = document.createElement("a");
            a.className = "msg-file-link";
            const blob = new Blob([f.inline_content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            a.href = url;
            a.download = f.name || "file.txt";
            a.textContent = f.name || "inline.txt";
            filesDiv.appendChild(a);
          }
        });
        bubble.appendChild(filesDiv);
      }

      if (!isUser) {
        const actions = createThumbButtons(text);
        bubble.appendChild(actions);
      }

      row.appendChild(isUser ? bubble : avatar);
      row.appendChild(isUser ? avatar : bubble);

      messagesEl.appendChild(row);
      scrollMessagesToBottom();
    }

    function renderMessages(list) {
      messagesEl.innerHTML = "";
      (list || []).forEach(appendMessage);
    }

    // --- API calls ---

    async function loadWallet() {
      try {
        // Read wallet from localStorage (same as other pages)
        const w = localStorage.getItem('thr_address') || "";
        walletInputEl.value = w;

        // Update wallet label with connection status
        const walletPill = walletLabelEl.parentElement;
        if (w) {
          walletLabelEl.textContent = w.slice(0, 6) + "‚Ä¶" + w.slice(-4);
          walletPill.classList.remove('pill-danger');
          walletPill.classList.add('pill-success');
        } else {
          walletLabelEl.textContent = "not connected";
          walletPill.classList.remove('pill-success');
          walletPill.classList.add('pill-danger');
        }
      } catch (e) {
        console.warn("Wallet load failed", e);
        walletLabelEl.textContent = "error";
      }
    }

    async function loadSessions() {
      try {
        const res = await fetch(API_SESSIONS);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        sessions = data.sessions || [];
        renderSessions();

        if (!currentSessionId && sessions.length) {
          currentSessionId = sessions[0].id;
          localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        } else if (!currentSessionId && !sessions.length) {
          setSessionStatus(t("status_no_sessions"));
        }

        if (currentSessionId) {
          const s = sessions.find((x) => x.id === currentSessionId);
          if (s) sessionTitleEl.textContent = s.title || "Mesh session";
        }
      } catch (e) {
        console.error("loadSessions error", e);
          setSessionState("error", t("status_failed_sessions"));
      }
    }

    async function loadSessionMessages(id) {
      if (!id) return;
      setSessionState("loading");
      try {
        const res = await fetch(API_SESSION_MESSAGES(id));
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const session = data.session || {};
        currentSessionId = session.id || id;
        if (currentSessionId) {
          localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        }
        sessionTitleEl.textContent = session.title || "Mesh session";
        modelStatusEl.textContent = session.model || modelSelectEl.value || "auto";
        renderMessages(data.messages || []);
        setSessionState("ready");
      } catch (e) {
        console.error("loadSessionMessages error", e);
        setSessionState("error", t("status_failed_messages"));
      }
    }

    async function validateSession(sessionId) {
      try {
        const res = await fetch(API_SESSION(sessionId));
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        currentSessionId = data.id || sessionId;
        sessionTitleEl.textContent = data.title || "Mesh session";
        localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        setSessionState("ready");
        return true;
      } catch (e) {
        console.warn("validateSession error", e);
        return false;
      }
    }

    async function createSession(isRetry = false) {
      setSessionState("loading");
      try {
        const wallet = walletInputEl.value.trim();
        const res = await fetch(API_SESSION_NEW, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: isRetry ? "Recovered session" : "New mesh session",
            wallet: wallet || null,
          }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        currentSessionId = data.id;
        localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        await loadSessions();
        await loadSessionMessages(currentSessionId);
        setSessionState("ready");
      } catch (e) {
        console.error("createSession error", e);
        setSessionState("error", t("status_error"));
      }
      await createSession(true);
    }

    async function ensureSession() {
      setSessionState("loading");
      const storedId = localStorage.getItem(SESSION_STORAGE_KEY);
      if (storedId) {
        const ok = await validateSession(storedId);
        if (ok) {
          await loadSessions();
          await loadSessionMessages(currentSessionId);
          return;
        }
      }
      await createSession(true);
    }

    async function renameSession() {
      if (!currentSessionId) return;
      const s = sessions.find((x) => x.id === currentSessionId);
      const currentName = s ? s.title || "" : "";
      const newName = prompt("Rename session:", currentName);
      if (!newName || newName === currentName) return;
      try {
        const res = await fetch(API_SESSION(currentSessionId), {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: newName }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        await loadSessions();
      } catch (e) {
        console.error("renameSession error", e);
      }
    }

    async function uploadFiles(files) {
      if (!files || !files.length) return;
      const form = new FormData();
      for (const f of files) {
        form.append("files", f, f.name);
      }
      // CRITICAL: Include wallet and session_id for ownership tracking
      const wallet = walletInputEl.value.trim();
      if (wallet) {
        form.append("wallet", wallet);
      }
      if (currentSessionId) {
        form.append("session_id", currentSessionId);
      }
      setUploadStatus(t("status_loading"));
      try {
        const res = await fetch(API_FILES, {
          method: "POST",
          body: form,
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const uploaded = data.files || [];
        uploaded.forEach((f) => {
          pendingFiles.push({
            id: f.id,
            name: f.name,
            size: f.size,
          });
        });
        renderPendingFiles();
        setUploadStatus(t("upload_success"), "ok");
      } catch (e) {
        console.error("uploadFiles error", e);
        setUploadStatus(t("upload_failed"), "error");
      }
    }

    async function loadTelemetry() {
      try {
        const res = await fetch(API_TELEMETRY);
        if (!res.ok) return;
        const data = await res.json();
        if (data.hashrate != null)
          hashrateLabelEl.textContent = data.hashrate + " H/s";
        if (data.pending_txs != null)
          pendingTxsLabelEl.textContent = data.pending_txs;
        if (data.difficulty != null)
          difficultyLabelEl.textContent = data.difficulty;
        if (data.ai_credits != null) creditsLabelEl.textContent = data.ai_credits;
      } catch (e) {
        console.warn("telemetry error", e);
      }
    }

    async function sendMessage() {
      const text = messageInputEl.value.trim();
      if (!text && !pendingFiles.length) return;
      if (!currentSessionId) {
        alert(t("no_active_session"));
        return;
      }
      if (sessionState === "loading") return;
      if (sessionState === "error") {
        setSessionStatus(t("session_not_ready"));
        return;
      }
      const wallet = walletInputEl.value.trim();
      setSending(false);
      setSessionStatus(t("status_sending"));
      usageStatusEl.textContent = "";

      const model = modelSelectEl.value || "auto";
      modelStatusEl.textContent = model;

      const payload = {
        session_id: currentSessionId,
        wallet: wallet || null,
        message: text,
        attachment_ids: pendingFiles.map((f) => f.id),
        model_key: model,
        lang: currentLang,
      };

      // optimistic render user message
      appendMessage({ role: "user", content: text, model: "user" });

      messageInputEl.value = "";
      pendingFiles = [];
      renderPendingFiles();

      try {
        const res = await fetch(API_CHAT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        // Handle no credits case
        if (data.status === "no_credits") {
          appendMessage({
            role: "assistant",
            content: data.response || "No AI credits available. Please purchase an AI pack to continue.",
            model: "system",
          });
          setSessionStatus("Ready");
          setSending(true);
          return;
        }

        // AI reply - handle actual server response format
        if (data.response) {
          appendMessage({
            role: "assistant",
            content: data.response,
            model: data.model || model,
            files: (data.files || []).map((f) => ({
              file_id: f.id || f.file_id,
              name: f.name || f.filename,
              url: f.url || null,
            })),
          });
        }

        // Update credits display if available
        if (data.credits !== undefined) {
          usageStatusEl.textContent = `AI Credits: ${data.credits}`;
        }

        // Update wallet if returned
        if (data.wallet) {
          walletInputEl.value = data.wallet;
          const w = data.wallet;
          walletLabelEl.textContent = w.slice(0, 6) + "‚Ä¶" + w.slice(-4);
        }

        setSessionStatus("Ready");
      } catch (e) {
        console.error("sendMessage error", e);
        appendMessage({
          role: "assistant",
          content: "Error: " + e.message,
          model: "system",
        });
        setSessionStatus(t("status_error"));
      } finally {
        setSending(true);
      }
    }

    // --- Events ---
    function bindEvents() {
      document
        .getElementById("newSessionBtn")
        .addEventListener("click", createSession);
      document
        .getElementById("renameSessionBtn")
        .addEventListener("click", renameSession);

      modelSelectEl.addEventListener("change", handleModelChange);

      retrySessionBtnEl.addEventListener("click", ensureSession);

      fileInputEl.addEventListener("change", (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length) {
          uploadFiles(files);
        }
        fileInputEl.value = "";
      });

      clearPendingBtnEl.addEventListener("click", () => {
        pendingFiles = [];
        renderPendingFiles();
      });

      sendBtnEl.addEventListener("click", () => {
        sendMessage();
      });

      messageInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // --- Init ---
    async function init() {
      cacheDom();
      initI18n();
      bindEvents();
      await loadWallet();
      initModelSelector();
      await ensureSession();
      loadTelemetry();
      setInterval(loadTelemetry, 15000);
      setSending(true);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
