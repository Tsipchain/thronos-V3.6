<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thronos Quantum Chat</title>
  <style>
    :root{--bg:#050a08;--panel:#07110d;--fg:#dfffe9;--muted:#6fe7b0;--border:#0ee07f;--accent:#00ff88;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .topbar{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid rgba(14,224,127,.35);background:linear-gradient(180deg,rgba(0,255,136,.08),transparent);}
    .badge{padding:4px 10px;border:1px solid rgba(14,224,127,.6);border-radius:999px;color:var(--muted);font-size:12px}
    .wrap{display:grid;grid-template-columns:280px 1fr; height:calc(100% - 50px);}
    .sidebar{border-right:1px solid rgba(14,224,127,.25);padding:10px;background:rgba(7,17,13,.7)}
    .main{display:flex;flex-direction:column;}
    .btn{cursor:pointer;padding:10px 12px;border:1px solid rgba(14,224,127,.7);border-radius:10px;background:rgba(0,0,0,.25);color:var(--fg)}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,255,136,.12) inset}
    .input,select{width:100%;padding:10px 12px;border:1px solid rgba(14,224,127,.35);border-radius:10px;background:rgba(0,0,0,.25);color:var(--fg);outline:none}
    .input:focus,select:focus{border-color:var(--accent)}
    .sessions{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 220px);overflow:auto}
    .sess{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border:1px solid rgba(14,224,127,.2);border-radius:12px;background:rgba(0,0,0,.18)}
    .sess.active{border-color:rgba(0,255,136,.75)}
    .sess small{color:rgba(223,255,233,.7)}
    .sess .x{padding:4px 8px;border-radius:8px;border:1px solid rgba(255,70,70,.55);background:rgba(255,0,0,.08);color:#ff9b9b}
    .center{flex:1;overflow:auto;padding:16px}
    .bubble{max-width:860px;margin:10px 0;padding:14px;border:1px solid rgba(14,224,127,.25);border-radius:14px;background:rgba(0,0,0,.22)}
    .me{margin-left:auto;border-color:rgba(0,255,136,.55);background:rgba(0,255,136,.08)}
    .meta{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:rgba(223,255,233,.65)}
    .composer{display:flex;gap:10px;align-items:center;padding:12px;border-top:1px solid rgba(14,224,127,.25);background:rgba(7,17,13,.7)}
    .drop{flex:1;border:1px dashed rgba(14,224,127,.35);border-radius:12px;padding:10px;background:rgba(0,0,0,.18)}
    .row{display:flex;gap:8px;align-items:center}
    .files{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{border:1px solid rgba(14,224,127,.25);border-radius:999px;padding:4px 10px;font-size:12px;color:rgba(223,255,233,.85)}
    .err{color:#ffb3b3;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:700;letter-spacing:.12em">THRONOS QUANTUM ASSISTANT</div>
    <div class="badge" id="qbadge">Quantum Encryption Active</div>
    <div style="flex:1"></div>
    <div class="row" style="gap:8px;min-width:420px">
      <label style="min-width:80px;color:rgba(223,255,233,.7)">THR wallet:</label>
      <input class="input" id="wallet" placeholder="THR..." />
      <select id="model" class="input" style="max-width:190px">
        <option value="auto">Auto (Smart)</option>
        <option value="gpt-4o">GPT‑4o</option>
        <option value="gpt-4.1-mini">GPT‑4.1‑mini</option>
        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
      </select>
      <button class="btn" id="loadBtn">Load</button>
    </div>
  </div>

  <div class="wrap">
    <aside class="sidebar">
      <button class="btn" id="newBtn" style="width:100%">+ New Chat</button>
      <div class="err" id="sideErr" style="display:none"></div>
      <div class="sessions" id="sessions"></div>
    </aside>

    <main class="main">
      <div class="center" id="chat"></div>

      <div class="composer">
        <div class="drop" id="drop">
          <div class="row" style="justify-content:space-between">
            <div style="opacity:.8">Drop files here or choose</div>
            <div class="row">
              <input type="file" id="file" multiple />
              <button class="btn" id="uploadBtn">Upload</button>
            </div>
          </div>
          <div class="files" id="pending"></div>
          <div class="err" id="upErr" style="display:none"></div>
        </div>
        <input class="input" id="msg" placeholder="Type a command to Thronos..." />
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </main>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
let currentSession = null;
let sessions = [];
let pendingFiles = []; // {id,filename,size,content_type}

function showErr(el, msg){
  el.style.display = msg ? "block":"none";
  el.textContent = msg || "";
}
function fmtTime(iso){
  if(!iso) return "";
  try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; }
}
function renderSessions(){
  const box = $("sessions");
  box.innerHTML = "";
  const w = $("wallet").value.trim();
  if(!w){
    box.innerHTML = `<div style="opacity:.6;padding:10px">Enter wallet to load sessions…</div>`;
    return;
  }
  sessions.forEach(s=>{
    const div=document.createElement("div");
    div.className="sess"+(currentSession && currentSession.id===s.id?" active":"");
    div.innerHTML = `
      <div style="min-width:0;flex:1;cursor:pointer">
        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(s.title||"New Chat")}</div>
        <small>${escapeHtml(fmtTime(s.updated_at||s.created_at))}</small>
      </div>
      <button class="x" title="Hide session (kept for training)">✕</button>
    `;
    div.children[0].onclick = ()=>{ currentSession=s; localStorage.setItem("thr_session", s.id); renderSessions(); renderChat(); };
    div.querySelector(".x").onclick = async (ev)=>{
      ev.stopPropagation();
      await archiveSession(s.id);
    };
    box.appendChild(div);
  });
}
function renderChat(){
  const box=$("chat");
  box.innerHTML="";
  if(!currentSession){
    box.innerHTML = `<div style="opacity:.6">wallet loaded. select a session.</div>`;
    return;
  }
  // Minimal: show session header only. Messages are still handled by your existing /api/chat pipeline.
  const head=document.createElement("div");
  head.className="bubble";
  head.innerHTML = `<div class="meta"><div>Session: <b>${escapeHtml(currentSession.title)}</b></div><div>${escapeHtml(currentSession.id)}</div></div>`;
  box.appendChild(head);
  box.scrollTop=box.scrollHeight;
}
function renderPending(){
  const p=$("pending");
  p.innerHTML="";
  pendingFiles.forEach(f=>{
    const c=document.createElement("div");
    c.className="chip";
    c.textContent = `${f.filename} (${Math.round((f.size||0)/1024)} KB)`;
    p.appendChild(c);
  });
}

async function loadSessions(){
  const wallet=$("wallet").value.trim();
  if(!wallet){ showErr($("sideErr"), "Wallet required."); return; }
  showErr($("sideErr"), "");
  try{
    const r=await fetch(`/api/ai_sessions?wallet=${encodeURIComponent(wallet)}`);
    const t=await r.text();
    let j=null;
    try{ j=JSON.parse(t); }catch(e){ throw new Error("Non‑JSON response from server"); }
    if(!j.ok) throw new Error(j.error||"failed");
    sessions=j.sessions||[];
    // restore last session if exists
    const last = localStorage.getItem("thr_session");
    currentSession = sessions.find(s=>s.id===last) || sessions[0] || null;
    renderSessions(); renderChat();
  }catch(e){
    showErr($("sideErr"), "Sessions load error: "+e.message);
  }
}

async function newSession(){
  const wallet=$("wallet").value.trim();
  if(!wallet){ showErr($("sideErr"), "Wallet required."); return; }
  const model=$("model").value;
  try{
    const r=await fetch(`/api/ai_sessions/start`,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({wallet,title:"New Chat",model})
    });
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||"failed");
    sessions.unshift(j.session);
    currentSession=j.session;
    localStorage.setItem("thr_session", j.session.id);
    renderSessions(); renderChat();
  }catch(e){
    showErr($("sideErr"), "New session error: "+e.message);
  }
}

async function archiveSession(id){
  const wallet=$("wallet").value.trim();
  try{
    const r=await fetch(`/api/ai_sessions/delete`,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({wallet,session_id:id})
    });
    const j=await r.json().catch(()=>({ok:false,error:"bad json"}));
    if(!j.ok && r.status!==404) throw new Error(j.error||"failed");
    sessions = sessions.filter(s=>s.id!==id);
    if(currentSession && currentSession.id===id) currentSession = sessions[0]||null;
    renderSessions(); renderChat();
  }catch(e){
    showErr($("sideErr"), "Delete error: "+e.message);
  }
}

async function uploadSelected(files){
  const wallet=$("wallet").value.trim();
  const sid = currentSession ? currentSession.id : "";
  if(!files || !files.length){ return; }
  showErr($("upErr"), "");
  for(const file of files){
    const fd=new FormData();
    fd.append("wallet", wallet);
    fd.append("session_id", sid);
    fd.append("file", file);
    const r=await fetch("/api/ai/files/upload",{method:"POST", body:fd});
    const t=await r.text();
    let j=null;
    try{ j=JSON.parse(t);}catch(e){ throw new Error("Upload returned non‑JSON"); }
    if(!j.ok) throw new Error(j.error||"upload failed");
    pendingFiles.push(j.file);
    renderPending();
  }
}

async function sendMessage(){
  const wallet=$("wallet").value.trim();
  const model=$("model").value;
  const sid=currentSession ? currentSession.id : "";
  const msg=$("msg").value.trim();
  if(!msg) return;

  const payload = { wallet, session_id:sid, model, message:msg, attachments: pendingFiles };
  $("msg").value="";
  // optimistic bubble
  const box=$("chat");
  const b=document.createElement("div");
  b.className="bubble me";
  b.innerHTML = `<div>${escapeHtml(msg)}</div><div class="meta"><div>You</div><div>${escapeHtml(new Date().toLocaleString())}</div></div>`;
  box.appendChild(b); box.scrollTop=box.scrollHeight;

  try{
    const r=await fetch("/api/chat",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const t=await r.text();
    let j=null;
    try{ j=JSON.parse(t);}catch(e){ throw new Error("Chat returned non‑JSON"); }
    if(!j.ok) throw new Error(j.error||"chat failed");
    const ans=document.createElement("div");
    ans.className="bubble";
    ans.innerHTML = `<div>${escapeHtml(j.reply||"")}</div>
      ${Array.isArray(j.files)?`<div class="files">${j.files.map(f=>`<a class="chip" href="/api/ai/files/${encodeURIComponent(f.id)}" target="_blank">${escapeHtml(f.filename)}</a>`).join("")}</div>`:""}
      <div class="meta"><div>Thronos</div><div>${escapeHtml(fmtTime(j.ts))}</div></div>`;
    box.appendChild(ans); box.scrollTop=box.scrollHeight;
    pendingFiles=[]; renderPending();
    await loadSessions(); // refresh updated_at
  }catch(e){
    showErr($("upErr"), e.message);
  }
}

function escapeHtml(s){
  return (s??"").toString().replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[c]));
}

$("loadBtn").onclick = loadSessions;
$("newBtn").onclick = newSession;
$("sendBtn").onclick = sendMessage;
$("uploadBtn").onclick = async()=>{ await uploadSelected($("file").files); $("file").value=""; };
$("msg").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ sendMessage(); } });

$("drop").addEventListener("dragover",(e)=>{ e.preventDefault(); $("drop").style.borderColor="rgba(0,255,136,.75)"; });
$("drop").addEventListener("dragleave",()=>{ $("drop").style.borderColor="rgba(14,224,127,.35)"; });
$("drop").addEventListener("drop", async (e)=>{
  e.preventDefault(); $("drop").style.borderColor="rgba(14,224,127,.35)";
  const files=[...e.dataTransfer.files];
  await uploadSelected(files);
});
</script>
</body>
</html>
