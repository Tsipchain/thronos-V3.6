<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thronos Quantum Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020712;
      --bg-alt: #050b18;
      --panel: #050f1f;
      --panel-alt: #071628;
      --accent: #23ff6b;
      --accent-soft: rgba(35, 255, 107, 0.15);
      --accent-soft-2: rgba(35, 255, 107, 0.05);
      --danger: #ff4b81;
      --text: #e6fff4;
      --muted: #7aa398;
      --border: #102338;
      --border-soft: rgba(16, 35, 56, 0.7);
      --shadow-soft: 0 0 40px rgba(0, 0, 0, 0.7);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition-fast: 150ms ease-out;
      --transition-med: 220ms ease-out;
      --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #07162a 0, #020712 55%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 18px;
    }

    .quantum-shell {
      width: 100%;
      max-width: 1600px;  /* Increased from 1360px for better full screen use */
      height: 100vh;
      max-height: calc(100vh - 36px);  /* Use full viewport height minus padding */
      background: radial-gradient(circle at top left, #08162a 0, #020712 55%);
      border-radius: 26px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .quantum-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      background: radial-gradient(
          circle at 10% 0,
          rgba(35, 255, 107, 0.1),
          transparent 55%
        ),
        radial-gradient(
          circle at 90% 0,
          rgba(0, 255, 255, 0.08),
          transparent 60%
        );
      mix-blend-mode: screen;
      opacity: 0.6;
    }

    .q-header {
      position: relative;
      z-index: 1;
      padding: 14px 20px 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-soft);
      background: linear-gradient(
        135deg,
        rgba(3, 13, 30, 0.98),
        rgba(3, 11, 25, 0.95)
      );
      backdrop-filter: blur(12px);
    }

    .q-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-main {
      display: flex;
      align-items: center;
    }

    .brand-logo {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 0, #23ff6b, #071628);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 14px;
      box-shadow: 0 0 20px rgba(35, 255, 107, 0.5);
    }

    .brand-logo img {
      max-width: 70%;
      max-height: 70%;
      display: block;
    }

    .th-chip {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.1em;
      text-shadow: 0 0 8px rgba(35, 255, 107, 0.9);
      box-shadow: 0 0 18px rgba(35, 255, 107, 0.4);
    }

    .q-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .q-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .q-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .q-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(4, 18, 32, 0.85);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .pill-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .pill-value {
      color: var(--text);
      font-weight: 500;
    }

    .pill-quiet .pill-dot {
      background: #7aa398;
      box-shadow: none;
    }

    .pill-danger .pill-dot {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger);
    }

    .pill-success .pill-dot {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .q-main {
      position: relative;
      z-index: 1;
      flex: 1;
      display: grid;
      grid-template-columns: 260px minmax(0, 1.5fr) 260px;
      grid-template-rows: minmax(0, 1fr);  /* ADDED - constrains row height to prevent overflow */
      gap: 12px;
      padding: 12px 16px 14px 16px;
      min-height: 0;  /* ADDED - allows grid to shrink properly */
    }

    .error-banner {
      display: none;
      background: rgba(255, 75, 129, 0.1);
      border: 1px solid rgba(255, 75, 129, 0.4);
      color: #ffc2d6;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .error-banner strong {
      color: #ff4b81;
    }

    .error-banner button {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    /* Left column (sessions) */

    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, #061426 0, #050b18 55%);
      border: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .panel-title {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-actions {
      display: flex;
      gap: 6px;
    }

    .btn-ghost {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(3, 13, 30, 0.7);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast);
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      background: rgba(9, 32, 50, 0.9);
      color: var(--accent);
      transform: translateY(-0.5px);
    }

    .btn-ghost-danger:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .sessions-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      flex: 1;
      font-size: 12px;
    }

    .session-item {
      border-radius: var(--radius-md);
      padding: 7px 9px;
      border: 1px solid rgba(16, 35, 56, 0.9);
      background: linear-gradient(
        135deg,
        rgba(5, 17, 32, 0.95),
        rgba(4, 13, 26, 0.96)
      );
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .session-item:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.15);
      transform: translateY(-0.5px);
    }

    .session-item.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.2);
      background: radial-gradient(circle at top left, #071f35 0, #040d1b 55%);
    }

    .session-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .session-name {
      font-size: 12px;
      font-weight: 500;
      flex: 1;
    }

    .session-delete-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      padding: 0 4px;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
    }

    .session-item:hover .session-delete-btn {
      opacity: 1;
    }

    .session-delete-btn:hover {
      color: #ff4444;
    }

    .session-meta {
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .session-status-pill {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(64, 96, 112, 0.9);
      font-size: 9px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .session-status-pill span {
      color: var(--accent);
    }

    /* Center column (chat) */

    .chat-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: radial-gradient(circle at top, #07182e 0, #040b17 55%);
      padding: 8px 10px;
      position: relative;
      overflow: hidden;  /* CHANGED from visible - prevents content overflow */
      min-height: 0;
    }

    .chat-panel::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
          to bottom,
          rgba(35, 255, 107, 0.04),
          transparent 30%
        ),
        linear-gradient(to right, rgba(0, 255, 255, 0.04), transparent 35%);
      opacity: 0.9;
    }

    .chat-panel-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      gap: 8px;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 2px 4px 4px;
    }

    .chat-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #sessionTitle {
      font-size: 12px;
      font-weight: 500;
    }

    #sessionStatusTag {
      font-size: 10px;
      color: var(--muted);
    }

    .chat-badges-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(6, 18, 32, 0.9);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .badge strong {
      color: var(--accent);
      font-weight: 500;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
      padding: 6px 4px 8px 4px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(12, 30, 51, 0.9);
      background: radial-gradient(circle at top, #050f1f 0, #040a16 55%);
      font-size: 13px;
      scroll-behavior: smooth;
    }

    .msg-row {
      display: flex;
      margin-bottom: 10px;
      gap: 6px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
      flex-shrink: 0;
      background: rgba(3, 12, 26, 0.96);
    }

    .msg-bubble {
      max-width: 100%;
      padding: 7px 9px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(20, 50, 80, 0.9);
      background: rgba(5, 16, 32, 0.98);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }

    .msg-row.user .msg-bubble {
      border-color: rgba(35, 255, 107, 0.7);
      background: rgba(7, 26, 40, 0.98);
    }

    .msg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--muted);
    }

    .msg-author {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-weight: 500;
    }

    .msg-model-tag {
      font-size: 10px;
      color: #a6e2ff;
    }

    .msg-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
      line-height: 1.4;
    }

    .msg-files {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .ai-files {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text);
    }

    .ai-files a {
      color: var(--accent);
      text-decoration: none;
    }

    .msg-file-link {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(74, 119, 128, 0.9);
      background: rgba(5, 20, 30, 0.96);
      color: var(--accent);
      text-decoration: none;
    }

    .msg-actions {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .thumb-btn {
      border-radius: 999px;
      border: 1px solid rgba(50, 80, 100, 0.9);
      background: rgba(4, 15, 26, 0.96);
      color: var(--muted);
      font-size: 11px;
      padding: 2px 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast);
    }

    .thumb-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-0.5px);
    }

    .thumb-btn.down:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    .thumb-btn.active {
      border-color: var(--accent);
      background: rgba(35, 255, 107, 0.09);
      color: var(--accent);
    }

    .thumb-btn.down.active {
      border-color: var(--danger);
      background: rgba(255, 75, 129, 0.08);
      color: var(--danger);
    }

    .chat-input-block {
      border-radius: var(--radius-md);
      border: 1px solid rgba(16, 35, 56, 0.9);
      background: radial-gradient(circle at top, #050f22 0, #030917 55%);
      padding: 8px 9px 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .wallet-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    #walletInput {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 11px;
      padding: 5px 7px;
      border-radius: 999px;
      border: 1px solid rgba(40, 72, 96, 0.9);
      background: rgba(2, 9, 18, 0.96);
      color: var(--text);
    }

    #walletInput:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.2);
    }

    .wallet-label {
      font-size: 10px;
      color: var(--muted);
    }

    .input-row-main {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    #messageInput {
      flex: 1;
      min-height: 40px;
      max-height: 80px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(40, 72, 96, 0.9);
      background: rgba(3, 10, 20, 0.96);
      color: var(--text);
      padding: 6px 8px;
      font-size: 13px;
      font-family: var(--font-sans);
    }

    #messageInput:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(35, 255, 107, 0.2);
    }

    .input-side {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: flex-end;
    }

    .attach-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    #fileInput {
      display: none;
    }

    .attach-btn {
      border-radius: 999px;
      border: 1px dashed rgba(60, 92, 116, 0.9);
      background: rgba(5, 14, 26, 0.96);
      color: var(--muted);
      padding: 3px 7px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: border-color var(--transition-fast),
        color var(--transition-fast), background var(--transition-fast);
    }

    .attach-btn:hover {
      border-style: solid;
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(7, 22, 36, 0.96);
    }

    .model-select {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(60, 92, 116, 0.9);
      background: rgba(5, 14, 26, 0.96);
      color: var(--text);
      padding: 3px 6px;
    }

    .send-btn {
      margin-top: 2px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: radial-gradient(circle at 30% 0, #22ff6a 0, #059448 55%, #02361b 100%);
      color: #021108;
      font-weight: 600;
      font-size: 12px;
      padding: 5px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 0 20px rgba(35, 255, 107, 0.18);
      transition: transform var(--transition-med), box-shadow var(--transition-med),
        filter var(--transition-med), opacity var(--transition-med);
    }

    .send-btn[disabled] {
      opacity: 0.45;
      cursor: default;
      filter: grayscale(0.2);
      box-shadow: none;
    }

    .send-btn:not([disabled]):hover {
      transform: translateY(-1px);
      box-shadow: 0 0 28px rgba(35, 255, 107, 0.3);
      filter: brightness(1.06);
    }

    #pendingFilesRow {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .pending-files-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .pending-file-chip {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(70, 110, 126, 0.9);
      background: rgba(4, 14, 24, 0.96);
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pending-file-chip span {
      color: var(--accent);
    }

    .pending-file-chip .remove-file-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 11px;
      padding: 0 4px;
    }

    .pending-file-chip .remove-file-btn:hover {
      color: var(--danger);
    }

    .remove-link {
      cursor: pointer;
      text-decoration: underline;
      color: var(--muted);
    }

    .remove-link:hover {
      color: var(--danger);
    }

    #uploadStatus,
    #usageStatus {
      font-size: 10px;
      color: var(--muted);
    }

    #uploadStatus.ok {
      color: var(--accent);
    }

    #uploadStatus.error {
      color: var(--danger);
    }

    /* Right column (telemetry) */

    .telemetry-kv {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .telemetry-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 6px;
      border-radius: var(--radius-md);
      background: rgba(4, 13, 24, 0.95);
      border: 1px solid rgba(20, 44, 68, 0.9);
    }

    .telemetry-row strong {
      color: var(--accent);
      font-weight: 500;
    }

    .telemetry-note {
      margin-top: 4px;
      font-size: 10px;
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      body {
        padding: 10px;
      }
      .quantum-shell {
        max-height: none;
        height: auto;
        min-height: 100vh;  /* Ensure full height on smaller screens */
      }
      .q-main {
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 2.2fr);
        grid-template-rows: minmax(400px, 1fr) minmax(200px, auto);  /* Give chat more space */
        grid-template-areas:
          "sessions chat"
          "telemetry chat";
      }
      .panel.sessions {
        grid-area: sessions;
      }
      .chat-panel {
        grid-area: chat;
      }
      .panel.telemetry {
        grid-area: telemetry;
      }
    }

    @media (max-width: 900px) {
      .q-main {
        grid-template-columns: 1fr;
        grid-template-areas:
          "chat"
          "sessions"
          "telemetry";
      }
      .panel.sessions,
      .panel.telemetry {
        height: auto;
        max-height: 260px;
      }
    }
  </style>
</head>

<body>
  <div class="quantum-shell">
    <header class="q-header">
      <div class="q-header-left">
        <div class="th-chip">TH</div>
        <div class="brand-main">
          <div class="brand-logo">
            <img src="/static/img/thronos-quantum-q.png" alt="Thronos Quantum" />
          </div>
          <div class="q-title-block">
            <div class="q-title" id="titleText">Thronos Quantum</div>
            <div class="q-subtitle" id="subtitleText">
              Peer-to-peer encrypted AI console â€¢ Bound to Thronos chain
            </div>
          </div>
        </div>
      </div>
      <div class="q-header-right">
        <div class="pill">
          <div class="pill-dot"></div>
          <div class="pill-label" id="encryptionLabel">Encryption</div>
          <div class="pill-value" id="encryptionValue">Active</div>
        </div>
        <div class="pill pill-quiet">
          <div class="pill-dot"></div>
          <div class="pill-label" id="modeLabelText">Mode</div>
          <div class="pill-value" id="modeLabel">auto</div>
        </div>
        <div class="pill pill-quiet">
          <div class="pill-dot"></div>
          <div class="pill-label" id="coreLabelText">Core</div>
          <div class="pill-value" id="coreStatus">ready</div>
        </div>
        <div class="pill pill-danger">
          <div class="pill-dot"></div>
          <div class="pill-label">THR wallet</div>
          <div class="pill-value" id="walletLabel">unknown</div>
        </div>
      </div>
    </header>

    <main class="q-main">
      <!-- Sessions -->
      <section class="panel sessions">
        <div class="panel-header">
          <div class="panel-title" id="sessionsTitleLabel">Sessions</div>
          <div class="panel-actions">
            <button class="btn-ghost" id="newSessionBtn">
              â—¦ New
            </button>
            <button class="btn-ghost btn-ghost-danger" id="renameSessionBtn">
              âœŽ Rename
            </button>
          </div>
        </div>
        <ul id="sessionsList" class="sessions-list"></ul>
      </section>

      <!-- Chat -->
      <section class="chat-panel">
        <div class="chat-panel-inner">
          <div id="sessionErrorBanner" class="error-banner">
            <span id="sessionErrorText"><strong>Session error</strong>: Unable to load chat session.</span>
            <button id="retrySessionBtn">Retry</button>
          </div>
          <div class="chat-header-row">
            <div class="chat-title-block">
              <div id="sessionTitle">Mesh session</div>
              <div id="sessionStatusTag">Session: loadingâ€¦</div>
            </div>
            <div class="chat-badges-row">
              <div class="badge">
                <span id="modelLabelText">Model:</span>
                <strong id="modelStatus">auto</strong>
              </div>
              <div class="badge">
                <span id="creditsLabelText">AI Credits:</span>
                <strong id="usageStatus">â€“</strong>
              </div>
            </div>
          </div>

          <div id="messages"></div>

          <div class="chat-input-block">
            <div class="wallet-row">
              <span class="wallet-label" id="walletLabelText">Bound wallet:</span>
              <input
                id="walletInput"
                placeholder="THR address"
                autocomplete="off"
              />
            </div>

            <div class="input-row-main">
              <textarea
                id="messageInput"
                placeholder="Type a command to Thronosâ€¦"
              ></textarea>

              <div class="input-side">
                <div class="attach-row">
                  <label for="fileInput" class="attach-btn">
                    ðŸ“Ž Attach file
                  </label>
                  <input id="fileInput" type="file" multiple />
                  <select
                    id="modelSelect"
                    class="model-select"
                    style="background: var(--bg-alt); color: var(--fg); border-radius: 4px; padding: 4px; font-size: 11px; margin-top: 8px;"
                  >
                    <option value="auto">Auto Select (Prioritize Our Stack)</option>

                    <option value="diko_mas">ðŸ§¿ Thrai (Custom Agent)</option>

                    <option value="gemini-2.5-flash">ðŸš€ Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">ðŸ’Ž Gemini 2.5 Pro</option>
                    <option value="gpt-4o">ðŸ¤– GPT-4o (OpenAI)</option>
                    <option value="claude-3-sonnet-20240229">ðŸ§  Claude 3 Sonnet</option>
                  </select>
                  <select
                    id="chatModeSelect"
                    style="background: var(--bg-alt); color: var(--fg); border-radius: 4px; padding: 4px; font-size: 11px; margin-top: 8px;"
                  >
                    <option value="chat">ðŸ’¬ Chat</option>
                    <option value="docs">ðŸ“‘ Document attachments</option>
                    <option value="transform">ðŸ›  Transform attachments</option>
                  </select>
                </div>
                <button id="sendBtn" class="send-btn">
                  SEND
                </button>
              </div>
            </div>

            <div id="pendingFilesRow" style="display: none">
              <div class="pending-files-list" id="pendingFilesList"></div>
              <div class="remove-link" id="clearPendingBtn">remove</div>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
              "
            >
              <div id="uploadStatus"></div>
              <!-- usageStatus text now handled in header badge -->
            </div>
          </div>
        </div>
      </section>

      <!-- Telemetry -->
      <section class="panel telemetry">
        <div class="panel-header">
          <div class="panel-title" id="telemetryTitleLabel">Node Telemetry</div>
        </div>
        <div class="telemetry-kv">
          <div class="telemetry-row">
            <span id="telemetryHashrateLabel">Hashrate (local)</span>
            <strong id="hashrateLabel">0 H/s</strong>
          </div>
          <div class="telemetry-row">
            <span id="telemetryPendingLabel">Pending TXs</span>
            <strong id="pendingTxsLabel">0</strong>
          </div>
          <div class="telemetry-row">
            <span id="telemetryDifficultyLabel">Difficulty</span>
            <strong id="difficultyLabel">â€“</strong>
          </div>
          <div class="telemetry-row">
            <span id="telemetryCreditsLabel">AI Credits</span>
            <strong id="creditsLabel">â€“</strong>
          </div>
        </div>
        <div class="telemetry-note" id="telemetryNote">
          Offline corpus: best blocks from conversations will be promoted to the
          AI training dataset automatically.
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Endpoint constants ---
    const API_WALLET = "/api/ai/wallet";
    const API_CHAT = "/api/chat";
    const API_SESSION_NEW = "/api/chat/session/new";
    const API_SESSION = (id) => `/api/chat/session/${id}`;
    const API_SESSIONS = "/api/chat/sessions";
    const API_SESSION_MESSAGES = (id) => `/api/chat/session/${id}/messages`;
    const API_FILES = "/api/ai/files/upload";
    const API_TELEMETRY = "/api/ai/telemetry";
    const API_FEEDBACK = "/api/ai/feedback";

    const I18N = {
      en: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "Peer-to-peer encrypted AI console â€¢ Bound to Thronos chain",
        sessions_title: "Sessions",
        new_session: "New",
        rename_session: "Rename",
        session_loading: "Session: loadingâ€¦",
        status_loading: "Loadingâ€¦",
        status_ready: "Ready",
        status_error: "Error",
        status_sending: "Sendingâ€¦",
        status_no_sessions: "No sessions yet. Create a new one.",
        status_failed_sessions: "Failed to load sessions",
        status_failed_messages: "Failed to load messages",
        session_error_banner: "Unable to load chat session.",
        retry: "Retry",
        encryption_label: "Encryption",
        encryption_value: "Active",
        mode_label: "Mode",
        core_label: "Core",
        core_ready: "ready",
        session_title_default: "Mesh session",
        model_label: "Model:",
        credits_label: "AI Credits:",
        wallet_label: "Bound wallet:",
        wallet_placeholder: "THR address",
        message_placeholder: "Type a command to Thronosâ€¦",
        chat_mode_chat: "ðŸ’¬ Chat",
        chat_mode_docs: "ðŸ“‘ Document attachments",
        chat_mode_transform: "ðŸ›  Transform attachments",
        attach_file: "ðŸ“Ž Attach file",
        send: "Send",
        telemetry_title: "Node Telemetry",
        telemetry_hashrate: "Hashrate (local)",
        telemetry_pending: "Pending TXs",
        telemetry_difficulty: "Difficulty",
        telemetry_credits: "AI Credits",
        telemetry_note:
          "Offline corpus: best blocks from conversations will be promoted to the AI training dataset automatically.",
        session_not_ready: "Session not ready",
        no_active_session: "No active session. Create one first.",
        upload_failed: "Upload failed",
        upload_success: "Files uploaded",
      },
      el: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "ÎšÎ¿Î½ÏƒÏŒÎ»Î± AI Î¼Îµ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· P2P â€¢ Î”ÎµÎ¼Î­Î½Î· Î¼Îµ Ï„Î¿ Thronos chain",
        sessions_title: "Î£Ï…Î½ÎµÎ´ÏÎ¯ÎµÏ‚",
        new_session: "ÎÎ­Î±",
        rename_session: "ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±",
        session_loading: "Î£Ï…Î½ÎµÎ´ÏÎ¯Î±: Ï†ÏŒÏÏ„Ï‰ÏƒÎ·â€¦",
        status_loading: "Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦",
        status_ready: "ÎˆÏ„Î¿Î¹Î¼Î¿",
        status_error: "Î£Ï†Î¬Î»Î¼Î±",
        status_sending: "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®â€¦",
        status_no_sessions: "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î½ÎµÎ´ÏÎ¯ÎµÏ‚. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¯Î± Î½Î­Î±.",
        status_failed_sessions: "Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÏƒÏ…Î½ÎµÎ´ÏÎ¹ÏŽÎ½",
        status_failed_messages: "Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½",
        session_error_banner: "Î‘Î´Ï…Î½Î±Î¼Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±Ï‚.",
        retry: "ÎžÎ±Î½Î±Î´Î¿ÎºÎ¹Î¼Î®",
        encryption_label: "ÎšÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·",
        encryption_value: "Î•Î½ÎµÏÎ³Î®",
        mode_label: "Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±",
        core_label: "Î Ï…ÏÎ®Î½Î±Ï‚",
        core_ready: "Î­Ï„Î¿Î¹Î¼Î¿",
        session_title_default: "Mesh ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±",
        model_label: "ÎœÎ¿Î½Ï„Î­Î»Î¿:",
        credits_label: "AI Credits:",
        wallet_label: "Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹:",
        wallet_placeholder: "Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· THR",
        message_placeholder: "Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ÎµÎ½Ï„Î¿Î»Î® Ï€ÏÎ¿Ï‚ Ï„Î¿ Thronosâ€¦",
        chat_mode_chat: "ðŸ’¬ Î£Ï…Î½Î¿Î¼Î¹Î»Î¯Î±",
        chat_mode_docs: "ðŸ“‘ Î¤ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ· ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Ï‰Î½",
        chat_mode_transform: "ðŸ›  ÎœÎµÏ„Î±ÏƒÏ‡Î·Î¼Î±Ï„Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Ï‰Î½",
        attach_file: "ðŸ“Ž Î•Ï€Î¹ÏƒÏÎ½Î±ÏˆÎ· Î±ÏÏ‡ÎµÎ¯Î¿Ï…",
        send: "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®",
        telemetry_title: "Î¤Î·Î»ÎµÎ¼ÎµÏ„ÏÎ¯Î± ÎšÏŒÎ¼Î²Î¿Ï…",
        telemetry_hashrate: "Hashrate (Ï„Î¿Ï€Î¹ÎºÏŒ)",
        telemetry_pending: "Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚",
        telemetry_difficulty: "Î”Ï…ÏƒÎºÎ¿Î»Î¯Î±",
        telemetry_credits: "AI Credits",
        telemetry_note:
          "Offline corpus: Ï„Î± ÎºÎ±Î»ÏÏ„ÎµÏÎ± blocks Î±Ï€ÏŒ ÏƒÏ…Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚ Ï€ÏÎ¿Ï‰Î¸Î¿ÏÎ½Ï„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏƒÏ„Î¿ dataset ÎµÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·Ï‚.",
        session_not_ready: "Î— ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·",
        no_active_session: "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Ï€ÏÏŽÏ„Î±.",
        upload_failed: "Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î¼ÎµÏ„Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚",
        upload_success: "Î¤Î± Î±ÏÏ‡ÎµÎ¯Î± Î±Î½Î­Î²Î·ÎºÎ±Î½",
      },
      es: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "Consola de IA cifrada P2P â€¢ Vinculada a Thronos",
        sessions_title: "Sesiones",
        new_session: "Nueva",
        rename_session: "Renombrar",
        session_loading: "SesiÃ³n: cargandoâ€¦",
        status_loading: "Cargandoâ€¦",
        status_ready: "Listo",
        status_error: "Error",
        status_sending: "Enviandoâ€¦",
        status_no_sessions: "Sin sesiones. Crea una nueva.",
        status_failed_sessions: "Error al cargar sesiones",
        status_failed_messages: "Error al cargar mensajes",
        session_error_banner: "No se pudo cargar la sesiÃ³n.",
        retry: "Reintentar",
        encryption_label: "Cifrado",
        encryption_value: "Activo",
        mode_label: "Modo",
        core_label: "NÃºcleo",
        core_ready: "listo",
        session_title_default: "SesiÃ³n mesh",
        model_label: "Modelo:",
        credits_label: "CrÃ©ditos de IA:",
        wallet_label: "Billetera vinculada:",
        wallet_placeholder: "DirecciÃ³n THR",
        message_placeholder: "Escribe un comando para Thronosâ€¦",
        chat_mode_chat: "ðŸ’¬ Chat",
        chat_mode_docs: "ðŸ“‘ Documentar adjuntos",
        chat_mode_transform: "ðŸ›  Transformar adjuntos",
        attach_file: "ðŸ“Ž Adjuntar archivo",
        send: "Enviar",
        telemetry_title: "TelemetrÃ­a del nodo",
        telemetry_hashrate: "Hashrate (local)",
        telemetry_pending: "TX pendientes",
        telemetry_difficulty: "Dificultad",
        telemetry_credits: "CrÃ©ditos de IA",
        telemetry_note:
          "Corpus sin conexiÃ³n: los mejores bloques de conversaciones se promoverÃ¡n automÃ¡ticamente al dataset de entrenamiento.",
        session_not_ready: "SesiÃ³n no lista",
        no_active_session: "No hay sesiÃ³n activa. Crea una primero.",
        upload_failed: "Subida fallida",
        upload_success: "Archivos subidos",
      },
      ja: {
        page_title: "Thronos Quantum Chat",
        brand_title: "Thronos Quantum",
        brand_subtitle: "P2Pæš—å·åŒ–AIã‚³ãƒ³ã‚½ãƒ¼ãƒ« â€¢ Thronosãƒã‚§ãƒ¼ãƒ³ã«é€£æº",
        sessions_title: "ã‚»ãƒƒã‚·ãƒ§ãƒ³",
        new_session: "æ–°è¦",
        rename_session: "åå‰å¤‰æ›´",
        session_loading: "ã‚»ãƒƒã‚·ãƒ§ãƒ³: èª­ã¿è¾¼ã¿ä¸­â€¦",
        status_loading: "èª­ã¿è¾¼ã¿ä¸­â€¦",
        status_ready: "æº–å‚™å®Œäº†",
        status_error: "ã‚¨ãƒ©ãƒ¼",
        status_sending: "é€ä¿¡ä¸­â€¦",
        status_no_sessions: "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚",
        status_failed_sessions: "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",
        status_failed_messages: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ",
        session_error_banner: "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚",
        retry: "å†è©¦è¡Œ",
        encryption_label: "æš—å·åŒ–",
        encryption_value: "æœ‰åŠ¹",
        mode_label: "ãƒ¢ãƒ¼ãƒ‰",
        core_label: "ã‚³ã‚¢",
        core_ready: "æº–å‚™å®Œäº†",
        session_title_default: "ãƒ¡ãƒƒã‚·ãƒ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³",
        model_label: "ãƒ¢ãƒ‡ãƒ«:",
        credits_label: "AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ:",
        wallet_label: "ç´ä»˜ã‘ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ:",
        wallet_placeholder: "THRã‚¢ãƒ‰ãƒ¬ã‚¹",
        message_placeholder: "Thronosã¸ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å…¥åŠ›â€¦",
        chat_mode_chat: "ðŸ’¬ ãƒãƒ£ãƒƒãƒˆ",
        chat_mode_docs: "ðŸ“‘ æ·»ä»˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–",
        chat_mode_transform: "ðŸ›  æ·»ä»˜ã®å¤‰æ›",
        attach_file: "ðŸ“Ž ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜",
        send: "é€ä¿¡",
        telemetry_title: "ãƒŽãƒ¼ãƒ‰ãƒ†ãƒ¬ãƒ¡ãƒˆãƒª",
        telemetry_hashrate: "ãƒãƒƒã‚·ãƒ¥ãƒ¬ãƒ¼ãƒˆ (ãƒ­ãƒ¼ã‚«ãƒ«)",
        telemetry_pending: "ä¿ç•™TX",
        telemetry_difficulty: "é›£æ˜“åº¦",
        telemetry_credits: "AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ",
        telemetry_note:
          "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‘ã‚¹: ä¼šè©±ã®ãƒ™ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ãŒè‡ªå‹•ã§å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«æ˜‡æ ¼ã—ã¾ã™ã€‚",
        session_not_ready: "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“",
        no_active_session: "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä½œæˆã—ã¦ãã ã•ã„ã€‚",
        upload_failed: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—",
        upload_success: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†",
      },
    };

    // --- DOM refs ---
    let sessionsListEl,
      messagesEl,
      walletInputEl,
      walletLabelEl,
      messageInputEl,
      fileInputEl,
      pendingFilesRowEl,
      pendingFilesListEl,
      clearPendingBtnEl,
      uploadStatusEl,
      usageStatusEl,
      sendBtnEl,
      modelSelectEl,
      chatModeSelect,
      modelStatusEl,
      coreStatusEl,
      sessionTitleEl,
      sessionStatusTagEl,
      sessionErrorBannerEl,
      sessionErrorTextEl,
      retrySessionBtnEl,
      hashrateLabelEl,
      pendingTxsLabelEl,
      difficultyLabelEl,
      creditsLabelEl;

    function cacheDom() {
      sessionsListEl = document.getElementById("sessionsList");
      messagesEl = document.getElementById("messages");
      walletInputEl = document.getElementById("walletInput");
      walletLabelEl = document.getElementById("walletLabel");
      messageInputEl = document.getElementById("messageInput");
      fileInputEl = document.getElementById("fileInput");
      pendingFilesRowEl = document.getElementById("pendingFilesRow");
      pendingFilesListEl = document.getElementById("pendingFilesList");
      clearPendingBtnEl = document.getElementById("clearPendingBtn");
      uploadStatusEl = document.getElementById("uploadStatus");
      usageStatusEl = document.getElementById("usageStatus");
      sendBtnEl = document.getElementById("sendBtn");
      modelSelectEl = document.getElementById("modelSelect");
      chatModeSelect = document.getElementById("chatModeSelect");
      modelStatusEl = document.getElementById("modelStatus");
      coreStatusEl = document.getElementById("coreStatus");
      sessionTitleEl = document.getElementById("sessionTitle");
      sessionStatusTagEl = document.getElementById("sessionStatusTag");
      sessionErrorBannerEl = document.getElementById("sessionErrorBanner");
      sessionErrorTextEl = document.getElementById("sessionErrorText");
      retrySessionBtnEl = document.getElementById("retrySessionBtn");
      hashrateLabelEl = document.getElementById("hashrateLabel");
      pendingTxsLabelEl = document.getElementById("pendingTxsLabel");
      difficultyLabelEl = document.getElementById("difficultyLabel");
      creditsLabelEl = document.getElementById("creditsLabel");
    }

    // --- State ---
    const SESSION_STORAGE_KEY = "thronos_session_id";
    const MODEL_STORAGE_KEY = "thronos_model_key";
    const LANG_STORAGE_KEY = "thronos_lang";
    let currentSessionId = null;
    let sessions = [];
    let pendingFiles = []; // { id, name, size }
    let receivedFiles = []; // for any AI-generated [[FILE:...]] blocks
    let sessionState = "idle"; // idle | loading | ready | error
    let sessionError = "";
    let currentLang = "en";

    // --- Utilities ---
    function setUploadStatus(text, mode = "") {
      uploadStatusEl.textContent = text || "";
      uploadStatusEl.classList.remove("ok", "error");
      if (mode) uploadStatusEl.classList.add(mode);
    }

    function setSessionStatus(text) {
      sessionStatusTagEl.textContent = text;
    }

    function setSessionState(state, message = "") {
      sessionState = state;
      sessionError = state === "error" ? message : "";
      const bannerVisible = state === "error";
      sessionErrorBannerEl.style.display = bannerVisible ? "flex" : "none";
      if (bannerVisible) {
        const text = message || "Session unavailable. Please retry.";
        sessionErrorTextEl.textContent = text;
      }

      if (state === "loading") {
        setSessionStatus(t("status_loading"));
        setSending(false);
      } else if (state === "ready") {
        setSessionStatus(t("status_ready"));
        setSending(true);
      } else if (state === "error") {
        setSessionStatus(t("status_error"));
        setSending(false);
      } else {
        setSending(true);
      }
    }

    function setSending(enabled) {
      sendBtnEl.disabled = !enabled;
    }

    function initModelSelector() {
      const saved = localStorage.getItem(MODEL_STORAGE_KEY) || "auto";
      modelSelectEl.value = saved;
      modelStatusEl.textContent = saved;
    }

    function handleModelChange() {
      const value = modelSelectEl.value || "auto";
      localStorage.setItem(MODEL_STORAGE_KEY, value);
      modelStatusEl.textContent = value;
    }

    function t(key) {
      const dict = I18N[currentLang] || I18N.en;
      return dict[key] || I18N.en[key] || key;
    }

    function applyTranslations() {
      document.title = t("page_title");
      const map = [
        ["titleText", "brand_title"],
        ["subtitleText", "brand_subtitle"],
        ["sessionTitle", "session_title_default"],
        ["sessionsTitleLabel", "sessions_title"],
        ["newSessionBtn", "new_session"],
        ["renameSessionBtn", "rename_session"],
        ["sessionStatusTag", "session_loading"],
        ["modelLabelText", "model_label"],
        ["creditsLabelText", "credits_label"],
        ["walletLabelText", "wallet_label"],
        ["encryptionLabel", "encryption_label"],
        ["encryptionValue", "encryption_value"],
        ["modeLabelText", "mode_label"],
        ["coreLabelText", "core_label"],
        ["coreStatus", "core_ready"],
        ["attachLabel", "attach_file"],
        ["sendBtn", "send"],
        ["telemetryTitleLabel", "telemetry_title"],
        ["telemetryHashrateLabel", "telemetry_hashrate"],
        ["telemetryPendingLabel", "telemetry_pending"],
        ["telemetryDifficultyLabel", "telemetry_difficulty"],
        ["telemetryCreditsLabel", "telemetry_credits"],
        ["telemetryNote", "telemetry_note"],
        ["retrySessionBtn", "retry"],
        ["sessionErrorText", "session_error_banner"],
      ];

      map.forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = t(key);
      });

      if (walletInputEl) walletInputEl.placeholder = t("wallet_placeholder");
      if (messageInputEl) messageInputEl.placeholder = t("message_placeholder");
      if (sessionStatusTagEl) sessionStatusTagEl.textContent = t("status_loading");
      if (chatModeSelect) {
        if (chatModeSelect.options[0]) chatModeSelect.options[0].textContent = t("chat_mode_chat");
        if (chatModeSelect.options[1]) chatModeSelect.options[1].textContent = t("chat_mode_docs");
        if (chatModeSelect.options[2]) chatModeSelect.options[2].textContent = t("chat_mode_transform");
      }
    }

    function initI18n() {
      const browserLang = (navigator.language || "").toLowerCase();
      const defaultLang = browserLang.startsWith("el") ? "el" : "en";
      currentLang = localStorage.getItem(LANG_STORAGE_KEY) || defaultLang;
      if (!I18N[currentLang]) currentLang = "en";
      applyTranslations();
    }

    function formatSize(bytes) {
      if (bytes == null) return "";
      if (bytes < 1024) return bytes + " B";
      const kb = bytes / 1024;
      if (kb < 1024) return kb.toFixed(1) + " KB";
      const mb = kb / 1024;
      return mb.toFixed(1) + " MB";
    }

    function scrollMessagesToBottom() {
      // Double requestAnimationFrame for smooth scrolling
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
      });

      // Fallback timeout to ensure scroll happens even if rAF doesn't work
      setTimeout(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, 50);
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // Extract [[FILE:name.ext]]...[[/FILE]] blocks from AI text, return:
    // { cleanedText, files: [{name, content}] }
    function extractAiFilesFromText(raw) {
      const files = [];
      let text = raw;
      const regex = /\[\[FILE:([^\]]+)\]\]([\s\S]*?)\[\[\/FILE\]\]/g;
      let match;
      while ((match = regex.exec(raw)) !== null) {
        const name = match[1].trim();
        const content = match[2];
        files.push({ name, content });
      }
      text = raw.replace(regex, "").trim();
      return { cleanedText: text, files };
    }

    // --- Rendering ---

    function renderSessions() {
      sessionsListEl.innerHTML = "";
      sessions.forEach((s) => {
        const li = document.createElement("li");
        li.className =
          "session-item" + (s.id === currentSessionId ? " active" : "");
        li.dataset.id = s.id;

        const nameRow = document.createElement("div");
        nameRow.className = "session-name-row";

        const nameSpan = document.createElement("div");
        nameSpan.className = "session-name";
        nameSpan.textContent = s.title || "Untitled session";

        // Add delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "session-delete-btn";
        deleteBtn.innerHTML = "Ã—";
        deleteBtn.title = "Delete session";
        deleteBtn.addEventListener("click", async (e) => {
          e.stopPropagation(); // Don't trigger session switch
          if (!confirm(`Delete "${s.title || 'Untitled session'}"?`)) return;

          try {
            const res = await fetch(API_SESSION(s.id), {
              method: "DELETE",
            });
            if (res.ok) {
              // Remove from local array
              sessions = sessions.filter(sess => sess.id !== s.id);
              // If deleted current session, switch to first available
              if (s.id === currentSessionId && sessions.length > 0) {
                currentSessionId = sessions[0].id;
                loadSessionMessages(currentSessionId);
                sessionTitleEl.textContent = sessions[0].title || "Mesh session";
              } else if (sessions.length === 0) {
                // No sessions left, create new one
                await createNewSession();
              }
              renderSessions();
            }
          } catch (e) {
            console.error("Delete session error:", e);
            alert("Failed to delete session");
          }
        });

        const statusPill = document.createElement("div");
        statusPill.className = "session-status-pill";
        statusPill.innerHTML = `<span>${(s.model || "auto").toUpperCase()}</span> Â· ${
          s.created_at || ""
        }`;

        nameRow.appendChild(nameSpan);
        nameRow.appendChild(deleteBtn);

        const metaRow = document.createElement("div");
        metaRow.className = "session-meta";
        metaRow.innerHTML = `<span>${
          s.message_count || 0
        } messages</span><span>${s.last_updated || ""}</span>`;

        li.appendChild(nameRow);
        li.appendChild(statusPill);
        li.appendChild(metaRow);

        li.addEventListener("click", () => {
          if (s.id !== currentSessionId) {
            currentSessionId = s.id;
            loadSessionMessages(s.id);
            renderSessions();
            sessionTitleEl.textContent = s.title || "Mesh session";
          }
        });

        sessionsListEl.appendChild(li);
      });
    }

    function renderPendingFiles() {
      if (!pendingFiles.length) {
        pendingFilesRowEl.style.display = "none";
        pendingFilesListEl.innerHTML = "";
        return;
      }
      pendingFilesRowEl.style.display = "flex";
      pendingFilesListEl.innerHTML = "";
      pendingFiles.forEach((f) => {
        const chip = document.createElement("div");
        chip.className = "pending-file-chip";

        const label = document.createElement("span");
        label.textContent = `${f.name} (${formatSize(f.size)})`;

        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-file-btn";
        removeBtn.textContent = "Ã—";
        removeBtn.addEventListener("click", () => {
          pendingFiles = pendingFiles.filter((x) => x.id !== f.id);
          renderPendingFiles();
        });

        chip.appendChild(label);
        chip.appendChild(removeBtn);
        pendingFilesListEl.appendChild(chip);
      });
    }

    function createThumbButtons(messageText) {
      const wrapper = document.createElement("div");
      wrapper.className = "msg-actions";

      const upBtn = document.createElement("button");
      upBtn.className = "thumb-btn up";
      upBtn.innerHTML = "ðŸ‘ <span>good</span>";

      const downBtn = document.createElement("button");
      downBtn.className = "thumb-btn down";
      downBtn.innerHTML = "ðŸ‘Ž <span>bad</span>";

      function setActive(which) {
        upBtn.classList.toggle("active", which === "up");
        downBtn.classList.toggle("active", which === "down");
      }

      async function sendFeedback(isUp) {
        try {
          await fetch(API_FEEDBACK, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              session_id: currentSessionId,
              message_text: messageText,
              thumbs_up: !!isUp,
            }),
          });
        } catch (e) {
          console.warn("Feedback error:", e);
        }
      }

      upBtn.addEventListener("click", () => {
        setActive("up");
        sendFeedback(true);
      });

      downBtn.addEventListener("click", () => {
        setActive("down");
        sendFeedback(false);
      });

      wrapper.appendChild(upBtn);
      wrapper.appendChild(downBtn);
      return wrapper;
    }

    function appendMessage(msg) {
      // msg: { role: "user" | "ai" | ..., content, model?, files? }
      const row = document.createElement("div");
      const isUser = msg.role === "user";
      row.className = "msg-row " + (isUser ? "user" : "ai");

      const avatar = document.createElement("div");
      avatar.className = "msg-avatar";
      avatar.textContent = isUser ? "YOU" : "AI";

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";

      const header = document.createElement("div");
      header.className = "msg-header";
      const authorSpan = document.createElement("div");
      authorSpan.className = "msg-author";
      authorSpan.textContent = isUser ? "USER" : "QUANTUM AGENT";
      const metaSpan = document.createElement("div");
      metaSpan.className = "msg-model-tag";
      if (msg.model) metaSpan.textContent = msg.model;
      header.appendChild(authorSpan);
      header.appendChild(metaSpan);

      let text = msg.content || "";
      let extraFiles = [];
      if (!isUser && text) {
        const extracted = extractAiFilesFromText(text);
        text = extracted.cleanedText;
        extraFiles = extracted.files;
      }

      const content = document.createElement("div");
      content.className = "msg-content";
      content.textContent = text;

      bubble.appendChild(header);
      bubble.appendChild(content);

      const allFiles = []
        .concat(msg.files || [])
        .concat(
          extraFiles.map((f) => ({
            // placeholder; server should create real file_id if you want
            name: f.name,
            file_id: null,
            inline_content: f.content,
          }))
        );

      if (allFiles.length) {
        const filesDiv = document.createElement("div");
        filesDiv.className = "msg-files";
        allFiles.forEach((f) => {
          if (f.url) {
            const a = document.createElement("a");
            a.className = "msg-file-link";
            a.href = f.url;
            a.target = "_blank";
            a.textContent = f.name || "file";
            filesDiv.appendChild(a);
          } else if (f.file_id) {
            const a = document.createElement("a");
            a.className = "msg-file-link";
            a.href = `/api/ai/files/${encodeURIComponent(f.file_id)}`;
            a.target = "_blank";
            a.textContent = f.name || "file";
            filesDiv.appendChild(a);
          } else if (f.inline_content != null) {
            const a = document.createElement("a");
            a.className = "msg-file-link";
            const blob = new Blob([f.inline_content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            a.href = url;
            a.download = f.name || "file.txt";
            a.textContent = f.name || "inline.txt";
            filesDiv.appendChild(a);
          }
        });
        bubble.appendChild(filesDiv);
      }

      const aiFiles = msg.aiFiles || [];
      if (aiFiles.length) {
        const filesDiv = document.createElement("div");
        filesDiv.className = "ai-files";
        filesDiv.innerHTML = "<strong>AI files:</strong><br/>";
        aiFiles.forEach((f) => {
          const a = document.createElement("a");
          const name = f.filename || f.name || "file";
          const url = f.url || "/api/ai/generated/" + encodeURIComponent(name);
          a.href = url;
          a.textContent = name + (f.size ? ` (${f.size} bytes)` : "");
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          filesDiv.appendChild(a);
          filesDiv.appendChild(document.createElement("br"));
        });
        bubble.appendChild(filesDiv);
      }

      if (!isUser) {
        const actions = createThumbButtons(text);
        bubble.appendChild(actions);
      }

      row.appendChild(isUser ? bubble : avatar);
      row.appendChild(isUser ? avatar : bubble);

      messagesEl.appendChild(row);
      scrollMessagesToBottom();
    }

    function renderMessages(list) {
      messagesEl.innerHTML = "";
      (list || []).forEach(appendMessage);
    }

    // --- API calls ---

    async function loadWallet() {
      try {
        // Read wallet from localStorage (same as other pages)
        const w = localStorage.getItem('thr_address') || "";
        walletInputEl.value = w;

        // Update wallet label with connection status
        const walletPill = walletLabelEl.parentElement;
        if (w) {
          walletLabelEl.textContent = w.slice(0, 6) + "â€¦" + w.slice(-4);
          walletPill.classList.remove('pill-danger');
          walletPill.classList.add('pill-success');
        } else {
          walletLabelEl.textContent = "not connected";
          walletPill.classList.remove('pill-success');
          walletPill.classList.add('pill-danger');
        }
      } catch (e) {
        console.warn("Wallet load failed", e);
        walletLabelEl.textContent = "error";
      }
    }

    async function loadSessions() {
      try {
        const res = await fetch(API_SESSIONS);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        sessions = data.sessions || [];
        renderSessions();

        if (!currentSessionId && sessions.length) {
          currentSessionId = sessions[0].id;
          localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        } else if (!currentSessionId && !sessions.length) {
          setSessionStatus(t("status_no_sessions"));
        }

        if (currentSessionId) {
          const s = sessions.find((x) => x.id === currentSessionId);
          if (s) sessionTitleEl.textContent = s.title || "Mesh session";
        }
      } catch (e) {
        console.error("loadSessions error", e);
          setSessionState("error", t("status_failed_sessions"));
      }
    }

    async function loadSessionMessages(id) {
      if (!id) return;
      setSessionState("loading");
      try {
        const res = await fetch(API_SESSION_MESSAGES(id));
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const session = data.session || {};
        currentSessionId = session.id || id;
        if (currentSessionId) {
          localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        }
        sessionTitleEl.textContent = session.title || "Mesh session";
        modelStatusEl.textContent = session.model || modelSelectEl.value || "auto";
        renderMessages(data.messages || []);
        setSessionState("ready");
      } catch (e) {
        console.error("loadSessionMessages error", e);
        setSessionState("error", t("status_failed_messages"));
      }
    }

    async function validateSession(sessionId) {
      try {
        const res = await fetch(API_SESSION(sessionId));
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        currentSessionId = data.id || sessionId;
        sessionTitleEl.textContent = data.title || "Mesh session";
        localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
        setSessionState("ready");
        return true;
      } catch (e) {
        console.warn("validateSession error", e);
        return false;
      }
    }

      async function createSession(isRetry = false) {
        setSessionState("loading");
        try {
          const wallet = walletInputEl.value.trim();
          const res = await fetch(API_SESSION_NEW, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: isRetry ? "Recovered session" : "New mesh session",
            wallet: wallet || null,
          }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const createdSession = data.session || data;
        currentSessionId = createdSession ? createdSession.id : null;
        if (currentSessionId) {
          localStorage.setItem(SESSION_STORAGE_KEY, currentSessionId);
          await loadSessions();
          await loadSessionMessages(currentSessionId);
        } else {
          setSessionStatus(t("status_error"));
        }
        setSessionState("ready");
      } catch (e) {
          console.error("createSession error", e);
          setSessionState("error", t("status_error"));
        }
      }

      async function ensureSession() {
        setSessionState("loading");
        const storedId = localStorage.getItem(SESSION_STORAGE_KEY);
        if (storedId) {
          const ok = await validateSession(storedId);
        if (ok) {
          await loadSessions();
            await loadSessionMessages(currentSessionId);
            return;
          }
        }
        await createSession();
      }

    async function renameSession() {
      if (!currentSessionId) return;
      const s = sessions.find((x) => x.id === currentSessionId);
      const currentName = s ? s.title || "" : "";
      const newName = prompt("Rename session:", currentName);
      if (!newName || newName === currentName) return;
      try {
        const res = await fetch(API_SESSION(currentSessionId), {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: newName }),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        await loadSessions();
      } catch (e) {
        console.error("renameSession error", e);
      }
    }

    async function uploadFiles(files) {
      if (!files || !files.length) return;
      const form = new FormData();
      for (const f of files) {
        form.append("files", f, f.name);
      }
      // CRITICAL: Include wallet and session_id for ownership tracking
      const wallet = walletInputEl.value.trim();
      if (wallet) {
        form.append("wallet", wallet);
      }
      if (currentSessionId) {
        form.append("session_id", currentSessionId);
      }
      setUploadStatus(t("status_loading"));
      try {
        const res = await fetch(API_FILES, {
          method: "POST",
          body: form,
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const uploaded = data.files || [];
        uploaded.forEach((f) => {
          pendingFiles.push({
            id: f.id,
            name: f.name,
            size: f.size,
          });
        });
        renderPendingFiles();
        setUploadStatus(t("upload_success"), "ok");
      } catch (e) {
        console.error("uploadFiles error", e);
        setUploadStatus(t("upload_failed"), "error");
      }
    }

    async function loadTelemetry() {
      try {
        const res = await fetch(API_TELEMETRY);
        if (!res.ok) return;
        const data = await res.json();
        if (data.hashrate != null)
          hashrateLabelEl.textContent = data.hashrate + " H/s";
        if (data.pending_txs != null)
          pendingTxsLabelEl.textContent = data.pending_txs;
        if (data.difficulty != null)
          difficultyLabelEl.textContent = data.difficulty;
        if (data.ai_credits != null) creditsLabelEl.textContent = data.ai_credits;
      } catch (e) {
        console.warn("telemetry error", e);
      }
    }

    async function sendMessage() {
      const text = messageInputEl.value.trim();
      if (!text && !pendingFiles.length) return;
      if (!currentSessionId) {
        alert(t("no_active_session"));
        return;
      }
      if (sessionState === "loading") return;
      if (sessionState === "error") {
        setSessionStatus(t("session_not_ready"));
        return;
      }
      const wallet = walletInputEl.value.trim();
      setSending(false);
      setSessionStatus(t("status_sending"));
      usageStatusEl.textContent = "";

      const model = modelSelectEl.value || "auto";
      modelStatusEl.textContent = model;

      const mode = chatModeSelect ? chatModeSelect.value : "chat";
      const userMessage = text;
      let finalMessage = userMessage;

      if (mode === "docs") {
        finalMessage =
          "Î›ÎµÎ¹Ï„Î¿ÏÏÎ³Î·ÏƒÎµ Ï‰Ï‚ Thronos Documentation Engine.\n" +
          "ÎœÎµ Î²Î¬ÏƒÎ· Ï„Î± ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î±, Î³ÏÎ¬ÏˆÎµ Ï€Î»Î®ÏÎ· Ï„ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ· ÏƒÎµ ÎºÎ±Î¸Î±ÏÏŒ Markdown.\n" +
          "Î— Î­Î¾Î¿Î´Î¿Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÎœÎŸÎÎŸ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î¼Î­ÏƒÎ± ÏƒÎµ block [[FILE:docs_session.md]] ... [[/FILE]].\n\n" +
          userMessage;
      } else if (mode === "transform") {
        finalMessage =
          "Î›ÎµÎ¹Ï„Î¿ÏÏÎ³Î·ÏƒÎµ Ï‰Ï‚ Thronos File Refiner.\n" +
          "Î Î¬ÏÎµ Ï„Î± ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î±, Î²ÎµÎ»Ï„Î¯Ï‰ÏƒÎ­ Ï„Î± (clean code / Î´Î¹Î¿ÏÎ¸ÏŽÏƒÎµÎ¹Ï‚) ÎºÎ±Î¹ Î³ÏÏÎ¹ÏƒÎ­ Ï„Î± Ï‰Ï‚ Î½Î­Î± Î±ÏÏ‡ÎµÎ¯Î±.\n" +
          "Î“Î¹Î± ÎºÎ¬Î¸Îµ Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€Î¬Î½Ï„Î·ÏƒÎµ Î¼Îµ [[FILE:new_<originalname>]] ... [[/FILE]].\n\n" +
          userMessage;
      }

      const payload = {
        session_id: currentSessionId,
        wallet: wallet || null,
        message: finalMessage,
        attachments: pendingFiles.map((f) => f.id),
        model_key: model,
        lang: currentLang,
      };

      // optimistic render user message
      appendMessage({ role: "user", content: userMessage, model: "user" });

      messageInputEl.value = "";
      pendingFiles = [];
      renderPendingFiles();

      try {
        const res = await fetch(API_CHAT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        // Handle no credits case
        if (data.status === "no_credits") {
          appendMessage({
            role: "assistant",
            content: data.response || "No AI credits available. Please purchase an AI pack to continue.",
            model: "system",
          });
          setSessionStatus("Ready");
          setSending(true);
          return;
        }

        // AI reply - handle actual server response format
        if (data.response) {
          appendMessage({
            role: "assistant",
            content: data.response,
            model: data.model || model,
            aiFiles: data.files || [],
          });
        }

        // Update credits display if available
        if (data.credits !== undefined) {
          usageStatusEl.textContent = `AI Credits: ${data.credits}`;
        }

        // Update wallet if returned
        if (data.wallet) {
          walletInputEl.value = data.wallet;
          const w = data.wallet;
          walletLabelEl.textContent = w.slice(0, 6) + "â€¦" + w.slice(-4);
        }

        setSessionStatus("Ready");
      } catch (e) {
        console.error("sendMessage error", e);
        appendMessage({
          role: "assistant",
          content: "Error: " + e.message,
          model: "system",
        });
        setSessionStatus(t("status_error"));
      } finally {
        setSending(true);
      }
    }

    // --- Events ---
    function bindEvents() {
      document
        .getElementById("newSessionBtn")
        .addEventListener("click", createSession);
      document
        .getElementById("renameSessionBtn")
        .addEventListener("click", renameSession);

      modelSelectEl.addEventListener("change", handleModelChange);

      retrySessionBtnEl.addEventListener("click", ensureSession);

      fileInputEl.addEventListener("change", (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length) {
          uploadFiles(files);
        }
        fileInputEl.value = "";
      });

      clearPendingBtnEl.addEventListener("click", () => {
        pendingFiles = [];
        renderPendingFiles();
      });

      sendBtnEl.addEventListener("click", () => {
        sendMessage();
      });

      messageInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // --- Init ---
    async function init() {
      cacheDom();
      initI18n();
      bindEvents();
      await loadWallet();
      initModelSelector();
      await ensureSession();
      loadTelemetry();
      setInterval(loadTelemetry, 15000);
      setSending(true);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
