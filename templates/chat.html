<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Thronos Quantum Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg: #050608;
            --panel: #0d1117;
            --border: #00ff66;
            --accent: #00ffcc;
            --danger: #ff4d4d;
            --text-main: #e0ffe8;
            --text-muted: #7de6a0;
            --sidebar-bg: #020904;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top, #04110a 0, #020204 40%, #000 100%);
            color: var(--text-main);
            font-family: "Fira Code", "Consolas", monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            border-bottom: 1px solid var(--border);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #020904;
            height: 40px;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent);
            font-size: 14px;
        }

        .logo span {
            color: var(--border);
        }

        .status-pill {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--accent);
            background: rgba(0, 0, 0, 0.4);
        }

        /* Layout Container */
        #root {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex-shrink: 0;
        }

        .new-chat-btn {
            border: 1px solid var(--border);
            background: rgba(0, 255, 102, 0.1);
            color: var(--accent);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            margin-bottom: 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: rgba(0, 255, 102, 0.2);
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .session-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Icon to delete a session. Hidden until hover */
        .delete-icon {
            opacity: 0;
            font-size: 10px;
            cursor: pointer;
            color: var(--danger);
            margin-left: 4px;
        }

        .session-item:hover .delete-icon {
            opacity: 1;
        }

        .session-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }
        
        .session-item:hover .edit-icon {
            opacity: 1;
        }

        .session-item.active {
            background: rgba(0, 255, 102, 0.15);
            color: var(--accent);
            border-left: 2px solid var(--accent);
        }
        
        .edit-icon {
            opacity: 0;
            font-size: 10px;
            cursor: pointer;
            color: var(--accent);
            margin-left: 4px;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            position: relative;
        }

        .chat-header {
            padding: 10px 14px;
            border-bottom: 1px solid rgba(0, 255, 102, 0.3);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            background: rgba(0,0,0,0.2);
        }

        .field-inline {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .field-inline label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .field-inline input, .field-inline select {
            background: #000;
            border: 1px solid rgba(0, 255, 102, 0.4);
            color: var(--accent);
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .field-inline input {
            width: 140px;
        }

        .credits-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .credits-label span {
            color: var(--accent);
            font-weight: 600;
        }
        
        .qa-btn-small {
            font-size: 10px;
            padding: 2px 6px;
            border: 1px solid var(--accent);
            color: var(--accent);
            text-decoration: none;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .qa-btn-small:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: radial-gradient(circle at top left, #042010 0, #050608 40%, #020204 100%);
        }

        .message-row {
            margin-bottom: 16px;
            display: flex;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .message-row.ai {
            justify-content: flex-start;
        }
        
        .message-row.assistant {
            justify-content: flex-start;
        }

        .bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 8px;
            line-height: 1.5;
            font-size: 14px;
            white-space: pre-wrap;
            position: relative;
        }

        .message-row.user .bubble {
            background: var(--border);
            color: #000;
            border-bottom-right-radius: 2px;
        }

        .message-row.ai .bubble, .message-row.assistant .bubble {
            background: rgba(1, 5, 8, 0.9);
            color: var(--text-main);
            border: 1px solid rgba(0, 255, 102, 0.5);
            border-bottom-left-radius: 2px;
        }

        .meta-line {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
        }

        .meta-tools {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 11px;
        }

        .btn-copy {
            border-radius: 3px;
            border: 1px solid rgba(0, 255, 102, 0.5);
            background: transparent;
            color: var(--accent);
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .btn-copy:hover {
            background: rgba(0, 255, 102, 0.12);
        }

        .file-link {
            text-decoration: none;
            color: var(--accent);
            border-bottom: 1px dotted rgba(0, 255, 102, 0.6);
        }

        .chat-footer {
            border-top: 1px solid rgba(0, 255, 102, 0.3);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #020904;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            resize: none;
            min-height: 44px;
            max-height: 140px;
            background: #000;
            border: 1px solid rgba(0, 255, 102, 0.4);
            color: var(--text-main);
            border-radius: 6px;
            padding: 10px;
            font-family: inherit;
            font-size: 14px;
        }
        
        #user-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(0, 255, 204, 0.2);
        }

        .btn {
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--border);
            color: #000;
            font-size: 14px;
            font-weight: 600;
            padding: 0 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: filter 0.2s;
        }
        
        .btn:hover {
            filter: brightness(1.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .footer-info {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        
        .qa-upload-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .qa-upload-bar input[type="file"] {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        #aiUploadBtn {
            font-size: 11px;
            padding: 4px 10px;
            background: #0d1117;
            border: 1px solid var(--accent);
            color: var(--accent);
            border-radius: 4px;
            cursor: pointer;
        }
        
        #aiUploadBtn:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none; /* Mobile hide sidebar for now or add toggle */
            }
            .chat-main {
                height: 100%;
            }
        }
    </style>
</head>
<body>
<div class="top-bar">
    <div class="logo">THRONOS <span>QUANTUM</span> ASSISTANT</div>
    <div class="status-pill" id="top-status-pill">Quantum Encryption Active · 256-bit Session Key</div>
</div>

<div id="root">
    <!-- Sidebar -->
    <div class="sidebar">
        <button id="new-chat-btn" class="new-chat-btn">
            <span>+ New Chat</span>
        </button>
        <div id="session-list" class="session-list">
            <!-- Sessions will be injected here -->
            <div style="padding:10px; opacity:0.5; font-size:11px;">Enter Wallet to load sessions...</div>
        </div>
        <div style="margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px;">
            <a href="/architect" style="color: var(--accent); font-size: 12px; text-decoration: none; display: block; padding: 5px;">
                ➜ Switch to Architect Mode
            </a>
        </div>
    </div>

    <!-- Main Chat -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="field-inline">
                <label for="wallet-input">THR Wallet:</label>
                <input id="wallet-input" type="text" placeholder="THRxxxxxxxx" autocomplete="off">
                <!-- Disconnect button clears the saved wallet and hides sessions -->
                <button id="disconnect-wallet-btn" type="button" title="Disconnect wallet" style="margin-left:6px; font-size:10px; padding:4px 6px; border:1px solid var(--border); border-radius:4px; background:rgba(255,0,0,0.1); color:var(--danger); cursor:pointer;">×</button>
            </div>

            <div class="field-inline">
                <label for="model-select">Model:</label>
                <select id="model-select">
                    <option value="auto">Auto (Smart)</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 (Exp)</option>
                </select>
            </div>

            <div class="credits-label">
                Credits: <span id="credits-count">∞ (demo)</span>
                <a href="/ai_packs" class="qa-btn-small">Get AI Packs</a>
            </div>
        </div>

        <div id="messages" class="chat-body">
            <!-- Messages will be injected here -->
            <div style="text-align:center; margin-top:40px; opacity:0.5;">
                <div>THRONOS QUANTUM CORE</div>
                <div style="font-size:11px; margin-top:8px;">Select a session or start a new chat.</div>
            </div>
        </div>

        <div class="chat-footer">
            <div class="input-row">
                <textarea id="user-input" rows="1" placeholder="Type a command to Thronos..."></textarea>
                <button id="send-btn" class="btn">
                    ▶ Send
                </button>
            </div>
            
            <div class="qa-upload-bar">
              <input type="file" id="aiUploadInput">
              <button id="aiUploadBtn">Upload to Quantum Node</button>
            </div>
            
            <div class="footer-info">
                <div>
                    <span id="status-line">Core: online</span> ·
                    <span id="key-line">Key: —</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const messagesEl      = document.getElementById("messages");
    const userInputEl     = document.getElementById("user-input");
    const sendBtn         = document.getElementById("send-btn");
    const walletInputEl   = document.getElementById("wallet-input");
    const creditsEl       = document.getElementById("credits-count");
    const statusLineEl    = document.getElementById("status-line");
    const keyLineEl       = document.getElementById("key-line");
    const topStatusPillEl = document.getElementById("top-status-pill");
    const aiUploadInput   = document.getElementById("aiUploadInput");
    const aiUploadBtn     = document.getElementById("aiUploadBtn");
    const sessionListEl   = document.getElementById("session-list");
    const newChatBtn      = document.getElementById("new-chat-btn");
    const modelSelect     = document.getElementById("model-select");

    let currentSessionId = null;

    // --- helpers ---

    function saveWalletLocal(addr) {
        try { localStorage.setItem("thronos_wallet", addr || ""); } catch (_) {}
    }

    function loadWalletLocal() {
        try { return localStorage.getItem("thronos_wallet") || ""; } catch (_) { return ""; }
    }

    function setCreditsLabel(v) {
        if (v === null || v === undefined) return;
        if (v === "infinite") {
            creditsEl.textContent = "∞ (demo)";
        } else {
            creditsEl.textContent = v;
        }
    }

    function setStatus(text) {
        statusLineEl.textContent = text;
    }

    function setQuantumKey(key) {
        if (!key) return;
        const shortKey = String(key).slice(0, 16) + "…";
        keyLineEl.textContent = "Key: " + shortKey;
        topStatusPillEl.textContent = "Quantum Encryption Verified · " + shortKey;
    }

    function appendMessage(role, text, metaHtml, files) {
        const row = document.createElement("div");
        row.className = "message-row " + role;

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        const main = document.createElement("div");
        main.textContent = text || "";
        bubble.appendChild(main);

        if (metaHtml) {
            const metaDiv = document.createElement("div");
            metaDiv.className = "meta-line";
            metaDiv.innerHTML = metaHtml;
            bubble.appendChild(metaDiv);
        }

        if (role === "ai" || role === "assistant") {
            const tools = document.createElement("div");
            tools.className = "meta-tools";

            // copy button
            const copyBtn = document.createElement("button");
            copyBtn.className = "btn-copy";
            copyBtn.type = "button";
            copyBtn.textContent = "Copy";
            copyBtn.addEventListener("click", () => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text || "").catch(() => {});
                }
            });
            tools.appendChild(copyBtn);

            // file links (if any)
            if (Array.isArray(files) && files.length > 0) {
                const minutes = Math.round((files[0].expires_in || 3600) / 60);
                files.forEach(f => {
                    const a = document.createElement("a");
                    a.href = f.url;
                    a.target = "_blank";
                    a.rel = "noopener";
                    a.className = "file-link";
                    a.textContent = "Download " + (f.filename || "file");
                    tools.appendChild(a);
                });
                const infoSpan = document.createElement("span");
                infoSpan.textContent = " (auto-delete ~" + minutes + " min)";
                tools.appendChild(infoSpan);
            }

            bubble.appendChild(tools);
        }

        row.appendChild(bubble);
        messagesEl.appendChild(row);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function refreshCredits() {
        const wallet = walletInputEl.value.trim();
        if (!wallet) {
            setCreditsLabel("infinite");
            return;
        }
        try {
            const res = await fetch(`/api/ai_credits?wallet=${encodeURIComponent(wallet)}`);
            const data = await res.json();
            setCreditsLabel(data.credits);
        } catch (e) {
            console.error('credits fetch error', e);
            setCreditsLabel("error");
        }
    }

    // --- Session Management ---

    async function loadSessions() {
        const wallet = walletInputEl.value.trim();
        if (!wallet) {
            sessionListEl.innerHTML = '<div style="padding:10px; opacity:0.5; font-size:11px;">Enter Wallet to load sessions...</div>';
            return;
        }

        try {
            const res = await fetch(`/api/ai_sessions?wallet=${encodeURIComponent(wallet)}`);
            const data = await res.json();
            
            sessionListEl.innerHTML = "";
            
            if (data.sessions && data.sessions.length > 0) {
                data.sessions.forEach(s => {
                    const el = document.createElement("div");
                    el.className = "session-item";
                    if (s.id === currentSessionId) el.classList.add("active");
                    
                    const titleSpan = document.createElement("span");
                    titleSpan.textContent = s.title || "Untitled Chat";
                    titleSpan.style.flex = "1";
                    titleSpan.style.overflow = "hidden";
                    titleSpan.style.textOverflow = "ellipsis";
                    el.appendChild(titleSpan);


                    const editIcon = document.createElement("span");
                    editIcon.className = "edit-icon";
                    editIcon.textContent = "✎";
                    editIcon.title = "Rename";
                    editIcon.onclick = (e) => {
                        e.stopPropagation();
                        renameSession(s.id, s.title);
                    };
                    el.appendChild(editIcon);

                    // Delete icon: click to remove this session
                    const deleteIcon = document.createElement("span");
                    deleteIcon.className = "delete-icon";
                    deleteIcon.textContent = "✖";
                    deleteIcon.title = "Delete";
                    deleteIcon.onclick = (e) => {
                        e.stopPropagation();
                        deleteSession(s.id);
                    };
                    el.appendChild(deleteIcon);

                    el.onclick = () => loadSessionHistory(s.id);
                    sessionListEl.appendChild(el);
                });
            } else {
                sessionListEl.innerHTML = '<div style="padding:10px; opacity:0.5; font-size:11px;">No sessions found. Start a new chat!</div>';
            }
        } catch (e) {
            console.error("Sessions load error:", e);
        }
    }

    async function loadSessionHistory(sid) {
        const wallet = walletInputEl.value.trim();
        if (!wallet) return;

        currentSessionId = sid;
        loadSessions(); // refresh active class

        try {
            const res = await fetch(`/api/ai_session_history?wallet=${encodeURIComponent(wallet)}&session_id=${encodeURIComponent(sid)}`);
            const data = await res.json();

            messagesEl.innerHTML = "";
            
            if (data.history && Array.isArray(data.history)) {
                data.history.forEach(msg => {
                   appendMessage(msg.role, msg.content, `<span style="opacity:0.5">${msg.ts}</span>`); 
                });
            } else {
                appendMessage("ai", "Quantum Encryption Verified. New session started.");
            }
            
        } catch (e) {
            console.error("History load error:", e);
        }
    }

    async function startNewSession() {
        const wallet = walletInputEl.value.trim();
        if (!wallet) {
            alert("Please enter a wallet address first.");
            return;
        }

        try {
            const res = await fetch("/api/ai_sessions/start", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ wallet: wallet, title: "New Chat" })
            });
            const data = await res.json();
            if (data.status === "ok") {
                currentSessionId = data.session.id;
                loadSessions();
                messagesEl.innerHTML = "";
                appendMessage("ai", "New secure session initialized.");
            }
        } catch (e) {
            console.error("New session error:", e);
        }
    }

    async function renameSession(sid, currentTitle) {
        const wallet = walletInputEl.value.trim();
        if (!wallet) return;

        const newTitle = prompt("Rename chat:", currentTitle);
        if (newTitle && newTitle.trim() !== "") {
            try {
                const res = await fetch("/api/ai_sessions/rename", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        wallet: wallet, 
                        session_id: sid, 
                        title: newTitle.trim() 
                    })
                });
                if (res.ok) {
                    loadSessions();
                }
            } catch (e) {
                console.error("Rename error:", e);
            }
        }
    }

    // Delete a session permanently. Requires wallet to be set. Removes session from list
    async function deleteSession(sid) {
        const wallet = walletInputEl.value.trim();
        if (!wallet) return;
        // Confirm deletion
        if (!confirm("Delete this session? This action cannot be undone.")) {
            return;
        }
        try {
            const res = await fetch("/api/ai_sessions/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ wallet: wallet, session_id: sid })
            });
            const data = await res.json();
            if (data.status === "ok") {
                // If we were viewing this session, reset the view
                if (currentSessionId === sid) {
                    currentSessionId = null;
                    messagesEl.innerHTML = '<div style="text-align:center; margin-top:40px; opacity:0.5;"><div>THRONOS QUANTUM CORE</div><div style="font-size:11px; margin-top:8px;">Session deleted.</div></div>';
                }
                loadSessions();
            } else {
                alert(data.error || "Delete failed");
            }
        } catch (e) {
            console.error("Delete error:", e);
        }
    }

    // --- Chat Logic ---

    async function sendMessage() {
        const text = userInputEl.value.trim();
        if (!text) return;

        const wallet = walletInputEl.value.trim();
        const model = modelSelect.value;
        saveWalletLocal(wallet);

        userInputEl.value = "";
        appendMessage("user", text);

        sendBtn.disabled = true;
        setStatus("Core: thinking…");

        // typing bubble
        const thinkingRow = document.createElement("div");
        thinkingRow.className = "message-row ai";
        const thinkingBubble = document.createElement("div");
        thinkingBubble.className = "bubble";
        thinkingBubble.textContent = "…";
        thinkingRow.appendChild(thinkingBubble);
        messagesEl.appendChild(thinkingRow);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        try {
            const payload = { 
                message: text,
                model_key: model
            };
            if (wallet) payload.wallet = wallet;
            if (currentSessionId) payload.session_id = currentSessionId;

            const res = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            messagesEl.removeChild(thinkingRow);

            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                appendMessage("ai", "Quantum Interference: " + (errData.message || "HTTP " + res.status));
                if (errData.response) {
                     // Special case for "no credits" warning which comes in response field
                     appendMessage("ai", errData.response);
                }
                setStatus("Core: error");
                if (errData.credits !== undefined) setCreditsLabel(errData.credits);
                return;
            }

            const data = await res.json();

            // If backend created a session or we sent one, update list to show updated time/title
            if (data.session_id) {
                if (currentSessionId !== data.session_id) {
                    currentSessionId = data.session_id;
                }
                loadSessions(); // refresh list to show new title/timestamp
            }

            const metaParts = [];
            if (data.status) {
                metaParts.push(`<span>Status: ${data.status}</span>`);
            }
            if (data.provider) {
                metaParts.push(`<span>Provider: ${data.provider}</span>`);
            }
            if (data.model) {
                metaParts.push(`<span>Model: ${data.model}</span>`);
            }

            appendMessage(
                "ai",
                data.response || "[Empty response]",
                metaParts.join(" · "),
                data.files || []
            );

            if (data.quantum_key) {
                setQuantumKey(data.quantum_key);
            }
            if (data.credits !== undefined) {
                setCreditsLabel(data.credits);
            }
            setStatus("Core: " + (data.status || "online"));
        } catch (err) {
            if (thinkingRow.parentNode) messagesEl.removeChild(thinkingRow);
            appendMessage("ai", "Quantum Interference Detected: " + (err.message || String(err)));
            setStatus("Core: network error");
        } finally {
            sendBtn.disabled = false;
        }
    }
    
    // --- Upload Logic ---
    aiUploadBtn.addEventListener('click', async () => {
      const wallet = walletInputEl.value.trim();
      if (!wallet) {
          alert("Please enter a THR Wallet address first.");
          return;
      }
      if (!aiUploadInput.files.length) return;

      const fd = new FormData();
      fd.append('wallet', wallet);
      fd.append('file', aiUploadInput.files[0]);
      if (currentSessionId) {
          fd.append('session_id', currentSessionId);
      }
      
      setStatus("Core: uploading...");
      aiUploadBtn.disabled = true;

      try {
          const res = await fetch('/api/ai_upload', {
            method: 'POST',
            body: fd
          });
          const data = await res.json();
          
          if (res.ok) {
              const fname = data.filename || (aiUploadInput.files[0] && aiUploadInput.files[0].name) || "file";
              const msg   = data.message || "File uploaded to AI corpus";
              appendMessage("ai", `Uploaded file ${fname} · ${msg}`);
              aiUploadInput.value = ""; // clear input
          } else {
              alert("Upload failed: " + (data.error || "Unknown error"));
          }
      } catch (e) {
          console.error(e);
          alert("Upload network error");
      } finally {
          setStatus("Core: online");
          aiUploadBtn.disabled = false;
      }
    });

    // --- events ---

    sendBtn.addEventListener("click", sendMessage);
    userInputEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
            ev.preventDefault();
            sendMessage();
        }
    });
    
    walletInputEl.addEventListener("change", () => {
        const w = walletInputEl.value.trim();
        saveWalletLocal(w);
        refreshCredits();
        loadSessions();
        // Reset view
        messagesEl.innerHTML = '<div style="text-align:center; margin-top:40px; opacity:0.5;"><div>THRONOS QUANTUM CORE</div><div style="font-size:11px; margin-top:8px;">Wallet loaded. Select a session.</div></div>';
        currentSessionId = null;
    });
    
    newChatBtn.addEventListener("click", startNewSession);

    // Disconnect button clears wallet and resets state
    const disconnectBtn = document.getElementById("disconnect-wallet-btn");
    if (disconnectBtn) {
        disconnectBtn.addEventListener("click", () => {
            saveWalletLocal("");
            walletInputEl.value = "";
            setCreditsLabel("infinite");
            sessionListEl.innerHTML = '<div style="padding:10px; opacity:0.5; font-size:11px;">Enter Wallet to load sessions...</div>';
            messagesEl.innerHTML = '<div style="text-align:center; margin-top:40px; opacity:0.5;"><div>THRONOS QUANTUM CORE</div><div style="font-size:11px; margin-top:8px;">Wallet disconnected.</div></div>';
            currentSessionId = null;
        });
    }

    const savedWallet = loadWalletLocal();
    walletInputEl.value = savedWallet;

    if (savedWallet) {
        // When a wallet is saved, refresh credits but do not automatically load sessions.
        // The user can choose to refresh or start a new chat. Sessions will only load after manual interaction.
        refreshCredits();
    } else {
        setCreditsLabel("infinite");
    }

</script>
</body>
</html>
