{% extends "base.html" %}
{% block title %}Course{% endblock %}
{% block content %}
<div class="l2e-container" style="max-width: 900px; margin: 40px auto; color: #d7ffe6;">
    <div id="courseHeader" class="panel" style="background:#07120b;border:1px solid #1a5a2f;border-radius:14px;padding:20px;">
        <h1 id="courseTitle">Course</h1>
        <p id="courseDesc"></p>
        <div id="courseMedia"></div>
    </div>
    <div class="panel" style="margin-top:20px;background:#050b07;border:1px solid #1a5a2f;border-radius:14px;padding:20px;">
        <h3>üìù Quiz</h3>
        <div id="quizArea">Loading...</div>
        <button id="submitBtn" class="btn-primary" style="margin-top:15px;" onclick="submitQuiz()">Submit</button>
    </div>
</div>
<script>
const courseId = "{{ course_id }}";
let quizData = null;
function mediaTag(course){
    if(course.video_url){
        return `<video controls style="width:100%; max-height:320px;">\n<source src="${course.video_url}" type="video/mp4">\n</video>`;
    }
    if(course.slides_path){
        const url = `/media/${course.slides_path}`;
        return `<iframe src="${url}" style="width:100%;height:400px;"></iframe>`;
    }
    return '';
}
fetch(`/api/v1/courses/${courseId}`)
    .then(r=>r.json())
    .then(({course})=>{
        if(!course) return;
        document.getElementById('courseTitle').textContent = course.title;
        document.getElementById('courseDesc').textContent = course.description || '';
        const cover = course.cover_path ? `/media/${course.cover_path}` : '/static/img/logo.png';
        document.getElementById('courseHeader').insertAdjacentHTML('afterbegin', `<img src="${cover}" style="width:100%;max-height:240px;object-fit:cover;border-radius:10px;" onerror="this.src='/static/img/logo.png'">`);
        document.getElementById('courseMedia').innerHTML = mediaTag(course);
    });

fetch(`/api/v1/courses/${courseId}/quiz`).then(r=>r.json()).then(res=>{
    quizData = res.quiz;
    if(!quizData){
        document.getElementById('quizArea').textContent = 'No quiz yet';
        document.getElementById('submitBtn').style.display='none';
        return;
    }
    const html = quizData.questions.map(q=>`<div style="margin-bottom:12px;">
        <div style="font-weight:700;">${q.question}</div>
        ${q.options.map((opt,i)=>`<label style="display:block;margin-left:10px;"><input type='radio' name='q${q.id}' value='${i}'> ${opt}</label>`).join('')}
    </div>`).join('');
    document.getElementById('quizArea').innerHTML = html;
});

function submitQuiz(){
    const addr = window.walletSession?.getAddress ? window.walletSession.getAddress() : '';
    const secret = window.walletSession?.getSendSecret ? window.walletSession.getSendSecret() : '';
    if(!addr || !secret){
        alert('Connect wallet from header widget.');
        return;
    }
    const answers = {};
    (quizData?.questions||[]).forEach(q=>{
        const val = document.querySelector(`input[name='q${q.id}']:checked`);
        if(val) answers[q.id] = parseInt(val.value, 10);
    });
    fetch('/api/l2e/submit_quiz', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({course_id: courseId, student_thr: addr, answers})
    }).then(r=>r.json()).then(res=>{
        alert(res.message || res.status || 'Submitted');
    }).catch(e=>alert(e.message));
}
</script>
{% endblock %}
