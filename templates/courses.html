{% extends "base.html" %}
{% block title %}Thronos Learn‑to‑Earn{% endblock %}
{% block content %}
<div class="container" style="max-width:1100px;margin:30px auto;color:#d7ffe6;">
  <h1 style="color:#3CFF7A;letter-spacing:2px;">LEARN‑TO‑EARN</h1>
  <p style="opacity:.9;">Μάθηση με κόστος, επιβράβευση με L2E. Όχι «placeholder». Πληρώνεις THR, τελειώνεις το course, παίρνεις L2E.</p>

  <div style="display:flex;gap:18px;flex-wrap:wrap;">
    <div style="flex:1;min-width:320px;background:#07120b;border:1px solid #1a5a2f;border-radius:14px;padding:16px;">
      <h3 style="margin-top:0;color:#3CFF7A;">Courses</h3>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
        <input id="wallet" placeholder="THR wallet (π.χ. THR...)" style="flex:1;padding:10px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;color:#d7ffe6;">
        <input id="secret" placeholder="auth_secret" style="flex:1;padding:10px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;color:#d7ffe6;">
        <input id="passphrase" placeholder="passphrase (optional)" style="flex:1;padding:10px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;color:#d7ffe6;">
      </div>
      <button id="refresh" style="padding:10px 14px;border-radius:10px;border:1px solid #3CFF7A;background:#06140b;color:#3CFF7A;cursor:pointer;">Refresh</button>
      <div id="courses" style="margin-top:14px;display:flex;flex-direction:column;gap:10px;"></div>
    </div>

    <div style="flex:1;min-width:320px;background:#07120b;border:1px solid #1a5a2f;border-radius:14px;padding:16px;">
      <h3 style="margin-top:0;color:#3CFF7A;">Create Course (Teacher)</h3>
      <input id="title" placeholder="Title" style="width:100%;padding:10px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;color:#d7ffe6;margin-bottom:10px;">
      <input id="price" placeholder="Price THR (e.g. 2.5)" style="width:100%;padding:10px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;color:#d7ffe6;margin-bottom:10px;">
      <input id="reward" placeholder="Reward L2E (e.g. 10)" style="width:100%;padding:10px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;color:#d7ffe6;margin-bottom:10px;">
      <button id="create" style="padding:10px 14px;border-radius:10px;border:1px solid #3CFF7A;background:#06140b;color:#3CFF7A;cursor:pointer;">Create</button>
      <pre id="log" style="white-space:pre-wrap;margin-top:12px;background:#050b07;border:1px solid #123a22;border-radius:12px;padding:12px;min-height:140px;"></pre>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);

async function apiGet(url){
  const r = await fetch(url);
  return await r.json();
}
async function apiPost(url, body){
  const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
  return await r.json();
}

function courseCard(c){
  const el = document.createElement("div");
  el.style.cssText="border:1px solid #123a22;border-radius:12px;padding:12px;background:#050b07;";
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
      <div>
        <div style="font-weight:700;color:#d7ffe6;">${c.title}</div>
        <div style="opacity:.85;font-size:13px;">Teacher: <code>${c.teacher}</code></div>
        <div style="opacity:.85;font-size:13px;">Price: <b>${c.price_thr}</b> THR · Reward: <b>${c.reward_l2e}</b> L2E</div>
        <div style="opacity:.75;font-size:12px;">Students: ${(c.students||[]).length} · Completed: ${(c.completed||[]).length}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;min-width:170px;">
        <button class="enroll" style="padding:9px 12px;border-radius:10px;border:1px solid #3CFF7A;background:#06140b;color:#3CFF7A;cursor:pointer;">Enroll</button>
        <button class="complete" style="padding:9px 12px;border-radius:10px;border:1px solid #1a5a2f;background:#06140b;color:#d7ffe6;cursor:pointer;">Complete</button>
      </div>
    </div>
  `;
  el.querySelector(".enroll").onclick = async ()=>{
    const student = $("wallet").value.trim();
    const secret  = $("secret").value.trim();
    const pass    = $("passphrase").value.trim();
    if(!student || !secret) return log("Wallet + auth_secret required.");
    const out = await apiPost(`/api/v1/courses/${c.id}/enroll`, {student_thr:student, auth_secret:secret, passphrase:pass});
    log(JSON.stringify(out,null,2));
    await refresh();
  };
  el.querySelector(".complete").onclick = async ()=>{
    const student = $("wallet").value.trim();
    const teacher = c.teacher;
    const secret  = $("secret").value.trim();
    const pass    = $("passphrase").value.trim();
    if(!student || !secret) return log("Wallet + auth_secret required.");
    const out = await apiPost(`/api/v1/courses/${c.id}/complete`, {student_thr:student, teacher_thr:teacher, auth_secret:secret, passphrase:pass});
    log(JSON.stringify(out,null,2));
    await refresh();
  };
  return el;
}

function log(s){
  $("log").textContent = s;
}

async function refresh(){
  const data = await apiGet("/api/v1/courses");
  const box = $("courses");
  box.innerHTML = "";
  (data.courses||[]).forEach(c=>box.appendChild(courseCard(c)));
}

$("refresh").onclick = refresh;

$("create").onclick = async ()=>{
  const teacher = $("wallet").value.trim();
  const secret  = $("secret").value.trim();
  const pass    = $("passphrase").value.trim();
  const title   = $("title").value.trim();
  const price   = parseFloat($("price").value||"0");
  const reward  = parseFloat($("reward").value||"0");
  if(!teacher || !secret) return log("Teacher wallet + auth_secret required.");
  const out = await apiPost("/api/v1/courses", {title, teacher, price_thr:price, reward_l2e:reward, auth_secret:secret, passphrase:pass});
  log(JSON.stringify(out,null,2));
  await refresh();
};

refresh().catch(e=>log(String(e)));
</script>
{% endblock %}
