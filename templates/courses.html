{% extends "base.html" %}
{% block title %}ğŸ“ Thronos Learnâ€‘toâ€‘Earn{% endblock %}

{% block styles %}
<style>
    .l2e-container {
        max-width: 1200px;
        margin: 30px auto;
        color: #d7ffe6;
    }
    .l2e-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #07120b 0%, #0a1f14 100%);
        border: 1px solid #1a5a2f;
        border-radius: 16px;
    }
    .l2e-header h1 {
        color: #3CFF7A;
        letter-spacing: 3px;
        font-size: 2.5em;
        margin: 0 0 10px 0;
        text-shadow: 0 0 20px rgba(60, 255, 122, 0.3);
    }
    .l2e-header p {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px 0;
    }
    .l2e-stats {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    .stat-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px 25px;
        border-radius: 10px;
        border: 1px solid #1a5a2f;
    }
    .stat-box .label {
        font-size: 0.9em;
        opacity: 0.7;
        margin-bottom: 5px;
    }
    .stat-box .value {
        font-size: 1.8em;
        font-weight: bold;
        color: #3CFF7A;
    }
    .l2e-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    @media (max-width: 768px) {
        .l2e-grid { grid-template-columns: 1fr; }
    }
    .panel {
        background: #07120b;
        border: 1px solid #1a5a2f;
        border-radius: 14px;
        padding: 20px;
    }
    .panel h3 {
        margin-top: 0;
        color: #3CFF7A;
        border-bottom: 1px solid #1a5a2f;
        padding-bottom: 10px;
    }
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    .input-field {
        flex: 1;
        min-width: 200px;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #1a5a2f;
        background: #050b07;
        color: #d7ffe6;
        font-family: monospace;
    }
    .input-field:focus {
        outline: none;
        border-color: #3CFF7A;
        box-shadow: 0 0 0 2px rgba(60, 255, 122, 0.1);
    }
    .btn-primary {
        padding: 12px 20px;
        border-radius: 10px;
        border: 1px solid #3CFF7A;
        background: #06140b;
        color: #3CFF7A;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    }
    .btn-primary:hover {
        background: #3CFF7A;
        color: #000;
        box-shadow: 0 0 15px rgba(60, 255, 122, 0.4);
    }
    .btn-secondary {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px solid #1a5a2f;
        background: #06140b;
        color: #d7ffe6;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-secondary:hover {
        border-color: #3CFF7A;
        background: rgba(60, 255, 122, 0.1);
    }
    .btn-danger {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px solid #ff6b6b;
        background: #1a0f0f;
        color: #ff6b6b;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-danger:hover {
        background: #ff6b6b;
        color: #000;
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
    }
    .btn-quiz {
        background: #1a3a5f;
        border-color: #5C9FFF;
        color: #5C9FFF;
    }
    .btn-quiz:hover {
        background: #5C9FFF;
        color: #000;
    }
    .course-card {
        border: 1px solid #123a22;
        border-radius: 12px;
        padding: 16px;
        background: #050b07;
        margin-bottom: 12px;
        transition: all 0.3s;
    }
    .course-card:hover {
        border-color: #3CFF7A;
        box-shadow: 0 0 20px rgba(60, 255, 122, 0.15);
        transform: translateY(-2px);
    }
    .course-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 12px;
    }
    .course-title {
        font-weight: 700;
        font-size: 1.2em;
        color: #d7ffe6;
        margin-bottom: 8px;
    }
    .course-meta {
        opacity: 0.85;
        font-size: 13px;
        margin: 4px 0;
    }
    .course-meta code {
        background: rgba(60, 255, 122, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        color: #3CFF7A;
    }
    .course-stats {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #123a22;
        font-size: 12px;
        opacity: 0.75;
    }
    .course-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 140px;
    }
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        margin-left: 8px;
    }
    .badge-enrolled { background: rgba(60, 255, 122, 0.2); color: #3CFF7A; border: 1px solid #3CFF7A; }
    .badge-completed { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid #ffd700; }
    .badge-quiz-passed { background: rgba(92, 159, 255, 0.2); color: #5C9FFF; border: 1px solid #5C9FFF; }
    .badge-has-quiz { background: rgba(255, 165, 0, 0.2); color: #ffa500; border: 1px solid #ffa500; }
    .log-box {
        white-space: pre-wrap;
        margin-top: 12px;
        background: #050b07;
        border: 1px solid #123a22;
        border-radius: 12px;
        padding: 12px;
        min-height: 100px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    .empty-state { text-align: center; padding: 40px; opacity: 0.6; }
    .loading { text-align: center; padding: 20px; color: #3CFF7A; }
    .error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        margin-top: 10px;
    }
    /* Course Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
    }
    .modal.active { display: flex; align-items: flex-start; justify-content: center; }
    .modal-content {
        background: #07120b;
        border: 1px solid #1a5a2f;
        border-radius: 16px;
        padding: 30px;
        max-width: 700px;
        width: 100%;
        margin: 20px auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #1a5a2f;
    }
    .modal-header h2 { margin: 0; color: #3CFF7A; }
    .modal-close {
        background: none;
        border: none;
        color: #ff6b6b;
        font-size: 24px;
        cursor: pointer;
    }
    .modal-tabs {
        display: flex;
        gap: 10px;
        margin: 10px 0 16px;
        flex-wrap: wrap;
    }
    .modal-tab {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #1a5a2f;
        background: #050b07;
        color: #d7ffe6;
        cursor: pointer;
        transition: all 0.2s;
    }
    .modal-tab.active {
        border-color: #3CFF7A;
        color: #000;
        background: #3CFF7A;
    }
    .modal-section { display: none; }
    .modal-section.active { display: block; }
    .question-card {
        background: #050b07;
        border: 1px solid #1a5a2f;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
    }
    .question-text {
        font-size: 1.1em;
        margin-bottom: 15px;
        color: #d7ffe6;
    }
    .question-number {
        color: #3CFF7A;
        font-weight: bold;
        margin-right: 10px;
    }
    .option-label {
        display: block;
        padding: 12px 15px;
        margin: 8px 0;
        background: #06140b;
        border: 1px solid #1a5a2f;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .option-label:hover { border-color: #3CFF7A; background: rgba(60, 255, 122, 0.05); }
    .option-label input { margin-right: 10px; }
    .option-label.correct { background: rgba(60, 255, 122, 0.2); border-color: #3CFF7A; }
    .option-label.incorrect { background: rgba(255, 107, 107, 0.2); border-color: #ff6b6b; }
    .quiz-result {
        text-align: center;
        padding: 30px;
        background: #050b07;
        border-radius: 12px;
        margin-top: 20px;
    }
    .quiz-score {
        font-size: 3em;
        font-weight: bold;
        margin: 10px 0;
    }
    .quiz-score.passed { color: #3CFF7A; }
    .quiz-score.failed { color: #ff6b6b; }
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .tab-btn {
        padding: 10px 20px;
        border: 1px solid #1a5a2f;
        background: #050b07;
        color: #d7ffe6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-btn.active { background: #3CFF7A; color: #000; border-color: #3CFF7A; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="l2e-container">
    <!-- Header Section -->
    <div class="l2e-header">
        <h1>ğŸ“ LEARNâ€‘TOâ€‘EARN</h1>
        <p>
            <span class="lang-el">ÎœÎ¬Î¸Îµ, Ï€Î»Î®ÏÏ‰ÏƒÎµ Î¼Îµ THR, Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï„Î¿ quiz, ÎºÎ­ÏÎ´Î¹ÏƒÎµ L2E tokens</span>
            <span class="lang-en">Learn, pay with THR, complete the quiz, earn L2E tokens</span>
        </p>
        <div class="l2e-stats">
            <div class="stat-box">
                <div class="label"><span class="lang-el">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</span><span class="lang-en">Total Courses</span></div>
                <div class="value" id="totalCourses">0</div>
            </div>
            <div class="stat-box">
                <div class="label"><span class="lang-el">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚</span><span class="lang-en">Total Students</span></div>
                <div class="value" id="totalStudents">0</div>
            </div>
            <div class="stat-box">
                <div class="label"><span class="lang-el">L2E Î”Î¹Î±Î½ÎµÎ¼Î·Î¼Î­Î½Î±</span><span class="lang-en">L2E Distributed</span></div>
                <div class="value" id="totalL2E">0</div>
            </div>
        </div>
    </div>

    <!-- Wallet Connection -->
    <div class="panel" style="margin-bottom: 20px;">
        <h3>ğŸ” <span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ· Î Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï</span><span class="lang-en">Wallet Connection</span></h3>
        <div class="input-group">
            <input id="wallet" class="input-field" placeholder="THR wallet address" readonly />
            <button id="connectBtn" class="btn-primary">
                <span class="lang-el">Î§ÏÎ®ÏƒÎ· Wallet Widget</span><span class="lang-en">Use Wallet Widget</span>
            </button>
        </div>
        <div id="walletStatus" style="margin-top: 10px; display: none;">
            <span style="color: #3CFF7A;">âœ“ <span class="lang-el">Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿</span><span class="lang-en">Connected</span>:</span>
            <code id="connectedWallet"></code>
            <span style="margin-left: 15px;">L2E: <strong id="l2eBalance">0</strong></span>
        </div>
        <div id="walletWarning" style="margin-top: 10px; color: #ff6b6b; display: none;">
            <span class="lang-el">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î±Ï€ÏŒ Ï„Î¿ widget Ï€Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï ÏƒÏ„Î¿ header.</span>
            <span class="lang-en">Connect via the header wallet widget.</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('courses')">
            ğŸ“š <span class="lang-el">ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</span><span class="lang-en">Courses</span>
        </button>
        <button class="tab-btn" onclick="showTab('create')">
            â• <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</span><span class="lang-en">Create</span>
        </button>
        <button class="tab-btn" onclick="showTab('my-courses')">
            ğŸ“– <span class="lang-el">Î¤Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¬ Î¼Î¿Ï…</span><span class="lang-en">My Courses</span>
        </button>
    </div>

    <!-- Courses Tab -->
    <div id="courses-tab" class="tab-content active">
        <div class="panel">
            <h3>ğŸ“š <span class="lang-el">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</span><span class="lang-en">Available Courses</span></h3>
            <button id="refresh" class="btn-secondary" style="width: 100%; margin-bottom: 15px;">
                ğŸ”„ <span class="lang-el">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</span><span class="lang-en">Refresh</span>
            </button>
            <div id="courses"></div>
        </div>
    </div>

    <!-- Create Course Tab -->
    <div id="create-tab" class="tab-content">
        <div class="panel">
            <h3>â• <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚ (Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î­Ï‚)</span><span class="lang-en">Create Course (Teachers Only)</span></h3>
            <input id="title" class="input-field" placeholder="Course Title" style="width: 100%; margin-bottom: 10px;" />
            <input id="titleEl" class="input-field" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚ ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚ (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)" style="width: 100%; margin-bottom: 10px;" />
            <input id="description" class="input-field" placeholder="Description (optional)" style="width: 100%; margin-bottom:10px;" />
            <div class="input-group">
                <input id="price" class="input-field" type="number" step="0.1" placeholder="Price in THR" />
                <input id="reward" class="input-field" type="number" step="0.1" placeholder="L2E Reward" />
            </div>
            <div style="margin: 15px 0; padding: 12px; border:1px solid #1a5a2f; border-radius: 10px;">
                <h4 style="margin-top:0;">ğŸ“‚ Course Content</h4>
                <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                    <label><input type="radio" name="contentType" value="pdf" checked> PDF Slides</label>
                    <label><input type="radio" name="contentType" value="video"> Video</label>
                    <label><input type="radio" name="contentType" value="external"> External Link</label>
                </div>
                <div id="pdfFields">
                    <input id="slidesFile" type="file" accept="application/pdf" style="width:100%; margin-bottom:10px;" />
                    <small style="opacity:0.8;">Upload slides as a PDF (saved under courses/&lt;course_id&gt;/slides.pdf).</small>
                </div>
                <div id="videoFields" style="display:none;">
                    <input id="videoUrl" class="input-field" placeholder="YouTube or MP4 URL" style="width:100%;" />
                </div>
                <div id="externalFields" style="display:none;">
                    <input id="contentUrl" class="input-field" placeholder="Content URL" style="width:100%;" />
                </div>
            </div>
            <div style="margin: 15px 0; padding: 12px; border:1px solid #1a5a2f; border-radius: 10px;">
                <h4 style="margin-top:0;">ğŸ§© Quiz Builder</h4>
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <label for="builderPassScore" style="white-space:nowrap;">Pass score (%)</label>
                    <input id="builderPassScore" class="input-field" type="number" value="70" style="width:100px;" />
                </div>
                <div id="builderQuestions"></div>
                <button type="button" class="btn-secondary" style="width:100%; margin-top:10px;" onclick="addBuilderQuestion()">â• Add Question</button>
            </div>
            <button id="create" class="btn-primary" style="width: 100%;">
                <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚</span><span class="lang-en">Create Course</span>
            </button>
            <div class="log-box" id="log"><span class="lang-el">ÎˆÏ„Î¿Î¹Î¼Î¿ Î³Î¹Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î±Î¸Î·Î¼Î¬Ï„Ï‰Î½...</span><span class="lang-en">Ready to create courses...</span></div>
        </div>
    </div>
    <!-- My Courses Tab -->
    <div id="my-courses-tab" class="tab-content">
        <div class="panel">
            <h3>ğŸ“– <span class="lang-el">Î¤Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¬ Î¼Î¿Ï…</span><span class="lang-en">My Courses</span></h3>
            <div id="my-courses-list"></div>
        </div>
    </div>
</div>

<!-- Course Modal -->
<div id="courseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="courseModalTitle">ğŸ“ Course</h2>
            <button class="modal-close" onclick="closeCourseModal()">Ã—</button>
        </div>
        <div class="modal-tabs">
            <button class="modal-tab active" data-tab="lesson" onclick="showCourseModalTab('lesson')">ğŸ“˜ <span class="lang-el">ÎœÎ¬Î¸Î·Î¼Î±</span><span class="lang-en">Lesson</span></button>
            <button class="modal-tab" data-tab="quiz" onclick="showCourseModalTab('quiz')">ğŸ“ <span class="lang-el">Quiz</span><span class="lang-en">Quiz</span></button>
        </div>
        <div id="courseModalLesson" class="modal-section active">
            <div id="courseLessonContent"></div>
            <div id="courseLessonActions" style="margin-top: 20px; text-align: center;"></div>
        </div>
        <div id="courseModalQuiz" class="modal-section">
            <div id="quizContent"></div>
            <div id="quizActions" style="margin-top: 20px; text-align: center;">
                <button id="submitQuizBtn" class="btn-primary" onclick="submitQuiz()" style="min-width: 200px;">
                    <span class="lang-el">Î¥Ï€Î¿Î²Î¿Î»Î® Î‘Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½</span><span class="lang-en">Submit Answers</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Quiz Modal -->
<div id="createQuizModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“ <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Quiz</span><span class="lang-en">Create Quiz</span></h2>
            <button class="modal-close" onclick="closeCreateQuizModal()">Ã—</button>
        </div>
        <div id="createQuizForm">
            <input id="quizTitleInput" class="input-field" placeholder="Quiz Title" style="width: 100%; margin-bottom: 10px;" />
            <input id="passingScore" class="input-field" type="number" value="80" placeholder="Passing Score (%)" style="width: 100%; margin-bottom: 20px;" />

            <h4><span class="lang-el">Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚</span><span class="lang-en">Questions</span></h4>
            <div id="questionsContainer"></div>

            <button class="btn-secondary" style="width: 100%; margin: 10px 0;" onclick="addQuestion()">
                â• <span class="lang-el">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•ÏÏÏ„Î·ÏƒÎ·Ï‚</span><span class="lang-en">Add Question</span>
            </button>

            <button class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="saveQuiz()">
                ğŸ’¾ <span class="lang-el">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Quiz</span><span class="lang-en">Save Quiz</span>
            </button>
        </div>
    </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
let connectedWallet = null;
let connectedSecret = null;
let connectedPassphrase = null;
let currentQuizCourseId = null;
let currentQuizQuestions = [];
let currentLang = localStorage.getItem('lang') || 'en';
let builderQuestionCounter = 0;
let coursesCache = [];
let currentCourse = null;
let lastLoadedQuizCourseId = null;

// API Helpers
async function apiGet(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
}

async function apiPost(url, body) {
    const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
}

// Logging
function log(message, isError = false) {
    const logBox = $("log");
    const timestamp = new Date().toLocaleTimeString();
    const prefix = isError ? "âŒ" : "âœ“";
    logBox.textContent = `[${timestamp}] ${prefix} ${message}\n\n${logBox.textContent}`;
    logBox.style.color = isError ? "#ff6b6b" : "#d7ffe6";
}

function toggleContentFields() {
    const type = (document.querySelector('input[name="contentType"]:checked') || {}).value || 'pdf';
    $("pdfFields").style.display = type === 'pdf' ? 'block' : 'none';
    $("videoFields").style.display = type === 'video' ? 'block' : 'none';
    $("externalFields").style.display = type === 'external' ? 'block' : 'none';
}

// Supported question types enum - MUST be defined before addBuilderQuestion
const QUESTION_TYPES = {
    MULTIPLE_CHOICE: 'multiple_choice',
    TRUE_FALSE: 'true_false',
    MULTI_SELECT: 'multi_select',
    SHORT_ANSWER: 'short_answer',
    MATCHING: 'matching',
    ORDERING: 'ordering',
    FILL_BLANK: 'fill_blank'
};

const QUESTION_TYPE_LABELS = {
    multiple_choice: { en: 'Multiple Choice', el: 'Î Î¿Î»Î»Î±Ï€Î»Î®Ï‚ Î•Ï€Î¹Î»Î¿Î³Î®Ï‚' },
    true_false: { en: 'True/False', el: 'Î£Ï‰ÏƒÏ„ÏŒ/Î›Î¬Î¸Î¿Ï‚' },
    multi_select: { en: 'Multi-Select', el: 'Î Î¿Î»Î»Î±Ï€Î»Î® Î•Ï€Î¹Î»Î¿Î³Î®' },
    short_answer: { en: 'Short Answer', el: 'Î£ÏÎ½Ï„Î¿Î¼Î· Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·' },
    matching: { en: 'Matching Pairs', el: 'Î‘Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ·' },
    ordering: { en: 'Put in Order', el: 'Î’Î¬Î»Îµ ÏƒÎµ Î£ÎµÎ¹ÏÎ¬' },
    fill_blank: { en: 'Fill in the Blank', el: 'Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± ÎšÎµÎ½Î¬' }
};

function normalizeQuestionType(rawType) {
    const val = String(rawType || '').toLowerCase();
    if (val === 'multiple_choice' || val === 'mcq' || val === 'single' || val === 'multiple-choice' || val === 'mc') return 'multiple_choice';
    if (val === 'true_false' || val === 'tf' || val === 'truefalse' || val === 'true-false' || val === 'boolean') return 'true_false';
    if (val === 'multi_select' || val === 'multi-select' || val === 'checkbox' || val === 'multi' || val === 'checkboxes') return 'multi_select';
    if (val === 'short_answer' || val === 'short' || val === 'text' || val === 'free_text' || val === 'freetext' || val === 'open') return 'short_answer';
    if (val === 'matching' || val === 'match' || val === 'pairs' || val === 'pair') return 'matching';
    if (val === 'ordering' || val === 'order' || val === 'sequence' || val === 'sort' || val === 'rank') return 'ordering';
    if (val === 'fill_blank' || val === 'fill-blank' || val === 'fillblank' || val === 'blank' || val === 'fill' || val === 'cloze') return 'fill_blank';
    return 'multiple_choice';
}

// Builder question data storage
let builderQuestionsData = {};

function addBuilderQuestion() {
    builderQuestionCounter += 1;
    const idx = builderQuestionCounter;

    // Initialize question data
    builderQuestionsData[idx] = {
        type: 'multiple_choice',
        options: ['', '', '', ''],
        correct: 0,
        correct_text: '',
        pairs: [['', ''], ['', '']],
        items: ['', '', ''],
        text_with_blanks: '',
        blanks: [{ answer: '' }]
    };

    const wrapper = document.createElement('div');
    wrapper.className = 'question-card builder-question';
    wrapper.dataset.qid = idx;
    wrapper.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <strong>${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ·' : 'Question'} #${idx}</strong>
            <button type="button" onclick="removeBuilderQuestion(${idx})" style="background:none;border:none;color:#ff6b6b;cursor:pointer;">âœ•</button>
        </div>
        <input class="input-field question-text" placeholder="${currentLang === 'el' ? 'ÎšÎµÎ¯Î¼ÎµÎ½Î¿ ÎµÏÏÏ„Î·ÏƒÎ·Ï‚' : 'Question text'}" style="width:100%; margin-bottom:10px;" />
        <div style="margin-bottom:10px;">
            <label style="font-size:12px;opacity:0.8;">${currentLang === 'el' ? 'Î¤ÏÏ€Î¿Ï‚ ÎµÏÏÏ„Î·ÏƒÎ·Ï‚' : 'Question type'}</label>
            <select class="input-field builder-type-select" onchange="onBuilderTypeChange(${idx}, this.value)">
                ${Object.keys(QUESTION_TYPE_LABELS).map(t => `
                    <option value="${t}">${QUESTION_TYPE_LABELS[t][currentLang] || QUESTION_TYPE_LABELS[t].en}</option>
                `).join('')}
            </select>
        </div>
        <div id="builder-fields-${idx}"></div>
    `;
    $("builderQuestions").appendChild(wrapper);
    renderBuilderFields(idx, 'multiple_choice');
}

function removeBuilderQuestion(idx) {
    const el = document.querySelector(`.builder-question[data-qid="${idx}"]`);
    if (el) el.remove();
    delete builderQuestionsData[idx];
}

function onBuilderTypeChange(idx, type) {
    const normalized = normalizeQuestionType(type);
    const q = builderQuestionsData[idx];
    if (!q) return;

    q.type = normalized;
    if (normalized === 'true_false') {
        q.options = ['False', 'True'];
        q.correct = 0;
    } else if (normalized === 'matching') {
        q.pairs = q.pairs || [['', ''], ['', '']];
    } else if (normalized === 'ordering') {
        q.items = q.items || ['', '', ''];
    } else if (normalized === 'fill_blank') {
        q.text_with_blanks = q.text_with_blanks || '';
        q.blanks = q.blanks || [{ answer: '' }];
    } else if (normalized === 'multi_select') {
        q.options = ['', '', '', ''];
        q.correct = [];
    } else if (normalized === 'short_answer') {
        q.correct_text = '';
    } else {
        q.options = ['', '', '', ''];
        q.correct = 0;
    }
    renderBuilderFields(idx, normalized);
}

function renderBuilderFields(idx, type) {
    const container = $(`builder-fields-${idx}`);
    if (!container) return;
    const q = builderQuestionsData[idx] || {};
    let html = '';

    if (type === 'multiple_choice') {
        html = `
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ (ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î· ÏƒÏ‰ÏƒÏ„Î®)' : 'Options (select correct)'}:</div>
            ${[0,1,2,3].map(i => `
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
                    <input type="radio" name="builder-correct-${idx}" value="${i}" ${(q.correct || 0) === i ? 'checked' : ''} onchange="builderQuestionsData[${idx}].correct=${i}">
                    <input class="input-field builder-option" data-idx="${i}" placeholder="Option ${i+1}" value="${escapeAttr((q.options||[])[i]||'')}" onchange="builderQuestionsData[${idx}].options[${i}]=this.value" style="flex:1;">
                </div>
            `).join('')}
        `;
    } else if (type === 'true_false') {
        html = `
            <div style="display:flex;gap:10px;align-items:center;">
                <label><input type="radio" name="builder-correct-${idx}" value="0" ${(q.correct||0)===0?'checked':''} onchange="builderQuestionsData[${idx}].correct=0"> ${currentLang === 'el' ? 'Î›Î¬Î¸Î¿Ï‚' : 'False'}</label>
                <label><input type="radio" name="builder-correct-${idx}" value="1" ${(q.correct||0)===1?'checked':''} onchange="builderQuestionsData[${idx}].correct=1"> ${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„ÏŒ' : 'True'}</label>
            </div>
        `;
    } else if (type === 'multi_select') {
        const correctValues = Array.isArray(q.correct) ? q.correct : [];
        html = `
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ (Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ ÏƒÏ‰ÏƒÏ„Î­Ï‚)' : 'Options (multiple correct)'}:</div>
            ${[0,1,2,3].map(i => `
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
                    <input type="checkbox" value="${i}" ${correctValues.includes(i)?'checked':''} onchange="toggleBuilderMultiSelect(${idx},${i},this.checked)">
                    <input class="input-field builder-option" data-idx="${i}" placeholder="Option ${i+1}" value="${escapeAttr((q.options||[])[i]||'')}" onchange="builderQuestionsData[${idx}].options[${i}]=this.value" style="flex:1;">
                </div>
            `).join('')}
        `;
    } else if (type === 'short_answer') {
        html = `
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· (Î´Î¹Î±Ï‡Ï‰ÏÎ¯ÏƒÏ„Îµ Î¼Îµ ÎºÏŒÎ¼Î¼Î±)' : 'Correct answer (comma-separated)'}:</div>
            <input class="input-field" placeholder="${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'Correct answer'}" value="${escapeAttr(q.correct_text||'')}" onchange="builderQuestionsData[${idx}].correct_text=this.value" style="width:100%;">
        `;
    } else if (type === 'matching') {
        const pairs = q.pairs || [['', ''], ['', '']];
        html = `
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'Î–ÎµÏ…Î³Î¬ÏÎ¹Î± (ÏŒÏÎ¿Ï‚ â†’ Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚)' : 'Pairs (term â†’ definition)'}:</div>
            <div id="builder-pairs-${idx}">
                ${pairs.map((p, i) => `
                    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'ÎŒÏÎ¿Ï‚' : 'Term'} ${i+1}" value="${escapeAttr(p[0]||'')}" onchange="builderQuestionsData[${idx}].pairs[${i}][0]=this.value" style="flex:1;">
                        <span style="color:#0f6;">â†’</span>
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚' : 'Definition'} ${i+1}" value="${escapeAttr(p[1]||'')}" onchange="builderQuestionsData[${idx}].pairs[${i}][1]=this.value" style="flex:1;">
                        <button type="button" onclick="removeBuilderPair(${idx},${i})" style="background:none;border:none;color:#ff6b6b;cursor:pointer;">âœ•</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" onclick="addBuilderPair(${idx})" class="btn-secondary" style="padding:6px 12px;font-size:12px;">â• ${currentLang === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·' : 'Add pair'}</button>
        `;
    } else if (type === 'ordering') {
        const items = q.items || ['', '', ''];
        html = `
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± (ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬)' : 'Items (in correct order)'}:</div>
            <div id="builder-items-${idx}">
                ${items.map((item, i) => `
                    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                        <span style="color:#888;min-width:25px;">${i+1}.</span>
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿' : 'Item'} ${i+1}" value="${escapeAttr(item||'')}" onchange="builderQuestionsData[${idx}].items[${i}]=this.value" style="flex:1;">
                        <button type="button" onclick="removeBuilderItem(${idx},${i})" style="background:none;border:none;color:#ff6b6b;cursor:pointer;">âœ•</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" onclick="addBuilderItem(${idx})" class="btn-secondary" style="padding:6px 12px;font-size:12px;">â• ${currentLang === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·' : 'Add item'}</button>
            <div style="font-size:0.85em;color:#888;margin-top:8px;">ğŸ’¡ ${currentLang === 'el' ? 'Î˜Î± Î±Î½Î±ÎºÎ±Ï„ÎµÏ…Ï„Î¿ÏÎ½ Î³Î¹Î± Ï„Î¿Î½ Î¼Î±Î¸Î·Ï„Î®' : 'Will be shuffled for student'}</div>
        `;
    } else if (type === 'fill_blank') {
        const blanks = q.blanks || [{ answer: '' }];
        html = `
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'ÎšÎµÎ¯Î¼ÎµÎ½Î¿ (Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ ___ Î³Î¹Î± ÎºÎµÎ½Î¬)' : 'Text (use ___ for blanks)'}:</div>
            <textarea class="input-field" placeholder="${currentLang === 'el' ? 'Î— ___ ÎµÎ¯Î½Î±Î¹ Î· Ï€ÏÏ‰Ï„ÎµÏÎ¿Ï…ÏƒÎ± Ï„Î·Ï‚ ___.' : 'The ___ is the capital of ___.'}" style="width:100%;min-height:60px;margin-bottom:12px;" onchange="builderQuestionsData[${idx}].text_with_blanks=this.value;updateBuilderBlanks(${idx})">${escapeAttr(q.text_with_blanks||'')}</textarea>
            <div style="font-size:0.9em;opacity:0.7;margin-bottom:8px;">${currentLang === 'el' ? 'Î‘Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ ÎºÎµÎ½ÏÎ½' : 'Blank answers'}:</div>
            <div id="builder-blanks-${idx}">
                ${blanks.map((b, i) => `
                    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                        <span style="color:#0f6;min-width:60px;">${currentLang === 'el' ? 'ÎšÎµÎ½ÏŒ' : 'Blank'} ${i+1}:</span>
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'Answer'}" value="${escapeAttr(typeof b==='object'?b.answer||'':b)}" onchange="builderQuestionsData[${idx}].blanks[${i}]={answer:this.value}" style="flex:1;">
                    </div>
                `).join('')}
            </div>
        `;
    }

    container.innerHTML = html;
}

// Builder helper functions
function toggleBuilderMultiSelect(idx, optionIndex, isChecked) {
    const q = builderQuestionsData[idx];
    if (!q) return;
    const current = Array.isArray(q.correct) ? q.correct : [];
    q.correct = isChecked
        ? Array.from(new Set([...current, optionIndex]))
        : current.filter(v => v !== optionIndex);
}

function addBuilderPair(idx) {
    const q = builderQuestionsData[idx];
    if (!q) return;
    q.pairs = q.pairs || [];
    q.pairs.push(['', '']);
    renderBuilderFields(idx, 'matching');
}

function removeBuilderPair(idx, pairIdx) {
    const q = builderQuestionsData[idx];
    if (!q || !q.pairs) return;
    q.pairs.splice(pairIdx, 1);
    if (q.pairs.length === 0) q.pairs.push(['', '']);
    renderBuilderFields(idx, 'matching');
}

function addBuilderItem(idx) {
    const q = builderQuestionsData[idx];
    if (!q) return;
    q.items = q.items || [];
    q.items.push('');
    renderBuilderFields(idx, 'ordering');
}

function removeBuilderItem(idx, itemIdx) {
    const q = builderQuestionsData[idx];
    if (!q || !q.items) return;
    q.items.splice(itemIdx, 1);
    if (q.items.length === 0) q.items.push('');
    renderBuilderFields(idx, 'ordering');
}

function updateBuilderBlanks(idx) {
    const q = builderQuestionsData[idx];
    if (!q) return;
    const text = q.text_with_blanks || '';
    const blankCount = (text.match(/___/g) || []).length || 1;
    const currentBlanks = q.blanks || [];
    while (currentBlanks.length < blankCount) currentBlanks.push({ answer: '' });
    while (currentBlanks.length > blankCount && currentBlanks.length > 1) currentBlanks.pop();
    q.blanks = currentBlanks;
    renderBuilderFields(idx, 'fill_blank');
}

function collectQuizBuilder() {
    const passScore = parseInt($("builderPassScore").value || '70');
    const questions = [];

    document.querySelectorAll('.builder-question').forEach((el) => {
        const qid = el.dataset.qid;
        const text = el.querySelector('.question-text')?.value?.trim() || '';
        const q = builderQuestionsData[qid];
        if (!text || !q) return;

        const qType = normalizeQuestionType(q.type);
        const questionData = {
            id: questions.length + 1,
            text: text,
            type: qType
        };

        if (qType === 'multiple_choice') {
            questionData.options = q.options || ['', '', '', ''];
            questionData.correct_index = q.correct || 0;
        } else if (qType === 'true_false') {
            questionData.options = ['False', 'True'];
            questionData.correct_index = q.correct || 0;
        } else if (qType === 'multi_select') {
            questionData.options = q.options || ['', '', '', ''];
            questionData.correct = q.correct || [];
        } else if (qType === 'short_answer') {
            questionData.correct_text = q.correct_text || '';
        } else if (qType === 'matching') {
            questionData.pairs = q.pairs || [];
        } else if (qType === 'ordering') {
            questionData.items = q.items || [];
        } else if (qType === 'fill_blank') {
            questionData.text_with_blanks = q.text_with_blanks || '';
            questionData.blanks = q.blanks || [];
        }

        questions.push(questionData);
    });

    return {
        pass_score: isNaN(passScore) ? 70 : passScore,
        questions
    };
}

// Tab switching
function showTab(name) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    $(name + '-tab').classList.add('active');
    event.target.classList.add('active');
    if (name === 'my-courses') loadMyCourses();
}

function syncWalletFromSession(showToast = true) {
    const addr = (window.walletSession?.getAddress && window.walletSession.getAddress()) || '';
    const secret = (window.walletSession?.getSendSecret && window.walletSession.getSendSecret()) || '';
    if (!addr || !secret) {
        $("walletWarning").style.display = "block";
        $("walletStatus").style.display = "none";
        if (showToast) log("Please connect via wallet widget", true);
        return false;
    }

    connectedWallet = addr;
    connectedSecret = secret;
    connectedPassphrase = '';
    $("wallet").value = addr;
    $("walletStatus").style.display = "block";
    $("walletWarning").style.display = "none";
    $("connectedWallet").textContent = addr.substring(0, 12) + '...';

    apiGet(`/api/v1/l2e/balance/${addr}`).then(data => {
        $("l2eBalance").textContent = data.l2e_balance || data.balance || 0;
    }).catch(e => log(`Failed to load L2E balance: ${e.message}`, true));

    if (showToast) log(`Connected wallet: ${addr}`);
    refresh();
    return true;
}

// Connect Wallet
$("connectBtn").onclick = () => syncWalletFromSession(true);

// Create Course Card
function courseCard(c) {
    const el = document.createElement("div");
    el.className = "course-card";

    const isEnrolled = connectedWallet && (c.students || []).includes(connectedWallet);
    const isCompleted = connectedWallet && (c.completed || []).includes(connectedWallet);
    const isQuizPassed = connectedWallet && (c.quiz_passed || []).includes(connectedWallet);
    const isTeacher = connectedWallet && c.teacher === connectedWallet;
    const hasQuiz = c.has_quiz;

    let badges = "";
    if (isEnrolled) badges += `<span class="badge badge-enrolled">${currentLang === 'el' ? 'Î•Î³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î¿Ï‚' : 'Enrolled'}</span>`;
    if (isQuizPassed) badges += `<span class="badge badge-quiz-passed">${currentLang === 'el' ? 'Quiz âœ“' : 'Quiz âœ“'}</span>`;
    if (isCompleted) badges += `<span class="badge badge-completed">${currentLang === 'el' ? 'ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ' : 'Completed'}</span>`;
    if (hasQuiz) badges += `<span class="badge badge-has-quiz">ğŸ“ Quiz</span>`;

    el.innerHTML = `
        <div class="course-header">
            <div style="flex: 1;">
                <div class="course-title">${escapeHtml(c.title)}${badges}</div>
                <div class="course-meta">ğŸ‘¨â€ğŸ« ${currentLang === 'el' ? 'Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î®Ï‚' : 'Teacher'}: <code>${escapeHtml(c.teacher.substring(0, 12))}...</code></div>
                <div class="course-meta">ğŸ’° ${currentLang === 'el' ? 'Î¤Î¹Î¼Î®' : 'Price'}: <strong>${c.price_thr}</strong> THR Â· ğŸ ${currentLang === 'el' ? 'Î‘Î½Ï„Î±Î¼Î¿Î¹Î²Î®' : 'Reward'}: <strong>${c.reward_l2e}</strong> L2E</div>
                <div class="course-stats">
                    <span>ğŸ‘¥ ${(c.students || []).length} ${currentLang === 'el' ? 'Î¼Î±Î¸Î·Ï„Î­Ï‚' : 'students'}</span>
                    <span>âœ… ${(c.completed || []).length} ${currentLang === 'el' ? 'Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ±Î½' : 'completed'}</span>
                </div>
            </div>
            <div class="course-actions">
                ${isEnrolled ? `
                    <button class="btn-primary" onclick="openCourseModal('${c.id}', 'lesson')">
                        ğŸš€ ${currentLang === 'el' ? 'Î†Î½Î¿Î¹Î³Î¼Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚' : 'Open course'}
                    </button>
                ` : `
                    <button class="btn-enroll btn-primary" ${!connectedWallet ? 'disabled' : ''}>
                        ğŸ“ ${currentLang === 'el' ? 'Î•Î³Î³ÏÎ±Ï†Î®' : 'Enroll'}
                    </button>
                `}
                ${hasQuiz && isEnrolled ? `
                    <button class="btn-quiz btn-secondary" onclick="openCourseModal('${c.id}', 'quiz')">
                        ğŸ“ ${isQuizPassed ? (currentLang === 'el' ? 'Î•Ï€Î±Î½ÎµÎ¾Î­Ï„Î±ÏƒÎ·' : 'Retake Quiz') : (currentLang === 'el' ? 'ÎšÎ¬Î½Îµ Quiz' : 'Take Quiz')}
                    </button>
                ` : ''}
                ${isTeacher ? `
                    <button class="btn-secondary" onclick="openCreateQuiz('${c.id}')">
                        âš™ï¸ ${currentLang === 'el' ? 'Quiz Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚' : 'Quiz Settings'}
                    </button>
                    <button class="btn-complete btn-secondary">
                        âœ… ${currentLang === 'el' ? 'ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·' : 'Complete'}
                    </button>
                    <button class="btn-danger" onclick="deleteCourse('${c.id}')">
                        ğŸ—‘ï¸ ${currentLang === 'el' ? 'Î”Î¹Î±Î³ÏÎ±Ï†Î®' : 'Delete'}
                    </button>
                ` : ''}
            </div>
        </div>
    `;

    // Enroll button
    const enrollBtn = el.querySelector(".btn-enroll");
    if (enrollBtn) {
        enrollBtn.onclick = async () => {
            if (!connectedWallet || !connectedSecret) {
                log("Please connect wallet first", true);
                return;
            }

            try {
                log(`Enrolling in "${c.title}"...`);
                const result = await apiPost(`/api/v1/courses/${c.id}/enroll`, {
                    student_thr: connectedWallet,
                    auth_secret: connectedSecret,
                    passphrase: connectedPassphrase
                });

                if (result.status === "success") {
                    log(`Successfully enrolled in "${c.title}"! TX: ${result.tx.tx_id}`);
                    await refresh();
                } else {
                    log(`Enrollment failed: ${result.message || 'Unknown error'}`, true);
                }
            } catch (e) {
                log(`Enrollment error: ${e.message}`, true);
            }
        };
    }

    // Complete button (for teachers)
    const completeBtn = el.querySelector(".btn-complete");
    if (completeBtn) {
        completeBtn.onclick = async () => {
            const studentAddr = prompt(currentLang === 'el' ? "Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ THR Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¼Î±Î¸Î·Ï„Î®:" : "Enter student's THR address:");
            if (!studentAddr) return;

            try {
                log(`Marking student ${studentAddr} as completed...`);
                const result = await apiPost(`/api/v1/courses/${c.id}/complete`, {
                    student_thr: studentAddr,
                    teacher_thr: connectedWallet,
                    auth_secret: connectedSecret,
                    passphrase: connectedPassphrase
                });

                if (result.status === "success") {
                    log(`Student completed! L2E reward distributed. TX: ${result.tx.tx_id}`);
                    await refresh();
                } else {
                    log(`Completion failed: ${result.message}`, true);
                }
            } catch (e) {
                log(`Completion error: ${e.message}`, true);
            }
        };
    }

    return el;
}

// Refresh Courses
async function refresh() {
    const box = $("courses");
    box.innerHTML = `<div class="loading">${currentLang === 'el' ? 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¼Î±Î¸Î·Î¼Î¬Ï„Ï‰Î½...' : 'Loading courses...'}</div>`;

    try {
        const data = await apiGet("/api/v1/courses");
        const courses = data.courses || [];

        // Check which courses have quizzes
        for (let c of courses) {
            try {
                const quizData = await apiGet(`/api/v1/courses/${c.id}/quiz`);
                c.has_quiz = quizData.quiz && quizData.quiz.questions && quizData.quiz.questions.length > 0;
            } catch (e) {
                c.has_quiz = false;
            }
        }
        coursesCache = courses;

        box.innerHTML = "";

        if (courses.length === 0) {
            box.innerHTML = `<div class="empty-state">${currentLang === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼Î±Î¸Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î±.' : 'No courses available yet.'}<br>${currentLang === 'el' ? 'Î“Î¯Î½Îµ Î¿ Ï€ÏÏÏ„Î¿Ï‚ Ï€Î¿Ï… Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹!' : 'Be the first to create one!'}</div>`;
        } else {
            courses.forEach(c => box.appendChild(courseCard(c)));
        }

        // Update stats
        $("totalCourses").textContent = courses.length;
        const totalStudents = courses.reduce((sum, c) => sum + (c.students || []).length, 0);
        $("totalStudents").textContent = totalStudents;
        const totalL2E = courses.reduce((sum, c) => sum + (c.completed || []).length * c.reward_l2e, 0);
        $("totalL2E").textContent = totalL2E.toFixed(2);

    } catch (e) {
        box.innerHTML = `<div class="error">${currentLang === 'el' ? 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚' : 'Failed to load courses'}: ${e.message}</div>`;
    }
}

// Load My Courses
async function loadMyCourses() {
    if (!connectedWallet) {
        $("my-courses-list").innerHTML = `<div class="empty-state">${currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚' : 'Please connect your wallet'}</div>`;
        return;
    }

    try {
        const data = await apiGet("/api/v1/courses");
        const courses = data.courses || [];
        const myCourses = courses.filter(c => (c.students || []).includes(connectedWallet));

        const box = $("my-courses-list");
        box.innerHTML = "";

        if (myCourses.length === 0) {
            box.innerHTML = `<div class="empty-state">${currentLang === 'el' ? 'Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÎ³Î³ÏÎ±Ï†ÎµÎ¯ ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Î¼Î¬Î¸Î·Î¼Î±' : 'You are not enrolled in any courses'}</div>`;
        } else {
            myCourses.forEach(c => box.appendChild(courseCard(c)));
        }
    } catch (e) {
        $("my-courses-list").innerHTML = `<div class="error">${e.message}</div>`;
    }
}

// Create Course
$("create").onclick = async () => {
    if (!connectedWallet || !connectedSecret) {
        log("Please connect wallet first", true);
        return;
    }

    const title = $("title").value.trim();
    const price = parseFloat($("price").value || "0");
    const reward = parseFloat($("reward").value || "0");
    const description = $("description").value.trim();
    const titleEl = $("titleEl").value.trim();
    const contentType = (document.querySelector('input[name="contentType"]:checked') || {}).value || 'pdf';
    const slidesFile = $("slidesFile").files[0];
    const videoUrl = $("videoUrl").value.trim();
    const contentUrl = $("contentUrl").value.trim();
    const quizPayload = collectQuizBuilder();

    if (!title || price < 0 || reward <= 0) {
        log("Invalid input: Title required, price >= 0, reward > 0", true);
        return;
    }

    if (contentType === 'pdf' && !slidesFile) {
        log("Please upload a slides PDF", true);
        return;
    }
    if (contentType === 'video' && !videoUrl) {
        log("Please provide a video URL", true);
        return;
    }
    if (contentType === 'external' && !contentUrl) {
        log("Please provide an external content URL", true);
        return;
    }

    try {
        log(`Creating course "${title}"...`);
        const formData = new FormData();
        formData.append('title', title);
        formData.append('title_el', titleEl);
        formData.append('description', description);
        formData.append('teacher', connectedWallet);
        formData.append('price_thr', price);
        formData.append('reward_l2e', reward);
        formData.append('auth_secret', connectedSecret);
        formData.append('passphrase', connectedPassphrase);
        formData.append('content_type', contentType);
        if (contentType === 'pdf' && slidesFile) formData.append('slides', slidesFile);
        if (contentType === 'video') formData.append('video_url', videoUrl);
        if (contentType === 'external') formData.append('content_url', contentUrl);
        if (quizPayload.questions.length > 0) {
            formData.append('quiz', JSON.stringify(quizPayload));
        }

        const response = await fetch("/api/v1/courses", { method: "POST", body: formData });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();

        if (result.status === "success") {
            log(`Course "${title}" created! ID: ${result.course.id}`);
            $("title").value = "";
            $("titleEl").value = "";
            $("description").value = "";
            $("price").value = "";
            $("reward").value = "";
            $("slidesFile").value = "";
            $("videoUrl").value = "";
            $("contentUrl").value = "";
            $("builderPassScore").value = "70";
            $("builderQuestions").innerHTML = "";
            builderQuestionCounter = 0;
            addBuilderQuestion();
            await refresh();
        } else {
            log(`Course creation failed: ${result.message}`, true);
        }
    } catch (e) {
        log(`Creation error: ${e.message}`, true);
    }
};

document.querySelectorAll('input[name="contentType"]').forEach(r => r.addEventListener('change', toggleContentFields));
toggleContentFields();
addBuilderQuestion();

// Course Modal Functions
async function openCourseModal(courseId, tab = 'lesson') {
    currentQuizCourseId = courseId;
    currentQuizQuestions = [];
    lastLoadedQuizCourseId = null;
    currentCourse = coursesCache.find(c => c.id === courseId) || null;
    if (!currentCourse) {
        try {
            const data = await apiGet(`/api/v1/courses/${courseId}`);
            currentCourse = data.course;
        } catch (e) {
            currentCourse = null;
        }
    }

    if (currentCourse) {
        $("courseModalTitle").textContent = `ğŸ“ ${currentCourse.title}`;
        if (currentCourse.has_quiz === undefined) {
            try {
                const quizData = await apiGet(`/api/v1/courses/${courseId}/quiz`);
                currentCourse.has_quiz = quizData.quiz && quizData.quiz.questions && quizData.quiz.questions.length > 0;
            } catch (e) {
                currentCourse.has_quiz = false;
            }
        }
    } else {
        $("courseModalTitle").textContent = "ğŸ“ Course";
    }

    renderCourseLesson(currentCourse);
    if (tab === 'quiz') {
        await loadQuizForModal(courseId);
    }
    await showCourseModalTab(tab);
    $("courseModal").classList.add("active");
}

async function showCourseModalTab(tab) {
    document.querySelectorAll('.modal-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    document.querySelectorAll('.modal-section').forEach(section => {
        section.classList.toggle('active', section.id === `courseModal${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
    });
    if (tab === 'quiz' && currentQuizCourseId) {
        await loadQuizForModal(currentQuizCourseId);
    }
}

function renderCourseLesson(course) {
    const box = $("courseLessonContent");
    const actions = $("courseLessonActions");
    actions.innerHTML = "";

    if (!course) {
        box.innerHTML = `<div class="error">${currentLang === 'el' ? 'Î¤Î¿ Î¼Î¬Î¸Î·Î¼Î± Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ' : 'Course not found'}</div>`;
        return;
    }

    const isTeacher = connectedWallet && course.teacher === connectedWallet;
    const isEnrolled = connectedWallet && (course.students || []).includes(connectedWallet);
    const price = parseFloat(course.price_thr || 0);
    const materials = course?.metadata?.materials || {};

    let notice = '';
    if (!connectedWallet) {
        notice = currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï…Î»Î¹ÎºÏŒ.' : 'Connect your wallet to view materials.';
    } else if (!isEnrolled && !isTeacher) {
        notice = price > 0
            ? (currentLang === 'el' ? `Î¤Î¿ Î¼Î¬Î¸Î·Î¼Î± ÎºÎ¿ÏƒÏ„Î¯Î¶ÎµÎ¹ ${price} THR. ÎšÎ¬Î½Ï„Îµ ÎµÎ³Î³ÏÎ±Ï†Î® Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·.` : `This course costs ${price} THR. Enroll to access.`)
            : (currentLang === 'el' ? 'ÎšÎ¬Î½Ï„Îµ ÎµÎ³Î³ÏÎ±Ï†Î® Î³Î¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ Ï…Î»Î¹ÎºÏŒ.' : 'Enroll to access materials.');
    }

    let materialHtml = '';
    if (!isEnrolled && !isTeacher) {
        materialHtml = `<div style="padding:12px;border-radius:10px;border:1px solid #1a5a2f;background:#050b07;">${currentLang === 'el' ? 'Î¤Î¿ Ï…Î»Î¹ÎºÏŒ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎµÎ³Î³ÏÎ±Ï†Î®.' : 'Materials unlock after enrollment.'}</div>`;
    } else if (materials.type === 'pdf' && materials.slides_path) {
        materialHtml = `<a class="btn-secondary" href="/media/${materials.slides_path}" target="_blank">ğŸ“„ ${currentLang === 'el' ? 'Î†Î½Î¿Î¹Î³Î¼Î± Î”Î¹Î±Ï†Î±Î½ÎµÎ¹ÏÎ½' : 'Open Slides'}</a>`;
    } else if (materials.type === 'video' && materials.video_url) {
        materialHtml = `<a class="btn-secondary" href="${materials.video_url}" target="_blank">ğŸ¬ ${currentLang === 'el' ? 'Î†Î½Î¿Î¹Î³Î¼Î± Video' : 'Open Video'}</a>`;
    } else if (materials.type === 'external' && materials.content_url) {
        materialHtml = `<a class="btn-secondary" href="${materials.content_url}" target="_blank">ğŸ”— ${currentLang === 'el' ? 'Î†Î½Î¿Î¹Î³Î¼Î± Î¥Î»Î¹ÎºÎ¿Ï' : 'Open Material'}</a>`;
    } else {
        materialHtml = `<div style="opacity:0.7;">${currentLang === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…Î»Î¹ÎºÏŒ Î±ÎºÏŒÎ¼Î·.' : 'No course materials configured yet.'}</div>`;
    }

    box.innerHTML = `
        <div style="margin-bottom:10px;opacity:0.85;">${escapeHtml(course.description || '')}</div>
        ${notice ? `<div style="margin-bottom:12px;color:#ff9b5f;">${notice}</div>` : ''}
        <div>${materialHtml}</div>
    `;

    if (course.has_quiz) {
        const canTakeQuiz = isTeacher || isEnrolled;
        actions.innerHTML = `
            <button class="btn-primary" onclick="showCourseModalTab('quiz')" ${canTakeQuiz ? '' : 'disabled'}>
                ğŸ“ ${currentLang === 'el' ? 'ÎšÎ¬Î½Îµ Quiz' : 'Take Quiz'}
            </button>
        `;
    }
}

async function deleteCourse(courseId) {
    if (!connectedWallet || !connectedSecret) {
        log("Please connect wallet first", true);
        return;
    }

    const confirmText = currentLang === 'el'
        ? 'Î•Î¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î±;'
        : 'Are you sure you want to delete this course?';

    if (!confirm(confirmText)) return;

    try {
        const result = await apiPost(`/api/v1/courses/${courseId}/delete`, {
            teacher_thr: connectedWallet,
            auth_secret: connectedSecret,
            passphrase: connectedPassphrase
        });

        if (result.status === "success") {
            log(currentLang === 'el' ? 'Î¤Î¿ Î¼Î¬Î¸Î·Î¼Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ.' : 'Course deleted.');
            closeCourseModal();
            await refresh();
        } else {
            log(result.message || 'Delete failed', true);
        }
    } catch (e) {
        log(`Delete error: ${e.message}`, true);
    }
}

async function loadQuizForModal(courseId) {
    if (lastLoadedQuizCourseId === courseId && currentQuizQuestions.length > 0) {
        return;
    }

    try {
        const data = await apiGet(`/api/v1/courses/${courseId}/quiz`);
        if (!data.quiz || !data.quiz.questions || data.quiz.questions.length === 0) {
            $("quizContent").innerHTML = `<div class="error">${currentLang === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ quiz Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î±' : 'No quiz available for this course'}</div>`;
            $("submitQuizBtn").style.display = "none";
            return;
        }

        const quiz = data.quiz;
        currentQuizQuestions = quiz.questions;
        lastLoadedQuizCourseId = courseId;

        let html = `<p style="margin-bottom: 20px; opacity: 0.8;">${currentLang === 'el' ? 'Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚' : 'Passing score'}: ${quiz.passing_score}%</p>`;

        quiz.questions.forEach((q, idx) => {
            const questionText = currentLang === 'el' ? (q.question_el || q.question) : q.question;
            const options = currentLang === 'el' ? (q.options_el || q.options) : q.options;
            const qType = normalizeQuestionType(q.type);

            let body = '';
            if (qType === 'true_false') {
                body = `
                    <label class="option-label">
                        <input type="radio" name="q${q.id}" value="0">${currentLang === 'el' ? 'Î›Î¬Î¸Î¿Ï‚' : 'False'}
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q${q.id}" value="1">${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„ÏŒ' : 'True'}
                    </label>`;
            } else if (qType === 'multi_select') {
                body = (options || []).map((opt, optIdx) => `
                    <label class="option-label">
                        <input type="checkbox" name="q${q.id}" value="${optIdx}">
                        ${escapeHtml(opt)}
                    </label>
                `).join('');
            } else if (qType === 'short_answer') {
                body = `
                    <input class="input-field" name="q${q.id}" placeholder="${currentLang === 'el' ? 'Î“ÏÎ¬ÏˆÎµ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'Type your answer'}" style="width: 100%;">
                `;
            } else if (qType === 'matching') {
                // Render matching pairs - shuffle right column for student
                const pairs = q.pairs || [];
                const terms = pairs.map((p, i) => ({ text: p[0], idx: i }));
                const definitions = pairs.map((p, i) => ({ text: p[1], idx: i }));
                // Shuffle definitions
                const shuffledDefs = [...definitions].sort(() => Math.random() - 0.5);
                body = `
                    <div style="font-size: 0.9em; margin-bottom: 10px; color: #888;">
                        ${currentLang === 'el' ? 'Î‘Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎµ ÎºÎ¬Î¸Îµ ÏŒÏÎ¿ Î¼Îµ Ï„Î¿Î½ ÏƒÏ‰ÏƒÏ„ÏŒ Î¿ÏÎ¹ÏƒÎ¼ÏŒ' : 'Match each term with the correct definition'}
                    </div>
                    <div class="matching-container" data-qid="${q.id}">
                        ${terms.map((term, i) => `
                            <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <div style="flex: 1; padding: 8px; background: rgba(0,255,102,0.1); border-radius: 4px;">
                                    ${escapeHtml(term.text)}
                                </div>
                                <span style="color: #0f6;">â†’</span>
                                <select class="input-field matching-select" data-term="${term.idx}" name="q${q.id}_${term.idx}" style="flex: 1;">
                                    <option value="">-- ${currentLang === 'el' ? 'Î•Ï€Î¯Î»ÎµÎ¾Îµ' : 'Select'} --</option>
                                    ${shuffledDefs.map(def => `
                                        <option value="${def.idx}">${escapeHtml(def.text)}</option>
                                    `).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (qType === 'ordering') {
                // Render ordering - shuffle items for student
                const items = q.items || q.options || [];
                const shuffledItems = items.map((item, i) => ({ text: item, originalIdx: i }))
                    .sort(() => Math.random() - 0.5);
                body = `
                    <div style="font-size: 0.9em; margin-bottom: 10px; color: #888;">
                        ${currentLang === 'el' ? 'Î£ÏÏÎµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬ (Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î± Î²Î­Î»Î·)' : 'Drag items to correct order (or use arrows)'}
                    </div>
                    <div class="ordering-container" data-qid="${q.id}" id="ordering-${q.id}">
                        ${shuffledItems.map((item, i) => `
                            <div class="ordering-item" data-original-idx="${item.originalIdx}" draggable="true"
                                 style="display: flex; gap: 10px; align-items: center; padding: 10px; margin-bottom: 6px;
                                        background: rgba(0,255,102,0.1); border: 1px solid rgba(0,255,102,0.3);
                                        border-radius: 6px; cursor: move;">
                                <span style="color: #888;" class="order-number">${i + 1}.</span>
                                <span style="flex: 1;">${escapeHtml(item.text)}</span>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button type="button" onclick="moveOrderItem('${q.id}', this.closest('.ordering-item'), -1)"
                                            style="background: none; border: none; color: #0f6; cursor: pointer; font-size: 14px;">â–²</button>
                                    <button type="button" onclick="moveOrderItem('${q.id}', this.closest('.ordering-item'), 1)"
                                            style="background: none; border: none; color: #0f6; cursor: pointer; font-size: 14px;">â–¼</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (qType === 'fill_blank') {
                // Render fill in the blank
                const textWithBlanks = q.text_with_blanks || q.prompt || '';
                const blanks = q.blanks || [];
                let blankIdx = 0;
                const renderedText = textWithBlanks.replace(/___/g, () => {
                    const inputHtml = `<input class="input-field fill-blank-input" name="q${q.id}_${blankIdx}"
                                              data-blank-idx="${blankIdx}"
                                              style="width: 120px; display: inline-block; margin: 0 4px;"
                                              placeholder="${currentLang === 'el' ? 'Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'answer'}">`;
                    blankIdx++;
                    return inputHtml;
                });
                body = `
                    <div style="font-size: 0.9em; margin-bottom: 10px; color: #888;">
                        ${currentLang === 'el' ? 'Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± ÎºÎµÎ½Î¬' : 'Fill in the blanks'}
                    </div>
                    <div class="fill-blank-text" data-qid="${q.id}" style="line-height: 2.2; font-size: 1.05em;">
                        ${renderedText}
                    </div>
                `;
            } else {
                // Multiple choice (default)
                body = (options || []).map((opt, optIdx) => `
                    <label class="option-label">
                        <input type="radio" name="q${q.id}" value="${optIdx}">
                        ${escapeHtml(opt)}
                    </label>
                `).join('');
            }

            html += `
                <div class="question-card">
                    <div class="question-text">
                        <span class="question-number">#${idx + 1}</span>
                        ${escapeHtml(questionText)}
                        <span style="font-size:12px;opacity:0.7;margin-left:8px;">(${qType.toUpperCase()})</span>
                    </div>
                    <div class="options">${body}</div>
                </div>
            `;
        });

        $("quizContent").innerHTML = html;
        $("submitQuizBtn").style.display = "inline-block";

    } catch (e) {
        $("quizContent").innerHTML = `<div class="error">${e.message}</div>`;
        $("submitQuizBtn").style.display = "none";
    }
}

function closeCourseModal() {
    $("courseModal").classList.remove("active");
    currentQuizCourseId = null;
    currentQuizQuestions = [];
    currentCourse = null;
    lastLoadedQuizCourseId = null;
}

async function submitQuiz() {
    if (!connectedWallet) {
        alert(currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚' : 'Please connect your wallet');
        return;
    }

    // Reset previous highlights
    document.querySelectorAll('.question-card').forEach(card => {
        card.style.border = '1px solid #1a5a2f';
    });

    // Collect answers and track unanswered questions
    const answers = {};
    const unansweredQuestions = [];

    currentQuizQuestions.forEach((q, idx) => {
        const qType = normalizeQuestionType(q.type);
        if (qType === 'multiple_choice' || qType === 'true_false') {
            const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
            if (selected) {
                answers[q.id] = parseInt(selected.value);
            } else {
                unansweredQuestions.push(idx + 1);
            }
        } else if (qType === 'multi_select') {
            const selected = Array.from(document.querySelectorAll(`input[name="q${q.id}"]:checked`))
                .map(el => parseInt(el.value));
            if (selected.length > 0) {
                answers[q.id] = selected;
            } else {
                unansweredQuestions.push(idx + 1);
            }
        } else if (qType === 'short_answer') {
            const input = document.querySelector(`input[name="q${q.id}"]`);
            const value = input ? input.value.trim() : '';
            if (value) {
                answers[q.id] = value;
            } else {
                unansweredQuestions.push(idx + 1);
            }
        } else if (qType === 'matching') {
            // Collect matching pairs: {termIdx: definitionIdx, ...}
            const pairs = q.pairs || [];
            const mapping = {};
            let allSelected = true;
            pairs.forEach((p, termIdx) => {
                const select = document.querySelector(`select[name="q${q.id}_${termIdx}"]`);
                if (select && select.value !== '') {
                    mapping[termIdx] = parseInt(select.value);
                } else {
                    allSelected = false;
                }
            });
            if (allSelected && Object.keys(mapping).length === pairs.length) {
                answers[q.id] = mapping;
            } else {
                unansweredQuestions.push(idx + 1);
            }
        } else if (qType === 'ordering') {
            // Collect ordering: [originalIdx, ...] in the displayed order
            const container = document.querySelector(`#ordering-${q.id}`);
            if (container) {
                const items = container.querySelectorAll('.ordering-item');
                const order = Array.from(items).map(item => parseInt(item.dataset.originalIdx));
                if (order.length > 0) {
                    answers[q.id] = order;
                } else {
                    unansweredQuestions.push(idx + 1);
                }
            } else {
                unansweredQuestions.push(idx + 1);
            }
        } else if (qType === 'fill_blank') {
            // Collect fill-in-the-blank answers: [answer1, answer2, ...]
            const blanks = q.blanks || [];
            const blankAnswers = [];
            let allFilled = true;
            blanks.forEach((b, blankIdx) => {
                const input = document.querySelector(`input[name="q${q.id}_${blankIdx}"]`);
                const value = input ? input.value.trim() : '';
                blankAnswers.push(value);
                if (!value) allFilled = false;
            });
            if (allFilled && blankAnswers.length === blanks.length) {
                answers[q.id] = blankAnswers;
            } else {
                unansweredQuestions.push(idx + 1);
            }
        }
    });

    if (unansweredQuestions.length > 0) {
        // Highlight unanswered questions
        unansweredQuestions.forEach(qNum => {
            const questionCards = document.querySelectorAll('.question-card');
            if (questionCards[qNum - 1]) {
                questionCards[qNum - 1].style.border = '2px solid #ff6b6b';
                questionCards[qNum - 1].style.boxShadow = '0 0 10px rgba(255, 107, 107, 0.3)';
            }
        });

        // Scroll to first unanswered question
        const firstUnanswered = document.querySelectorAll('.question-card')[unansweredQuestions[0] - 1];
        if (firstUnanswered) {
            firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const msg = currentLang === 'el'
            ? `Î‘Ï€Î±Î½Ï„Î®ÏƒÏ„Îµ ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚. Î›ÎµÎ¯Ï€Î¿Ï…Î½: ${unansweredQuestions.join(', ')}`
            : `Please answer all questions. Missing: ${unansweredQuestions.join(', ')}`;
        alert(msg);
        return;
    }

    try {
        const result = await apiPost(`/api/v1/courses/${currentQuizCourseId}/quiz/submit`, {
            student_thr: connectedWallet,
            answers: answers
        });

        // Show results
        const passedClass = result.passed ? 'passed' : 'failed';
        const passedText = result.passed
            ? (currentLang === 'el' ? 'ğŸ‰ Î Î­ÏÎ±ÏƒÎµÏ‚!' : 'ğŸ‰ You Passed!')
            : (currentLang === 'el' ? 'ğŸ˜” Î”ÎµÎ½ Ï€Î­ÏÎ±ÏƒÎµÏ‚' : 'ğŸ˜” You Failed');

        let breakdown = '';
        (result.results || []).forEach((row, i) => {
            const qMeta = currentQuizQuestions.find(q => String(q.id) === String(row.question_id)) || {};
            const label = currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„ÏŒ' : 'Correct';
            const wrong = currentLang === 'el' ? 'Î›Î¬Î¸Î¿Ï‚' : 'Wrong';
            // Get explanation from result (returned by API) or fallback to question metadata
            const explanation = currentLang === 'el'
                ? (row.explanation_el || row.explanation || qMeta.explanation_el || qMeta.explanation || '')
                : (row.explanation || row.explanation_el || qMeta.explanation || qMeta.explanation_el || '');
            const explanationHtml = explanation
                ? `<div style="margin-top:10px;padding:10px;background:rgba(0,255,102,0.1);border-radius:8px;border-left:3px solid #00ff66;">
                    <div style="font-size:11px;opacity:0.7;margin-bottom:4px;">ğŸ’¡ ${currentLang === 'el' ? 'Î•Ï€ÎµÎ¾Î®Î³Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÎ±Î¸Î·Î³Î·Ï„Î®' : "Teacher's explanation"}:</div>
                    <div style="font-size:13px;">${escapeHtml(explanation)}</div>
                   </div>`
                : '';
            breakdown += `
                <div class="question-card" style="border:${row.correct ? '1px solid #1a5a2f' : '1px solid #5f1a1a'}">
                    <div class="question-text"><span class="question-number">#${i + 1}</span> ${escapeHtml(qMeta.question || '')}</div>
                    <div style="opacity:0.8;font-size:13px;">${row.correct ? label : wrong}</div>
                    <div style="font-size:12px;opacity:0.7;">${currentLang === 'el' ? 'Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ® ÏƒÎ¿Ï…' : 'Your answer'}: ${JSON.stringify(row.your_answer)}</div>
                    <div style="font-size:12px;opacity:0.7;">${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'Correct answer'}: ${JSON.stringify(row.correct_answer)}</div>
                    ${explanationHtml}
                </div>`;
        });

        const rewardStatus = result.reward_credited
            ? (currentLang === 'el' ? `âœ… Î Î»Î·ÏÏ‰Î¼Î® Î±Î½Ï„Î±Î¼Î¿Î¹Î²Î®Ï‚ (${result.reward_amount} L2E)` : `âœ… Reward paid (${result.reward_amount} L2E)`)
            : (result.passed ? (currentLang === 'el' ? 'â³ Î‘Î½Î±Î¼Î¿Î½Î® Î±Î½Ï„Î±Î¼Î¿Î¹Î²Î®Ï‚' : 'â³ Reward pending') : (currentLang === 'el' ? 'Î”ÎµÎ½ Ï€Î»Î·ÏÎ¿Î¯Ï‚ Ï„Î¹Ï‚ Ï€ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚' : 'Not eligible'));

        $("quizContent").innerHTML = `
            <div class="quiz-result">
                <div class="quiz-score ${passedClass}">${result.score}%</div>
                <div style="font-size: 1.5em; margin: 15px 0;">${passedText}</div>
                <p>${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î­Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚' : 'Correct answers'}: ${result.correct}/${result.total}</p>
                <p>${currentLang === 'el' ? 'Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚' : 'Passing score'}: ${result.passing_score}%</p>
                <p>${rewardStatus}</p>
                <div style="margin-top:15px;">${breakdown}</div>
            </div>
        `;

        $("submitQuizBtn").style.display = "none";

        // Refresh courses to update badges
        await refresh();

    } catch (e) {
        alert(`Error submitting quiz: ${e.message}`);
    }
}

// Create Quiz Functions
let quizQuestions = [];

async function openCreateQuiz(courseId) {
    currentQuizCourseId = courseId;
    quizQuestions = [];
    $("questionsContainer").innerHTML = "";
    $("quizTitleInput").value = "";
    $("passingScore").value = "80";
    await loadQuizForEdit(courseId);
    if (quizQuestions.filter(Boolean).length === 0) {
        addQuestion();
    }
    $("createQuizModal").classList.add("active");
}

function closeCreateQuizModal() {
    $("createQuizModal").classList.remove("active");
    currentQuizCourseId = null;
}

async function loadQuizForEdit(courseId) {
    if (!connectedWallet || !connectedSecret) return;

    try {
        const params = new URLSearchParams({
            teacher_thr: connectedWallet,
            auth_secret: connectedSecret,
            passphrase: connectedPassphrase
        });
        let quiz = null;
        const courseData = await apiGet(`/api/v1/courses/${courseId}?${params.toString()}`);
        if (courseData.course && courseData.course.quiz_full) {
            quiz = courseData.course.quiz_full;
        } else {
            const data = await apiPost(`/api/v1/courses/${courseId}/quiz/edit`, {
                teacher_thr: connectedWallet,
                auth_secret: connectedSecret,
                passphrase: connectedPassphrase
            });
            quiz = data.quiz;
        }
        if (!quiz || !quiz.questions) return;
        $("quizTitleInput").value = quiz.title || "";
        $("passingScore").value = quiz.passing_score || quiz.pass_score || 80;
        quiz.questions.forEach(q => {
            const normalizedType = normalizeQuestionType(q.type);
            const normalizedQuestion = {
                ...q,
                type: normalizedType,
                options: normalizedType === 'true_false'
                    ? ['False', 'True']
                    : (normalizedType === 'short_answer' ? [] : (q.options || ['', '', '', ''])),
                correct: normalizedType === 'multi_select'
                    ? (Array.isArray(q.correct) ? q.correct : [])
                    : (normalizedType === 'true_false' ? (q.correct === 1 ? 1 : 0) : (q.correct ?? 0)),
                correct_text: normalizedType === 'short_answer'
                    ? (Array.isArray(q.correct_text) ? q.correct_text.join(', ') : (q.correct_text || q.correct || ''))
                    : ''
            };
            addQuestion(normalizedQuestion);
        });
    } catch (e) {
        console.warn(`Failed to load quiz: ${e.message}`);
    }
}

// NOTE: QUESTION_TYPES, QUESTION_TYPE_LABELS and normalizeQuestionType are defined earlier in this file

function addQuestion(existing = null) {
    const idx = quizQuestions.length;
    const baseQuestion = {
        question: existing?.question || '',
        question_el: existing?.question_el || '',
        options: existing?.options || ['', '', '', ''],
        correct: existing?.correct ?? 0,
        correct_text: existing?.correct_text || '',
        type: normalizeQuestionType(existing?.type),
        explanation: existing?.explanation || '',
        explanation_el: existing?.explanation_el || ''
    };

    quizQuestions.push(baseQuestion);

    const questionText = escapeAttr(baseQuestion.question || '');
    const questionEl = escapeAttr(baseQuestion.question_el || '');
    const questionType = baseQuestion.type || 'multiple_choice';
    const explanationText = escapeAttr(baseQuestion.explanation || '');
    const explanationEl = escapeAttr(baseQuestion.explanation_el || '');

    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `question-${idx}`;
    div.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong>${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ·' : 'Question'} #${idx + 1}</strong>
            <button type="button" onclick="removeQuestion(${idx})" style="background: none; border: none; color: #ff6b6b; cursor: pointer;">âœ•</button>
        </div>
        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ· (Î‘Î³Î³Î»Î¹ÎºÎ¬)' : 'Question (English)'}"
               value="${questionText}" onchange="quizQuestions[${idx}].question = this.value" style="width: 100%; margin-bottom: 8px;">
        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ· (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)' : 'Question (Greek)'}"
               value="${questionEl}" onchange="quizQuestions[${idx}].question_el = this.value" style="width: 100%; margin-bottom: 15px;">
        <div style="margin-bottom:10px;">
            <label style="font-size:12px;opacity:0.8;">${currentLang === 'el' ? 'Î¤ÏÏ€Î¿Ï‚ ÎµÏÏÏ„Î·ÏƒÎ·Ï‚' : 'Question type'}</label>
            <select class="input-field" onchange="onQuestionTypeChange(${idx}, this.value)">
                ${Object.keys(QUESTION_TYPE_LABELS).map(t => `
                    <option value="${t}" ${questionType === t ? 'selected' : ''}>${QUESTION_TYPE_LABELS[t][currentLang] || QUESTION_TYPE_LABELS[t].en}</option>
                `).join('')}
            </select>
        </div>
        <div id="q-${idx}-fields"></div>
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0,255,102,0.2);">
            <label style="font-size:12px;opacity:0.8;">ğŸ’¡ ${currentLang === 'el' ? 'Î•Ï€ÎµÎ¾Î®Î³Î·ÏƒÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ - ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î¿Î½ Î¼Î±Î¸Î·Ï„Î® Î¼ÎµÏ„Î¬ Ï„Î·Î½ Ï…Ï€Î¿Î²Î¿Î»Î®)' : 'Answer explanation (optional - shown to student after submission)'}</label>
            <textarea class="input-field" placeholder="${currentLang === 'el' ? 'Î“Î¹Î±Ï„Î¯ Î±Ï…Ï„Î® ÎµÎ¯Î½Î±Î¹ Î· ÏƒÏ‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·...' : 'Why this is the correct answer...'}"
                   onchange="quizQuestions[${idx}].explanation = this.value" style="width: 100%; margin-top: 5px; min-height: 60px; resize: vertical;">${explanationText}</textarea>
            <textarea class="input-field" placeholder="${currentLang === 'el' ? 'Î•Ï€ÎµÎ¾Î®Î³Î·ÏƒÎ· (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)' : 'Explanation (Greek)'}"
                   onchange="quizQuestions[${idx}].explanation_el = this.value" style="width: 100%; margin-top: 5px; min-height: 60px; resize: vertical;">${explanationEl}</textarea>
        </div>
    `;

    $("questionsContainer").appendChild(div);
    renderQuestionFields(idx, questionType);
}

function removeQuestion(idx) {
    const el = $(`question-${idx}`);
    if (el) el.remove();
    quizQuestions[idx] = null;
}

function renderQuestionFields(idx, type) {
    const container = $(`q-${idx}-fields`);
    if (!container) return;
    const question = quizQuestions[idx] || {};
    const optionValues = (question.options || []).concat(['', '', '', '']).slice(0, 4);
    let html = '';

    if (type === 'multiple_choice') {
        html = `
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">${currentLang === 'el' ? 'Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ (ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î· ÏƒÏ‰ÏƒÏ„Î®)' : 'Options (select the correct one)'}:</div>
            ${[0,1,2,3].map(i => `
                <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                    <input type="radio" name="correct-${idx}" value="${i}" ${Number(question.correct ?? 0) === i ? 'checked' : ''} onchange="quizQuestions[${idx}].correct=${i}">
                    <input class="input-field" placeholder="Option ${i + 1}" value="${escapeAttr(optionValues[i] || '')}" onchange="quizQuestions[${idx}].options[${i}] = this.value" style="flex: 1;">
                </div>`).join('')}
        `;
        quizQuestions[idx].options = quizQuestions[idx].options || ['', '', '', ''];

    } else if (type === 'true_false') {
        const correctValue = Number(question.correct ?? 0);
        html = `
            <div style="display:flex;gap:10px;align-items:center;">
                <label><input type="radio" name="correct-${idx}" value="0" ${correctValue === 0 ? 'checked' : ''} onchange="quizQuestions[${idx}].correct=0"> ${currentLang === 'el' ? 'Î›Î¬Î¸Î¿Ï‚' : 'False'}</label>
                <label><input type="radio" name="correct-${idx}" value="1" ${correctValue === 1 ? 'checked' : ''} onchange="quizQuestions[${idx}].correct=1"> ${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„ÏŒ' : 'True'}</label>
            </div>`;

    } else if (type === 'multi_select') {
        const correctValues = Array.isArray(question.correct) ? question.correct : [];
        html = `
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">${currentLang === 'el' ? 'Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ (Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ ÏƒÏ‰ÏƒÏ„Î­Ï‚)' : 'Options (multiple correct)'}:</div>
            ${[0,1,2,3].map(i => `
                <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items:center;">
                    <input type="checkbox" value="${i}" ${correctValues.includes(i) ? 'checked' : ''} onchange="toggleMultiSelect(${idx}, ${i}, this.checked)">
                    <input class="input-field" placeholder="Option ${i + 1}" value="${escapeAttr(optionValues[i] || '')}" onchange="quizQuestions[${idx}].options[${i}] = this.value" style="flex: 1;">
                </div>`).join('')}
        `;
        quizQuestions[idx].options = quizQuestions[idx].options || ['', '', '', ''];
        quizQuestions[idx].correct = correctValues;

    } else if (type === 'short_answer') {
        const answerValue = escapeAttr(question.correct_text || '');
        html = `
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">
                ${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· (Î´Î¹Î±Ï‡Ï‰ÏÎ¯ÏƒÏ„Îµ Î¼Îµ ÎºÏŒÎ¼Î¼Î± Î³Î¹Î± Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚)' : 'Correct answer (comma-separated for multiple)'}:
            </div>
            <input class="input-field" placeholder="${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'Correct answer'}" value="${answerValue}" onchange="quizQuestions[${idx}].correct_text = this.value" style="width: 100%;">
        `;

    } else if (type === 'matching') {
        // Matching pairs: [[term, definition], ...]
        const pairs = question.pairs || [['', ''], ['', ''], ['', '']];
        quizQuestions[idx].pairs = pairs;
        html = `
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">
                ${currentLang === 'el' ? 'Î–ÎµÏ…Î³Î¬ÏÎ¹Î± (ÏŒÏÎ¿Ï‚ â†’ Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚)' : 'Pairs (term â†’ definition)'}:
            </div>
            <div id="pairs-${idx}">
                ${pairs.map((p, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;" class="pair-row">
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'ÎŒÏÎ¿Ï‚' : 'Term'} ${i+1}" value="${escapeAttr(p[0] || '')}"
                               onchange="quizQuestions[${idx}].pairs[${i}][0] = this.value" style="flex: 1;">
                        <span style="color: #0f6;">â†’</span>
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚' : 'Definition'} ${i+1}" value="${escapeAttr(p[1] || '')}"
                               onchange="quizQuestions[${idx}].pairs[${i}][1] = this.value" style="flex: 1;">
                        <button type="button" onclick="removePair(${idx}, ${i})" style="background:none;border:none;color:#ff6b6b;cursor:pointer;">âœ•</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" onclick="addPair(${idx})" class="btn-secondary" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;">
                â• ${currentLang === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¶ÎµÏ…Î³Î±ÏÎ¹Î¿Ï' : 'Add pair'}
            </button>
        `;

    } else if (type === 'ordering') {
        // Items to order: [item1, item2, ...]
        const items = question.items || question.options || ['', '', ''];
        quizQuestions[idx].items = items;
        html = `
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">
                ${currentLang === 'el' ? 'Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± (ÏƒÏ„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬)' : 'Items (in correct order)'}:
            </div>
            <div id="order-items-${idx}">
                ${items.map((item, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;" class="order-row">
                        <span style="color: #888; min-width: 25px;">${i+1}.</span>
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î¿' : 'Item'} ${i+1}" value="${escapeAttr(item || '')}"
                               onchange="quizQuestions[${idx}].items[${i}] = this.value" style="flex: 1;">
                        <button type="button" onclick="removeOrderItem(${idx}, ${i})" style="background:none;border:none;color:#ff6b6b;cursor:pointer;">âœ•</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" onclick="addOrderItem(${idx})" class="btn-secondary" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;">
                â• ${currentLang === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿Ï…' : 'Add item'}
            </button>
            <div style="font-size: 0.85em; color: #888; margin-top: 8px;">
                ğŸ’¡ ${currentLang === 'el' ? 'Î¤Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î¸Î± Î±Î½Î±ÎºÎ±Ï„ÎµÏ…Ï„Î¿ÏÎ½ Î³Î¹Î± Ï„Î¿Î½ Î¼Î±Î¸Î·Ï„Î®' : 'Items will be shuffled for the student'}
            </div>
        `;

    } else if (type === 'fill_blank') {
        // Text with blanks and answers
        const textWithBlanks = question.text_with_blanks || '';
        const blanks = question.blanks || [{ answer: '' }];
        quizQuestions[idx].text_with_blanks = textWithBlanks;
        quizQuestions[idx].blanks = blanks;
        html = `
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">
                ${currentLang === 'el' ? 'ÎšÎµÎ¯Î¼ÎµÎ½Î¿ (Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ ___ Î³Î¹Î± ÎºÎµÎ½Î¬)' : 'Text (use ___ for blanks)'}:
            </div>
            <textarea class="input-field" placeholder="${currentLang === 'el' ? 'Î— ___ ÎµÎ¯Î½Î±Î¹ Î· Ï€ÏÏ‰Ï„ÎµÏÎ¿Ï…ÏƒÎ± Ï„Î·Ï‚ ___.' : 'The ___ is the capital of ___.'}"
                      style="width: 100%; min-height: 60px; margin-bottom: 12px;"
                      onchange="quizQuestions[${idx}].text_with_blanks = this.value; updateBlankFields(${idx})">${escapeAttr(textWithBlanks)}</textarea>
            <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">
                ${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î­Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ ÎºÎµÎ½ÏŒ' : 'Correct answers for each blank'}:
            </div>
            <div id="blanks-${idx}">
                ${blanks.map((b, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <span style="color: #0f6; min-width: 60px;">${currentLang === 'el' ? 'ÎšÎµÎ½ÏŒ' : 'Blank'} ${i+1}:</span>
                        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'Correct answer'}"
                               value="${escapeAttr(typeof b === 'object' ? b.answer || '' : b)}"
                               onchange="quizQuestions[${idx}].blanks[${i}] = {answer: this.value}" style="flex: 1;">
                    </div>
                `).join('')}
            </div>
            <div style="font-size: 0.85em; color: #888; margin-top: 8px;">
                ğŸ’¡ ${currentLang === 'el' ? 'Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ ___ (3 ÎºÎ¬Ï„Ï‰ Ï€Î±ÏÎ»ÎµÏ‚) Î³Î¹Î± ÎºÎ¬Î¸Îµ ÎºÎµÎ½ÏŒ' : 'Use ___ (3 underscores) for each blank'}
            </div>
        `;
    }

    container.innerHTML = html;
    quizQuestions[idx].type = type;
}

// Helper functions for matching pairs
function addPair(idx) {
    const question = quizQuestions[idx];
    if (!question) return;
    question.pairs = question.pairs || [];
    question.pairs.push(['', '']);
    renderQuestionFields(idx, 'matching');
}

function removePair(idx, pairIdx) {
    const question = quizQuestions[idx];
    if (!question || !question.pairs) return;
    question.pairs.splice(pairIdx, 1);
    if (question.pairs.length === 0) question.pairs.push(['', '']);
    renderQuestionFields(idx, 'matching');
}

// Helper functions for ordering items
function addOrderItem(idx) {
    const question = quizQuestions[idx];
    if (!question) return;
    question.items = question.items || [];
    question.items.push('');
    renderQuestionFields(idx, 'ordering');
}

function removeOrderItem(idx, itemIdx) {
    const question = quizQuestions[idx];
    if (!question || !question.items) return;
    question.items.splice(itemIdx, 1);
    if (question.items.length === 0) question.items.push('');
    renderQuestionFields(idx, 'ordering');
}

// Helper function to update blank fields when text changes
function updateBlankFields(idx) {
    const question = quizQuestions[idx];
    if (!question) return;
    const text = question.text_with_blanks || '';
    const blankCount = (text.match(/___/g) || []).length;
    const currentBlanks = question.blanks || [];
    // Adjust blanks array to match count
    while (currentBlanks.length < blankCount) {
        currentBlanks.push({ answer: '' });
    }
    while (currentBlanks.length > blankCount && currentBlanks.length > 1) {
        currentBlanks.pop();
    }
    question.blanks = currentBlanks;
    renderQuestionFields(idx, 'fill_blank');
}

function onQuestionTypeChange(idx, type) {
    const normalized = normalizeQuestionType(type);
    const q = quizQuestions[idx];

    if (normalized === 'true_false') {
        q.options = ['False', 'True'];
        q.correct = 0;
        q.correct_text = '';
    } else if (normalized === 'multi_select') {
        q.options = (q.options || ['', '', '', '']).concat(['', '', '', '']).slice(0, 4);
        q.correct = [];
        q.correct_text = '';
    } else if (normalized === 'short_answer') {
        q.options = [];
        q.correct = 0;
        q.correct_text = q.correct_text || '';
    } else if (normalized === 'matching') {
        q.pairs = q.pairs || [['', ''], ['', ''], ['', '']];
        q.options = [];
        q.correct = null;
    } else if (normalized === 'ordering') {
        q.items = q.items || q.options || ['', '', ''];
        q.correct_order = null; // Will be calculated from items order
        q.options = [];
    } else if (normalized === 'fill_blank') {
        q.text_with_blanks = q.text_with_blanks || '';
        q.blanks = q.blanks || [{ answer: '' }];
        q.options = [];
    } else {
        // multiple_choice
        q.options = (q.options || ['', '', '', '']).concat(['', '', '', '']).slice(0, 4);
        q.correct = Number(q.correct ?? 0);
        q.correct_text = '';
    }
    renderQuestionFields(idx, normalized);
}

function toggleMultiSelect(idx, optionIndex, isChecked) {
    const question = quizQuestions[idx];
    if (!question) return;
    const current = Array.isArray(question.correct) ? question.correct : [];
    const next = isChecked
        ? Array.from(new Set([...current, optionIndex]))
        : current.filter(value => value !== optionIndex);
    question.correct = next;
}

async function saveQuiz() {
    if (!connectedWallet || !connectedSecret) {
        alert(currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚' : 'Please connect your wallet');
        return;
    }

    const validationErrors = [];
    const validQuestions = quizQuestions.filter(q => q && q.question).map((q, idx) => {
        const qType = normalizeQuestionType(q.type);

        if (qType === 'multiple_choice') {
            const options = (q.options || []).concat(['', '', '', '']).slice(0, 4);
            if (!options.every(o => o)) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚' : 'fill all options'}`);
            }
            const correctIndex = Number(q.correct ?? 0);
            if (Number.isNaN(correctIndex) || correctIndex < 0 || correctIndex >= options.length) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'Î»Î¬Î¸Î¿Ï‚ ÏƒÏ‰ÏƒÏ„Î® ÎµÏ€Î¹Î»Î¿Î³Î®' : 'invalid correct option'}`);
            }
        } else if (qType === 'multi_select') {
            const options = (q.options || []).concat(['', '', '', '']).slice(0, 4);
            const correctValues = Array.isArray(q.correct) ? q.correct : [];
            if (!options.every(o => o)) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚' : 'fill all options'}`);
            }
            if (correctValues.length === 0) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'ÎµÏ€Î¯Î»ÎµÎ¾Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± ÏƒÏ‰ÏƒÏ„Î®' : 'select at least one correct option'}`);
            }
        } else if (qType === 'true_false') {
            if (q.correct !== 0 && q.correct !== 1) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'ÎµÏ€Î­Î»ÎµÎ¾Îµ ÏƒÏ‰ÏƒÏ„ÏŒ True/False' : 'select correct True/False'}`);
            }
        } else if (qType === 'short_answer') {
            const correctText = (q.correct_text || '').trim();
            if (!correctText) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'Î³ÏÎ¬ÏˆÎµ ÏƒÏ‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·' : 'enter correct answer'}`);
            }
        } else if (qType === 'matching') {
            const pairs = q.pairs || [];
            if (pairs.length < 2) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 2 Î¶ÎµÏ…Î³Î¬ÏÎ¹Î±' : 'need at least 2 pairs'}`);
            }
            pairs.forEach((p, i) => {
                if (!p[0] || !p[1]) {
                    validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? `ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î¶ÎµÏ…Î³Î¬ÏÎ¹ ${i+1}` : `fill pair ${i+1}`}`);
                }
            });
        } else if (qType === 'ordering') {
            const items = q.items || [];
            if (items.length < 2) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 2 ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±' : 'need at least 2 items'}`);
            }
            items.forEach((item, i) => {
                if (!item || !item.trim()) {
                    validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? `ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿ ${i+1}` : `fill item ${i+1}`}`);
                }
            });
        } else if (qType === 'fill_blank') {
            const text = q.text_with_blanks || '';
            const blanks = q.blanks || [];
            const blankCount = (text.match(/___/g) || []).length;
            if (!text || blankCount === 0) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 ÎºÎµÎ½ÏŒ (___)' : 'text must have at least 1 blank (___)'}`);
            }
            if (blanks.length !== blankCount) {
                validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? 'Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹ Î¼Îµ ÎºÎµÎ½Î¬' : 'answers count doesn\'t match blanks'}`);
            }
            blanks.forEach((b, i) => {
                const answer = typeof b === 'object' ? b.answer : b;
                if (!answer || !answer.trim()) {
                    validationErrors.push(`#${idx + 1}: ${currentLang === 'el' ? `ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÎºÎµÎ½Î¿Ï ${i+1}` : `fill blank ${i+1} answer`}`);
                }
            });
        }

        return { ...q, type: qType };
    });

    if (validQuestions.length === 0 || validationErrors.length > 0) {
        if (validationErrors.length > 0) {
            alert(validationErrors.join('\n'));
            return;
        }
        alert(currentLang === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± ÎµÏÏÏ„Î·ÏƒÎ·' : 'Please add at least one question');
        return;
    }

    try {
        const result = await apiPost(`/api/v1/courses/${currentQuizCourseId}/quiz`, {
            teacher_thr: connectedWallet,
            auth_secret: connectedSecret,
            passphrase: connectedPassphrase,
            title: $("quizTitleInput").value || "Course Quiz",
            passing_score: parseInt($("passingScore").value) || 80,
            questions: validQuestions
        });

        if (result.status === "success") {
            alert(currentLang === 'el' ? 'Quiz Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!' : 'Quiz saved successfully!');
            closeCreateQuizModal();
            await refresh();
        } else {
            alert(`Error: ${result.message}`);
        }
    } catch (e) {
        alert(`Error saving quiz: ${e.message}`);
    }
}

// Utility
// Helper function for ordering questions - move item up/down
function moveOrderItem(qid, item, direction) {
    const container = document.querySelector(`#ordering-${qid}`);
    if (!container || !item) return;

    const items = Array.from(container.querySelectorAll('.ordering-item'));
    const currentIndex = items.indexOf(item);
    const newIndex = currentIndex + direction;

    if (newIndex < 0 || newIndex >= items.length) return;

    if (direction === -1 && items[currentIndex - 1]) {
        container.insertBefore(item, items[currentIndex - 1]);
    } else if (direction === 1 && items[currentIndex + 1]) {
        container.insertBefore(items[currentIndex + 1], item);
    }

    // Update order numbers
    container.querySelectorAll('.ordering-item').forEach((el, i) => {
        const numEl = el.querySelector('.order-number');
        if (numEl) numEl.textContent = `${i + 1}.`;
    });
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function escapeAttr(str) {
    return escapeHtml(str).replace(/"/g, '&quot;');
}

// Auto-refresh
$("refresh").onclick = refresh;

// Initial load
syncWalletFromSession(false);
refresh().catch(e => log(`Initial load error: ${e.message}`, true));
</script>
{% endblock %}
