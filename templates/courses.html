{% extends "base.html" %}
{% block title %}ğŸ“ Thronos Learnâ€‘toâ€‘Earn{% endblock %}

{% block styles %}
<style>
    .l2e-container {
        max-width: 1200px;
        margin: 30px auto;
        color: #d7ffe6;
    }
    .l2e-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #07120b 0%, #0a1f14 100%);
        border: 1px solid #1a5a2f;
        border-radius: 16px;
    }
    .l2e-header h1 {
        color: #3CFF7A;
        letter-spacing: 3px;
        font-size: 2.5em;
        margin: 0 0 10px 0;
        text-shadow: 0 0 20px rgba(60, 255, 122, 0.3);
    }
    .l2e-header p {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px 0;
    }
    .l2e-stats {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    .stat-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px 25px;
        border-radius: 10px;
        border: 1px solid #1a5a2f;
    }
    .stat-box .label {
        font-size: 0.9em;
        opacity: 0.7;
        margin-bottom: 5px;
    }
    .stat-box .value {
        font-size: 1.8em;
        font-weight: bold;
        color: #3CFF7A;
    }
    .l2e-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    @media (max-width: 768px) {
        .l2e-grid { grid-template-columns: 1fr; }
    }
    .panel {
        background: #07120b;
        border: 1px solid #1a5a2f;
        border-radius: 14px;
        padding: 20px;
    }
    .panel h3 {
        margin-top: 0;
        color: #3CFF7A;
        border-bottom: 1px solid #1a5a2f;
        padding-bottom: 10px;
    }
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    .input-field {
        flex: 1;
        min-width: 200px;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #1a5a2f;
        background: #050b07;
        color: #d7ffe6;
        font-family: monospace;
    }
    .input-field:focus {
        outline: none;
        border-color: #3CFF7A;
        box-shadow: 0 0 0 2px rgba(60, 255, 122, 0.1);
    }
    .btn-primary {
        padding: 12px 20px;
        border-radius: 10px;
        border: 1px solid #3CFF7A;
        background: #06140b;
        color: #3CFF7A;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    }
    .btn-primary:hover {
        background: #3CFF7A;
        color: #000;
        box-shadow: 0 0 15px rgba(60, 255, 122, 0.4);
    }
    .btn-secondary {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px solid #1a5a2f;
        background: #06140b;
        color: #d7ffe6;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-secondary:hover {
        border-color: #3CFF7A;
        background: rgba(60, 255, 122, 0.1);
    }
    .btn-quiz {
        background: #1a3a5f;
        border-color: #5C9FFF;
        color: #5C9FFF;
    }
    .btn-quiz:hover {
        background: #5C9FFF;
        color: #000;
    }
    .course-card {
        border: 1px solid #123a22;
        border-radius: 12px;
        padding: 16px;
        background: #050b07;
        margin-bottom: 12px;
        transition: all 0.3s;
    }
    .course-card:hover {
        border-color: #3CFF7A;
        box-shadow: 0 0 20px rgba(60, 255, 122, 0.15);
        transform: translateY(-2px);
    }
    .course-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 12px;
    }
    .course-title {
        font-weight: 700;
        font-size: 1.2em;
        color: #d7ffe6;
        margin-bottom: 8px;
    }
    .course-meta {
        opacity: 0.85;
        font-size: 13px;
        margin: 4px 0;
    }
    .course-meta code {
        background: rgba(60, 255, 122, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        color: #3CFF7A;
    }
    .course-stats {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #123a22;
        font-size: 12px;
        opacity: 0.75;
    }
    .course-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 140px;
    }
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        margin-left: 8px;
    }
    .badge-enrolled { background: rgba(60, 255, 122, 0.2); color: #3CFF7A; border: 1px solid #3CFF7A; }
    .badge-completed { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid #ffd700; }
    .badge-quiz-passed { background: rgba(92, 159, 255, 0.2); color: #5C9FFF; border: 1px solid #5C9FFF; }
    .badge-has-quiz { background: rgba(255, 165, 0, 0.2); color: #ffa500; border: 1px solid #ffa500; }
    .log-box {
        white-space: pre-wrap;
        margin-top: 12px;
        background: #050b07;
        border: 1px solid #123a22;
        border-radius: 12px;
        padding: 12px;
        min-height: 100px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    .empty-state { text-align: center; padding: 40px; opacity: 0.6; }
    .loading { text-align: center; padding: 20px; color: #3CFF7A; }
    .error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        margin-top: 10px;
    }
    /* Quiz Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
    }
    .modal.active { display: flex; align-items: flex-start; justify-content: center; }
    .modal-content {
        background: #07120b;
        border: 1px solid #1a5a2f;
        border-radius: 16px;
        padding: 30px;
        max-width: 700px;
        width: 100%;
        margin: 20px auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #1a5a2f;
    }
    .modal-header h2 { margin: 0; color: #3CFF7A; }
    .modal-close {
        background: none;
        border: none;
        color: #ff6b6b;
        font-size: 24px;
        cursor: pointer;
    }
    .question-card {
        background: #050b07;
        border: 1px solid #1a5a2f;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
    }
    .question-text {
        font-size: 1.1em;
        margin-bottom: 15px;
        color: #d7ffe6;
    }
    .question-number {
        color: #3CFF7A;
        font-weight: bold;
        margin-right: 10px;
    }
    .option-label {
        display: block;
        padding: 12px 15px;
        margin: 8px 0;
        background: #06140b;
        border: 1px solid #1a5a2f;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .option-label:hover { border-color: #3CFF7A; background: rgba(60, 255, 122, 0.05); }
    .option-label input { margin-right: 10px; }
    .option-label.correct { background: rgba(60, 255, 122, 0.2); border-color: #3CFF7A; }
    .option-label.incorrect { background: rgba(255, 107, 107, 0.2); border-color: #ff6b6b; }
    .quiz-result {
        text-align: center;
        padding: 30px;
        background: #050b07;
        border-radius: 12px;
        margin-top: 20px;
    }
    .quiz-score {
        font-size: 3em;
        font-weight: bold;
        margin: 10px 0;
    }
    .quiz-score.passed { color: #3CFF7A; }
    .quiz-score.failed { color: #ff6b6b; }
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .tab-btn {
        padding: 10px 20px;
        border: 1px solid #1a5a2f;
        background: #050b07;
        color: #d7ffe6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-btn.active { background: #3CFF7A; color: #000; border-color: #3CFF7A; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="l2e-container">
    <!-- Header Section -->
    <div class="l2e-header">
        <h1>ğŸ“ LEARNâ€‘TOâ€‘EARN</h1>
        <p>
            <span class="lang-el">ÎœÎ¬Î¸Îµ, Ï€Î»Î®ÏÏ‰ÏƒÎµ Î¼Îµ THR, Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµ Ï„Î¿ quiz, ÎºÎ­ÏÎ´Î¹ÏƒÎµ L2E tokens</span>
            <span class="lang-en">Learn, pay with THR, complete the quiz, earn L2E tokens</span>
        </p>
        <div class="l2e-stats">
            <div class="stat-box">
                <div class="label"><span class="lang-el">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</span><span class="lang-en">Total Courses</span></div>
                <div class="value" id="totalCourses">0</div>
            </div>
            <div class="stat-box">
                <div class="label"><span class="lang-el">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¿Î¯ ÎœÎ±Î¸Î·Ï„Î­Ï‚</span><span class="lang-en">Total Students</span></div>
                <div class="value" id="totalStudents">0</div>
            </div>
            <div class="stat-box">
                <div class="label"><span class="lang-el">L2E Î”Î¹Î±Î½ÎµÎ¼Î·Î¼Î­Î½Î±</span><span class="lang-en">L2E Distributed</span></div>
                <div class="value" id="totalL2E">0</div>
            </div>
        </div>
    </div>

    <!-- Wallet Connection -->
    <div class="panel" style="margin-bottom: 20px;">
        <h3>ğŸ” <span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ· Î Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï</span><span class="lang-en">Wallet Connection</span></h3>
        <div class="input-group">
            <input id="wallet" class="input-field" placeholder="THR wallet address" readonly />
            <button id="connectBtn" class="btn-primary">
                <span class="lang-el">Î§ÏÎ®ÏƒÎ· Wallet Widget</span><span class="lang-en">Use Wallet Widget</span>
            </button>
        </div>
        <div id="walletStatus" style="margin-top: 10px; display: none;">
            <span style="color: #3CFF7A;">âœ“ <span class="lang-el">Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿</span><span class="lang-en">Connected</span>:</span>
            <code id="connectedWallet"></code>
            <span style="margin-left: 15px;">L2E: <strong id="l2eBalance">0</strong></span>
        </div>
        <div id="walletWarning" style="margin-top: 10px; color: #ff6b6b; display: none;">
            <span class="lang-el">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï… Î±Ï€ÏŒ Ï„Î¿ widget Ï€Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï ÏƒÏ„Î¿ header.</span>
            <span class="lang-en">Connect via the header wallet widget.</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('courses')">
            ğŸ“š <span class="lang-el">ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</span><span class="lang-en">Courses</span>
        </button>
        <button class="tab-btn" onclick="showTab('create')">
            â• <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</span><span class="lang-en">Create</span>
        </button>
        <button class="tab-btn" onclick="showTab('my-courses')">
            ğŸ“– <span class="lang-el">Î¤Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¬ Î¼Î¿Ï…</span><span class="lang-en">My Courses</span>
        </button>
    </div>

    <!-- Courses Tab -->
    <div id="courses-tab" class="tab-content active">
        <div class="panel">
            <h3>ğŸ“š <span class="lang-el">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î±</span><span class="lang-en">Available Courses</span></h3>
            <button id="refresh" class="btn-secondary" style="width: 100%; margin-bottom: 15px;">
                ğŸ”„ <span class="lang-el">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</span><span class="lang-en">Refresh</span>
            </button>
            <div id="courses"></div>
        </div>
    </div>

    <!-- Create Course Tab -->
    <div id="create-tab" class="tab-content">
        <div class="panel">
            <h3>â• <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚ (Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î­Ï‚)</span><span class="lang-en">Create Course (Teachers Only)</span></h3>
            <input id="title" class="input-field" placeholder="Course Title" style="width: 100%; margin-bottom: 10px;" />
            <input id="titleEl" class="input-field" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚ ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚ (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)" style="width: 100%; margin-bottom: 10px;" />
            <input id="description" class="input-field" placeholder="Description (optional)" style="width: 100%; margin-bottom:10px;" />
            <div class="input-group">
                <input id="price" class="input-field" type="number" step="0.1" placeholder="Price in THR" />
                <input id="reward" class="input-field" type="number" step="0.1" placeholder="L2E Reward" />
            </div>
            <div style="margin: 15px 0; padding: 12px; border:1px solid #1a5a2f; border-radius: 10px;">
                <h4 style="margin-top:0;">ğŸ“‚ Course Content</h4>
                <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                    <label><input type="radio" name="contentType" value="pdf" checked> PDF Slides</label>
                    <label><input type="radio" name="contentType" value="video"> Video</label>
                    <label><input type="radio" name="contentType" value="external"> External Link</label>
                </div>
                <div id="pdfFields">
                    <input id="slidesFile" type="file" accept="application/pdf" style="width:100%; margin-bottom:10px;" />
                    <small style="opacity:0.8;">Upload slides as a PDF (saved under courses/&lt;course_id&gt;/slides.pdf).</small>
                </div>
                <div id="videoFields" style="display:none;">
                    <input id="videoUrl" class="input-field" placeholder="YouTube or MP4 URL" style="width:100%;" />
                </div>
                <div id="externalFields" style="display:none;">
                    <input id="contentUrl" class="input-field" placeholder="Content URL" style="width:100%;" />
                </div>
            </div>
            <div style="margin: 15px 0; padding: 12px; border:1px solid #1a5a2f; border-radius: 10px;">
                <h4 style="margin-top:0;">ğŸ§© Quiz Builder</h4>
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <label for="builderPassScore" style="white-space:nowrap;">Pass score (%)</label>
                    <input id="builderPassScore" class="input-field" type="number" value="70" style="width:100px;" />
                </div>
                <div id="builderQuestions"></div>
                <button type="button" class="btn-secondary" style="width:100%; margin-top:10px;" onclick="addBuilderQuestion()">â• Add Question</button>
            </div>
            <button id="create" class="btn-primary" style="width: 100%;">
                <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚</span><span class="lang-en">Create Course</span>
            </button>
            <div class="log-box" id="log"><span class="lang-el">ÎˆÏ„Î¿Î¹Î¼Î¿ Î³Î¹Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î±Î¸Î·Î¼Î¬Ï„Ï‰Î½...</span><span class="lang-en">Ready to create courses...</span></div>
        </div>
    </div>
    <!-- My Courses Tab -->
    <div id="my-courses-tab" class="tab-content">
        <div class="panel">
            <h3>ğŸ“– <span class="lang-el">Î¤Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¬ Î¼Î¿Ï…</span><span class="lang-en">My Courses</span></h3>
            <div id="my-courses-list"></div>
        </div>
    </div>
</div>

<!-- Quiz Modal -->
<div id="quizModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="quizTitle">ğŸ“ Quiz</h2>
            <button class="modal-close" onclick="closeQuizModal()">Ã—</button>
        </div>
        <div id="quizContent"></div>
        <div id="quizActions" style="margin-top: 20px; text-align: center;">
            <button id="submitQuizBtn" class="btn-primary" onclick="submitQuiz()" style="min-width: 200px;">
                <span class="lang-el">Î¥Ï€Î¿Î²Î¿Î»Î® Î‘Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½</span><span class="lang-en">Submit Answers</span>
            </button>
        </div>
    </div>
</div>

<!-- Create Quiz Modal -->
<div id="createQuizModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“ <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Quiz</span><span class="lang-en">Create Quiz</span></h2>
            <button class="modal-close" onclick="closeCreateQuizModal()">Ã—</button>
        </div>
        <div id="createQuizForm">
            <input id="quizTitleInput" class="input-field" placeholder="Quiz Title" style="width: 100%; margin-bottom: 10px;" />
            <input id="passingScore" class="input-field" type="number" value="80" placeholder="Passing Score (%)" style="width: 100%; margin-bottom: 20px;" />

            <h4><span class="lang-el">Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚</span><span class="lang-en">Questions</span></h4>
            <div id="questionsContainer"></div>

            <button class="btn-secondary" style="width: 100%; margin: 10px 0;" onclick="addQuestion()">
                â• <span class="lang-el">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•ÏÏÏ„Î·ÏƒÎ·Ï‚</span><span class="lang-en">Add Question</span>
            </button>

            <button class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="saveQuiz()">
                ğŸ’¾ <span class="lang-el">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Quiz</span><span class="lang-en">Save Quiz</span>
            </button>
        </div>
    </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
let connectedWallet = null;
let connectedSecret = null;
let connectedPassphrase = null;
let currentQuizCourseId = null;
let currentQuizQuestions = [];
let currentLang = localStorage.getItem('lang') || 'en';
let builderQuestionCounter = 0;

// API Helpers
async function apiGet(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
}

async function apiPost(url, body) {
    const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
}

// Logging
function log(message, isError = false) {
    const logBox = $("log");
    const timestamp = new Date().toLocaleTimeString();
    const prefix = isError ? "âŒ" : "âœ“";
    logBox.textContent = `[${timestamp}] ${prefix} ${message}\n\n${logBox.textContent}`;
    logBox.style.color = isError ? "#ff6b6b" : "#d7ffe6";
}

function toggleContentFields() {
    const type = (document.querySelector('input[name="contentType"]:checked') || {}).value || 'pdf';
    $("pdfFields").style.display = type === 'pdf' ? 'block' : 'none';
    $("videoFields").style.display = type === 'video' ? 'block' : 'none';
    $("externalFields").style.display = type === 'external' ? 'block' : 'none';
}

function addBuilderQuestion() {
    builderQuestionCounter += 1;
    const idx = builderQuestionCounter;
    const wrapper = document.createElement('div');
    wrapper.className = 'question-card builder-question';
    wrapper.dataset.qid = idx;
    wrapper.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Question #${idx}</strong>
            <button type="button" onclick="this.closest('.builder-question').remove();" style="background:none;border:none;color:#ff6b6b;cursor:pointer;">âœ•</button>
        </div>
        <input class="input-field question-text" placeholder="Question text" style="width:100%; margin:8px 0;" />
        ${['A','B','C','D'].map((label,i)=>`
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
                <input type="radio" name="correct-${idx}" value="${i}" ${i===0?'checked':''}>
                <input class="input-field option-input" placeholder="Option ${label}" style="flex:1;" />
            </div>
        `).join('')}
    `;
    $("builderQuestions").appendChild(wrapper);
}

function collectQuizBuilder() {
    const passScore = parseInt($("builderPassScore").value || '70');
    const questions = [];
    document.querySelectorAll('.builder-question').forEach((el) => {
        const text = el.querySelector('.question-text').value.trim();
        const options = Array.from(el.querySelectorAll('.option-input')).map(i => i.value.trim());
        const qid = el.dataset.qid;
        const correctRadio = el.querySelector(`input[name="correct-${qid}"]:checked`);
        const correctIndex = correctRadio ? parseInt(correctRadio.value) : 0;
        if (text && options.every(Boolean)) {
            questions.push({ id: questions.length + 1, text, options, correct_index: correctIndex });
        }
    });
    return {
        pass_score: isNaN(passScore) ? 70 : passScore,
        questions
    };
}

// Tab switching
function showTab(name) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    $(name + '-tab').classList.add('active');
    event.target.classList.add('active');
    if (name === 'my-courses') loadMyCourses();
}

function syncWalletFromSession(showToast = true) {
    const addr = (window.walletSession?.getAddress && window.walletSession.getAddress()) || '';
    const secret = (window.walletSession?.getSendSecret && window.walletSession.getSendSecret()) || '';
    if (!addr || !secret) {
        $("walletWarning").style.display = "block";
        $("walletStatus").style.display = "none";
        if (showToast) log("Please connect via wallet widget", true);
        return false;
    }

    connectedWallet = addr;
    connectedSecret = secret;
    connectedPassphrase = '';
    $("wallet").value = addr;
    $("walletStatus").style.display = "block";
    $("walletWarning").style.display = "none";
    $("connectedWallet").textContent = addr.substring(0, 12) + '...';

    apiGet(`/api/v1/l2e/balance/${addr}`).then(data => {
        $("l2eBalance").textContent = data.l2e_balance || data.balance || 0;
    }).catch(e => log(`Failed to load L2E balance: ${e.message}`, true));

    if (showToast) log(`Connected wallet: ${addr}`);
    refresh();
    return true;
}

// Connect Wallet
$("connectBtn").onclick = () => syncWalletFromSession(true);

// Create Course Card
function courseCard(c) {
    const el = document.createElement("div");
    el.className = "course-card";

    const isEnrolled = connectedWallet && (c.students || []).includes(connectedWallet);
    const isCompleted = connectedWallet && (c.completed || []).includes(connectedWallet);
    const isQuizPassed = connectedWallet && (c.quiz_passed || []).includes(connectedWallet);
    const isTeacher = connectedWallet && c.teacher === connectedWallet;
    const hasQuiz = c.has_quiz;

    let badges = "";
    if (isEnrolled) badges += `<span class="badge badge-enrolled">${currentLang === 'el' ? 'Î•Î³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î¿Ï‚' : 'Enrolled'}</span>`;
    if (isQuizPassed) badges += `<span class="badge badge-quiz-passed">${currentLang === 'el' ? 'Quiz âœ“' : 'Quiz âœ“'}</span>`;
    if (isCompleted) badges += `<span class="badge badge-completed">${currentLang === 'el' ? 'ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ' : 'Completed'}</span>`;
    if (hasQuiz) badges += `<span class="badge badge-has-quiz">ğŸ“ Quiz</span>`;

    el.innerHTML = `
        <div class="course-header">
            <div style="flex: 1;">
                <div class="course-title">${escapeHtml(c.title)}${badges}</div>
                <div class="course-meta">ğŸ‘¨â€ğŸ« ${currentLang === 'el' ? 'Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î®Ï‚' : 'Teacher'}: <code>${escapeHtml(c.teacher.substring(0, 12))}...</code></div>
                <div class="course-meta">ğŸ’° ${currentLang === 'el' ? 'Î¤Î¹Î¼Î®' : 'Price'}: <strong>${c.price_thr}</strong> THR Â· ğŸ ${currentLang === 'el' ? 'Î‘Î½Ï„Î±Î¼Î¿Î¹Î²Î®' : 'Reward'}: <strong>${c.reward_l2e}</strong> L2E</div>
                <div class="course-stats">
                    <span>ğŸ‘¥ ${(c.students || []).length} ${currentLang === 'el' ? 'Î¼Î±Î¸Î·Ï„Î­Ï‚' : 'students'}</span>
                    <span>âœ… ${(c.completed || []).length} ${currentLang === 'el' ? 'Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ±Î½' : 'completed'}</span>
                </div>
            </div>
            <div class="course-actions">
                ${isEnrolled ? `
                    <a class="btn-primary" href="/courses/${c.id}?student=${connectedWallet || ''}">
                        ğŸš€ ${currentLang === 'el' ? 'Î†Î½Î¿Î¹Î³Î¼Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¿Ï‚' : 'Open course'}
                    </a>
                ` : `
                    <button class="btn-enroll btn-primary" ${!connectedWallet ? 'disabled' : ''}>
                        ğŸ“ ${currentLang === 'el' ? 'Î•Î³Î³ÏÎ±Ï†Î®' : 'Enroll'}
                    </button>
                `}
                ${hasQuiz && isEnrolled && !isCompleted ? `
                    <button class="btn-quiz btn-secondary" onclick="openQuiz('${c.id}')">
                        ğŸ“ ${isQuizPassed ? (currentLang === 'el' ? 'Î•Ï€Î±Î½ÎµÎ¾Î­Ï„Î±ÏƒÎ·' : 'Retake Quiz') : (currentLang === 'el' ? 'ÎšÎ¬Î½Îµ Quiz' : 'Take Quiz')}
                    </button>
                ` : ''}
                ${isTeacher ? `
                    <button class="btn-secondary" onclick="openCreateQuiz('${c.id}')">
                        âš™ï¸ ${currentLang === 'el' ? 'Quiz Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚' : 'Quiz Settings'}
                    </button>
                    <button class="btn-complete btn-secondary">
                        âœ… ${currentLang === 'el' ? 'ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·' : 'Complete'}
                    </button>
                ` : ''}
            </div>
        </div>
    `;

    // Enroll button
    const enrollBtn = el.querySelector(".btn-enroll");
    if (enrollBtn) {
        enrollBtn.onclick = async () => {
            if (!connectedWallet || !connectedSecret) {
                log("Please connect wallet first", true);
                return;
            }

            try {
                log(`Enrolling in "${c.title}"...`);
                const result = await apiPost(`/api/v1/courses/${c.id}/enroll`, {
                    student_thr: connectedWallet,
                    auth_secret: connectedSecret,
                    passphrase: connectedPassphrase
                });

                if (result.status === "success") {
                    log(`Successfully enrolled in "${c.title}"! TX: ${result.tx.tx_id}`);
                    await refresh();
                } else {
                    log(`Enrollment failed: ${result.message || 'Unknown error'}`, true);
                }
            } catch (e) {
                log(`Enrollment error: ${e.message}`, true);
            }
        };
    }

    // Complete button (for teachers)
    const completeBtn = el.querySelector(".btn-complete");
    if (completeBtn) {
        completeBtn.onclick = async () => {
            const studentAddr = prompt(currentLang === 'el' ? "Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ THR Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¼Î±Î¸Î·Ï„Î®:" : "Enter student's THR address:");
            if (!studentAddr) return;

            try {
                log(`Marking student ${studentAddr} as completed...`);
                const result = await apiPost(`/api/v1/courses/${c.id}/complete`, {
                    student_thr: studentAddr,
                    teacher_thr: connectedWallet,
                    auth_secret: connectedSecret,
                    passphrase: connectedPassphrase
                });

                if (result.status === "success") {
                    log(`Student completed! L2E reward distributed. TX: ${result.tx.tx_id}`);
                    await refresh();
                } else {
                    log(`Completion failed: ${result.message}`, true);
                }
            } catch (e) {
                log(`Completion error: ${e.message}`, true);
            }
        };
    }

    return el;
}

// Refresh Courses
async function refresh() {
    const box = $("courses");
    box.innerHTML = `<div class="loading">${currentLang === 'el' ? 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¼Î±Î¸Î·Î¼Î¬Ï„Ï‰Î½...' : 'Loading courses...'}</div>`;

    try {
        const data = await apiGet("/api/v1/courses");
        const courses = data.courses || [];

        // Check which courses have quizzes
        for (let c of courses) {
            try {
                const quizData = await apiGet(`/api/v1/courses/${c.id}/quiz`);
                c.has_quiz = quizData.quiz && quizData.quiz.questions && quizData.quiz.questions.length > 0;
            } catch (e) {
                c.has_quiz = false;
            }
        }

        box.innerHTML = "";

        if (courses.length === 0) {
            box.innerHTML = `<div class="empty-state">${currentLang === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼Î±Î¸Î®Î¼Î±Ï„Î± Î±ÎºÏŒÎ¼Î±.' : 'No courses available yet.'}<br>${currentLang === 'el' ? 'Î“Î¯Î½Îµ Î¿ Ï€ÏÏÏ„Î¿Ï‚ Ï€Î¿Ï… Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹!' : 'Be the first to create one!'}</div>`;
        } else {
            courses.forEach(c => box.appendChild(courseCard(c)));
        }

        // Update stats
        $("totalCourses").textContent = courses.length;
        const totalStudents = courses.reduce((sum, c) => sum + (c.students || []).length, 0);
        $("totalStudents").textContent = totalStudents;
        const totalL2E = courses.reduce((sum, c) => sum + (c.completed || []).length * c.reward_l2e, 0);
        $("totalL2E").textContent = totalL2E.toFixed(2);

    } catch (e) {
        box.innerHTML = `<div class="error">${currentLang === 'el' ? 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚' : 'Failed to load courses'}: ${e.message}</div>`;
    }
}

// Load My Courses
async function loadMyCourses() {
    if (!connectedWallet) {
        $("my-courses-list").innerHTML = `<div class="empty-state">${currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚' : 'Please connect your wallet'}</div>`;
        return;
    }

    try {
        const data = await apiGet("/api/v1/courses");
        const courses = data.courses || [];
        const myCourses = courses.filter(c => (c.students || []).includes(connectedWallet));

        const box = $("my-courses-list");
        box.innerHTML = "";

        if (myCourses.length === 0) {
            box.innerHTML = `<div class="empty-state">${currentLang === 'el' ? 'Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎµÎ³Î³ÏÎ±Ï†ÎµÎ¯ ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Î¼Î¬Î¸Î·Î¼Î±' : 'You are not enrolled in any courses'}</div>`;
        } else {
            myCourses.forEach(c => box.appendChild(courseCard(c)));
        }
    } catch (e) {
        $("my-courses-list").innerHTML = `<div class="error">${e.message}</div>`;
    }
}

// Create Course
$("create").onclick = async () => {
    if (!connectedWallet || !connectedSecret) {
        log("Please connect wallet first", true);
        return;
    }

    const title = $("title").value.trim();
    const price = parseFloat($("price").value || "0");
    const reward = parseFloat($("reward").value || "0");
    const description = $("description").value.trim();
    const titleEl = $("titleEl").value.trim();
    const contentType = (document.querySelector('input[name="contentType"]:checked') || {}).value || 'pdf';
    const slidesFile = $("slidesFile").files[0];
    const videoUrl = $("videoUrl").value.trim();
    const contentUrl = $("contentUrl").value.trim();
    const quizPayload = collectQuizBuilder();

    if (!title || price < 0 || reward <= 0) {
        log("Invalid input: Title required, price >= 0, reward > 0", true);
        return;
    }

    if (contentType === 'pdf' && !slidesFile) {
        log("Please upload a slides PDF", true);
        return;
    }
    if (contentType === 'video' && !videoUrl) {
        log("Please provide a video URL", true);
        return;
    }
    if (contentType === 'external' && !contentUrl) {
        log("Please provide an external content URL", true);
        return;
    }

    try {
        log(`Creating course "${title}"...`);
        const formData = new FormData();
        formData.append('title', title);
        formData.append('title_el', titleEl);
        formData.append('description', description);
        formData.append('teacher', connectedWallet);
        formData.append('price_thr', price);
        formData.append('reward_l2e', reward);
        formData.append('auth_secret', connectedSecret);
        formData.append('passphrase', connectedPassphrase);
        formData.append('content_type', contentType);
        if (contentType === 'pdf' && slidesFile) formData.append('slides', slidesFile);
        if (contentType === 'video') formData.append('video_url', videoUrl);
        if (contentType === 'external') formData.append('content_url', contentUrl);
        if (quizPayload.questions.length > 0) {
            formData.append('quiz', JSON.stringify(quizPayload));
        }

        const response = await fetch("/api/v1/courses", { method: "POST", body: formData });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();

        if (result.status === "success") {
            log(`Course "${title}" created! ID: ${result.course.id}`);
            $("title").value = "";
            $("titleEl").value = "";
            $("description").value = "";
            $("price").value = "";
            $("reward").value = "";
            $("slidesFile").value = "";
            $("videoUrl").value = "";
            $("contentUrl").value = "";
            $("builderPassScore").value = "70";
            $("builderQuestions").innerHTML = "";
            builderQuestionCounter = 0;
            addBuilderQuestion();
            await refresh();
        } else {
            log(`Course creation failed: ${result.message}`, true);
        }
    } catch (e) {
        log(`Creation error: ${e.message}`, true);
    }
};

document.querySelectorAll('input[name="contentType"]').forEach(r => r.addEventListener('change', toggleContentFields));
toggleContentFields();
addBuilderQuestion();

// Quiz Functions
async function openQuiz(courseId) {
    currentQuizCourseId = courseId;

    try {
        const data = await apiGet(`/api/v1/courses/${courseId}/quiz`);
        if (!data.quiz || !data.quiz.questions || data.quiz.questions.length === 0) {
            alert(currentLang === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ quiz Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î¬Î¸Î·Î¼Î±' : 'No quiz available for this course');
            return;
        }

        const quiz = data.quiz;
        currentQuizQuestions = quiz.questions;

        $("quizTitle").textContent = currentLang === 'el' ? (quiz.title_el || quiz.title) : quiz.title;

        let html = `<p style="margin-bottom: 20px; opacity: 0.8;">${currentLang === 'el' ? 'Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚' : 'Passing score'}: ${quiz.passing_score}%</p>`;

        quiz.questions.forEach((q, idx) => {
            const questionText = currentLang === 'el' ? (q.question_el || q.question) : q.question;
            const options = currentLang === 'el' ? (q.options_el || q.options) : q.options;

            html += `
                <div class="question-card">
                    <div class="question-text">
                        <span class="question-number">#${idx + 1}</span>
                        ${escapeHtml(questionText)}
                    </div>
                    <div class="options">
                        ${options.map((opt, optIdx) => `
                            <label class="option-label">
                                <input type="radio" name="q${q.id}" value="${optIdx}">
                                ${escapeHtml(opt)}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        $("quizContent").innerHTML = html;
        $("quizModal").classList.add("active");
        $("submitQuizBtn").style.display = "inline-block";

    } catch (e) {
        alert(`Error loading quiz: ${e.message}`);
    }
}

function closeQuizModal() {
    $("quizModal").classList.remove("active");
    currentQuizCourseId = null;
    currentQuizQuestions = [];
}

async function submitQuiz() {
    if (!connectedWallet) {
        alert(currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚' : 'Please connect your wallet');
        return;
    }

    // Reset previous highlights
    document.querySelectorAll('.question-card').forEach(card => {
        card.style.border = '1px solid #1a5a2f';
    });

    // Collect answers and track unanswered questions
    const answers = {};
    const unansweredQuestions = [];

    currentQuizQuestions.forEach((q, idx) => {
        const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
        if (selected) {
            answers[q.id] = parseInt(selected.value);
        } else {
            unansweredQuestions.push(idx + 1);
        }
    });

    if (unansweredQuestions.length > 0) {
        // Highlight unanswered questions
        unansweredQuestions.forEach(qNum => {
            const questionCards = document.querySelectorAll('.question-card');
            if (questionCards[qNum - 1]) {
                questionCards[qNum - 1].style.border = '2px solid #ff6b6b';
                questionCards[qNum - 1].style.boxShadow = '0 0 10px rgba(255, 107, 107, 0.3)';
            }
        });

        // Scroll to first unanswered question
        const firstUnanswered = document.querySelectorAll('.question-card')[unansweredQuestions[0] - 1];
        if (firstUnanswered) {
            firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const msg = currentLang === 'el'
            ? `Î‘Ï€Î±Î½Ï„Î®ÏƒÏ„Îµ ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚. Î›ÎµÎ¯Ï€Î¿Ï…Î½: ${unansweredQuestions.join(', ')}`
            : `Please answer all questions. Missing: ${unansweredQuestions.join(', ')}`;
        alert(msg);
        return;
    }

    try {
        const result = await apiPost(`/api/v1/courses/${currentQuizCourseId}/quiz/submit`, {
            student_thr: connectedWallet,
            answers: answers
        });

        // Show results
        const passedClass = result.passed ? 'passed' : 'failed';
        const passedText = result.passed
            ? (currentLang === 'el' ? 'ğŸ‰ Î Î­ÏÎ±ÏƒÎµÏ‚!' : 'ğŸ‰ You Passed!')
            : (currentLang === 'el' ? 'ğŸ˜” Î”ÎµÎ½ Ï€Î­ÏÎ±ÏƒÎµÏ‚' : 'ğŸ˜” You Failed');

        $("quizContent").innerHTML = `
            <div class="quiz-result">
                <div class="quiz-score ${passedClass}">${result.score}%</div>
                <div style="font-size: 1.5em; margin: 15px 0;">${passedText}</div>
                <p>${currentLang === 'el' ? 'Î£Ï‰ÏƒÏ„Î­Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚' : 'Correct answers'}: ${result.correct}/${result.total}</p>
                <p>${currentLang === 'el' ? 'Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚' : 'Passing score'}: ${result.passing_score}%</p>
            </div>
        `;

        $("submitQuizBtn").style.display = "none";

        // Refresh courses to update badges
        await refresh();

    } catch (e) {
        alert(`Error submitting quiz: ${e.message}`);
    }
}

// Create Quiz Functions
let quizQuestions = [];

function openCreateQuiz(courseId) {
    currentQuizCourseId = courseId;
    quizQuestions = [];
    $("questionsContainer").innerHTML = "";
    $("quizTitleInput").value = "";
    $("passingScore").value = "80";
    addQuestion();
    $("createQuizModal").classList.add("active");
}

function closeCreateQuizModal() {
    $("createQuizModal").classList.remove("active");
    currentQuizCourseId = null;
}

function addQuestion() {
    const idx = quizQuestions.length;
    quizQuestions.push({ question: '', options: ['', '', '', ''], correct: 0 });

    const div = document.createElement('div');
    div.className = 'question-card';
    div.id = `question-${idx}`;
    div.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong>${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ·' : 'Question'} #${idx + 1}</strong>
            <button type="button" onclick="removeQuestion(${idx})" style="background: none; border: none; color: #ff6b6b; cursor: pointer;">âœ•</button>
        </div>
        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ· (Î‘Î³Î³Î»Î¹ÎºÎ¬)' : 'Question (English)'}"
               onchange="quizQuestions[${idx}].question = this.value" style="width: 100%; margin-bottom: 8px;">
        <input class="input-field" placeholder="${currentLang === 'el' ? 'Î•ÏÏÏ„Î·ÏƒÎ· (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)' : 'Question (Greek)'}"
               onchange="quizQuestions[${idx}].question_el = this.value" style="width: 100%; margin-bottom: 15px;">
        <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 8px;">${currentLang === 'el' ? 'Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ (ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î· ÏƒÏ‰ÏƒÏ„Î®)' : 'Options (select the correct one)'}:</div>
        ${[0, 1, 2, 3].map(i => `
            <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                <input type="radio" name="correct-${idx}" value="${i}" ${i === 0 ? 'checked' : ''}
                       onchange="quizQuestions[${idx}].correct = ${i}">
                <input class="input-field" placeholder="Option ${i + 1}"
                       onchange="quizQuestions[${idx}].options[${i}] = this.value" style="flex: 1;">
            </div>
        `).join('')}
    `;

    $("questionsContainer").appendChild(div);
}

function removeQuestion(idx) {
    const el = $(`question-${idx}`);
    if (el) el.remove();
    quizQuestions[idx] = null;
}

async function saveQuiz() {
    if (!connectedWallet || !connectedSecret) {
        alert(currentLang === 'el' ? 'Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚' : 'Please connect your wallet');
        return;
    }

    const validQuestions = quizQuestions.filter(q => q && q.question && q.options.every(o => o));

    if (validQuestions.length === 0) {
        alert(currentLang === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± ÎµÏÏÏ„Î·ÏƒÎ·' : 'Please add at least one question');
        return;
    }

    try {
        const result = await apiPost(`/api/v1/courses/${currentQuizCourseId}/quiz`, {
            teacher_thr: connectedWallet,
            auth_secret: connectedSecret,
            passphrase: connectedPassphrase,
            title: $("quizTitleInput").value || "Course Quiz",
            passing_score: parseInt($("passingScore").value) || 80,
            questions: validQuestions
        });

        if (result.status === "success") {
            alert(currentLang === 'el' ? 'Quiz Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!' : 'Quiz saved successfully!');
            closeCreateQuizModal();
            await refresh();
        } else {
            alert(`Error: ${result.message}`);
        }
    } catch (e) {
        alert(`Error saving quiz: ${e.message}`);
    }
}

// Utility
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Auto-refresh
$("refresh").onclick = refresh;

// Initial load
syncWalletFromSession(false);
refresh().catch(e => log(`Initial load error: ${e.message}`, true));
</script>
{% endblock %}
