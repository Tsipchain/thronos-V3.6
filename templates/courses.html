{% extends "base.html" %}
{% block title %}üéì Thronos Learn‚Äëto‚ÄëEarn{% endblock %}

{% block styles %}
<style>
    .l2e-container {
        max-width: 1200px;
        margin: 30px auto;
        color: #d7ffe6;
    }
    .l2e-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #07120b 0%, #0a1f14 100%);
        border: 1px solid #1a5a2f;
        border-radius: 16px;
    }
    .l2e-header h1 {
        color: #3CFF7A;
        letter-spacing: 3px;
        font-size: 2.5em;
        margin: 0 0 10px 0;
        text-shadow: 0 0 20px rgba(60, 255, 122, 0.3);
    }
    .l2e-header p {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px 0;
    }
    .l2e-stats {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
    }
    .stat-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px 25px;
        border-radius: 10px;
        border: 1px solid #1a5a2f;
    }
    .stat-box .label {
        font-size: 0.9em;
        opacity: 0.7;
        margin-bottom: 5px;
    }
    .stat-box .value {
        font-size: 1.8em;
        font-weight: bold;
        color: #3CFF7A;
    }
    .l2e-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    @media (max-width: 768px) {
        .l2e-grid {
            grid-template-columns: 1fr;
        }
    }
    .panel {
        background: #07120b;
        border: 1px solid #1a5a2f;
        border-radius: 14px;
        padding: 20px;
    }
    .panel h3 {
        margin-top: 0;
        color: #3CFF7A;
        border-bottom: 1px solid #1a5a2f;
        padding-bottom: 10px;
    }
    .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    .input-field {
        flex: 1;
        min-width: 200px;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #1a5a2f;
        background: #050b07;
        color: #d7ffe6;
        font-family: monospace;
    }
    .input-field:focus {
        outline: none;
        border-color: #3CFF7A;
        box-shadow: 0 0 0 2px rgba(60, 255, 122, 0.1);
    }
    .btn-primary {
        padding: 12px 20px;
        border-radius: 10px;
        border: 1px solid #3CFF7A;
        background: #06140b;
        color: #3CFF7A;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    }
    .btn-primary:hover {
        background: #3CFF7A;
        color: #000;
        box-shadow: 0 0 15px rgba(60, 255, 122, 0.4);
    }
    .btn-secondary {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px solid #1a5a2f;
        background: #06140b;
        color: #d7ffe6;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-secondary:hover {
        border-color: #3CFF7A;
        background: rgba(60, 255, 122, 0.1);
    }
    .course-card {
        border: 1px solid #123a22;
        border-radius: 12px;
        padding: 16px;
        background: #050b07;
        margin-bottom: 12px;
        transition: all 0.3s;
    }
    .course-card:hover {
        border-color: #3CFF7A;
        box-shadow: 0 0 20px rgba(60, 255, 122, 0.15);
        transform: translateY(-2px);
    }
    .course-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 12px;
    }
    .course-title {
        font-weight: 700;
        font-size: 1.2em;
        color: #d7ffe6;
        margin-bottom: 8px;
    }
    .course-meta {
        opacity: 0.85;
        font-size: 13px;
        margin: 4px 0;
    }
    .course-meta code {
        background: rgba(60, 255, 122, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        color: #3CFF7A;
    }
    .course-stats {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #123a22;
        font-size: 12px;
        opacity: 0.75;
    }
    .course-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 140px;
    }
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        margin-left: 8px;
    }
    .badge-enrolled {
        background: rgba(60, 255, 122, 0.2);
        color: #3CFF7A;
        border: 1px solid #3CFF7A;
    }
    .badge-completed {
        background: rgba(255, 215, 0, 0.2);
        color: #ffd700;
        border: 1px solid #ffd700;
    }
    .log-box {
        white-space: pre-wrap;
        margin-top: 12px;
        background: #050b07;
        border: 1px solid #123a22;
        border-radius: 12px;
        padding: 12px;
        min-height: 140px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        opacity: 0.6;
    }
    .loading {
        text-align: center;
        padding: 20px;
        color: #3CFF7A;
    }
    .error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="l2e-container">
    <!-- Header Section -->
    <div class="l2e-header">
        <h1>üéì LEARN‚ÄëTO‚ÄëEARN</h1>
        <p>ŒúŒ¨Œ∏Œµ, œÄŒªŒÆœÅœâœÉŒµ ŒºŒµ THR, ŒøŒªŒøŒ∫ŒªŒÆœÅœâœÉŒµ œÑŒø course, Œ∫Œ≠œÅŒ¥ŒπœÉŒµ L2E tokens</p>
        <div class="l2e-stats">
            <div class="stat-box">
                <div class="label">Total Courses</div>
                <div class="value" id="totalCourses">0</div>
            </div>
            <div class="stat-box">
                <div class="label">Total Students</div>
                <div class="value" id="totalStudents">0</div>
            </div>
            <div class="stat-box">
                <div class="label">L2E Distributed</div>
                <div class="value" id="totalL2E">0</div>
            </div>
        </div>
    </div>

    <!-- Wallet Connection -->
    <div class="panel" style="margin-bottom: 20px;">
        <h3>üîê Wallet Connection</h3>
        <div class="input-group">
            <input id="wallet" class="input-field" placeholder="THR wallet address (e.g., THR123...)" />
            <input id="secret" class="input-field" type="password" placeholder="auth_secret" />
            <input id="passphrase" class="input-field" type="password" placeholder="passphrase (optional)" />
            <button id="connectBtn" class="btn-primary">Connect</button>
        </div>
        <div id="walletStatus" style="margin-top: 10px; display: none;">
            <span style="color: #3CFF7A;">‚úì Connected:</span> <code id="connectedWallet"></code>
            <span style="margin-left: 15px;">L2E Balance: <strong id="l2eBalance">0</strong></span>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="l2e-grid">
        <!-- Courses List -->
        <div class="panel">
            <h3>üìö Available Courses</h3>
            <button id="refresh" class="btn-secondary" style="width: 100%; margin-bottom: 15px;">üîÑ Refresh Courses</button>
            <div id="courses"></div>
        </div>

        <!-- Create Course -->
        <div class="panel">
            <h3>‚ûï Create Course (Teachers Only)</h3>
            <input id="title" class="input-field" placeholder="Course Title (e.g., Blockchain Basics)" style="width: 100%; margin-bottom: 10px;" />
            <input id="description" class="input-field" placeholder="Course Description (optional)" style="width: 100%; margin-bottom: 10px;" />
            <input id="price" class="input-field" type="number" step="0.1" placeholder="Price in THR (e.g., 2.5)" style="width: 100%; margin-bottom: 10px;" />
            <input id="reward" class="input-field" type="number" step="0.1" placeholder="L2E Reward (e.g., 10)" style="width: 100%; margin-bottom: 10px;" />
            <button id="create" class="btn-primary" style="width: 100%;">Create Course</button>
            <div class="log-box" id="log">Ready to create courses...</div>
        </div>
    </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
let connectedWallet = null;
let connectedSecret = null;
let connectedPassphrase = null;

// API Helpers
async function apiGet(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
}

async function apiPost(url, body) {
    const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
}

// Logging
function log(message, isError = false) {
    const logBox = $("log");
    const timestamp = new Date().toLocaleTimeString();
    const prefix = isError ? "‚ùå ERROR" : "‚úì";
    logBox.textContent = `[${timestamp}] ${prefix} ${message}\n\n${logBox.textContent}`;
    if (isError) {
        logBox.style.color = "#ff6b6b";
    } else {
        logBox.style.color = "#d7ffe6";
    }
}

// Connect Wallet
$("connectBtn").onclick = async () => {
    const wallet = $("wallet").value.trim();
    const secret = $("secret").value.trim();
    const passphrase = $("passphrase").value.trim();
    
    if (!wallet) {
        log("Please enter a wallet address", true);
        return;
    }
    
    connectedWallet = wallet;
    connectedSecret = secret;
    connectedPassphrase = passphrase;
    
    $("walletStatus").style.display = "block";
    $("connectedWallet").textContent = wallet;
    
    // Load L2E balance
    try {
        const data = await apiGet(`/api/v1/l2e/balance/${wallet}`);
        $("l2eBalance").textContent = data.l2e_balance || 0;
    } catch (e) {
        log(`Failed to load L2E balance: ${e.message}`, true);
    }
    
    log(`Connected wallet: ${wallet}`);
    await refresh();
};

// Create Course Card
function courseCard(c) {
    const el = document.createElement("div");
    el.className = "course-card";
    
    const isEnrolled = connectedWallet && (c.students || []).includes(connectedWallet);
    const isCompleted = connectedWallet && (c.completed || []).includes(connectedWallet);
    const isTeacher = connectedWallet && c.teacher === connectedWallet;
    
    let badges = "";
    if (isEnrolled) badges += '<span class="badge badge-enrolled">Enrolled</span>';
    if (isCompleted) badges += '<span class="badge badge-completed">Completed</span>';
    
    el.innerHTML = `
        <div class="course-header">
            <div style="flex: 1;">
                <div class="course-title">${escapeHtml(c.title)}${badges}</div>
                <div class="course-meta">üë®‚Äçüè´ Teacher: <code>${escapeHtml(c.teacher.substring(0, 12))}...</code></div>
                <div class="course-meta">üí∞ Price: <strong>${c.price_thr}</strong> THR ¬∑ üéÅ Reward: <strong>${c.reward_l2e}</strong> L2E</div>
                <div class="course-stats">
                    <span>üë• ${(c.students || []).length} students</span>
                    <span>‚úÖ ${(c.completed || []).length} completed</span>
                </div>
            </div>
            <div class="course-actions">
                <button class="btn-enroll btn-primary" ${isEnrolled || !connectedWallet ? 'disabled' : ''}>
                    ${isEnrolled ? '‚úì Enrolled' : 'üìù Enroll'}
                </button>
                <button class="btn-complete btn-secondary" ${!isTeacher || isCompleted ? 'disabled' : ''}>
                    ${isCompleted ? '‚úì Completed' : '‚úÖ Complete'}
                </button>
            </div>
        </div>
    `;
    
    // Enroll button
    el.querySelector(".btn-enroll").onclick = async () => {
        if (!connectedWallet || !connectedSecret) {
            log("Please connect wallet first", true);
            return;
        }
        
        try {
            log(`Enrolling in "${c.title}"...`);
            const result = await apiPost(`/api/v1/courses/${c.id}/enroll`, {
                student_thr: connectedWallet,
                auth_secret: connectedSecret,
                passphrase: connectedPassphrase
            });
            
            if (result.status === "success") {
                log(`Successfully enrolled in "${c.title}"! TX: ${result.tx.tx_id}`);
                await refresh();
            } else {
                log(`Enrollment failed: ${result.message || 'Unknown error'}`, true);
            }
        } catch (e) {
            log(`Enrollment error: ${e.message}`, true);
        }
    };
    
    // Complete button (for teachers)
    el.querySelector(".btn-complete").onclick = async () => {
        if (!connectedWallet || !connectedSecret) {
            log("Please connect wallet first", true);
            return;
        }
        
        const studentAddr = prompt("Enter student's THR address to mark as completed:");
        if (!studentAddr) return;
        
        try {
            log(`Marking student ${studentAddr} as completed for "${c.title}"...`);
            const result = await apiPost(`/api/v1/courses/${c.id}/complete`, {
                student_thr: studentAddr,
                teacher_thr: connectedWallet,
                auth_secret: connectedSecret,
                passphrase: connectedPassphrase
            });
            
            if (result.status === "success") {
                log(`Student completed! L2E reward distributed. TX: ${result.tx.tx_id}`);
                await refresh();
            } else {
                log(`Completion failed: ${result.message || 'Unknown error'}`, true);
            }
        } catch (e) {
            log(`Completion error: ${e.message}`, true);
        }
    };
    
    return el;
}

// Refresh Courses
async function refresh() {
    const box = $("courses");
    box.innerHTML = '<div class="loading">Loading courses...</div>';
    
    try {
        const data = await apiGet("/api/v1/courses");
        const courses = data.courses || [];
        
        box.innerHTML = "";
        
        if (courses.length === 0) {
            box.innerHTML = '<div class="empty-state">No courses available yet.<br>Be the first to create one!</div>';
        } else {
            courses.forEach(c => box.appendChild(courseCard(c)));
        }
        
        // Update stats
        $("totalCourses").textContent = courses.length;
        const totalStudents = courses.reduce((sum, c) => sum + (c.students || []).length, 0);
        $("totalStudents").textContent = totalStudents;
        const totalL2E = courses.reduce((sum, c) => sum + (c.completed || []).length * c.reward_l2e, 0);
        $("totalL2E").textContent = totalL2E.toFixed(2);
        
    } catch (e) {
        box.innerHTML = `<div class="error">Failed to load courses: ${e.message}</div>`;
        log(`Refresh error: ${e.message}`, true);
    }
}

// Create Course
$("create").onclick = async () => {
    if (!connectedWallet || !connectedSecret) {
        log("Please connect wallet first", true);
        return;
    }
    
    const title = $("title").value.trim();
    const price = parseFloat($("price").value || "0");
    const reward = parseFloat($("reward").value || "0");
    
    if (!title || price < 0 || reward <= 0) {
        log("Invalid input: Title required, price >= 0, reward > 0", true);
        return;
    }
    
    try {
        log(`Creating course "${title}"...`);
        const result = await apiPost("/api/v1/courses", {
            title,
            teacher: connectedWallet,
            price_thr: price,
            reward_l2e: reward,
            auth_secret: connectedSecret,
            passphrase: connectedPassphrase
        });
        
        if (result.status === "success") {
            log(`Course "${title}" created successfully! ID: ${result.course.id}`);
            $("title").value = "";
            $("description").value = "";
            $("price").value = "";
            $("reward").value = "";
            await refresh();
        } else {
            log(`Course creation failed: ${result.message || 'Unknown error'}`, true);
        }
    } catch (e) {
        log(`Creation error: ${e.message}`, true);
    }
};

// Utility
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Auto-refresh
$("refresh").onclick = refresh;

// Initial load
refresh().catch(e => log(`Initial load error: ${e.message}`, true));

// Auto-load wallet from localStorage
const savedWallet = localStorage.getItem('thr_address');
if (savedWallet) {
    $("wallet").value = savedWallet;
}
</script>
{% endblock %}
