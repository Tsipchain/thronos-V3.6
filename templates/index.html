{% extends "base.html" %}

{% block title %}Thronos Network{% endblock %}

{% block styles %}
<style>
    .stats {
      background: #111;
      padding: 10px;
      margin-top: 20px;
      border: 1px dashed #0f0;
    }
    .game-link {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #f0f;
        color: #f0f;
        display: inline-block;
        text-decoration: none;
    }
    .game-link:hover {
        background: #200;
    }
    .beta-section {
        background: #1a001a;
        padding: 15px;
        margin-top: 20px;
        border: 1px dashed #f0f;
        color: #f0f;
    }
    .beta-btn {
        background: #300030;
        color: #f0f;
        border: 1px solid #f0f;
        padding: 8px 16px;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
        cursor: pointer;
    }
    .beta-btn:hover {
        background: #500050;
    }
</style>
{% endblock %}

{% block content %}
<h1>ğŸ”¥ <span class="lang-el">ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ ÏƒÏ„Î¿ Î”Î¯ÎºÏ„Ï…Î¿ Thronos</span><span class="lang-en">Welcome to the Thronos Network</span></h1>
<p>
    <span class="lang-el">ÎˆÎ½Î± blockchain Î±Î½Ï„Î¯ÏƒÏ„Î±ÏƒÎ·Ï‚. ÎœÎ¹Î± Î´Î­ÏƒÎ¼ÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ Î¬ÎºÎ±Ï…ÏƒÏ„Î¿.</span>
    <span class="lang-en">A blockchain of resistance. A pledge to the unburnable.</span>
</p>

<div class="stats">
  <h2>ğŸ“ˆ <span class="lang-el">Î–Ï‰Î½Ï„Î±Î½Î¬ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Î”Î¹ÎºÏ„ÏÎ¿Ï…</span><span class="lang-en">Live Network Stats</span></h2>
  <pre id="chainInfo"><span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Î»Ï…ÏƒÎ¯Î´Î±Ï‚...</span><span class="lang-en">Loading chain data...</span></pre>
</div>

<div class="stats">
  <h3>ğŸ’° <span class="lang-el">Î™ÏƒÎ¿Ï„Î¹Î¼Î¯Î±</span><span class="lang-en">Exchange Rate</span></h3>
  <p>1 THR = <span class="highlight">0.0001 BTC</span> (Pegged)</p>
</div>

<!-- Crypto Hunters Beta Section -->
<div class="beta-section">
    <h3>ğŸ® <span class="lang-el">Crypto Hunters - Beta & Î¨Î·Ï†Î¿Ï†Î¿ÏÎ¯Î±</span><span class="lang-en">Crypto Hunters - Beta & Voting</span></h3>
    <p>
        <span class="lang-el">Î›Î¬Î²ÎµÏ„Îµ Î¼Î­ÏÎ¿Ï‚ ÏƒÏ„Î¿ ÎºÏ…Î½Î®Î³Î¹! Î’Î¿Î·Î¸Î®ÏƒÏ„Îµ Î¼Î±Ï‚ Î½Î± Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ ÎµÏ€ÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ Crypto Hunters. Î¨Î·Ï†Î¯ÏƒÏ„Îµ Î³Î¹Î± Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ ÎºÎµÏÎ´Î¯ÏƒÏ„Îµ Î±Î½Ï„Î±Î¼Î¿Î¹Î²Î­Ï‚.</span>
        <span class="lang-en">Join the hunt! Help us test the upcoming Crypto Hunters game. Vote on features and earn rewards.</span>
    </p>
    <div id="votingPolls">
        <p><span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏˆÎ·Ï†Î¿Ï†Î¿ÏÎ¹ÏÎ½...</span><span class="lang-en">Loading polls...</span></p>
    </div>
</div>

<!-- Wallet Widget Section -->
<div class="beta-section" style="border-color: #0f0; background: #001a00;">
    <h3>ğŸ’ <span class="lang-el">Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ - Balance Widget</span><span class="lang-en">Wallet - Balance Widget</span></h3>
    <p style="color: #0f0;">
        <span class="lang-el">Î”ÎµÎ¯Ï„Îµ Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ tokens Î¼Îµ Î­Î½Î± ÎºÎ»Î¹Îº!</span>
        <span class="lang-en">See all your token balances at a glance!</span>
    </p>
    <div style="margin-top: 15px;">
        <iframe id="walletWidgetFrame"
                src=""
                style="width: 100%; height: 600px; border: 1px solid #0f0; border-radius: 8px; background: #000;"
                frameborder="0">
        </iframe>
    </div>
    <script>
        // Auto-load wallet widget with connected address
        (function() {
            const addr = localStorage.getItem('thr_address');
            const iframe = document.getElementById('walletWidgetFrame');
            if (addr) {
                iframe.src = `/widget/wallet?address=${addr}&show_zero=true`;
            } else {
                iframe.src = `/widget/wallet?address=THR79ca94a7eb70a6aa99d12d7fdb01446ef246301a&show_zero=true`;
            }
        })();
    </script>
</div>

<a href="{{ game_panel_url }}" target="_blank" class="game-link">
    ğŸ‘¾ <span class="lang-el">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Crypto Hunters</span><span class="lang-en">Crypto Hunters Admin</span>
</a>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const labels = {
    el: {
      totalBlocks: "Î£ÏÎ½Î¿Î»Î¿ Blocks",
      lastHash:    "Hash Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï… Block",
      lastMiner:   "Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï‚ Miner",
      timestamp:   "Î§ÏÎ¿Î½Î¹ÎºÎ® Î£Î®Î¼Î±Î½ÏƒÎ·",
      totalSupply: "Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î ÏÎ¿Î¼Î®Î¸ÎµÎ¹Î± THR"
    },
    en: {
      totalBlocks: "Total Blocks",
      lastHash:    "Last Block Hash",
      lastMiner:   "Last Miner",
      timestamp:   "Timestamp",
      totalSupply: "Total THR Supply"
    }
  };

  function renderStats(lastBlock, netStats) {
    const lang = localStorage.getItem("lang") || "el";
    const l = labels[lang];

    const blockCount  = (lastBlock && lastBlock.block_count) || (netStats && netStats.block_count) || 0;
    const totalSupply = (lastBlock && lastBlock.total_supply) || (netStats && netStats.total_supply) || 0;
    const lastHash    = (lastBlock && lastBlock.block_hash) || "N/A";
    const lastMiner   = (lastBlock && lastBlock.thr_address) || "N/A";
    const ts          = (lastBlock && lastBlock.timestamp) || "N/A";

    const html = `
${l.totalBlocks}: <span class="highlight">${blockCount}</span>\n
${l.totalSupply}: <span class="highlight">${totalSupply.toFixed(6)}</span> / ~420,000 THR\n
${l.lastHash}: ${lastHash}\n
${l.lastMiner}: ${lastMiner}\n
${l.timestamp}: ${ts}
`;
    document.getElementById("chainInfo").innerHTML = html;
  }

  function loadStats() {
    Promise.all([
      fetch("/last_block").then(r => r.json()).catch(() => ({})),
      fetch("/api/network_stats").then(r => r.json()).catch(() => ({})),
    ])
      .then(([lastBlock, netStats]) => {
        renderStats(lastBlock, netStats);
        // ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î± Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÏƒÏ„Î¿Î½ window Î³Î¹Î± debugging Î±Î½ Î¸ÎµÏ‚
        window.__THR_LAST_BLOCK  = lastBlock;
        window.__THR_NET_STATS   = netStats;
      })
      .catch(err => {
        console.error(err);
        document.getElementById("chainInfo").innerText =
          "Failed to load network stats.";
      });
  }

  // Î±ÏÏ‡Î¹ÎºÏŒ load
  loadStats();

  // Î¾Î±Î½Î±ÎºÏ„Î¯ÏƒÎ¹Î¼Î¿ ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Î· Î³Î»ÏÏƒÏƒÎ±
  window.addEventListener("langChanged", () => {
    renderStats(window.__THR_LAST_BLOCK || {}, window.__THR_NET_STATS || {});
  });

  // Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬: Î¼Î¹ÎºÏÏŒ auto-refresh Î±Î½Î¬ 30s
  setInterval(loadStats, 30000);
})();

// â”€â”€â”€ Voting System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  let currentWallet = null;

  // Get wallet from localStorage if connected
  function getWallet() {
    return localStorage.getItem("thr_wallet") || null;
  }

  function loadVotingPolls() {
    fetch("/api/voting/polls")
      .then(r => r.json())
      .then(polls => {
        renderPolls(polls);
      })
      .catch(err => {
        console.error("Failed to load polls:", err);
        document.getElementById("votingPolls").innerHTML =
          '<p style="color: #f00;">Failed to load polls</p>';
      });
  }

  function renderPolls(polls) {
    const lang = localStorage.getItem("lang") || "el";
    const container = document.getElementById("votingPolls");

    if (!polls || polls.length === 0) {
      container.innerHTML = `
        <p><span class="lang-el">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ½ÎµÏÎ³Î­Ï‚ ÏˆÎ·Ï†Î¿Ï†Î¿ÏÎ¯ÎµÏ‚</span>
        <span class="lang-en">No active polls</span></p>
      `;
      return;
    }

    let html = '<div style="margin-top: 10px;">';
    polls.forEach(poll => {
      const title = poll.title[lang] || poll.title["en"];
      const desc = poll.description[lang] || poll.description["en"];
      const votes = poll.votes || 0;

      html += `
        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #f0f; background: #200020;">
          <h4 style="margin: 0 0 5px 0; color: #f0f;">${title}</h4>
          <p style="margin: 0 0 8px 0; font-size: 0.9em; color: #ccc;">${desc}</p>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #0f0;">ğŸ‘ ${votes} ${lang === 'el' ? 'ÏˆÎ®Ï†Î¿Î¹' : 'votes'}</span>
            <button onclick="vote('${poll.id}')" class="beta-btn" style="margin: 0; padding: 5px 10px; font-size: 0.9em;">
              <span class="lang-el">Î¨Î·Ï†Î¯ÏƒÏ„Îµ</span><span class="lang-en">Vote</span>
            </button>
          </div>
        </div>
      `;
    });
    html += '</div>';

    container.innerHTML = html;
  }

  window.vote = function(pollId) {
    const lang = localStorage.getItem("lang") || "el";
    const wallet = getWallet();

    fetch("/api/voting/vote", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ poll_id: pollId, wallet: wallet })
    })
      .then(r => r.json())
      .then(data => {
        if (data.status === "success") {
          alert(lang === "el" ?
            "âœ… Î— ÏˆÎ®Ï†Î¿Ï‚ ÏƒÎ±Ï‚ ÎºÎ±Ï„Î±Î³ÏÎ¬Ï†Î·ÎºÎµ! Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ!" :
            "âœ… Your vote has been recorded! Thank you!"
          );
          loadVotingPolls(); // Refresh to show updated count
        } else if (data.status === "duplicate") {
          alert(lang === "el" ?
            "âš ï¸ ÎˆÏ‡ÎµÏ„Îµ Î®Î´Î· ÏˆÎ·Ï†Î¯ÏƒÎµÎ¹ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ ÏˆÎ·Ï†Î¿Ï†Î¿ÏÎ¯Î±!" :
            "âš ï¸ You have already voted in this poll!"
          );
        } else {
          alert(lang === "el" ?
            "âŒ Î£Ï†Î¬Î»Î¼Î±: " + (data.error || "Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±") :
            "âŒ Error: " + (data.error || "Unknown error")
          );
        }
      })
      .catch(err => {
        console.error("Vote error:", err);
        alert(lang === "el" ?
          "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ ÏˆÎ®Ï†Î¿Ï…" :
          "âŒ Failed to submit vote"
        );
      });
  };

  // Initial load
  loadVotingPolls();

  // Reload when language changes
  window.addEventListener("langChanged", loadVotingPolls);
})();
</script>

{% endblock %}
