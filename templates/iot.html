{% extends "base.html" %}

{% block title %}ğŸ“¡ Thronos IoT & Smart City{% endblock %}

{% block styles %}
<style>
    .iot-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    @media (min-width: 768px) {
        .iot-container { grid-template-columns: 1fr 1fr; }
    }
    
    .panel {
        background: #111;
        border: 1px solid #0f0;
        border-radius: 8px;
        padding: 20px;
    }
    
    .parking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .spot {
        border: 2px solid #333;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .spot.free { border-color: #0f0; background: #001100; }
    .spot.occupied { border-color: #f00; background: #110000; opacity: 0.7; cursor: not-allowed; }
    .spot.reserved { border-color: #ff0; background: #111100; }
    
    .spot-id { font-weight: bold; font-size: 1.1em; }
    .spot-status { font-size: 0.8em; margin-top: 5px; }
    
    .sensor-val { font-family: monospace; color: #0ff; }
    
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: #111;
        border: 1px solid #0f0;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        text-align: center;
    }
    
    button.action-btn {
        background: #0f0; color: #000; border: none;
        padding: 8px 16px; font-weight: bold; cursor: pointer;
        margin-top: 10px; width: 100%;
    }
    button.action-btn:disabled { background: #333; color: #666; }
    
    .water-level {
        height: 20px;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }
    .water-fill {
        height: 100%;
        background: #00f;
        width: 0%;
        transition: width 1s;
    }
</style>
{% endblock %}

{% block content %}

<h1>ğŸ“¡ <span class="lang-el">IoT & ÎˆÎ¾Ï…Ï€Î½Î· Î ÏŒÎ»Î·</span><span class="lang-en">IoT & Smart City</span></h1>

<div id="walletWarning" style="color:#ffaa88; margin-bottom:15px; display:none; text-align:center;">
    âš ï¸ <a href="/wallet" style="color:#ffaa88; text-decoration:underline;">Connect Wallet</a> to interact with Smart City services.
</div>

<div class="iot-container">
    
    <!-- SMART PARKING SECTION -->
    <div class="panel">
        <h2>ğŸ…¿ï¸ <span class="lang-el">ÎˆÎ¾Ï…Ï€Î½Î¿ Î Î¬ÏÎºÎ¹Î½Î³Îº</span><span class="lang-en">Smart Parking</span></h2>
        <p class="lang-el">ÎšÏÎ¬Ï„Î·ÏƒÎ· Î¸Î­ÏƒÎ·Ï‚ ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ Ï‡ÏÏŒÎ½Î¿ Î¼Îµ THR.</p>
        <p class="lang-en">Real-time spot reservation with THR.</p>
        
        <div style="margin:10px 0; font-size:0.9em;">
            <span style="color:#0f0">â–  Free</span> &nbsp; 
            <span style="color:#f00">â–  Occupied</span> &nbsp; 
            <span style="color:#ff0">â–  Reserved</span>
        </div>

        <div class="parking-grid" id="parkingGrid">
            <!-- Spots generated by JS -->
        </div>
    </div>

    <!-- SMART WATER / ENV SENSORS -->
    <div class="panel">
        <h2>ğŸ’§ <span class="lang-el">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î¥Î´Î¬Ï„Ï‰Î½</span><span class="lang-en">Water Management</span></h2>
        
        <div style="margin-bottom:20px;">
            <h3>Reservoir A (Main)</h3>
            <div class="water-level"><div id="waterA" class="water-fill" style="width:75%"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:0.8em; margin-top:5px;">
                <span>Level: <span id="lvlA" class="sensor-val">75%</span></span>
                <span>Quality: <span class="sensor-val">Good (pH 7.2)</span></span>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <h3>Reservoir B (Reserve)</h3>
            <div class="water-level"><div id="waterB" class="water-fill" style="width:40%"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:0.8em; margin-top:5px;">
                <span>Level: <span id="lvlB" class="sensor-val">40%</span></span>
                <span>Quality: <span class="sensor-val">Excellent (pH 7.0)</span></span>
            </div>
        </div>
        
        <hr style="border-color:#333; margin:15px 0;">
        
        <h3>ğŸš— Active Vehicle Nodes</h3>
        <div id="vehicleList" style="max-height:200px; overflow-y:auto; font-size:0.8em;">
            <div style="color:#666; font-style:italic;">Scanning for nodes...</div>
        </div>
    </div>
</div>

<!-- REGISTER NODE SECTION -->
<div class="panel" style="margin-top:20px;">
    <h2>ğŸ”§ <span class="lang-el">Î•Î³Î³ÏÎ±Ï†Î® ÎšÏŒÎ¼Î²Î¿Ï…</span><span class="lang-en">Register Node</span></h2>
    <form action="/register_node" method="POST" style="display:flex; gap:10px; flex-wrap:wrap;">
        <input name="address" placeholder="Wallet Address (THR)" style="flex:1; padding:8px; background:#000; border:1px solid #0f0; color:#fff;">
        <input name="secret" type="password" placeholder="Node Secret" style="flex:1; padding:8px; background:#000; border:1px solid #0f0; color:#fff;">
        <button type="submit" class="action-btn" style="width:auto;">Download Kit (.zip)</button>
    </form>
</div>

<!-- RESERVATION MODAL -->
<div id="reserveModal" class="modal">
    <div class="modal-content">
        <h3>Reserve Spot <span id="modalSpotId"></span></h3>
        <p>Cost: <strong>5 THR</strong> / hour</p>
        <p style="font-size:0.8em; color:#888;">Funds will be deducted from your connected wallet.</p>
        <div id="modalMsg" style="margin:10px 0; min-height:20px;"></div>
        <div style="display:flex; gap:10px;">
            <button class="action-btn" onclick="confirmReservation()">Confirm & Pay</button>
            <button class="action-btn" style="background:#333; color:#fff;" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const $ = (id) => document.getElementById(id);

// --- Mock Data for Parking ---
// In a real app, this would come from /api/iot/parking
const SPOTS = Array.from({length: 12}, (_, i) => ({
    id: `P-${101+i}`,
    status: Math.random() > 0.7 ? 'occupied' : 'free', // Random init
    reservedBy: null
}));

let selectedSpot = null;

function renderParking() {
    const grid = $('parkingGrid');
    grid.innerHTML = '';
    
    SPOTS.forEach(spot => {
        const div = document.createElement('div');
        div.className = `spot ${spot.status}`;
        div.innerHTML = `
            <div class="spot-id">${spot.id}</div>
            <div class="spot-status">${spot.status.toUpperCase()}</div>
        `;
        
        if (spot.status === 'free') {
            div.onclick = () => openReserveModal(spot);
        }
        
        grid.appendChild(div);
    });
}

function openReserveModal(spot) {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        alert("Please connect your wallet first!");
        return;
    }
    selectedSpot = spot;
    $('modalSpotId').textContent = spot.id;
    $('modalMsg').textContent = '';
    $('reserveModal').style.display = 'flex';
}

function closeModal() {
    $('reserveModal').style.display = 'none';
    selectedSpot = null;
}

async function confirmReservation() {
    const wallet = localStorage.getItem('thr_address');
    const secret = localStorage.getItem('thr_secret'); // Needed for signing
    
    if (!wallet || !secret) {
        $('modalMsg').textContent = "âŒ Wallet auth missing.";
        return;
    }
    
    $('modalMsg').style.color = '#ff0';
    $('modalMsg').textContent = "Processing payment...";
    
    // Simulate API call to pay and reserve
    // In real implementation: POST /api/iot/reserve { spot, wallet, secret }
    // Here we simulate via send_thr to a "PARKING_SERVICE" address
    
    try {
        const res = await fetch('/send_thr', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                from_thr: wallet,
                to_thr: "THR_PARKING_SERVICE", // Virtual service address
                amount: 5,
                auth_secret: secret
            })
        });
        
        const data = await res.json();
        
        if (data.status === 'pending' || data.status === 'confirmed') {
            // Success
            $('modalMsg').style.color = '#0f0';
            $('modalMsg').textContent = "âœ… Reserved!";
            
            // Update local state
            const spotIdx = SPOTS.findIndex(s => s.id === selectedSpot.id);
            if (spotIdx >= 0) {
                SPOTS[spotIdx].status = 'reserved';
                SPOTS[spotIdx].reservedBy = wallet;
            }
            renderParking();
            
            setTimeout(closeModal, 1500);
        } else {
            throw new Error(data.error || "Payment failed");
        }
    } catch (e) {
        $('modalMsg').style.color = '#f00';
        $('modalMsg').textContent = "âŒ Error: " + e.message;
    }
}

// --- IoT Data Polling ---
async function fetchIoTData() {
    try {
        const res = await fetch('/api/iot/data');
        const data = await res.json();
        
        const list = $('vehicleList');
        if (data.length === 0) {
            list.innerHTML = '<div style="color:#666;">No active vehicles.</div>';
        } else {
            list.innerHTML = data.map(v => `
                <div style="border-bottom:1px solid #333; padding:5px 0;">
                    <strong>${v.vehicle_id}</strong> 
                    <span style="color:#0f0; font-size:0.9em;">${v.speed} km/h</span><br>
                    <span style="color:#888; font-size:0.8em;">${v.timestamp}</span>
                </div>
            `).join('');
        }
        
        // Simulate Water Sensor fluctuation
        const lvlA = 70 + Math.random() * 10;
        const lvlB = 35 + Math.random() * 10;
        $('waterA').style.width = lvlA + '%';
        $('lvlA').textContent = Math.round(lvlA) + '%';
        $('waterB').style.width = lvlB + '%';
        $('lvlB').textContent = Math.round(lvlB) + '%';
        
    } catch (e) {
        console.error("IoT poll error", e);
    }
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) $('walletWarning').style.display = 'block';
    
    renderParking();
    fetchIoTData();
    setInterval(fetchIoTData, 5000);
});
</script>
{% endblock %}
