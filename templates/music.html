{% extends "base.html" %}

{% block title %}ğŸµ Decent Music - Thronos{% endblock %}

{% block styles %}
<style>
    .music-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 150px; /* FIX 4A: Prevent music player from being covered by footer widget */
    }

    .music-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .music-title {
        font-size: 36px;
        font-weight: bold;
        background: linear-gradient(135deg, #ff6600 0%, #00ff66 50%, #ffd700 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
        filter: drop-shadow(0 0 15px rgba(255, 102, 0, 0.4));
    }

    .music-subtitle {
        color: #56ff9a;
        font-size: 14px;
    }

    /* Tabs */
    .music-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #1a3b2e;
        flex-wrap: wrap;
    }

    .music-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #56ff9a;
        cursor: pointer;
        font-family: "Courier New", monospace;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .music-tab:hover {
        color: #00ff66;
    }

    .music-tab.active {
        color: #ff6600;
        border-bottom-color: #ff6600;
        background: linear-gradient(135deg, rgba(255, 102, 0, 0.1) 0%, rgba(255, 102, 0, 0.05) 100%);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Track Cards */
    .tracks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .track-card {
        background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(40, 20, 10, 0.3) 100%);
        border: 1px solid #3a2a1e;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s;
    }

    .track-card:hover {
        border-color: #ff6600;
        box-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
        transform: translateY(-3px);
    }

    .track-cover {
        width: 100%;
        height: 180px;
        background: linear-gradient(135deg, #1a0a00 0%, #2a1a10 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        position: relative;
    }

    .track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .track-play-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6600 0%, #ff8800 100%);
        border: none;
        color: #000;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4);
    }

    .track-play-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 102, 0, 0.6);
    }

    .track-info {
        padding: 15px;
    }

    .track-title {
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-artist {
        font-size: 13px;
        color: #ff6600;
        margin-bottom: 10px;
    }

    .track-stats {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
    }

    .track-genre {
        background: rgba(255, 102, 0, 0.2);
        color: #ff6600;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
    }

    .track-tips {
        color: #ffd700;
    }

    /* Audio Player */
    .player-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(10, 5, 0, 0.98) 0%, rgba(20, 10, 5, 0.95) 100%);
        border-top: 2px solid #ff6600;
        padding: 15px 20px;
        display: none;
        z-index: 1000;
    }

    .player-container.active {
        display: block;
    }

    .player-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .player-cover {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        background: #1a0a00;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }

    .player-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .player-info {
        flex: 1;
        min-width: 0;
    }

    .player-title {
        font-size: 14px;
        font-weight: bold;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .player-artist {
        font-size: 12px;
        color: #ff6600;
    }

    .player-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .player-btn {
        background: transparent;
        border: none;
        color: #ff6600;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .player-btn:hover {
        color: #ffa500;
        transform: scale(1.1);
    }

    .player-progress {
        flex: 2;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .player-progress-bar {
        flex: 1;
        height: 6px;
        background: #2a1a10;
        border-radius: 3px;
        cursor: pointer;
        position: relative;
    }

    .player-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6600 0%, #ffa500 100%);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s linear;
    }

    .player-time {
        font-size: 11px;
        color: #888;
        min-width: 40px;
    }

    .player-tip-btn {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .player-tip-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }

    /* Artist Registration Form */
    .artist-form {
        max-width: 500px;
        margin: 0 auto;
        background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(40, 20, 10, 0.3) 100%);
        border: 1px solid #3a2a1e;
        border-radius: 12px;
        padding: 30px;
    }

    .form-title {
        font-size: 20px;
        color: #ff6600;
        margin-bottom: 20px;
        text-align: center;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        color: #56ff9a;
        font-size: 12px;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #3a2a1e;
        padding: 12px 15px;
        border-radius: 8px;
        color: #fff;
        font-family: "Courier New", monospace;
        transition: all 0.3s;
    }

    .form-input:focus {
        outline: none;
        border-color: #ff6600;
        box-shadow: 0 0 10px rgba(255, 102, 0, 0.3);
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-submit {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #ff6600 0%, #ff8800 100%);
        border: none;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4);
    }

    /* Upload Form */
    .upload-area {
        border: 2px dashed #3a2a1e;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-area:hover {
        border-color: #ff6600;
        background: rgba(255, 102, 0, 0.05);
    }

    .upload-area.has-file {
        border-color: #00ff66;
        border-style: solid;
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    /* Search */
    .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
    }

    .search-input {
        flex: 1;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #3a2a1e;
        padding: 12px 20px;
        border-radius: 25px;
        color: #fff;
        font-family: "Courier New", monospace;
    }

    .search-input:focus {
        outline: none;
        border-color: #ff6600;
    }

    .genre-filter {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #3a2a1e;
        padding: 12px 20px;
        border-radius: 25px;
        color: #fff;
        cursor: pointer;
    }

    /* Artist Profile */
    .artist-profile {
        background: linear-gradient(135deg, rgba(255, 102, 0, 0.1) 0%, rgba(0, 0, 0, 0.5) 100%);
        border: 1px solid #ff6600;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .artist-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .artist-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6600 0%, #ffd700 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: #000;
    }

    .artist-name {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
    }

    .artist-stats {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }

    .artist-stat {
        text-align: center;
    }

    .artist-stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #ff6600;
    }

    .artist-stat-label {
        font-size: 11px;
        color: #888;
    }

    /* Message */
    .message-box {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .message-box.success {
        display: block;
        background: rgba(0, 255, 102, 0.1);
        border: 1px solid #00ff66;
        color: #00ff66;
    }

    .message-box.error {
        display: block;
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff0000;
        color: #ff6666;
    }
</style>
{% endblock %}

{% block content %}
<div class="music-container">
    <div class="music-header">
        <h1 class="music-title">ğŸµ Decent Music</h1>
        <p class="music-subtitle">
            <span class="lang-el">Î‘Ï€Î¿ÎºÎµÎ½Ï„ÏÏ‰Î¼Î­Î½Î· Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®Ï‚ - ÎšÎ±Î»Î»Î¹Ï„Î­Ï‡Î½ÎµÏ‚ ÎºÎµÏÎ´Î¯Î¶Î¿Ï…Î½ THR Î±Ï€ÏŒ ÎºÎ¬Î¸Îµ play!</span>
            <span class="lang-en">Decentralized music platform - Artists earn THR from every play!</span>
        </p>
    </div>

    <!-- Tabs -->
    <div class="music-tabs">
        <button class="music-tab active" onclick="showMusicTab('discover')">
            ğŸ”¥ <span class="lang-el">Î‘Î½Î±ÎºÎ¬Î»Ï…ÏˆÎ·</span><span class="lang-en">Discover</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('trending')">
            ğŸ“ˆ <span class="lang-el">Trending</span><span class="lang-en">Trending</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('artist')">
            ğŸ¤ <span class="lang-el">Î“Î¹Î± ÎšÎ±Î»Î»Î¹Ï„Î­Ï‡Î½ÎµÏ‚</span><span class="lang-en">For Artists</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('upload')">
            â¬†ï¸ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span class="lang-en">Upload</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('my-profile')">
            ğŸ‘¤ <span class="lang-el">Î¤Î¿ Î ÏÎ¿Ï†Î¯Î» Î¼Î¿Ï…</span><span class="lang-en">My Profile</span>
        </button>
    </div>

    <!-- Discover Tab -->
    <div id="discover-tab" class="tab-content active">
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search tracks, artists..." onkeyup="handleSearch(event)">
            <select class="genre-filter" id="genreFilter" onchange="filterByGenre()">
                <option value="">All Genres</option>
                <option value="Electronic">Electronic</option>
                <option value="Hip-Hop">Hip-Hop</option>
                <option value="Rock">Rock</option>
                <option value="Pop">Pop</option>
                <option value="Classical">Classical</option>
                <option value="Jazz">Jazz</option>
                <option value="Ambient">Ambient</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div id="tracksGrid" class="tracks-grid"></div>
        <div id="tracksEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸµ</div>
            <p><span class="lang-el">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„ÏÎ±Î³Î¿ÏÎ´Î¹Î± Î±ÎºÏŒÎ¼Î±</span><span class="lang-en">No tracks yet</span></p>
        </div>
    </div>

    <!-- Trending Tab -->
    <div id="trending-tab" class="tab-content">
        <div id="trendingGrid" class="tracks-grid"></div>
    </div>

    <!-- Artist Registration Tab -->
    <div id="artist-tab" class="tab-content">
        <div class="artist-form">
            <h2 class="form-title">ğŸ¤ <span class="lang-el">Î“Î¯Î½Îµ ÎšÎ±Î»Î»Î¹Ï„Î­Ï‡Î½Î·Ï‚</span><span class="lang-en">Become an Artist</span></h2>
            <p style="color: #888; font-size: 12px; text-align: center; margin-bottom: 20px;">
                <span class="lang-el">ÎšÎ­ÏÎ´Î¹ÏƒÎµ 0.0001 THR Î³Î¹Î± ÎºÎ¬Î¸Îµ play + tips Î±Ï€ÏŒ Î±ÎºÏÎ¿Î±Ï„Î­Ï‚!</span>
                <span class="lang-en">Earn 0.0001 THR per play + tips from listeners!</span>
            </p>
            <div id="artistMessage" class="message-box"></div>
            <form id="artistForm" onsubmit="registerArtist(event)">
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">ÎšÎ±Î»Î»Î¹Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÎŒÎ½Î¿Î¼Î±</span><span class="lang-en">Artist Name</span>
                    </label>
                    <input type="text" class="form-input" id="artistName" required minlength="2" placeholder="Your stage name">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î’Î¹Î¿Î³ÏÎ±Ï†Î¹ÎºÏŒ</span><span class="lang-en">Bio</span>
                    </label>
                    <textarea class="form-input form-textarea" id="artistBio" placeholder="Tell us about yourself..."></textarea>
                </div>
                <button type="submit" class="form-submit">
                    ğŸš€ <span class="lang-el">Î•Î³Î³ÏÎ±Ï†Î®</span><span class="lang-en">Register</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Upload Tab -->
    <div id="upload-tab" class="tab-content">
        <div class="artist-form">
            <h2 class="form-title">â¬†ï¸ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎµ Î¤ÏÎ±Î³Î¿ÏÎ´Î¹</span><span class="lang-en">Upload Track</span></h2>
            <div id="uploadMessage" class="message-box"></div>
            <form id="uploadForm" onsubmit="uploadTrack(event)">
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î¤Î¯Ï„Î»Î¿Ï‚</span><span class="lang-en">Title</span>
                    </label>
                    <input type="text" class="form-input" id="trackTitle" required minlength="2" placeholder="Track title">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î•Î¯Î´Î¿Ï‚</span><span class="lang-en">Genre</span>
                    </label>
                    <select class="form-input" id="trackGenre">
                        <option value="Electronic">Electronic</option>
                        <option value="Hip-Hop">Hip-Hop</option>
                        <option value="Rock">Rock</option>
                        <option value="Pop">Pop</option>
                        <option value="Classical">Classical</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Ambient">Ambient</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</span><span class="lang-en">Description</span>
                    </label>
                    <textarea class="form-input form-textarea" id="trackDescription" placeholder="About this track..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î‘ÏÏ‡ÎµÎ¯Î¿ Î‰Ï‡Î¿Ï…</span><span class="lang-en">Audio File</span>
                    </label>
                    <div class="upload-area" id="audioUploadArea" onclick="document.getElementById('audioFile').click()">
                        <div class="upload-icon">ğŸµ</div>
                        <p><span class="lang-el">ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î® (MP3, WAV, OGG, FLAC)</span>
                        <span class="lang-en">Click to select (MP3, WAV, OGG, FLAC)</span></p>
                        <input type="file" id="audioFile" accept=".mp3,.wav,.ogg,.flac,.m4a" style="display: none;" onchange="handleAudioSelect(event)">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î•Î¾ÏÏ†Ï…Î»Î»Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</span><span class="lang-en">Cover Art (optional)</span>
                    </label>
                    <div class="upload-area" id="coverUploadArea" onclick="document.getElementById('coverFile').click()">
                        <div class="upload-icon">ğŸ–¼ï¸</div>
                        <p><span class="lang-el">ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÎ¾ÏÏ†Ï…Î»Î»Î¿</span>
                        <span class="lang-en">Click to add cover</span></p>
                        <input type="file" id="coverFile" accept="image/*" style="display: none;" onchange="handleCoverSelect(event)">
                    </div>
                </div>
                <button type="submit" class="form-submit" id="uploadBtn">
                    ğŸš€ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span class="lang-en">Upload</span>
                </button>
            </form>
        </div>
    </div>

    <!-- My Profile Tab -->
    <div id="my-profile-tab" class="tab-content">
        <div id="myArtistProfile"></div>
        <h3 style="color: #ff6600; margin: 20px 0;"><span class="lang-el">Î¤Î± Î¤ÏÎ±Î³Î¿ÏÎ´Î¹Î± Î¼Î¿Ï…</span><span class="lang-en">My Tracks</span></h3>
        <div id="myTracksGrid" class="tracks-grid"></div>
    </div>
</div>

<!-- Audio Player -->
<div class="player-container" id="playerContainer">
    <div class="player-content">
        <div class="player-cover" id="playerCover">ğŸµ</div>
        <div class="player-info">
            <div class="player-title" id="playerTitle">-</div>
            <div class="player-artist" id="playerArtist">-</div>
        </div>
        <div class="player-controls">
            <button class="player-btn" onclick="seekBack()">âª</button>
            <button class="player-btn" onclick="togglePlay()" id="playPauseBtn">â–¶ï¸</button>
            <button class="player-btn" onclick="seekForward()">â©</button>
        </div>
        <div class="player-progress">
            <span class="player-time" id="currentTime">0:00</span>
            <div class="player-progress-bar" onclick="seekTo(event)">
                <div class="player-progress-fill" id="progressFill"></div>
            </div>
            <span class="player-time" id="totalTime">0:00</span>
        </div>
        <button class="player-tip-btn" onclick="tipArtist()">
            ğŸ’° <span class="lang-el">Tip</span><span class="lang-en">Tip</span>
        </button>
    </div>
</div>

<audio id="audioPlayer" style="display: none;"></audio>
{% endblock %}

{% block scripts %}
<script>
let allTracks = [];
let currentTrack = null;
let audioElement = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    audioElement = document.getElementById('audioPlayer');
    setupAudioListeners();
    loadTracks();
});

function setupAudioListeners() {
    audioElement.addEventListener('timeupdate', updateProgress);
    audioElement.addEventListener('loadedmetadata', () => {
        document.getElementById('totalTime').textContent = formatTime(audioElement.duration);
    });
    audioElement.addEventListener('ended', () => {
        document.getElementById('playPauseBtn').textContent = 'â–¶ï¸';
    });
}

function showMusicTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.music-tab').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'trending') loadTrending();
    if (tabName === 'my-profile') loadMyProfile();
}

async function loadTracks() {
    try {
        const res = await fetch('/api/v1/music/tracks');
        const data = await res.json();
        if (data.status === 'success') {
            allTracks = data.tracks;
            renderTracks(allTracks, 'tracksGrid');
        }
    } catch (e) {
        console.error('Error loading tracks:', e);
    }
}

async function loadTrending() {
    try {
        const res = await fetch('/api/v1/music/tracks/trending');
        const data = await res.json();
        if (data.status === 'success') {
            renderTracks(data.tracks, 'trendingGrid');
        }
    } catch (e) {
        console.error('Error loading trending:', e);
    }
}

function renderTracks(tracks, containerId) {
    const container = document.getElementById(containerId);
    const emptyEl = document.getElementById('tracksEmpty');

    if (!tracks || tracks.length === 0) {
        container.innerHTML = '';
        if (emptyEl) emptyEl.style.display = 'block';
        return;
    }

    if (emptyEl) emptyEl.style.display = 'none';

    container.innerHTML = tracks.map(track => `
        <div class="track-card">
            <div class="track-cover">
                ${track.cover_path || track.cover_url
                    ? `<img src="${track.cover_path ? '/media/' + track.cover_path : track.cover_url}" alt="${track.title}" onerror="this.src='/static/img/logo.png'">`
                    : 'ğŸµ'}
                <button class="track-play-btn" onclick="playTrack('${track.id}')">â–¶ï¸</button>
            </div>
            <div class="track-info">
                <div class="track-title">${track.title}</div>
                <div class="track-artist">${track.artist_name}</div>
                <div class="track-stats">
                    <span class="track-genre">${track.genre || 'Other'}</span>
                    <span>â–¶ï¸ ${track.play_count || 0}</span>
                    <span class="track-tips">ğŸ’° ${(track.tips_total || 0).toFixed(2)} THR</span>
                </div>
            </div>
        </div>
    `).join('');

    // Re-apply language
    const savedLang = localStorage.getItem('lang') || 'el';
    setLanguage(savedLang);
}

async function playTrack(trackId) {
    const track = allTracks.find(t => t.id === trackId);
    if (!track) return;

    currentTrack = track;

    // Record play
    const wallet = localStorage.getItem('thr_address');
    fetch(`/api/v1/music/play/${trackId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ listener_address: wallet || '' })
    });

    // Update player UI
    document.getElementById('playerTitle').textContent = track.title;
    document.getElementById('playerArtist').textContent = track.artist_name;
    const coverSrc = track.cover_path ? `/media/${track.cover_path}` : track.cover_url;
    document.getElementById('playerCover').innerHTML = coverSrc
        ? `<img src="${coverSrc}" onerror="this.src='/static/img/logo.png'">` : 'ğŸµ';
    document.getElementById('playerContainer').classList.add('active');

    // Play audio
    audioElement.src = track.audio_url;
    audioElement.play();
    document.getElementById('playPauseBtn').textContent = 'â¸ï¸';
}

function togglePlay() {
    if (!currentTrack) return;

    if (audioElement.paused) {
        audioElement.play();
        document.getElementById('playPauseBtn').textContent = 'â¸ï¸';
    } else {
        audioElement.pause();
        document.getElementById('playPauseBtn').textContent = 'â–¶ï¸';
    }
}

function updateProgress() {
    const progress = (audioElement.currentTime / audioElement.duration) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
}

function seekTo(e) {
    const bar = e.target.closest('.player-progress-bar');
    const rect = bar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    audioElement.currentTime = percent * audioElement.duration;
}

function seekBack() {
    audioElement.currentTime = Math.max(0, audioElement.currentTime - 10);
}

function seekForward() {
    audioElement.currentTime = Math.min(audioElement.duration, audioElement.currentTime + 10);
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

async function tipArtist() {
    if (!currentTrack) return;

    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        alert('Please connect your wallet first!');
        return;
    }

    const amount = prompt('Enter tip amount in THR:', '1');
    if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return;

    const authSecret = prompt('Enter your auth secret:');
    if (!authSecret) return;

    try {
        const res = await fetch('/api/v1/music/tip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                track_id: currentTrack.id,
                from_address: wallet,
                amount: parseFloat(amount),
                auth_secret: authSecret,
                passphrase: ''
            })
        });

        const data = await res.json();
        if (data.status === 'success') {
            alert(`âœ… Tip sent! ${amount} THR to ${currentTrack.artist_name}`);
        } else {
            alert(`âŒ Error: ${data.message}`);
        }
    } catch (e) {
        alert(`âŒ Error: ${e.message}`);
    }
}

async function registerArtist(e) {
    e.preventDefault();

    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        showMessage('artistMessage', 'Please connect your wallet first!', 'error');
        return;
    }

    const name = document.getElementById('artistName').value.trim();
    const bio = document.getElementById('artistBio').value.trim();

    try {
        const res = await fetch('/api/v1/music/register_artist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: wallet, name, bio })
        });

        const data = await res.json();
        if (data.status === 'success') {
            showMessage('artistMessage', 'âœ… Artist registration successful!', 'success');
            setTimeout(() => showMusicTab('upload'), 2000);
        } else {
            showMessage('artistMessage', `âŒ ${data.message}`, 'error');
        }
    } catch (e) {
        showMessage('artistMessage', `âŒ Error: ${e.message}`, 'error');
    }
}

let selectedAudio = null;
let selectedCover = null;

function handleAudioSelect(e) {
    const file = e.target.files[0];
    if (file) {
        selectedAudio = file;
        document.getElementById('audioUploadArea').classList.add('has-file');
        document.getElementById('audioUploadArea').innerHTML = `
            <div class="upload-icon">âœ…</div>
            <p>${file.name}</p>
        `;
    }
}

function handleCoverSelect(e) {
    const file = e.target.files[0];
    if (file) {
        selectedCover = file;
        document.getElementById('coverUploadArea').classList.add('has-file');
        document.getElementById('coverUploadArea').innerHTML = `
            <div class="upload-icon">âœ…</div>
            <p>${file.name}</p>
        `;
    }
}

async function uploadTrack(e) {
    e.preventDefault();

    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        showMessage('uploadMessage', 'Please connect your wallet first!', 'error');
        return;
    }

    if (!selectedAudio) {
        showMessage('uploadMessage', 'Please select an audio file!', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('artist_address', wallet);
    formData.append('title', document.getElementById('trackTitle').value.trim());
    formData.append('genre', document.getElementById('trackGenre').value);
    formData.append('description', document.getElementById('trackDescription').value.trim());
    formData.append('audio', selectedAudio);
    if (selectedCover) formData.append('cover', selectedCover);

    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('uploadBtn').textContent = 'â³ Uploading...';

    try {
        const res = await fetch('/api/v1/music/upload', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();
        if (data.status === 'success') {
            showMessage('uploadMessage', 'âœ… Track uploaded successfully!', 'success');
            document.getElementById('uploadForm').reset();
            selectedAudio = null;
            selectedCover = null;
            loadTracks();
        } else {
            showMessage('uploadMessage', `âŒ ${data.message}`, 'error');
        }
    } catch (e) {
        showMessage('uploadMessage', `âŒ Error: ${e.message}`, 'error');
    } finally {
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').innerHTML = 'ğŸš€ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span class="lang-en">Upload</span>';
    }
}

async function loadMyProfile() {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        document.getElementById('myArtistProfile').innerHTML = `
            <div class="empty-state">
                <p><span class="lang-el">Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚</span><span class="lang-en">Connect your wallet</span></p>
            </div>
        `;
        return;
    }

    try {
        const res = await fetch(`/api/v1/music/artist/${wallet}`);
        const data = await res.json();

        if (data.status === 'success' && data.artist.name) {
            document.getElementById('myArtistProfile').innerHTML = `
                <div class="artist-profile">
                    <div class="artist-header">
                        <div class="artist-avatar">${data.artist.name[0]}</div>
                        <div>
                            <div class="artist-name">${data.artist.name}</div>
                            <div style="color: #888; font-size: 12px;">${data.artist.bio || ''}</div>
                        </div>
                    </div>
                    <div class="artist-stats">
                        <div class="artist-stat">
                            <div class="artist-stat-value">${data.stats.total_tracks}</div>
                            <div class="artist-stat-label">Tracks</div>
                        </div>
                        <div class="artist-stat">
                            <div class="artist-stat-value">${data.stats.total_plays}</div>
                            <div class="artist-stat-label">Plays</div>
                        </div>
                        <div class="artist-stat">
                            <div class="artist-stat-value">${data.stats.total_earnings_thr.toFixed(4)}</div>
                            <div class="artist-stat-label">THR Earned</div>
                        </div>
                    </div>
                </div>
            `;

            renderTracks(data.tracks, 'myTracksGrid');
        } else {
            document.getElementById('myArtistProfile').innerHTML = `
                <div class="empty-state">
                    <p><span class="lang-el">Î”ÎµÎ½ ÎµÎ¯ÏƒÏ„Îµ ÎµÎ³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î¿Ï‚ ÎºÎ±Î»Î»Î¹Ï„Î­Ï‡Î½Î·Ï‚</span>
                    <span class="lang-en">Not registered as an artist yet</span></p>
                    <button onclick="showMusicTab('artist')" class="form-submit" style="max-width: 200px; margin-top: 20px;">
                        <span class="lang-el">Î•Î³Î³ÏÎ±Ï†Î®</span><span class="lang-en">Register</span>
                    </button>
                </div>
            `;
        }
    } catch (e) {
        console.error('Error loading profile:', e);
    }
}

function handleSearch(e) {
    if (e.key === 'Enter') {
        const query = document.getElementById('searchInput').value.trim();
        if (query) {
            searchTracks(query);
        } else {
            renderTracks(allTracks, 'tracksGrid');
        }
    }
}

async function searchTracks(query) {
    try {
        const res = await fetch(`/api/v1/music/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.status === 'success') {
            renderTracks(data.results, 'tracksGrid');
        }
    } catch (e) {
        console.error('Search error:', e);
    }
}

function filterByGenre() {
    const genre = document.getElementById('genreFilter').value;
    if (genre) {
        const filtered = allTracks.filter(t => t.genre === genre);
        renderTracks(filtered, 'tracksGrid');
    } else {
        renderTracks(allTracks, 'tracksGrid');
    }
}

function showMessage(elementId, message, type) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = `message-box ${type}`;
    setTimeout(() => { el.className = 'message-box'; }, 5000);
}
</script>
{% endblock %}
