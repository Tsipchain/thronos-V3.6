{% extends "base.html" %}

{% block title %}ğŸµ Decent Music - Thronos{% endblock %}

{% block styles %}
<style>
    .music-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 150px; /* FIX 4A: Prevent music player from being covered by footer widget */
    }

    .music-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .music-title {
        font-size: 36px;
        font-weight: bold;
        background: linear-gradient(135deg, #ff6600 0%, #00ff66 50%, #ffd700 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
        filter: drop-shadow(0 0 15px rgba(255, 102, 0, 0.4));
    }

    .music-subtitle {
        color: #56ff9a;
        font-size: 14px;
    }

    /* Tabs */
    .music-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #1a3b2e;
        flex-wrap: wrap;
    }

    .music-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #56ff9a;
        cursor: pointer;
        font-family: "Courier New", monospace;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .music-tab:hover {
        color: #00ff66;
    }

    .music-tab.active {
        color: #ff6600;
        border-bottom-color: #ff6600;
        background: linear-gradient(135deg, rgba(255, 102, 0, 0.1) 0%, rgba(255, 102, 0, 0.05) 100%);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Track Cards */
    .tracks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .track-card {
        background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(40, 20, 10, 0.3) 100%);
        border: 1px solid #3a2a1e;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s;
        cursor: pointer;
    }

    .track-card:hover {
        border-color: #ff6600;
        box-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
        transform: translateY(-3px);
    }

    /* QUEST: Now Playing Highlight */
    .track-card.now-playing {
        border: 2px solid #ff6600;
        background: linear-gradient(135deg, rgba(255, 102, 0, 0.2) 0%, rgba(255, 136, 0, 0.1) 100%);
        box-shadow: 0 0 30px rgba(255, 102, 0, 0.5);
        transform: scale(1.02);
    }

    .track-card.now-playing .track-title {
        color: #ff6600;
    }

    .track-card.now-playing::before {
        content: 'â–¶ï¸';
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 102, 0, 0.9);
        color: #000;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        z-index: 10;
        font-weight: bold;
    }

    .track-cover {
        width: 100%;
        height: 180px;
        background: linear-gradient(135deg, #1a0a00 0%, #2a1a10 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        position: relative;
    }

    .track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .track-play-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6600 0%, #ff8800 100%);
        border: none;
        color: #000;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4);
    }

    .track-play-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 102, 0, 0.6);
    }

    .track-info {
        padding: 15px;
    }

    .track-title {
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-artist {
        font-size: 13px;
        color: #ff6600;
        margin-bottom: 10px;
    }

    .track-stats {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
    }

    .track-genre {
        background: rgba(255, 102, 0, 0.2);
        color: #ff6600;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
    }

    .track-tips {
        color: #ffd700;
    }

    /* Audio Player - QUEST: Ensure it's visible and not behind footer */
    .player-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(10, 5, 0, 0.98) 0%, rgba(20, 10, 5, 0.95) 100%);
        border-top: 2px solid #ff6600;
        padding: 15px 20px;
        display: none;
        z-index: 2900; /* Above chain tokens widget (2800) */
        backdrop-filter: blur(10px);
    }

    .player-container.active {
        display: block;
    }

    .player-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .player-cover {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        background: #1a0a00;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }

    .player-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .player-info {
        flex: 1;
        min-width: 0;
    }

    .player-title {
        font-size: 14px;
        font-weight: bold;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .player-artist {
        font-size: 12px;
        color: #ff6600;
    }

    .player-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .player-btn {
        background: transparent;
        border: none;
        color: #ff6600;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .player-btn:hover {
        color: #ffa500;
        transform: scale(1.1);
    }

    .player-progress {
        flex: 2;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .player-progress-bar {
        flex: 1;
        height: 6px;
        background: #2a1a10;
        border-radius: 3px;
        cursor: pointer;
        position: relative;
    }

    .player-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6600 0%, #ffa500 100%);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s linear;
    }

    .player-time {
        font-size: 11px;
        color: #888;
        min-width: 40px;
    }

    .player-tip-btn {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .player-tip-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }

    /* Artist Registration Form */
    .artist-form {
        max-width: 500px;
        margin: 0 auto;
        background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(40, 20, 10, 0.3) 100%);
        border: 1px solid #3a2a1e;
        border-radius: 12px;
        padding: 30px;
    }

    .form-title {
        font-size: 20px;
        color: #ff6600;
        margin-bottom: 20px;
        text-align: center;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        color: #56ff9a;
        font-size: 12px;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #3a2a1e;
        padding: 12px 15px;
        border-radius: 8px;
        color: #fff;
        font-family: "Courier New", monospace;
        transition: all 0.3s;
    }

    .form-input:focus {
        outline: none;
        border-color: #ff6600;
        box-shadow: 0 0 10px rgba(255, 102, 0, 0.3);
    }

    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-submit {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #ff6600 0%, #ff8800 100%);
        border: none;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4);
    }

    /* Upload Form */
    .upload-area {
        border: 2px dashed #3a2a1e;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-area:hover {
        border-color: #ff6600;
        background: rgba(255, 102, 0, 0.05);
    }

    .upload-area.has-file {
        border-color: #00ff66;
        border-style: solid;
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    /* Search */
    .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
    }

    .search-input {
        flex: 1;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #3a2a1e;
        padding: 12px 20px;
        border-radius: 25px;
        color: #fff;
        font-family: "Courier New", monospace;
    }

    .search-input:focus {
        outline: none;
        border-color: #ff6600;
    }

    .genre-filter {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #3a2a1e;
        padding: 12px 20px;
        border-radius: 25px;
        color: #fff;
        cursor: pointer;
    }

    /* Artist Profile */
    .artist-profile {
        background: linear-gradient(135deg, rgba(255, 102, 0, 0.1) 0%, rgba(0, 0, 0, 0.5) 100%);
        border: 1px solid #ff6600;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .artist-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .artist-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6600 0%, #ffd700 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: #000;
    }

    .artist-name {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
    }

    .artist-stats {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }

    .artist-stat {
        text-align: center;
    }

    .artist-stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #ff6600;
    }

    .artist-stat-label {
        font-size: 11px;
        color: #888;
    }

    /* Message */
    .message-box {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .message-box.success {
        display: block;
        background: rgba(0, 255, 102, 0.1);
        border: 1px solid #00ff66;
        color: #00ff66;
    }

    .message-box.error {
        display: block;
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff0000;
        color: #ff6666;
    }
</style>
{% endblock %}

{% block content %}
<div class="music-container">
    <div class="music-header">
        <h1 class="music-title">ğŸµ Decent Music</h1>
        <p class="music-subtitle">
            <span class="lang-el">Î‘Ï€Î¿ÎºÎµÎ½Ï„ÏÏ‰Î¼Î­Î½Î· Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®Ï‚ - ÎšÎ±Î»Î»Î¹Ï„Î­Ï‡Î½ÎµÏ‚ ÎºÎµÏÎ´Î¯Î¶Î¿Ï…Î½ THR Î±Ï€ÏŒ ÎºÎ¬Î¸Îµ play!</span>
            <span class="lang-en">Decentralized music platform - Artists earn THR from every play!</span>
        </p>
    </div>

    <!-- Tabs -->
    <div class="music-tabs">
        <button class="music-tab active" onclick="showMusicTab('discover')">
            ğŸ”¥ <span class="lang-el">Î‘Î½Î±ÎºÎ¬Î»Ï…ÏˆÎ·</span><span class="lang-en">Discover</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('trending')">
            ğŸ“ˆ <span class="lang-el">Trending</span><span class="lang-en">Trending</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('artist')">
            ğŸ¤ <span class="lang-el">Î“Î¹Î± ÎšÎ±Î»Î»Î¹Ï„Î­Ï‡Î½ÎµÏ‚</span><span class="lang-en">For Artists</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('upload')">
            â¬†ï¸ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span class="lang-en">Upload</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('my-profile')">
            ğŸ‘¤ <span class="lang-el">Î¤Î¿ Î ÏÎ¿Ï†Î¯Î» Î¼Î¿Ï…</span><span class="lang-en">My Profile</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('playlists')">
            ğŸ“‹ <span class="lang-el">Playlists</span><span class="lang-en">Playlists</span>
        </button>
        <button class="music-tab" onclick="showMusicTab('offline')">
            ğŸ“¥ <span class="lang-el">Offline</span><span class="lang-en">Offline</span>
        </button>
    </div>

    <!-- Discover Tab -->
    <div id="discover-tab" class="tab-content active">
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search tracks, artists..." onkeyup="handleSearch(event)">
            <select class="genre-filter" id="genreFilter" onchange="filterByGenre()">
                <option value="">All Genres</option>
                <option value="Electronic">Electronic</option>
                <option value="Hip-Hop">Hip-Hop</option>
                <option value="Rock">Rock</option>
                <option value="Pop">Pop</option>
                <option value="Classical">Classical</option>
                <option value="Jazz">Jazz</option>
                <option value="Ambient">Ambient</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div id="tracksGrid" class="tracks-grid"></div>
        <div id="tracksEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸµ</div>
            <p><span class="lang-el">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„ÏÎ±Î³Î¿ÏÎ´Î¹Î± Î±ÎºÏŒÎ¼Î±</span><span class="lang-en">No tracks yet</span></p>
        </div>
    </div>

    <!-- Trending Tab -->
    <div id="trending-tab" class="tab-content">
        <div id="trendingGrid" class="tracks-grid"></div>
    </div>

    <!-- Artist Registration Tab -->
    <div id="artist-tab" class="tab-content">
        <div class="artist-form">
            <h2 class="form-title">ğŸ¤ <span class="lang-el">Î“Î¯Î½Îµ ÎšÎ±Î»Î»Î¹Ï„Î­Ï‡Î½Î·Ï‚</span><span class="lang-en">Become an Artist</span></h2>
            <p style="color: #888; font-size: 12px; text-align: center; margin-bottom: 20px;">
                <span class="lang-el">ÎšÎ­ÏÎ´Î¹ÏƒÎµ 0.0001 THR Î³Î¹Î± ÎºÎ¬Î¸Îµ play + tips Î±Ï€ÏŒ Î±ÎºÏÎ¿Î±Ï„Î­Ï‚!</span>
                <span class="lang-en">Earn 0.0001 THR per play + tips from listeners!</span>
            </p>
            <div id="artistMessage" class="message-box"></div>
            <form id="artistForm" onsubmit="registerArtist(event)">
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">ÎšÎ±Î»Î»Î¹Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÎŒÎ½Î¿Î¼Î±</span><span class="lang-en">Artist Name</span>
                    </label>
                    <input type="text" class="form-input" id="artistName" required minlength="2" placeholder="Your stage name">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î’Î¹Î¿Î³ÏÎ±Ï†Î¹ÎºÏŒ</span><span class="lang-en">Bio</span>
                    </label>
                    <textarea class="form-input form-textarea" id="artistBio" placeholder="Tell us about yourself..."></textarea>
                </div>
                <button type="submit" class="form-submit">
                    ğŸš€ <span class="lang-el">Î•Î³Î³ÏÎ±Ï†Î®</span><span class="lang-en">Register</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Upload Tab -->
    <div id="upload-tab" class="tab-content">
        <div class="artist-form">
            <h2 class="form-title">â¬†ï¸ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎµ Î¤ÏÎ±Î³Î¿ÏÎ´Î¹</span><span class="lang-en">Upload Track</span></h2>
            <div id="uploadMessage" class="message-box"></div>
            <form id="uploadForm" onsubmit="uploadTrack(event)">
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î¤Î¯Ï„Î»Î¿Ï‚</span><span class="lang-en">Title</span>
                    </label>
                    <input type="text" class="form-input" id="trackTitle" required minlength="2" placeholder="Track title">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î•Î¯Î´Î¿Ï‚</span><span class="lang-en">Genre</span>
                    </label>
                    <select class="form-input" id="trackGenre">
                        <option value="Electronic">Electronic</option>
                        <option value="Hip-Hop">Hip-Hop</option>
                        <option value="Rock">Rock</option>
                        <option value="Pop">Pop</option>
                        <option value="Classical">Classical</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Ambient">Ambient</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</span><span class="lang-en">Description</span>
                    </label>
                    <textarea class="form-input form-textarea" id="trackDescription" placeholder="About this track..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î‘ÏÏ‡ÎµÎ¯Î¿ Î‰Ï‡Î¿Ï…</span><span class="lang-en">Audio File</span>
                    </label>
                    <div class="upload-area" id="audioUploadArea" onclick="document.getElementById('audioFile').click()">
                        <div class="upload-icon">ğŸµ</div>
                        <p><span class="lang-el">ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î® (MP3, WAV, OGG, FLAC)</span>
                        <span class="lang-en">Click to select (MP3, WAV, OGG, FLAC)</span></p>
                        <input type="file" id="audioFile" accept=".mp3,.wav,.ogg,.flac,.m4a" style="display: none;" onchange="handleAudioSelect(event)">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span class="lang-el">Î•Î¾ÏÏ†Ï…Î»Î»Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</span><span class="lang-en">Cover Art (optional)</span>
                    </label>
                    <div class="upload-area" id="coverUploadArea" onclick="document.getElementById('coverFile').click()">
                        <div class="upload-icon">ğŸ–¼ï¸</div>
                        <p><span class="lang-el">ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÎ¾ÏÏ†Ï…Î»Î»Î¿</span>
                        <span class="lang-en">Click to add cover</span></p>
                        <input type="file" id="coverFile" accept="image/*" style="display: none;" onchange="handleCoverSelect(event)">
                    </div>
                </div>
                <button type="submit" class="form-submit" id="uploadBtn">
                    ğŸš€ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span class="lang-en">Upload</span>
                </button>
            </form>
        </div>
    </div>

    <!-- My Profile Tab -->
    <div id="my-profile-tab" class="tab-content">
        <div id="myArtistProfile"></div>
        <h3 style="color: #ff6600; margin: 20px 0;"><span class="lang-el">Î¤Î± Î¤ÏÎ±Î³Î¿ÏÎ´Î¹Î± Î¼Î¿Ï…</span><span class="lang-en">My Tracks</span></h3>
        <div id="myTracksGrid" class="tracks-grid"></div>
    </div>

    <!-- Playlists Tab -->
    <div id="playlists-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #ff6600; margin: 0;"><span class="lang-el">ÎŸÎ¹ Playlists Î¼Î¿Ï…</span><span class="lang-en">My Playlists</span></h3>
            <button class="form-submit" style="width: auto; padding: 10px 20px;" onclick="createNewPlaylist()">
                â• <span class="lang-el">ÎÎ­Î± Playlist</span><span class="lang-en">New Playlist</span>
            </button>
        </div>
        <div id="playlistsContainer"></div>
    </div>

    <!-- Offline Tab -->
    <div id="offline-tab" class="tab-content">
        <h3 style="color: #ff6600; margin-bottom: 20px;">
            ğŸ“¥ <span class="lang-el">Î¤ÏÎ±Î³Î¿ÏÎ´Î¹Î± Offline</span><span class="lang-en">Offline Tracks</span>
        </h3>
        <p style="color: #888; font-size: 13px; margin-bottom: 20px;">
            <span class="lang-el">Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏƒÏ„Îµ Ï„ÏÎ±Î³Î¿ÏÎ´Î¹Î± Î³Î¹Î± offline Î±ÎºÏÏŒÎ±ÏƒÎ·. Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ ÏƒÏ„ÎµÎ¯Î»Ï„Îµ 0.01 THR tip ÏƒÏ„Î¿Î½ ÎºÎ±Î»Î»Î¹Ï„Î­Ï‡Î½Î·!</span>
            <span class="lang-en">Save tracks for offline listening. Optionally send 0.01 THR tip to the artist!</span>
        </p>
        <div id="offlineTracksGrid" class="tracks-grid"></div>
        <div id="offlineEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ“¥</div>
            <p><span class="lang-el">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Ï„ÏÎ±Î³Î¿ÏÎ´Î¹Î± Î³Î¹Î± offline</span><span class="lang-en">No offline tracks saved yet</span></p>
        </div>
    </div>
</div>

<!-- Audio Player -->
<div class="player-container" id="playerContainer">
    <div class="player-content">
        <div class="player-cover" id="playerCover">ğŸµ</div>
        <div class="player-info">
            <div class="player-title" id="playerTitle">-</div>
            <div class="player-artist" id="playerArtist">-</div>
        </div>
        <div class="player-controls">
            <button class="player-btn" onclick="seekBack()">âª</button>
            <button class="player-btn" onclick="togglePlay()" id="playPauseBtn">â–¶ï¸</button>
            <button class="player-btn" onclick="seekForward()">â©</button>
        </div>
        <div class="player-progress">
            <span class="player-time" id="currentTime">0:00</span>
            <div class="player-progress-bar" onclick="seekTo(event)">
                <div class="player-progress-fill" id="progressFill"></div>
            </div>
            <span class="player-time" id="totalTime">0:00</span>
        </div>
        <button class="player-tip-btn" onclick="tipArtist()">
            ğŸ’° <span class="lang-el">Tip</span><span class="lang-en">Tip</span>
        </button>
    </div>
</div>

<audio id="audioPlayer" style="display: none;"></audio>
{% endblock %}

{% block scripts %}
<script>
let allTracks = [];
let currentTrack = null;
let audioElement = null;
let userPlaylists = [];
let offlineTracks = [];

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    audioElement = document.getElementById('audioPlayer');
    setupAudioListeners();
    loadTracks();
});

function setupAudioListeners() {
    audioElement.addEventListener('timeupdate', updateProgress);
    audioElement.addEventListener('loadedmetadata', () => {
        document.getElementById('totalTime').textContent = formatTime(audioElement.duration);
    });
    audioElement.addEventListener('ended', () => {
        document.getElementById('playPauseBtn').textContent = 'â–¶ï¸';
    });
}

function showMusicTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.music-tab').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'trending') loadTrending();
    if (tabName === 'my-profile') loadMyProfile();
    if (tabName === 'playlists') loadPlaylists();
    if (tabName === 'offline') loadOfflineTracks();
}

async function loadTracks() {
    try {
        const res = await fetch('/api/v1/music/tracks');
        const data = await res.json();
        if (data.status === 'success') {
            allTracks = data.tracks;
            renderTracks(allTracks, 'tracksGrid');
        }
    } catch (e) {
        console.error('Error loading tracks:', e);
    }
}

async function loadTrending() {
    try {
        const res = await fetch('/api/v1/music/tracks/trending');
        const data = await res.json();
        if (data.status === 'success') {
            renderTracks(data.tracks, 'trendingGrid');
        }
    } catch (e) {
        console.error('Error loading trending:', e);
    }
}

function renderTracks(tracks, containerId) {
    const container = document.getElementById(containerId);
    const emptyEl = document.getElementById('tracksEmpty');

    if (!tracks || tracks.length === 0) {
        container.innerHTML = '';
        if (emptyEl) emptyEl.style.display = 'block';
        return;
    }

    if (emptyEl) emptyEl.style.display = 'none';

    container.innerHTML = tracks.map(track => `
        <div class="track-card ${currentTrack && currentTrack.id === track.id ? 'now-playing' : ''}"
             data-track-id="${track.id}">
            <div class="track-cover" onclick="playTrack('${track.id}')">
                ${track.cover_path || track.cover_url
                    ? `<img src="${track.cover_path ? '/media/' + track.cover_path : track.cover_url}" alt="${track.title}" onerror="this.src='/static/img/logo.png'">`
                    : 'ğŸµ'}
                <button class="track-play-btn" onclick="event.stopPropagation(); playTrack('${track.id}')">â–¶ï¸</button>
            </div>
            <div class="track-info" onclick="playTrack('${track.id}')">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div class="track-title">${track.title}</div>
                        <div class="track-artist">${track.artist_name}</div>
                    </div>
                    <button class="player-btn" style="font-size: 16px; padding: 4px;" onclick="event.stopPropagation(); showTrackOptions('${track.id}')">â‹®</button>
                </div>
                <div class="track-stats">
                    <span class="track-genre">${track.genre || 'Other'}</span>
                    <span>â–¶ï¸ ${track.play_count || 0}</span>
                    <span class="track-tips">ğŸ’° ${(track.tips_total || 0).toFixed(2)} THR</span>
                </div>
            </div>
        </div>
    `).join('');

    // Re-apply language
    const savedLang = localStorage.getItem('lang') || 'el';
    setLanguage(savedLang);
}

async function playTrack(trackId) {
    const track = allTracks.find(t => t.id === trackId);
    if (!track) return;

    currentTrack = track;

    // QUEST: Remove highlight from all tracks, add to current
    document.querySelectorAll('.track-card').forEach(card => {
        card.classList.remove('now-playing');
    });
    document.querySelectorAll(`[data-track-id="${trackId}"]`).forEach(card => {
        card.classList.add('now-playing');
    });

    // Record play
    const wallet = localStorage.getItem('thr_address');
    fetch(`/api/v1/music/play/${trackId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ listener_address: wallet || '' })
    });

    // Update player UI
    document.getElementById('playerTitle').textContent = track.title;
    document.getElementById('playerArtist').textContent = track.artist_name;
    const coverSrc = track.cover_path ? `/media/${track.cover_path}` : track.cover_url;
    document.getElementById('playerCover').innerHTML = coverSrc
        ? `<img src="${coverSrc}" onerror="this.src='/static/img/logo.png'">` : 'ğŸµ';
    document.getElementById('playerContainer').classList.add('active');

    // Play audio
    audioElement.src = track.audio_url;
    audioElement.play();
    document.getElementById('playPauseBtn').textContent = 'â¸ï¸';

    // QUEST: Scroll player into view if needed
    setTimeout(() => {
        const playerEl = document.getElementById('playerContainer');
        if (playerEl && playerEl.classList.contains('active')) {
            playerEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }, 100);
}

function togglePlay() {
    if (!currentTrack) return;

    if (audioElement.paused) {
        audioElement.play();
        document.getElementById('playPauseBtn').textContent = 'â¸ï¸';
    } else {
        audioElement.pause();
        document.getElementById('playPauseBtn').textContent = 'â–¶ï¸';
    }
}

function updateProgress() {
    const progress = (audioElement.currentTime / audioElement.duration) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
}

function seekTo(e) {
    const bar = e.target.closest('.player-progress-bar');
    const rect = bar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    audioElement.currentTime = percent * audioElement.duration;
}

function seekBack() {
    audioElement.currentTime = Math.max(0, audioElement.currentTime - 10);
}

function seekForward() {
    audioElement.currentTime = Math.min(audioElement.duration, audioElement.currentTime + 10);
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

async function tipArtist() {
    // PR-5a: Use WalletAuth for PIN-based unlock (no auth_secret prompt)
    if (!currentTrack) return;

    const amount = prompt('Enter tip amount in THR:', '1');
    if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return;

    try {
        // PR-5a: Require unlocked wallet (PIN if locked)
        const { address, authSecret } = await window.WalletAuth.requireUnlockedWallet();

        const res = await fetch('/api/v1/music/tip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                track_id: currentTrack.id,
                from_address: address,
                amount: parseFloat(amount),
                auth_secret: authSecret,
                passphrase: ''
            })
        });

        const data = await res.json();
        if (data.status === 'success') {
            alert(`âœ… Tip sent! ${amount} THR to ${currentTrack.artist_name}`);
        } else {
            alert(`âŒ Error: ${data.message}`);
        }
    } catch (e) {
        // PR-5a: Handle wallet auth errors
        if (e.code === 'WALLET_NOT_CONNECTED') {
            alert('âŒ Please connect your wallet first!');
        } else if (e.code === 'WALLET_LOCKED') {
            alert('âŒ Wallet is locked. Please unlock with your PIN.');
        } else {
            alert(`âŒ Error: ${e.message}`);
        }
    }
}

async function registerArtist(e) {
    e.preventDefault();

    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        showMessage('artistMessage', 'Please connect your wallet first!', 'error');
        return;
    }

    const name = document.getElementById('artistName').value.trim();
    const bio = document.getElementById('artistBio').value.trim();

    try {
        const res = await fetch('/api/v1/music/register_artist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: wallet, name, bio })
        });

        const data = await res.json();
        if (data.status === 'success') {
            showMessage('artistMessage', 'âœ… Artist registration successful!', 'success');
            setTimeout(() => showMusicTab('upload'), 2000);
        } else {
            showMessage('artistMessage', `âŒ ${data.message}`, 'error');
        }
    } catch (e) {
        showMessage('artistMessage', `âŒ Error: ${e.message}`, 'error');
    }
}

let selectedAudio = null;
let selectedCover = null;

function handleAudioSelect(e) {
    const file = e.target.files[0];
    if (file) {
        selectedAudio = file;
        document.getElementById('audioUploadArea').classList.add('has-file');
        document.getElementById('audioUploadArea').innerHTML = `
            <div class="upload-icon">âœ…</div>
            <p>${file.name}</p>
        `;
    }
}

function handleCoverSelect(e) {
    const file = e.target.files[0];
    if (file) {
        selectedCover = file;
        document.getElementById('coverUploadArea').classList.add('has-file');
        document.getElementById('coverUploadArea').innerHTML = `
            <div class="upload-icon">âœ…</div>
            <p>${file.name}</p>
        `;
    }
}

async function uploadTrack(e) {
    e.preventDefault();

    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        showMessage('uploadMessage', 'Please connect your wallet first!', 'error');
        return;
    }

    if (!selectedAudio) {
        showMessage('uploadMessage', 'Please select an audio file!', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('artist_address', wallet);
    formData.append('title', document.getElementById('trackTitle').value.trim());
    formData.append('genre', document.getElementById('trackGenre').value);
    formData.append('description', document.getElementById('trackDescription').value.trim());
    formData.append('audio', selectedAudio);
    if (selectedCover) formData.append('cover', selectedCover);

    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('uploadBtn').textContent = 'â³ Uploading...';

    try {
        const res = await fetch('/api/v1/music/upload', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();
        if (data.status === 'success') {
            showMessage('uploadMessage', 'âœ… Track uploaded successfully!', 'success');
            document.getElementById('uploadForm').reset();
            selectedAudio = null;
            selectedCover = null;
            loadTracks();
        } else {
            showMessage('uploadMessage', `âŒ ${data.message}`, 'error');
        }
    } catch (e) {
        showMessage('uploadMessage', `âŒ Error: ${e.message}`, 'error');
    } finally {
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').innerHTML = 'ğŸš€ <span class="lang-el">Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span class="lang-en">Upload</span>';
    }
}

async function loadMyProfile() {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        document.getElementById('myArtistProfile').innerHTML = `
            <div class="empty-state">
                <p><span class="lang-el">Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚</span><span class="lang-en">Connect your wallet</span></p>
            </div>
        `;
        return;
    }

    try {
        const res = await fetch(`/api/v1/music/artist/${wallet}`);
        const data = await res.json();

        if (data.status === 'success' && data.artist.name) {
            document.getElementById('myArtistProfile').innerHTML = `
                <div class="artist-profile">
                    <div class="artist-header">
                        <div class="artist-avatar">${data.artist.name[0]}</div>
                        <div>
                            <div class="artist-name">${data.artist.name}</div>
                            <div style="color: #888; font-size: 12px;">${data.artist.bio || ''}</div>
                        </div>
                    </div>
                    <div class="artist-stats">
                        <div class="artist-stat">
                            <div class="artist-stat-value">${data.stats.total_tracks}</div>
                            <div class="artist-stat-label">Tracks</div>
                        </div>
                        <div class="artist-stat">
                            <div class="artist-stat-value">${data.stats.total_plays}</div>
                            <div class="artist-stat-label">Plays</div>
                        </div>
                        <div class="artist-stat">
                            <div class="artist-stat-value">${data.stats.total_earnings_thr.toFixed(4)}</div>
                            <div class="artist-stat-label">THR Earned</div>
                        </div>
                    </div>
                </div>
            `;

            renderTracks(data.tracks, 'myTracksGrid');
        } else {
            document.getElementById('myArtistProfile').innerHTML = `
                <div class="empty-state">
                    <p><span class="lang-el">Î”ÎµÎ½ ÎµÎ¯ÏƒÏ„Îµ ÎµÎ³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î¿Ï‚ ÎºÎ±Î»Î»Î¹Ï„Î­Ï‡Î½Î·Ï‚</span>
                    <span class="lang-en">Not registered as an artist yet</span></p>
                    <button onclick="showMusicTab('artist')" class="form-submit" style="max-width: 200px; margin-top: 20px;">
                        <span class="lang-el">Î•Î³Î³ÏÎ±Ï†Î®</span><span class="lang-en">Register</span>
                    </button>
                </div>
            `;
        }
    } catch (e) {
        console.error('Error loading profile:', e);
    }
}

function handleSearch(e) {
    if (e.key === 'Enter') {
        const query = document.getElementById('searchInput').value.trim();
        if (query) {
            searchTracks(query);
        } else {
            renderTracks(allTracks, 'tracksGrid');
        }
    }
}

async function searchTracks(query) {
    try {
        const res = await fetch(`/api/v1/music/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.status === 'success') {
            renderTracks(data.results, 'tracksGrid');
        }
    } catch (e) {
        console.error('Search error:', e);
    }
}

function filterByGenre() {
    const genre = document.getElementById('genreFilter').value;
    if (genre) {
        const filtered = allTracks.filter(t => t.genre === genre);
        renderTracks(filtered, 'tracksGrid');
    } else {
        renderTracks(allTracks, 'tracksGrid');
    }
}

function showMessage(elementId, message, type) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = `message-box ${type}`;
    setTimeout(() => { el.className = 'message-box'; }, 5000);
}

// ========== PLAYLISTS & OFFLINE FUNCTIONALITY ==========

async function loadPlaylists() {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        document.getElementById('playlistsContainer').innerHTML = `
            <div class="empty-state">
                <p><span class="lang-el">Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Ï„Î¿ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ ÏƒÎ±Ï‚</span><span class="lang-en">Connect your wallet</span></p>
            </div>
        `;
        return;
    }

    try {
        const res = await fetch(`/api/music/playlists/${wallet}`);
        const data = await res.json();

        if (data.ok && data.playlists && data.playlists.length > 0) {
            userPlaylists = data.playlists;
            renderPlaylists();
        } else {
            document.getElementById('playlistsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p><span class="lang-el">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ playlists Î±ÎºÏŒÎ¼Î±</span><span class="lang-en">No playlists yet</span></p>
                </div>
            `;
        }
    } catch (e) {
        console.error('Error loading playlists:', e);
    }
}

function renderPlaylists() {
    const container = document.getElementById('playlistsContainer');
    container.innerHTML = userPlaylists.map(playlist => `
        <div class="artist-profile" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="color: #ff6600; margin: 0;">${playlist.name}</h4>
                <div>
                    <button class="player-btn" style="font-size: 16px;" onclick="viewPlaylist('${playlist.id}')">â–¶ï¸</button>
                    <button class="player-btn" style="font-size: 16px;" onclick="deletePlaylist('${playlist.id}')">ğŸ—‘ï¸</button>
                </div>
            </div>
            <p style="color: #888; font-size: 12px; margin: 10px 0 0 0;">
                ${playlist.tracks ? playlist.tracks.length : 0} tracks Â· Created ${new Date(playlist.created_at).toLocaleDateString()}
            </p>
        </div>
    `).join('');
}

async function createNewPlaylist() {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        alert('Please connect your wallet first!');
        return;
    }

    const name = prompt('Enter playlist name:');
    if (!name || !name.trim()) return;

    try {
        const res = await fetch(`/api/music/playlists/${wallet}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name.trim() })
        });

        const data = await res.json();
        if (data.ok) {
            alert('âœ… Playlist created!');
            loadPlaylists();
        } else {
            alert(`âŒ Error: ${data.error}`);
        }
    } catch (e) {
        alert(`âŒ Error: ${e.message}`);
    }
}

async function deletePlaylist(playlistId) {
    if (!confirm('Are you sure you want to delete this playlist?')) return;

    const wallet = localStorage.getItem('thr_address');
    try {
        const res = await fetch(`/api/music/playlists/${wallet}/${playlistId}`, {
            method: 'DELETE'
        });

        const data = await res.json();
        if (data.ok) {
            alert('âœ… Playlist deleted!');
            loadPlaylists();
        } else {
            alert(`âŒ Error: ${data.error}`);
        }
    } catch (e) {
        alert(`âŒ Error: ${e.message}`);
    }
}

async function viewPlaylist(playlistId) {
    const wallet = localStorage.getItem('thr_address');
    try {
        const res = await fetch(`/api/music/playlists/${wallet}/${playlistId}`);
        const data = await res.json();

        if (data.ok && data.playlist) {
            const playlist = data.playlist;
            const container = document.getElementById('playlistsContainer');

            container.innerHTML = `
                <button class="form-submit" style="width: auto; padding: 10px 20px; margin-bottom: 20px;" onclick="loadPlaylists()">
                    â¬…ï¸ <span class="lang-el">Î Î¯ÏƒÏ‰</span><span class="lang-en">Back</span>
                </button>
                <h3 style="color: #ff6600; margin-bottom: 20px;">${playlist.name}</h3>
                <div class="tracks-grid" id="playlistTracksGrid"></div>
            `;

            if (playlist.tracks && playlist.tracks.length > 0) {
                renderTracks(playlist.tracks, 'playlistTracksGrid');
            } else {
                document.getElementById('playlistTracksGrid').innerHTML = `
                    <div class="empty-state">
                        <p><span class="lang-el">Î†Î´ÎµÎ¹Î± playlist</span><span class="lang-en">Empty playlist</span></p>
                    </div>
                `;
            }
        }
    } catch (e) {
        console.error('Error viewing playlist:', e);
    }
}

async function loadOfflineTracks() {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        document.getElementById('offlineTracksGrid').innerHTML = '';
        document.getElementById('offlineEmpty').style.display = 'block';
        return;
    }

    try {
        const res = await fetch(`/api/music/offline/${wallet}`);
        const data = await res.json();

        if (data.ok && data.tracks && data.tracks.length > 0) {
            offlineTracks = data.tracks;
            document.getElementById('offlineEmpty').style.display = 'none';
            renderTracks(data.tracks, 'offlineTracksGrid');
        } else {
            document.getElementById('offlineTracksGrid').innerHTML = '';
            document.getElementById('offlineEmpty').style.display = 'block';
        }
    } catch (e) {
        console.error('Error loading offline tracks:', e);
    }
}

async function saveTrackOffline(trackId, sendTip = false) {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        alert('Please connect your wallet first!');
        return;
    }

    try {
        const res = await fetch('/api/music/offline/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                wallet: wallet,
                track_id: trackId,
                send_tip: sendTip
            })
        });

        const data = await res.json();
        if (data.ok) {
            const msg = data.tip_sent
                ? `âœ… Track saved offline with 0.01 THR tip sent to artist!`
                : `âœ… Track saved for offline listening!`;
            alert(msg);
            if (document.getElementById('offline-tab').classList.contains('active')) {
                loadOfflineTracks();
            }
        } else {
            alert(`âŒ Error: ${data.error}`);
        }
    } catch (e) {
        alert(`âŒ Error: ${e.message}`);
    }
}

async function removeTrackOffline(trackId) {
    const wallet = localStorage.getItem('thr_address');
    if (!confirm('Remove this track from offline storage?')) return;

    try {
        const res = await fetch(`/api/music/offline/${wallet}/${trackId}`, {
            method: 'DELETE'
        });

        const data = await res.json();
        if (data.ok) {
            alert('âœ… Track removed from offline storage!');
            loadOfflineTracks();
        } else {
            alert(`âŒ Error: ${data.error}`);
        }
    } catch (e) {
        alert(`âŒ Error: ${e.message}`);
    }
}

async function showTrackOptions(trackId) {
    const wallet = localStorage.getItem('thr_address');
    if (!wallet) {
        alert('Please connect your wallet first!');
        return;
    }

    // Load playlists first
    try {
        const res = await fetch(`/api/music/playlists/${wallet}`);
        const data = await res.json();
        userPlaylists = data.ok ? data.playlists : [];
    } catch (e) {
        console.error('Error loading playlists:', e);
    }

    const options = [
        'ğŸ“¥ Save for offline (no tip)',
        'ğŸ’° Save for offline + 0.01 THR tip',
        'ğŸ“‹ Add to playlist'
    ];

    const choice = prompt(`Select option for this track:\n${options.map((o, i) => `${i+1}. ${o}`).join('\n')}\n\nEnter number:`);

    if (choice === '1') {
        await saveTrackOffline(trackId, false);
    } else if (choice === '2') {
        await saveTrackOffline(trackId, true);
    } else if (choice === '3') {
        if (userPlaylists.length === 0) {
            alert('You have no playlists. Create one first!');
            return;
        }

        const playlistChoice = prompt(`Select playlist:\n${userPlaylists.map((p, i) => `${i+1}. ${p.name}`).join('\n')}\n\nEnter number:`);
        const playlistIndex = parseInt(playlistChoice) - 1;

        if (playlistIndex >= 0 && playlistIndex < userPlaylists.length) {
            await addTrackToPlaylist(trackId, userPlaylists[playlistIndex].id);
        }
    }
}

async function addTrackToPlaylist(trackId, playlistId) {
    const wallet = localStorage.getItem('thr_address');

    try {
        const res = await fetch(`/api/music/playlists/${wallet}/${playlistId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ track_id: trackId })
        });

        const data = await res.json();
        if (data.ok) {
            alert('âœ… Track added to playlist!');
        } else {
            alert(`âŒ Error: ${data.error}`);
        }
    } catch (e) {
        alert(`âŒ Error: ${e.message}`);
    }
}
</script>

<!-- PR-5a: Wallet authentication helper for PIN-based unlock -->
<script src="{{ url_for('static', filename='wallet_auth.js') }}?v={{ build_id }}"></script>
{% endblock %}
