{% extends "base.html" %}

{% block title %}ğŸ”¥ Thronos Pledge to the Flame{% endblock %}

{% block styles %}
<style>
    form { width:100%; max-width:650px; margin:20px auto; text-align:left; }
    input,textarea{
      width:100%; padding:8px; margin-top:5px;
      background:#111; border:1px solid #0f0; color:#0f0;
      font-family:monospace;
      box-sizing: border-box;
    }
    label{ font-weight:bold; margin-top:15px; display:block; }
    .info{ font-size:13px; color:#0f0; opacity:0.8; }

    #result{ margin-top:25px; border:1px solid #0f0;
      width:100%; max-width:650px; padding:15px; text-align:left; margin-left: auto; margin-right: auto; box-sizing: border-box;}
    #result.error{ border-color:red; color:red; }
    #result.success{ border-color:#0f0; }
    .pdf-link{ color:#0f0; text-decoration:underline; }
    
    button[type="submit"] {
      margin-top: 20px;
      padding: 10px 20px;
      background: #0f0;
      color: #000;
      border: 1px solid #000;
      font-weight: bold;
      cursor: pointer;
    }
    button[type="submit"]:hover {
      background: #0c0;
    }
</style>
{% endblock %}

{% block content %}
<div style="text-align: center;">
  <h1>ğŸ”¥ <span class="lang-el">Î”Î­ÏƒÎ¼ÎµÏ…ÏƒÎ· ÏƒÏ„Î· Î¦Î»ÏŒÎ³Î±</span><span class="lang-en">Pledge to the Flame</span></h1>

  <form id="pledgeForm">

    <label><span class="lang-el">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· BTC (KYC):</span><span class="lang-en">BTC Address (KYC):</span></label>
    <div class="info">
      <span class="lang-el">Î— Î´Î­ÏƒÎ¼ÎµÏ…ÏƒÎ· Î³Î¯Î½ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ BTC â†’ THR. Î†Î»Î»Î± chains Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ Î³Î¹Î± bridge/balances.</span>
      <span class="lang-en">Pledge is BTC-only â†’ THR. Other chains are bridge/balances only.</span>
    </div>
    <input id="btc_address" placeholder="e.g. 1FQov4P8yz..." required>

    <label><span class="lang-el">Î— Î”Î­ÏƒÎ¼ÎµÏ…ÏƒÎ® ÏƒÎ±Ï‚:</span><span class="lang-en">Your Pledge:</span></label>
    <textarea id="pledge_text" rows="4">I hereby pledge allegiance to the Thronos Chain.</textarea>

    <label><span class="lang-el">ÎœÏ…ÏƒÏ„Î¹ÎºÎ® Î¦ÏÎ¬ÏƒÎ· (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ):</span><span class="lang-en">Secret Passphrase (optional):</span></label>
    <input id="user_passphrase" placeholder="ÎœÏŒÎ½Î¿ ÎµÏƒÏ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï„Î· Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹Ï‚. / Only you must know this.">
    <div class="info">
      â€¢ <span class="lang-el">Î‘Î½ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï†ÏÎ¬ÏƒÎ·, Î· Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® THR **Î±Ï€Î±Î¹Ï„ÎµÎ¯ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿**: (PDF-stego seed + Î±Ï…Ï„Î® Ï„Î· Ï†ÏÎ¬ÏƒÎ·).</span><span class="lang-en">If you add a passphrase, THR sending **requires both**: (PDF-stego seed + this phrase).</span><br>
      â€¢ <span class="lang-el">Î‘Î½ Ï‡Î¬ÏƒÎµÏ„Îµ ÎšÎ‘Î™ Î¤Î‘ Î”Î¥ÎŸ â†’ ÎºÎ±Î¼Î¯Î± Î±Î½Î¬ÎºÏ„Î·ÏƒÎ· Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® (ÏŒÏ€Ï‰Ï‚ Î­Î½Î± Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ blockchain).</span><span class="lang-en">If you lose BOTH â†’ no recovery possible (like a real blockchain).</span>
    </div>

    <br><br>

    <div style="border:1px dashed #0f0; padding:15px; text-align:center;">
      <p><span class="lang-el">Î£Ï„ÎµÎ¯Î»Ï„Îµ ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ BTC fee ÏƒÏ„Î¿:</span><span class="lang-en">Send a minimum BTC fee to:</span></p>
      <p><b>1QFeDPwEF8yEgPEfP79hpc8pHytXMz9oEQ</b></p>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=bitcoin:1QFeDPwEF8yEgPEfP79hpc8pHytXMz9oEQ"
           id="qr" title="Click to copy address" style="cursor:pointer;">
      <p style="font-size:12px"><span class="lang-el">(ÎšÎ»Î¹Îº ÏƒÏ„Î¿ QR Î³Î¹Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î® BTC Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚)</span><span class="lang-en">(Click QR to copy BTC address)</span></p>
    </div>

    <button type="submit"><span class="lang-el">Î¥Ï€Î¿Î²Î¿Î»Î® Î”Î­ÏƒÎ¼ÎµÏ…ÏƒÎ·Ï‚</span><span class="lang-en">Submit Pledge</span></button>
  </form>

  <div id="result"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function activateWallet(addr, secret) {
  // Connect via the base.html wallet widget (walletSession from wallet_session.js)
  if (typeof walletSession !== 'undefined' && walletSession.saveSession) {
    walletSession.saveSession({ address: addr, sendSeed: secret || '', bound: true });
  }
  // Update header wallet UI if available
  if (typeof updateHeaderWalletUi === 'function') updateHeaderWalletUi();
  if (typeof updateWalletUI === 'function') updateWalletUI();
  if (typeof loadWalletBalances === 'function') loadWalletBalances(true);
  // Open the wallet popup
  if (typeof setWalletOpen === 'function') setWalletOpen(true);
  if (typeof showWalletContentSection === 'function') showWalletContentSection();
}

document.getElementById("qr").onclick = () => {
  navigator.clipboard.writeText("1QFeDPwEF8yEgPEfP79hpc8pHytXMz9oEQ");
  const lang = localStorage.getItem('lang') || 'el';
  alert(lang === 'el' ? "Î— Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· BTC Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!" : "BTC address copied!");
};

document.getElementById("pledgeForm").onsubmit = async (e) => {
  e.preventDefault();
  const result = document.getElementById("result");
  const lang = localStorage.getItem('lang') || 'el';
  
  result.className = "";
  result.textContent = lang === 'el' ? "â³ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±..." : "â³ Processing...";

  const payload = {
    btc_address: document.getElementById("btc_address").value.trim(),
    pledge_text: document.getElementById("pledge_text").value.trim(),
    user_passphrase: document.getElementById("user_passphrase").value.trim(),
  };

  try {
    const r = await fetch("/pledge_submit", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.error || data.message || "Unknown error");

    result.classList.add("success");
    
    const msg = lang === 'el' ? {
        accepted: "ğŸ”¥ Î— Î”Î­ÏƒÎ¼ÎµÏ…ÏƒÎ· ÎˆÎ³Î¹Î½Îµ Î”ÎµÎºÏ„Î®!",
        addr: "Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· THR",
        hash: "Pledge Hash",
        secret: "ÎœÏ…ÏƒÏ„Î¹ÎºÏŒ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ (Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î• Î¤ÎŸ!)",
        secretWarn: "Î‘Ï…Ï„ÏŒ ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ ÎœÎ™Î‘ Î¦ÎŸÎ¡Î‘. Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ­ Ï„Î¿ Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±. Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î³Î¹Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® THR.",
        pdf: "Î›Î®ÏˆÎ· Î£Ï…Î¼Î²Î¿Î»Î±Î¯Î¿Ï… PDF",
        pdfNote: "Î¤Î¿ PDF Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î¿. Î‘Î½ Ï‡Î¬ÏƒÎµÎ¹Ï‚ Ï„Î¿ Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ, Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï„Î¿ Î±Î½Î±ÎºÏ„Î®ÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿",
        recovery: "Î£ÎµÎ»Î¯Î´Î± Î‘Î½Î¬ÎºÏ„Î·ÏƒÎ·Ï‚",
        wallet: "ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î¿ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹",
        miner: "Î›Î®ÏˆÎ· Thronos Kit",
        alreadyVerified: "Î‘Ï…Ï„Î® Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· BTC Î­Ï‡ÎµÎ¹ Î®Î´Î· Î´ÎµÏƒÎ¼ÎµÏ…Ï„ÎµÎ¯.",
        pending: "Î‘Î½Î±Î¼Î¿Î½Î® Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ BTC...",
    } : {
        accepted: "ğŸ”¥ Pledge Accepted!",
        addr: "THR Address",
        hash: "Pledge Hash",
        secret: "Send Secret (SAVE THIS!)",
        secretWarn: "This is shown ONLY ONCE. Save it securely. Required to send THR.",
        pdf: "Download Contract PDF",
        pdfNote: "The PDF contains an encrypted backup. If you lose your secret, recover it from the",
        recovery: "Recovery Page",
        wallet: "Go to Wallet",
        miner: "Download Thronos Kit",
        alreadyVerified: "This BTC address has already been pledged.",
        pending: "Waiting for BTC payment...",
    };

    if (data.status === "pending") {
      result.classList.add("error");
      result.innerHTML = `<b>â³ ${msg.pending}</b><br>${data.message || ''}`;
      return;
    }

    if (data.status === "already_verified") {
      result.innerHTML = `
        <b>${msg.alreadyVerified}</b><br><br>
        ${msg.addr}: <code style="font-size:14px;background:#111;padding:4px 8px;user-select:all">${data.thr_address}</code><br>
        ${msg.hash}: <code>${data.pledge_hash}</code><br><br>
        ${data.recovery_required ? `
          <div style="border:2px solid #ff9500;background:rgba(255,149,0,0.1);padding:15px;margin:10px 0;text-align:center;">
            <b style="color:#ff9500;">ğŸ”‘ ${msg.secret}</b><br>
            <small>${msg.pdfNote} <a href="${data.recovery_url || '/recovery'}" class="pdf-link">${msg.recovery}</a></small>
          </div>
        ` : ''}
        ${data.pdf_url ? `ğŸ“„ <a class="pdf-link" href="${data.pdf_url}" target="_blank">${msg.pdf}</a><br>` : ''}
        ğŸ’¼ <a href="#" class="pdf-link" onclick="activateWallet('${data.thr_address}');return false;">${msg.wallet}</a>
      `;
      // Auto-connect wallet for already_verified
      activateWallet(data.thr_address);
      return;
    }

    result.innerHTML = `
      <b>${msg.accepted}</b><br><br>
      ${msg.addr}: <code style="font-size:14px;background:#111;padding:4px 8px;user-select:all">${data.thr_address}</code><br>
      ${msg.hash}: <code>${data.pledge_hash}</code><br><br>
      ${data.send_secret ? `
        <div style="border:2px solid #ff0;background:rgba(255,255,0,0.1);padding:15px;margin:10px 0;text-align:center;">
          <b style="color:#ff0;">âš ï¸ ${msg.secret}</b><br>
          <code id="secretCode" style="font-size:18px;color:#ff0;background:#111;padding:8px 16px;display:inline-block;margin:10px 0;user-select:all;letter-spacing:1px">${data.send_secret}</code><br>
          <div style="margin:10px 0;display:flex;gap:10px;justify-content:center;">
            <button onclick="navigator.clipboard.writeText('${data.send_secret}');this.textContent='âœ… Copied!';setTimeout(()=>this.textContent='ğŸ“‹ Copy',2000)" style="padding:8px 16px;background:#ff0;color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">ğŸ“‹ Copy</button>
            <button onclick="(function(){var b=new Blob(['Send Secret for ${data.thr_address}\\n\\n${data.send_secret}\\n\\nKeep this safe. Required to send THR.'],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='thr_send_secret_${data.thr_address}.txt';a.click()})()" style="padding:8px 16px;background:#0f0;color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">ğŸ’¾ Download .txt</button>
          </div>
          <small style="color:#f88;">${msg.secretWarn}</small><br>
          <small>${msg.pdfNote} <a href="/recovery" class="pdf-link">${msg.recovery}</a></small>
        </div>
      ` : ''}
      ${data.pdf_url ? `ğŸ“„ <a class="pdf-link" href="${data.pdf_url}" target="_blank">${msg.pdf}</a><br>` : ''}
      â›ï¸ <a class="pdf-link" href="/static/thronos_kit.zip" download>${msg.miner}</a><br><br>
      ğŸ’¼ <a href="#" class="pdf-link" onclick="activateWallet('${data.thr_address}','${data.send_secret || ''}');return false;">${msg.wallet}</a>
    `;
    // Auto-connect wallet with new credentials
    if (data.send_secret) activateWallet(data.thr_address, data.send_secret);
  } catch (err) {
    result.classList.add("error");
    const errMsg = lang === 'el' ? "âŒ Î£Ï†Î¬Î»Î¼Î±:" : "âŒ Error:";
    result.innerHTML = `<b>${errMsg}</b> ${err.message}`;
  }
};
</script>
{% endblock %}
