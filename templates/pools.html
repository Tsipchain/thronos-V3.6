{% extends "base.html" %}

{% block title %}üèä Pools{% endblock %}

{% block styles %}
<style>
  .pools-container {
    max-width: 900px;
    margin: 0 auto;
    background: #111;
    border: 1px solid #0f0;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
  }
  .pools-container h2 {
    margin-top: 0;
  }
  .pools-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  .pools-table th, .pools-table td {
    border: 1px solid #0f0;
    padding: 8px;
    text-align: left;
    font-size: 0.9em;
  }
  .pools-table th {
    background: #002200;
  }
  .pools-table tr:nth-child(even) {
    background: #010801;
  }
  .pools-table tr:nth-child(odd) {
    background: #000;
  }
  .form-group {
    margin-bottom: 10px;
  }
  .form-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.9em;
  }
  .form-group select, .form-group input {
    width: 100%;
    padding: 6px;
    border: 1px solid #333;
    border-radius: 4px;
    background: #000;
    color: #0f0;
    font-family: monospace;
  }
  .form-group select:focus, .form-group input:focus {
    outline: none;
    border-color: #0f0;
  }
  .btn-small {
    display: inline-block;
    background: #0f0;
    color: #000;
    padding: 6px 12px;
    font-size: 0.8em;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
  }
  .btn-small:hover { background: #0c0; }
  .section-divider {
    margin: 30px 0;
    border-top: 1px dashed #0f0;
  }
  #poolMsg {
    margin-top: 10px;
    white-space: pre-wrap;
    font-family: monospace;
  }
</style>
{% endblock %}

{% block content %}
<div class="pools-container">
  <h2>üèä <span class="lang-el">Liquidity Pools</span><span class="lang-en">Liquidity Pools</span></h2>
  <div id="poolsSection">
    <div id="poolsLoading">Loading pools‚Ä¶</div>
    <table class="pools-table" id="poolsTable" style="display:none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Token A</th>
          <th>Token B</th>
          <th>Reserve A</th>
          <th>Reserve B</th>
          <th>Total Shares</th>
        </tr>
      </thead>
      <tbody id="poolsBody">
      </tbody>
    </table>
  </div>
  <div class="section-divider"></div>
  <h3><span class="lang-el">ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒØŒ± Pool</span><span class="lang-en">Create Pool</span></h3>
  <form id="createPoolForm" onsubmit="return submitPool(event);">
    <div class="form-group">
      <label for="poolTokenA">Token A</label>
      <select id="poolTokenA" required></select>
    </div>
    <div class="form-group">
      <label for="poolAmountA"><span class="lang-el">Œ†ŒøœÉœå A</span><span class="lang-en">Amount A</span></label>
      <input type="number" step="0.000001" id="poolAmountA" required>
    </div>
    <div class="form-group">
      <label for="poolTokenB">Token B</label>
      <select id="poolTokenB" required></select>
    </div>
    <div class="form-group">
      <label for="poolAmountB"><span class="lang-el">Œ†ŒøœÉœå B</span><span class="lang-en">Amount B</span></label>
      <input type="number" step="0.000001" id="poolAmountB" required>
    </div>
    <button type="submit" class="btn-small"><span class="lang-el">ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒØŒ±</span><span class="lang-en">Create</span></button>
  </form>
  <div id="poolMsg"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadPools() {
  try {
    const res = await fetch('/api/v1/pools');
    const data = await res.json();
    const table = document.getElementById('poolsTable');
    const tbody = document.getElementById('poolsBody');
    tbody.innerHTML = '';
    if (data.pools && data.pools.length > 0) {
      data.pools.forEach(pool => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${pool.id || ''}</td><td>${pool.token_a}</td><td>${pool.token_b}</td><td>${(pool.reserves_a ?? pool.reserve_a ?? '')}</td><td>${(pool.reserves_b ?? pool.reserve_b ?? '')}</td><td>${pool.total_shares || 0}</td>`;
        tbody.appendChild(tr);
      });
      table.style.display = '';
      document.getElementById('poolsLoading').style.display = 'none';
    } else {
      document.getElementById('poolsLoading').textContent = 'No pools created yet.';
    }
  } catch (e) {
    document.getElementById('poolsLoading').textContent = 'Error loading pools.';
  }
}

async function loadTokenOptions() {
  try {
    const res = await fetch('/api/v1/tokens');
    const data = await res.json();
    const selectA = document.getElementById('poolTokenA');
    const selectB = document.getElementById('poolTokenB');
    selectA.innerHTML = '';
    selectB.innerHTML = '';
    // Add native tokens as options
    const nativeTokens = [ {symbol: 'THR'}, {symbol: 'wBTC'} ];
    nativeTokens.forEach(t => {
      const optA = document.createElement('option');
      optA.value = t.symbol;
      optA.textContent = t.symbol;
      selectA.appendChild(optA);
      const optB = document.createElement('option');
      optB.value = t.symbol;
      optB.textContent = t.symbol;
      selectB.appendChild(optB);
    });
    // Add custom tokens
    if (data.tokens && data.tokens.length > 0) {
      data.tokens.forEach(tok => {
        const optA = document.createElement('option');
        optA.value = tok.symbol;
        optA.textContent = tok.symbol;
        selectA.appendChild(optA);
        const optB = document.createElement('option');
        optB.value = tok.symbol;
        optB.textContent = tok.symbol;
        selectB.appendChild(optB);
      });
    }
  } catch (e) {
    console.error('Error loading token options:', e);
  }
}

async function submitPool(evt) {
  evt.preventDefault();
  const tokenA = document.getElementById('poolTokenA').value;
  const tokenB = document.getElementById('poolTokenB').value;
  const amtA = parseFloat(document.getElementById('poolAmountA').value);
  const amtB = parseFloat(document.getElementById('poolAmountB').value);
  const provider = localStorage.getItem('thr_address');
  const secret   = localStorage.getItem('thr_secret');
  if (!provider || !secret) {
    alert('Please connect your wallet first.');
    return false;
  }
  if (!tokenA || !tokenB || tokenA === tokenB) {
    alert('Select two distinct tokens.');
    return false;
  }
  if (!amtA || !amtB || amtA <= 0 || amtB <= 0) {
    alert('Enter positive amounts.');
    return false;
  }
  const payload = {
    token_a: tokenA,
    token_b: tokenB,
    amount_a: amtA,
    amount_b: amtB,
    provider_thr: provider,
    auth_secret: secret
  };
  document.getElementById('poolMsg').style.color = '#fff';
  document.getElementById('poolMsg').textContent = 'Submitting‚Ä¶';
  try {
    const res = await fetch('/api/v1/pools', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.status === 201) {
      document.getElementById('poolMsg').style.color = '#0f0';
      document.getElementById('poolMsg').textContent = '‚úÖ Pool created successfully.';
      await loadPools();
      document.getElementById('createPoolForm').reset();
    } else {
      document.getElementById('poolMsg').style.color = '#f00';
      document.getElementById('poolMsg').textContent = `‚ùå Error: ${data.message || data.error || 'Unknown error'}`;
    }
  } catch (e) {
    document.getElementById('poolMsg').style.color = '#f00';
    document.getElementById('poolMsg').textContent = '‚ùå Network error.';
  }
  return false;
}

document.addEventListener('DOMContentLoaded', () => {
  loadTokenOptions();
  loadPools();
});
</script>
{% endblock %}
