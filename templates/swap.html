{% extends "base.html" %}

{% block title %}üîÑ Thronos Swap{% endblock %}

{% block styles %}
<style>
    .swap-container {
        max-width: 480px;
        margin: 40px auto;
        background: #111;
        border: 1px solid #0f0;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
    }
    
    .token-input-group {
        background: #000;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 8px;
    }
    
    .token-input-group:focus-within {
        border-color: #0f0;
    }
    
    .token-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9em;
        color: #888;
    }
    
    .token-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    input.amount-input {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 24px;
        width: 60%;
        font-family: monospace;
        outline: none;
    }
    
    .token-select {
        background: #222;
        color: #fff;
        border: 1px solid #444;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .swap-arrow {
        text-align: center;
        margin: -10px 0;
        position: relative;
        z-index: 10;
    }
    
    .swap-arrow button {
        background: #111;
        border: 1px solid #0f0;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        color: #0f0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .swap-arrow button:hover {
        background: #0f0;
        color: #000;
    }
    
    .swap-btn {
        width: 100%;
        background: #0f0;
        color: #000;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 16px;
    }
    
    .swap-btn:hover {
        background: #0c0;
    }
    
    .swap-btn:disabled {
        background: #333;
        color: #666;
        cursor: not-allowed;
    }
    
    .rate-info {
        margin-top: 16px;
        padding: 12px;
        background: #001100;
        border-radius: 8px;
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        color: #0f0;
    }
    
    .hidden { display: none; }
</style>
{% endblock %}

{% block content %}

<div class="swap-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>üîÑ Swap</h2>
        <span style="font-size:0.8em; color:#666;">Slippage: Auto</span>
    </div>
    
    <div id="walletWarning" style="color:#ffaa88; margin-bottom:15px; display:none; text-align:center;">
        ‚ö†Ô∏è <a href="/wallet" style="color:#ffaa88; text-decoration:underline;">Connect Wallet</a> to swap
    </div>

    <!-- FROM -->
    <div class="token-input-group">
        <div class="token-header">
            <span><span class="lang-el">ŒëœÄœå</span><span class="lang-en">From</span></span>
            <span>Balance: <span id="balanceFrom">0.00</span></span>
        </div>
        <div class="token-row">
            <input type="number" id="amountFrom" class="amount-input" placeholder="0.0" oninput="calcTo()">
            <select id="symbolFrom" class="token-select" onchange="onTokenChange()"></select>
        </div>
    </div>

    <!-- ARROW -->
    <div class="swap-arrow">
        <button onclick="flipTokens()">‚¨áÔ∏è</button>
    </div>

    <!-- TO -->
    <div class="token-input-group">
        <div class="token-header">
            <span><span class="lang-el">Œ†œÅŒøœÇ</span><span class="lang-en">To</span></span>
            <span>Balance: <span id="balanceTo">0.00</span></span>
        </div>
        <div class="token-row">
            <input type="number" id="amountTo" class="amount-input" placeholder="0.0" readonly>
            <select id="symbolTo" class="token-select" onchange="onTokenChange()"></select>
        </div>
    </div>

    <div class="rate-info">
        <span>Rate</span>
        <span id="rateDisplay">1 THR = 0.0001 wBTC</span>
    </div>

    <button id="swapBtn" class="swap-btn" onclick="doSwap()">Swap</button>
    
    <div id="swapResult" style="margin-top:10px; text-align:center; font-family:monospace; white-space:pre-wrap;"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
(() => {
if (window.__swapInitDone) return;
window.__swapInitDone = true;

const $ = (id) => document.getElementById(id);

let tokenBalances = {};
let availableTokens = [];
let poolPairs = [];
let latestQuote = null;

document.addEventListener('DOMContentLoaded', async () => {
    const addr = walletSession.getAddress();
    if (!addr || !walletSession.isBound()) {
        $('walletWarning').style.display = 'block';
        $('swapBtn').disabled = true;
        $('swapBtn').textContent = "Connect Wallet";
    } else {
        await Promise.all([loadBalances(addr), loadSwapCatalog()]);
        setDefaultTokens();
        calcTo();
    }
});

async function loadBalances(addr) {
    try {
        const res = await fetch(`/api/wallet/tokens/${addr}?show_zero=true`);
        const data = await res.json();
        tokenBalances = {};
        if (data.tokens) {
            data.tokens.forEach(t => {
                tokenBalances[t.symbol] = Number(t.balance || 0);
            });
        }
        updateBalanceDisplays();
    } catch (e) {
        console.error("Load balance error:", e);
    }
}

async function loadSwapCatalog() {
    const [poolsRes, tokensRes] = await Promise.all([
        fetch('/api/v1/pools').then(r => r.json()).catch(() => ({ pools: [] })),
        fetch('/api/v1/tokens').then(r => r.json()).catch(() => ({ tokens: [] })),
    ]);
    const registry = new Map((tokensRes.tokens || []).map(t => [t.symbol, t]));
    const poolTokens = new Set();
    poolPairs = [];
    (poolsRes.pools || []).forEach(pool => {
        if (pool.token_a) poolTokens.add(pool.token_a.toUpperCase());
        if (pool.token_b) poolTokens.add(pool.token_b.toUpperCase());
        if (pool.token_a && pool.token_b) {
            poolPairs.push([pool.token_a.toUpperCase(), pool.token_b.toUpperCase()]);
        }
    });
    availableTokens = Array.from(poolTokens).filter(sym => registry.has(sym));
    availableTokens.sort();

    const selectFrom = $('symbolFrom');
    const selectTo = $('symbolTo');
    selectFrom.innerHTML = '';
    selectTo.innerHTML = '';
    availableTokens.forEach(sym => {
        const optFrom = document.createElement('option');
        optFrom.value = sym;
        optFrom.textContent = sym;
        selectFrom.appendChild(optFrom);

        const optTo = document.createElement('option');
        optTo.value = sym;
        optTo.textContent = sym;
        selectTo.appendChild(optTo);
    });
}

function setDefaultTokens() {
    const selectFrom = $('symbolFrom');
    const selectTo = $('symbolTo');
    if (availableTokens.includes('THR')) {
        selectFrom.value = 'THR';
    }
    const fallbackTo = availableTokens.find(sym => sym !== selectFrom.value);
    if (fallbackTo) {
        selectTo.value = fallbackTo;
    }
    updateBalanceDisplays();
    refreshToOptions();
}

function updateBalanceDisplays() {
    const fromSymbol = $('symbolFrom').value;
    const toSymbol = $('symbolTo').value;
    const fromBal = tokenBalances[fromSymbol] || 0;
    const toBal = tokenBalances[toSymbol] || 0;
    $('balanceFrom').textContent = fromBal.toFixed(6);
    $('balanceTo').textContent = toBal.toFixed(6);
}

function canRoute(fromToken, toToken) {
    if (fromToken === toToken) return false;
    const direct = poolPairs.some(pair =>
        (pair[0] === fromToken && pair[1] === toToken) || (pair[1] === fromToken && pair[0] === toToken)
    );
    if (direct) return true;
    const hasFromThr = poolPairs.some(pair =>
        (pair[0] === fromToken && pair[1] === 'THR') || (pair[1] === fromToken && pair[0] === 'THR')
    );
    const hasToThr = poolPairs.some(pair =>
        (pair[0] === toToken && pair[1] === 'THR') || (pair[1] === toToken && pair[0] === 'THR')
    );
    return hasFromThr && hasToThr;
}

function refreshToOptions() {
    const selectTo = $('symbolTo');
    const fromToken = $('symbolFrom').value;
    const previous = selectTo.value;
    selectTo.innerHTML = '';
    availableTokens.forEach(sym => {
        if (sym === fromToken) return;
        if (!canRoute(fromToken, sym)) return;
        const opt = document.createElement('option');
        opt.value = sym;
        opt.textContent = sym;
        selectTo.appendChild(opt);
    });
    if (previous && Array.from(selectTo.options).some(o => o.value === previous)) {
        selectTo.value = previous;
    } else if (selectTo.options.length > 0) {
        selectTo.value = selectTo.options[0].value;
    }
}

function flipTokens() {
    const selectFrom = $('symbolFrom');
    const selectTo = $('symbolTo');
    const fromVal = selectFrom.value;
    selectFrom.value = selectTo.value;
    selectTo.value = fromVal;
    const amtFrom = $('amountFrom').value;
    $('amountFrom').value = $('amountTo').value;
    $('amountTo').value = amtFrom;
    updateBalanceDisplays();
    refreshToOptions();
    calcTo();
}

function onTokenChange() {
    updateBalanceDisplays();
    refreshToOptions();
    calcTo();
}

async function calcTo() {
    const fromVal = parseFloat($('amountFrom').value) || 0;
    const tokenIn = $('symbolFrom').value;
    const tokenOut = $('symbolTo').value;
    latestQuote = null;
    if (!fromVal || !tokenIn || !tokenOut || tokenIn === tokenOut) {
        $('amountTo').value = '';
        $('rateDisplay').textContent = '‚Äî';
        $('swapBtn').disabled = true;
        return;
    }
    try {
        const res = await fetch(`/api/swap/quote?token_in=${encodeURIComponent(tokenIn)}&token_out=${encodeURIComponent(tokenOut)}&amount_in=${encodeURIComponent(fromVal)}`);
        const data = await res.json();
        if (data.status !== 'success') {
            $('amountTo').value = '';
            $('rateDisplay').textContent = '‚Äî';
            $('swapBtn').disabled = true;
            $('swapResult').textContent = data.message || 'No liquidity';
            return;
        }
        latestQuote = data;
        $('amountTo').value = Number(data.amount_out).toFixed(6);
        const rate = data.amount_out / fromVal;
        $('rateDisplay').textContent = rate ? `1 ${tokenIn} = ${rate.toFixed(6)} ${tokenOut}` : '‚Äî';
        $('swapBtn').disabled = false;
        $('swapResult').textContent = '';
    } catch (e) {
        $('amountTo').value = '';
        $('rateDisplay').textContent = '‚Äî';
        $('swapBtn').disabled = true;
        console.error('Quote error', e);
    }
}

async function doSwap() {
    const addr = walletSession.getAddress();
    const secret = walletSession.getSendSeed();
    const amount = parseFloat($('amountFrom').value);
    const tokenIn = $('symbolFrom').value;
    const tokenOut = $('symbolTo').value;

    if (!addr || !secret || !walletSession.isBound()) {
        alert("Wallet not connected");
        return;
    }

    if(!walletSession.requirePin('swap')) return;
    
    if (!amount || amount <= 0) {
        alert("Enter a valid amount.");
        return;
    }
    if (!latestQuote || latestQuote.status !== 'success') {
        alert("No valid quote available.");
        return;
    }
    
    $('swapBtn').disabled = true;
    $('swapBtn').innerHTML = '<span class="spinner"></span> Swapping...';
    $('swapResult').textContent = "";
    
    try {
        const res = await fetch('/api/swap/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                trader_thr: addr,
                auth_secret: secret,
                token_in: tokenIn,
                token_out: tokenOut,
                amount_in: amount,
                min_amount_out: latestQuote.amount_out
            })
        });
        
        const data = await res.json();
        
        if (data.status === 'success') {
            $('swapResult').style.color = '#0f0';
            $('swapResult').textContent = `‚úÖ Swap Successful!\nTXID: ${data.tx_id}`;
            await loadBalances(addr); // Refresh UI
            $('amountFrom').value = '';
            $('amountTo').value = '';
        } else {
            $('swapResult').style.color = '#f00';
            $('swapResult').textContent = `‚ùå Error: ${data.message || 'Unknown error'}`;
        }
    } catch (e) {
        $('swapResult').style.color = '#f00';
        $('swapResult').textContent = `‚ùå Error: ${e.message}`;
    } finally {
        $('swapBtn').disabled = false;
        $('swapBtn').textContent = "Swap";
    }
}

window.flipTokens = flipTokens;
window.onTokenChange = onTokenChange;
window.calcTo = calcTo;
window.doSwap = doSwap;
})();
</script>
{% endblock %}
