{% extends "base.html" %}

{% block title %}Thronos Block & TX Viewer{% endblock %}

{% block styles %}
<style>
    :root { --g:#00ff66; --panel:#0b0b0b; }
    
    .wrap { padding:14px; max-width:1200px; margin:0 auto; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .btn-tool {
      background:var(--panel); border:1px solid var(--g); color:var(--g);
      padding:8px 12px; cursor:pointer; font-weight:bold;
    }
    .btn-tool.active { background:var(--g); color:#000; }
    .input {
      background:#111; color:var(--g); border:1px solid var(--g);
      padding:8px 10px; min-width:260px;
    }
    .panel { background:var(--panel); border:1px dashed var(--g); padding:10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #0f0; padding:8px; font-size:13px; }
    th { background:#061; text-align:left; }
    tr:nth-child(odd) td { background:rgba(0,255,102,0.05); }
    code { background:#111; padding:2px 4px; }
    .muted { opacity:.85; }
    .right { text-align:right; }
    .copy { cursor:pointer; text-decoration:underline; }
    .hidden { display:none; }
</style>
{% endblock %}

{% block content %}
  <div class="wrap">
    <h1>ğŸ“¦ <span class="lang-el">Î•Î¾ÎµÏÎµÏ…Î½Î·Ï„Î®Ï‚ Thronos</span><span class="lang-en">Thronos Viewer</span></h1>

    <div class="toolbar">
      <button id="btnBlocks" class="btn-tool active"><span class="lang-el">ÎœÏ€Î»Î¿Îº</span><span class="lang-en">Blocks</span></button>
      <button id="btnTx" class="btn-tool"><span class="lang-el">ÎœÎµÏ„Î±Ï†Î¿ÏÎ­Ï‚</span><span class="lang-en">Transfers</span></button>

      <input id="search" class="input" placeholder="Search (address or tx id)" />
      <button id="btnClear" class="btn-tool"><span class="lang-el">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</span><span class="lang-en">Clear</span></button>
    </div>

    <!-- Blocks table -->
    <div id="blocksPanel" class="panel">
      <table id="blocksTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Block Hash</th>
            <th>Miner THR</th>
            <th class="right"><span class="lang-el">Î‘Î¼Î¿Î¹Î²Î®</span><span class="lang-en">Reward</span></th>
            <th class="right"><span class="lang-el">Î ÏÎ¿Î¼Î®Î¸ÎµÎ¹Î± Pool</span><span class="lang-en">Pool Fee</span></th>
            <th class="right"><span class="lang-el">Î£Ï„Î¿Î½ Miner</span><span class="lang-en">To Miner</span></th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
    </div>

    <!-- TX table -->
    <div id="txPanel" class="panel hidden">
      <table id="txTable">
        <thead>
          <tr>
            <th>TX ID</th>
            <th>Height</th>
            <th>From</th>
            <th>To</th>
            <th class="right"><span class="lang-el">Î Î¿ÏƒÏŒ</span><span class="lang-en">Amount</span></th>
            <th class="right"><span class="lang-el">Î ÏÎ¿Î¼Î®Î¸ÎµÎ¹Î±</span><span class="lang-en">Fee</span></th>
            <th>Timestamp</th>
            <th>Copy</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
      <p class="muted">
          <span class="lang-el">Tip: ÎºÎ¬Î½Îµ ÎºÎ»Î¹Îº ÏƒÎµ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î³Î¹Î± Î¬Î½Î¿Î¹Î³Î¼Î± wallet viewer Î® ÏƒÏ„Î·Î½ Â«CopyÂ» Î³Î¹Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î® TX/Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚.</span>
          <span class="lang-en">Tip: click an address to open wallet viewer or "Copy" to copy TX/address.</span>
      </p>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const el = (q) => document.querySelector(q);
    const blocksPanel = el("#blocksPanel");
    const txPanel     = el("#txPanel");
    const btnBlocks   = el("#btnBlocks");
    const btnTx       = el("#btnTx");
    const searchBox   = el("#search");
    const btnClear    = el("#btnClear");

    let allBlocks = [];    // Î¼ÏŒÎ½Î¿ block entries
    let allTxs    = [];    // Î¼ÏŒÎ½Î¿ transfers

    function show(panel) {
      if (panel === "blocks") {
        blocksPanel.classList.remove("hidden");
        txPanel.classList.add("hidden");
        btnBlocks.classList.add("active");
        btnTx.classList.remove("active");
      } else {
        txPanel.classList.remove("hidden");
        blocksPanel.classList.add("hidden");
        btnTx.classList.add("active");
        btnBlocks.classList.remove("active");
      }
    }

    btnBlocks.onclick = () => show("blocks");
    btnTx.onclick     = () => show("tx");

    btnClear.onclick = () => {
      searchBox.value = "";
      renderBlocks(allBlocks);
      renderTxs(allTxs);
    };

    function copy(text) {
      navigator.clipboard.writeText(text);
      const lang = localStorage.getItem('lang') || 'el';
      alert(lang === 'el' ? "Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ:\n" + text : "Copied:\n" + text);
    }

    function linkAddr(addr) {
      return `<a href="/wallet/${addr}" target="_blank" style="color:#0f0">${addr}</a>`;
    }

    function renderBlocks(rows) {
      const q = searchBox.value.trim().toLowerCase();
      const body = el("#blocksTable tbody");
      body.innerHTML = "";

      rows
        .filter(b => !q ||
          String(b.block_hash||"").toLowerCase().includes(q) ||
          String(b.thr_address||"").toLowerCase().includes(q)
        )
        .forEach(b => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(b.block_hash||"").startsWith("THR-") ? (b.block_hash||"").split("-")[1] : ""}</td>
            <td><span class="copy" onclick='(${copy}).call(null, "${b.block_hash}")'>${b.block_hash}</span></td>
            <td>${b.thr_address ? linkAddr(b.thr_address) : ""}</td>
            <td class="right">${Number(b.reward||0).toFixed(3)}</td>
            <td class="right">${Number(b.pool_fee||0).toFixed(3)}</td>
            <td class="right">${Number(b.reward_to_miner||0).toFixed(3)}</td>
            <td>${b.timestamp||""}</td>
          `;
          body.appendChild(tr);
        });
    }

    function renderTxs(rows) {
      const q = searchBox.value.trim().toLowerCase();
      const body = el("#txTable tbody");
      body.innerHTML = "";

      rows
        .filter(t => !q ||
          String(t.tx_id||"").toLowerCase().includes(q) ||
          String(t.from||"").toLowerCase().includes(q) ||
          String(t.to||"").toLowerCase().includes(q)
        )
        .forEach(t => {
          const tr = document.createElement("tr");
          const copyTx = `(${copy}).call(null, "${t.tx_id}")`;
          const copyFrom = `(${copy}).call(null, "${t.from}")`;
          const copyTo   = `(${copy}).call(null, "${t.to}")`;

          tr.innerHTML = `
            <td><span class="copy" onclick='${copyTx}'>${t.tx_id}</span></td>
            <td>${t.height ?? ""}</td>
            <td>${t.from ? linkAddr(t.from) : ""}</td>
            <td>${t.to ? linkAddr(t.to) : ""}</td>
            <td class="right">${Number(t.amount||0).toFixed(6)}</td>
            <td class="right">${Number(t.fee_burned||0).toFixed(4)}</td>
            <td>${t.timestamp||""}</td>
            <td>
              <span class="copy" onclick='${copyTx}'>TX</span> |
              <span class="copy" onclick='${copyFrom}'>From</span> |
              <span class="copy" onclick='${copyTo}'>To</span>
            </td>
          `;
          body.appendChild(tr);
        });
    }

    async function loadData() {
      // Î¦Î­ÏÎ½Î¿Ï…Î¼Îµ ÎŸÎ›ÎŸ Ï„Î¿ chain ÎºÎ±Î¹ Ï†Î¹Î»Ï„ÏÎ¬ÏÎ¿Ï…Î¼Îµ blocks client-side
      const chain = await fetch("/chain").then(r=>r.json());
      allBlocks = chain.filter(x => typeof x === "object" && x && x.type !== "transfer");

      // Î¦Î­ÏÎ½Î¿Ï…Î¼Îµ Ï„Î± transfers
      allTxs = chain.filter(x => typeof x === "object" && x && x.type === "transfer");

      // RENDER
      renderBlocks(allBlocks);
      renderTxs(allTxs);
    }

    searchBox.addEventListener("input", () => {
      renderBlocks(allBlocks);
      renderTxs(allTxs);
    });

    loadData();
  </script>
{% endblock %}
