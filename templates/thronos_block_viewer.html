<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Thronos Block & TX Viewer</title>
<style>
  :root{
    --bg:#050b06; --panel:#0b140d; --line:#0f2612; --glow:#16ff57; --muted:#6bfd9b;
    --accent:#22ff77; --danger:#ff5577; --warn:#ffd166;
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#b8ffcc;font-family:var(--mono);letter-spacing:.2px}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .title{display:flex;align-items:center;gap:12px;font-size:28px;font-weight:800;color:var(--accent)}
  .title .cube{width:18px;height:18px;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .tabs{display:flex;gap:8px;margin:18px 0 12px}
  .tab{padding:8px 12px;border:1px solid var(--line);background:var(--panel);cursor:pointer;
       border-radius:8px;font-weight:700;color:#b8ffcc}
  .tab.active{outline:1px solid var(--accent);box-shadow:0 0 8px #0f4}
  .panel{border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .grow{flex:1}
  .badge{font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:999px}
  .b-stratum{color:#041;background:#16ff5730;border-color:#16ff57}
  .b-legacy{color:#044;background:#8affc630;border-color:#8affc6}
  .b-hot{color:#220;background:#ffd16666;border-color:#ffd166}
  .muted{color:#82b98f}
  .right{float:right}

  .search{display:flex;gap:8px;align-items:center}
  .search input{flex:1;background:#07110a;color:#caffdd;border:1px solid var(--line);border-radius:8px;
                padding:10px 12px;font-family:var(--mono)}
  .btn{background:#0c1a10;color:#b8ffcc;border:1px solid var(--line);padding:8px 10px;border-radius:8px;
       cursor:pointer}
  .btn:hover{outline:1px solid var(--accent)}

  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#07110a;border-bottom:1px solid var(--line);z-index:2;
           padding:10px 8px;text-align:left}
  tbody td{border-bottom:1px dashed #0b2; padding:8px 8px;font-size:13px;vertical-align:middle}
  tr:nth-child(even) td{background:#08140d60}
  .mono{font-family:var(--mono)}
  .hash, .addr{color:#caffdd;text-decoration:none}
  .hash:hover, .addr:hover{text-decoration:underline}
  .copy{cursor:pointer;border:1px solid var(--line);border-radius:6px;padding:2px 6px;margin-left:6px}
  .k{color:#7bffad}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{border:1px solid var(--line);border-radius:12px;background:#07110a;padding:12px}
  .card h4{margin:0 0 8px;color:var(--muted)}
  .big{font-size:20px;font-weight:800;color:#d6ffe6}
  .small{font-size:12px}

  .spark{width:100%;height:40px;display:block}
  .hint{font-size:12px;color:#9fdfb4;margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="title"><div class="cube"></div> Thronos Viewer</div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="blocks">Blocks</div>
    <div class="tab" data-tab="txs">Transfers</div>
    <div class="tab" data-tab="mempool">Mempool</div>
    <div class="tab" data-tab="live">Live Stats</div>
    <div class="right muted" id="liveClock">—</div>
  </div>

  <!-- Controls -->
  <div class="row panel">
    <div class="search grow">
      <input id="q" placeholder="Search (address, tx id, block hash)…" />
      <button class="btn" id="clearBtn">Clear</button>
      <button class="btn" id="refreshBtn" title="Refresh blocks from API">Refresh</button>
    </div>
    <div class="badge b-hot" id="tipBadge" style="display:none">recent activity</div>
  </div>

  <!-- Blocks -->
  <section id="view-blocks" class="panel" style="margin-top:12px">
    <table id="tblBlocks">
      <thead>
        <tr>
          <th>#</th>
          <th>Block Hash</th>
          <th>Miner THR</th>
          <th>Reward</th>
          <th>Pool Burn</th>
          <th>To Miner</th>
          <th>AI</th>
          <th>Type</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="hint">Tip: κλικ στο hash/διεύθυνση για αντιγραφή.</div>
  </section>

  <!-- Transfers -->
  <section id="view-txs" class="panel" style="display:none;margin-top:12px">
    <table id="tblTxs">
      <thead>
        <tr>
          <th>TX ID</th>
          <th>Height</th>
          <th>From</th>
          <th>To</th>
          <th>Amount</th>
          <th>Fee</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Mempool -->
  <section id="view-mempool" class="panel" style="display:none;margin-top:12px">
    <div class="row">
      <div class="badge">Pending:</div>
      <div class="badge b-hot" id="mpCount">0</div>
      <button class="btn" id="btnLoadMempool">Reload</button>
    </div>
    <table id="tblMempool" style="margin-top:8px">
      <thead>
        <tr>
          <th>TX ID</th><th>From</th><th>To</th><th>Amount</th><th>Fee</th><th>Status</th><th>Queued</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="hint">Οι μεταφορές γίνονται “confirmed” όταν κλείσει block. Ο watchdog κλείνει μόνος του αν αργήσει.</div>
  </section>

  <!-- Live -->
  <section id="view-live" class="panel grid" style="display:none;margin-top:12px">
    <div class="card">
      <h4>Difficulty</h4>
      <div class="big" id="liveDiff">—</div>
      <div class="small muted">network target ratio</div>
    </div>
    <div class="card">
      <h4>Avg Block Time</h4>
      <div class="big" id="liveABT">—</div>
      <div class="small muted">last window</div>
    </div>
    <div class="card">
      <h4>Estimated Hashrate</h4>
      <div class="big" id="liveHR">—</div>
      <canvas class="spark" id="sparkHR"></canvas>
    </div>
    <div class="card">
      <h4>Mempool size</h4>
      <div class="big" id="liveMP">—</div>
      <div class="small muted">pending TXs</div>
    </div>
  </section>
</div>

<script>
/* ===== Utilities ===== */
const fmtN = (n) => (n==null?'—':Number(n).toLocaleString(undefined,{minimumFractionDigits:3,maximumFractionDigits:6}));
const short = s => (s && s.length>20 ? s.slice(0,20)+'…' : (s||'—'));
const rel = ts => {
  if(!ts) return '—';
  const t = new Date(ts.replace(' UTC','')+'Z').getTime();
  const d = (Date.now()-t)/1000;
  if (d<90) return 'just now';
  if (d<3600) return Math.round(d/60)+'m ago';
  if (d<86400) return Math.round(d/3600)+'h ago';
  return new Date(t).toISOString().replace('T',' ').slice(0,19)+' UTC';
};
const copy = (txt)=>{ navigator.clipboard.writeText(txt||''); };
const el = (sel)=>document.querySelector(sel);
const tbody = (id)=>document.querySelector(id+' tbody');

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    ['blocks','txs','mempool','live'].forEach(name=>{
      el('#view-'+name).style.display = (name===tab)?'block':'none';
    });
  };
});

/* ===== Data bootstrapped by server (Jinja) ===== */
const BOOT_BLOCKS = {{ (blocks or [])|tojson }};
const BOOT_TXS    = {{ (transactions or [])|tojson }};

/* ===== Renderers ===== */
function renderBlocks(list){
  const q = el('#q').value.trim().toLowerCase();
  const tb = tbody('#tblBlocks');
  tb.innerHTML='';
  let hot=false;
  list.forEach(b=>{
    const match = !q || JSON.stringify(b).toLowerCase().includes(q);
    if(!match) return;
    const tr=document.createElement('tr');
    const typeBadge = b.is_stratum
      ? '<span class="badge b-stratum">stratum</span>'
      : '<span class="badge b-legacy">legacy</span>';
    const timeStr = rel(b.timestamp);
    if(timeStr==='just now' || timeStr.endsWith('m ago') && parseInt(timeStr) <= 5) hot=true;

    tr.innerHTML = `
      <td class="mono k">${b.index}</td>
      <td class="mono">
        <a class="hash" title="${b.hash}" onclick="copy('${b.hash}')">${short(b.hash)}</a>
        <span class="copy" title="copy" onclick="copy('${b.hash}')">copy</span>
      </td>
      <td class="mono">
        <a class="addr" title="${b.transactions?.[0]?.thr_address||b.thr_address}" onclick="copy('${b.transactions?.[0]?.thr_address||b.thr_address}')">
          ${short(b.transactions?.[0]?.thr_address||b.thr_address||'—')}
        </a>
      </td>
      <td>${fmtN(b.reward_to_miner + b.reward_to_ai + (b.fee_burned||0))}</td>
      <td>${fmtN(b.fee_burned)}</td>
      <td>${fmtN(b.reward_to_miner)}</td>
      <td>${fmtN(b.reward_to_ai)}</td>
      <td>${typeBadge}</td>
      <td class="muted">${timeStr}</td>
    `;
    tb.appendChild(tr);
  });
  el('#tipBadge').style.display = hot?'inline-block':'none';
}

function renderTxs(list){
  const q = el('#q').value.trim().toLowerCase();
  const tb = tbody('#tblTxs');
  tb.innerHTML='';
  list.forEach(t=>{
    const match = !q || JSON.stringify(t).toLowerCase().includes(q);
    if(!match) return;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">
        <a class="hash" title="${t.tx_id}" onclick="copy('${t.tx_id}')">${short(t.tx_id)}</a>
      </td>
      <td class="mono k">${t.height ?? '—'}</td>
      <td class="mono"><a class="addr" onclick="copy('${t.from}')">${short(t.from)}</a></td>
      <td class="mono"><a class="addr" onclick="copy('${t.to}')">${short(t.to)}</a></td>
      <td>${fmtN(t.amount)}</td>
      <td>${fmtN(t.fee_burned)}</td>
      <td class="muted">${rel(t.timestamp)}</td>
    `;
    tb.appendChild(tr);
  });
}

function renderMempool(list){
  el('#mpCount').textContent = list.length;
  const tb = tbody('#tblMempool');
  tb.innerHTML='';
  list.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">
        <a class="hash" title="${t.tx_id||''}" onclick="copy('${t.tx_id||''}')">${short(t.tx_id||'—')}</a>
      </td>
      <td class="mono"><a class="addr" onclick="copy('${t.from||''}')">${short(t.from||'—')}</a></td>
      <td class="mono"><a class="addr" onclick="copy('${t.to||''}')">${short(t.to||'—')}</a></td>
      <td>${fmtN(t.amount)}</td>
      <td>${fmtN(t.fee_burned)}</td>
      <td>${t.status||'pending'}</td>
      <td class="muted">${rel(t.timestamp)}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== Live Stats ===== */
const hrSeries = [];
function pushSpark(val){
  hrSeries.push(val||0);
  while(hrSeries.length>60) hrSeries.shift(); // last 60 samples
  const c = el('#sparkHR'); const ctx=c.getContext('2d');
  const W=c.width = c.clientWidth, H=c.height = c.clientHeight;
  ctx.clearRect(0,0,W,H);
  const max = Math.max(...hrSeries, 1);
  const step = W / Math.max(1, hrSeries.length-1);
  ctx.beginPath();
  hrSeries.forEach((v,i)=>{
    const x = i*step;
    const y = H - (v/max)*H;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#22ff77'; ctx.lineWidth = 1.5; ctx.stroke();
}

async function loadLive(){
  try{
    const r = await fetch('/api/network_live'); const j = await r.json();
    el('#liveDiff').textContent = j.difficulty?.toLocaleString() ?? '—';
    el('#liveABT').textContent = j.avg_block_time_sec ? (j.avg_block_time_sec.toFixed(1)+'s') : '—';
    el('#liveHR').textContent  = j.est_hashrate_hs ? (Intl.NumberFormat('en',{notation:'compact'}).format(j.est_hashrate_hs)+' H/s') : '—';
    el('#liveMP').textContent  = j.mempool ?? '0';
    pushSpark(j.est_hashrate_hs||0);
  }catch(e){
    console.error('Live network stats update failed:', e);
  }
}

/* ===== Fetchers ===== */
async function reloadBlocks(){
  const r = await fetch('/api/blocks'); const j = await r.json();
  CURRENT_BLOCKS = j;
  renderBlocks(CURRENT_BLOCKS);
}
async function reloadMempool(){
  const r = await fetch('/api/mempool'); const j = await r.json();
  renderMempool(j);
}

/* ===== Wireup ===== */
let CURRENT_BLOCKS = BOOT_BLOCKS || [];
let CURRENT_TXS    = BOOT_TXS || [];

renderBlocks(CURRENT_BLOCKS);
renderTxs(CURRENT_TXS);

el('#q').addEventListener('input', ()=>{
  renderBlocks(CURRENT_BLOCKS);
  renderTxs(CURRENT_TXS);
});
el('#clearBtn').onclick=()=>{ el('#q').value=''; renderBlocks(CURRENT_BLOCKS); renderTxs(CURRENT_TXS); };
el('#refreshBtn').onclick=reloadBlocks;
el('#btnLoadMempool')?.addEventListener('click', reloadMempool);

// live refresh ticker
setInterval(()=>{
  loadLive();
  el('#liveClock').textContent = new Date().toLocaleTimeString();
}, 5000);

// first live ping
loadLive();
reloadMempool();

// highlight recent on first paint
setTimeout(()=>renderBlocks(CURRENT_BLOCKS), 100);

/* polite defaults for older servers with no data passed */
if(!Array.isArray(CURRENT_BLOCKS)) CURRENT_BLOCKS=[];
if(!Array.isArray(CURRENT_TXS)) CURRENT_TXS=[];
</script>
</body>
</html>
