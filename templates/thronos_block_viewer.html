{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Thronos Block Explorer</h1>
        <div class="flex gap-2">
            <button onclick="switchTab('blocks')" id="btn-blocks" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 transition">Blocks</button>
            <button onclick="switchTab('txs')" id="btn-txs" class="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition">Transactions</button>
            <button onclick="switchTab('mempool')" id="btn-mempool" class="px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition">Mempool</button>
        </div>
    </div>

    <!-- Network Intelligence (Live) -->
    <section id="network" class="mb-8 bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700">
        <h3 class="text-xl font-semibold text-blue-400 mb-3">Network Intelligence (Live)</h3>
        <div id="net-stats" class="font-mono text-sm text-gray-300 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>Loading stats...</div>
        </div>
    </section>

    <!-- Search Bar -->
    <div class="mb-6">
        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Search by Hash, Address, or TX ID..." 
               class="w-full px-4 py-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:border-blue-500 transition">
    </div>

    <!-- Blocks Table -->
    <div id="blocks-view" class="overflow-x-auto bg-gray-800 rounded-lg shadow-xl">
        <table class="min-w-full text-left text-gray-300" id="blocksTable">
            <thead class="bg-gray-700 text-gray-100 uppercase font-semibold text-sm">
                <tr>
                    <th class="px-6 py-3">Height</th>
                    <th class="px-6 py-3">Block Hash</th>
                    <th class="px-6 py-3">Miner THR</th>
                    <th class="px-6 py-3">Reward (Miner)</th>
                    <th class="px-6 py-3">Reward (AI)</th>
                    <th class="px-6 py-3">Fee Burned</th>
                    <th class="px-6 py-3">Type</th>
                    <th class="px-6 py-3">Nonce</th>
                    <th class="px-6 py-3">Timestamp</th>
                </tr>
            </thead>
            <tbody id="blocks-body" class="divide-y divide-gray-600">
                <!-- Initial Render via Jinja2 (SEO/Fast Load) -->
                {% for block in blocks %}
                <tr class="hover:bg-gray-700 transition-colors">
                    <td class="px-6 py-4">{{ block.index }}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span id="hash-{{ loop.index }}" class="font-mono text-xs break-all">{{ block.hash }}</span>
                            <button onclick="copy_to_clipboard('hash-{{ loop.index }}')" class="text-blue-400 hover:text-blue-300 p-1 rounded transition" title="Copy Hash">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-mono text-xs">
                        {% if block.transactions %}
                           {% set coinbase = block.transactions | selectattr("type", "equalto", "coinbase") | first %}
                           {{ coinbase.to if coinbase else '-' }}
                        {% else %}
                           -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-green-400">{{ block.reward_to_miner }}</td>
                    <td class="px-6 py-4 text-purple-400">{{ block.reward_to_ai }}</td>
                    <td class="px-6 py-4 text-red-400">{{ block.fee_burned }}</td>
                    <td class="px-6 py-4 text-xs uppercase">{{ 'Stratum' if block.is_stratum else 'Legacy' }}</td>
                    <td class="px-6 py-4 font-mono text-sm">{{ block.nonce }}</td>
                    <td class="px-6 py-4 text-xs text-gray-400">{{ block.timestamp }}</td>
                </tr>
                <!-- Transactions Sub-row -->
                {% if block.transactions %}
                <tr>
                    <td colspan="9" class="px-6 py-2 bg-gray-750 text-xs text-gray-400">
                        {% for tx in block.transactions %}
                        <div class="mb-1 font-mono">
                            <span class="text-blue-300">{{ tx.tx_id }}</span> — <b class="text-white">{{ tx.type }}</b> — from {{ tx.from }} to {{ tx.to }} : <b class="text-yellow-400">{{ tx.amount }}</b> (fee {{ tx.fee_burned }})
                        </div>
                        {% endfor %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Transactions Table -->
    <div id="txs-view" class="hidden overflow-x-auto bg-gray-800 rounded-lg shadow-xl">
        <table class="min-w-full text-left text-gray-300" id="txsTable">
            <thead class="bg-gray-700 text-gray-100 uppercase font-semibold text-sm">
                <tr>
                    <th class="px-6 py-3">TX ID</th>
                    <th class="px-6 py-3">From</th>
                    <th class="px-6 py-3">To</th>
                    <th class="px-6 py-3">Amount</th>
                    <th class="px-6 py-3">Time</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-600">
                {% for tx in transactions %}
                <tr class="hover:bg-gray-700 transition-colors">
                    <td class="px-6 py-4 font-mono text-xs">{{ tx.tx_id }}</td>
                    <td class="px-6 py-4 font-mono text-xs">{{ tx.from }}</td>
                    <td class="px-6 py-4 font-mono text-xs">{{ tx.to }}</td>
                    <td class="px-6 py-4 text-yellow-400 font-bold">{{ tx.amount }} THR</td>
                    <td class="px-6 py-4 text-sm text-gray-400">{{ tx.timestamp }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mempool View -->
    <div id="mempool-view" class="hidden bg-gray-800 rounded-lg shadow-xl p-6">
        <h3 class="text-xl font-bold text-yellow-400 mb-4">Pending Transactions (Mempool)</h3>
        <button onclick="showMempool()" class="mb-4 px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white">Refresh Mempool</button>
        <textarea id="mempoolBox" rows="12" class="w-full bg-gray-900 text-green-400 font-mono text-xs p-4 rounded border border-gray-700 focus:outline-none" readonly>Loading...</textarea>
    </div>
</div>

<script>
function copy_to_clipboard(elm_id) {
    const text = document.getElementById(elm_id).textContent;
    navigator.clipboard.writeText(text).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

function switchTab(tab) {
    const blocksView = document.getElementById('blocks-view');
    const txsView = document.getElementById('txs-view');
    const mempoolView = document.getElementById('mempool-view');
    
    const btnBlocks = document.getElementById('btn-blocks');
    const btnTxs = document.getElementById('btn-txs');
    const btnMempool = document.getElementById('btn-mempool');

    // Reset all
    blocksView.classList.add('hidden');
    txsView.classList.add('hidden');
    mempoolView.classList.add('hidden');
    
    btnBlocks.className = 'px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition';
    btnTxs.className = 'px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition';
    btnMempool.className = 'px-4 py-2 bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition';

    // Activate selected
    if (tab === 'blocks') {
        blocksView.classList.remove('hidden');
        btnBlocks.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 transition';
    } else if (tab === 'txs') {
        txsView.classList.remove('hidden');
        btnTxs.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 transition';
    } else if (tab === 'mempool') {
        mempoolView.classList.remove('hidden');
        btnMempool.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 transition';
        showMempool();
    }
}

async function showMempool() {
  const box = document.getElementById('mempoolBox');
  box.value = "Loading mempool...";
  try {
      const res = await fetch('/api/mempool');
      const data = await res.json();
      if (data.length === 0) {
          box.value = "Mempool is empty. All transactions confirmed.";
      } else {
          box.value = JSON.stringify(data, null, 2);
      }
  } catch(e) {
      box.value = "Error loading mempool.";
  }
}

function searchTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const activeTable = document.getElementById('blocks-view').classList.contains('hidden') ? 'txsTable' : 'blocksTable';
    const table = document.getElementById(activeTable);
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        let visible = false;
        const tds = tr[i].getElementsByTagName('td');
        for (let j = 0; j < tds.length; j++) {
            if (tds[j]) {
                const txtValue = tds[j].textContent || tds[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    visible = true;
                    break;
                }
            }
        }
        tr[i].style.display = visible ? "" : "none";
    }
}

// Live Network Stats
async function pollNet() {
  try {
    const r = await fetch('/api/network_live');
    const j = await r.json();
    const hs = j.est_hashrate_hs ? (j.est_hashrate_hs/1e9).toFixed(3) + ' GH/s' : 'n/a';
    const t = `
      <div>Difficulty: <b class="text-white">${j.difficulty}</b></div>
      <div>Avg Block Time: <b class="text-white">${j.avg_block_time_sec ? j.avg_block_time_sec.toFixed(1) : 'n/a'} sec</b></div>
      <div>Est. Hashrate: <b class="text-white">${hs}</b></div>
      <div>Total TXs: <b class="text-white">${j.tx_count}</b></div>
      <div>Mempool Size: <b class="text-yellow-400">${j.mempool}</b></div>
    `;
    document.getElementById('net-stats').innerHTML = t;
  } catch(_) {}
}

// Live Block Updates (Client-Side Rendering)
async function loadBlocks() {
  const res = await fetch('/api/blocks');
  const blocks = await res.json();

  const tbody = document.getElementById('blocks-body');
  tbody.innerHTML = '';

  for (const b of blocks) {
    const tr = document.createElement('tr');
    tr.className = "hover:bg-gray-700 transition-colors";
    const tType = b.is_stratum ? 'Stratum' : 'Legacy';
    
    // Find coinbase TX for Miner Address
    let minerAddr = '-';
    if (b.transactions) {
        const cb = b.transactions.find(tx => tx.type === 'coinbase');
        if (cb) minerAddr = cb.to;
    }

    tr.innerHTML = `
      <td class="px-6 py-4">${b.index}</td>
      <td class="px-6 py-4">
        <div class="flex items-center gap-2">
            <span class="font-mono text-xs break-all">${b.hash}</span>
        </div>
      </td>
      <td class="px-6 py-4 font-mono text-xs">${minerAddr}</td>
      <td class="px-6 py-4 text-green-400">${(b.reward_to_miner ?? 0).toFixed(6)}</td>
      <td class="px-6 py-4 text-purple-400">${(b.reward_to_ai ?? 0).toFixed(6)}</td>
      <td class="px-6 py-4 text-red-400">${(b.fee_burned ?? 0).toFixed(6)}</td>
      <td class="px-6 py-4 text-xs uppercase">${tType}</td>
      <td class="px-6 py-4 font-mono text-sm">${b.nonce}</td>
      <td class="px-6 py-4 text-xs text-gray-400">${b.timestamp || ''}</td>
    `;

    tbody.appendChild(tr);

    // TXs Sub-row
    if (b.transactions && b.transactions.length) {
      const trx = document.createElement('tr');
      const txHtml = b.transactions.map(tx => {
        return `<div class="mb-1 font-mono">
          <span class="text-blue-300">${tx.tx_id}</span> — <b class="text-white">${tx.type}</b> — from ${tx.from || '-'} to ${tx.to || '-'} : <b class="text-yellow-400">${tx.amount ?? '-'}</b> (fee ${tx.fee_burned ?? 0})
        </div>`;
      }).join('');
      trx.innerHTML = `<td colspan="9" class="px-6 py-2 bg-gray-750 text-xs text-gray-400">${txHtml}</td>`;
      tbody.appendChild(trx);
    }
  }
}

// Start Polling
pollNet();
setInterval(pollNet, 5000);
setInterval(loadBlocks, 6000);
</script>
{% endblock %}
