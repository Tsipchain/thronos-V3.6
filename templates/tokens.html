{% extends "base.html" %}

{% block title %}ğŸª™ Experimental Tokens - Thronos Network{% endblock %}

{% block styles %}
<style>
  .tokens-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .tokens-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
    border: 2px solid;
    border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
    border-radius: 16px;
    box-shadow: 0 0 30px rgba(0, 255, 102, 0.3);
  }

  .tokens-header h1 {
    background: linear-gradient(135deg, #ffd700 0%, #00ff00 50%, #ffed4e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5em;
    margin-bottom: 10px;
  }

  .tokens-tagline {
    color: #00ff66;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 2px;
    opacity: 0.8;
  }

  .tokens-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .token-card {
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.8) 0%, rgba(26, 59, 46, 0.1) 100%);
    border: 1px solid #1a3b2e;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .token-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
    transition: left 0.5s;
  }

  .token-card:hover {
    background: linear-gradient(135deg, rgba(26, 59, 46, 0.3) 0%, rgba(10, 10, 10, 0.9) 100%);
    border-color: #00ff66;
    box-shadow: 0 0 20px rgba(0, 255, 102, 0.2), inset 0 0 10px rgba(0, 255, 102, 0.05);
    transform: translateY(-4px);
  }

  .token-card:hover::before {
    left: 100%;
  }

  .token-card-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .token-logo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #000;
    border: 2px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    filter: drop-shadow(0 0 8px rgba(0, 255, 102, 0.5));
  }

  .token-logo img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .token-info h3 {
    margin: 0 0 5px 0;
    font-size: 1.3em;
  }

  .token-symbol {
    font-size: 0.9em;
    opacity: 0.8;
  }

  .token-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 15px;
  }

  .token-stat {
    background: rgba(0, 255, 102, 0.05);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(0, 255, 102, 0.1);
  }

  .token-stat-label {
    font-size: 0.75em;
    color: #666;
    text-transform: uppercase;
  }

  .token-stat-value {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 5px;
    font-family: monospace;
  }

  .token-creator {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(0, 255, 102, 0.1);
    font-size: 0.8em;
    color: #666;
  }

  .create-token-section {
    background: linear-gradient(135deg, #000000 0%, #071810 50%, #000000 100%);
    border: 2px solid;
    border-image: linear-gradient(135deg, #d4af37 0%, #00ff66 50%, #ffd700 100%) 1;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 0 30px rgba(0, 255, 102, 0.3);
  }

  .create-token-section h2 {
    background: linear-gradient(135deg, #ffd700 0%, #00ff00 50%, #ffed4e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 20px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    display: block;
    color: #00ff66;
    margin-bottom: 8px;
    font-weight: bold;
    font-size: 0.9em;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 12px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #1a3b2e;
    border-radius: 8px;
    color: #00ff00;
    font-family: "Courier New", monospace;
    font-size: 1em;
    transition: all 0.3s;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #00ff66;
    box-shadow: 0 0 15px rgba(0, 255, 102, 0.2);
  }

  .logo-upload-area {
    border: 2px dashed #1a3b2e;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(0, 255, 102, 0.02);
  }

  .logo-upload-area:hover {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.05);
  }

  .logo-upload-area.has-file {
    border-color: #00ff66;
    background: rgba(0, 255, 102, 0.1);
  }

  .logo-preview {
    width: 100px;
    height: 100px;
    margin: 0 auto 15px;
    border-radius: 50%;
    border: 2px solid #00ff66;
    display: none;
    overflow: hidden;
  }

  .logo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .fee-info {
    background: rgba(255, 102, 0, 0.1);
    border: 1px solid #ff6600;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .fee-info-icon {
    font-size: 2em;
  }

  .fee-info-text {
    flex: 1;
  }

  .fee-amount {
    font-size: 1.2em;
    font-weight: bold;
    color: #ffd700;
  }

  .btn-create-token {
    background: linear-gradient(135deg, #00ff00 0%, #00ff66 100%);
    color: #000;
    border: 2px solid #00ff66;
    padding: 15px 40px;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 0 15px rgba(0, 255, 102, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .btn-create-token:hover {
    background: linear-gradient(135deg, #00ff66 0%, #ffed4e 100%);
    border-color: #ffd700;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
    transform: translateY(-2px);
  }

  .btn-create-token:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .message-box {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    display: none;
  }

  .message-box.success {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    color: #00ff00;
  }

  .message-box.error {
    background: rgba(255, 0, 0, 0.1);
    border: 1px solid #ff0000;
    color: #ff0000;
  }

  .loading {
    text-align: center;
    padding: 40px;
    color: #00ff66;
  }

  .loading .spinner {
    border: 3px solid rgba(0, 255, 102, 0.1);
    border-top: 3px solid #00ff66;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .empty-state-icon {
    font-size: 4em;
    margin-bottom: 20px;
    opacity: 0.3;
  }
</style>
{% endblock %}

{% block content %}
<div class="tokens-container">
  <!-- Header -->
  <div class="tokens-header">
    <h1>ğŸª™ <span class="lang-el">Î ÎµÎ¹ÏÎ±Î¼Î±Ï„Î¹ÎºÎ¬ Tokens</span><span class="lang-en">Experimental Tokens</span></h1>
    <p class="tokens-tagline">
      <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ token ÏƒÏ„Î¿ Thronos Network</span>
      <span class="lang-en">Create your own token on Thronos Network</span>
    </p>
  </div>

  <!-- Existing Tokens Grid -->
  <div id="tokensSection">
    <div id="tokensLoading" class="loading">
      <div class="spinner"></div>
      <p><span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· tokens...</span><span class="lang-en">Loading tokens...</span></p>
    </div>
    <div id="tokensGrid" class="tokens-grid" style="display:none;"></div>
    <div id="tokensEmpty" class="empty-state" style="display:none;">
      <div class="empty-state-icon">ğŸª™</div>
      <p><span class="lang-el">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ¹ÏÎ±Î¼Î±Ï„Î¹ÎºÎ¬ tokens Î±ÎºÏŒÎ¼Î±</span><span class="lang-en">No experimental tokens yet</span></p>
      <p><span class="lang-el">Î“Î¯Î½Îµ Î¿ Ï€ÏÏÏ„Î¿Ï‚ Ï€Î¿Ï… Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î­Î½Î±!</span><span class="lang-en">Be the first to create one!</span></p>
    </div>
  </div>

  <!-- Create Token Section -->
  <div class="create-token-section">
    <h2>ğŸ”¥ <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎÎ­Î¿Ï… Token</span><span class="lang-en">Create New Token</span></h2>

    <div class="fee-info">
      <div class="fee-info-icon">ğŸ’</div>
      <div class="fee-info-text">
        <div><span class="lang-el">ÎšÏŒÏƒÏ„Î¿Ï‚ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚</span><span class="lang-en">Creation Fee</span></div>
        <div class="fee-amount">100 THR</div>
      </div>
    </div>

    <form id="createTokenForm" onsubmit="return submitToken(event);">
      <div class="form-grid">
        <div class="form-group">
          <label for="tokenName">
            <span class="lang-el">ÎŒÎ½Î¿Î¼Î± Token</span>
            <span class="lang-en">Token Name</span>
          </label>
          <input type="text" id="tokenName" placeholder="My Amazing Token" required>
        </div>

        <div class="form-group">
          <label for="tokenSymbol">
            <span class="lang-el">Î£ÏÎ¼Î²Î¿Î»Î¿ (max 8 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚)</span>
            <span class="lang-en">Symbol (max 8 chars)</span>
          </label>
          <input type="text" id="tokenSymbol" placeholder="MAT" maxlength="8" required>
        </div>

        <div class="form-group">
          <label for="tokenSupply">
            <span class="lang-el">Î‘ÏÏ‡Î¹ÎºÎ® Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬</span>
            <span class="lang-en">Initial Supply</span>
          </label>
          <input type="number" step="0.000001" id="tokenSupply" placeholder="1000000" required>
        </div>

        <div class="form-group">
          <label for="tokenDecimals">
            <span class="lang-el">Î”ÎµÎºÎ±Î´Î¹ÎºÎ¬ (0-18)</span>
            <span class="lang-en">Decimals (0-18)</span>
          </label>
          <input type="number" step="1" id="tokenDecimals" min="0" max="18" value="6" required>
        </div>

        <div class="form-group full-width">
          <label for="tokenColor">
            <span class="lang-el">Î§ÏÏÎ¼Î± (HEX)</span>
            <span class="lang-en">Color (HEX)</span>
          </label>
          <input type="color" id="tokenColor" value="#00ff66" required>
        </div>

        <div class="form-group full-width">
          <label for="tokenDescription">
            <span class="lang-el">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</span>
            <span class="lang-en">Description</span>
          </label>
          <textarea id="tokenDescription" rows="3" placeholder="Describe your token..."></textarea>
        </div>

        <div class="form-group full-width">
          <label>
            <span class="lang-el">Î”Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Token</span>
            <span class="lang-en">Token Permissions</span>
          </label>
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="tokenTransferable" checked style="width: auto; cursor: pointer;">
              <span style="color: #e6ffe5;">
                <span class="lang-el">ÎœÎµÏ„Î±Ï†Î­ÏÎµÏ„Î±Î¹</span>
                <span class="lang-en">Transferable</span>
              </span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="tokenBurnable" style="width: auto; cursor: pointer;">
              <span style="color: #e6ffe5;">
                <span class="lang-el">ÎšÎ±Î¯Î³ÎµÏ„Î±Î¹</span>
                <span class="lang-en">Burnable</span>
              </span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="tokenMintable" style="width: auto; cursor: pointer;">
              <span style="color: #e6ffe5;">
                <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎÎ­Ï‰Î½</span>
                <span class="lang-en">Mintable</span>
              </span>
            </label>
          </div>
          <p style="font-size: 0.8em; color: #666; margin-top: 10px;">
            <span class="lang-el">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï€Î¿Î¹Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î¸Î± Î­Ï‡ÎµÎ¹ Ï„Î¿ token ÏƒÎ±Ï‚</span>
            <span class="lang-en">Select which permissions your token will have</span>
          </p>
        </div>

        <div class="form-group full-width">
          <label>
            <span class="lang-el">Logo Token (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</span>
            <span class="lang-en">Token Logo (optional)</span>
          </label>
          <div class="logo-upload-area" id="logoUploadArea" onclick="document.getElementById('logoFile').click()">
            <div class="logo-preview" id="logoPreview">
              <img id="logoPreviewImg" src="" alt="Logo preview">
            </div>
            <input type="file" id="logoFile" accept="image/png,image/jpeg,image/jpg,image/gif" style="display:none;" onchange="handleLogoUpload(event)">
            <div id="logoUploadText">
              <p>ğŸ“ <span class="lang-el">ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº Î³Î¹Î± Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÏ„Îµ logo</span><span class="lang-en">Click to upload logo</span></p>
              <p style="font-size: 0.8em; color: #666;"><span class="lang-el">PNG, JPG Î® GIF (max 2MB)</span><span class="lang-en">PNG, JPG or GIF (max 2MB)</span></p>
            </div>
          </div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 30px;">
        <button type="submit" class="btn-create-token" id="createBtn">
          ğŸš€ <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Token</span><span class="lang-en">Create Token</span>
        </button>
      </div>
    </form>

    <div id="tokenMsg" class="message-box"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let uploadedLogo = null;

async function loadTokens() {
  try {
    const res = await fetch('/api/tokens/list');
    const data = await res.json();
    const grid = document.getElementById('tokensGrid');
    const loading = document.getElementById('tokensLoading');
    const empty = document.getElementById('tokensEmpty');

    loading.style.display = 'none';

    if (data.ok && data.tokens && data.tokens.length > 0) {
      grid.innerHTML = '';
      data.tokens.forEach(tok => {
        const card = document.createElement('div');
        card.className = 'token-card';

        const logoUrl = tok.logo_url || tok.logo || (tok.logo_path ? `/media/${tok.logo_path}` : '');
        const logoHtml = logoUrl
          ? `<img src="${logoUrl}" alt="${tok.symbol}" onerror="this.onerror=null; this.src='/static/img/logo.png';">`
          : `<span style="color: ${tok.color}">${tok.symbol[0]}</span>`;

        // Permission badges
        const permissions = [];
        if (tok.transferable !== false) permissions.push('ğŸ“¤ Transferable');
        if (tok.burnable) permissions.push('ğŸ”¥ Burnable');
        if (tok.mintable) permissions.push('âš¡ Mintable');
        const permissionHtml = permissions.length > 0
          ? `<div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
              ${permissions.map(p => `<span style="font-size: 0.7em; background: rgba(0,255,102,0.1); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(0,255,102,0.2);">${p}</span>`).join('')}
             </div>`
          : '';

        card.innerHTML = `
          <div class="token-card-header">
            <div class="token-logo" style="border-color: ${tok.color};">
              ${logoHtml}
            </div>
            <div class="token-info">
              <h3 style="color: ${tok.color}">${tok.name}</h3>
              <div class="token-symbol">${tok.symbol}</div>
            </div>
          </div>
          ${permissionHtml}
          <div class="token-stats">
            <div class="token-stat">
              <div class="token-stat-label">Supply</div>
              <div class="token-stat-value" style="color: ${tok.color}">${tok.current_supply.toLocaleString()}</div>
            </div>
            <div class="token-stat">
              <div class="token-stat-label">Decimals</div>
              <div class="token-stat-value">${tok.decimals}</div>
            </div>
          </div>
          <div class="token-creator">
            Created by: ${tok.creator.slice(0, 12)}...${tok.creator.slice(-8)}
          </div>
        `;

        grid.appendChild(card);
      });
      grid.style.display = 'grid';
    } else {
      empty.style.display = 'block';
    }
  } catch (e) {
    document.getElementById('tokensLoading').innerHTML = '<p style="color: #ff0000;">Error loading tokens</p>';
  }
}

function handleLogoUpload(evt) {
  const file = evt.target.files[0];
  if (!file) return;

  if (file.size > 2 * 1024 * 1024) {
    alert('File too large! Max 2MB');
    return;
  }

  uploadedLogo = file;

  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('logoPreviewImg').src = e.target.result;
    document.getElementById('logoPreview').style.display = 'block';
    document.getElementById('logoUploadArea').classList.add('has-file');
    document.getElementById('logoUploadText').innerHTML = '<p>âœ… Logo uploaded successfully</p>';
  };
  reader.readAsDataURL(file);
}

async function submitToken(evt) {
  evt.preventDefault();

  const name = document.getElementById('tokenName').value.trim();
  const symbol = document.getElementById('tokenSymbol').value.trim().toUpperCase();
  const supply = parseFloat(document.getElementById('tokenSupply').value);
  const decimals = parseInt(document.getElementById('tokenDecimals').value);
  const color = document.getElementById('tokenColor').value;
  const description = document.getElementById('tokenDescription').value.trim();

  const creator = localStorage.getItem('thr_address');
  if (!creator) {
    showMessage('Please connect your wallet first!', 'error');
    return false;
  }

  const createBtn = document.getElementById('createBtn');
  createBtn.disabled = true;
  createBtn.textContent = 'â³ Creating...';

  try {
    // Get permission flags
    const transferable = document.getElementById('tokenTransferable').checked;
    const burnable = document.getElementById('tokenBurnable').checked;
    const mintable = document.getElementById('tokenMintable').checked;

    // Use FormData for token creation (supports logo upload in single request)
    const formData = new FormData();
    formData.append('creator_address', creator);
    formData.append('name', name);
    formData.append('symbol', symbol);
    formData.append('initial_supply', supply);
    formData.append('max_supply', 0);
    formData.append('decimals', decimals);
    formData.append('color', color);
    formData.append('description', description || `${name} token on Thronos Network`);
    formData.append('transferable', transferable);
    formData.append('burnable', burnable);
    formData.append('mintable', mintable);

    // Include logo if uploaded
    if (uploadedLogo) {
      formData.append('logo', uploadedLogo);
    }

    const res = await fetch('/api/tokens/create', {
      method: 'POST',
      body: formData  // No Content-Type header - browser sets it with boundary
    });

    const data = await res.json();

    if (!data.ok) {
      throw new Error(data.error || 'Failed to create token');
    }

    // Show success with logo confirmation
    const logoMsg = uploadedLogo ? ' Logo uploaded!' : '';
    showMessage(`âœ… Token ${symbol} created successfully!${logoMsg} Fee: 100 THR deducted.`, 'success');
    await loadTokens();
    document.getElementById('createTokenForm').reset();
    document.getElementById('logoPreview').style.display = 'none';
    document.getElementById('logoUploadArea').classList.remove('has-file');
    uploadedLogo = null;

  } catch (e) {
    showMessage(`âŒ Error: ${e.message}`, 'error');
  } finally {
    createBtn.disabled = false;
    createBtn.innerHTML = 'ğŸš€ <span class="lang-el">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Token</span><span class="lang-en">Create Token</span>';
  }

  return false;
}

function showMessage(text, type) {
  const msgBox = document.getElementById('tokenMsg');
  msgBox.textContent = text;
  msgBox.className = `message-box ${type}`;
  msgBox.style.display = 'block';

  setTimeout(() => {
    msgBox.style.display = 'none';
  }, 5000);
}

document.addEventListener('DOMContentLoaded', () => {
  loadTokens();
});
</script>
{% endblock %}
