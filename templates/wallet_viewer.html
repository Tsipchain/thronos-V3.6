{% extends "base.html" %}

{% block title %}ğŸ’¼ Thronos Wallet{% endblock %}

{% block styles %}
<style>
    .wallet-card {
        background: #111;
        border: 1px solid #0f0;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    input, button {
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 10px;
        margin: 5px 0;
        font-family: monospace;
        width: 100%;
        box-sizing: border-box;
    }
    button { 
        cursor: pointer; 
        font-weight: bold;
        background: #0f0;
        color: #000;
    }
    button:hover { background: #0c0; }
    button.secondary {
        background: transparent;
        color: #0f0;
    }
    button.secondary:hover {
        background: #111;
    }
    
    .tx {
        margin-top: 10px;
        border-bottom: 1px dashed #333;
        padding: 10px 0;
    }
    .tx-filters {
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        margin-bottom:8px;
    }
    .tx-filter-btn {
        padding:6px 10px;
        border:1px solid #0f0;
        background:#000;
        color:#0f0;
        cursor:pointer;
        border-radius:6px;
    }
    .tx-filter-btn.active { background:#0f0; color:#000; }
    .btc-val {
        color: #ff0;
        font-size: 0.9em;
    }
    .hidden { display: none; }
    
    .balance-large {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .fire-icon-wallet {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 0 8px #ff6600);
        animation: glow 2s ease-in-out infinite;
    }
    @keyframes glow {
        0%, 100% { filter: drop-shadow(0 0 8px #ff6600); }
        50% { filter: drop-shadow(0 0 16px #ff9900) drop-shadow(0 0 24px #ff6600); }
    }
</style>
{% endblock %}

{% block content %}
  <h1>ğŸ’¼ <span class="lang-el">Î¤Î¿ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ Î¼Î¿Ï…</span><span class="lang-en">My Wallet</span></h1>

  <!-- CONNECT SECTION -->
  <div id="connectSection" class="wallet-card">
      <h2><span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ· Î Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï</span><span class="lang-en">Connect Wallet</span></h2>
      <p><span class="lang-el">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ. Î¤Î± ÎºÎ»ÎµÎ¹Î´Î¹Î¬ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ Ï„Î¿Ï€Î¹ÎºÎ¬ (browser).</span><span class="lang-en">Enter your credentials to connect. Keys are stored locally in your browser.</span></p>
      
      <label><span class="lang-el">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· THR</span><span class="lang-en">THR Address</span></label>
      <input type="text" id="inputAddress" placeholder="THR..." />
      
      <label><span class="lang-el">ÎœÏ…ÏƒÏ„Î¹ÎºÏŒ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î®, Î‘Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ Î³Î¹Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®)</span><span class="lang-en">Send Secret (Optional for view, Required for send)</span></label>
      <input type="password" id="inputSecret" placeholder="auth_secret..." />
      
      <button onclick="connectWallet()">ğŸ”“ <span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ·</span><span class="lang-en">Connect</span></button>
      <p style="font-size:0.8em; color:#666;">
          <span class="lang-el">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹;</span><span class="lang-en">Don't have a wallet?</span> 
          <a href="/pledge">ğŸ”¥ Pledge to create one</a>
      </p>
  </div>

  <!-- DASHBOARD SECTION -->
  <div id="dashboardSection" class="hidden">
      <div class="wallet-card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:10px;">
                  <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="ğŸ”¥" class="fire-icon-wallet" />
                  <strong><span id="displayAddress">THR...</span></strong>
              </div>
              <button class="secondary" style="width:auto; padding:5px 10px;" onclick="disconnectWallet()">âŒ <span class="lang-el">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</span><span class="lang-en">Disconnect</span></button>
          </div>
          
          <div class="balance-large">
              <span id="balance">0</span> THR
          </div>
          <div class="btc-val">â‰ˆ <span id="btcValue">0.0000</span> BTC</div>
          
          <div style="margin-top:20px; display:flex; gap:10px;">
              <button onclick="window.location.href='/send'">ğŸ“¤ <span class="lang-el">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</span><span class="lang-en">Send</span></button>
              <button class="secondary" onclick="refreshWallet()">ğŸ”„ <span class="lang-el">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</span><span class="lang-en">Refresh</span></button>
          </div>
      </div>

      <h3><span class="lang-el">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î£Ï…Î½Î±Î»Î»Î±Î³ÏÎ½</span><span class="lang-en">Transaction History</span></h3>
      <div class="tx-filters">
        <button class="tx-filter-btn active" data-filter="all" onclick="renderTxHistory('all')">All</button>
        <button class="tx-filter-btn" data-filter="transfers" onclick="renderTxHistory('transfers')">Transfers</button>
        <button class="tx-filter-btn" data-filter="tokens" onclick="renderTxHistory('tokens')">Tokens</button>
        <button class="tx-filter-btn" data-filter="swaps" onclick="renderTxHistory('swaps')">Swaps</button>
      </div>
      <div id="txHistory" class="wallet-card">
          <span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span><span class="lang-en">Loading...</span>
      </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
    // --- Logic ---
    const $ = (id) => document.getElementById(id);

    function checkConnection() {
        const addr = localStorage.getItem('thr_address');
        if (addr) {
            $('connectSection').classList.add('hidden');
            $('dashboardSection').classList.remove('hidden');
            $('displayAddress').textContent = addr;
            currentAddress = addr;
            loadWalletData(addr);
        } else {
            $('connectSection').classList.remove('hidden');
            $('dashboardSection').classList.add('hidden');
        }
    }

    function connectWallet() {
        const addr = $('inputAddress').value.trim();
        const secret = $('inputSecret').value.trim();
        
        if (!addr) {
            alert("Please enter a THR address.");
            return;
        }
        
        localStorage.setItem('thr_address', addr);
        if (secret) {
            localStorage.setItem('thr_secret', secret);
        }

        currentAddress = addr;
        checkConnection();
    }

    function disconnectWallet() {
        if(confirm("Are you sure? This will clear your stored keys from this browser.")) {
            localStorage.removeItem('thr_address');
            localStorage.removeItem('thr_secret');
            window.location.reload();
        }
    }

    async function refreshWallet() {
        const addr = localStorage.getItem('thr_address');
        if (addr) loadWalletData(addr);
    }

    // FIX 4C: Format token amounts with proper decimals and no scientific notation
    function formatTokenAmount(amount, decimals) {
      const decimalPlaces = decimals || 6;
      const num = parseFloat(amount) || 0;
      // Prevent scientific notation by using toFixed
      return num.toFixed(decimalPlaces);
    }

    let walletTxs = [];
    let currentFilter = 'all';
    let currentAddress = '';
    let tokenDecimals = 6;

    function renderTxHistory(filter) {
      if (filter) currentFilter = filter;
      const div = $('txHistory');
      const btns = document.querySelectorAll('.tx-filter-btn');
      btns.forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter));

      const txs = walletTxs || [];
      if (!txs.length) {
        div.innerHTML = '<p style="color:#666;">No transactions found.</p>';
        return;
      }

      const filtered = txs.filter(tx => {
        const kind = (tx.kind || tx.type || '').toLowerCase();
        const asset = (tx.asset_symbol || tx.asset || tx.token_symbol || 'THR').toUpperCase();
        if (currentFilter === 'tokens') return kind === 'token_transfer';
        if (currentFilter === 'swaps') return kind === 'swap';
        if (currentFilter === 'transfers') return kind !== 'swap' && kind !== 'token_transfer';
        return true;
      });

      if (!filtered.length) {
        div.innerHTML = '<p style="color:#666;">No transactions match this filter.</p>';
        return;
      }

      let html = "";
      filtered.forEach(tx => {
        const isIncoming = tx.direction === 'in' || tx.to === currentAddress;
        const isSwap = tx.direction === 'swap' || (tx.kind || tx.type) === 'swap';
        const color = isSwap ? '#0ff' : (isIncoming ? '#0f0' : '#ff0');
        const sign = isSwap ? 'â†”ï¸' : (isIncoming ? '+' : '-');
        const asset = (tx.asset_symbol || tx.asset || tx.token_symbol || 'THR').toUpperCase();
        const decimals = tx.decimals || tokenDecimals;
        const formattedAmount = formatTokenAmount(tx.display_amount ?? tx.amount ?? 0, decimals);
        const label = (tx.category_label || tx.kind || tx.type || '').toString().toUpperCase();

        html += `
            <div class="tx">
              <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
                  <span style="color:#fff;">${tx.timestamp || ''}</span>
                  <span style="color:${color}; font-weight:bold;">${sign} ${formattedAmount} ${asset}</span>
              </div>
              <div style="font-size:0.85em; color:#9adf9a; margin-top:4px;">${label}</div>
              <div style="font-size:0.8em; color:#888; margin-top:4px;">
                  ${isSwap ? `Trader: ${tx.from || tx.trader || currentAddress}` : (isIncoming ? 'From: ' + (tx.from || '') : 'To: ' + (tx.to || ''))}
                  <br>TXID: ${(tx.tx_id || 'pending')}
                  ${tx.amount_out ? `<br>Output: ${formatTokenAmount(tx.amount_out, decimals)} ${(tx.token_out || asset)}` : ''}
              </div>
            </div>`;
      });

      div.innerHTML = html;
    }

    async function loadWalletData(addr) {
      try {
        const [walletRes, feedRes] = await Promise.all([
          fetch(`/wallet_data/${addr}`),
          fetch(`/api/tx_feed?wallet=${encodeURIComponent(addr)}`)
        ]);

        if (!walletRes.ok) throw new Error("Server returned " + walletRes.status);
        const data = await walletRes.json();
        const feed = feedRes.ok ? await feedRes.json() : [];

        const balance = parseFloat(data.balance);
        tokenDecimals = data.token_decimals || 6;  // Get decimals from response or default to 6

        const normalizedFeed = Array.isArray(feed) ? feed : [];
        walletTxs = (normalizedFeed.length ? normalizedFeed : (data.transactions || [])).map(tx => ({
          ...tx,
          kind: (tx.kind || tx.type || 'transfer').toLowerCase(),
          direction: tx.direction || (tx.to === addr ? 'in' : (tx.from === addr ? 'out' : tx.direction)),
        }));

        $('balance').textContent = formatTokenAmount(balance, tokenDecimals);

        // Calculate BTC value (Fixed rate: 1 THR = 0.0001 BTC)
        const btcVal = (balance * 0.0001).toFixed(8);
        $('btcValue').textContent = btcVal;
        renderTxHistory(currentFilter);
      } catch (e) {
        console.error(e);
        $('txHistory').textContent = "Error loading data.";
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', checkConnection);
</script>
{% endblock %}
