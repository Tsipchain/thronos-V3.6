{% extends "base.html" %}

{% block title %}ğŸ’¼ Thronos Wallet{% endblock %}

{% block styles %}
<style>
    /* Remove double border-bottom */
    h1, h2, h3 {
        border-bottom: none;
        padding-bottom: 0;
    }

    .wallet-card {
        background: #111;
        border: 1px solid #0f0;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    input, button {
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 10px;
        margin: 5px 0;
        font-family: monospace;
        width: 100%;
        box-sizing: border-box;
    }
    button {
        cursor: pointer;
        font-weight: bold;
        background: #0f0;
        color: #000;
    }
    button:hover { background: #0c0; }
    button.secondary {
        background: transparent;
        color: #0f0;
    }
    button.secondary:hover {
        background: #111;
    }

    .tx {
        margin-top: 10px;
        border-bottom: 1px dashed #333;
        padding: 10px 0;
    }
    .tx-filters {
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        margin-bottom:8px;
    }
    .tx-filter-btn {
        padding:6px 10px;
        border:1px solid #0f0;
        background:#000;
        color:#0f0;
        cursor:pointer;
        border-radius:6px;
    }
    .tx-filter-btn.active { background:#0f0; color:#000; }
    .btc-val {
        color: #ff0;
        font-size: 0.9em;
    }
    .hidden { display: none; }

    .balance-large {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .fire-icon-wallet {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 0 8px #ff6600);
        animation: glow 2s ease-in-out infinite;
    }
    @keyframes glow {
        0%, 100% { filter: drop-shadow(0 0 8px #ff6600); }
        50% { filter: drop-shadow(0 0 16px #ff9900) drop-shadow(0 0 24px #ff6600); }
    }
</style>
{% endblock %}

{% block content %}
  <h1>ğŸ’¼ <span class="lang-el">Î¤Î¿ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ Î¼Î¿Ï…</span><span class="lang-en">My Wallet</span></h1>

  <!-- CONNECT SECTION -->
  <div id="connectSection" class="wallet-card">
      <h2><span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ· Î Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï</span><span class="lang-en">Connect Wallet</span></h2>
      <p><span class="lang-el">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ. Î¤Î± ÎºÎ»ÎµÎ¹Î´Î¹Î¬ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ Ï„Î¿Ï€Î¹ÎºÎ¬ (browser).</span><span class="lang-en">Enter your credentials to connect. Keys are stored locally in your browser.</span></p>
      
      <label><span class="lang-el">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· THR</span><span class="lang-en">THR Address</span></label>
      <input type="text" id="inputAddress" placeholder="THR..." />
      
      <label><span class="lang-el">ÎœÏ…ÏƒÏ„Î¹ÎºÏŒ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î®, Î‘Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ Î³Î¹Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®)</span><span class="lang-en">Send Secret (Optional for view, Required for send)</span></label>
      <input type="password" id="inputSecret" placeholder="auth_secret..." />
      
      <button onclick="connectWallet()">ğŸ”“ <span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ·</span><span class="lang-en">Connect</span></button>
      <p style="font-size:0.8em; color:#666;">
          <span class="lang-el">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹;</span><span class="lang-en">Don't have a wallet?</span> 
          <a href="/pledge">ğŸ”¥ Pledge to create one</a>
      </p>
  </div>

  <!-- DASHBOARD SECTION -->
  <div id="dashboardSection" class="hidden">
      <div class="wallet-card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:10px;">
                  <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="ğŸ”¥" class="fire-icon-wallet" />
                  <strong><span id="displayAddress">THR...</span></strong>
              </div>
              <button class="secondary" style="width:auto; padding:5px 10px;" onclick="disconnectWallet()">âŒ <span class="lang-el">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</span><span class="lang-en">Disconnect</span></button>
          </div>

          <div class="balance-large">
              <span class="lang-el">Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î‘Î¾Î¯Î±</span><span class="lang-en">Total Value</span>: <span id="totalValue">â€”</span> THR
          </div>
          <div class="btc-val">â‰ˆ <span id="totalUSD">â€”</span> USD</div>

          <div style="margin-top:20px; display:flex; gap:10px;">
              <button onclick="window.location.href='/send'">ğŸ“¤ <span class="lang-el">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</span><span class="lang-en">Send</span></button>
              <button class="secondary" onclick="refreshWallet()">ğŸ”„ <span class="lang-el">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</span><span class="lang-en">Refresh</span></button>
          </div>
      </div>

      <h3><span class="lang-el">Î¤Î± Tokens Î¼Î¿Ï…</span><span class="lang-en">My Tokens</span></h3>
      <div id="tokensList" class="wallet-card">
          <span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span><span class="lang-en">Loading...</span>
      </div>

      <h3><span class="lang-el">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î£Ï…Î½Î±Î»Î»Î±Î³ÏÎ½</span><span class="lang-en">Transaction History</span></h3>
      <div class="tx-filters">
        <button class="tx-filter-btn active" data-filter="all" onclick="renderTxHistory('all')">All</button>
        <button class="tx-filter-btn" data-filter="thr" onclick="renderTxHistory('thr')">THR</button>
        <button class="tx-filter-btn" data-filter="tokens" onclick="renderTxHistory('tokens')">Tokens</button>
        <button class="tx-filter-btn" data-filter="swaps" onclick="renderTxHistory('swaps')">Swaps</button>
        <button class="tx-filter-btn" data-filter="l2e" onclick="renderTxHistory('l2e')">L2E</button>
        <button class="tx-filter-btn" data-filter="ai_credits" onclick="renderTxHistory('ai_credits')">AI Credits</button>
        <button class="tx-filter-btn" data-filter="architect_ai_jobs" onclick="renderTxHistory('architect_ai_jobs')">Architect</button>
        <button class="tx-filter-btn" data-filter="bridge" onclick="renderTxHistory('bridge')">Bridge</button>
        <button class="tx-filter-btn" data-filter="iot" onclick="renderTxHistory('iot')">IoT</button>
      </div>
      <div id="txHistory" class="wallet-card">
          <span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span><span class="lang-en">Loading...</span>
      </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
    // --- Logic ---
    const $ = (id) => document.getElementById(id);

    // Fallback: avoid crashing history render if helper is missing
    window.shouldExcludeTx = window.shouldExcludeTx || function (tx) {
        if (!tx) return true;

        // Keep it conservative: don't hide real user txs.
        // Hide only obvious housekeeping/noise entries if any:
        const kind = String(tx.kind || tx.type || "").toLowerCase();
        const amt = Number(tx.display_amount ?? tx.amount ?? 0);

        // Example: hide "block" rows with 0 and no note (optional)
        if (kind === "block" && amt === 0 && !tx.note) return true;

        return false;
    };

    function checkConnection() {
        const addr = localStorage.getItem('thr_address');
        if (addr) {
            $('connectSection').classList.add('hidden');
            $('dashboardSection').classList.remove('hidden');
            $('displayAddress').textContent = addr;
            currentAddress = addr;
            loadWalletData(addr);
        } else {
            $('connectSection').classList.remove('hidden');
            $('dashboardSection').classList.add('hidden');
        }
    }

    function connectWallet() {
        const addr = $('inputAddress').value.trim();
        const secret = $('inputSecret').value.trim();
        
        if (!addr) {
            alert("Please enter a THR address.");
            return;
        }
        
        localStorage.setItem('thr_address', addr);
        if (secret) {
            localStorage.setItem('thr_secret', secret);
        }

        currentAddress = addr;
        checkConnection();
    }

    function disconnectWallet() {
        if(confirm("Are you sure? This will clear your stored keys from this browser.")) {
            localStorage.removeItem('thr_address');
            localStorage.removeItem('thr_secret');
            window.location.reload();
        }
    }

    async function refreshWallet() {
        const addr = localStorage.getItem('thr_address');
        if (addr) loadWalletData(addr);
    }

    // FIX 4C: Format token amounts with proper decimals and no scientific notation
    function formatTokenAmount(amount, decimals) {
      const decimalPlaces = decimals || 6;
      const num = parseFloat(amount) || 0;
      // Prevent scientific notation by using toFixed
      return num.toFixed(decimalPlaces);
    }

    function normalizeKind(value) {
        return String(value || '').toLowerCase();
    }

    function normalizeCategory(value) {
        return String(value || '').toLowerCase();
    }

    function getCanonicalCategory(tx) {
        const category = normalizeCategory(tx.category);
        if (category) return category;
        const kind = normalizeKind(tx.kind);
        const map = {
            transfer: 'thr',
            thr_transfer: 'thr',
            token_transfer: 'tokens',
            swap: 'swaps',
            pool_swap: 'swaps',
            bridge: 'bridge',
            l2e: 'l2e',
            ai_credit: 'ai_credits',
            ai_credits: 'ai_credits',
            ai_credits_earned: 'ai_credits',
            ai_credits_spent: 'ai_credits',
            architect: 'architect_ai_jobs',
            architect_job: 'architect_ai_jobs',
            ai_job_created: 'architect_ai_jobs',
            ai_job_progress: 'architect_ai_jobs',
            ai_job_completed: 'architect_ai_jobs',
            ai_job_reward: 'architect_ai_jobs',
            iot: 'iot',
            iot_parking: 'iot',
            iot_parking_reservation: 'iot',
            iot_autopilot: 'iot',
        };
        return map[kind] || kind;
    }
    function sanitizeTokenSymbol(value) {
        const symbol = String(value || '').trim().toUpperCase();
        if (!symbol || symbol === 'TOKEN' || symbol === 'TKN' || symbol === 'UNKNOWN') return '';
        return symbol;
    }

    let walletTxs = [];
    let currentFilter = 'all';
    let currentAddress = '';
    let tokenDecimals = 6;

    function renderTxHistory(filter) {
      if (filter) currentFilter = filter;
      const div = $('txHistory');
      const btns = document.querySelectorAll('.tx-filter-btn');
      btns.forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter));

      const txs = (walletTxs || []).filter(tx => !window.shouldExcludeTx(tx));
      if (!txs.length) {
        div.innerHTML = '<p style="color:#666;">No transactions found.</p>';
        return;
      }

      const filtered = txs.filter(tx => {
        const category = getCanonicalCategory(tx);
        if (currentFilter === 'tokens') return category === 'tokens';
        if (currentFilter === 'swaps') return category === 'swaps';
        if (currentFilter === 'thr') return category === 'thr';
        if (currentFilter === 'l2e') return category === 'l2e';
        if (currentFilter === 'ai_credits') return category === 'ai_credits';
        if (currentFilter === 'architect_ai_jobs') return category === 'architect_ai_jobs';
        if (currentFilter === 'bridge') return category === 'bridge';
        if (currentFilter === 'iot') return category === 'iot';
        return true;
      });

      if (!filtered.length) {
        div.innerHTML = '<p style="color:#666;">No transactions match this filter.</p>';
        return;
      }

      let html = "";
      filtered.forEach(tx => {
        const isIncoming = tx.direction === 'in' || tx.to === currentAddress;
        const kind = normalizeKind(tx.kind);
        const isSwap = tx.direction === 'swap' || kind === 'swap' || kind === 'pool_swap';
        const color = isSwap ? '#0ff' : (isIncoming ? '#0f0' : '#ff0');
        const sign = isSwap ? 'â†”ï¸' : (isIncoming ? '+' : '-');
        const isToken = kind === 'token_transfer';
        const tokenSymbol = sanitizeTokenSymbol(tx.asset_symbol || tx.asset || tx.symbol);
        const asset = isToken ? (tokenSymbol || '(unknown token)') : 'THR';
        const decimals = tx.decimals || tokenDecimals;
        const formattedAmount = formatTokenAmount(tx.display_amount ?? tx.amount ?? 0, decimals);
        const label = (tx.category_label || tx.kind || tx.type || '').toString().toUpperCase();

        html += `
            <div class="tx">
              <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
                  <span style="color:#fff;">${tx.timestamp || ''}</span>
                  <span style="color:${color}; font-weight:bold;">${sign} ${formattedAmount} ${asset}</span>
              </div>
              <div style="font-size:0.85em; color:#9adf9a; margin-top:4px;">${label}</div>
              <div style="font-size:0.8em; color:#888; margin-top:4px;">
                  ${isSwap ? `Trader: ${tx.from || tx.trader || currentAddress}` : (isIncoming ? 'From: ' + (tx.from || '') : 'To: ' + (tx.to || ''))}
                  <br>TXID: ${(tx.tx_id || 'pending')}
                  ${tx.amount_out ? `<br>Output: ${formatTokenAmount(tx.amount_out, decimals)} ${(tx.token_out || asset)}` : ''}
              </div>
            </div>`;
      });

      div.innerHTML = html;
    }

    async function loadWalletData(addr) {
      try {
        currentFilter = 'all';
        const [walletRes, feedRes] = await Promise.all([
          fetch(`/api/balances?address=${encodeURIComponent(addr)}&show_zero=false`),
          fetch(`/api/tx_feed?wallet=${encodeURIComponent(addr)}`)
        ]);

        if (!walletRes.ok) throw new Error("Server returned " + walletRes.status);
        const data = await walletRes.json();
        const feed = feedRes.ok ? await feedRes.json() : [];

        // Store tokens globally
        const tokens = data.tokens || [];

        // Calculate total portfolio value from tokens with valid prices
        const pricedTokens = tokens.filter(t => t.value_in_thr !== null && t.value_in_thr !== undefined);
        const totalTHR = pricedTokens.reduce((sum, t) => sum + Number(t.value_in_thr || 0), 0);
        const totalUSD = pricedTokens.reduce((sum, t) => sum + Number(t.value_usd || 0), 0);

        // Display total values with "â€”" if no priced tokens
        $('totalValue').textContent = pricedTokens.length > 0 ? totalTHR.toFixed(4) : 'â€”';
        $('totalUSD').textContent = pricedTokens.length > 0 && totalUSD > 0 ? `$${totalUSD.toFixed(2)}` : 'â€”';

        // Render tokens list
        renderTokensList(tokens);

        const normalizedFeed = Array.isArray(feed) ? feed : [];
        walletTxs = (normalizedFeed.length ? normalizedFeed : []).map(tx => ({
          ...tx,
          kind: (tx.kind || tx.type || 'transfer').toLowerCase(),
          direction: tx.direction || (tx.to === addr ? 'in' : (tx.from === addr ? 'out' : tx.direction)),
        }));

        renderTxHistory(currentFilter);
      } catch (e) {
        console.error(e);
        $('txHistory').textContent = "Error loading data.";
        $('tokensList').innerHTML = '<p style="color:#f00;">Error loading tokens.</p>';
      }
    }

    function renderTokensList(tokens) {
      const div = $('tokensList');
      if (!tokens || tokens.length === 0) {
        div.innerHTML = '<p style="color:#666;">No tokens found.</p>';
        return;
      }

      let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
      tokens.forEach(token => {
        const balance = token.balance.toFixed(token.decimals || 6);
        const valueInThr = token.value_in_thr !== null && token.value_in_thr !== undefined
          ? `${Number(token.value_in_thr).toFixed(4)} THR`
          : 'â€”';
        const valueUSD = token.value_usd !== null && token.value_usd !== undefined
          ? `$${Number(token.value_usd).toFixed(2)}`
          : 'â€”';
        const priceInThr = token.price_in_thr !== null && token.price_in_thr !== undefined
          ? `${Number(token.price_in_thr).toFixed(6)} THR`
          : 'â€”';

        html += `
          <div style="display:flex; align-items:center; gap:12px; padding:12px; border:1px solid #0f0; border-radius:8px; background:#111;">
            <div style="flex:0 0 40px;">
              ${token.logo_url ? `<img src="${token.logo_url}" alt="${token.symbol}" style="width:40px; height:40px; border-radius:50%;" onerror="this.style.display='none';">` : `<div style="width:40px; height:40px; border-radius:50%; background:#000; border:2px solid ${token.color || '#0f0'}; display:flex; align-items:center; justify-content:center; font-weight:bold;">${token.symbol[0]}</div>`}
            </div>
            <div style="flex:1;">
              <div style="font-weight:bold; font-size:1.1em;">${token.symbol}</div>
              <div style="font-size:0.85em; color:#9f9;">${token.name}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:bold; font-family:monospace; font-size:1.1em;">${balance}</div>
              <div style="font-size:0.85em; color:#9f9;">â‰ˆ ${valueInThr}</div>
              <div style="font-size:0.75em; color:#9f9;">${valueUSD}</div>
              <div style="font-size:0.75em; color:#666;">Price: ${priceInThr}</div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      div.innerHTML = html;
    }

    // Init
    document.addEventListener('DOMContentLoaded', checkConnection);
</script>
{% endblock %}
