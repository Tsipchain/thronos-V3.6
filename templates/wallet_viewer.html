{% extends "base.html" %}

{% block title %}ğŸ’¼ Thronos Wallet{% endblock %}

{% block styles %}
<style>
    /* Remove double border-bottom */
    h1, h2, h3 {
        border-bottom: none;
        padding-bottom: 0;
    }

    .wallet-card {
        background: #111;
        border: 1px solid #0f0;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    input, button {
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 10px;
        margin: 5px 0;
        font-family: monospace;
        width: 100%;
        box-sizing: border-box;
    }
    button {
        cursor: pointer;
        font-weight: bold;
        background: #0f0;
        color: #000;
    }
    button:hover { background: #0c0; }
    button.secondary {
        background: transparent;
        color: #0f0;
    }
    button.secondary:hover {
        background: #111;
    }

    .tx {
        margin-top: 10px;
        border-bottom: 1px dashed #333;
        padding: 10px 0;
    }
    .tx-filters {
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        margin-bottom:8px;
    }
    .tx-filter-btn {
        padding:6px 10px;
        border:1px solid #0f0;
        background:#000;
        color:#0f0;
        cursor:pointer;
        border-radius:6px;
    }
    .tx-filter-btn.active { background:#0f0; color:#000; }
    .btc-val {
        color: #ff0;
        font-size: 0.9em;
    }
    .hidden { display: none; }

    .balance-large {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .fire-icon-wallet {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 0 8px #ff6600);
        animation: glow 2s ease-in-out infinite;
    }
    @keyframes glow {
        0%, 100% { filter: drop-shadow(0 0 8px #ff6600); }
        50% { filter: drop-shadow(0 0 16px #ff9900) drop-shadow(0 0 24px #ff6600); }
    }

    /* PR-5: Tabs for wallet sections */
    .wallet-tabs {
        display: flex;
        gap: 8px;
        margin: 20px 0 12px 0;
        border-bottom: 2px solid #0f0;
    }
    .wallet-tab-btn {
        padding: 10px 20px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #0f0;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        font-family: monospace;
        transition: all 0.2s;
    }
    .wallet-tab-btn:hover {
        background: #111;
        color: #0c0;
    }
    .wallet-tab-btn.active {
        color: #0f0;
        border-bottom-color: #0f0;
        background: #111;
    }
    .wallet-tab-content {
        display: none;
    }
    .wallet-tab-content.active {
        display: block;
    }

    /* PR-5: Music section styles */
    .music-section {
        margin-bottom: 20px;
    }
    .music-section-title {
        font-size: 14px;
        color: #0f0;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #333;
    }
    .music-track-item, .music-playlist-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #111;
        border: 1px solid #0f0;
        border-radius: 6px;
        margin-bottom: 8px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .music-track-item:hover, .music-playlist-item:hover {
        background: #1a1a1a;
        border-color: #0c0;
        transform: translateX(-2px);
    }
    .music-track-info, .music-playlist-info {
        flex: 1;
        min-width: 0;
    }
    .music-track-title, .music-playlist-name {
        font-size: 14px;
        font-weight: 600;
        color: #e6ffe5;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .music-track-artist {
        font-size: 12px;
        color: #9f9;
        opacity: 0.8;
        margin-top: 2px;
    }
    .music-playlist-count {
        font-size: 12px;
        color: #9f9;
        opacity: 0.8;
        margin-top: 2px;
    }
    .music-empty {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
  <h1>ğŸ’¼ <span class="lang-el">Î¤Î¿ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹ Î¼Î¿Ï…</span><span class="lang-en">My Wallet</span></h1>

  <!-- CONNECT SECTION -->
  <div id="connectSection" class="wallet-card">
      <h2><span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ· Î Î¿ÏÏ„Î¿Ï†Î¿Î»Î¹Î¿Ï</span><span class="lang-en">Connect Wallet</span></h2>
      <p><span class="lang-el">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ. Î¤Î± ÎºÎ»ÎµÎ¹Î´Î¹Î¬ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ Ï„Î¿Ï€Î¹ÎºÎ¬ (browser).</span><span class="lang-en">Enter your credentials to connect. Keys are stored locally in your browser.</span></p>
      
      <label><span class="lang-el">Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· THR</span><span class="lang-en">THR Address</span></label>
      <input type="text" id="inputAddress" placeholder="THR..." />
      
      <label><span class="lang-el">ÎœÏ…ÏƒÏ„Î¹ÎºÏŒ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î®, Î‘Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ Î³Î¹Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®)</span><span class="lang-en">Send Secret (Optional for view, Required for send)</span></label>
      <input type="password" id="inputSecret" placeholder="auth_secret..." />
      
      <button onclick="connectWallet()">ğŸ”“ <span class="lang-el">Î£ÏÎ½Î´ÎµÏƒÎ·</span><span class="lang-en">Connect</span></button>
      <p style="font-size:0.8em; color:#666;">
          <span class="lang-el">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹;</span><span class="lang-en">Don't have a wallet?</span> 
          <a href="/pledge">ğŸ”¥ Pledge to create one</a>
      </p>
  </div>

  <!-- DASHBOARD SECTION -->
  <div id="dashboardSection" class="hidden">
      <div class="wallet-card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:10px;">
                  <img src="{{ url_for('static', filename='img/thronos-token.png') }}" alt="ğŸ”¥" class="fire-icon-wallet" />
                  <strong><span id="displayAddress">THR...</span></strong>
              </div>
              <button class="secondary" style="width:auto; padding:5px 10px;" onclick="disconnectWallet()">âŒ <span class="lang-el">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</span><span class="lang-en">Disconnect</span></button>
          </div>

          <div class="balance-large">
              <span class="lang-el">Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î‘Î¾Î¯Î±</span><span class="lang-en">Total Value</span>: <span id="totalValue">â€”</span> THR
          </div>
          <div class="btc-val">â‰ˆ <span id="totalUSD">â€”</span> USD</div>

          <div style="margin-top:20px; display:flex; gap:10px;">
              <button onclick="window.location.href='/send'">ğŸ“¤ <span class="lang-el">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</span><span class="lang-en">Send</span></button>
              <button class="secondary" onclick="refreshWallet()">ğŸ”„ <span class="lang-el">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</span><span class="lang-en">Refresh</span></button>
          </div>
      </div>

      <!-- PR-5: Tabs for Tokens, History, and Music -->
      <div class="wallet-tabs">
          <button class="wallet-tab-btn active" data-tab="tokens" onclick="switchWalletViewerTab('tokens')">
              ğŸ’° <span class="lang-el">Tokens</span><span class="lang-en">Tokens</span>
          </button>
          <button class="wallet-tab-btn" data-tab="history" onclick="switchWalletViewerTab('history')">
              ğŸ“œ <span class="lang-el">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</span><span class="lang-en">History</span>
          </button>
          <button class="wallet-tab-btn" data-tab="music" onclick="switchWalletViewerTab('music')">
              ğŸµ <span class="lang-el">ÎœÎ¿Ï…ÏƒÎ¹ÎºÎ®</span><span class="lang-en">Music</span>
          </button>
      </div>

      <!-- Tokens Tab -->
      <div class="wallet-tab-content active" id="tokensTabContent">
          <h3><span class="lang-el">Î¤Î± Tokens Î¼Î¿Ï…</span><span class="lang-en">My Tokens</span></h3>
          <div id="tokensList" class="wallet-card">
              <span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span><span class="lang-en">Loading...</span>
          </div>
      </div>

      <!-- History Tab -->
      <div class="wallet-tab-content" id="historyTabContent">
          <h3><span class="lang-el">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î£Ï…Î½Î±Î»Î»Î±Î³ÏÎ½</span><span class="lang-en">Transaction History</span></h3>
          <div class="tx-filters">
        <button class="tx-filter-btn active" data-filter="all" onclick="renderTxHistory('all')">All</button>
        <button class="tx-filter-btn" data-filter="thr" onclick="renderTxHistory('thr')">THR</button>
        <button class="tx-filter-btn" data-filter="tokens" onclick="renderTxHistory('tokens')">Tokens</button>
        <button class="tx-filter-btn" data-filter="swaps" onclick="renderTxHistory('swaps')">Swaps</button>
        <button class="tx-filter-btn" data-filter="l2e" onclick="renderTxHistory('l2e')">L2E</button>
        <button class="tx-filter-btn" data-filter="ai_credits" onclick="renderTxHistory('ai_credits')">AI Credits</button>
        <button class="tx-filter-btn" data-filter="architect_ai_jobs" onclick="renderTxHistory('architect_ai_jobs')">Architect</button>
        <button class="tx-filter-btn" data-filter="bridge" onclick="renderTxHistory('bridge')">Bridge</button>
        <button class="tx-filter-btn" data-filter="iot" onclick="renderTxHistory('iot')">IoT</button>
      </div>
      <div id="txHistory" class="wallet-card">
          <span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span><span class="lang-en">Loading...</span>
      </div>
      </div>

      <!-- Music Tab -->
      <div class="wallet-tab-content" id="musicTabContent">
          <h3><span class="lang-el">ÎœÎ¿Ï…ÏƒÎ¹ÎºÎ®</span><span class="lang-en">Music</span></h3>
          <div class="wallet-card">
              <span class="lang-el">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span><span class="lang-en">Loading...</span>
          </div>
      </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
    // --- Logic ---
    const $ = (id) => document.getElementById(id);

    // Fallback: avoid crashing history render if helper is missing
    window.shouldExcludeTx = window.shouldExcludeTx || function (tx) {
        if (!tx) return true;

        // Keep it conservative: don't hide real user txs.
        // Hide only obvious housekeeping/noise entries if any:
        const kind = String(tx.kind || tx.type || "").toLowerCase();
        const amt = Number(tx.display_amount ?? tx.amount ?? 0);

        // Example: hide "block" rows with 0 and no note (optional)
        if (kind === "block" && amt === 0 && !tx.note) return true;

        return false;
    };

    function checkConnection() {
        const addr = localStorage.getItem('thr_address');
        if (addr) {
            $('connectSection').classList.add('hidden');
            $('dashboardSection').classList.remove('hidden');
            $('displayAddress').textContent = addr;
            currentAddress = addr;
            loadWalletData(addr);
        } else {
            $('connectSection').classList.remove('hidden');
            $('dashboardSection').classList.add('hidden');
        }
    }

    function connectWallet() {
        const addr = $('inputAddress').value.trim();
        const secret = $('inputSecret').value.trim();
        
        if (!addr) {
            alert("Please enter a THR address.");
            return;
        }
        
        localStorage.setItem('thr_address', addr);
        if (secret) {
            localStorage.setItem('thr_secret', secret);
        }

        currentAddress = addr;
        checkConnection();
    }

    function disconnectWallet() {
        if(confirm("Are you sure? This will clear your stored keys from this browser.")) {
            localStorage.removeItem('thr_address');
            localStorage.removeItem('thr_secret');
            window.location.reload();
        }
    }

    async function refreshWallet() {
        const addr = localStorage.getItem('thr_address');
        if (addr) loadWalletData(addr);
    }

    // FIX 4C: Format token amounts with proper decimals and no scientific notation
    function formatTokenAmount(amount, decimals) {
      const decimalPlaces = decimals || 6;
      const num = parseFloat(amount) || 0;
      // Prevent scientific notation by using toFixed
      return num.toFixed(decimalPlaces);
    }

    function normalizeKind(value) {
        return String(value || '').toLowerCase();
    }

    function normalizeCategory(value) {
        return String(value || '').toLowerCase();
    }

    function getCanonicalCategory(tx) {
        const category = normalizeCategory(tx.category);
        if (category) return category;
        const kind = normalizeKind(tx.kind);
        const map = {
            transfer: 'thr',
            thr_transfer: 'thr',
            mining: 'mining',
            block_reward: 'mining',
            mining_reward: 'mining',
            mined: 'mining',
            token_transfer: 'tokens',
            swap: 'swaps',
            pool_swap: 'swaps',
            liquidity_add: 'liquidity',
            liquidity_remove: 'liquidity',
            liquidity: 'liquidity',
            pool_add: 'liquidity',
            pool_remove: 'liquidity',
            bridge: 'bridge',
            bridge_deposit: 'bridge',
            bridge_withdraw: 'bridge',
            l2e: 'l2e',
            l2e_reward: 'l2e',
            ai_credit: 'ai_credits',
            ai_credits: 'ai_credits',
            ai_credits_earned: 'ai_credits',
            ai_credits_spent: 'ai_credits',
            architect: 'architect_ai_jobs',
            architect_job: 'architect_ai_jobs',
            ai_job_created: 'architect_ai_jobs',
            ai_job_progress: 'architect_ai_jobs',
            ai_job_completed: 'architect_ai_jobs',
            ai_job_reward: 'architect_ai_jobs',
            iot: 'iot',
            iot_parking: 'iot',
            iot_parking_reservation: 'iot',
            iot_autopilot: 'iot',
            gateway: 'gateway',
            gateway_deposit: 'gateway',
            gateway_withdraw: 'gateway',
            music: 'music',
            music_tip: 'music',
            music_purchase: 'music',
            music_stream: 'music',
            music_royalty: 'music',
            music_play_reward: 'music',
        };
        return map[kind] || kind;
    }
    function sanitizeTokenSymbol(value) {
        const symbol = String(value || '').trim().toUpperCase();
        if (!symbol || symbol === 'TOKEN' || symbol === 'TKN' || symbol === 'UNKNOWN') return '';
        return symbol;
    }

    let walletTxs = [];
    let currentFilter = 'all';
    let currentAddress = '';
    let tokenDecimals = 6;

    function renderTxHistory(filter) {
      if (filter) currentFilter = filter;
      const div = $('txHistory');
      const btns = document.querySelectorAll('.tx-filter-btn');
      btns.forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter));

      const txs = (walletTxs || []).filter(tx => !window.shouldExcludeTx(tx));
      if (!txs.length) {
        div.innerHTML = '<p style="color:#666;">No transactions found.</p>';
        return;
      }

      const filtered = txs.filter(tx => {
        const category = getCanonicalCategory(tx);
        if (currentFilter === 'tokens') return category === 'tokens';
        if (currentFilter === 'swaps') return category === 'swaps';
        if (currentFilter === 'thr') return category === 'thr';
        if (currentFilter === 'l2e') return category === 'l2e';
        if (currentFilter === 'ai_credits') return category === 'ai_credits';
        if (currentFilter === 'architect_ai_jobs') return category === 'architect_ai_jobs';
        if (currentFilter === 'bridge') return category === 'bridge';
        if (currentFilter === 'iot') return category === 'iot';
        return true;
      });

      if (!filtered.length) {
        div.innerHTML = '<p style="color:#666;">No transactions match this filter.</p>';
        return;
      }

      let html = "";
      filtered.forEach(tx => {
        const isIncoming = tx.direction === 'in' || tx.to === currentAddress;
        const kind = normalizeKind(tx.kind);
        const isSwap = tx.direction === 'swap' || kind === 'swap' || kind === 'pool_swap';
        const color = isSwap ? '#0ff' : (isIncoming ? '#0f0' : '#ff0');
        const sign = isSwap ? 'â†”ï¸' : (isIncoming ? '+' : '-');
        const isToken = kind === 'token_transfer';
        const tokenSymbol = sanitizeTokenSymbol(tx.asset_symbol || tx.asset || tx.symbol);
        const asset = tokenSymbol || 'THR';
        const decimals = tx.decimals || tokenDecimals;
        const formattedAmount = formatTokenAmount(tx.display_amount ?? tx.amount ?? 0, decimals);
        const label = (tx.category_label || tx.kind || tx.type || '').toString().toUpperCase();

        html += `
            <div class="tx">
              <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
                  <span style="color:#fff;">${tx.timestamp || ''}</span>
                  <span style="color:${color}; font-weight:bold;">${sign} ${formattedAmount} ${asset}</span>
              </div>
              <div style="font-size:0.85em; color:#9adf9a; margin-top:4px;">${label}</div>
              <div style="font-size:0.8em; color:#888; margin-top:4px;">
                  ${isSwap ? `Trader: ${tx.from || tx.trader || currentAddress}` : (isIncoming ? 'From: ' + (tx.from || '') : 'To: ' + (tx.to || ''))}
                  <br>TXID: ${(tx.tx_id || 'pending')}
                  ${tx.amount_out ? `<br>Output: ${formatTokenAmount(tx.amount_out, decimals)} ${(tx.token_out || asset)}` : ''}
              </div>
            </div>`;
      });

      div.innerHTML = html;
    }

    async function loadWalletData(addr) {
      try {
        currentFilter = 'all';
        const [walletRes, feedRes] = await Promise.all([
          fetch(`/api/balances?address=${encodeURIComponent(addr)}&show_zero=false`),
          fetch(`/api/tx_feed?wallet=${encodeURIComponent(addr)}`)
        ]);

        if (!walletRes.ok) throw new Error("Server returned " + walletRes.status);
        const data = await walletRes.json();
        const feed = feedRes.ok ? await feedRes.json() : [];

        // Store tokens globally
        const tokens = data.tokens || [];

        // Calculate total portfolio value from tokens with valid prices
        const pricedTokens = tokens.filter(t => t.value_in_thr !== null && t.value_in_thr !== undefined);
        const totalTHR = pricedTokens.reduce((sum, t) => sum + Number(t.value_in_thr || 0), 0);
        const totalUSD = pricedTokens.reduce((sum, t) => sum + Number(t.value_usd || 0), 0);

        // Display total values with "â€”" if no priced tokens
        $('totalValue').textContent = pricedTokens.length > 0 ? totalTHR.toFixed(4) : 'â€”';
        $('totalUSD').textContent = pricedTokens.length > 0 && totalUSD > 0 ? `$${totalUSD.toFixed(2)}` : 'â€”';

        // Render tokens list
        renderTokensList(tokens);

        const normalizedFeed = Array.isArray(feed) ? feed : [];
        walletTxs = (normalizedFeed.length ? normalizedFeed : []).map(tx => ({
          ...tx,
          kind: (tx.kind || tx.type || 'transfer').toLowerCase(),
          direction: tx.direction || (tx.to === addr ? 'in' : (tx.from === addr ? 'out' : tx.direction)),
        }));

        renderTxHistory(currentFilter);
      } catch (e) {
        console.error(e);
        $('txHistory').textContent = "Error loading data.";
        $('tokensList').innerHTML = '<p style="color:#f00;">Error loading tokens.</p>';
      }
    }

    function renderTokensList(tokens) {
      const div = $('tokensList');
      if (!tokens || tokens.length === 0) {
        div.innerHTML = '<p style="color:#666;">No tokens found.</p>';
        return;
      }

      let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
      tokens.forEach(token => {
        const balance = token.balance.toFixed(token.decimals || 6);
        const valueInThr = token.value_in_thr !== null && token.value_in_thr !== undefined
          ? `${Number(token.value_in_thr).toFixed(4)} THR`
          : 'â€”';
        const valueUSD = token.value_usd !== null && token.value_usd !== undefined
          ? `$${Number(token.value_usd).toFixed(2)}`
          : 'â€”';
        const priceInThr = token.price_in_thr !== null && token.price_in_thr !== undefined
          ? `${Number(token.price_in_thr).toFixed(6)} THR`
          : 'â€”';

        html += `
          <div style="display:flex; align-items:center; gap:12px; padding:12px; border:1px solid #0f0; border-radius:8px; background:#111;">
            <div style="flex:0 0 40px;">
              ${token.logo_url ? `<img src="${token.logo_url}" alt="${token.symbol}" style="width:40px; height:40px; border-radius:50%;" onerror="this.style.display='none';">` : `<div style="width:40px; height:40px; border-radius:50%; background:#000; border:2px solid ${token.color || '#0f0'}; display:flex; align-items:center; justify-content:center; font-weight:bold;">${token.symbol[0]}</div>`}
            </div>
            <div style="flex:1;">
              <div style="font-weight:bold; font-size:1.1em;">${token.symbol}</div>
              <div style="font-size:0.85em; color:#9f9;">${token.name}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:bold; font-family:monospace; font-size:1.1em;">${balance}</div>
              <div style="font-size:0.85em; color:#9f9;">â‰ˆ ${valueInThr}</div>
              <div style="font-size:0.75em; color:#9f9;">${valueUSD}</div>
              <div style="font-size:0.75em; color:#666;">Price: ${priceInThr}</div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      div.innerHTML = html;
    }

    // PR-5: Tab Switching for Wallet Viewer
    function switchWalletViewerTab(tabName) {
        // Update tab buttons
        const tabBtns = document.querySelectorAll('.wallet-tab-btn');
        tabBtns.forEach(btn => {
            if (btn.dataset.tab === tabName) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // Update tab content
        const tabContents = document.querySelectorAll('.wallet-tab-content');
        tabContents.forEach(content => {
            content.classList.remove('active');
        });

        const activeContent = document.getElementById(`${tabName}TabContent`);
        if (activeContent) {
            activeContent.classList.add('active');
        }

        // Load music when switching to music tab
        if (tabName === 'music') {
            loadViewerMusicTab();
        }
    }

    // PR-5: Load and render music tab
    let viewerMusicModuleInitialized = false;
    const viewerMusicState = {
        library: [],
        playlists: [],
        libraryError: null,
        playlistsError: null
    };

    function viewerMusicApiUrl(path) {
        if (window.buildWalletMusicApiUrl) return window.buildWalletMusicApiUrl(path);
        const base = window.__API_BASE__ || window.location.origin;
        if (!path) return path;
        if (/^https?:\/\//i.test(path)) return path;
        const normalized = path.startsWith('/') ? path : `/${path}`;
        return `${base}${normalized}`;
    }

    function normalizeViewerTrack(track) {
        if (!track || typeof track !== 'object') return track;
        const normalized = { ...track };
        const fixer = window.normalizeMediaUrl || window.FetchUtils?.normalizeMediaUrl;
        ['audio_url', 'cover_url', 'image_url', 'logo_url', 'thumbnail_url'].forEach(field => {
            if (normalized[field] && fixer) {
                normalized[field] = fixer(normalized[field]);
            }
        });
        return normalized;
    }

    function normalizeViewerPlaylist(playlist) {
        if (!playlist || typeof playlist !== 'object') return playlist;
        const normalized = { ...playlist };
        if (Array.isArray(normalized.tracks)) {
            normalized.tracks = normalized.tracks.map(track => normalizeViewerTrack(track));
        }
        return normalized;
    }

    function initViewerMusicSkeleton() {
        const musicContent = document.getElementById('musicTabContent');
        if (!musicContent) return;
        musicContent.innerHTML = `
            <div class="wallet-card">
                <div style="margin-bottom: 12px; font-weight: bold;">Library</div>
                <div class="music-empty">Loading music...</div>
                <div style="margin: 16px 0 8px; font-weight: bold; display:flex; justify-content: space-between; align-items:center;">
                    <span>Playlists</span>
                    <button onclick="viewerCreatePlaylist()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;">â• ÎÎ­Î± Playlist</button>
                </div>
                <div class="music-empty">Loading music...</div>
            </div>
        `;
    }

    async function loadViewerLibrary(wallet) {
        try {
            const res = await fetch(viewerMusicApiUrl(`/api/music/library?address=${encodeURIComponent(wallet)}`));
            const data = res.ok ? await res.json() : {};
            if (data.ok && Array.isArray(data.library)) {
                return { items: data.library.map(track => normalizeViewerTrack(track)), error: null };
            }
            return { items: Array.isArray(data.library) ? data.library : [], error: data.error || 'library_unavailable' };
        } catch (error) {
            return { items: [], error: error.message || 'library_unavailable' };
        }
    }

    async function loadViewerPlaylists(wallet) {
        try {
            const res = await fetch(viewerMusicApiUrl(`/api/music/playlists?address=${encodeURIComponent(wallet)}`));
            const data = res.ok ? await res.json() : {};
            const playlists = Array.isArray(data.playlists)
                ? data.playlists
                : (Array.isArray(data.items) ? data.items : []);
            return {
                items: playlists.map(playlist => normalizeViewerPlaylist(playlist)),
                error: data.ok === false ? (data.error || 'playlists_unavailable') : null
            };
        } catch (error) {
            return { items: [], error: error.message || 'playlists_unavailable' };
        }
    }

    async function loadViewerMusicTab() {
        const musicContent = document.getElementById('musicTabContent');
        if (!musicContent) return;

        const wallet = currentAddress || localStorage.getItem('thr_address');
        if (!wallet) {
            musicContent.innerHTML = '<div class="wallet-card"><div class="music-empty">Please connect your wallet to view music.</div></div>';
            return;
        }

        // Security: Check if wallet is unlocked (has send_secret)
        const secret = localStorage.getItem('thr_secret');
        if (!secret) {
            musicContent.innerHTML = '<div class="wallet-card"><div class="music-empty">Unlock your wallet to view music.</div></div>';
            return;
        }

        initViewerMusicSkeleton();
        viewerMusicState.libraryError = null;
        viewerMusicState.playlistsError = null;

        let moduleLoaded = false;
        if (typeof MusicModule !== 'undefined') {
            try {
                await MusicModule.init(wallet);
                viewerMusicModuleInitialized = true;
                viewerMusicState.library = (MusicModule.getLibrary() || []).map(track => normalizeViewerTrack(track));
                viewerMusicState.playlists = (MusicModule.getPlaylists() || []).map(playlist => normalizeViewerPlaylist(playlist));
                moduleLoaded = true;
            } catch (error) {
                console.warn('[Wallet Viewer] MusicModule init failed, falling back to API:', error);
                viewerMusicState.libraryError = error.message || 'library_unavailable';
                viewerMusicState.playlistsError = error.message || 'playlists_unavailable';
            }
        }

        if (!moduleLoaded) {
            const [libraryResult, playlistsResult] = await Promise.all([
                loadViewerLibrary(wallet),
                loadViewerPlaylists(wallet)
            ]);
            viewerMusicState.library = libraryResult.items;
            viewerMusicState.playlists = playlistsResult.items;
            viewerMusicState.libraryError = libraryResult.error;
            viewerMusicState.playlistsError = playlistsResult.error;
        }

        renderViewerMusicTab();
    }

    // PR-5c: Create playlist from wallet music tab
    async function viewerCreatePlaylist() {
        const name = prompt('Enter playlist name:');
        if (!name || !name.trim()) return;

        try {
            // Use WalletAuth for PIN-based unlock
            const { address, authSecret } = await window.WalletAuth.requireUnlockedWallet();

            // Show loading
            const musicContent = document.getElementById('musicTabContent');
            if (musicContent) {
                musicContent.innerHTML = `
                    <div class="wallet-card">
                        <div style="text-align:center; padding:20px; color:#0f0;">
                            <div style="display:inline-block; width:20px; height:20px; border:2px solid rgba(0,255,0,0.2); border-top:2px solid #0f0; border-radius:50%; animation:spin 1s linear infinite;"></div>
                            <div style="margin-top:10px;">Creating playlist...</div>
                        </div>
                    </div>
                `;
            }

            // Create via API
            const res = await fetch(viewerMusicApiUrl('/api/music/playlists/create'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    address: address,
                    name: name.trim(),
                    auth_secret: authSecret
                })
            });

            const data = await res.json();
            if (data.ok) {
                // Refresh music tab
                if (typeof MusicModule !== 'undefined') {
                    await MusicModule.init(address);
                }
                const playlistsResult = await loadViewerPlaylists(address);
                viewerMusicState.playlists = playlistsResult.items;
                viewerMusicState.playlistsError = playlistsResult.error;
                renderViewerMusicTab();
                alert('âœ… Playlist created!');
            } else {
                alert(`âŒ Error: ${data.error}`);
                renderViewerMusicTab();
            }
        } catch (e) {
            if (e.code === 'WALLET_NOT_CONNECTED') {
                alert('âŒ Please connect your wallet first!');
            } else if (e.code === 'WALLET_LOCKED') {
                alert('âŒ Wallet is locked. Please unlock with your PIN.');
            } else {
                alert(`âŒ Error: ${e.message}`);
            }
            renderViewerMusicTab();
        }
    }

    function renderViewerMusicTab() {
        const musicContent = document.getElementById('musicTabContent');
        if (!musicContent) return;

        const library = viewerMusicState.library || [];
        const playlists = viewerMusicState.playlists || [];
        const libraryError = viewerMusicState.libraryError;
        const playlistsError = viewerMusicState.playlistsError;

        // Render library tracks
        const libraryHtml = library.length > 0
            ? library.map(track => `
                <div class="music-track-item">
                    <div class="music-track-info">
                        <div class="music-track-title">${escapeHtml(track.title || 'Untitled')}</div>
                        <div class="music-track-artist">${escapeHtml(track.artist || 'Unknown Artist')}</div>
                    </div>
                    <div style="font-size: 11px; color: #666;">${escapeHtml(track.duration || '')}</div>
                </div>
            `).join('')
            : `<div class="music-empty">${libraryError ? 'Library unavailable' : 'No tracks found'}</div>`;

        // Render playlists
        const playlistsHtml = playlists.length > 0
            ? playlists.map(playlist => {
                const trackCount = (playlist.tracks || []).length;
                return `
                    <div class="music-playlist-item">
                        <div class="music-playlist-info">
                            <div class="music-playlist-name">${escapeHtml(playlist.name || 'Untitled Playlist')}</div>
                            <div class="music-playlist-count">${trackCount} tracks</div>
                        </div>
                    </div>
                `;
            }).join('')
            : `
                <div class="music-empty">
                    ${playlistsError ? 'Playlists failed to load.' : 'No playlists found'}
                    ${playlistsError ? `<button onclick="reloadViewerPlaylists()" style="margin-left:8px; background: transparent; border: 1px solid rgba(0,255,102,0.4); color: #0f0; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 10px;">Retry</button>` : ''}
                </div>
            `;

        const html = `
            <div class="wallet-card">
                <div class="music-section">
                    <div class="music-section-title">Library</div>
                    ${libraryHtml}
                </div>
                <div class="music-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div class="music-section-title" style="margin: 0;">Playlists</div>
                        <button onclick="viewerCreatePlaylist()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                            â• ÎÎ­Î± Playlist
                        </button>
                    </div>
                    ${playlistsHtml}
                </div>
            </div>
        `;

        musicContent.innerHTML = html;
    }

    async function reloadViewerPlaylists() {
        const wallet = currentAddress || localStorage.getItem('thr_address');
        if (!wallet) return;
        const result = await loadViewerPlaylists(wallet);
        viewerMusicState.playlists = result.items;
        viewerMusicState.playlistsError = result.error;
        renderViewerMusicTab();
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Init
    document.addEventListener('DOMContentLoaded', checkConnection);

    window.addEventListener('beforeunload', () => {
        if (musicModuleCheckInterval) {
            clearInterval(musicModuleCheckInterval);
            musicModuleCheckInterval = null;
        }
    });
</script>

<script src="https://thrchain.vercel.app/static/wallet_auth.js"></script>
<script src="https://thrchain.vercel.app/static/music_module.js"></script>

<script>
// PR-5a: Verify MusicModule loaded
if (typeof MusicModule === 'undefined') {
    console.warn('[Wallet Viewer] MusicModule not loaded - check script path/caching');
}
</script>
{% endblock %}
